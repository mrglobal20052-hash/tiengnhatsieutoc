<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AzaKanji - Master Trợ Từ (Joshi)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #f0f9ff; overflow-x: hidden; }
        .kanji-font { font-family: 'Noto Sans JP', sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Ruby Control */
        ruby rt { font-size: 0.6em; color: #64748b; user-select: none; transition: opacity 0.3s; }
        .hide-furigana ruby rt { opacity: 0; }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .modal-enter { animation: modalIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        .correct-anim { animation: pulse-green 0.5s; }
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); } 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); } }
        
        .wrong-anim { animation: shake 0.4s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* Tab Active State */
        .tab-active { background-color: #0369a1; color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .tab-inactive { background-color: #e0f2fe; color: #0c4a6e; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Header -->
    <header class="bg-sky-700 text-white shadow-lg sticky top-0 z-40">
        <div class="container mx-auto px-4 py-3">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center space-x-3 cursor-pointer" onclick="location.reload()">
                    <i class="fas fa-torii-gate text-3xl text-yellow-400"></i>
                    <div>
                        <h1 class="text-xl font-bold uppercase tracking-wider">AzaKanji Joshi</h1>
                        <p class="text-xs text-sky-200">Làm chủ trợ từ tiếng Nhật</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-2 overflow-x-auto max-w-full pb-1 md:pb-0">
                    <div class="flex bg-sky-800 rounded-lg p-1">
                        <button onclick="switchTab('learn')" id="tab-learn" class="px-4 py-2 rounded-md text-sm font-bold transition whitespace-nowrap tab-active">
                            <i class="fas fa-book-open mr-2"></i>Học Tập
                        </button>
                        <button onclick="switchTab('quiz')" id="tab-quiz" class="px-4 py-2 rounded-md text-sm font-bold transition whitespace-nowrap tab-inactive ml-1">
                            <i class="fas fa-gamepad mr-2"></i>Luyện Tập
                        </button>
                          <!-- Nút về trang chủ chính -->
                    <a href="https://tiengnhatsieutoc.com/ftrotu.html" class="px-3 md:px-4 py-2 bg-sky-600 hover:bg-sky-500 rounded-md text-sm font-bold transition whitespace-nowrap border border-sky-500 shadow-sm mr-1 md:mr-3">
                        <i class="fas fa-home mr-1">FlashCard</i>
                    </a>
                    </div>
                    <button id="toggle-furigana" class="px-3 py-2 bg-sky-600 rounded-lg hover:bg-sky-500 transition text-xs font-bold" title="Bật/Tắt Furigana">
                        Furi: ON
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6 flex-grow" id="app-container">
        
        <!-- LEARN SECTION -->
        <div id="learn-section" class="fade-in">
            <div class="mb-6 bg-white p-4 rounded-xl shadow-sm border-l-4 border-sky-500">
                <h3 class="text-lg font-bold text-gray-800 mb-1"><i class="fas fa-info-circle text-sky-500 mr-2"></i>Trợ từ (Joshi) là gì?</h3>
                <p class="text-sm text-gray-600">Những "hạt giống" nhỏ bé kết nối các từ vựng lại với nhau, quyết định ý nghĩa của cả câu văn. Hãy nắm vững chúng!</p>
            </div>
            
            <div id="particles-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Cards will be injected here -->
            </div>
        </div>

        <!-- QUIZ SECTION -->
        <div id="quiz-section" class="hidden fade-in max-w-2xl mx-auto">
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-200">
                <div class="bg-gradient-to-r from-emerald-500 to-teal-600 p-6 text-white flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-bold"><i class="fas fa-puzzle-piece mr-2"></i>Thử Thách Trợ Từ</h2>
                        <p class="text-emerald-100 text-xs mt-1">Chọn trợ từ đúng cho câu dưới đây</p>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-emerald-200 uppercase font-bold">Điểm số</div>
                        <div class="text-3xl font-bold" id="score-display">0</div>
                    </div>
                </div>
                
                <div class="p-6 md:p-8">
                    <!-- Progress Bar -->
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-6">
                        <div id="quiz-progress" class="bg-emerald-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>

                    <div id="question-area" class="text-center mb-8">
                        <div class="text-gray-500 text-sm font-bold mb-4 uppercase tracking-wide">Câu hỏi <span id="q-current">1</span> / <span id="q-total">10</span></div>
                        <div class="text-2xl md:text-3xl kanji-font font-medium text-gray-800 mb-6 leading-relaxed" id="quiz-sentence"></div>
                        <div class="text-gray-500 italic text-sm" id="quiz-translation"></div>
                    </div>

                    <div id="options-area" class="grid grid-cols-2 gap-4 mb-6">
                        <!-- Options injected here -->
                    </div>

                    <div id="feedback-area" class="hidden bg-gray-50 rounded-xl p-4 border border-gray-200 text-left animate-fade-in">
                        <div id="feedback-title" class="font-bold text-lg mb-2 flex items-center"></div>
                        <p id="feedback-detail" class="text-gray-600 text-sm mb-3"></p>
                        <button onclick="nextQuestion()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-lg shadow transition">Tiếp tục <i class="fas fa-arrow-right ml-2"></i></button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- DETAIL MODAL -->
    <div id="detail-modal" class="fixed inset-0 z-50 hidden overflow-y-auto" role="dialog" aria-modal="true">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity backdrop-blur-sm" onclick="closeModal()"></div>
            <div class="inline-block align-bottom bg-white rounded-xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl w-full modal-enter relative">
                <div class="bg-sky-600 px-6 py-4 flex justify-between items-center text-white">
                    <h3 class="text-xl font-bold flex items-center">
                        <span class="bg-white text-sky-700 w-8 h-8 rounded-full flex items-center justify-center mr-3 text-lg font-black" id="modal-particle"></span>
                        Chi tiết cách dùng
                    </h3>
                    <button onclick="closeModal()" class="hover:text-gray-200 text-2xl">&times;</button>
                </div>
                <div class="p-6 bg-gray-50 max-h-[70vh] overflow-y-auto">
                    <div class="space-y-4">
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                            <h4 class="font-bold text-sky-700 mb-2 text-sm uppercase"><i class="fas fa-book mr-2"></i>Định nghĩa chi tiết</h4>
                            <p class="text-gray-700 text-sm leading-relaxed" id="modal-usage"></p>
                        </div>
                        
                        <div class="bg-yellow-50 p-4 rounded-lg shadow-sm border border-yellow-200">
                            <h4 class="font-bold text-yellow-800 mb-2 text-sm uppercase"><i class="fas fa-lightbulb mr-2"></i>Lưu ý & So sánh</h4>
                            <p class="text-gray-700 text-sm leading-relaxed italic" id="modal-nuance"></p>
                        </div>

                        <div>
                            <h4 class="font-bold text-gray-500 mb-3 text-xs uppercase tracking-wider">Ví dụ mở rộng</h4>
                            <ul class="space-y-3" id="modal-examples"></ul>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-100 px-6 py-3 flex justify-end">
                    <button type="button" class="inline-flex justify-center rounded-lg border border-transparent shadow-sm px-5 py-2 bg-sky-600 text-base font-medium text-white hover:bg-sky-700 focus:outline-none sm:text-sm" onclick="closeModal()">Đã hiểu</button>
                </div>
            </div>
        </div>
    </div>

    <!-- AUDIO ELEMENT (Hidden) -->
    <script>
        // --- DATA ---
        const particlesData = [
            {
                p: "は", r: "wa", m: "Chủ đề (là, thì)",
                ex_jp: "私[わたし]は学生[がくせい]です。", ex_vi: "Tôi là học sinh.",
                usage: "Đánh dấu chủ đề của câu. Nhấn mạnh vào thông tin phía sau.",
                nuance: "Khác với 'が'. 'は' dùng cho thông tin đã biết, 'が' dùng cho thông tin mới hoặc nhấn mạnh chủ ngữ.",
                more: [
                    { j: "今日[きょう]は暑[あつ]いです。", v: "Hôm nay trời nóng." },
                    { j: "日本語[にほんご]は面白[おもしろ]いです。", v: "Tiếng Nhật thì thú vị." }
                ]
            },
            {
                p: "が", r: "ga", m: "Chủ ngữ (nhấn mạnh)",
                ex_jp: "猫[ねこ]が好[す]きです。", ex_vi: "Tôi thích mèo (Mèo là thứ tôi thích).",
                usage: "Đánh dấu chủ ngữ của hành động/trạng thái. Nhấn mạnh vào chính chủ ngữ đó.",
                nuance: "Dùng trong câu hỏi 'Ai/Cái gì' (Da re ga...). Dùng với động từ chỉ khả năng, thích ghét (suki, jozu...).",
                more: [
                    { j: "雨[あめ]が降[ふ]っています。", v: "Trời đang mưa." },
                    { j: "足[あし]が痛[いた]いです。", v: "Chân tôi bị đau." }
                ]
            },
            {
                p: "を", r: "o", m: "Tân ngữ trực tiếp",
                ex_jp: "本[ほん]を読[よ]みます。", ex_vi: "Tôi đọc sách.",
                usage: "Đánh dấu đối tượng chịu tác động của hành động.",
                nuance: "Cũng dùng để chỉ địa điểm đi qua/rời khỏi: 公園を散歩する (Đi dạo công viên), 家を出る (Ra khỏi nhà).",
                more: [
                    { j: "音楽[おんがく]を聴[き]きます。", v: "Tôi nghe nhạc." },
                    { j: "ご飯[はん]を食[た]べます。", v: "Tôi ăn cơm." }
                ]
            },
            {
                p: "に", r: "ni", m: "Thời gian, đích đến",
                ex_jp: "６時[じ]に起[お]きます。", ex_vi: "Tôi dậy lúc 6 giờ.",
                usage: "Chỉ thời điểm cụ thể, đích đến (đi đâu), đối tượng (gặp ai), sự tồn tại (ở đâu).",
                nuance: "に vs で: 'に' chỉ sự tồn tại (Imasu/Arimasu), 'で' chỉ nơi diễn ra hành động.",
                more: [
                    { j: "日本[にほん]に行[い]きます。", v: "Tôi đi Nhật." },
                    { j: "友達[ともだち]に会[あ]います。", v: "Tôi gặp bạn." }
                ]
            },
            {
                p: "へ", r: "e", m: "Phương hướng",
                ex_jp: "大阪[おおさか]へ行[い]きます。", ex_vi: "Tôi đi về phía Osaka.",
                usage: "Chỉ hướng di chuyển.",
                nuance: "Gần giống 'に' khi dùng với động từ di chuyển. 'へ' nhấn mạnh hướng đi, 'に' nhấn mạnh điểm đến. Ngày nay thường dùng lẫn lộn.",
                more: [
                    { j: "右[みぎ]へ曲[ま]がってください。", v: "Hãy rẽ về bên phải." },
                    { j: "未来[みらい]へ。", v: "Hướng tới tương lai." }
                ]
            },
            {
                p: "で", r: "de", m: "Tại, bằng, vì",
                ex_jp: "バスで来[き]ました。", ex_vi: "Tôi đến bằng xe buýt.",
                usage: "Chỉ phương tiện, nơi diễn ra hành động, nguyên nhân, phạm vi.",
                nuance: "Khác với 'に'. Ví dụ: Ăn Ở nhà hàng (で), nhưng Sống Ở Tokyo (に).",
                more: [
                    { j: "図書館[としょかん]で勉強[べんきょう]します。", v: "Học ở thư viện." },
                    { j: "病気[びょうき]で休[やす]みました。", v: "Nghỉ vì bệnh." }
                ]
            },
            {
                p: "の", r: "no", m: "Của (Sở hữu)",
                ex_jp: "私[わたし]の本[ほん]です。", ex_vi: "Là sách của tôi.",
                usage: "Nối 2 danh từ. Chỉ sở hữu, xuất xứ, tính chất.",
                nuance: "Có thể thay thế danh từ đã nhắc đến (Cái to thì đắt -> 大きいのは高い).",
                more: [
                    { j: "日本語[にほんご]の先生[せんせい]。", v: "Giáo viên tiếng Nhật." },
                    { j: "机[つくえ]の上[うえ]。", v: "Trên bàn." }
                ]
            },
            {
                p: "と", r: "to", m: "Và, với",
                ex_jp: "母[はは]と行[い]きます。", ex_vi: "Tôi đi với mẹ.",
                usage: "Nối danh từ (liệt kê hết), chỉ đối tác hành động, trích dẫn.",
                nuance: "Liệt kê toàn bộ (A và B). Khác với 'や' (Liệt kê đại diện).",
                more: [
                    { j: "パンと卵[たまご]を買[か]いました。", v: "Tôi đã mua bánh mì và trứng." },
                    { j: "「はい」と言[い]いました。", v: "Đã nói là 'Vâng'." }
                ]
            },
            {
                p: "も", r: "mo", m: "Cũng",
                ex_jp: "私[わたし]も学生[がくせい]です。", ex_vi: "Tôi cũng là học sinh.",
                usage: "Thay thế cho Wa, Ga, O để chỉ sự tương đồng.",
                nuance: "Nếu dùng với phủ định nghĩa là 'Cũng không' (Đâu cũng không đi).",
                more: [
                    { j: "昨日[きのう]も雨[あめ]でした。", v: "Hôm qua cũng mưa." },
                    { j: "何[なに]も食[た]べません。", v: "Tôi không ăn gì cả." }
                ]
            },
            {
                p: "から", r: "kara", m: "Từ, vì",
                ex_jp: "９時[くじ]から働[はたら]きます。", ex_vi: "Làm việc từ 9 giờ.",
                usage: "Điểm bắt đầu (thời gian/không gian), nguyên nhân (lý do chủ quan).",
                nuance: "Thường đi với 'まで'. Khác 'ので' (lý do khách quan/lịch sự hơn).",
                more: [
                    { j: "東京[とうきょう]から来[き]ました。", v: "Đến từ Tokyo." },
                    { j: "危[あぶ]ないから、触[さわ]らないで。", v: "Vì nguy hiểm nên đừng chạm vào." }
                ]
            },
            {
                p: "まで", r: "made", m: "Đến",
                ex_jp: "５時[ごじ]まで寝[ね]ます。", ex_vi: "Ngủ đến 5 giờ.",
                usage: "Điểm kết thúc của hành động liên tục.",
                nuance: "Khác 'までに' (Trước thời điểm nào đó - Hạn chót).",
                more: [
                    { j: "駅[えき]まで走[はし]ります。", v: "Chạy đến nhà ga." },
                    { j: "朝[あさ]から晩[ばん]まで。", v: "Từ sáng đến tối." }
                ]
            },
            {
                p: "や", r: "ya", m: "Và (vân vân)",
                ex_jp: "本[ほん]やペンがあります。", ex_vi: "Có sách, bút (và những thứ khác).",
                usage: "Liệt kê đại diện, không kể hết.",
                nuance: "Thường đi kèm với 'など' (nado - vân vân) ở cuối.",
                more: [
                    { j: "猫[ねこ]や犬[いぬ]が好[す]きです。", v: "Tôi thích chó, mèo (v.v)." }
                ]
            }
        ];

        // --- QUIZ QUESTIONS (Generated based on data) ---
        const quizQuestions = [
            { q: "私___学生です。", a: "は", o: ["は", "を", "に", "で"], m: "Chủ đề câu" },
            { q: "ご飯___食べます。", a: "を", o: ["が", "を", "に", "へ"], m: "Tân ngữ trực tiếp" },
            { q: "東京___行きます。", a: "へ", o: ["を", "へ", "が", "で"], m: "Phương hướng di chuyển" },
            { q: "バス___帰ります。", a: "で", o: ["に", "で", "を", "と"], m: "Phương tiện" },
            { q: "６時___起きます。", a: "に", o: ["で", "を", "に", "は"], m: "Thời điểm cụ thể" },
            { q: "これ___私のです。", a: "は", o: ["の", "を", "は", "に"], m: "Chủ đề" },
            { q: "猫___います。", a: "が", o: ["を", "で", "が", "に"], m: "Chủ ngữ tồn tại (nhấn mạnh)" },
            { q: "友達___会います。", a: "に", o: ["を", "で", "に", "へ"], m: "Đối tượng gặp gỡ" },
            { q: "私___行きます。", a: "も", o: ["も", "を", "に", "で"], m: "Sự tương đồng (Cũng)" },
            { q: "明日___雨です。", a: "は", o: ["に", "を", "は", "で"], m: "Chủ đề thời gian" },
            { q: "図書館___勉強します。", a: "で", o: ["に", "で", "を", "へ"], m: "Nơi diễn ra hành động" },
            { q: "日本___のアニメ。", a: "の", o: ["は", "の", "が", "を"], m: "Sở hữu/Xuất xứ" }
        ];

        // --- STATE ---
        let showFurigana = true;
        let currentTab = 'learn';
        let currentQuestionIndex = 0;
        let score = 0;
        let currentQuizQ = null;

        // --- UTILS ---
        function parseRuby(text) {
            // Simple parser: "Text[Furi]" -> <ruby>Text<rt>Furi</rt></ruby>
            return text.replace(/([^\x00-\x7F]+)\[(.+?)\]/g, '<ruby>$1<rt>$2</rt></ruby>');
        }

        function speak(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const cleanText = text.replace(/\[.*?\]/g, '').replace(/<.*?>/g, '');
                const u = new SpeechSynthesisUtterance(cleanText);
                u.lang = 'ja-JP';
                u.rate = 0.9;
                window.speechSynthesis.speak(u);
            }
        }

        function switchTab(tab) {
            currentTab = tab;
            document.getElementById('learn-section').classList.toggle('hidden', tab !== 'learn');
            document.getElementById('quiz-section').classList.toggle('hidden', tab !== 'quiz');
            
            // Update Buttons
            const btnLearn = document.getElementById('tab-learn');
            const btnQuiz = document.getElementById('tab-quiz');
            if (tab === 'learn') {
                btnLearn.classList.add('tab-active'); btnLearn.classList.remove('tab-inactive');
                btnQuiz.classList.add('tab-inactive'); btnQuiz.classList.remove('tab-active');
            } else {
                btnQuiz.classList.add('tab-active'); btnQuiz.classList.remove('tab-inactive');
                btnLearn.classList.add('tab-inactive'); btnLearn.classList.remove('tab-active');
                startQuiz();
            }
        }

        // --- RENDER LEARN SECTION ---
        function renderParticles() {
            const grid = document.getElementById('particles-grid');
            grid.innerHTML = particlesData.map((item, index) => `
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden hover:shadow-md transition duration-300 flex flex-col group">
                    <div class="bg-sky-50 p-4 border-b border-sky-100 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-sky-600 text-white flex items-center justify-center text-xl font-bold kanji-font shadow-sm group-hover:scale-110 transition-transform">
                                ${item.p}
                            </div>
                            <div>
                                <div class="text-xs text-gray-500 font-bold uppercase tracking-wider">${item.r}</div>
                                <div class="font-bold text-gray-800">${item.m}</div>
                            </div>
                        </div>
                        <div class="text-sky-200 font-bold text-2xl opacity-20">#${index + 1}</div>
                    </div>
                    
                    <div class="p-4 flex-grow flex flex-col justify-between">
                        <div class="mb-4">
                            <div class="bg-gray-50 p-3 rounded-lg border border-gray-100 relative">
                                <p class="text-lg text-gray-800 kanji-font mb-1 pr-6">${parseRuby(item.ex_jp)}</p>
                                <p class="text-xs text-gray-500 italic">${item.ex_vi}</p>
                                <button onclick="speak('${item.ex_jp}')" class="absolute top-2 right-2 text-sky-400 hover:text-sky-600 p-1">
                                    <i class="fas fa-volume-up"></i>
                                </button>
                            </div>
                        </div>
                        
                        <button onclick="openModal('${item.p}')" class="w-full py-2 bg-white border border-sky-200 text-sky-600 rounded-lg hover:bg-sky-50 transition text-sm font-bold flex items-center justify-center gap-2">
                            <i class="fas fa-search-plus"></i> Xem Chi Tiết
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // --- MODAL LOGIC ---
        function openModal(particle) {
            const item = particlesData.find(p => p.p === particle);
            if (!item) return;

            document.getElementById('modal-particle').innerText = item.p;
            document.getElementById('modal-usage').innerText = item.usage;
            document.getElementById('modal-nuance').innerText = item.nuance || "Không có lưu ý đặc biệt.";
            
            const examplesList = document.getElementById('modal-examples');
            examplesList.innerHTML = item.more.map(ex => `
                <li class="flex items-start gap-3 bg-white p-3 rounded border border-gray-100">
                    <button onclick="speak('${ex.j}')" class="text-sky-400 hover:text-sky-600 mt-1 flex-shrink-0"><i class="fas fa-volume-up"></i></button>
                    <div>
                        <p class="kanji-font text-gray-800 font-medium">${parseRuby(ex.j)}</p>
                        <p class="text-xs text-gray-500">${ex.v}</p>
                    </div>
                </li>
            `).join('');

            document.getElementById('detail-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('detail-modal').classList.add('hidden');
        }

        // --- QUIZ LOGIC ---
        function startQuiz() {
            score = 0;
            currentQuestionIndex = 0;
            updateScore();
            loadQuestion();
        }

        function loadQuestion() {
            // Pick random question from list
            const q = quizQuestions[Math.floor(Math.random() * quizQuestions.length)];
            currentQuizQ = q;
            
            document.getElementById('q-current').innerText = currentQuestionIndex + 1;
            document.getElementById('quiz-sentence').innerHTML = q.q.replace('___', '<span class="text-sky-500 border-b-2 border-sky-500 px-2">___</span>');
            document.getElementById('quiz-translation').innerText = `(${q.m})`;
            
            const optionsHtml = q.o.map(opt => `
                <button onclick="checkAnswer('${opt}')" class="quiz-opt-btn bg-white border-2 border-gray-200 text-gray-700 py-4 rounded-xl text-xl font-bold kanji-font hover:border-sky-400 hover:bg-sky-50 transition active:scale-95 shadow-sm">
                    ${opt}
                </button>
            `).join('');
            document.getElementById('options-area').innerHTML = optionsHtml;
            document.getElementById('feedback-area').classList.add('hidden');
            
            // Update Progress
            document.getElementById('quiz-progress').style.width = `${((currentQuestionIndex) / 10) * 100}%`;
        }

        function checkAnswer(selected) {
            const btns = document.querySelectorAll('.quiz-opt-btn');
            btns.forEach(b => b.disabled = true); // Disable all buttons

            const isCorrect = selected === currentQuizQ.a;
            const feedbackArea = document.getElementById('feedback-area');
            const feedbackTitle = document.getElementById('feedback-title');
            const feedbackDetail = document.getElementById('feedback-detail');

            feedbackArea.classList.remove('hidden');
            
            if (isCorrect) {
                score += 10;
                updateScore();
                feedbackTitle.innerHTML = '<i class="fas fa-check-circle text-emerald-500 mr-2"></i> Chính xác!';
                feedbackTitle.className = "font-bold text-lg mb-1 flex items-center text-emerald-700";
                feedbackArea.className = "bg-emerald-50 rounded-xl p-4 border border-emerald-200 text-left animate-fade-in";
                feedbackDetail.innerText = `Đáp án là "${currentQuizQ.a}". Tuyệt vời!`;
                speak(currentQuizQ.q.replace('___', currentQuizQ.a));
            } else {
                feedbackTitle.innerHTML = '<i class="fas fa-times-circle text-red-500 mr-2"></i> Sai rồi!';
                feedbackTitle.className = "font-bold text-lg mb-1 flex items-center text-red-700";
                feedbackArea.className = "bg-red-50 rounded-xl p-4 border border-red-200 text-left animate-fade-in wrong-anim";
                feedbackDetail.innerHTML = `Đáp án đúng là <span class="font-bold text-red-600 text-lg mx-1">${currentQuizQ.a}</span>`;
            }
        }

        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex >= 10) { // Limit to 10 questions per session
                // End game logic can go here (e.g., Show summary)
                alert(`Kết thúc! Điểm của bạn: ${score}/100`);
                startQuiz(); // Restart
            } else {
                loadQuestion();
            }
        }

        function updateScore() {
            document.getElementById('score-display').innerText = score;
        }

        // --- GLOBAL EVENTS ---
        document.getElementById('toggle-furigana').addEventListener('click', (e) => {
            showFurigana = !showFurigana;
            document.body.classList.toggle('hide-furigana', !showFurigana);
            e.target.innerText = `Furi: ${showFurigana ? 'ON' : 'OFF'}`;
            e.target.classList.toggle('bg-sky-600', showFurigana);
            e.target.classList.toggle('bg-gray-400', !showFurigana);
        });

        // Init
        renderParticles();

    </script>
</body>
</html>
