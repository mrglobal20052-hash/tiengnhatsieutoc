<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AzaKanji - Master Trợ Từ & Phó Từ N3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #f0f9ff; overflow-x: hidden; }
        .kanji-font { font-family: 'Noto Sans JP', sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Ruby Control */
        ruby rt { font-size: 0.6em; color: #64748b; user-select: none; transition: opacity 0.3s; }
        .hide-furigana ruby rt { opacity: 0; }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .modal-enter { animation: modalIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        .correct-anim { animation: pulse-green 0.5s; }
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); } 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); } }
        
        .wrong-anim { animation: shake 0.4s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* Tab Active State */
        .tab-active { background-color: #0369a1; color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .tab-inactive { background-color: #e0f2fe; color: #0c4a6e; }
        
        /* Badges */
        .badge-particle { background-color: #0284c7; color: white; } /* Sky-600 */
        .badge-adverb { background-color: #ea580c; color: white; } /* Orange-600 */
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Header -->
    <header class="bg-sky-700 text-white shadow-lg sticky top-0 z-40">
        <div class="container mx-auto px-4 py-3">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center space-x-3 cursor-pointer" onclick="location.reload()">
                    <i class="fas fa-torii-gate text-3xl text-yellow-400"></i>
                    <div>
                        <h1 class="text-xl font-bold uppercase tracking-wider">AzaKanji Master</h1>
                        <p class="text-xs text-sky-200">Trợ Từ & Phó Từ N5-N3</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-2 overflow-x-auto max-w-full pb-1 md:pb-0">
                    <div class="flex bg-sky-800 rounded-lg p-1">
                        <button onclick="switchTab('learn')" id="tab-learn" class="px-4 py-2 rounded-md text-sm font-bold transition whitespace-nowrap tab-active">
                            <i class="fas fa-book-open mr-2"></i>Học Tập
                        </button>
                        <a href="https://tiengnhatsieutoc.com/ftrotu.html" class="flex-shrink-0 px-4 py-2 rounded-md text-xs md:text-sm font-bold transition whitespace-nowrap flex items-center hover:bg-indigo-800 ml-1">
                            <i class="fas fa-home mr-1 md:mr-2"></i>FlashCard
                        </a>
                        <button onclick="switchTab('quiz')" id="tab-quiz" class="px-4 py-2 rounded-md text-sm font-bold transition whitespace-nowrap tab-inactive ml-1">
                            <i class="fas fa-gamepad mr-2"></i>Luyện Tập
                        </button>
                    </div>
                    <button id="toggle-furigana" class="px-3 py-2 bg-sky-600 rounded-lg hover:bg-sky-500 transition text-xs font-bold whitespace-nowrap" title="Bật/Tắt Furigana">
                        Furi: ON
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6 flex-grow" id="app-container">
        
        <!-- LEARN SECTION -->
        <div id="learn-section" class="fade-in">
            <div class="mb-6 bg-white p-4 rounded-xl shadow-sm border-l-4 border-sky-500 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h3 class="text-lg font-bold text-gray-800 mb-1"><i class="fas fa-info-circle text-sky-500 mr-2"></i>Hệ thống Kiến thức N3</h3>
                    <p class="text-sm text-gray-600">Bao gồm 35 Trợ từ và 30 Phó từ (Mức độ, Thời gian, Trạng thái) quan trọng.</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="filterData('all')" class="filter-btn px-3 py-1 rounded-full text-xs font-bold bg-gray-800 text-white ring-2 ring-gray-300 transition-all">Tất cả</button>
                    <button onclick="filterData('particle')" class="filter-btn px-3 py-1 rounded-full text-xs font-bold bg-sky-100 text-sky-700 hover:bg-sky-200 transition-all">Trợ từ (Joshi)</button>
                    <button onclick="filterData('adverb')" class="filter-btn px-3 py-1 rounded-full text-xs font-bold bg-orange-100 text-orange-700 hover:bg-orange-200 transition-all">Phó từ (Fukushi)</button>
                </div>
            </div>
            
            <div id="particles-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Cards will be injected here -->
            </div>
        </div>

        <!-- QUIZ SECTION -->
        <div id="quiz-section" class="hidden fade-in max-w-2xl mx-auto">
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-200">
                <div class="bg-gradient-to-r from-emerald-500 to-teal-600 p-6 text-white flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-bold"><i class="fas fa-puzzle-piece mr-2"></i>Thử Thách</h2>
                        <p class="text-emerald-100 text-xs mt-1">Chọn từ đúng cho câu dưới đây</p>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-emerald-200 uppercase font-bold">Điểm số</div>
                        <div class="text-3xl font-bold" id="score-display">0</div>
                    </div>
                </div>
                
                <div class="p-6 md:p-8">
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-6">
                        <div id="quiz-progress" class="bg-emerald-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>

                    <div id="question-area" class="text-center mb-8">
                        <div class="text-gray-500 text-sm font-bold mb-4 uppercase tracking-wide">Câu hỏi <span id="q-current">1</span> / <span id="q-total">10</span></div>
                        <div class="text-2xl md:text-3xl kanji-font font-medium text-gray-800 mb-6 leading-relaxed" id="quiz-sentence"></div>
                        <div class="text-gray-500 italic text-sm" id="quiz-translation"></div>
                    </div>

                    <div id="options-area" class="grid grid-cols-2 gap-4 mb-6">
                        <!-- Options injected here -->
                    </div>

                    <div id="feedback-area" class="hidden bg-gray-50 rounded-xl p-4 border border-gray-200 text-left animate-fade-in">
                        <div id="feedback-title" class="font-bold text-lg mb-2 flex items-center"></div>
                        <p id="feedback-detail" class="text-gray-600 text-sm mb-3"></p>
                        <button onclick="nextQuestion()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-lg shadow transition">Tiếp tục <i class="fas fa-arrow-right ml-2"></i></button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- DETAIL MODAL -->
    <div id="detail-modal" class="fixed inset-0 z-50 hidden overflow-y-auto" role="dialog" aria-modal="true">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity backdrop-blur-sm" onclick="closeModal()"></div>
            <div class="inline-block align-bottom bg-white rounded-xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl w-full modal-enter relative">
                <div class="bg-sky-600 px-6 py-4 flex justify-between items-center text-white" id="modal-header">
                    <h3 class="text-xl font-bold flex items-center">
                        <span class="bg-white text-sky-700 px-4 py-2 rounded-xl flex items-center justify-center mr-3 text-lg font-black shadow-sm min-w-[3.5rem]" id="modal-particle"></span>
                        Chi tiết cách dùng
                    </h3>
                    <button onclick="closeModal()" class="hover:text-gray-200 text-2xl">&times;</button>
                </div>
                <div class="p-6 bg-gray-50 max-h-[70vh] overflow-y-auto">
                    <div class="space-y-4">
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                            <h4 class="font-bold text-sky-700 mb-2 text-sm uppercase"><i class="fas fa-book mr-2"></i>Định nghĩa & Cách dùng</h4>
                            <p class="text-gray-700 text-sm leading-relaxed" id="modal-usage"></p>
                        </div>
                        
                        <div class="bg-yellow-50 p-4 rounded-lg shadow-sm border border-yellow-200">
                            <h4 class="font-bold text-yellow-800 mb-2 text-sm uppercase"><i class="fas fa-lightbulb mr-2"></i>Sắc thái (Nuance)</h4>
                            <p class="text-gray-700 text-sm leading-relaxed italic" id="modal-nuance"></p>
                        </div>

                        <div id="modal-example-section">
                            <h4 class="font-bold text-gray-500 mb-3 text-xs uppercase tracking-wider">Ví dụ bổ sung</h4>
                            <ul class="space-y-3" id="modal-examples"></ul>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-100 px-6 py-3 flex justify-end">
                    <button type="button" class="inline-flex justify-center rounded-lg border border-transparent shadow-sm px-5 py-2 bg-sky-600 text-base font-medium text-white hover:bg-sky-700 focus:outline-none sm:text-sm" onclick="closeModal()">Đã hiểu</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA ---
        // Type: 'particle' (Trợ từ) or 'adverb' (Phó từ)
        const particlesData = [
            // PARTICLE DATA (JOSHI) - 35 items
            { p: "は", r: "wa", type: "particle", m: "Chủ đề (là, thì)", ex_jp: "私[わたし]は学生[がくせい]です。", ex_vi: "Tôi là sinh viên.", usage: "Xác định chủ đề chính của câu.", nuance: "Nhấn mạnh vào thông tin đứng sau.", more: [{ j: "俺[おれ]、学生[がくせい]だよ。", v: "Tớ là sinh viên đấy." }] },
            { p: "が", r: "ga", type: "particle", m: "Chủ ngữ / Tồn tại", ex_jp: "学生[がくせい]がいます。", ex_vi: "Có sinh viên.", usage: "Nhấn mạnh đối tượng thực hiện hành động hoặc dùng trong câu có/không.", nuance: "Nhấn mạnh vào chính chủ ngữ đứng trước.", more: [{ j: "教室[きょうしつ]に学生[がくせい]がいる。", v: "Có sinh viên trong lớp kìa." }] },
            { p: "を", r: "o", type: "particle", m: "Tân ngữ trực tiếp", ex_jp: "本[ほん]を読[よ]みます。", ex_vi: "Đọc sách.", usage: "Chỉ đối tượng chịu tác động của hành động.", nuance: "Dùng với tha động từ.", more: [{ j: "コーヒー飲[の]む？", v: "Uống cà phê không?" }] },
            { p: "に", r: "ni", type: "particle", m: "Thời gian / Địa điểm", ex_jp: "７時[じ]に起[お]きます。", ex_vi: "Thức dậy lúc 7 giờ.", usage: "Chỉ mốc thời gian, đích đến hoặc người nhận.", nuance: "Xác định điểm dừng của hành động.", more: [{ j: "７時[じ]に起[お]きる。", v: "7 giờ dậy nhé." }] },
            { p: "で", r: "de", type: "particle", m: "Nơi chốn / Phương tiện", ex_jp: "電車[でんしゃ]で行[い]きます。", ex_vi: "Đi bằng tàu điện.", usage: "Nơi diễn ra hành động hoặc công cụ thực hiện.", nuance: "Chỉ bối cảnh hoặc cách thức.", more: [{ j: "電車[でんしゃ]で行[い]く。", v: "Đi tàu điện nhé." }] },
            { p: "へ", r: "e", type: "particle", m: "Hướng di chuyển", ex_jp: "日本[にほん]へ行[い]きます。", ex_vi: "Đi Nhật Bản.", usage: "Chỉ hướng của hành động di chuyển.", nuance: "Nhấn mạnh vào quá trình/hướng đi.", more: [{ j: "日本[にほん]行[い]く。", v: "Đi Nhật đây." }] },
            { p: "と", r: "to", type: "particle", m: "Và / Cùng với", ex_jp: "友達[ともだち]と遊[あそ]びます。", ex_vi: "Chơi với bạn bè.", usage: "Liệt kê danh từ hoặc chỉ đối tượng làm cùng.", nuance: "Nối các danh từ ngang hàng.", more: [{ j: "友達[ともだち]と遊[あそ]ぶ。", v: "Chơi với bạn." }] },
            { p: "の", r: "no", type: "particle", m: "Sở hữu / Bổ nghĩa", ex_jp: "私[わたし]の本[ほん]です。", ex_vi: "Là sách của tôi.", usage: "Nối hai danh từ. Của...", nuance: "Xác định quan hệ sở hữu hoặc tính chất.", more: [{ j: "これ、俺[おれ]の本[ほん]。", v: "Đây là sách của tớ." }] },
            { p: "も", r: "mo", type: "particle", m: "Cũng", ex_jp: "私[わたし]も学生[がくせい]です。", ex_vi: "Tôi cũng là sinh viên.", usage: "Nhấn mạnh sự tương đồng.", nuance: "Thay thế cho wa, ga, o.", more: [{ j: "私[わたし]も学生[がくせい]だよ。", v: "Tớ cũng là sinh viên nè." }] },
            { p: "から", r: "kara", type: "particle", m: "Từ (Mốc đầu)", ex_jp: "９時[くじ]から働[はたら]きます。", ex_vi: "Làm việc từ 9 giờ.", usage: "Phạm vi thời gian hoặc địa điểm bắt đầu.", nuance: "Nguồn gốc hoặc điểm khởi đầu.", more: [{ j: "９時[くじ]から働[はたら]く。", v: "Làm từ 9 giờ." }] },
            { p: "まで", r: "made", type: "particle", m: "Đến (Mốc cuối)", ex_jp: "５時[ごじ]まで寝[ね]ます。", ex_vi: "Ngủ đến 5 giờ.", usage: "Giới hạn cuối của thời gian hoặc không gian.", nuance: "Điểm kết thúc hành động.", more: [{ j: "５時[ごじ]まで寝[ね]る。", v: "Ngủ tới 5 giờ." }] },
            { p: "か", r: "ka", type: "particle", m: "Hoặc / Câu hỏi", ex_jp: "行[い]きますか。", ex_vi: "Có đi không?", usage: "Kết thúc câu hỏi hoặc lựa chọn giữa A và B.", nuance: "Nghi vấn từ.", more: [{ j: "行[い]くか？", v: "Đi không?" }] },
            { p: "ね", r: "ne", type: "particle", m: "Nhỉ / Nhé", ex_jp: "暑[あつ]いですね。", ex_vi: "Nóng nhỉ.", usage: "Tìm kiếm sự đồng tình.", nuance: "Dùng khi cả hai cùng biết thông tin.", more: [{ j: "暑[あつ]いね。", v: "Nóng nhỉ." }] },
            { p: "よ", r: "yo", type: "particle", m: "Đấy / Nhé", ex_jp: "おいしいですよ。", ex_vi: "Ngon lắm đấy.", usage: "Cung cấp thông tin mới cho người nghe.", nuance: "Nhấn mạnh ý kiến cá nhân.", more: [{ j: "おいしいよ。", v: "Ngon đấy." }] },
            { p: "より", r: "yori", type: "particle", m: "So sánh hơn", ex_jp: "これよりあれが安[やす]いです。", ex_vi: "Cái kia rẻ hơn cái này.", usage: "Dùng để so sánh các đối tượng.", nuance: "Nhấn mạnh sự khác biệt về mức độ.", more: [{ j: "これより、あっち。", v: "Cái kia hơn." }] },
            { p: "ほど", r: "hodo", type: "particle", m: "Đến mức / Không bằng", ex_jp: "昨日[きのう]ほど暑[あつ]くないです。", ex_vi: "Không nóng bằng hôm qua.", usage: "Chỉ mức độ hoặc so sánh kém.", nuance: "Thường dùng trong câu phủ định.", more: [{ j: "死[し]ぬほど疲[つか]れた。", v: "Mệt muốn chết." }] },
            { p: "くらい", r: "kurai", type: "particle", m: "Khoảng / Đến mức", ex_jp: "30分[さんじゅっぷん]ぐらい休[やす]みます。", ex_vi: "Nghỉ khoảng 30 phút.", usage: "Chỉ số lượng hoặc mức độ đại khái.", nuance: "Tương đương với goro nhưng linh hoạt hơn.", more: [{ j: "これくらい、いいよ。", v: "Chừng này là được rồi." }] },
            { p: "しか", r: "shika", type: "particle", m: "Chỉ (đi với phủ định)", ex_jp: "1000円[えん]しかありません。", ex_vi: "Tôi chỉ còn 1000 yên.", usage: "Nhấn mạnh sự ít ỏi, duy nhất.", nuance: "Luôn đi với động từ phủ định.", more: [{ j: "一人[ひとり]しかいない。", v: "Chỉ có mỗi một người." }] },
            { p: "だけ", r: "dake", type: "particle", m: "Chỉ (khẳng định)", ex_jp: "私[わたし]だけ行[い]きます。", ex_vi: "Chỉ mình tôi đi.", usage: "Xác định giới hạn phạm vi.", nuance: "Dùng với câu khẳng định.", more: [{ j: "寝[ね]るだけだ。", v: "Chỉ ngủ thôi." }] },
            { p: "までに", r: "made ni", type: "particle", m: "Trước khi / Trước lúc", ex_jp: "5時[ごじ]までに帰[かえ]ります。", ex_vi: "Tôi sẽ về trước 5 giờ.", usage: "Chỉ thời hạn chót của hành động.", nuance: "Hành động phải xong trước mốc này.", more: [{ j: "明日[あした]までにやって。", v: "Làm xong trước mai nhé." }] },
            { p: "ばかり", r: "bakari", type: "particle", m: "Toàn là / Vừa mới", ex_jp: "肉[にく]ばかり食[た]べます。", ex_vi: "Toàn ăn thịt thôi.", usage: "Chỉ sự lặp lại nhiều lần hoặc vừa kết thúc.", nuance: "Có thể mang sắc thái chê bai.", more: [{ j: "起[お]きたばかりだ。", v: "Vừa mới dậy xong." }] },
            { p: "には", r: "ni wa", type: "particle", m: "Đối với... thì", ex_jp: "私[わたし]には難[むずか]しいです。", ex_vi: "Đối với tôi thì khó.", usage: "Xác định chủ đề cho đối tượng cụ thể.", nuance: "Nhấn mạnh phạm vi áp dụng.", more: [{ j: "俺[おれ]には無理[むり]。", v: "Với tớ thì chịu." }] },
            { p: "とは", r: "to wa", type: "particle", m: "Cái gọi là / Định nghĩa", ex_jp: "自由[じゆう]とは何[なん]ですか。", ex_vi: "Tự do có nghĩa là gì?", usage: "Định nghĩa một danh từ.", nuance: "Văn viết hoặc giải thích khái niệm.", more: [{ j: "自由[じゆう]って何[なに]？", v: "Tự do là cái gì vậy?" }] },
            { p: "への", r: "e no", type: "particle", m: "Hướng tới / Đến", ex_jp: "日本[にほん]への旅行[りょこう]。", ex_vi: "Chuyến đi đến Nhật Bản.", usage: "Bổ nghĩa phương hướng cho danh từ sau.", nuance: "E (hướng) + No (sở hữu).", more: [{ j: "日本[にほん]への旅行[りょこう]、楽[たの]しみ！", v: "Đi Nhật thích quá!" }] },
            { p: "にも", r: "ni mo", type: "particle", m: "Cũng ở / Cũng cho", ex_jp: "東京[とうきょう]にも雪[ゆき]が降[ふ]りました。", ex_vi: "Ở Tokyo cũng có tuyết.", usage: "Cũng tồn tại/xảy ra tại một địa điểm.", nuance: "Ni (địa điểm) + Mo (cũng).", more: [{ j: "東京[とうきょう]にも雪[ゆき]降[ふ]ったよ。", v: "Tokyo cũng có tuyết rồi." }] },
            { p: "とも", r: "to mo", type: "particle", m: "Cùng với cả", ex_jp: "家族[かぞく]とも相談[そうだん]します。", ex_vi: "Thảo luận với cả gia đình.", usage: "Cũng thực hiện cùng với ai đó.", nuance: "To (với) + Mo (cũng).", more: [{ j: "家族[かぞく]とも話[はな]す。", v: "Cũng nói với cả nhà." }] },
            { p: "において", r: "ni oite", type: "particle", m: "Tại / Ở (Trang trọng)", ex_jp: "会議[かいぎ]はホールにおいて行[おこな]われます。", ex_vi: "Hội nghị tổ chức tại hội trường.", usage: "Chỉ địa điểm, thời gian, lĩnh vực.", nuance: "Thay cho 'de' trong văn phong trang trọng.", more: [{ j: "歴史[れきし]において重要[じゅうよう]だ。", v: "Quan trọng trong lịch sử." }] },
            { p: "として", r: "toshite", type: "particle", m: "Với tư cách là", ex_jp: "留学生[りゅうがくせい]として来[き]ました。", ex_vi: "Đến với tư cách du học sinh.", usage: "Chỉ vai trò, danh nghĩa.", nuance: "Nhấn mạnh vị thế của đối tượng.", more: [{ j: "趣味[しゅみ]としてやってる。", v: "Làm vì sở thích thôi." }] },
            { p: "によって", r: "ni yotte", type: "particle", m: "Do / Bởi / Tùy vào", ex_jp: "人[ひと]によって違[ちが]います。", ex_vi: "Tùy người mà khác nhau.", usage: "Nguyên nhân, tác giả, phương pháp, sự khác biệt.", nuance: "Rất quan trọng trong văn viết N3.", more: [{ j: "台風[たいふう]によって壊[こわ]れた。", v: "Bị hỏng do bão." }] },
            { p: "に対して", r: "ni taishite", type: "particle", m: "Đối với / Trái với", ex_jp: "先生[せんせい]に対して失礼[しつれい]です。", ex_vi: "Thất lễ với giáo viên.", usage: "Đối tượng hướng tới hoặc sự đối lập.", nuance: "Thái độ ứng xử.", more: [{ j: "客[きゃく]に対して怒[おこ]るな。", v: "Đừng giận với khách." }] },
            { p: "について", r: "ni tsuite", type: "particle", m: "Về việc (Liên quan)", ex_jp: "将来[しょうらい]について考[かんが]えます。", ex_vi: "Suy nghĩ về tương lai.", usage: "Chỉ nội dung, chủ đề đang bàn luận.", nuance: "Về một đề tài cụ thể.", more: [{ j: "これについて話[はな]そう。", v: "Nói về chuyện này đi." }] },
            { p: "にわたって", r: "ni watatte", type: "particle", m: "Suốt / Khắp", ex_jp: "２０年[ねん]にわたって研究[けんきゅう]した。", ex_vi: "Nghiên cứu suốt 20 năm.", usage: "Chỉ phạm vi thời gian/không gian lớn.", nuance: "Nhấn mạnh quy mô.", more: [{ j: "広範囲[こうはんい]にわたる。", v: "Trải dài phạm vi rộng." }] },
            { p: "に沿って", r: "ni sotte", type: "particle", m: "Dọc theo / Theo sát", ex_jp: "川[かわ]に沿[そ]って歩[ある]きます。", ex_vi: "Đi bộ dọc theo sông.", usage: "Làm theo một quy tắc, lộ trình có sẵn.", nuance: "Tuân thủ sự dẫn dắt.", more: [{ j: "計画[けいかく]に沿[そ]ってやる。", v: "Làm theo kế hoạch." }] },
            { p: "に際して", r: "ni saishite", type: "particle", m: "Nhân dịp / Khi làm gì", ex_jp: "受験[じゅけん]に際[さい]して注意[ちゅうい]する。", ex_vi: "Lưu ý khi đi thi.", usage: "Khi bắt đầu một sự kiện trang trọng.", nuance: "Dùng trong thông báo.", more: [{ j: "帰国[きこく]に際[さい]して挨拶[あいさつ]する。", v: "Chào hỏi khi về nước." }] },
            { p: "をめぐって", r: "o megutte", type: "particle", m: "Xoay quanh", ex_jp: "問題[もんだい]をめぐって争[あらそ]う。", ex_vi: "Tranh cãi xoay quanh vấn đề.", usage: "Chủ đề gây ra nhiều ý kiến trái chiều.", nuance: "Thường dùng với số đông.", more: [{ j: "噂[うわさ]をめぐって大騒[おおさわ]ぎだ。", v: "Lùm xùm quanh lời đồn." }] },

            // ADVERB DATA (DEGREE) - 15 items
            { p: "ずいぶん", r: "zuibun", type: "adverb", m: "Khá là (Ngạc nhiên)", ex_jp: "ずいぶん寒[さむ]くなった。", ex_vi: "Trời đã khá lạnh rồi.", usage: "Biểu thị mức độ cao hơn suy nghĩ, mong đợi.", nuance: "Thường chứa cảm xúc ngạc nhiên.", more: [{ j: "ずいぶん待[ま]ったよ。", v: "Tôi đã đợi khá lâu đấy." }] },
            { p: "かなり", r: "kanari", type: "adverb", m: "Tương đối / Khá", ex_jp: "かなり上手[じょうず]だ。", ex_vi: "Khá là giỏi đấy.", usage: "Mức độ cao hơn mức trung bình.", nuance: "Khách quan hơn zuibun.", more: [{ j: "かなり難[むずか]しい。", v: "Tương đối khó." }] },
            { p: "相当", r: "soutou", type: "adverb", m: "Khá nhiều", ex_jp: "相当[そうとう]疲[つか]れている。", ex_vi: "Đang khá là mệt mỏi.", usage: "Mức độ rất cao, tương đương với một mức nào đó.", nuance: "Trang trọng hơn kanari.", more: [{ j: "相当[そうとう]な金額[きんがく]だ。", v: "Số tiền khá lớn đấy." }] },
            { p: "めちゃくちゃ", r: "mechakucha", type: "adverb", m: "Cực kỳ / Lộn xộn", ex_jp: "めちゃくちゃ重[おも]い。", ex_vi: "Nặng kinh khủng.", usage: "Mức độ cực cao (văn nói).", nuance: "Thân mật, suồng sã.", more: [{ j: "部屋[へや]がめちゃくちゃだ。", v: "Phòng bừa bộn quá." }] },
            { p: "めったに", r: "mettani", type: "adverb", m: "Hiếm khi", ex_jp: "めったに怒[おこ]らない。", ex_vi: "Hiếm khi nổi giận.", usage: "Tần suất rất thấp.", nuance: "Bắt buộc đi với thể Phủ định.", more: [{ j: "めったに会[あ]えない。", v: "Hiếm khi gặp được." }] },
            { p: "ほとんど", r: "hotondo", type: "adverb", m: "Hầu hết / Gần như", ex_jp: "ほとんど終[お]わった。", ex_vi: "Đã xong hầu hết rồi.", usage: "Chỉ số lượng gần đạt 100%.", nuance: "Có thể dùng khẳng định hoặc phủ định.", more: [{ j: "ほとんど寝[ね]てない。", v: "Gần như không ngủ." }] },
            { p: "大分", r: "daibu", type: "adverb", m: "Khá là / Nhiều rồi", ex_jp: "大分[だいぶ]良[よ]くなった。", ex_vi: "Đã đỡ hơn nhiều rồi.", usage: "So sánh sự thay đổi trạng thái.", nuance: "Thường dùng cho sự biến đổi.", more: [{ j: "大分[だいぶ]待[ま]った。", v: "Đợi khá lâu rồi." }] },
            { p: "たっぷり", r: "tappuri", type: "adverb", m: "Đầy ắp / Dư thừa", ex_jp: "時間[じかん]がたっぷりある。", ex_vi: "Có dư dả thời gian.", usage: "Số lượng nhiều, thoải mái.", nuance: "Cảm giác tích cực, đầy đủ.", more: [{ j: "栄養[えいよう]たっぷり。", v: "Đầy đủ dinh dưỡng." }] },
            { p: "多少", r: "tashou", type: "adverb", m: "Một chút / Ít nhiều", ex_jp: "多少[たしょう]のミスはある。", ex_vi: "Cũng có một chút lỗi.", usage: "Mức độ không nhiều nhưng có.", nuance: "Văn viết, trang trọng hơn sukoshi.", more: [{ j: "多少[たしょう]遅[おく]れる。", v: "Sẽ muộn một chút." }] },
            { p: "ぎっしり", r: "gisshiri", type: "adverb", m: "Chật ních", ex_jp: "予定[よてい]がぎっしりだ。", ex_vi: "Lịch trình kín mít.", usage: "Không còn khoảng trống.", nuance: "Cảm giác chật chội, đầy ứ.", more: [{ j: "箱[はこ]にぎっしり詰[つ]まる。", v: "Nhét đầy trong hộp." }] },
            { p: "すっかり", r: "sukkari", type: "adverb", m: "Hoàn toàn", ex_jp: "すっかり忘[わす]れた。", ex_vi: "Quên sạch sành sanh.", usage: "Trạng thái hoàn tất 100%.", nuance: "Thường dùng cho sự thay đổi xong xuôi.", more: [{ j: "すっかり春[はる]だね。", v: "Hoàn toàn là mùa xuân rồi." }] },
            { p: "わずか", r: "wazuka", type: "adverb", m: "Vỏn vẹn / Chỉ", ex_jp: "わずかな希望[きぼう]だ。", ex_vi: "Hy vọng mong manh.", usage: "Số lượng cực ít, không đáng kể.", nuance: "Nhấn mạnh sự ít ỏi.", more: [{ j: "残[のこ]りわずか。", v: "Chỉ còn lại một chút." }] },
            { p: "およそ", r: "oyoso", type: "adverb", m: "Khoảng / Đại khái", ex_jp: "およそ一時間[いちじかん]だ。", ex_vi: "Khoảng 1 tiếng đồng hồ.", usage: "Ước lượng con số.", nuance: "Trang trọng hơn 'yaku'.", more: [{ j: "およその見当[けんとう]。", v: "Dự đoán đại khái." }] },
            { p: "もっと", r: "motto", type: "adverb", m: "Hơn nữa", ex_jp: "もっと頑張[がんば]る。", ex_vi: "Sẽ cố gắng hơn nữa.", usage: "Tăng mức độ lên so với hiện tại.", nuance: "Mong muốn tiến bộ.", more: [{ j: "もっと食[た]べたい。", v: "Muốn ăn thêm nữa." }] },
            { p: "一番", r: "ichiban", type: "adverb", m: "Nhất / Số 1", ex_jp: "一番[いちばん]大切[たいせつ]だ。", ex_vi: "Quan trọng nhất.", usage: "So sánh cao nhất.", nuance: "Vị trí độc tôn.", more: [{ j: "これが一番[いちばん]好[す]き。", v: "Thích cái này nhất." }] },

            // ADVERB DATA (MANNER/STATE - NEW N3) - 5 items
            { p: "うっかり", r: "ukkari", type: "adverb", m: "Lơ đễnh / Trót", ex_jp: "うっかり秘密[ひみつ]を言[い]った。", ex_vi: "Lỡ miệng nói ra bí mật.", usage: "Làm sai do không chú ý.", nuance: "Thường đi với 'shimatta'.", more: [{ j: "うっかり忘[わす]れた。", v: "Trót quên mất." }] },
            { p: "わざと", r: "wazato", type: "adverb", m: "Cố tình", ex_jp: "わざと負[ま]けた。", ex_vi: "Cố tình thua.", usage: "Hành động có chủ đích (thường là xấu).", nuance: "Trái ngược với 'ukkari'.", more: [{ j: "わざとじゃないよ！", v: "Tớ không cố ý đâu!" }] },
            { p: "こっそり", r: "kossori", type: "adverb", m: "Lén lút", ex_jp: "こっそり逃[に]げた。", ex_vi: "Lén lút bỏ trốn.", usage: "Làm để không ai biết.", nuance: "Hành động bí mật.", more: [{ j: "こっそり見[み]る。", v: "Nhìn trộm." }] },
            { p: "ぼんやり", r: "bonyari", type: "adverb", m: "Mờ ảo / Lơ đãng", ex_jp: "山[やま]がぼんやり見[み]える。", ex_vi: "Nhìn thấy núi mờ mờ.", usage: "Không rõ ràng (thị giác hoặc tâm trí).", nuance: "Trạng thái không tập trung.", more: [{ j: "ぼんやり考[かんが]える。", v: "Suy nghĩ vẩn vơ." }] },
            { p: "ぎりぎり", r: "girigiri", type: "adverb", m: "Sát nút", ex_jp: "時間[じかん]ぎりぎりに着[つ]いた。", ex_vi: "Đến sát nút giờ.", usage: "Vừa đủ, không dư thừa.", nuance: "Cảm giác nguy hiểm, suýt soát.", more: [{ j: "ぎりぎり合格[ごうかく]だ。", v: "Vừa đủ điểm đậu." }] },

            // ADVERB DATA (TIME - NEW N3) - 5 items
            { p: "今にも", r: "ima ni mo", type: "adverb", m: "Sắp sửa (xảy ra)", ex_jp: "今[いま]にも雨[あめ]が降[ふ]りそうだ。", ex_vi: "Trời trông như sắp mưa ngay.", usage: "Dự đoán sự việc sắp xảy ra ngay lập tức.", nuance: "Thường dùng cho thay đổi tiêu cực.", more: [{ j: "今[いま]にも泣[な]きそう。", v: "Sắp khóc đến nơi rồi." }] },
            { p: "やがて", r: "yagate", type: "adverb", m: "Chẳng mấy chốc", ex_jp: "やがて夏[なつ]が来[く]る。", ex_vi: "Chẳng mấy chốc mùa hè sẽ tới.", usage: "Thời gian trôi qua và sự việc sẽ đến.", nuance: "Văn viết, trang trọng hơn 'mamonaku'.", more: [{ j: "やがてわかるよ。", v: "Rồi cậu sẽ hiểu thôi." }] },
            { p: "いつの間にか", r: "itsunomanika", type: "adverb", m: "Lúc nào không hay", ex_jp: "いつの間[ま]にか寝[ね]ていた。", ex_vi: "Ngủ quên lúc nào không biết.", usage: "Sự việc xảy ra mà mình không nhận ra.", nuance: "Ngạc nhiên về sự thay đổi.", more: [{ j: "いつの間[ま]にか夜[よる]だ。", v: "Trời tối lúc nào không hay." }] },
            { p: "たまたま", r: "tamatama", type: "adverb", m: "Tình cờ / Ngẫu nhiên", ex_jp: "たまたま駅[えき]で会[あ]った。", ex_vi: "Tình cờ gặp ở nhà ga.", usage: "Sự việc xảy ra không có kế hoạch.", nuance: "Ngẫu nhiên.", more: [{ j: "たまたま持[も]っていた。", v: "Tình cờ mang theo." }] },
            { p: "いきなり", r: "ikinari", type: "adverb", m: "Đột nhiên", ex_jp: "いきなり泣[な]き出[だ]した。", ex_vi: "Đột nhiên bật khóc.", usage: "Hành động bất ngờ, không báo trước.", nuance: "Gây ngạc nhiên hoặc khó chịu.", more: [{ j: "いきなり変[か]えるな。", v: "Đừng có đổi đột ngột thế." }] },

            // ADVERB DATA (ASSERTION/CONJECTURE - NEW N3) - 5 items
            { p: "案外", r: "angai", type: "adverb", m: "Không ngờ / Bất ngờ", ex_jp: "案外[あんがい]高[たか]かった。", ex_vi: "Đắt hơn tôi tưởng.", usage: "Khác với dự đoán chủ quan.", nuance: "Ngạc nhiên nhẹ.", more: [{ j: "案外[あんがい]簡単[かんたん]だ。", v: "Đơn giản không ngờ." }] },
            { p: "決して", r: "kesshite", type: "adverb", m: "Tuyệt đối không", ex_jp: "決[けっ]して諦[あきら]めない。", ex_vi: "Tuyệt đối không bỏ cuộc.", usage: "Phủ định mạnh mẽ.", nuance: "Đi với thể phủ định (nai).", more: [{ j: "決[けっ]して忘[わす]れない。", v: "Không bao giờ quên." }] },
            { p: "まさか", r: "masaka", type: "adverb", m: "Không lẽ nào / Chắc chắn không", ex_jp: "まさか失敗[しっぱい]するとは。", ex_vi: "Không ngờ lại thất bại.", usage: "Phủ định khả năng xảy ra.", nuance: "Cảm xúc ngạc nhiên cực độ.", more: [{ j: "まさか彼[かれ]が犯人[はんにん]？", v: "Không lẽ anh ta là thủ phạm?" }] },
            { p: "ちっとも", r: "chittomo", type: "adverb", m: "Một chút cũng không", ex_jp: "ちっとも変[か]わらない。", ex_vi: "Chẳng thay đổi chút nào.", usage: "Phủ định hoàn toàn.", nuance: "Văn nói, nhấn mạnh hơn 'sukoshi mo'.", more: [{ j: "ちっとも面白[おもしろ]くない。", v: "Chẳng thú vị tẹo nào." }] },
            { p: "まるで", r: "marude", type: "adverb", m: "Cứ như là", ex_jp: "まるで夢[ゆめ]のようだ。", ex_vi: "Cứ như là mơ vậy.", usage: "So sánh ví von.", nuance: "Thường đi với 'you da' / 'mitai'.", more: [{ j: "まるで子供[こども]だ。", v: "Cứ như trẻ con vậy." }] }
        ];

        // --- QUIZ QUESTIONS ---
        const quizQuestions = [
            // Particles
            { q: "私___学生です。", a: "は", o: ["は", "が", "を", "に"], m: "Chủ đề câu" },
            { q: "学生___います。", a: "が", o: ["を", "が", "に", "で"], m: "Chủ ngữ tồn tại" },
            { q: "コーヒー___飲みます。", a: "を", o: ["を", "に", "は", "が"], m: "Tân ngữ trực tiếp" },
            { q: "７時___起きます。", a: "に", o: ["に", "で", "を", "は"], m: "Mốc thời gian cụ thể" },
            { q: "電車___行きます。", a: "で", o: ["へ", "で", "を", "と"], m: "Phương tiện di chuyển" },
            { q: "日本___行きます。", a: "へ", o: ["へ", "を", "が", "の"], m: "Hướng di chuyển" },
            { q: "友達___遊びます。", a: "と", o: ["と", "に", "で", "を"], m: "Cùng với ai đó" },
            { q: "これ、俺___本だよ。", a: "の", o: ["は", "の", "が", "を"], m: "Sở hữu vật" },
            { q: "私___学生です。", a: "も", o: ["も", "を", "に", "は"], m: "Sự tương đồng (Cũng)" },
            { q: "９時___働きます。", a: "から", o: ["から", "まで", "に", "で"], m: "Mốc bắt đầu" },
            { q: "５時___勉強します。", a: "まで", o: ["まで", "から", "に", "へ"], m: "Mốc kết thúc" },
            { q: "行きます___？", a: "か", o: ["か", "ね", "よ", "を"], m: "Nghi vấn" },
            { q: "暑い___。", a: "ね", o: ["ね", "よ", "か", "は"], m: "Xác nhận cảm xúc" },
            { q: "行く___！", a: "よ", o: ["よ", "ね", "か", "を"], m: "Thông báo/Nhấn mạnh" },
            { q: "これ___あれが安い。", a: "より", o: ["より", "ほど", "だけ", "しか"], m: "So sánh hơn" },
            { q: "昨日___暑くない。", a: "ほど", o: ["ほど", "より", "だけ", "しか"], m: "So sánh kém" },
            { q: "30分___休みます。", a: "くらい", o: ["くらい", "より", "しか", "だけ"], m: "Số lượng đại khái" },
            { q: "1000円___ありません。", a: "しか", o: ["しか", "だけ", "ほど", "より"], m: "Chỉ (đi với phủ định)" },
            { q: "私___が行きます。", a: "だけ", o: ["だけ", "しか", "ほど", "より"], m: "Chỉ (đi với khẳng định)" },
            { q: "5時___に帰ります。", a: "までに", o: ["までに", "まで", "から", "より"], m: "Thời hạn chót" },
            { q: "肉___食べます。", a: "ばかり", o: ["ばかり", "だけ", "しか", "ほど"], m: "Toàn là một thứ" },
            { q: "私___難しいです。", a: "には", o: ["には", "への", "とも", "とは"], m: "Đối với đối tượng" },
            { q: "自由___何ですか。", a: "とは", o: ["とは", "には", "への", "とも"], m: "Định nghĩa khái niệm" },
            { q: "日本___旅行、楽しみ。", a: "への", o: ["への", "とは", "にも", "とも"], m: "Chuyến đi hướng đến" },
            { q: "東京___雪が降った。", a: "にも", o: ["にも", "への", "とも", "とは"], m: "Cũng tại địa điểm" },
            { q: "家族___相談します。", a: "とも", o: ["とも", "にも", "とは", "には"], m: "Cùng với cả đối tượng" },
            { q: "会議はホール___行われる。", a: "において", o: ["において", "として", "によって", "に対して"], m: "Tại địa điểm trang trọng" },
            { q: "留学生___来ました。", a: "として", o: ["として", "について", "に対して", "によって"], m: "Vị trí/Tư cách" },
            { q: "人___違います。", a: "によって", o: ["によって", "として", "に対して", "について"], m: "Tùy vào mỗi người" },
            { q: "先生___失礼です。", a: "に対して", o: ["に対して", "について", "によって", "として"], m: "Đối với đối tượng (thái độ)" },
            { q: "将来___考えます。", a: "について", o: ["について", "に対して", "として", "によって"], m: "Về nội dung liên quan" },
            { q: "２０年___研究した。", a: "にわたって", o: ["にわたって", "に沿って", "に際して", "をめぐって"], m: "Suốt phạm vi rộng" },
            { q: "川___歩きます。", a: "に沿って", o: ["に沿って", "にわたって", "に際して", "をめぐって"], m: "Dọc theo hình dáng" },
            { q: "受験___注意点。", a: "に際して", o: ["に際して", "に沿って", "にわたって", "をめぐって"], m: "Khi thực hiện sự kiện" },
            { q: "問題___争う。", a: "をめぐって", o: ["をめぐって", "に際して", "に沿って", "にわたって"], m: "Xoay quanh tranh luận" },
            // Adverbs Quiz (Expanded)
            { q: "___寒くなったね。", a: "ずいぶん", o: ["ずいぶん", "めったに", "ぎっしり", "わずか"], m: "Khá là (ngạc nhiên)" },
            { q: "___怒らない人だ。", a: "めったに", o: ["めったに", "たっぷり", "もっと", "一番"], m: "Hiếm khi (phủ định)" },
            { q: "予定が___だ。", a: "ぎっしり", o: ["ぎっしり", "めったに", "多少", "わずか"], m: "Chật ních" },
            { q: "___終わったよ。", a: "ほとんど", o: ["ほとんど", "もっと", "一番", "たっぷり"], m: "Hầu hết" },
            { q: "___良くなった。", a: "大分", o: ["大分", "ぎっしり", "めったに", "わずか"], m: "Khá hơn nhiều" },
            { q: "___秘密を言った。", a: "うっかり", o: ["うっかり", "たっぷり", "わざと", "ぎっしり"], m: "Lỡ miệng" },
            { q: "___雨が降りそうだ。", a: "今にも", o: ["今にも", "やがて", "いつの間にか", "たまたま"], m: "Sắp sửa (ngay lập tức)" },
            { q: "___諦めない。", a: "決して", o: ["決して", "案外", "まさか", "まるで"], m: "Tuyệt đối không" },
            { q: "___彼が犯人？", a: "まさか", o: ["まさか", "決して", "ちっとも", "案外"], m: "Không lẽ nào" },
            { q: "___夢のようだ。", a: "まるで", o: ["まるで", "案外", "うっかり", "こっそり"], m: "Cứ như là" }
        ];

        // --- CORE LOGIC ---
        let showFurigana = true;
        let currentTab = 'learn';
        let currentFilter = 'all';
        let currentQuestionIndex = 0;
        let score = 0;
        let currentQuizQ = null;

        function parseRuby(text) {
            return text.replace(/([^\x00-\x7F]+)\[(.+?)\]/g, '<ruby>$1<rt>$2</rt></ruby>');
        }

        function speak(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const cleanText = text.replace(/\[.*?\]/g, '').replace(/<.*?>/g, '');
                const u = new SpeechSynthesisUtterance(cleanText);
                u.lang = 'ja-JP';
                u.rate = 0.85;
                window.speechSynthesis.speak(u);
            }
        }

        function switchTab(tab) {
            currentTab = tab;
            document.getElementById('learn-section').classList.toggle('hidden', tab !== 'learn');
            document.getElementById('quiz-section').classList.toggle('hidden', tab !== 'quiz');
            document.getElementById('tab-learn').classList.toggle('tab-active', tab === 'learn');
            document.getElementById('tab-learn').classList.toggle('tab-inactive', tab !== 'learn');
            document.getElementById('tab-quiz').classList.toggle('tab-active', tab === 'quiz');
            document.getElementById('tab-quiz').classList.toggle('tab-inactive', tab !== 'quiz');
            if (tab === 'quiz') startQuiz();
        }

        function filterData(type) {
            currentFilter = type;
            const btns = document.querySelectorAll('.filter-btn');
            btns.forEach(btn => {
                const isActive = (type === 'all' && btn.innerText.includes('Tất cả')) ||
                               (type === 'particle' && btn.innerText.includes('Trợ từ')) ||
                               (type === 'adverb' && btn.innerText.includes('Phó từ'));
                if (isActive) {
                    btn.classList.add('ring-2', 'ring-offset-2', 'ring-sky-500');
                } else {
                    btn.classList.remove('ring-2', 'ring-offset-2', 'ring-sky-500');
                }
            });
            renderParticles();
        }

        function renderParticles() {
            const grid = document.getElementById('particles-grid');
            const filteredData = currentFilter === 'all' 
                ? particlesData 
                : particlesData.filter(item => item.type === currentFilter);

            grid.innerHTML = filteredData.map((item) => {
                const isAdverb = item.type === 'adverb';
                const badgeClass = isAdverb ? 'badge-adverb' : 'badge-particle';
                const label = isAdverb ? 'Phó từ' : 'Trợ từ';
                
                return `
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden hover:shadow-md transition duration-300 flex flex-col group animate-fade-in">
                    <div class="bg-gray-50 p-4 border-b border-gray-100 flex justify-between items-center relative overflow-hidden">
                        <div class="absolute top-0 right-0 px-2 py-1 text-[10px] font-bold uppercase rounded-bl-lg opacity-80 ${badgeClass}">${label}</div>
                        <div class="flex items-center gap-3 w-full">
                            <div class="px-3 py-2 rounded-xl text-white flex flex-col items-center justify-center shadow-sm group-hover:scale-105 transition-transform min-w-[3.5rem] ${badgeClass}">
                                <span class="text-xl font-bold kanji-font leading-tight">${item.p}</span>
                                <span class="text-[10px] font-bold opacity-80 uppercase">${item.r}</span>
                            </div>
                            <div class="flex-grow">
                                <div class="font-bold text-gray-800 leading-tight">${item.m}</div>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 flex-grow flex flex-col justify-between">
                        <div class="mb-4 bg-white p-3 rounded-lg border border-gray-100 relative shadow-inner">
                            <p class="text-lg text-gray-800 kanji-font mb-1 pr-6 leading-snug">${parseRuby(item.ex_jp)}</p>
                            <p class="text-xs text-gray-500 italic">${item.ex_vi}</p>
                            <button onclick="speak('${item.ex_jp}')" class="absolute top-2 right-2 text-gray-400 hover:text-sky-600 p-1 transition">
                                <i class="fas fa-volume-up"></i>
                            </button>
                        </div>
                        <button onclick="openModal('${item.p}')" class="w-full py-2 bg-white border border-gray-200 text-gray-600 rounded-lg hover:bg-sky-50 hover:text-sky-600 hover:border-sky-200 transition text-sm font-bold flex items-center justify-center gap-2">
                            <i class="fas fa-search-plus"></i> Chi tiết
                        </button>
                    </div>
                </div>
            `}).join('');
        }

        function openModal(particle) {
            const item = particlesData.find(p => p.p === particle);
            if (!item) return;
            
            const isAdverb = item.type === 'adverb';
            const header = document.getElementById('modal-header');
            const badge = document.getElementById('modal-particle');
            
            if(isAdverb) {
                header.className = "bg-orange-600 px-6 py-4 flex justify-between items-center text-white";
                badge.className = "bg-white text-orange-700 px-4 py-2 rounded-xl flex items-center justify-center mr-3 text-lg font-black shadow-sm min-w-[3.5rem]";
            } else {
                header.className = "bg-sky-600 px-6 py-4 flex justify-between items-center text-white";
                badge.className = "bg-white text-sky-700 px-4 py-2 rounded-xl flex items-center justify-center mr-3 text-lg font-black shadow-sm min-w-[3.5rem]";
            }

            badge.innerText = item.p;
            document.getElementById('modal-usage').innerText = item.usage;
            document.getElementById('modal-nuance').innerText = item.nuance || "Tập trung vào ngữ cảnh sử dụng.";
            document.getElementById('modal-examples').innerHTML = item.more.map(ex => `
                <li class="flex items-start gap-3 bg-white p-3 rounded border border-gray-100">
                    <button onclick="speak('${ex.j}')" class="text-gray-400 hover:text-sky-600 mt-1 flex-shrink-0"><i class="fas fa-volume-up"></i></button>
                    <div>
                        <p class="kanji-font text-gray-800 font-medium">${parseRuby(ex.j)}</p>
                        <p class="text-xs text-gray-500">${ex.v}</p>
                    </div>
                </li>
            `).join('');
            document.getElementById('detail-modal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('detail-modal').classList.add('hidden'); }

        function startQuiz() {
            score = 0; currentQuestionIndex = 0;
            document.getElementById('score-display').innerText = '0';
            loadQuestion();
        }

        function loadQuestion() {
            const q = quizQuestions[Math.floor(Math.random() * quizQuestions.length)];
            currentQuizQ = q;
            document.getElementById('q-current').innerText = currentQuestionIndex + 1;
            document.getElementById('quiz-sentence').innerHTML = q.q.replace('___', '<span class="text-sky-500 border-b-2 border-sky-500 px-2">___</span>');
            document.getElementById('quiz-translation').innerText = `(${q.m})`;
            const shuffledOptions = [...q.o].sort(() => Math.random() - 0.5);
            document.getElementById('options-area').innerHTML = shuffledOptions.map(opt => `
                <button onclick="checkAnswer('${opt}')" class="quiz-opt-btn bg-white border-2 border-gray-200 text-gray-700 py-4 rounded-xl text-xl font-bold kanji-font hover:border-sky-400 hover:bg-sky-50 transition active:scale-95 shadow-sm">
                    ${opt}
                </button>
            `).join('');
            document.getElementById('feedback-area').classList.add('hidden');
            document.getElementById('quiz-progress').style.width = `${((currentQuestionIndex) / 10) * 100}%`;
        }

        function checkAnswer(selected) {
            const btns = document.querySelectorAll('.quiz-opt-btn');
            btns.forEach(b => b.disabled = true);
            const isCorrect = selected === currentQuizQ.a;
            const feedbackArea = document.getElementById('feedback-area');
            const feedbackTitle = document.getElementById('feedback-title');
            
            if (isCorrect) {
                score += 10;
                document.getElementById('score-display').innerText = score;
                speak(currentQuizQ.q.replace('___', currentQuizQ.a));
                feedbackTitle.innerHTML = '<i class="fas fa-check-circle text-emerald-500 mr-2"></i> Chính xác!';
                feedbackArea.className = "bg-emerald-50 rounded-xl p-4 border border-emerald-200 text-left animate-fade-in";
            } else {
                feedbackTitle.innerHTML = '<i class="fas fa-times-circle text-red-500 mr-2"></i> Sai rồi!';
                feedbackArea.className = "bg-red-50 rounded-xl p-4 border border-red-200 text-left animate-fade-in wrong-anim";
            }
            document.getElementById('feedback-detail').innerText = `Đáp án là "${currentQuizQ.a}".`;
            feedbackArea.classList.remove('hidden');
        }

        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex >= 10) {
                alert(`Hoàn thành phiên luyện tập! Điểm của bạn: ${score}/100.`);
                startQuiz();
            } else loadQuestion();
        }

        document.getElementById('toggle-furigana').addEventListener('click', (e) => {
            showFurigana = !showFurigana;
            document.body.classList.toggle('hide-furigana', !showFurigana);
            e.target.innerText = `Furi: ${showFurigana ? 'ON' : 'OFF'}`;
        });

        // Init
        filterData('all');
    </script>
</body>
</html>
