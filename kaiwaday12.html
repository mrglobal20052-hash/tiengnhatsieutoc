<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Học Tiếng Nhật Siêu Tốc - Ngày 12</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .jp-font {
            font-family: 'Noto Sans JP', sans-serif;
        }
        ruby rt {
            font-size: 0.7em;
            font-weight: 500;
            user-select: none;
        }
        .hide-furigana ruby rt {
            visibility: hidden;
        }
        .transition-height {
            transition: max-height 0.5s ease-in-out;
        }
        .correct-char { color: #16a34a; }
        .incorrect-char { color: #dc2626; text-decoration: underline; }
        
        /* --- NEW STYLES FOR UPGRADES --- */
        /* Progress Bar */
        .progress-bar-container {
            background-color: #e5e7eb; /* gray-200 */
            border-radius: 9999px;
            overflow: hidden;
        }
        .progress-bar {
            background-color: #22c55e; /* green-500 */
            transition: width 0.5s ease-in-out;
        }
        /* Fade transition for conversation */
        .content-fade {
            transition: opacity 0.3s ease-in-out;
        }
        .fading-out {
            opacity: 0;
        }
        /* Quiz feedback icons */
        .feedback-icon {
            display: inline-block;
            margin-right: 0.5rem;
            font-weight: bold;
        }
        .feedback-correct { color: #16a34a; }
        .feedback-incorrect { color: #dc2626; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-sky-700 jp-font" id="main-title"></h1>
            <p class="text-gray-500 mt-2">Bài học về Tự động từ, Tha động từ và các hành động có chủ đích.</p>
        </header>

        <!-- Progress Bar Section -->
        <div class="mb-8">
            <h3 class="font-bold text-center mb-2">Tiến độ bài học</h3>
            <div class="progress-bar-container w-full h-4">
                <div id="lesson-progress-bar" class="progress-bar h-full text-xs text-white text-center" style="width: 0%;"></div>
            </div>
        </div>

        <main class="space-y-8">
            <!-- Settings Panel -->
            <div class="bg-white p-4 rounded-xl shadow-md border border-gray-200">
                <h3 class="font-bold text-lg mb-3 text-gray-700">Bảng điều khiển</h3>
                <div class="flex flex-wrap gap-4">
                    <button id="toggle-furigana" class="toggle-btn">Bật Furigana</button>
                    <button id="toggle-romaji" class="toggle-btn">Hiện Romaji</button>
                    <button id="toggle-vietnamese" class="toggle-btn">Hiện Tiếng Việt</button>
                </div>
            </div>

            <!-- Conversation Section -->
            <section id="conversation-section" class="lesson-section"></section>

            <!-- Reading Section -->
            <section id="reading-section" class="lesson-section"></section>

            <!-- Grammar Section -->
            <section id="grammar-section" class="lesson-section"></section>
            
            <!-- Quiz Section -->
            <section id="quiz-section" class="lesson-section"></section>
        </main>

        <footer class="text-center mt-12 text-gray-400 text-sm">
            <p>Copyright by AzaCan, 2025</p>
        </footer>
    </div>

    <script>
        // --- DATA FOR DAY 12 ---
        const day12Data = {
            title: "Ngày 12: Trạng thái và Chủ đích",
            conversation: {
                id: 'conversation',
                title: "今日の会話 (Hội thoại trong ngày)",
                context: "Bối cảnh: Tanaka và Suzuki đang chuẩn bị cho một chuyến đi.",
                modes: {
                    polite: {
                        name: "Thể lịch sự (丁寧形)",
                        dialogue: [
                            { speaker: "Tanaka", jp: "鈴木[すずき]さん、旅行[りょこう]の準備[じゅんび]は進[すす]んでいますか。", romaji: "Suzuki-san, ryokou no junbi wa susunde imasu ka.", vi: "Anh Suzuki, việc chuẩn bị cho chuyến du lịch tiến triển tốt chứ?" },
                            { speaker: "Suzuki", jp: "はい、もう服[ふく]をスーツケースに詰[つ]めておきました。でも、シャツが一枚[いちまい]汚[よご]れてしまいました。", romaji: "Hai, mou fuku o suutsukeesu ni tsumete okimashita. Demo, shatsu ga ichimai yogorete shimaimashita.", vi: "Vâng, tôi đã xếp sẵn quần áo vào va-li rồi. Nhưng mà, tôi lỡ làm bẩn mất một chiếc áo sơ mi." },
                            { speaker: "Tanaka", jp: "そうですか。大変[たいへん]ですね。ドアは開[あ]いていますか。", romaji: "Sou desu ka. Taihen desu ne. Doa wa aite imasu ka.", vi: "Vậy à. Vất vả cho anh nhỉ. Cửa đang mở phải không ạ?" },
                            { speaker: "Suzuki", jp: "いいえ、閉[し]まっています。旅行[りょこう]に行[い]く前[まえ]に、部屋[へや]をきれいにしておこうと思[おも]っています。", romaji: "Iie, shimatte imasu. Ryokou ni iku mae ni, heya o kirei ni shite okou to omotte imasu.", vi: "Không, cửa đang đóng. Trước khi đi du lịch, tôi định dọn dẹp phòng cho sạch sẽ." },
                            { speaker: "Tanaka", jp: "立派[りっぱ]ですね。私[わたし]は来年[らいねん]、都心[としん]に引[ひ]っ越[こ]すつもりです。", romaji: "Rippa desu ne. Watashi wa rainen, toshin ni hikkosu tsumori desu.", vi: "Tuyệt vời thật. Tôi thì dự định năm sau sẽ chuyển đến trung tâm thành phố." },
                            { speaker: "Suzuki", jp: "いいですね。新しい生活[せいかつ]が楽[たの]しみですね。", romaji: "Ii desu ne. Atarashii seikatsu ga tanoshimi desu ne.", vi: "Hay quá. Mong chờ cuộc sống mới nhỉ." }
                        ]
                    },
                    casual: {
                        name: "Thể thông thường (普通形)",
                        dialogue: [
                            { speaker: "Tanaka", jp: "鈴木[すずき]くん、旅行[りょこう]の準備[じゅんび]、進[すす]んでる？", romaji: "Suzuki-kun, ryokou no junbi, susunderu?", vi: "Suzuki, chuẩn bị du lịch đến đâu rồi?" },
                            { speaker: "Suzuki", jp: "うん、もう服[ふく]はスーツケースに詰[つ]めといたよ。でも、シャツが一枚[いちまい]汚[よご]れちゃった。", romaji: "Un, mou fuku wa suutsukeesu ni tsumetoita yo. Demo, shatsu ga ichimai yogorechatta.", vi: "Ừ, tớ xếp sẵn quần áo vào va-li rồi. Nhưng mà, lỡ làm bẩn một cái áo sơ mi mất rồi." },
                            { speaker: "Tanaka", jp: "そっか。大変[たいへん]だね。ドア、開[あ]いてる？", romaji: "Sokka. Taihen da ne. Doa, aiteru?", vi: "Vậy à. Mệt nhỉ. Cửa đang mở à?" },
                            { speaker: "Suzuki", jp: "ううん、閉[し]まってる。旅行[りょこう]に行[い]く前[まえ]に、部屋[へや]をきれいにしておこうと思[おも]って。", romaji: "Uun, shimatteru. Ryokou ni iku mae ni, heya o kirei ni shite okou to omotte.", vi: "Không, đang đóng. Tớ định dọn phòng cho sạch trước khi đi du lịch." },
                            { speaker: "Tanaka", jp: "えらいね。俺[おれ]は来年[らいねん]、都心[としん]に引[ひ]っ越[こ]すつもりなんだ。", romaji: "Erai ne. Ore wa rainen, toshin ni hikkosu tsumori nanda.", vi: "Giỏi ghê. Tớ thì định năm sau chuyển vào trung tâm thành phố." },
                            { speaker: "Suzuki", jp: "いいね。新しい生活[せいかつ]、楽[たの]しみだね。", romaji: "Ii ne. Atarashii seikatsu, tanoshimi da ne.", vi: "Hay đó. Chắc là mong chờ cuộc sống mới lắm nhỉ." }
                        ]
                    }
                }
            },
            reading: {
                id: 'reading',
                title: "今日の読み物 (Bài đọc ngắn)",
                content: {
                    jp: "昨日[きのう]の夜中[よなか]、大[おお]きな音[おと]で目[め]が覚[さ]めてしまいました。窓[まど]の外[そと]を見[み]ると、木[き]が一本[いっぽん]倒[たお]れていました。びっくりして、服[ふく]が濡[ぬ]れているのも忘[わす]れて外[そと]に出[で]ました。幸[さいわ]い、誰[だれ]もけがをしませんでした。来週[らいしゅう]から、新[あたら]しい家[いえ]を建[た]てようと思[おも]っています。今度[こんど]はもっと強[つよ]い家[いえ]に住[す]むつもりです。",
                    romaji: "Kinou no yonaka, ookina oto de me ga samete shimaimashita. Mado no soto o miru to, ki ga ippon taorete imashita. Bikkuri shite, fuku ga nurete iru no mo wasurete soto ni demashita. Saiwai, dare mo kega o shimasen deshita. Raishuu kara, atarashii ie o tateyou to omotte imasu. Kondo wa motto tsuyoi ie ni sumu tsumori desu.",
                    vi: "Đêm qua, tôi đã lỡ tỉnh giấc vì một tiếng động lớn. Khi nhìn ra ngoài cửa sổ, có một cái cây đang bị đổ. Tôi đã rất ngạc nhiên, quên cả việc quần áo đang bị ướt mà chạy ra ngoài. May mắn là không có ai bị thương. Từ tuần sau, tôi đang định xây một ngôi nhà mới. Lần này tôi dự định sẽ sống trong một ngôi nhà vững chắc hơn."
                }
            },
            grammar: {
                id: 'grammar',
                title: "今日の文法 (Tổng hợp ngữ pháp)",
                points: [
                    { rule: "Vています (Tự động từ)", meaning: "Diễn tả trạng thái của sự vật", formula: "N が V(tự)ています", example: "ドアが開[あ]いています。", example_vi: "Cửa đang mở." },
                    { rule: "Vてあります (Tha động từ)", meaning: "Hành động có chủ đích của ai đó", formula: "N が V(tha)てあります", example: "机[つくえ]の上[うえ]に本[ほん]が置[お]いてあります。", example_vi: "(Ai đó) đã đặt sẵn sách ở trên bàn." },
                    { rule: "Vておきます", meaning: "Làm gì đó trước, làm sẵn", formula: "Vて + おきます", example: "旅行[りょこう]の前[まえ]に、切符[きっぷ]を買[か]っておきます。", example_vi: "Tôi sẽ mua vé sẵn trước chuyến du lịch." },
                    { rule: "Vてしまいます", meaning: "Hoàn thành / Lỡ làm gì đó mất rồi", formula: "Vて + しまいます", example: "宿題[しゅくだい]を全部[ぜんぶ]してしまいました。", example_vi: "Tôi đã làm xong hết bài tập rồi." },
                    { rule: "～と思っています", meaning: "Định làm... (ý định)", formula: "V(ý chí) + と思っています", example: "週末[しゅうまつ]、映画[えいが]を見[み]に行[い]こうと思[おも]っています。", example_vi: "Tôi định cuối tuần đi xem phim." },
                    { rule: "～つもりです", meaning: "Dự định làm... (quyết tâm cao)", formula: "Vる/Vない + つもりです", example: "来年[らいねん]、日本[にほん]へ留学[りゅうがく]するつもりです。", example_vi: "Tôi dự định năm sau sẽ đi du học Nhật Bản." },
                    { rule: "Danh từ hóa tính từ", meaning: "Biến tính từ thành danh từ", formula: "Aい→さ / Aな→み・さ", example: "富士山[ふじさん]の高[たか]さは３７７６メートルです。", example_vi: "Độ cao của núi Phú Sĩ là 3776 mét." }
                ]
            },
            quiz: {
                id: 'quiz',
                title: "練習とテスト (Luyện tập & Kiểm tra)",
                questions: [
                    { type: "mcq", question: "窓[まど]が（___）います。", options: ["開いて", "開けて", "開いて"], answer: "開いて" },
                    { type: "fill", question: "明日[あした]までにこの本[ほん]を読んで（___）。", answer: "しまいます" },
                    { type: "mcq", question: "来年[らいねん]、結婚[けっこん]する（___）です。", options: ["つもり", "思って", "おきます"], answer: "つもり" },
                    { type: "audio", jp: "旅行の前に切符を買っておきます。", question: "Nghe và gõ lại câu bạn vừa nghe:" }
                ]
            }
        };

        // --- STATE MANAGEMENT & SETTINGS ---
        let settings = {
            hideFurigana: false,
            showRomaji: false,
            showVietnamese: false
        };

        let progress = {
            conversation: false,
            reading: false,
            grammar: false,
            quiz: false
        };

        function saveSettings() {
            localStorage.setItem('jpAppSettings_day12', JSON.stringify(settings));
        }

        function loadSettings() {
            const saved = localStorage.getItem('jpAppSettings_day12');
            if (saved) {
                settings = JSON.parse(saved);
            }
        }

        function applySettings() {
            // Buttons
            updateToggleButtonUI('toggle-furigana', !settings.hideFurigana, 'Ẩn Furigana', 'Hiện Furigana');
            updateToggleButtonUI('toggle-romaji', settings.showRomaji, 'Ẩn Romaji', 'Hiện Romaji');
            updateToggleButtonUI('toggle-vietnamese', settings.showVietnamese, 'Ẩn Tiếng Việt', 'Hiện Tiếng Việt');
            
            // Content
            document.getElementById('app').classList.toggle('hide-furigana', settings.hideFurigana);
            document.querySelectorAll('.romaji-text').forEach(el => el.classList.toggle('hidden', !settings.showRomaji));
            document.querySelectorAll('.vi-text').forEach(el => el.classList.toggle('hidden', !settings.showVietnamese));
        }

        function updateToggleButtonUI(buttonId, isActive, activeText, inactiveText) {
            const button = document.getElementById(buttonId);
            button.textContent = isActive ? activeText : inactiveText;
            button.classList.toggle('bg-sky-500', isActive);
            button.classList.toggle('text-white', isActive);
            button.classList.toggle('bg-gray-200', !isActive);
            button.classList.toggle('text-gray-700', !isActive);
        }

        // --- PROGRESS ---
        function updateProgress(sectionId) {
            if (progress.hasOwnProperty(sectionId) && !progress[sectionId]) {
                progress[sectionId] = true;
                updateProgressBar();
            }
        }

        function updateProgressBar() {
            const completed = Object.values(progress).filter(Boolean).length;
            const total = Object.keys(progress).length;
            const percentage = (completed / total) * 100;
            const bar = document.getElementById('lesson-progress-bar');
            bar.style.width = `${percentage}%`;
            bar.textContent = `${Math.round(percentage)}%`;
        }


        // --- UTILITY FUNCTIONS ---
        function parseFurigana(text) {
            return text.replace(/([^\[\]]+)\[(.+?)\]/g, '<ruby>$1<rt>$2</rt></ruby>');
        }

        function speak(text) {
            speechSynthesis.cancel(); // Stop any previous speech
            const cleanText = text.replace(/\[.*?\]/g, '');
            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = 'ja-JP';
            utterance.rate = 0.9;
            speechSynthesis.speak(utterance);
        }

        // --- RENDER FUNCTIONS ---
        function renderConversation() {
            const section = document.getElementById('conversation-section');
            const data = day12Data.conversation;
            section.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h2 class="text-2xl font-bold mb-1 jp-font">${data.title}</h2>
                    <p class="text-gray-500 mb-4">${data.context}</p>
                    <div class="flex items-center justify-center space-x-2 mb-6 p-1 bg-gray-100 rounded-full">
                        <button id="convo-mode-polite" class="convo-mode-btn flex-1 py-2 px-4 rounded-full bg-sky-600 text-white shadow">Thể lịch sự</button>
                        <button id="convo-mode-casual" class="convo-mode-btn flex-1 py-2 px-4 rounded-full">Thể thông thường</button>
                    </div>
                    <div id="conversation-content" class="space-y-4 content-fade"></div>
                </div>
            `;
            renderDialogue('polite');
            updateProgress(data.id);
        }
        
        function renderDialogue(mode) {
            const container = document.getElementById('conversation-content');
            const dialogue = day12Data.conversation.modes[mode].dialogue;

            container.innerHTML = dialogue.map((line) => `
                <div class="dialogue-line p-4 rounded-lg bg-gray-50 border">
                    <div class="flex items-start space-x-3">
                        <div class="w-10 h-10 rounded-full ${line.speaker === 'Tanaka' ? 'bg-sky-100' : 'bg-emerald-100'} flex items-center justify-center font-bold text-sky-800">${line.speaker.charAt(0)}</div>
                        <div class="flex-1">
                            <p class="font-bold text-gray-800">${line.speaker}</p>
                            <p class="jp-font text-lg mt-1 leading-relaxed">${parseFurigana(line.jp)}</p>
                            <p class="romaji-text text-sm text-gray-500 mt-1">${line.romaji}</p>
                            <p class="vi-text text-sm text-emerald-700 mt-1">${line.vi}</p>
                            <div class="mt-3 flex items-center space-x-3">
                                <button class="speak-btn" data-text="${line.jp}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                                </button>
                                <div class="w-full">
                                    <input type="text" class="typing-input w-full p-2 border rounded-md bg-white text-base" data-correct="${line.jp.replace(/\[.*?\]/g, '')}" placeholder="Luyện gõ ở đây...">
                                    <div class="typing-feedback text-xs mt-1 h-4"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            attachEventListenersToRenderedContent(container);
            applySettings();
        }

        function renderReading() {
            const section = document.getElementById('reading-section');
            const data = day12Data.reading;
            section.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h2 class="text-2xl font-bold mb-2 jp-font">${data.title}</h2>
                    <div class="reading-content p-4 rounded-lg bg-gray-50 border">
                        <p class="jp-font text-lg leading-relaxed">${parseFurigana(data.content.jp)}</p>
                        <p class="romaji-text text-sm text-gray-500 mt-2">${data.content.romaji}</p>
                        <p class="vi-text text-sm text-emerald-700 mt-2">${data.content.vi}</p>
                        <div class="mt-4 flex items-center space-x-3">
                             <button class="speak-btn" data-text="${data.content.jp}">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                             </button>
                             <div class="w-full">
                                 <input type="text" class="typing-input w-full p-2 border rounded-md bg-white text-base" data-correct="${data.content.jp.replace(/\[.*?\]/g, '')}" placeholder="Luyện gõ ở đây...">
                                 <div class="typing-feedback text-xs mt-1 h-4"></div>
                             </div>
                        </div>
                    </div>
                </div>
            `;
            attachEventListenersToRenderedContent(section);
            updateProgress(data.id);
        }

        function renderGrammar() {
            const section = document.getElementById('grammar-section');
            const data = day12Data.grammar;
            section.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h2 class="text-2xl font-bold mb-4 jp-font">${data.title}</h2>
                    <div class="space-y-3">
                        ${data.points.map((point) => `
                            <div class="grammar-point border border-gray-200 rounded-lg overflow-hidden">
                                <button class="grammar-toggle w-full flex justify-between items-center p-4 bg-gray-50 hover:bg-gray-100">
                                    <span class="font-bold text-sky-800 jp-font text-lg">${point.rule}</span>
                                    <svg class="w-5 h-5 transform transition-transform" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </button>
                                <div class="grammar-details max-h-0 overflow-hidden transition-height">
                                    <div class="p-4 border-t border-gray-200">
                                        <p><strong>Ý nghĩa:</strong> ${point.meaning}</p>
                                        <p><strong>Công thức:</strong> <code class="bg-gray-200 text-red-600 px-1 rounded">${point.formula}</code></p>
                                        <div class="mt-2 p-3 bg-sky-50 rounded-md">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <p class="jp-font">${parseFurigana(point.example)}</p>
                                                    <p class="vi-text text-sm text-emerald-700 mt-1">${point.example_vi}</p>
                                                </div>
                                                <button class="speak-btn" data-text="${point.example}">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            attachEventListenersToRenderedContent(section);
            updateProgress(data.id);
        }

        function renderQuiz() {
            const section = document.getElementById('quiz-section');
            const data = day12Data.quiz;
            section.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h2 class="text-2xl font-bold mb-4 jp-font">${data.title}</h2>
                    <div id="quiz-content" class="space-y-6">
                        ${data.questions.map((q, index) => {
                            if (q.type === 'mcq') {
                                return `
                                    <div class="quiz-question" data-answer="${q.answer}">
                                        <p class="mb-2 jp-font">${index + 1}. ${parseFurigana(q.question)}</p>
                                        <div class="flex flex-col space-y-2">
                                            ${q.options.map(opt => `<button class="mcq-option text-left p-3 border rounded-lg hover:bg-gray-100">${opt}</button>`).join('')}
                                        </div>
                                        <div class="feedback mt-2 text-sm h-5"></div>
                                    </div>
                                `;
                            }
                            if (q.type === 'fill') {
                                return `
                                    <div class="quiz-question" data-answer="${q.answer}">
                                        <p class="mb-2 jp-font">${index + 1}. ${parseFurigana(q.question)}</p>
                                        <input type="text" class="fill-input w-full p-2 border rounded-md">
                                        <div class="feedback mt-2 text-sm h-5"></div>
                                    </div>
                                `;
                            }
                            if (q.type === 'audio') {
                                return `
                                    <div class="quiz-question" data-answer="${q.jp.replace(/\[.*?\]/g, '')}">
                                        <p class="mb-2 jp-font">${index + 1}. ${q.question}</p>
                                        <button class="speak-btn mb-2 flex items-center" data-text="${q.jp}">
                                           <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-sky-600"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                                           <span class="ml-2">Nghe</span>
                                        </button>
                                        <input type="text" class="fill-input w-full p-2 border rounded-md">
                                        <div class="feedback mt-2 text-sm h-5"></div>
                                    </div>
                                `;
                            }
                        }).join('')}
                    </div>
                    <button id="check-quiz-btn" class="mt-6 w-full bg-emerald-600 text-white font-bold py-3 rounded-lg hover:bg-emerald-700 transition-colors">Kiểm tra đáp án</button>
                    <div id="quiz-result" class="mt-4 text-center font-bold"></div>
                </div>
            `;
            attachEventListenersToRenderedContent(section);
        }

        // --- EVENT LISTENERS ---
        function attachEventListenersToRenderedContent(container) {
            container.querySelectorAll('.speak-btn').forEach(btn => {
                btn.onclick = () => speak(btn.dataset.text);
            });

            container.querySelectorAll('.typing-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const correctText = e.target.dataset.correct;
                    const userText = e.target.value;
                    const feedbackContainer = e.target.nextElementSibling;
                    let styledText = '';
                    for (let i = 0; i < userText.length; i++) {
                        styledText += `<span class="${userText[i] === correctText[i] ? 'correct-char' : 'incorrect-char'}">${userText[i]}</span>`;
                    }
                    feedbackContainer.innerHTML = styledText;
                    if (userText === correctText) {
                        feedbackContainer.innerHTML = '<span class="text-green-600 font-bold">Chính xác! 🎉</span>';
                    }
                });
            });
            
            container.querySelectorAll('.grammar-toggle').forEach(button => {
                button.addEventListener('click', () => {
                    const details = button.nextElementSibling;
                    const icon = button.querySelector('svg');
                    if (details.style.maxHeight && details.style.maxHeight !== '0px') {
                        details.style.maxHeight = '0px';
                        icon.style.transform = 'rotate(0deg)';
                    } else {
                        details.style.maxHeight = details.scrollHeight + 'px';
                        icon.style.transform = 'rotate(180deg)';
                    }
                });
            });
        }

        function setupGlobalEventListeners() {
            document.getElementById('toggle-furigana').addEventListener('click', () => {
                settings.hideFurigana = !settings.hideFurigana;
                saveSettings();
                applySettings();
            });
            document.getElementById('toggle-romaji').addEventListener('click', () => {
                settings.showRomaji = !settings.showRomaji;
                saveSettings();
                applySettings();
            });
            document.getElementById('toggle-vietnamese').addEventListener('click', () => {
                settings.showVietnamese = !settings.showVietnamese;
                saveSettings();
                applySettings();
            });

            document.getElementById('convo-mode-polite').addEventListener('click', (e) => {
                const container = document.getElementById('conversation-content');
                container.classList.add('fading-out');
                setTimeout(() => {
                    renderDialogue('polite');
                    container.classList.remove('fading-out');
                    e.target.classList.add('bg-sky-600', 'text-white', 'shadow');
                    document.getElementById('convo-mode-casual').classList.remove('bg-sky-600', 'text-white', 'shadow');
                }, 300);
            });
            document.getElementById('convo-mode-casual').addEventListener('click', (e) => {
                const container = document.getElementById('conversation-content');
                container.classList.add('fading-out');
                setTimeout(() => {
                    renderDialogue('casual');
                    container.classList.remove('fading-out');
                    e.target.classList.add('bg-sky-600', 'text-white', 'shadow');
                    document.getElementById('convo-mode-polite').classList.remove('bg-sky-600', 'text-white', 'shadow');
                }, 300);
            });
            
            document.getElementById('check-quiz-btn').addEventListener('click', () => {
                const questions = document.querySelectorAll('.quiz-question');
                let score = 0;
                questions.forEach(q => {
                    const answer = q.dataset.answer;
                    const feedback = q.querySelector('.feedback');
                    let isCorrect = false;

                    const selectedOption = q.querySelector('.mcq-option.bg-sky-200');
                    if (selectedOption) {
                        isCorrect = selectedOption.textContent === answer;
                        selectedOption.classList.add(isCorrect ? 'border-green-500' : 'border-red-500');
                    }
                    
                    const input = q.querySelector('.fill-input');
                    if (input) {
                        isCorrect = input.value.trim() === answer;
                        input.classList.add(isCorrect ? 'border-green-500' : 'border-red-500');
                    }

                    if (isCorrect) {
                        score++;
                        feedback.innerHTML = `<span class="feedback-icon feedback-correct">✔️</span><span class="text-green-600 font-bold">Đúng!</span>`;
                    } else {
                        feedback.innerHTML = `<span class="feedback-icon feedback-incorrect">❌</span><span class="text-red-600 font-bold">Sai! Đáp án đúng là: ${answer}</span>`;
                    }
                });
                
                document.getElementById('quiz-result').innerHTML = `Bạn đã trả lời đúng ${score}/${questions.length} câu!`;
                updateProgress(day12Data.quiz.id);
            });
            
            document.querySelectorAll('.mcq-option').forEach(opt => {
                opt.addEventListener('click', () => {
                    opt.parentElement.querySelectorAll('.mcq-option').forEach(sibling => {
                        sibling.classList.remove('bg-sky-200', 'border-sky-500');
                    });
                    opt.classList.add('bg-sky-200', 'border-sky-500');
                });
            });
        }
        
        // --- INITIALIZATION ---
        function init() {
            document.getElementById('main-title').textContent = day12Data.title;
            loadSettings();
            renderConversation();
            renderReading();
            renderGrammar();
            renderQuiz();
            setupGlobalEventListeners();
            applySettings();
            updateProgressBar();
        }

        window.onload = init;
    </script>
</body>
</html>
