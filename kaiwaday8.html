<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Học Tiếng Nhật Siêu Tốc - Ngày 8</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .jp-font {
            font-family: 'Noto Sans JP', sans-serif;
        }
        ruby rt {
            font-size: 0.7em;
            font-weight: 500;
            user-select: none;
        }
        .hide-furigana ruby rt {
            visibility: hidden;
        }
        .transition-height {
            transition: max-height 0.5s ease-in-out;
        }
        .correct-char { color: #16a34a; }
        .incorrect-char { color: #dc2626; text-decoration: underline; }
        
        /* --- NEW STYLES FOR UPGRADES --- */
        /* Progress Bar */
        .progress-bar-container {
            background-color: #e5e7eb; /* gray-200 */
            border-radius: 9999px;
            overflow: hidden;
        }
        .progress-bar {
            background-color: #22c55e; /* green-500 */
            transition: width 0.5s ease-in-out;
        }
        /* Fade transition for conversation */
        .content-fade {
            transition: opacity 0.3s ease-in-out;
        }
        .fading-out {
            opacity: 0;
        }
        /* Quiz feedback icons */
        .feedback-icon {
            display: inline-block;
            margin-right: 0.5rem;
            font-weight: bold;
        }
        .feedback-correct { color: #16a34a; }
        .feedback-incorrect { color: #dc2626; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-sky-700 jp-font" id="main-title"></h1>
            <p class="text-gray-500 mt-2">Cùng củng cố lại toàn bộ kiến thức đã học trong tuần đầu tiên!</p>
        </header>

        <!-- Progress Bar Section -->
        <div class="mb-8">
            <h3 class="font-bold text-center mb-2">Tiến độ bài học</h3>
            <div class="progress-bar-container w-full h-4">
                <div id="lesson-progress-bar" class="progress-bar h-full text-xs text-white text-center" style="width: 0%;"></div>
            </div>
        </div>

        <main class="space-y-8">
            <!-- Settings Panel -->
            <div class="bg-white p-4 rounded-xl shadow-md border border-gray-200">
                <h3 class="font-bold text-lg mb-3 text-gray-700">Bảng điều khiển</h3>
                <div class="flex flex-wrap gap-4">
                    <button id="toggle-furigana" class="toggle-btn">Bật Furigana</button>
                    <button id="toggle-romaji" class="toggle-btn">Hiện Romaji</button>
                    <button id="toggle-vietnamese" class="toggle-btn">Hiện Tiếng Việt</button>
                </div>
            </div>

            <!-- Conversation Section -->
            <section id="conversation-section" class="lesson-section"></section>

            <!-- Reading Section -->
            <section id="reading-section" class="lesson-section"></section>

            <!-- Grammar Section -->
            <section id="grammar-section" class="lesson-section"></section>
            
            <!-- Quiz Section -->
            <section id="quiz-section" class="lesson-section"></section>
        </main>

        <footer class="text-center mt-12 text-gray-400 text-sm">
            <p>Copyright by AzaCan, 2025</p>
        </footer>
    </div>

    <script>
        // --- DATA FOR DAY 8 ---
        const day8Data = {
            title: "Ngày 8: Ôn tập tổng hợp (Ngày 1 - 7)",
            conversation: {
                id: 'conversation',
                title: "今日の会話 (Hội thoại trong ngày)",
                context: "Bối cảnh: Tanaka và Suzuki lên kế hoạch cho cuối tuần.",
                modes: {
                    polite: {
                        name: "Thể lịch sự (丁寧形)",
                        dialogue: [
                            { speaker: "Tanaka", jp: "鈴木[すずき]さん、週末[しゅうまつ]どこかへ行[い]きたいですね。海[うみ]と山[やま]とどちらが好[す]きですか。", romaji: "Suzuki-san, shuumatsu dokoka e ikitai desu ne. Umi to yama to dochira ga suki desu ka.", vi: "Anh Suzuki, cuối tuần tôi muốn đi đâu đó quá. Giữa biển và núi thì anh thích bên nào hơn?" },
                            { speaker: "Suzuki", jp: "そうですね。どちらも好[す]きですが、今週[こんしゅう]は山[やま]のほうがいいです。新[あたら]しい靴[くつ]が欲[ほ]しいですから、買[か]ってから行[い]きたいです。", romaji: "Sou desu ne. Dochira mo suki desu ga, konshuu wa yama no hou ga ii desu. Atarashii kutsu ga hoshii desu kara, katte kara ikitai desu.", vi: "Để xem nào. Tôi thích cả hai, nhưng tuần này thì núi có lẽ tốt hơn. Vì tôi muốn có đôi giày mới nên tôi muốn đi sau khi đã mua xong." },
                            { speaker: "Tanaka", jp: "いいですね！でも、天気予報[てんきよほう]によると、雨[あめ]が降[ふ]るかもしれません。雨[あめ]が降[ふ]っても行[い]きますか。", romaji: "Ii desu ne! Demo, tenki yohou ni yoru to, ame ga furu kamoshiremasen. Ame ga futte mo ikimasu ka.", vi: "Hay đó! Nhưng theo dự báo thời tiết, có thể trời sẽ mưa. Dù trời mưa anh vẫn đi chứ?" },
                            { speaker: "Suzuki", jp: "ええ、大丈夫[だいじょうぶ]です。でも、あまり寒[さむ]くないといいですね。荷物[にもつ]を準備[じゅんび]しましょうか。", romaji: "Ee, daijoubu desu. Demo, amari samukunai to ii desu ne. Nimotsu o junbi shimashou ka.", vi: "Vâng, không sao đâu. Nhưng mong là trời không lạnh lắm. Tôi chuẩn bị hành lý giúp anh nhé?" },
                            { speaker: "Tanaka", jp: "ありがとうございます。公園[こうえん]ではお酒[さけ]を飲[の]んではいけませんから、気[き]をつけてくださいね。", romaji: "Arigatou gozaimasu. Kouen de wa osake o nonde wa ikemasen kara, ki o tsukete kudasai ne.", vi: "Cảm ơn anh. Ở công viên không được uống rượu nên hãy chú ý nhé." },
                            { speaker: "Suzuki", jp: "分[わ]かりました。あそこにはきれいな花[はな]や木[き]などしかありませんね。日本[にほん]で一番[いちばん]好[す]きな場所[ばしょ]です。", romaji: "Wakarimashita. Asoko ni wa kirei na hana ya ki nado shika arimasen ne. Nihon de ichiban suki na basho desu.", vi: "Tôi hiểu rồi. Ở đó chỉ có hoa và cây đẹp thôi nhỉ. Đó là nơi tôi thích nhất ở Nhật Bản." }
                        ]
                    },
                    casual: {
                        name: "Thể thông thường (普通形)",
                        dialogue: [
                            { speaker: "Tanaka", jp: "鈴木[すずき]くん、週末[しゅうまつ]どこか行[い]きたいな。海[うみ]と山[やま]、どっちが好[す]き？", romaji: "Suzuki-kun, shuumatsu dokoka ikitai na. Umi to yama, dotchi ga suki?", vi: "Suzuki, cuối tuần muốn đi đâu đó ghê. Biển với núi, cậu thích bên nào hơn?" },
                            { speaker: "Suzuki", jp: "うーん、どっちも好[す]きだけど、今週[こんしゅう]は山[やま]かな。新[あたら]しい靴[くつ]が欲[ほ]しいから、買[か]ってから行[い]きたいな。", romaji: "Uun, dotchi mo suki dakedo, konshuu wa yama kana. Atarashii kutsu ga hoshii kara, katte kara ikitai na.", vi: "Ừm, tớ thích cả hai, nhưng chắc tuần này là núi. Tớ muốn có giày mới nên muốn đi sau khi mua xong." },
                            { speaker: "Tanaka", jp: "いいね！でも、天気予報[てんきよほう]だと、雨[あめ]が降[ふ]るかもよ。雨[あめ]でも行[い]く？", romaji: "Ii ne! Demo, tenki yohou da to, ame ga furu kamo yo. Ame demo iku?", vi: "Hay đó! Nhưng dự báo thời tiết bảo có thể mưa đó. Mưa cũng đi à?" },
                            { speaker: "Suzuki", jp: "うん、大丈夫[だいじょうぶ]。でも、あまり寒[さむ]くないといいな。荷物[にもつ]、準備[じゅんび]しようか？", romaji: "Un, daijoubu. Demo, amari samukunai to ii na. Nimotsu, junbi shiyou ka?", vi: "Ừ, không sao. Nhưng mong là trời không lạnh lắm. Tớ chuẩn bị đồ giúp cậu nhé?" },
                            { speaker: "Tanaka", jp: "ありがとう。公園[こうえん]でお酒[さけ]飲[の]んじゃだめだから、気[き]をつけてね。", romaji: "Arigatou. Kouen de osake nonja dame dakara, ki o tsukete ne.", vi: "Cảm ơn. Ở công viên không được uống rượu đâu nên cẩn thận nhé." },
                            { speaker: "Suzuki", jp: "分[わ]かった。あそこってきれいな花[はな]や木[き]とかしかないよね。日本[にほん]で一番[いちばん]好[す]きな場所[ばしょ]だよ。", romaji: "Wakatta. Asoko tte kirei na hana ya ki toka shika nai yo ne. Nihon de ichiban suki na basho da yo.", vi: "Biết rồi. Chỗ đó chỉ toàn cây với hoa đẹp thôi nhỉ. Là nơi tớ thích nhất ở Nhật đó." }
                        ]
                    }
                }
            },
            reading: {
                id: 'reading',
                title: "今日の読み物 (Bài đọc ngắn)",
                content: {
                    jp: "私[わたし]は日本[にほん]の生活[せいかつ]に慣[な]れてきました。毎日[まいにち]美味[おい]しいものを食[た]べたいですが、お金[かね]があまりありません。でも、スーパーへ買[か]い物[もの]に行[い]ってから、自分[じぶん]で料理[りょうり]をします。料理[りょうり]は難[むずか]しいけれど、楽[たの]しいです。週末[しゅうまつ]は図書館[としょかん]へ行[い]ったり、映画[えいが]を見[み]たりします。図書館[としょかん]では静[しず]かにしてください。騒[さわ]いではいけません。日本[にほん]の秋[あき]が一番[いちばん]好[す]きです。とてもきれいですね。",
                    romaji: "Watashi wa Nihon no seikatsu ni narete kimashita. Mainichi oishii mono o tabetai desu ga, okane ga amari arimasen. Demo, suupaa e kaimono ni itte kara, jibun de ryouri o shimasu. Ryouri wa muzukashii keredo, tanoshii desu. Shuumatsu wa toshokan e ittari, eiga o mitari shimasu. Toshokan de wa shizuka ni shite kudasai. sawaide wa ikemasen. Nihon no aki ga ichiban suki desu. Totemo kirei desu ne.",
                    vi: "Tôi đã dần quen với cuộc sống ở Nhật. Mỗi ngày tôi đều muốn ăn đồ ngon nhưng lại không có nhiều tiền. Nhưng sau khi đi siêu thị mua đồ, tôi sẽ tự mình nấu ăn. Nấu ăn tuy khó nhưng rất vui. Cuối tuần tôi thường đi thư viện, xem phim... Ở thư viện, xin hãy giữ im lặng. Không được làm ồn. Tôi thích nhất là mùa thu ở Nhật Bản. Nó rất đẹp phải không."
                }
            },
            grammar: {
                id: 'grammar',
                title: "今日の文法 (Tổng hợp ngữ pháp)",
                points: [
                    { rule: "Ngày 1: 〜あまり, 〜だけ, 〜しか", meaning: "Phó từ chỉ mức độ và giới hạn." },
                    { rule: "Ngày 2: 〜から, 〜まで, 〜に", meaning: "Giới từ chỉ điểm đầu, điểm cuối và thời gian." },
                    { rule: "Ngày 3: 〜が欲しい, 〜たい, 〜や", meaning: "Diễn tả mong muốn và liệt kê." },
                    { rule: "Ngày 4: 〜くらい, 〜までに, 〜に行きます", meaning: "Ước lượng, thời hạn và mục đích." },
                    { rule: "Ngày 5: Cách đếm, 〜一番", meaning: "Cách đếm đồ vật và so sánh nhất." },
                    { rule: "Ngày 6: 〜より, 〜ほうがいい, 〜てはいけない", meaning: "So sánh hơn, lời khuyên và cấm đoán." },
                    { rule: "Ngày 7: 〜てから, 〜てもいい, 〜ましょうか", meaning: "Trình tự, sự cho phép và đề nghị." }
                ]
            },
            quiz: {
                id: 'quiz',
                title: "練習とテスト (Luyện tập & Kiểm tra)",
                questions: [
                    { type: "mcq", question: "私[わたし]は犬[いぬ]より猫[ねこ]の（___）が好[す]きです。", options: ["ほう", "より", "だけ"], answer: "ほう" },
                    { type: "fill", question: "ご飯[はん]を食[た]べて（___）、勉強[べんきょう]しましょう。", answer: "から" },
                    { type: "mcq", question: "この公園[こうえん]では、ごみを捨[す]てては（___）。", options: ["いいです", "ください", "いけません"], answer: "いけません" },
                    { type: "audio", jp: "映画館へ映画を見に行きませんか。", question: "Nghe và gõ lại câu bạn vừa nghe:" }
                ]
            }
        };

        // --- STATE MANAGEMENT & SETTINGS ---
        let settings = {
            hideFurigana: false,
            showRomaji: false,
            showVietnamese: false
        };

        let progress = {
            conversation: false,
            reading: false,
            grammar: false,
            quiz: false
        };

        function saveSettings() {
            localStorage.setItem('jpAppSettings_day8', JSON.stringify(settings));
        }

        function loadSettings() {
            const saved = localStorage.getItem('jpAppSettings_day8');
            if (saved) {
                settings = JSON.parse(saved);
            }
        }

        function applySettings() {
            // Buttons
            updateToggleButtonUI('toggle-furigana', !settings.hideFurigana, 'Ẩn Furigana', 'Hiện Furigana');
            updateToggleButtonUI('toggle-romaji', settings.showRomaji, 'Ẩn Romaji', 'Hiện Romaji');
            updateToggleButtonUI('toggle-vietnamese', settings.showVietnamese, 'Ẩn Tiếng Việt', 'Hiện Tiếng Việt');
            
            // Content
            document.getElementById('app').classList.toggle('hide-furigana', settings.hideFurigana);
            document.querySelectorAll('.romaji-text').forEach(el => el.classList.toggle('hidden', !settings.showRomaji));
            document.querySelectorAll('.vi-text').forEach(el => el.classList.toggle('hidden', !settings.showVietnamese));
        }

        function updateToggleButtonUI(buttonId, isActive, activeText, inactiveText) {
            const button = document.getElementById(buttonId);
            button.textContent = isActive ? activeText : inactiveText;
            button.classList.toggle('bg-sky-500', isActive);
            button.classList.toggle('text-white', isActive);
            button.classList.toggle('bg-gray-200', !isActive);
            button.classList.toggle('text-gray-700', !isActive);
        }

        // --- PROGRESS ---
        function updateProgress(sectionId) {
            if (progress.hasOwnProperty(sectionId) && !progress[sectionId]) {
                progress[sectionId] = true;
                updateProgressBar();
            }
        }

        function updateProgressBar() {
            const completed = Object.values(progress).filter(Boolean).length;
            const total = Object.keys(progress).length;
            const percentage = (completed / total) * 100;
            const bar = document.getElementById('lesson-progress-bar');
            bar.style.width = `${percentage}%`;
            bar.textContent = `${Math.round(percentage)}%`;
        }


        // --- UTILITY FUNCTIONS ---
        function parseFurigana(text) {
            return text.replace(/([^\[\]]+)\[(.+?)\]/g, '<ruby>$1<rt>$2</rt></ruby>');
        }

        function speak(text) {
            speechSynthesis.cancel(); // Stop any previous speech
            const cleanText = text.replace(/\[.*?\]/g, '');
            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = 'ja-JP';
            utterance.rate = 0.9;
            speechSynthesis.speak(utterance);
        }

        // --- RENDER FUNCTIONS ---
        function renderConversation() {
            const section = document.getElementById('conversation-section');
            const data = day8Data.conversation;
            section.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h2 class="text-2xl font-bold mb-1 jp-font">${data.title}</h2>
                    <p class="text-gray-500 mb-4">${data.context}</p>
                    <div class="flex items-center justify-center space-x-2 mb-6 p-1 bg-gray-100 rounded-full">
                        <button id="convo-mode-polite" class="convo-mode-btn flex-1 py-2 px-4 rounded-full bg-sky-600 text-white shadow">Thể lịch sự</button>
                        <button id="convo-mode-casual" class="convo-mode-btn flex-1 py-2 px-4 rounded-full">Thể thông thường</button>
                    </div>
                    <div id="conversation-content" class="space-y-4 content-fade"></div>
                </div>
            `;
            renderDialogue('polite');
            updateProgress(data.id);
        }
        
        function renderDialogue(mode) {
            const container = document.getElementById('conversation-content');
            const dialogue = day8Data.conversation.modes[mode].dialogue;

            container.innerHTML = dialogue.map((line) => `
                <div class="dialogue-line p-4 rounded-lg bg-gray-50 border">
                    <div class="flex items-start space-x-3">
                        <div class="w-10 h-10 rounded-full ${line.speaker === 'Tanaka' ? 'bg-sky-100' : 'bg-emerald-100'} flex items-center justify-center font-bold text-sky-800">${line.speaker.charAt(0)}</div>
                        <div class="flex-1">
                            <p class="font-bold text-gray-800">${line.speaker}</p>
                            <p class="jp-font text-lg mt-1 leading-relaxed">${parseFurigana(line.jp)}</p>
                            <p class="romaji-text text-sm text-gray-500 mt-1">${line.romaji}</p>
                            <p class="vi-text text-sm text-emerald-700 mt-1">${line.vi}</p>
                            <div class="mt-3 flex items-center space-x-3">
                                <button class="speak-btn" data-text="${line.jp}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                                </button>
                                <div class="w-full">
                                    <input type="text" class="typing-input w-full p-2 border rounded-md bg-white text-base" data-correct="${line.jp.replace(/\[.*?\]/g, '')}" placeholder="Luyện gõ ở đây...">
                                    <div class="typing-feedback text-xs mt-1 h-4"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            attachEventListenersToRenderedContent(container);
            applySettings();
        }

        function renderReading() {
            const section = document.getElementById('reading-section');
            const data = day8Data.reading;
            section.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h2 class="text-2xl font-bold mb-2 jp-font">${data.title}</h2>
                    <div class="reading-content p-4 rounded-lg bg-gray-50 border">
                        <p class="jp-font text-lg leading-relaxed">${parseFurigana(data.content.jp)}</p>
                        <p class="romaji-text text-sm text-gray-500 mt-2">${data.content.romaji}</p>
                        <p class="vi-text text-sm text-emerald-700 mt-2">${data.content.vi}</p>
                        <div class="mt-4 flex items-center space-x-3">
                             <button class="speak-btn" data-text="${data.content.jp}">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                             </button>
                             <div class="w-full">
                                 <input type="text" class="typing-input w-full p-2 border rounded-md bg-white text-base" data-correct="${data.content.jp.replace(/\[.*?\]/g, '')}" placeholder="Luyện gõ ở đây...">
                                 <div class="typing-feedback text-xs mt-1 h-4"></div>
                             </div>
                        </div>
                    </div>
                </div>
            `;
            attachEventListenersToRenderedContent(section);
            updateProgress(data.id);
        }

        function renderGrammar() {
            const section = document.getElementById('grammar-section');
            const data = day8Data.grammar;
            section.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h2 class="text-2xl font-bold mb-4 jp-font">${data.title}</h2>
                    <div class="space-y-3">
                        ${data.points.map((point) => `
                            <div class="grammar-point border border-gray-200 rounded-lg p-4 bg-gray-50">
                                <span class="font-bold text-sky-800 jp-font text-lg">${point.rule}</span>:
                                <span class="ml-2">${point.meaning}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            attachEventListenersToRenderedContent(section);
            updateProgress(data.id);
        }

        function renderQuiz() {
            const section = document.getElementById('quiz-section');
            const data = day8Data.quiz;
            section.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h2 class="text-2xl font-bold mb-4 jp-font">${data.title}</h2>
                    <div id="quiz-content" class="space-y-6">
                        ${data.questions.map((q, index) => {
                            if (q.type === 'mcq') {
                                return `
                                    <div class="quiz-question" data-answer="${q.answer}">
                                        <p class="mb-2 jp-font">${index + 1}. ${parseFurigana(q.question)}</p>
                                        <div class="flex flex-col space-y-2">
                                            ${q.options.map(opt => `<button class="mcq-option text-left p-3 border rounded-lg hover:bg-gray-100">${opt}</button>`).join('')}
                                        </div>
                                        <div class="feedback mt-2 text-sm h-5"></div>
                                    </div>
                                `;
                            }
                            if (q.type === 'fill') {
                                return `
                                    <div class="quiz-question" data-answer="${q.answer}">
                                        <p class="mb-2 jp-font">${index + 1}. ${parseFurigana(q.question)}</p>
                                        <input type="text" class="fill-input w-full p-2 border rounded-md">
                                        <div class="feedback mt-2 text-sm h-5"></div>
                                    </div>
                                `;
                            }
                            if (q.type === 'audio') {
                                return `
                                    <div class="quiz-question" data-answer="${q.jp.replace(/\[.*?\]/g, '')}">
                                        <p class="mb-2 jp-font">${index + 1}. ${q.question}</p>
                                        <button class="speak-btn mb-2 flex items-center" data-text="${q.jp}">
                                           <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-sky-600"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                                           <span class="ml-2">Nghe</span>
                                        </button>
                                        <input type="text" class="fill-input w-full p-2 border rounded-md">
                                        <div class="feedback mt-2 text-sm h-5"></div>
                                    </div>
                                `;
                            }
                        }).join('')}
                    </div>
                    <button id="check-quiz-btn" class="mt-6 w-full bg-emerald-600 text-white font-bold py-3 rounded-lg hover:bg-emerald-700 transition-colors">Kiểm tra đáp án</button>
                    <div id="quiz-result" class="mt-4 text-center font-bold"></div>
                </div>
            `;
            attachEventListenersToRenderedContent(section);
        }

        // --- EVENT LISTENERS ---
        function attachEventListenersToRenderedContent(container) {
            container.querySelectorAll('.speak-btn').forEach(btn => {
                btn.onclick = () => speak(btn.dataset.text);
            });

            container.querySelectorAll('.typing-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const correctText = e.target.dataset.correct;
                    const userText = e.target.value;
                    const feedbackContainer = e.target.nextElementSibling;
                    let styledText = '';
                    for (let i = 0; i < userText.length; i++) {
                        styledText += `<span class="${userText[i] === correctText[i] ? 'correct-char' : 'incorrect-char'}">${userText[i]}</span>`;
                    }
                    feedbackContainer.innerHTML = styledText;
                    if (userText === correctText) {
                        feedbackContainer.innerHTML = '<span class="text-green-600 font-bold">Chính xác! 🎉</span>';
                    }
                });
            });
            
            container.querySelectorAll('.grammar-toggle').forEach(button => {
                button.addEventListener('click', () => {
                    const details = button.nextElementSibling;
                    const icon = button.querySelector('svg');
                    if (details.style.maxHeight && details.style.maxHeight !== '0px') {
                        details.style.maxHeight = '0px';
                        icon.style.transform = 'rotate(0deg)';
                    } else {
                        details.style.maxHeight = details.scrollHeight + 'px';
                        icon.style.transform = 'rotate(180deg)';
                    }
                });
            });
        }

        function setupGlobalEventListeners() {
            document.getElementById('toggle-furigana').addEventListener('click', () => {
                settings.hideFurigana = !settings.hideFurigana;
                saveSettings();
                applySettings();
            });
            document.getElementById('toggle-romaji').addEventListener('click', () => {
                settings.showRomaji = !settings.showRomaji;
                saveSettings();
                applySettings();
            });
            document.getElementById('toggle-vietnamese').addEventListener('click', () => {
                settings.showVietnamese = !settings.showVietnamese;
                saveSettings();
                applySettings();
            });

            document.getElementById('convo-mode-polite').addEventListener('click', (e) => {
                const container = document.getElementById('conversation-content');
                container.classList.add('fading-out');
                setTimeout(() => {
                    renderDialogue('polite');
                    container.classList.remove('fading-out');
                    e.target.classList.add('bg-sky-600', 'text-white', 'shadow');
                    document.getElementById('convo-mode-casual').classList.remove('bg-sky-600', 'text-white', 'shadow');
                }, 300);
            });
            document.getElementById('convo-mode-casual').addEventListener('click', (e) => {
                const container = document.getElementById('conversation-content');
                container.classList.add('fading-out');
                setTimeout(() => {
                    renderDialogue('casual');
                    container.classList.remove('fading-out');
                    e.target.classList.add('bg-sky-600', 'text-white', 'shadow');
                    document.getElementById('convo-mode-polite').classList.remove('bg-sky-600', 'text-white', 'shadow');
                }, 300);
            });
            
            document.getElementById('check-quiz-btn').addEventListener('click', () => {
                const questions = document.querySelectorAll('.quiz-question');
                let score = 0;
                questions.forEach(q => {
                    const answer = q.dataset.answer;
                    const feedback = q.querySelector('.feedback');
                    let isCorrect = false;

                    const selectedOption = q.querySelector('.mcq-option.bg-sky-200');
                    if (selectedOption) {
                        isCorrect = selectedOption.textContent === answer;
                        selectedOption.classList.add(isCorrect ? 'border-green-500' : 'border-red-500');
                    }
                    
                    const input = q.querySelector('.fill-input');
                    if (input) {
                        isCorrect = input.value.trim() === answer;
                        input.classList.add(isCorrect ? 'border-green-500' : 'border-red-500');
                    }

                    if (isCorrect) {
                        score++;
                        feedback.innerHTML = `<span class="feedback-icon feedback-correct">✔️</span><span class="text-green-600 font-bold">Đúng!</span>`;
                    } else {
                        feedback.innerHTML = `<span class="feedback-icon feedback-incorrect">❌</span><span class="text-red-600 font-bold">Sai! Đáp án đúng là: ${answer}</span>`;
                    }
                });
                
                document.getElementById('quiz-result').innerHTML = `Bạn đã trả lời đúng ${score}/${questions.length} câu!`;
                updateProgress(day8Data.quiz.id);
            });
            
            document.querySelectorAll('.mcq-option').forEach(opt => {
                opt.addEventListener('click', () => {
                    opt.parentElement.querySelectorAll('.mcq-option').forEach(sibling => {
                        sibling.classList.remove('bg-sky-200', 'border-sky-500');
                    });
                    opt.classList.add('bg-sky-200', 'border-sky-500');
                });
            });
        }
        
        // --- INITIALIZATION ---
        function init() {
            document.getElementById('main-title').textContent = day8Data.title;
            loadSettings();
            renderConversation();
            renderReading();
            renderGrammar();
            renderQuiz();
            setupGlobalEventListeners();
            applySettings();
            updateProgressBar();
        }

        window.onload = init;
    </script>
</body>
</html>
