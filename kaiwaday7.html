<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AzaKanji - Hội Thoại & Ngữ Pháp (Day 7)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #f3f4f6; overflow-x: hidden; }
        .kanji-font { font-family: 'Noto Sans JP', sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Ruby Text Styling */
        ruby rt { font-size: 0.6em; color: #64748b; user-select: none; }
        .hide-furigana ruby rt { visibility: hidden; }

        /* Animations */
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .card-transition { transition: all 0.3s ease-in-out; }
        
        /* Highlight classes for Typing */
        .correct-char { color: #16a34a; font-weight: bold; }
        .incorrect-char { color: #dc2626; text-decoration: underline; font-weight: bold; }
        .correct-input { border-color: #22c55e !important; background-color: #f0fdf4 !important; }
        .wrong-input { border-color: #ef4444 !important; background-color: #fef2f2 !important; }
        
        /* Microphone Animation */
        .mic-listening { animation: pulse-red 1.5s infinite; color: #dc2626 !important; border-color: #dc2626 !important; }
        @keyframes pulse-red { 
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); } 
            70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); } 
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } 
        }

        /* Tab Transitions */
        .tab-btn { transition: all 0.3s ease; }
        .tab-active { background-color: #0284c7; color: white; shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .tab-inactive { background-color: #f3f4f6; color: #4b5563; }
        .tab-inactive:hover { background-color: #e5e7eb; }

        /* Progress Bar */
        .progress-container { background-color: #e5e7eb; border-radius: 999px; height: 8px; width: 100%; overflow: hidden; margin-top: 10px; }
        .progress-fill { background-color: #10b981; height: 100%; width: 0%; transition: width 0.5s ease-in-out; }

        /* Active playing line */
        .playing-line { border-left: 4px solid #0ea5e9; background-color: #f0f9ff !important; }

        /* STROKE ORDER STYLES */
        .stroke-path {
            fill: none;
            stroke: #333;
            stroke-width: 3;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .stroke-grid-box {
            border: 1px solid #e5e7eb;
            background-color: white;
            position: relative;
        }
        /* Dotted lines for kanji grid */
        .stroke-grid-box::after {
            content: ''; position: absolute; top: 0; left: 50%; width: 1px; height: 100%;
            background: repeating-linear-gradient(to bottom, #ddd 0, #ddd 4px, transparent 4px, transparent 8px); z-index: 0;
        }
        .stroke-grid-box::before {
            content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 1px;
            background: repeating-linear-gradient(to right, #ddd 0, #ddd 4px, transparent 4px, transparent 8px); z-index: 0;
        }

        /* Mobile Optimization for Quiz Options */
        .quiz-option {
            touch-action: manipulation; /* Improves touch response */
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Header -->
    <header class="bg-sky-700 text-white shadow-lg sticky top-0 z-40">
        <div class="container mx-auto px-4 py-3">
            <div class="flex flex-col md:flex-row justify-between items-center gap-3">
                <!-- Logo Area -->
                <div class="flex items-center space-x-3 cursor-pointer self-start md:self-auto" onclick="location.reload()">
                    <i class="fas fa-torii-gate text-2xl md:text-3xl text-yellow-300"></i>
                    <div>
                        <h1 class="text-lg md:text-xl font-bold uppercase tracking-wider leading-tight">AzaKanji Kaiwa</h1>
                        <p class="text-[10px] md:text-xs text-sky-200">Học Hội Thoại & Ngữ Pháp (Day 7)</p>
                    </div>
                </div>
                
                <!-- Controls (Scrollable on mobile) -->
                <div class="w-full md:w-auto flex items-center overflow-x-auto pb-1 md:pb-0 no-scrollbar">
                    <div class="flex bg-sky-800 rounded-lg p-1 text-sm whitespace-nowrap mx-auto md:mx-0">
                        <button id="btn-toggle-furigana" class="px-2 md:px-3 py-1.5 rounded transition hover:bg-sky-600 text-white flex items-center" title="Bật/Tắt cách đọc Kanji">
                            <i class="fas fa-eye mr-1 md:mr-2"></i> Furi
                        </button>
                        <button id="btn-toggle-romaji" class="px-2 md:px-3 py-1.5 rounded transition hover:bg-sky-600 text-white flex items-center ml-1" title="Bật/Tắt phiên âm Romaji">
                            <i class="fas fa-font mr-1 md:mr-2"></i> Romaji
                        </button>
                        <button id="btn-toggle-vi" class="px-2 md:px-3 py-1.5 rounded transition bg-white text-sky-800 font-bold ml-1 flex items-center" title="Bật/Tắt dịch tiếng Việt">
                            <i class="fas fa-language mr-1 md:mr-2"></i> Việt
                        </button>
                        
                        <!-- Audio Speed Control -->
                        <div class="flex items-center px-2 ml-1 border-l border-sky-600 text-white">
                            <i class="fas fa-tachometer-alt mr-1 text-sky-300 text-xs"></i>
                            <select id="audio-speed" class="bg-transparent border-none focus:ring-0 text-white font-bold cursor-pointer text-xs p-0">
                                <option value="0.75" class="text-gray-800">0.75x</option>
                                <option value="1.0" class="text-gray-800" selected>1.0x</option>
                                <option value="1.25" class="text-gray-800">1.25x</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-3 md:px-4 py-4 md:py-8 flex-grow space-y-6 md:space-y-8" id="app">
        
        <!-- Progress Section -->
        <div class="w-full max-w-4xl mx-auto mb-2 bg-white p-3 rounded-lg shadow-sm border border-gray-100">
            <div class="flex justify-between text-xs text-gray-500 mb-1 font-bold">
                <span>Tiến độ học tập</span>
                <span id="progress-text">0%</span>
            </div>
            <div class="progress-container">
                <div id="progress-bar" class="progress-fill"></div>
            </div>
        </div>

        <!-- 1. Conversation Section -->
        <section class="bg-white rounded-xl md:rounded-2xl shadow-md overflow-hidden fade-in border border-gray-100">
            <div class="bg-sky-50 px-4 md:px-6 py-3 md:py-4 border-b border-sky-100">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-3">
                    <h2 class="text-lg md:text-xl font-bold text-sky-800 flex items-center flex-wrap">
                        <span class="flex items-center"><i class="fas fa-comments mr-2"></i>Hội Thoại: Tại Nhà Trọ</span>
                        <button onclick="playAllConversation()" class="ml-auto md:ml-3 text-xs md:text-sm bg-sky-100 text-sky-700 hover:bg-sky-200 px-3 py-1 rounded-full transition flex items-center whitespace-nowrap">
                            <i class="fas fa-play mr-1"></i> Nghe hết
                        </button>
                    </h2>
                    
                    <!-- Mode Tabs -->
                    <div class="flex bg-white rounded-lg p-1 shadow-sm border border-gray-200 w-full md:w-auto">
                        <button onclick="switchMode('polite')" id="tab-polite" class="tab-btn tab-active flex-1 md:flex-none px-2 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-bold text-center">Lịch sự</button>
                        <button onclick="switchMode('casual')" id="tab-casual" class="tab-btn tab-inactive flex-1 md:flex-none px-2 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-bold ml-1 text-center">Thông thường</button>
                    </div>
                </div>
            </div>
            
            <div class="p-3 md:p-6 space-y-4 md:space-y-6" id="conversation-container">
                <!-- Dialogue injected by JS -->
            </div>
        </section>

        <!-- 2. Reading Section -->
        <section class="bg-white rounded-xl md:rounded-2xl shadow-md overflow-hidden fade-in border border-gray-100">
            <div class="bg-orange-50 px-4 md:px-6 py-3 md:py-4 border-b border-orange-100">
                <h2 class="text-lg md:text-xl font-bold text-orange-800"><i class="fas fa-book-open mr-2"></i>Bài Đọc: Kỷ Niệm Kỳ Nghỉ</h2>
            </div>
            <div class="p-4 md:p-6">
                <div class="bg-orange-50/30 p-3 md:p-5 rounded-xl border border-orange-100 leading-loose text-base md:text-lg kanji-font mb-2 text-justify" id="reading-text"></div>
                <div class="text-gray-500 text-sm mb-4 italic hidden romaji-text" id="reading-romaji"></div>
                <div class="text-gray-700 text-sm mb-4 hidden vi-trans border-t border-orange-100 pt-2" id="reading-vi"></div>
                
                <!-- Reading Practice Area -->
                <div class="mt-6 pt-4 border-t border-gray-100">
                    <h4 class="text-sm font-bold text-gray-500 mb-2 uppercase flex items-center"><i class="fas fa-keyboard mr-2"></i> Luyện gõ lại bài đọc:</h4>
                    <textarea id="reading-input" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-200 bg-gray-50 text-base kanji-font h-32" placeholder="Gõ lại nội dung bài đọc bằng tiếng Nhật vào đây..."></textarea>
                    <div id="reading-feedback" class="text-sm mt-2 min-h-[1.5rem]"></div>
                </div>
            </div>
        </section>

        <!-- 3. Grammar Section -->
        <section class="bg-white rounded-xl md:rounded-2xl shadow-md overflow-hidden fade-in border border-gray-100">
            <div class="bg-purple-50 px-4 md:px-6 py-3 md:py-4 border-b border-purple-100">
                <h2 class="text-lg md:text-xl font-bold text-purple-800"><i class="fas fa-star mr-2"></i>Ngữ Pháp Quan Trọng</h2>
            </div>
            <div class="p-4 md:p-6 grid grid-cols-1 md:grid-cols-2 gap-4" id="grammar-container"></div>
        </section>

        <!-- 4. Vocabulary Flashcards -->
        <section class="fade-in">
            <div class="flex items-center justify-between mb-4 px-2">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800"><i class="fas fa-tags mr-2 text-sky-600"></i>Thẻ Kanji</h2>
                <div class="flex items-center gap-2">
                    <button onclick="shuffleVocab()" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1 rounded-full font-bold transition flex items-center">
                        <i class="fas fa-random mr-1"></i> Shuffle
                    </button>
                    <span class="text-xs md:text-sm text-gray-500 bg-white px-3 py-1 rounded-full shadow-sm" id="vocab-counter">1 / 18</span>
                </div>
            </div>
            
            <div class="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden relative min-h-[450px] md:min-h-[500px]" id="vocab-card-container">
                <!-- Navigation buttons customized for mobile to not cover content -->
                <button onclick="prevVocab()" class="absolute left-0 top-0 bottom-0 px-2 md:px-4 text-gray-400 hover:text-sky-600 hover:bg-sky-50 transition z-10 focus:outline-none bg-white/50 md:bg-transparent"><i class="fas fa-chevron-left text-2xl md:text-3xl"></i></button>
                <button onclick="nextVocab()" class="absolute right-0 top-0 bottom-0 px-2 md:px-4 text-gray-400 hover:text-sky-600 hover:bg-sky-50 transition z-10 focus:outline-none bg-white/50 md:bg-transparent"><i class="fas fa-chevron-right text-2xl md:text-3xl"></i></button>
                
                <div id="vocab-content" class="p-6 md:p-12 text-center card-transition h-full flex flex-col justify-center"></div>
            </div>
        </section>

        <!-- 5. Quiz Section -->
        <section class="bg-white rounded-xl md:rounded-2xl shadow-md overflow-hidden fade-in border border-gray-100 mb-8 md:mb-12">
            <div class="bg-emerald-50 px-4 md:px-6 py-3 md:py-4 border-b border-emerald-100 flex justify-between items-center">
                <h2 class="text-lg md:text-xl font-bold text-emerald-800"><i class="fas fa-question-circle mr-2"></i>Thực Hành</h2>
                <span class="text-xs md:text-sm bg-emerald-200 text-emerald-800 px-3 py-1 rounded-full font-bold" id="quiz-score">0/10</span>
            </div>
            <div class="p-4 md:p-6 space-y-6" id="quiz-container"></div>
            <div class="px-6 py-4 bg-gray-50 border-t border-gray-100 text-center">
                <button onclick="checkQuiz()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-10 rounded-full shadow-lg transform transition active:scale-95 text-sm md:text-base w-full md:w-auto">Nộp Bài</button>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-gray-400 py-6 md:py-8 mt-6">
        <div class="container mx-auto px-4 text-center text-sm">
            <p>&copy; 2025 AzaKanji Kaiwa.</p>
        </div>
    </footer>

    <!-- STROKE ORDER MODAL -->
    <div id="stroke-modal" class="fixed inset-0 z-50 hidden overflow-y-auto" role="dialog" aria-modal="true">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity backdrop-blur-sm" onclick="closeStrokeModal()"></div>
            <div class="inline-block align-bottom bg-white rounded-xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl w-full modal-enter relative">
                <div class="bg-sky-600 px-4 py-3 flex justify-between items-center text-white">
                    <h3 class="font-bold text-lg"><i class="fas fa-pen-nib mr-2"></i>Tập Viết Kanji: <span id="stroke-modal-char" class="text-2xl ml-2"></span></h3>
                    <button onclick="closeStrokeModal()" class="hover:text-gray-200 p-2"><i class="fas fa-times text-xl"></i></button>
                </div>
                <div class="p-4 md:p-6 bg-gray-50 max-h-[80vh] overflow-y-auto">
                    <div class="flex flex-col md:flex-row gap-6 md:gap-8 items-center md:items-start justify-center">
                        <div class="bg-white p-4 rounded-lg shadow border border-gray-200 text-center w-full md:w-auto">
                            <p class="text-sm text-gray-500 mb-2 font-bold uppercase">Mô phỏng</p>
                            <div id="stroke-animation-container" class="w-40 h-40 mx-auto bg-white border border-gray-300 relative stroke-grid-box flex items-center justify-center">
                                <span class="text-gray-400 text-xs">Đang tải...</span>
                            </div>
                            <button onclick="replayStrokeAnimation()" class="mt-3 text-sm bg-sky-100 text-sky-700 px-4 py-2 rounded hover:bg-sky-200 transition w-full"><i class="fas fa-redo mr-1"></i> Viết lại</button>
                        </div>
                        <div class="flex-1 w-full">
                            <p class="text-sm text-gray-500 mb-3 font-bold uppercase text-center md:text-left">Thứ tự nét</p>
                            <div id="stroke-grid-container" class="flex flex-wrap gap-2 justify-center md:justify-start"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA DAY 7 ---
        const lessonData = {
            conversation: {
                polite: [
                    { role: "Tanaka", jp: "鈴木[すずき]さん、荷物[にもつ]は重[おも]いですか。手伝[てつだ]いましょうか。", romaji: "Suzuki-san, nimotsu wa omoi desu ka. Tetsudaimashou ka.", vi: "Anh Suzuki, hành lý có nặng không? Để tôi giúp một tay nhé?" },
                    { role: "Suzuki", jp: "ありがとうございます。でも、大丈夫[だいじょうぶ]です。ホテルに着[つ]いてから、休[やす]みましょう。", romaji: "Arigatou gozaimasu. Demo, daijoubu desu. Hoteru ni tsuite kara, yasumimashou.", vi: "Cảm ơn anh. Nhưng tôi không sao đâu. Sau khi đến khách sạn, chúng ta hãy nghỉ ngơi." },
                    { role: "Tanaka", jp: "はい。この旅館[りょかん]はきれいですね。ここで写真[しゃしん]を撮[と]ってもいいですか。", romaji: "Hai. Kono ryokan wa kirei desu ne. Koko de shashin o totte mo ii desu ka.", vi: "Vâng. Nhà trọ kiểu Nhật này đẹp thật nhỉ. Tôi chụp ảnh ở đây có được không?" },
                    { role: "Suzuki", jp: "もちろん、いいですよ。でも、フラッシュは使[つか]わないでください。夕食[ゆうしょく]を食[た]べてから、相撲[すもう]を見[み]に行[い]きませんか。", romaji: "Mochiron, ii desu yo. Demo, furasshu wa tsukawanai de kudasai. Yuushoku o tabete kara, sumou o mi ni ikimasen ka.", vi: "Tất nhiên là được ạ. Nhưng xin đừng dùng đèn flash. Sau khi ăn tối, chúng ta đi xem Sumo không?" },
                    { role: "Tanaka", jp: "いいですね、行[い]きましょう。相撲[すもう]は一度[いちど]も見[み]たことがありません。", romaji: "Ii desu ne, ikimashou. Sumou wa ichido mo mita koto ga arimasen.", vi: "Hay đấy, chúng ta cùng đi nào. Tôi chưa từng xem Sumo một lần nào." }
                ],
                casual: [
                    { role: "Tanaka", jp: "鈴木[すずき]くん、荷物[にもつ]、重[おも]い？手伝[てつだ]おうか。", romaji: "Suzuki-kun, nimotsu, omoi? Tetsudaou ka.", vi: "Suzuki, hành lý nặng không? Giúp một tay nhé?" },
                    { role: "Suzuki", jp: "ありがとう。でも、大丈夫[だいじょうぶ]。ホテルに着[つ]いてから、休[やす]もう。", romaji: "Arigatou. Demo, daijoubu. Hoteru ni tsuite kara, yasumou.", vi: "Cảm ơn nhé. Nhưng không sao đâu. Đến khách sạn rồi nghỉ ngơi thôi." },
                    { role: "Tanaka", jp: "うん。この旅館[りょかん]、きれいだね。ここで写真[しゃしん]撮[と]ってもいい？", romaji: "Un. Kono ryokan, kirei da ne. Koko de shashin totte mo ii?", vi: "Ừ. Nhà trọ này đẹp ghê. Chụp ảnh ở đây được không?" },
                    { role: "Suzuki", jp: "もちろん。でも、フラッシュは使[つか]わないでね。晩[ばん]ごはん食[た]べてから、相撲[すもう]見[み]に行[い]かない？", romaji: "Mochiron. Demo, furasshu wa tsukawanai de ne. Ban gohan tabete kara, sumou mi ni ikanai?", vi: "Được chứ. Nhưng đừng dùng flash nhé. Ăn tối xong đi xem Sumo không?" },
                    { role: "Tanaka", jp: "いいね、行[い]こう。相撲[すもう]って一度[いちど]も見[み]たことないんだ。", romaji: "Ii ne, ikou. Sumou tte ichido mo mita koto nain da.", vi: "Hay đó, đi thôi. Tớ chưa xem Sumo bao giờ cả." }
                ]
            },
            reading: {
                jp: "私[わたし]は旅行[りょこう]が好[す]きです。でも、あまり時間[じかん]がありません。先週[せんしゅう]の連休[れんきゅう]に、初[はじ]めて旅館[りょかん]に泊[と]まりました。旅館[りょかん]は静[しず]かですけれど、少[すこ]し古[ふる]かったです。ご飯[はん]を食[た]べてから、近[ちか]くのプールで泳[およ]ぎました。夜[よる]遅[おそ]くまでドラマを見[み]ても、誰[だれ]も心配[しんぱい]しません。とても楽[たの]しかったです。",
                romaji: "Watashi wa ryokou ga suki desu. Demo, amari jikan ga arimasen. Senshuu no renkyuu ni, hajimete ryokan ni tomarimashita. Ryokan wa shizuka desu keredo, sukoshi furukatta desu. Gohan o tabete kara, chikaku no puuru de oyogimashita. Yoru osoku made dorama o mite mo, dare mo shinpai shimasen. Totemo tanoshikatta desu.",
                vi: "Tôi thích du lịch. Nhưng tôi không có nhiều thời gian. Vào kỳ nghỉ dài tuần trước, lần đầu tiên tôi đã ở một nhà trọ kiểu Nhật. Nhà trọ yên tĩnh nhưng hơi cũ một chút. Sau khi ăn cơm, tôi đã bơi ở hồ bơi gần đó. Dù tôi xem phim đến khuya cũng không ai lo lắng. Rất là vui."
            },
            grammar: [
                { rule: "Vてから", formula: "V1 てから, V2", mean: "Sau khi làm V1, thì làm V2 (nhấn mạnh trình tự)", ex: "仕事[しごと]が終[お]わってから、帰[かえ]ります。", vi: "Sau khi xong việc, tôi sẽ về." },
                { rule: "Vてもいいです", formula: "Vて + もいいです(か)", mean: "Làm V... cũng được (xin phép / cho phép)", ex: "このペンを使[つか]ってもいいですか。", vi: "Tôi dùng cái bút này có được không?" },
                { rule: "Vてはいけません", formula: "Vて + はいけません", mean: "Không được làm V (cấm đoán)", ex: "ここでタバコを吸[す]ってはいけません。", vi: "Không được hút thuốc ở đây." },
                { rule: "Vましょうか", formula: "V(bỏ ます) + ましょうか", mean: "Để tôi làm V giúp bạn nhé? (đề nghị)", ex: "荷物[にもつ]を持[も]ちましょうか。", vi: "Để tôi mang hành lý giúp bạn nhé?" },
                { rule: "まだ～ていません", formula: "まだ + Vていません", mean: "Vẫn chưa làm V", ex: "まだ昼[ひる]ごはんを食[た]べていません。", vi: "Tôi vẫn chưa ăn trưa." },
                { rule: "～から", formula: "Câu + から", mean: "Bởi vì... (nêu lý do)", ex: "時間[じかん]がありませんから、急[いそ]ぎましょう。", vi: "Vì không có thời gian nên hãy nhanh lên." }
            ],
            vocab: [
                { 
                    k: "旅", h: "たび", on: "リョ", kun: "たび", m: "Lữ/Du lịch", hv: "LỮ", 
                    ti: "Phương (**方**) trời xa, người nằm (**𠂉**) mặc áo rách (**衣**) đi Lữ hành.", 
                    ta: "Đi **Du lịch** mang cái **Rổ** (**Ryo**) làm gì?", 
                    compounds: [{w: "旅行", r: "りょこう", m: "Du lịch"}] 
                },
                { 
                    k: "荷", h: "に", on: "カ", kun: "に", m: "Hà/Hành lý", hv: "HÀ", 
                    ti: "Cỏ (**艹**) mà Hà (**何**) bá mang vác là Hành lý.", 
                    ta: "**Ca** (**Ka**) hát khi mang hành lý.", 
                    compounds: [{w: "荷物", r: "にもつ", m: "Hành lý"}] 
                },
                { 
                    k: "物", h: "もの", on: "ブツ", kun: "もの", m: "Vật/Đồ vật", hv: "VẬT", 
                    ti: "Con Bò (**牛**) Chớ (**勿**) coi là đồ vật.", 
                    ta: "Đồ vật này **Bự** (**Butsu**) quá.", 
                    compounds: [{w: "荷物", r: "にもつ", m: "Hành lý"}] 
                },
                { 
                    k: "重", h: "おも", on: "ジュウ", kun: "おも.い", m: "Trọng/Nặng", hv: "TRỌNG", 
                    ti: "Ngàn (**千**) ngôi làng (**里**) thì rất Nặng.", 
                    ta: "**Trọng** lượng của **Chủ** (**Juu**) tịch.", 
                    compounds: [{w: "重い", r: "おもい", m: "Nặng"}] 
                },
                { 
                    k: "手", h: "て", on: "シュ", kun: "て", m: "Thủ/Tay", hv: "THỦ", 
                    ti: "Hình dáng bàn tay xòe ra.", 
                    ta: "**Su** (**Shu**) hào cầm bằng tay.", 
                    compounds: [{w: "手伝う", r: "てつだう", m: "Giúp đỡ"}] 
                },
                { 
                    k: "伝", h: "つた", on: "デン", kun: "つた.える", m: "Truyền/Nhắn", hv: "TRUYỀN", 
                    ti: "Người (**亻**) đứng trên mây (**云**) Truyền tin.", 
                    ta: "Dây **Điện** (**Den**) truyền tin.", 
                    compounds: [{w: "手伝う", r: "てつだう", m: "Giúp đỡ"}] 
                },
                { 
                    k: "写", h: "うつ", on: "シャ", kun: "うつ.す", m: "Tả/Sao chép", hv: "TẢ", 
                    ti: "Dưới mái nhà (**冖**) Cho (**与**) người ta Sao chép.", 
                    ta: "**Xa** (**Sha**) lánh việc sao chép.", 
                    compounds: [{w: "写真", r: "しゃしん", m: "Ảnh"}] 
                },
                { 
                    k: "真", h: "ま", on: "シン", kun: "ま", m: "Chân/Thật", hv: "CHÂN", 
                    ti: "Mười (**十**) con mắt (**目**) nhìn vào cái bàn (**一** + **八**) là sự Thật.", 
                    ta: "**Xin** (**Shin**) thề nói thật.", 
                    compounds: [{w: "写真", r: "しゃしん", m: "Ảnh"}] 
                },
                { 
                    k: "撮", h: "と", on: "サツ", kun: "と.る", m: "Toát/Chụp", hv: "TOÁT", 
                    ti: "Tay (**扌**) Tối (**最**) ưu hóa việc Chụp ảnh.", 
                    ta: "**Sát** (**Satsu**) thủ chụp ảnh.", 
                    compounds: [{w: "撮る", r: "とる", m: "Chụp ảnh"}] 
                },
                { 
                    k: "夕", h: "ゆう", on: "セキ", kun: "ゆう", m: "Tịch/Chiều tối", hv: "TỊCH", 
                    ti: "Vầng trăng khuyết lúc Chiều tối.", 
                    ta: "Phân **Tích** (**Seki**) buổi chiều tà.", 
                    compounds: [{w: "夕食", r: "ゆうしょく", m: "Bữa tối"}] 
                },
                { 
                    k: "相", h: "あい", on: "ソウ", kun: "-", m: "Tương/Tương tự", hv: "TƯƠNG", 
                    ti: "Cây (**木**) và Mắt (**目**) Tương tư nhau.", 
                    ta: "**Sau** (**Sou**) này tương ngộ.", 
                    compounds: [{w: "相撲", r: "すもう", m: "Sumo"}] 
                },
                { 
                    k: "撲", h: "はた", on: "ボク", kun: "なぐ.る", m: "Phác/Đánh", hv: "PHÁC", 
                    ti: "Tay (**扌**) của người Nghiệp (**業**) dư đánh nhau.", 
                    ta: "Người **Mộc** (**Boku**) mạc đi đánh nhau.", 
                    compounds: [{w: "相撲", r: "すもう", m: "Sumo"}] 
                },
                { 
                    k: "泊", h: "と", on: "ハク", kun: "と.まる", m: "Bạc/Trọ lại", hv: "BẠC", 
                    ti: "Nước (**氵**) Trắng (**白**) ở bến Bạc.", 
                    ta: "Chú **Bác** (**Haku**) đi trọ lại.", 
                    compounds: [{w: "泊まる", r: "とまる", m: "Trọ lại/Ở lại"}] 
                },
                { 
                    k: "泳", h: "およ", on: "エイ", kun: "およ.ぐ", m: "Vịnh/Bơi", hv: "VỊNH", 
                    ti: "Nước (**氵**) Vĩnh (**永**) cửu để Bơi.", 
                    ta: "Bơi lội nghệ thuật (**Ei**).", 
                    compounds: [{w: "泳ぐ", r: "およぐ", m: "Bơi"}] 
                },
                { 
                    k: "酒", h: "さけ", on: "シュ", kun: "さけ", m: "Tửu/Rượu", hv: "TỬU", 
                    ti: "Nước (**氵**) trong bình Dậu (**酉**) là Rượu.", 
                    ta: "**Sa kê** (**Sake**) là rượu Nhật.", 
                    compounds: [{w: "お酒", r: "おさけ", m: "Rượu"}] 
                },
                { 
                    k: "飲", h: "の", on: "イン", kun: "の.む", m: "Ẩm/Uống", hv: "ẨM", 
                    ti: "Ăn (**飠**) xong thiếu (**欠**) nước phải Uống.", 
                    ta: "**In** (**In**) dấu môi khi uống.", 
                    compounds: [{w: "飲む", r: "のむ", m: "Uống"}] 
                },
                { 
                    k: "禁", h: "きん", on: "キン", kun: "-", m: "Cấm", hv: "CẤM", 
                    ti: "Rừng (**林**) cấm vào thờ cúng (**示**).", 
                    ta: "**Kim** (**Kin**) tiêm là đồ cấm.", 
                    compounds: [{w: "禁止", r: "きんし", m: "Cấm"}] 
                },
                { 
                    k: "止", h: "と", on: "シ", kun: "と.める", m: "Chỉ/Dừng", hv: "CHỈ", 
                    ti: "Người đang đi thì dừng lại.", 
                    ta: "**Si** (**Shi**) mê nên dừng lại ngắm.", 
                    compounds: [{w: "禁止", r: "きんし", m: "Cấm"}] 
                }
            ],
            quiz: [
                { type: "mcq", question: "荷物[にもつ]を（___）ましょうか。", options: ["持ち", "持って", "持つ"], answer: "持ち", explain: "V(bỏ mas) + ましょうか: Để tôi làm V nhé (đề nghị)." },
                { type: "fill", question: "ご飯[はん]を食[た]べて（___）、勉強[べんきょう]します。", answer: "から", explain: "Vて + から: Sau khi làm V1 thì làm V2." },
                { type: "mcq", question: "ここでタバコを吸[す]って（___）いけません。", options: ["も", "は", "が"], answer: "は", explain: "Vて + は + いけません: Cấm làm V." },
                { type: "audio", question: "Nghe và gõ lại câu bạn vừa nghe:", jp: "ここで写真を撮ってもいいですか。", explain: "Koko de shashin o totte mo ii desu ka (Tôi chụp ảnh ở đây được không?)." },
                { type: "mcq", question: "（___）から、タクシーで行[い]きましょう。", options: ["時間がない", "時間がありません", "時間がある"], answer: "時間がない", explain: "～から: Bởi vì (lý do). Đi với thể thông thường hoặc lịch sự đều được, nhưng 'Jikan ga nai' tự nhiên hơn trong văn nói." },
                { type: "fill", question: "窓[まど]を（___）ましょうか。", answer: "閉め", explain: "Shimemashouka (Tôi đóng cửa nhé?)." },
                { type: "mcq", question: "まだ宿題[しゅくだい]を（___）。", options: ["していません", "しません", "しませんでした"], answer: "していません", explain: "Mada ... teimasen: Vẫn chưa làm gì." },
                { type: "mcq", question: "Từ '旅館' đọc là gì?", options: ["りょかん", "りょこう", "かいかん"], answer: "りょかん", explain: "旅館 (Ryokan) - Nhà trọ kiểu Nhật." },
                { type: "mcq", question: "このペンを（___）もいいですか。", options: ["使う", "使って", "使い"], answer: "使って", explain: "Vて + もいいですか: Làm V có được không (xin phép)." },
                { type: "audio", question: "Nghe và điền từ còn thiếu: 荷物は___ですか。", jp: "荷物は重いですか。", explain: "Omoi (Nặng)." }
            ]
        };

        // --- STATE MANAGEMENT & SETTINGS ---
        let currentMode = 'polite';
        let settings = { hideFurigana: false, showRomaji: false, showVietnamese: false, currentSpeed: 1.0 };
        let progress = { conversation: false, reading: false, grammar: false, vocab: 0, quiz: 0 };
        let vocabSeen = new Set();
        let currentVocabIndex = 0;
        let currentStrokeSvg = null;
        let quizScoreCurrent = 0;
        let jpVoice = null;
        let recognition = null;
        let isRecognizing = false;

        // --- AUDIO & SPEECH ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            if (type === 'correct') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(500, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1); gain.gain.setValueAtTime(0.2, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3); osc.start(); osc.stop(audioCtx.currentTime + 0.3);
            } else {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(200, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.2); gain.gain.setValueAtTime(0.2, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2); osc.start(); osc.stop(audioCtx.currentTime + 0.2);
            }
        }

        function loadVoices() {
            const voices = window.speechSynthesis.getVoices();
            jpVoice = voices.find(v => v.name === 'Google 日本語') || voices.find(v => v.lang === 'ja-JP') || null;
        }
        window.speechSynthesis.onvoiceschanged = loadVoices;

        function cleanText(text) { return text ? text.replace(/\[.*?\]/g, '') : ''; }
        function parseFurigana(text) { return text ? text.replace(/([^\[\]]+)\[(.+?)\]/g, '<ruby>$1<rt>$2</rt></ruby>') : ''; }

        function speak(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(cleanText(text));
                u.lang = 'ja-JP'; u.rate = settings.currentSpeed;
                if(jpVoice) u.voice = jpVoice;
                window.speechSynthesis.speak(u);
            }
        }

        function initSpeech() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.lang = 'ja-JP';
                recognition.continuous = false;
                recognition.interimResults = false;
            }
        }

        function startListening(targetInputId) {
            if (!recognition) { alert("Trình duyệt không hỗ trợ nhận diện giọng nói."); return; }
            if (isRecognizing) { recognition.stop(); return; }
            const btn = document.getElementById(`mic-btn-${targetInputId}`);
            const input = document.getElementById(targetInputId);
            document.querySelectorAll('.mic-listening').forEach(el => el.classList.remove('mic-listening'));
            recognition.onstart = () => { isRecognizing = true; btn.classList.add('mic-listening'); };
            recognition.onend = () => { isRecognizing = false; btn.classList.remove('mic-listening'); };
            recognition.onresult = (event) => { input.value = event.results[0][0].transcript; input.dispatchEvent(new Event('input')); };
            try { recognition.start(); } catch (e) { isRecognizing = false; }
        }

        // --- CORE FUNCTIONS ---
        function saveSettings() { localStorage.setItem('azaSettings_day7', JSON.stringify(settings)); }
        function loadSettings() {
            const saved = localStorage.getItem('azaSettings_day7');
            if (saved) settings = { ...settings, ...JSON.parse(saved) };
        }

        function updateProgress() {
            let points = 0;
            const convoInputs = document.querySelectorAll('#conversation-container .correct-input');
            const totalConvoLines = lessonData.conversation.polite.length;
            if (totalConvoLines > 0) points += (convoInputs.length / totalConvoLines) * 30;
            const readingInput = document.getElementById('reading-input');
            if(readingInput && readingInput.value.length > 20) points += 10;
            if(lessonData.vocab.length > 0) points += (vocabSeen.size / lessonData.vocab.length) * 30;
            if(lessonData.quiz.length > 0) points += (quizScoreCurrent / lessonData.quiz.length) * 30;
            const percent = Math.min(100, Math.round(points));
            document.getElementById('progress-bar').style.width = `${percent}%`;
            document.getElementById('progress-text').innerText = `${percent}%`;
        }

        function checkTyping(input, correctText, feedbackDiv) {
            const userText = input.value;
            const targetText = cleanText(correctText);
            let html = '';
            for (let i = 0; i < userText.length; i++) {
                if (i >= targetText.length) html += `<span class="incorrect-char">${userText[i]}</span>`;
                else if (userText[i] === targetText[i]) html += `<span class="correct-char">${userText[i]}</span>`;
                else html += `<span class="incorrect-char">${userText[i]}</span>`;
            }
            feedbackDiv.innerHTML = html;
            if (userText === targetText) {
                input.classList.add('correct-input'); input.classList.remove('wrong-input');
                feedbackDiv.innerHTML += ' <span class="text-green-600 ml-2 font-bold text-xs"><i class="fas fa-check-circle"></i> Chính xác!</span>';
                playSound('correct'); updateProgress();
            } else if (userText.length > 0) {
                input.classList.add('wrong-input'); input.classList.remove('correct-input');
            } else {
                input.classList.remove('correct-input', 'wrong-input');
            }
        }

        // --- RENDERERS ---
        function renderConversation() {
            const container = document.getElementById('conversation-container');
            const lines = lessonData.conversation[currentMode];
            container.innerHTML = lines.map((line, idx) => `
                <div class="flex gap-2 md:gap-4 fade-in ${line.role === 'Tanaka' ? '' : 'flex-row-reverse'} p-1 md:p-2 rounded-lg transition-colors duration-300">
                    <div class="flex-shrink-0 w-8 h-8 md:w-12 md:h-12 rounded-full flex items-center justify-center font-bold text-white shadow-md text-sm md:text-base ${line.role === 'Tanaka' ? 'bg-blue-500' : 'bg-green-500'}">${line.role[0]}</div>
                    <div class="flex-1 max-w-[95%] md:max-w-[90%]">
                        <div class="text-[10px] md:text-xs text-gray-500 mb-1 ${line.role === 'Tanaka' ? 'text-left' : 'text-right'}">${line.role}</div>
                        <div class="bg-white p-3 md:p-4 rounded-xl md:rounded-2xl shadow-sm border border-gray-200 relative group transition hover:shadow-md ${line.role === 'Tanaka' ? 'rounded-tl-none' : 'rounded-tr-none bg-green-50'}">
                            <p class="text-base md:text-lg text-gray-800 kanji-font leading-relaxed mb-1 pr-6 md:pr-0">${parseFurigana(line.jp)}</p>
                            <p class="text-sm text-gray-500 romaji-text hidden italic mb-1">${line.romaji}</p>
                            <p class="text-xs md:text-sm text-gray-500 vi-trans border-t border-gray-100 pt-2 mt-2">${line.vi}</p>
                            <button onclick="speak('${line.jp}')" class="absolute top-2 right-2 text-gray-300 hover:text-sky-600 transition"><i class="fas fa-volume-up"></i></button>
                            <div class="mt-3 pt-2 border-t border-gray-100">
                                <div class="flex gap-2">
                                    <input type="text" id="convo-input-${idx}" class="flex-1 text-base p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-200 transition bg-gray-50 placeholder-gray-300 min-w-0" placeholder="Nghe và gõ lại..." oninput="checkTyping(this, '${line.jp}', this.parentElement.nextElementSibling)">
                                    <button id="mic-btn-convo-input-${idx}" onclick="startListening('convo-input-${idx}')" class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-2 md:px-3 rounded-lg transition flex-shrink-0"><i class="fas fa-microphone"></i></button>
                                </div>
                                <div class="h-auto md:h-5 mt-1 text-xs md:text-sm pl-1 kanji-font break-all"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            updateUI();
        }

        function playAllConversation() {
            const lines = lessonData.conversation[currentMode];
            let i = 0;
            function playNext() {
                if (i >= lines.length) return;
                const allLines = document.querySelectorAll('#conversation-container > div');
                allLines.forEach(el => el.classList.remove('playing-line'));
                if (allLines[i]) {
                    allLines[i].classList.add('playing-line');
                    allLines[i].scrollIntoView({behavior: "smooth", block: "center"});
                }
                speak(lines[i].jp);
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(cleanText(lines[i].jp));
                u.lang = 'ja-JP'; u.rate = settings.currentSpeed;
                if(jpVoice) u.voice = jpVoice;
                u.onend = () => { i++; setTimeout(playNext, 500); };
                window.speechSynthesis.speak(u);
            }
            window.speechSynthesis.cancel();
            playNext();
        }

        function switchMode(mode) {
            currentMode = mode;
            document.getElementById('tab-polite').className = mode === 'polite' ? "tab-btn tab-active flex-1 md:flex-none px-2 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-bold text-center" : "tab-btn tab-inactive flex-1 md:flex-none px-2 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-bold ml-1 text-center";
            document.getElementById('tab-casual').className = mode === 'casual' ? "tab-btn tab-active flex-1 md:flex-none px-2 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-bold ml-1 text-center" : "tab-btn tab-inactive flex-1 md:flex-none px-2 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-bold ml-1 text-center";
            renderConversation();
        }

        function renderReading() {
            document.getElementById('reading-text').innerHTML = parseFurigana(lessonData.reading.jp);
            document.getElementById('reading-romaji').innerText = lessonData.reading.romaji;
            document.getElementById('reading-vi').innerText = lessonData.reading.vi;
            const input = document.getElementById('reading-input');
            const feedback = document.getElementById('reading-feedback');
            input.oninput = () => {
                if(input.value.length > 50) updateProgress();
                checkTyping(input, lessonData.reading.jp, feedback); 
            };
            if(!document.getElementById('reading-play-btn')) {
                const btn = document.createElement('button');
                btn.id = 'reading-play-btn';
                btn.className = "mt-4 text-orange-500 hover:text-orange-700 font-bold flex items-center text-sm transition";
                btn.innerHTML = '<i class="fas fa-volume-up mr-2"></i> Nghe bài đọc';
                btn.onclick = () => speak(lessonData.reading.jp);
                document.getElementById('reading-text').parentNode.insertBefore(btn, document.getElementById('reading-text').nextSibling);
            }
        }

        function renderGrammar() {
            const container = document.getElementById('grammar-container');
            container.innerHTML = lessonData.grammar.map(g => `
                <div class="bg-white p-4 md:p-5 rounded-xl border border-purple-100 shadow-sm hover:border-purple-300 transition group">
                    <h3 class="font-bold text-purple-700 mb-1 text-base md:text-lg flex items-center"><span class="w-2 h-2 bg-purple-500 rounded-full mr-2 flex-shrink-0"></span>${g.rule}</h3>
                    <div class="mb-2 pl-4"><span class="bg-red-100 text-red-600 text-[10px] md:text-xs px-2 py-1 rounded font-bold">Công thức:</span> <span class="text-gray-700 text-xs md:text-sm kanji-font break-all">${g.formula}</span></div>
                    <p class="text-gray-600 text-xs md:text-sm mb-3 pl-4">${g.mean}</p>
                    <div class="bg-purple-50 p-3 rounded-lg text-xs md:text-sm text-gray-700 kanji-font relative pl-4">
                        <i class="fas fa-quote-left text-purple-200 absolute top-1 left-1 text-xs"></i>${parseFurigana(g.ex)}
                        <p class="text-[10px] md:text-xs text-purple-600 mt-1 italic">${g.vi}</p>
                        <button onclick="speak('${g.ex}')" class="absolute top-2 right-2 text-purple-300 hover:text-purple-600 transition md:opacity-0 md:group-hover:opacity-100"><i class="fas fa-volume-up"></i></button>
                    </div>
                </div>
            `).join('');
        }

        // --- VOCAB FLASHCARDS ---
        function getKanjiHex(kanji) { return kanji.charCodeAt(0).toString(16).padStart(5, '0'); }
        async function fetchKanjiSvg(hex) {
            try {
                const response = await fetch(`https://cdn.jsdelivr.net/gh/KanjiVG/kanjivg/kanji/${hex}.svg`);
                if (!response.ok) throw new Error('Not found');
                return await response.text();
            } catch (e) { return null; }
        }

        async function showStrokeOrder(kanji) {
            const hex = getKanjiHex(kanji);
            document.getElementById('stroke-modal').classList.remove('hidden');
            document.getElementById('stroke-modal-char').innerText = kanji;
            const animContainer = document.getElementById('stroke-animation-container');
            const gridContainer = document.getElementById('stroke-grid-container');
            animContainer.innerHTML = '<span class="text-gray-400 text-xs">Đang tải...</span>';
            const svgContent = await fetchKanjiSvg(hex);
            if (!svgContent) { animContainer.innerHTML = "<p class='text-red-500'>Lỗi</p>"; gridContainer.innerHTML = ""; return; }
            
            animContainer.innerHTML = svgContent;
            const mainSvg = animContainer.querySelector('svg');
            mainSvg.setAttribute('width', '100%'); mainSvg.setAttribute('height', '100%');
            const paths = mainSvg.querySelectorAll('path');
            paths.forEach(p => { 
                const len = p.getTotalLength(); p.style.strokeDasharray = len; p.style.strokeDashoffset = len; 
                p.style.stroke = "#333"; p.style.strokeWidth = "4"; p.style.fill = "none"; 
                p.style.strokeLinecap = "round"; p.style.strokeLinejoin = "round"; 
            });
            currentStrokeSvg = mainSvg;
            replayStrokeAnimation();

            gridContainer.innerHTML = '';
            for(let i=0; i<paths.length; i++) {
                const box = document.createElement('div');
                box.className = "w-12 h-12 md:w-20 md:h-20 bg-white border border-gray-200 relative stroke-grid-box flex items-center justify-center";
                const parser = new DOMParser();
                const svgClone = parser.parseFromString(svgContent, "image/svg+xml").querySelector('svg');
                svgClone.setAttribute('width', '100%'); svgClone.setAttribute('height', '100%');
                svgClone.querySelectorAll('path').forEach((p, idx) => {
                    p.style.fill="none"; p.style.strokeLinecap="round"; p.style.strokeLinejoin="round";
                    if(idx < i) { p.style.stroke="#9ca3af"; p.style.strokeWidth="3"; }
                    else if(idx === i) { p.style.stroke="#000"; p.style.strokeWidth="4"; }
                    else p.style.display="none";
                });
                box.appendChild(svgClone);
                gridContainer.appendChild(box);
            }
        }

        function replayStrokeAnimation() {
            if(!currentStrokeSvg) return;
            const paths = currentStrokeSvg.querySelectorAll('path');
            paths.forEach(p => { p.style.transition = 'none'; p.style.strokeDashoffset = p.getTotalLength(); });
            void currentStrokeSvg.offsetWidth;
            let delay = 0;
            paths.forEach(p => {
                p.style.transition = `stroke-dashoffset 0.6s ease-in-out ${delay}s`;
                p.style.strokeDashoffset = '0';
                delay += 0.6;
            });
        }
        function closeStrokeModal() { document.getElementById('stroke-modal').classList.add('hidden'); }

        function renderVocab() {
            vocabSeen.add(currentVocabIndex);
            updateProgress();
            const container = document.getElementById('vocab-content');
            const v = lessonData.vocab[currentVocabIndex];
            const compoundsHtml = v.compounds ? v.compounds.map(c => 
                `<div class="flex justify-between items-center bg-gray-50 px-3 py-2 rounded mb-1 cursor-pointer hover:bg-gray-100" onclick="speak('${c.r}')">
                    <span class="text-gray-800 font-bold">${c.w}</span>
                    <span class="text-gray-500 text-xs">${c.r}</span>
                    <span class="text-sky-600 text-xs text-right">${c.m}</span>
                    <i class="fas fa-volume-up text-xs text-gray-300 ml-2"></i>
                </div>`
            ).join('') : '';

            container.innerHTML = `
                <div class="animate-fade-in relative">
                    <div class="text-5xl md:text-6xl font-bold text-gray-800 kanji-font mb-2 cursor-pointer hover:text-sky-600 transition" onclick="showStrokeOrder('${v.k}')" title="Bấm để xem cách viết">${v.k}</div>
                    <button onclick="showStrokeOrder('${v.k}')" class="text-xs bg-sky-100 text-sky-700 px-3 py-1 rounded-full mb-2 hover:bg-sky-200 transition"><i class="fas fa-pen-nib mr-1"></i> Tập viết</button>
                    <div class="grid grid-cols-2 gap-2 md:gap-4 text-center mb-4 text-sm bg-gray-50 p-2 rounded-lg">
                        <div class="flex flex-col items-center"><span class="text-[10px] md:text-xs text-gray-400 block uppercase font-bold mb-1">On'yomi</span>
                            <div class="flex items-center gap-1 md:gap-2 flex-wrap justify-center"><span class="text-gray-800 font-bold text-xs md:text-sm">${v.on}</span><button onclick="speak('${v.on}')" class="w-5 h-5 rounded-full bg-white shadow-sm flex items-center justify-center text-sky-500 hover:bg-sky-50"><i class="fas fa-volume-up text-[10px]"></i></button></div>
                        </div>
                        <div class="flex flex-col items-center"><span class="text-[10px] md:text-xs text-gray-400 block uppercase font-bold mb-1">Kun'yomi</span>
                            <div class="flex items-center gap-1 md:gap-2 flex-wrap justify-center"><span class="text-gray-800 font-bold text-xs md:text-sm">${v.kun}</span><button onclick="speak('${v.kun.replace(/\./g, '')}')" class="w-5 h-5 rounded-full bg-white shadow-sm flex items-center justify-center text-sky-500 hover:bg-sky-50"><i class="fas fa-volume-up text-[10px]"></i></button></div>
                        </div>
                    </div>
                    <div class="inline-block text-[10px] md:text-xs font-bold text-white bg-gray-400 px-3 py-1 rounded-full mb-3 md:mb-4 tracking-wide">${v.hv}</div>
                    <div class="text-sky-700 font-bold text-xl md:text-2xl mb-4 md:mb-6 border-b border-gray-100 pb-2 md:pb-4">${v.m}</div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 text-left max-w-2xl mx-auto">
                        <div class="bg-orange-50 p-3 md:p-4 rounded-xl border border-orange-100"><div class="font-bold text-orange-600 mb-2 flex items-center text-sm"><i class="fas fa-image mr-2"></i> Mẹo Hình Ảnh</div><div class="text-gray-700 text-xs md:text-sm leading-relaxed">${v.ti.replace(/\*\*(.*?)\*\*/g, '<span class="text-red-600 font-bold">$1</span>')}</div></div>
                        <div class="bg-blue-50 p-3 md:p-4 rounded-xl border border-blue-100"><div class="font-bold text-blue-600 mb-2 flex items-center text-sm"><i class="fas fa-volume-up mr-2"></i> Mẹo Âm Thanh</div><div class="text-gray-700 text-xs md:text-sm leading-relaxed">${v.ta.replace(/\*\*(.*?)\*\*/g, '<span class="text-indigo-600 font-bold">$1</span>')}</div></div>
                    </div>
                    ${compoundsHtml ? `<div class="mt-6 md:mt-8 pt-4 md:pt-6 border-t border-gray-100"><div class="text-xs md:text-sm text-gray-400 mb-2 font-bold uppercase tracking-wide text-center">Từ ghép</div><div class="kanji-font text-gray-600 max-w-sm mx-auto text-left">${compoundsHtml}</div></div>` : ''}
                </div>
            `;
            document.getElementById('vocab-counter').innerText = `${currentVocabIndex + 1} / ${lessonData.vocab.length}`;
        }
        function prevVocab() { if (currentVocabIndex > 0) { currentVocabIndex--; renderVocab(); } }
        function nextVocab() { if (currentVocabIndex < lessonData.vocab.length - 1) { currentVocabIndex++; renderVocab(); } }
        function shuffleVocab() {
            for (let i = lessonData.vocab.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [lessonData.vocab[i], lessonData.vocab[j]] = [lessonData.vocab[j], lessonData.vocab[i]]; }
            currentVocabIndex = 0; renderVocab();
        }
        document.addEventListener('keydown', (e) => { if (e.key === 'ArrowLeft') prevVocab(); if (e.key === 'ArrowRight') nextVocab(); });

        // --- QUIZ ---
        function renderQuiz() {
            const container = document.getElementById('quiz-container');
            container.innerHTML = lessonData.quiz.map((q, idx) => `
                <div class="quiz-item border-b border-gray-100 pb-4 last:border-0">
                    <p class="font-bold text-gray-800 mb-2 md:mb-3 text-sm md:text-base"><span class="text-emerald-600 mr-2">Câu ${idx + 1}:</span> ${q.type === 'audio' ? q.question : parseFurigana(q.question)}</p>
                    <div class="space-y-2">
                        ${q.type === 'audio' ? `<button class="speak-btn mb-2 flex items-center text-sky-600 font-bold text-sm" onclick="speak('${q.jp}')"><i class="fas fa-volume-up mr-2"></i> Nghe câu hỏi</button><input type="text" class="w-full p-2 border rounded text-base" placeholder="Nhập câu bạn nghe được..." data-idx="${idx}">` 
                        : q.type === 'fill' ? `<input type="text" class="w-full p-2 border rounded fill-input text-base" placeholder="Điền từ còn thiếu..." data-idx="${idx}">` 
                        : q.options.map((opt, optIdx) => `<label class="flex items-center p-2 md:p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition quiz-option text-sm md:text-base" data-q="${idx}" data-opt="${optIdx}"><input type="radio" name="q${idx}" value="${optIdx}" class="mr-3 text-emerald-600 focus:ring-emerald-500"><span class="kanji-font">${parseFurigana(opt)}</span></label>`).join('')}
                    </div>
                    <div class="quiz-feedback hidden mt-3 p-3 rounded-lg text-sm" id="feedback-${idx}"></div>
                </div>
            `).join('');
            document.getElementById('quiz-score').innerText = `0/${lessonData.quiz.length}`;
        }

        function checkQuiz() {
            let score = 0;
            lessonData.quiz.forEach((q, idx) => {
                const feedbackEl = document.getElementById(`feedback-${idx}`);
                feedbackEl.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
                let isCorrect = false;
                if (q.type === 'audio') {
                    const input = document.querySelector(`input[data-idx="${idx}"]`);
                    isCorrect = input.value.trim() === cleanText(q.jp);
                } else if (q.type === 'fill') {
                    const input = document.querySelector(`input[data-idx="${idx}"]`);
                    isCorrect = input.value.trim() === q.answer;
                } else {
                    const selected = document.querySelector(`input[name="q${idx}"]:checked`);
                    if (selected && q.options && q.options[q.answer]) { // Fix logic for old string answers in MCQs
                         isCorrect = selected.parentElement.innerText.trim() === q.answer;
                    } else if (selected && typeof q.answer === 'string') {
                         isCorrect = selected.nextSibling.innerText === q.answer;
                    } else if (selected && typeof q.correct !== 'undefined') { // New logic for index-based correct answer
                         isCorrect = parseInt(selected.value) === q.correct;
                    }
                }
                
                if (isCorrect) {
                    score++;
                    feedbackEl.innerHTML = `<i class="fas fa-check-circle mr-2"></i> Chính xác! <br><span class="text-xs mt-1 block opacity-80">${q.explain || ''}</span>`;
                    feedbackEl.classList.add('bg-green-100', 'text-green-800');
                } else {
                    const ans = q.type === 'mcq' ? (q.options ? q.options[q.correct] : q.answer) : (q.type === 'audio' ? q.jp : q.answer);
                    feedbackEl.innerHTML = `<i class="fas fa-times-circle mr-2"></i> Sai rồi. Đáp án: <strong>${ans}</strong><br><span class="text-xs mt-1 block opacity-80">${q.explain || ''}</span>`;
                    feedbackEl.classList.add('bg-red-100', 'text-red-800');
                }
            });
            if(score === lessonData.quiz.length) playSound('correct'); else playSound('wrong');
            quizScoreCurrent = score;
            document.getElementById('quiz-score').innerText = `${score}/${lessonData.quiz.length}`;
            updateProgress();
        }

        function updateUI() {
            document.querySelectorAll('rt').forEach(rt => rt.style.visibility = settings.hideFurigana ? 'hidden' : 'visible');
            document.getElementById('btn-toggle-furigana').className = !settings.hideFurigana ? "px-2 md:px-3 py-1.5 rounded transition bg-sky-600 text-white flex items-center shadow" : "px-2 md:px-3 py-1.5 rounded transition bg-gray-200 text-gray-600 flex items-center";
            document.querySelectorAll('.romaji-text').forEach(el => el.classList.toggle('hidden', !settings.showRomaji));
            document.getElementById('btn-toggle-romaji').className = settings.showRomaji ? "px-2 md:px-3 py-1.5 rounded transition bg-sky-600 text-white flex items-center shadow ml-1" : "px-2 md:px-3 py-1.5 rounded transition bg-gray-200 text-gray-600 flex items-center ml-1";
            document.querySelectorAll('.vi-trans').forEach(p => p.style.display = settings.showVietnamese ? 'block' : 'none');
            document.getElementById('btn-toggle-vi').className = settings.showVietnamese ? "px-2 md:px-3 py-1.5 rounded transition bg-white text-sky-800 font-bold ml-1 flex items-center border border-sky-200 shadow-sm" : "px-2 md:px-3 py-1.5 rounded transition bg-gray-200 text-gray-500 font-bold ml-1 flex items-center";
            const speedSelect = document.getElementById('audio-speed');
            speedSelect.value = settings.currentSpeed;
            speedSelect.onchange = (e) => { settings.currentSpeed = parseFloat(e.target.value); saveSettings(); };
        }

        document.getElementById('btn-toggle-furigana').onclick = () => { settings.hideFurigana = !settings.hideFurigana; updateUI(); saveSettings(); };
        document.getElementById('btn-toggle-romaji').onclick = () => { settings.showRomaji = !settings.showRomaji; updateUI(); saveSettings(); };
        document.getElementById('btn-toggle-vi').onclick = () => { settings.showVietnamese = !settings.showVietnamese; updateUI(); saveSettings(); };

        document.addEventListener('DOMContentLoaded', () => {
            initSpeech(); loadSettings();
            renderConversation(); renderReading(); renderGrammar(); renderVocab(); renderQuiz();
            updateUI(); updateProgress();
            setTimeout(loadVoices, 100);
        });
    </script>
</body>
</html>
