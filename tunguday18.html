<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AzaKanji Tango - Ngày 18: Truyền đạt & Trạng thái</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Nunito', 'Inter', sans-serif; background-color: #f3f4f6; height: 100dvh; overflow: hidden; }
        .ja-text { font-family: 'Noto Sans JP', sans-serif; }
        .scroller { -webkit-overflow-scrolling: touch; overflow-y: auto; }
        .scroller::-webkit-scrollbar { width: 5px; height: 5px; }
        .scroller::-webkit-scrollbar-track { background: transparent; }
        .scroller::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        
        .vocab-item { transition: all 0.2s; }
        .vocab-item.active { background-color: #eef2ff; border-left: 4px solid #4f46e5; color: #4338ca; padding-left: 0.75rem; }
        
        .shadow-card { transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.2s; }
        .shadow-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border-top: 1px solid rgba(255, 255, 255, 0.3); }
        
        .tab-btn.active { background-color: white; color: #312e81; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); }
        .tab-btn { color: #a5b4fc; }
        
        /* Animation Classes */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .wrong-anim { animation: shake 0.3s ease-in-out; }
        
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .correct-anim { animation: pop 0.3s ease-in-out; }

        /* Stroke Order Styles */
        .stroke-grid-box { border: 1px solid #e5e7eb; background-color: white; position: relative; }
        .stroke-grid-box::after { content: ''; position: absolute; top: 0; left: 50%; width: 1px; height: 100%; background: repeating-linear-gradient(to bottom, #ddd 0, #ddd 4px, transparent 4px, transparent 8px); pointer-events: none; }
        .stroke-grid-box::before { content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 1px; background: repeating-linear-gradient(to right, #ddd 0, #ddd 4px, transparent 4px, transparent 8px); pointer-events: none; }
        
        /* Hide stroke paths initially */
        #strokeAnimContainer svg path { opacity: 0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="flex flex-col text-slate-800">

    <!-- HEADER -->
    <header class="bg-indigo-700 text-white shadow-lg flex-none z-40 relative">
        <div class="container mx-auto px-4 py-2 md:py-3">
            <div class="flex flex-col md:flex-row justify-between items-center gap-3">
                <div class="flex items-center gap-3 cursor-pointer select-none w-full md:w-auto justify-between" onclick="location.reload()">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-torii-gate text-3xl text-white"></i>
                        <div>
                            <h1 class="text-lg md:text-xl font-bold uppercase tracking-wider">AzaKanji Tango</h1>
                            <p class="text-[10px] md:text-xs text-indigo-200">Ngày 18: Truyền đạt & Trạng thái</p>
                        </div>
                    </div>
                    <div class="md:hidden text-xs font-semibold bg-indigo-800 px-3 py-1 rounded-full border border-indigo-500/50"><span id="headerProgress">1/87</span></div>
                </div>
                <div class="flex items-center gap-3 w-full md:w-auto">
                    <div class="flex bg-indigo-900/50 rounded-lg p-1 w-full md:w-auto overflow-x-auto no-scrollbar">
                        <button onclick="switchTab('learn')" id="tab-learn" class="tab-btn active flex-1 md:flex-none px-4 py-1.5 rounded-md text-sm font-bold transition flex items-center justify-center gap-2 whitespace-nowrap"><i class="fas fa-book-open"></i> Học Từ</button>
                        <button onclick="switchTab('quiz')" id="tab-quiz" class="tab-btn flex-1 md:flex-none px-4 py-1.5 rounded-md text-sm font-bold transition flex items-center justify-center gap-2 whitespace-nowrap"><i class="fas fa-keyboard"></i> Kiểm Tra</button>
                        <div class="w-px bg-indigo-600 mx-1"></div>
                        <button onclick="openGrammarList()" class="tab-btn flex-1 md:flex-none px-4 py-1.5 rounded-md text-sm font-bold transition flex items-center justify-center gap-2 whitespace-nowrap"><i class="fas fa-scroll"></i> Cẩm Nang</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative w-full">
        <!-- DESKTOP SIDEBAR -->
        <aside class="hidden md:flex w-72 bg-white border-r border-gray-200 flex-col z-10">
            <div class="p-4 border-b border-gray-100 bg-gray-50">
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i>
                    <input type="text" id="searchInput" placeholder="Tìm kiếm từ..." class="w-full pl-9 pr-4 py-2 bg-white border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 transition-all shadow-sm outline-none">
                </div>
            </div>
            <div id="vocabList" class="flex-1 scroller p-2 space-y-1"></div>
        </aside>

        <!-- MAIN CONTENT (LEARN MODE) -->
        <main id="learn-section" class="flex-1 overflow-y-auto scroller bg-slate-50 p-4 pb-28 w-full scroll-smooth">
            <div class="max-w-3xl mx-auto flex flex-col items-center animate-fade-in">
                <!-- Flashcard -->
                <div class="w-full bg-white rounded-2xl p-6 shadow-sm border border-gray-200 mb-6 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-indigo-50 to-pink-50 rounded-bl-full -mr-8 -mt-8 z-0 opacity-60 transition-transform group-hover:scale-110 duration-700"></div>
                    <div class="relative z-10 text-center">
                        <div class="inline-flex items-center gap-2 bg-gray-50 px-3 py-1 rounded-full mb-4 border border-gray-100">
                            <span id="wordType" class="text-[10px] font-bold uppercase text-indigo-500">WORD</span>
                            <div class="w-px h-3 bg-gray-300"></div>
                            <span class="text-[10px] text-gray-400 font-mono" id="wordIndex">#1</span>
                        </div>
                        <div class="relative inline-block mb-2">
                            <h2 id="cardKanji" class="text-5xl md:text-6xl font-bold text-gray-800 ja-text tracking-tight cursor-pointer hover:text-indigo-700 transition-colors" onclick="speakCurrent()">凄い</h2>
                            <button id="strokeBtn" onclick="openStrokeModal()" class="absolute -right-10 top-2 w-8 h-8 bg-pink-100 text-pink-600 rounded-full flex items-center justify-center shadow-sm hover:bg-pink-200 hover:scale-110 transition-all hidden" title="Tập viết">
                                <i class="fas fa-pen-nib text-sm"></i>
                            </button>
                        </div>
                        <div class="flex flex-col items-center gap-1 cursor-pointer" onclick="speakCurrent()">
                            <span id="cardFurigana" class="text-xl text-indigo-600 font-medium ja-text">すごい</span>
                            <span id="cardMeaning" class="text-lg text-gray-500 font-medium">Giỏi, xuất sắc</span>
                        </div>
                    </div>
                </div>

                <!-- Shadowing Sentences -->
                <div class="w-full">
                    <div class="flex items-center gap-2 mb-4 px-1">
                        <div class="bg-pink-100 text-pink-600 p-1.5 rounded-lg text-sm"><i class="fas fa-comments"></i></div>
                        <h3 class="font-bold text-gray-700 text-lg">Hội thoại đời sống</h3>
                    </div>
                    <div id="sentenceList" class="space-y-4"></div>
                    
                    <!-- Empty State -->
                    <div id="emptyState" class="hidden flex-col items-center justify-center p-8 text-center bg-white rounded-2xl border border-dashed border-gray-300 text-gray-400">
                        <i class="fas fa-comment-dots text-4xl mb-2 text-gray-300"></i>
                        <p class="text-sm">Chưa có hội thoại mẫu cho từ này.</p>
                        <p class="text-xs text-gray-300 mt-1">(Dữ liệu đang cập nhật)</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- QUIZ MODE -->
        <div id="quiz-section" class="hidden flex-1 w-full overflow-y-auto scroller bg-slate-100 p-4 absolute inset-0 z-20">
            <div class="max-w-2xl mx-auto mt-4 md:mt-10 animate-fade-in">
                <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-200">
                    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-6 text-white flex justify-between items-center relative overflow-hidden">
                        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                        <div class="relative z-10">
                            <h2 class="text-2xl font-bold flex items-center gap-2"><i class="fas fa-graduation-cap"></i> Thử Thách</h2>
                            <p class="text-indigo-100 text-sm">Nhìn Kanji - Đoán Hiragana</p>
                        </div>
                        <div class="text-right relative z-10 bg-white/10 p-2 rounded-lg backdrop-blur-sm">
                            <div class="text-[10px] text-indigo-100 uppercase font-bold tracking-wider">Điểm số</div>
                            <div class="text-3xl font-bold font-mono" id="score-display">0</div>
                        </div>
                    </div>
                    
                    <div class="p-6 md:p-10 text-center">
                        <div class="mb-8 relative">
                            <div class="text-xs text-gray-400 mb-2 uppercase font-bold tracking-widest">Từ này đọc là gì?</div>
                            <div id="quiz-kanji" class="text-6xl ja-text font-bold text-gray-800 mb-4 transition-all inline-block"></div>
                            <div id="quiz-meaning" class="text-lg text-indigo-600 font-bold mb-2"></div>
                        </div>
                        
                        <div class="relative max-w-md mx-auto mb-8">
                            <input type="text" id="quiz-input" class="w-full text-center text-2xl p-4 border-2 border-gray-300 rounded-xl focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 outline-none transition-all ja-text placeholder:text-gray-300" placeholder="nhập hiragana..." autocomplete="off">
                        </div>
                        
                        <div id="feedback-area" class="hidden rounded-xl p-5 bg-gray-50 border border-gray-200 text-left mb-6 animate-fade-in shadow-inner">
                            <div id="feedback-title" class="font-bold text-lg mb-2 flex items-center"></div>
                            <div class="text-gray-700 mb-3 flex items-center flex-wrap gap-2">
                                Đáp án đúng: <span id="correct-answer" class="font-bold text-xl text-indigo-600 px-3 py-1 bg-white border border-indigo-100 rounded-lg ja-text shadow-sm"></span>
                                <button onclick="playQuizAudio()" class="text-gray-400 hover:text-indigo-600 transition-colors w-8 h-8 rounded-full flex items-center justify-center hover:bg-gray-200 border border-transparent hover:border-gray-300"><i class="fas fa-volume-up"></i></button>
                            </div>
                        </div>
                        
                        <div>
                            <button id="btn-check" onclick="checkAnswer()" class="w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 px-10 rounded-xl shadow-lg transition active:scale-95 text-lg flex items-center justify-center gap-2 mx-auto">
                                <i class="fas fa-check"></i> Kiểm Tra
                            </button>
                            <button id="btn-next" onclick="nextQuestion()" class="hidden w-full md:w-auto bg-gray-800 hover:bg-gray-900 text-white font-bold py-3.5 px-10 rounded-xl shadow-lg transition active:scale-95 text-lg flex items-center justify-center gap-2 mx-auto">
                                Câu Tiếp Theo <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MOBILE BOTTOM BAR -->
        <div class="fixed bottom-0 left-0 right-0 glass px-4 py-3 pb-6 z-30 flex items-center justify-between gap-4 md:hidden shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] border-t border-gray-200">
            <button onclick="prevWord()" class="w-12 h-12 rounded-xl bg-white border border-gray-200 text-gray-600 flex items-center justify-center shadow-sm active:bg-gray-50 active:scale-95 transition">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button onclick="toggleDrawer()" class="flex-1 h-12 rounded-xl bg-indigo-600 text-white font-bold flex items-center justify-center shadow-lg gap-2 active:scale-95 transition active:bg-indigo-700">
                <i class="fas fa-list-ul"></i> Danh Sách
            </button>
            <button onclick="nextWord()" class="w-12 h-12 rounded-xl bg-white border border-gray-200 text-gray-600 flex items-center justify-center shadow-sm active:bg-gray-50 active:scale-95 transition">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>

    <!-- MODAL: GRAMMAR LIST -->
    <div id="grammarListModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-gray-900/70 backdrop-blur-sm transition-opacity opacity-0" id="grammarListBackdrop" onclick="closeModal('grammarListModal')"></div>
        <div class="bg-white rounded-2xl w-full max-w-4xl relative z-10 shadow-2xl transform transition-all scale-95 opacity-0 flex flex-col max-h-[85vh]" id="grammarListPanel">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-indigo-50 rounded-t-2xl">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-600 text-white p-2 rounded-lg shadow-sm"><i class="fas fa-book"></i></div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-800">Cẩm Nang Ngữ Pháp</h3>
                        <p class="text-xs text-gray-500">Thư viện ngữ pháp Day 18 (N4 - N3)</p>
                    </div>
                </div>
                <button onclick="closeModal('grammarListModal')" class="w-8 h-8 rounded-full hover:bg-white flex items-center justify-center text-gray-500 transition-colors"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto scroller bg-slate-50">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="grammarGrid"></div>
            </div>
            <div class="p-4 border-t border-gray-100 bg-white rounded-b-2xl flex justify-end">
                <button onclick="closeModal('grammarListModal')" class="px-6 py-2 bg-gray-800 text-white font-bold rounded-full text-sm transition active:scale-95 shadow-lg hover:bg-gray-700">Đã Hiểu</button>
            </div>
        </div>
    </div>

    <!-- MODAL: GRAMMAR DETAIL -->
    <div id="detailGrammarModal" class="fixed inset-0 z-[90] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity opacity-0" id="detailGrammarBackdrop" onclick="closeModal('detailGrammarModal')"></div>
        <div class="bg-white rounded-2xl w-full max-w-md relative z-10 shadow-2xl transform transition-all scale-95 opacity-0 flex flex-col" id="detailGrammarPanel">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 rounded-t-2xl">
                <div class="flex items-center gap-2">
                    <div class="bg-indigo-100 p-1.5 rounded-lg text-indigo-600"><i class="fas fa-info-circle"></i></div>
                    <h3 class="text-lg font-bold text-gray-800">Giải thích Ngữ pháp</h3>
                </div>
                <button onclick="closeModal('detailGrammarModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6">
                <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-3 text-center mb-4 shadow-sm">
                    <code class="text-lg font-bold text-indigo-700 font-mono" id="dgFormula"></code>
                </div>
                <div id="dgExplanation" class="text-gray-600 text-sm mb-4 space-y-3 leading-relaxed"></div>
            </div>
        </div>
    </div>

    <!-- MODAL: KANJI STROKE -->
    <div id="strokeModal" class="fixed inset-0 z-[80] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-gray-900/80 backdrop-blur-sm transition-opacity opacity-0" id="strokeBackdrop" onclick="closeModal('strokeModal')"></div>
        <div class="bg-white rounded-2xl w-full max-w-5xl relative z-10 shadow-2xl transform transition-all scale-95 opacity-0 flex flex-col max-h-[90vh]" id="strokePanel">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-pink-50 rounded-t-2xl">
                <h3 class="text-lg font-bold text-pink-700 flex items-center gap-2"><i class="fas fa-pen-nib"></i> Tập Viết & Chi Tiết Kanji</h3>
                <button onclick="closeModal('strokeModal')" class="w-8 h-8 rounded-full hover:bg-white flex items-center justify-center text-gray-500 transition-colors"><i class="fas fa-times text-lg"></i></button>
            </div>
            <div class="p-6 overflow-y-auto scroller bg-slate-50 flex-1">
                <div id="strokeTabs" class="flex justify-center gap-2 mb-6 flex-wrap"></div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="flex flex-col gap-6 text-center">
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 relative">
                            <p class="text-xs text-gray-400 mb-2 font-bold uppercase tracking-wider">Mô phỏng nét viết</p>
                            <div id="strokeAnimContainer" class="w-48 h-48 mx-auto bg-white border border-gray-300 relative stroke-grid-box flex items-center justify-center rounded-lg cursor-pointer" onclick="replayStrokeAnimation()"></div>
                            <button onclick="replayStrokeAnimation()" class="absolute top-4 right-4 bg-pink-50 text-pink-600 w-8 h-8 rounded-full flex items-center justify-center hover:bg-pink-100 transition shadow-sm z-10"><i class="fas fa-redo text-sm"></i></button>
                            <p class="text-[10px] text-gray-400 mt-2">Nhấn vào ô để chạy lại</p>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 text-left">
                            <p class="text-xs text-gray-400 mb-3 font-bold uppercase tracking-wider text-center">Thứ tự từng nét</p>
                            <div id="strokeGridContainer" class="flex flex-wrap gap-2 justify-center"></div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200 flex flex-col h-full text-left">
                        <div id="kanjiDetailContent">
                            <div class="flex items-center justify-between mb-6 border-b border-gray-100 pb-4">
                                <div><h2 id="detailKanji" class="text-6xl font-bold text-gray-800 ja-text mb-1 leading-none"></h2><div class="text-xs font-bold bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded inline-block mt-2" id="detailHanViet"></div></div>
                                <div class="text-right"><div class="text-2xl font-bold text-gray-600 capitalize" id="detailMeaning"></div></div>
                            </div>
                            <!-- Radicals -->
                            <div class="mb-4 bg-indigo-50 p-3 rounded-lg border border-indigo-100">
                                <span class="text-xs font-bold text-indigo-500 uppercase block mb-1"><i class="fas fa-layer-group mr-1"></i> Bộ thủ (Thành phần)</span>
                                <span class="text-sm font-medium text-indigo-900" id="detailRadicals">...</span>
                            </div>
                            <!-- On/Kun -->
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <div class="bg-slate-50 p-3 rounded-lg border border-slate-100 flex justify-between items-center group cursor-pointer" onclick="document.getElementById('btnPlayOn').click()"><div class="flex flex-col"><span class="text-xs font-bold text-gray-400 uppercase">On</span><span class="text-lg font-bold text-indigo-600 ja-text" id="detailOn"></span></div><button id="btnPlayOn" class="text-indigo-300 group-hover:text-indigo-600"><i class="fas fa-volume-up"></i></button></div>
                                <div class="bg-slate-50 p-3 rounded-lg border border-slate-100 flex justify-between items-center group cursor-pointer" onclick="document.getElementById('btnPlayKun').click()"><div class="flex flex-col"><span class="text-xs font-bold text-gray-400 uppercase">Kun</span><span class="text-lg font-bold text-pink-600 ja-text" id="detailKun"></span></div><button id="btnPlayKun" class="text-pink-300 group-hover:text-pink-600"><i class="fas fa-volume-up"></i></button></div>
                            </div>
                            <!-- Tips -->
                            <div class="space-y-4 mb-6">
                                <div class="bg-green-50 p-4 rounded-lg border border-green-100">
                                    <h4 class="text-sm font-bold text-green-800 mb-2 flex items-center gap-2"><i class="fas fa-image"></i> Ghi nhớ hình ảnh</h4>
                                    <p class="text-sm text-green-700 leading-relaxed" id="detailTipImg"></p>
                                </div>
                                <div class="bg-orange-50 p-4 rounded-lg border border-orange-100">
                                    <h4 class="text-sm font-bold text-orange-800 mb-2 flex items-center gap-2"><i class="fas fa-music"></i> Mẹo nhớ âm thanh</h4>
                                    <p class="text-sm text-orange-700" id="detailTipSound"></p>
                                </div>
                            </div>
                            <!-- Related Words -->
                            <div>
                                <h4 class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-3">Từ vựng liên quan</h4>
                                <div class="space-y-2" id="detailWords"></div>
                            </div>
                        </div>
                        <div id="kanjiDetailEmpty" class="hidden h-full flex flex-col items-center justify-center text-center p-4 text-gray-400"><i class="fas fa-book-open text-4xl mb-3 opacity-30"></i><p class="text-sm">Chưa có dữ liệu chi tiết cho chữ Hán này.</p></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. GRAMMAR REPO (N4 - N3) ---
        const grammarRepo = {
            "sou_da_hearsay": { title: "Nghe nói là (Truyền đạt)", formula: "Thể thường + そうだ", desc: "N4: Truyền đạt lại thông tin nghe được từ người khác hoặc nguồn tin (dự báo thời tiết, tin tức...).", ex: "明日は雨が降るそうです。" },
            "no_ni": { title: "Thế mà/Vậy mà (Đối lập)", formula: "V/A/N(na) + のに", desc: "N4: Diễn tả sự ngạc nhiên, bất mãn khi kết quả trái ngược với mong đợi.", ex: "約束したのに、来ませんでした。" },
            "baai": { title: "Trong trường hợp", formula: "V/A/N + 場合", desc: "N4: Giả định tình huống xảy ra (trang trọng hơn 'tara').", ex: "火事の場合は、逃げてください。" },
            "te_kimasu": { title: "Đi rồi về", formula: "Vて + きます", desc: "N4: Đi làm một việc gì đó rồi quay lại địa điểm hiện tại.", ex: "ちょっと行ってきます。" },
            "hazu": { title: "Chắc chắn là", formula: "V/A/N + はず", desc: "N4: Phỏng đoán có căn cứ, độ tin cậy cao.", ex: "彼は来るはずです。" },
            "bakari": { title: "Vừa mới", formula: "Vた + ばかり", desc: "N4: Diễn tả hành động vừa mới kết thúc theo cảm giác của người nói.", ex: "食べたばかりです。" },
            "tokoro": { title: "Đúng lúc", formula: "Vる/ていろ/た + ところ", desc: "N4: Nhấn mạnh thời điểm của hành động (sắp sửa, đang, vừa mới xong).", ex: "今から食べるところです。" },
            "te_iru": { title: "Đang/Trạng thái", formula: "Vている", desc: "N5/N4: Hành động đang diễn ra hoặc trạng thái.", ex: "雨が降っています。" },
            "te_kudasai": { title: "Hãy...", formula: "Vてください", desc: "N5: Yêu cầu lịch sự.", ex: "書いてください。" },
            "mashou": { title: "Cùng làm nhé", formula: "Vましょう", desc: "N5: Rủ rê.", ex: "行きましょう。" },
            "volitional": { title: "Thể ý định", formula: "Vよう", desc: "N4: Rủ rê thân mật.", ex: "行こう！" },
            "ta_form": { title: "Thể quá khứ ngắn", formula: "Vた", desc: "N5: Dùng trong văn nói thân mật.", ex: "食べた？" },
            "wa_desu": { title: "Cấu trúc định danh", formula: "N1 は N2 です", desc: "N5: Khẳng định.", ex: "これはペンです。" },
            "sou_da_visual": { title: "Trông có vẻ", formula: "Adj(bỏ i/na) + そう", desc: "N4: Phỏng đoán qua thị giác.", ex: "おいしそうです。" },
            "tame_ni": { title: "Để (Mục đích)", formula: "Vる/Nの + ために", desc: "N4: Mục đích.", ex: "健康のために走ります。" },
            "te_mo_ii": { title: "Làm...được không", formula: "Vてもいい", desc: "N5/N4: Xin phép.", ex: "入ってもいいですか。" },
            "koto_ga_aru": { title: "Đã từng", formula: "Vた + ことがある", desc: "N4: Kinh nghiệm.", ex: "見たことがあります。" },
            "ndesu": { title: "Giải thích", formula: "V/Adj + んです", desc: "N4: Giải thích lý do.", ex: "頭が痛いんです。" },
            "na_adj": { title: "Tính từ đuôi Na", formula: "Adj + な", desc: "N5: Bổ nghĩa cho danh từ.", ex: "静かな町。" }
        };

        // --- 2. VOCABULARY DATA (Day 18) ---
        const vocabData = [
            { "STT": 1, "Kanji": "凄い", "Nghĩa": "Giỏi, xuất sắc", "Furigana": "すごい", "type": "adj_i", "conv": { "polite": "彼はすごい人だそうです。", "pVi": "Nghe nói anh ấy là một người tuyệt vời.", "casual": "彼、すごい人だそうだ。", "cVi": "Nghe bảo ổng đỉnh lắm.", "gIds": ["sou_da_hearsay"] } },
            { "STT": 2, "Kanji": "酷い", "Nghĩa": "Kinh khủng", "Furigana": "ひどい", "type": "adj_i", "conv": { "polite": "酷い天気なのに、出かけますか。", "pVi": "Thời tiết kinh khủng vậy mà bạn vẫn ra ngoài à?", "casual": "酷い天気なのに、出かけるの？", "cVi": "Trời xấu thế mà vẫn đi à?", "gIds": ["no_ni"] } },
            { "STT": 3, "Kanji": "激しい", "Nghĩa": "Mãnh liệt", "Furigana": "はげしい", "type": "adj_i", "conv": { "polite": "激しい雨の場合、試合は中止です。", "pVi": "Trong trường hợp mưa lớn, trận đấu sẽ bị hủy.", "casual": "激しい雨の場合、試合は中止だ。", "cVi": "Mưa to là hủy trận đấy.", "gIds": ["baai"] } },
            { "STT": 4, "Kanji": "", "Nghĩa": "Giống hệt", "Furigana": "そっくり(な)", "type": "adj_na", "conv": { "polite": "彼は父親にそっくりだそうです。", "pVi": "Nghe nói anh ấy giống hệt bố.", "casual": "彼、父親にそっくりだそうだ。", "cVi": "Nghe bảo hắn giống hệt bố.", "gIds": ["sou_da_hearsay"] } },
            { "STT": 5, "Kanji": "急(な)", "Nghĩa": "Gấp", "Furigana": "きゅう(な)", "type": "adj_na", "conv": { "polite": "急な用事があるので、帰ってきます。", "pVi": "Vì có việc gấp nên tôi sẽ về (rồi quay lại).", "casual": "急な用事あるんで、帰ってくる。", "cVi": "Có việc gấp nên tớ chạy về cái.", "gIds": ["te_kimasu", "ndesu"] } },
            { "STT": 6, "Kanji": "適当(な)", "Nghĩa": "Thích hợp", "Furigana": "てきとう(な)", "type": "adj_na", "conv": { "polite": "適当な服を選んだばかりです。", "pVi": "Tôi vừa mới chọn được bộ quần áo phù hợp.", "casual": "適当な服選んだばっかだ。", "cVi": "Vừa chọn được bộ đồ hợp xong.", "gIds": ["bakari"] } },
            { "STT": 7, "Kanji": "特別(な)", "Nghĩa": "Đặc biệt", "Furigana": "とくべつ(な)", "type": "adj_na", "conv": { "polite": "今日は特別な日だそうです。", "pVi": "Nghe nói hôm nay là một ngày đặc biệt.", "casual": "今日、特別な日だそうだ。", "cVi": "Nghe bảo nay ngày đặc biệt.", "gIds": ["sou_da_hearsay"] } },
            { "STT": 8, "Kanji": "完全(な)", "Nghĩa": "Hoàn toàn", "Furigana": "かんぜん(な)", "type": "adj_na", "conv": { "polite": "この計画は完全だそうです。", "pVi": "Nghe nói kế hoạch này hoàn hảo.", "casual": "この計画、完全だそうだ。", "cVi": "Nghe bảo kế hoạch này hoàn hảo.", "gIds": ["sou_da_hearsay"] } },
            { "STT": 9, "Kanji": "盛ん(な)", "Nghĩa": "Thịnh vượng", "Furigana": "さかん(な)", "type": "adj_na", "conv": { "polite": "この町は昔は盛んだったそうです。", "pVi": "Nghe nói thị trấn này ngày xưa rất thịnh vượng.", "casual": "この町、昔は盛んだったそうだ。", "cVi": "Nghe bảo thị trấn này xưa giàu lắm.", "gIds": ["sou_da_hearsay"] } },
            { "STT": 10, "Kanji": "様々(な)", "Nghĩa": "Nhiều loại", "Furigana": "さまざま(な)", "type": "adj_na", "conv": { "polite": "様々な種類の花が咲いているそうです。", "pVi": "Nghe nói có nhiều loại hoa đang nở.", "casual": "様々な種類の花が咲いてるそうだ。", "cVi": "Nghe bảo nhiều loại hoa nở lắm.", "gIds": ["sou_da_hearsay"] } },
            { "STT": 11, "Kanji": "可能(な)", "Nghĩa": "Khả thi", "Furigana": "かのう(な)", "type": "adj_na", "conv": { "polite": "それは可能なはずです。", "pVi": "Điều đó chắc chắn là có thể.", "casual": "それ、可能なはずだ。", "cVi": "Cái đó chắc chắn làm được.", "gIds": ["hazu"] } },
            { "STT": 12, "Kanji": "不可能(な)", "Nghĩa": "Không khả thi", "Furigana": "ふかのう(な)", "type": "adj_na", "conv": { "polite": "それは不可能なはずです。", "pVi": "Điều đó chắc chắn là không thể.", "casual": "それ、不可能なはずだ。", "cVi": "Cái đó chắc chắn không được đâu.", "gIds": ["hazu"] } },
            { "STT": 13, "Kanji": "基本的(な)", "Nghĩa": "Cơ bản", "Furigana": "きほんてき(な)", "type": "adj_na", "conv": { "polite": "基本的な文法はもう習ったはずです。", "pVi": "Ngữ pháp cơ bản chắc chắn đã học rồi.", "casual": "基本的な文法、もう習ったはずだ。", "cVi": "Ngữ pháp cơ bản chắc học rồi chứ.", "gIds": ["hazu"] } },
            { "STT": 14, "Kanji": "国際的(な)", "Nghĩa": "Quốc tế", "Furigana": "こくさいてき(な)", "type": "adj_na", "conv": { "polite": "彼は国際的な仕事をしているそうです。", "pVi": "Nghe nói anh ấy đang làm công việc quốc tế.", "casual": "彼、国際的な仕事してるそうだ。", "cVi": "Nghe bảo hắn làm việc quốc tế.", "gIds": ["sou_da_hearsay"] } },
            { "STT": 15, "Kanji": "", "Nghĩa": "Bừa bộn", "Furigana": "ばらばら(な)", "type": "adj_na", "conv": { "polite": "部屋がばらばらなのに、掃除しませんか。", "pVi": "Phòng bừa bộn vậy mà không dọn dẹp à?", "casual": "部屋ばらばらなのに、掃除しない？", "cVi": "Phòng bừa thế mà không dọn à?", "gIds": ["no_ni"] } },
            { "STT": 16, "Kanji": "", "Nghĩa": "Rách nát", "Furigana": "ぼろぼろ(な)", "type": "adj_na", "conv": { "polite": "ぼろぼろの服を着て、出かけますか。", "pVi": "Bạn mặc quần áo rách nát rồi ra ngoài à?", "casual": "ぼろぼろの服着て出かける？", "cVi": "Mặc đồ rách thế mà cũng đi à?", "gIds": [] } },
            { "STT": 17, "Kanji": "読書", "Nghĩa": "Đọc sách", "Furigana": "どくしょ", "type": "noun", "conv": { "polite": "読書は楽しいはずです。", "pVi": "Đọc sách chắc chắn là vui.", "casual": "読書、楽しいはずだ。", "cVi": "Đọc sách chắc vui mà.", "gIds": ["hazu"] } },
            { "STT": 18, "Kanji": "演奏", "Nghĩa": "Biểu diễn", "Furigana": "えんそう", "type": "noun", "conv": { "polite": "彼の演奏は素晴らしいそうです。", "pVi": "Nghe nói màn trình diễn của anh ấy rất tuyệt vời.", "casual": "彼の演奏、素晴らしいそうだ。", "cVi": "Nghe bảo hắn diễn hay lắm.", "gIds": ["sou_da_hearsay"] } },
            { "STT": 19, "Kanji": "芸術", "Nghĩa": "Nghệ thuật", "Furigana": "げいじゅつ", "type": "noun", "conv": { "polite": "芸術を学ぶのは難しいです。", "pVi": "Việc học nghệ thuật rất khó.", "casual": "芸術学ぶの難しい。", "cVi": "Học nghệ thuật khó phết.", "gIds": [] } },
            { "STT": 20, "Kanji": "検査する", "Nghĩa": "Kiểm tra", "Furigana": "けんさする", "type": "verb", "conv": { "polite": "健康診断はもう終わったはずです。", "pVi": "Khám sức khỏe chắc chắn đã xong rồi.", "casual": "健康診断、もう終わったはずだ。", "cVi": "Khám sức khỏe chắc xong rồi.", "gIds": ["hazu"] } },
            { "STT": 21, "Kanji": "胃", "Nghĩa": "Dạ dày", "Furigana": "い", "type": "noun", "conv": { "polite": "胃が痛いのに、ご飯を食べますか。", "pVi": "Dạ dày đau vậy mà bạn vẫn ăn cơm à?", "casual": "胃が痛いのに、ご飯食べる？", "cVi": "Đau dạ dày mà vẫn ăn à?", "gIds": ["no_ni"] } },
            { "STT": 22, "Kanji": "血液", "Nghĩa": "Máu", "Furigana": "けつえき", "type": "noun", "conv": { "polite": "血液型は何ですか。", "pVi": "Nhóm máu của bạn là gì?", "casual": "血液型は何？", "cVi": "Nhóm máu gì thế?", "gIds": ["wa_desu"] } },
            { "STT": 23, "Kanji": "治療する", "Nghĩa": "Trị liệu", "Furigana": "ちりょうする", "type": "verb", "conv": { "polite": "病気を治療するために、病院へ行ってきます。", "pVi": "Để điều trị bệnh, tôi sẽ đi bệnh viện rồi về.", "casual": "病気治療するため、病院行ってくる。", "cVi": "Đi viện chữa bệnh cái đã.", "gIds": ["tame_ni", "te_kimasu"] } },
            { "STT": 24, "Kanji": "症状", "Nghĩa": "Triệu chứng", "Furigana": "しょうじょう", "type": "noun", "conv": { "polite": "どんな症状が出ましたか。", "pVi": "Bạn đã có triệu chứng gì?", "casual": "どんな症状出た？", "cVi": "Có triệu chứng gì không?", "gIds": ["ta_form"] } },
            { "STT": 25, "Kanji": "鼻水", "Nghĩa": "Nước mũi", "Furigana": "はなみず", "type": "noun", "conv": { "polite": "鼻水が出ているのに、学校へ行きますか。", "pVi": "Chảy nước mũi vậy mà bạn vẫn đi học à?", "casual": "鼻水出てるのに、学校行く？", "cVi": "Sổ mũi mà vẫn đi học à?", "gIds": ["no_ni"] } },
            { "STT": 26, "Kanji": "予防する", "Nghĩa": "Dự phòng", "Furigana": "よぼうする", "type": "verb", "conv": { "polite": "風邪を予防するために、マスクをします。", "pVi": "Để phòng cúm, tôi sẽ đeo khẩu trang.", "casual": "風邪予防するため、マスクする。", "cVi": "Đeo khẩu trang phòng cúm.", "gIds": ["tame_ni"] } },
            { "STT": 27, "Kanji": "栄養", "Nghĩa": "Dinh dưỡng", "Furigana": "えいよう", "type": "noun", "conv": { "polite": "栄養があるものを食べたばかりです。", "pVi": "Tôi vừa mới ăn đồ bổ dưỡng.", "casual": "栄養あるもの食べたばっかだ。", "cVi": "Vừa ăn đồ bổ xong.", "gIds": ["bakari"] } },
            { "STT": 28, "Kanji": "手術", "Nghĩa": "Phẫu thuật", "Furigana": "しゅじゅつ", "type": "noun", "conv": { "polite": "手術はもう終わったはずです。", "pVi": "Ca phẫu thuật chắc chắn đã xong rồi.", "casual": "手術、もう終わったはずだ。", "cVi": "Mổ chắc xong rồi.", "gIds": ["hazu"] } },
            { "STT": 29, "Kanji": "死亡する", "Nghĩa": "Tử vong", "Furigana": "しぼうする", "type": "verb", "conv": { "polite": "事故で死亡したそうです。", "pVi": "Nghe nói anh ấy đã tử vong do tai nạn.", "casual": "事故で死亡したそうだ。", "cVi": "Nghe bảo mất vì tai nạn.", "gIds": ["sou_da_hearsay"] } },
            { "STT": 30, "Kanji": "命", "Nghĩa": "Sinh mệnh", "Furigana": "いのち", "type": "noun", "conv": { "polite": "命は大切だそうです。", "pVi": "Nghe nói cuộc sống rất quý giá.", "casual": "命は大切だそうだ。", "cVi": "Mạng sống quan trọng lắm đấy.", "gIds": ["sou_da_hearsay"] } },
            { "STT": 31, "Kanji": "一生", "Nghĩa": "Một đời", "Furigana": "いっしょう", "type": "noun", "conv": { "polite": "一生懸命勉強したばかりです。", "pVi": "Tôi vừa mới học chăm chỉ.", "casual": "一生懸命勉強したばっかだ。", "cVi": "Vừa mới học hộc mặt ra.", "gIds": ["bakari"] } },
            { "STT": 32, "Kanji": "誤解する", "Nghĩa": "Hiểu lầm", "Furigana": "ごかいする", "type": "verb", "conv": { "polite": "誤解したばかりです。", "pVi": "Tôi vừa mới hiểu nhầm.", "casual": "誤解したばっかだ。", "cVi": "Vừa hiểu nhầm xong.", "gIds": ["bakari"] } },
            { "STT": 33, "Kanji": "後悔", "Nghĩa": "Hối hận", "Furigana": "こうかい", "type": "noun", "conv": { "polite": "後悔したくないのに、失敗してしまいました。", "pVi": "Tôi không muốn hối hận vậy mà lại thất bại mất rồi.", "casual": "後悔したくないのに、失敗しちゃった。", "cVi": "Không muốn hối hận mà lại fail rồi.", "gIds": ["no_ni"] } },
            { "STT": 34, "Kanji": "訳", "Nghĩa": "Lý do", "Furigana": "わけ", "type": "noun", "conv": { "polite": "どうして休むのか、訳を教えてください。", "pVi": "Vui lòng cho tôi biết lý do tại sao bạn nghỉ.", "casual": "なんで休むのか、訳教えて。", "cVi": "Sao nghỉ thế, nói lý do xem nào.", "gIds": ["te_kudasai"] } },
            { "STT": 35, "Kanji": "態度", "Nghĩa": "Thái độ", "Furigana": "たいど", "type": "noun", "conv": { "polite": "彼の態度は悪いそうです。", "pVi": "Nghe nói thái độ của anh ấy tệ.", "casual": "彼の態度、悪いそうだ。", "cVi": "Nghe bảo thái độ lồi lõm lắm.", "gIds": ["sou_da_hearsay"] } },
            { "STT": 36, "Kanji": "癖", "Nghĩa": "Tật xấu", "Furigana": "くせ", "type": "noun", "conv": { "polite": "彼は変な癖があるそうです。", "pVi": "Nghe nói anh ấy có tật xấu lạ.", "casual": "彼、変な癖あるそうだ。", "cVi": "Nghe bảo hắn có tật lạ lắm.", "gIds": ["sou_da_hearsay"] } },
            { "STT": 37, "Kanji": "礼儀", "Nghĩa": "Lễ nghi", "Furigana": "れいぎ", "type": "noun", "conv": { "polite": "日本の礼儀は難しいです。", "pVi": "Lễ nghi Nhật Bản khó.", "casual": "日本の礼儀、難しい。", "cVi": "Lễ nghi Nhật khó thật.", "gIds": ["wa_desu"] } },
            { "STT": 38, "Kanji": "文句", "Nghĩa": "Phàn nàn", "Furigana": "もんく", "type": "noun", "conv": { "polite": "文句を言ったばかりです。", "pVi": "Tôi vừa mới than phiền.", "casual": "文句言ったばっかだ。", "cVi": "Vừa ca cẩm xong.", "gIds": ["bakari"] } },
            { "STT": 39, "Kanji": "表情", "Nghĩa": "Biểu cảm", "Furigana": "ひょうじょう", "type": "noun", "conv": { "polite": "彼女の表情は悲しそうです。", "pVi": "Biểu cảm của cô ấy trông có vẻ buồn.", "casual": "彼女の表情、悲しそう。", "cVi": "Mặt cổ trông buồn thế.", "gIds": ["sou_da_visual"] } },
            { "STT": 40, "Kanji": "表面", "Nghĩa": "Bề mặt", "Furigana": "ひょうめん", "type": "noun", "conv": { "polite": "表面は綺麗ですが、中は汚いそうです。", "pVi": "Bề ngoài thì sạch nhưng nghe nói bên trong bẩn.", "casual": "表面綺麗だけど、中汚いそうだ。", "cVi": "Ngoài đẹp mà nghe bảo trong bẩn lắm.", "gIds": ["sou_da_hearsay"] } },
            { "STT": 41, "Kanji": "禁煙する", "Nghĩa": "Cấm hút thuốc", "Furigana": "きんえんする", "type": "verb", "conv": { "polite": "ここは禁煙のはずです。", "pVi": "Chắc chắn ở đây cấm hút thuốc.", "casual": "ここ、禁煙のはずだ。", "cVi": "Chỗ này chắc chắn cấm hút thuốc.", "gIds": ["hazu"] } },
            { "STT": 42, "Kanji": "禁止する", "Nghĩa": "Cấm", "Furigana": "きんしする", "type": "verb", "conv": { "polite": "ここは駐車禁止のはずです。", "pVi": "Chắc chắn ở đây cấm đỗ xe.", "casual": "ここ、駐車禁止のはずだ。", "cVi": "Chỗ này cấm đỗ xe mà.", "gIds": ["hazu"] } },
            { "STT": 43, "Kanji": "完成する", "Nghĩa": "Hoàn thành", "Furigana": "かんせいする", "type": "verb", "conv": { "polite": "レポートはもう完成したはずです。", "pVi": "Báo cáo chắc chắn đã hoàn thành rồi.", "casual": "レポート、もう完成したはずだ。", "cVi": "Báo cáo chắc xong rồi.", "gIds": ["hazu"] } },
            { "STT": 44, "Kanji": "課題", "Nghĩa": "Bài tập/Chủ đề", "Furigana": "かだい", "type": "noun", "conv": { "polite": "難しい課題が出たばかりです。", "pVi": "Vừa mới có một chủ đề khó.", "casual": "難しい課題出たばっかだ。", "cVi": "Vừa ra bài khó xong.", "gIds": ["bakari"] } },
            { "STT": 45, "Kanji": "例外", "Nghĩa": "Ngoại lệ", "Furigana": "れいがい", "type": "noun", "conv": { "polite": "それは例外だそうです。", "pVi": "Nghe nói đó là ngoại lệ.", "casual": "それ、例外だそうだ。", "cVi": "Nghe bảo cái đó ngoại lệ.", "gIds": ["sou_da_hearsay"] } },
            { "STT": 46, "Kanji": "基本", "Nghĩa": "Cơ bản", "Furigana": "きほん", "type": "noun", "conv": { "polite": "基本を学ぶのは大切です。", "pVi": "Việc học cơ bản là quan trọng.", "casual": "基本学ぶの大切だ。", "cVi": "Học cơ bản quan trọng lắm.", "gIds": [] } },
            { "STT": 47, "Kanji": "記録する", "Nghĩa": "Ghi chép", "Furigana": "きろくする", "type": "verb", "conv": { "polite": "記録したばかりです。", "pVi": "Tôi vừa mới ghi lại.", "casual": "記録したばっかだ。", "cVi": "Vừa ghi lại xong.", "gIds": ["bakari"] } },
            { "STT": 48, "Kanji": "状態", "Nghĩa": "Trạng thái", "Furigana": "じょうたい", "type": "noun", "conv": { "polite": "彼の健康状態は悪いそうです。", "pVi": "Nghe nói tình trạng sức khỏe của anh ấy tệ.", "casual": "彼の健康状態、悪いそうだ。", "cVi": "Nghe bảo sức khỏe hắn tệ lắm.", "gIds": ["sou_da_hearsay"] } },
            { "STT": 49, "Kanji": "出来事", "Nghĩa": "Sự việc", "Furigana": "できごと", "type": "noun", "conv": { "polite": "変な出来事があったばかりです。", "pVi": "Vừa mới có một việc lạ xảy ra.", "casual": "変な出来事あったばっかだ。", "cVi": "Vừa có biến xong.", "gIds": ["bakari"] } },
            { "STT": 50, "Kanji": "場面", "Nghĩa": "Bối cảnh", "Furigana": "ばめん", "type": "noun", "conv": { "polite": "どんな場面でも、落ち着いてください。", "pVi": "Dù trong bất kỳ tình huống nào, xin hãy bình tĩnh.", "casual": "どんな場面でも、落ち着いて。", "cVi": "Gặp cảnh nào cũng phải bình tĩnh.", "gIds": ["te_kudasai"] } },
            { "STT": 51, "Kanji": "機会", "Nghĩa": "Cơ hội", "Furigana": "きかい", "type": "noun", "conv": { "polite": "チャンスは来たばかりです。", "pVi": "Cơ hội vừa mới đến.", "casual": "チャンス来たばっかだ。", "cVi": "Cơ hội vừa tới xong.", "gIds": ["bakari"] } },
            { "STT": 52, "Kanji": "距離", "Nghĩa": "Khoảng cách", "Furigana": "きょり", "type": "noun", "conv": { "polite": "距離が遠いのに、歩きますか。", "pVi": "Khoảng cách xa vậy mà bạn vẫn đi bộ à?", "casual": "距離遠いのに、歩く？", "cVi": "Xa thế mà vẫn đi bộ à?", "gIds": ["no_ni"] } },
            { "STT": 53, "Kanji": "提案する", "Nghĩa": "Đề xuất", "Furigana": "ていあんする", "type": "verb", "conv": { "polite": "新しい提案をしたばかりです。", "pVi": "Tôi vừa mới đưa ra một đề xuất mới.", "casual": "新しい提案したばっかだ。", "cVi": "Vừa đề xuất cái mới xong.", "gIds": ["bakari"] } },
            { "STT": 54, "Kanji": "やり取り", "Nghĩa": "Trao đổi", "Furigana": "やりとりする", "type": "verb", "conv": { "polite": "彼女とメールのやり取りをしたばかりです。", "pVi": "Tôi vừa mới trao đổi email với cô ấy.", "casual": "彼女とメールやり取りしたばっかだ。", "cVi": "Vừa mail với cổ xong.", "gIds": ["bakari"] } },
            { "STT": 55, "Kanji": "知識", "Nghĩa": "Kiến thức", "Furigana": "ちしき", "type": "noun", "conv": { "polite": "知識は大切だそうです。", "pVi": "Nghe nói tri thức rất quan trọng.", "casual": "知識は大切だそうだ。", "cVi": "Nghe bảo kiến thức quan trọng lắm.", "gIds": ["sou_da_hearsay"] } },
            { "STT": 56, "Kanji": "実力", "Nghĩa": "Thực lực", "Furigana": "じつりょく", "type": "noun", "conv": { "polite": "彼は実力があるはずです。", "pVi": "Anh ấy chắc chắn có thực lực.", "casual": "彼、実力あるはずだ。", "cVi": "Hắn chắc chắn có thực lực.", "gIds": ["hazu"] } },
            { "STT": 57, "Kanji": "手段", "Nghĩa": "Phương pháp", "Furigana": "しゅだん", "type": "noun", "conv": { "polite": "どんな手段を使いますか。", "pVi": "Bạn dùng phương pháp nào?", "casual": "どんな手段使う？", "cVi": "Dùng cách nào?", "gIds": [] } },
            { "STT": 58, "Kanji": "代表する", "Nghĩa": "Đại diện", "Furigana": "だいひょうする", "type": "verb", "conv": { "polite": "彼は日本を代表する選手だそうです。", "pVi": "Nghe nói anh ấy là cầu thủ đại diện cho Nhật Bản.", "casual": "彼、日本代表する選手だそうだ。", "cVi": "Nghe bảo hắn đại diện cho Nhật đấy.", "gIds": ["sou_da_hearsay"] } },
            { "STT": 59, "Kanji": "影響する", "Nghĩa": "Ảnh hưởng", "Furigana": "えいきょうする", "type": "verb", "conv": { "polite": "天気は気分に影響するそうです。", "pVi": "Nghe nói thời tiết ảnh hưởng đến tâm trạng.", "casual": "天気、気分に影響するそうだ。", "cVi": "Nghe bảo thời tiết ảnh hưởng tâm trạng.", "gIds": ["sou_da_hearsay"] } },
            { "STT": 60, "Kanji": "効果", "Nghĩa": "Hiệu quả", "Furigana": "こうか", "type": "noun", "conv": { "polite": "この薬は効果があるはずです。", "pVi": "Thuốc này chắc chắn có hiệu quả.", "casual": "この薬、効果あるはずだ。", "cVi": "Thuốc này chắc chắn hiệu nghiệm.", "gIds": ["hazu"] } },
            { "STT": 61, "Kanji": "印象", "Nghĩa": "Ấn tượng", "Furigana": "いんしょう", "type": "noun", "conv": { "polite": "良い印象を与えたばかりです。", "pVi": "Tôi vừa mới tạo được ấn tượng tốt.", "casual": "良い印象与えたばっかだ。", "cVi": "Vừa ghi điểm xong.", "gIds": ["bakari"] } },
            { "STT": 62, "Kanji": "印", "Nghĩa": "Dấu hiệu", "Furigana": "しるし", "type": "noun", "conv": { "polite": "変な印があるそうです。", "pVi": "Nghe nói có dấu hiệu lạ.", "casual": "変な印あるそうだ。", "cVi": "Nghe bảo có dấu lạ.", "gIds": ["sou_da_hearsay"] } },
            { "STT": 63, "Kanji": "合図", "Nghĩa": "Ám hiệu", "Furigana": "あいず", "type": "noun", "conv": { "polite": "合図を送ったばかりです。", "pVi": "Tôi vừa mới gửi tín hiệu.", "casual": "合図送ったばっかだ。", "cVi": "Vừa ra hiệu xong.", "gIds": ["bakari"] } },
            { "STT": 64, "Kanji": "共通する", "Nghĩa": "Điểm chung", "Furigana": "きょうつうする", "type": "verb", "conv": { "polite": "彼らには共通点があるはずです。", "pVi": "Chắc chắn họ có điểm chung.", "casual": "彼ら、共通点あるはずだ。", "cVi": "Họ chắc chắn có điểm chung.", "gIds": ["hazu"] } },
            { "STT": 65, "Kanji": "強調する", "Nghĩa": "Nhấn mạnh", "Furigana": "きょうちょうする", "type": "verb", "conv": { "polite": "重要な点を強調したばかりです。", "pVi": "Tôi vừa mới nhấn mạnh điểm quan trọng.", "casual": "重要な点強調したばっかだ。", "cVi": "Vừa nhấn mạnh điểm chính xong.", "gIds": ["bakari"] } },
            { "STT": 66, "Kanji": "大事(な)", "Nghĩa": "Quan trọng", "Furigana": "だいじ(な)", "type": "adj_na", "conv": { "polite": "大事な話があるので、帰ってきます。", "pVi": "Vì có chuyện quan trọng nên tôi sẽ về.", "casual": "大事な話あるんで、帰ってくる。", "cVi": "Có chuyện quan trọng nên tớ về cái.", "gIds": ["te_kimasu"] } },
            { "STT": 67, "Kanji": "説明する", "Nghĩa": "Giải thích", "Furigana": "せつめいする", "type": "verb", "conv": { "polite": "詳しく説明したばかりです。", "pVi": "Tôi vừa mới giải thích chi tiết.", "casual": "詳しく説明したばっかだ。", "cVi": "Vừa giải thích xong.", "gIds": ["bakari"] } },
            { "STT": 68, "Kanji": "省略する", "Nghĩa": "Lược bỏ", "Furigana": "しょうりゃくする", "type": "verb", "conv": { "polite": "一部を省略したそうです。", "pVi": "Nghe nói đã lược bỏ một phần.", "casual": "一部省略したそうだ。", "cVi": "Nghe bảo bỏ bớt rồi.", "gIds": ["sou_da_hearsay"] } },
            { "STT": 69, "Kanji": "詳細", "Nghĩa": "Chi tiết", "Furigana": "しょうさい", "type": "noun", "conv": { "polite": "詳細を教えてください。", "pVi": "Vui lòng cho tôi biết chi tiết.", "casual": "詳細教えて。", "cVi": "Cho xin chi tiết đi.", "gIds": ["te_kudasai"] } },
            { "STT": 70, "Kanji": "挑戦する", "Nghĩa": "Thử thách", "Furigana": "ちょうせんする", "type": "verb", "conv": { "polite": "新しいことに挑戦したばかりです。", "pVi": "Tôi vừa mới thử thách điều mới.", "casual": "新しいこと挑戦したばっかだ。", "cVi": "Vừa thử cái mới xong.", "gIds": ["bakari"] } },
            { "STT": 71, "Kanji": "やる気", "Nghĩa": "Động lực", "Furigana": "やるき", "type": "noun", "conv": { "polite": "やる気があるはずです。", "pVi": "Chắc chắn là có hứng thú.", "casual": "やる気あるはずだ。", "cVi": "Chắc chắn là máu lắm.", "gIds": ["hazu"] } },
            { "STT": 72, "Kanji": "勇気", "Nghĩa": "Dũng khí", "Furigana": "ゆうき", "type": "noun", "conv": { "polite": "勇気を出したばかりです。", "pVi": "Tôi vừa mới lấy hết dũng khí.", "casual": "勇気出したばっかだ。", "cVi": "Vừa lấy hết can đảm xong.", "gIds": ["bakari"] } },
            { "STT": 73, "Kanji": "資格", "Nghĩa": "Bằng cấp", "Furigana": "しかく", "type": "noun", "conv": { "polite": "資格があるはずです。", "pVi": "Chắc chắn là có tư cách.", "casual": "資格あるはずだ。", "cVi": "Chắc chắn có bằng rồi.", "gIds": ["hazu"] } },
            { "STT": 74, "Kanji": "弁護士", "Nghĩa": "Luật sư", "Furigana": "べんごし", "type": "noun", "conv": { "polite": "彼は弁護士だそうです。", "pVi": "Nghe nói anh ấy là luật sư.", "casual": "彼弁護士だそうだ。", "cVi": "Nghe bảo hắn là luật sư.", "gIds": ["sou_da_hearsay"] } },
            { "STT": 75, "Kanji": "申請する", "Nghĩa": "Đăng ký", "Furigana": "しんせいする", "type": "verb", "conv": { "polite": "申請したばかりです。", "pVi": "Tôi vừa mới nộp đơn.", "casual": "申請したばっかだ。", "cVi": "Vừa nộp đơn xong.", "gIds": ["bakari"] } },
            { "STT": 76, "Kanji": "通帳", "Nghĩa": "Sổ tiết kiệm", "Furigana": "つうちょう", "type": "noun", "conv": { "polite": "通帳はどこですか。", "pVi": "Sổ tiết kiệm ở đâu?", "casual": "通帳どこ？", "cVi": "Sổ đâu rồi?", "gIds": [] } },
            { "STT": 77, "Kanji": "貯金する", "Nghĩa": "Tiết kiệm", "Furigana": "ちょきんする", "type": "verb", "conv": { "polite": "貯金したばかりです。", "pVi": "Tôi vừa mới tiết kiệm tiền.", "casual": "貯金したばっかだ。", "cVi": "Vừa gửi tiền xong.", "gIds": ["bakari"] } },
            { "STT": 78, "Kanji": "本人", "Nghĩa": "Chính chủ", "Furigana": "ほんにん", "type": "noun", "conv": { "polite": "本人が来たばかりです。", "pVi": "Chính chủ vừa mới đến.", "casual": "本人来たばっかだ。", "cVi": "Người đó vừa tới xong.", "gIds": ["bakari"] } },
            { "STT": 79, "Kanji": "契約する", "Nghĩa": "Ký hợp đồng", "Furigana": "けいやくする", "type": "verb", "conv": { "polite": "契約したばかりです。", "pVi": "Tôi vừa mới ký hợp đồng.", "casual": "契約したばっかだ。", "cVi": "Vừa ký xong.", "gIds": ["bakari"] } },
            { "STT": 80, "Kanji": "証明する", "Nghĩa": "Chứng minh", "Furigana": "しょうめいする", "type": "verb", "conv": { "polite": "証明したばかりです。", "pVi": "Tôi vừa mới chứng minh.", "casual": "証明したばっかだ。", "cVi": "Vừa chứng minh xong.", "gIds": ["bakari"] } },
            { "STT": 81, "Kanji": "変更する", "Nghĩa": "Thay đổi", "Furigana": "へんこうする", "type": "verb", "conv": { "polite": "変更したばかりです。", "pVi": "Tôi vừa mới sửa đổi.", "casual": "変更したばっかだ。", "cVi": "Vừa đổi xong.", "gIds": ["bakari"] } },
            { "STT": 82, "Kanji": "保存する", "Nghĩa": "Lưu", "Furigana": "ほぞんする", "type": "verb", "conv": { "polite": "保存したばかりです。", "pVi": "Tôi vừa mới lưu lại.", "casual": "保存したばっかだ。", "cVi": "Vừa save xong.", "gIds": ["bakari"] } },
            { "STT": 83, "Kanji": "保護する", "Nghĩa": "Bảo vệ", "Furigana": "ほごする", "type": "verb", "conv": { "polite": "保護したばかりです。", "pVi": "Tôi vừa mới bảo hộ.", "casual": "保護したばっかだ。", "cVi": "Vừa bảo vệ xong.", "gIds": ["bakari"] } },
            { "STT": 84, "Kanji": "郊外", "Nghĩa": "Ngoại ô", "Furigana": "こうがい", "type": "place", "conv": { "polite": "郊外に住んでいるそうです。", "pVi": "Nghe nói anh ấy sống ở ngoại ô.", "casual": "郊外に住んでるそうだ。", "cVi": "Nghe bảo sống ở ngoại ô.", "gIds": ["sou_da_hearsay"] } },
            { "STT": 85, "Kanji": "都会", "Nghĩa": "Thành phố", "Furigana": "とかい", "type": "place", "conv": { "polite": "都会に住むのは便利です。", "pVi": "Việc sống ở thành phố rất tiện lợi.", "casual": "都会住むの便利だ。", "cVi": "Sống thành phố tiện thật.", "gIds": ["no_wa"] } },
            { "STT": 86, "Kanji": "資源", "Nghĩa": "Tài nguyên", "Furigana": "しげん", "type": "noun", "conv": { "polite": "資源は大切だそうです。", "pVi": "Nghe nói tài nguyên rất quan trọng.", "casual": "資源は大切だそうだ。", "cVi": "Nghe bảo tài nguyên quan trọng lắm.", "gIds": ["sou_da_hearsay"] } },
            { "STT": 87, "Kanji": "有効", "Nghĩa": "Hữu hiệu", "Furigana": "ゆうこう", "type": "adj_na", "conv": { "polite": "このチケットはまだ有効なはずです。", "pVi": "Vé này chắc chắn vẫn còn hiệu lực.", "casual": "このチケット、まだ有効なはずだ。", "cVi": "Vé này chắc vẫn dùng được.", "gIds": ["hazu"] } }
        ];

        // --- 3. KANJI DETAILS (Tips & Mnemonics) ---
        const kanjiDetails = {
            "凄": { hanviet: "THÊ", mean: "Ghê gớm/Tuyệt", on: "セイ", kun: "すご.い", radicals: "Băng (冫) + Thê (妻)", tipImg: "Người vợ (妻) lạnh lùng (冫) thật ghê gớm.", tipSoundOn: "**Sei**zetsu thê lương.", tipSoundKun: "**Sugo**i tuyệt/ghê.", words: [{w:"凄い (すごい)", m:"Tuyệt vời/Kinh khủng"}] },
            "酷": { hanviet: "KHỐC", mean: "Tàn khốc", on: "コク", kun: "ひど.い", radicals: "Dậu (酉) + Cáo (告)", tipImg: "Uống rượu (酉) rồi cáo (告) giác tàn khốc.", tipSoundOn: "Zan**koku** tàn khốc.", tipSoundKun: "**Hido**i tồi tệ.", words: [{w:"酷い (ひどい)", m:"Tồi tệ/Kinh khủng"}] },
            "激": { hanviet: "KÍCH", mean: "Kích động/Mãnh liệt", on: "ゲキ", kun: "はげ.しい", radicals: "Thủy (氵) + Phóng (敫)", tipImg: "Nước (氵) phóng (敫) ra mãnh liệt.", tipSoundOn: "**Geki**retsu kịch liệt.", tipSoundKun: "**Hage**shii mãnh liệt.", words: [{w:"激しい (はげしい)", m:"Mãnh liệt"}, {w:"感激 (かんげき)", m:"Cảm kích"}] },
            "急": { hanviet: "CẤP", mean: "Gấp", on: "キュウ", kun: "いそ.ぐ", radicals: "Tâm (心) + Sô (刍)", tipImg: "Tâm (心) trí sô (刍) bồ gấp gáp.", tipSoundOn: "**Kyuu**kou tàu tốc hành.", tipSoundKun: "**Iso**gu vội.", words: [{w:"急な (きゅうな)", m:"Gấp/Đột nhiên"}, {w:"急ぐ (いそぐ)", m:"Vội vàng"}] },
            "適": { hanviet: "THÍCH", mean: "Thích hợp", on: "テキ", kun: "", radicals: "Xước (⻌) + Đế (啇)", tipImg: "Đi (⻌) tìm đế (啇) vương thích hợp.", tipSoundOn: "**Teki**tou thích hợp.", tipSoundKun: "", words: [{w:"適当 (てきとう)", m:"Thích hợp"}] },
            "特": { hanviet: "ĐẶC", mean: "Đặc biệt", on: "トク", kun: "", radicals: "Ngưu (牜) + Tự (寺)", tipImg: "Con bò (牜) ở chùa (寺) rất đặc biệt.", tipSoundOn: "**Toku**betsu đặc biệt.", tipSoundKun: "", words: [{w:"特別 (とくべつ)", m:"Đặc biệt"}] },
            "完": { hanviet: "HOÀN", mean: "Hoàn thành", on: "カン", kun: "", radicals: "Miên (宀) + Nguyên (元)", tipImg: "Ngôi nhà (宀) nguyên (元) vẹn hoàn hảo.", tipSoundOn: "**Kan**zen hoàn toàn.", tipSoundKun: "", words: [{w:"完全 (かんぜん)", m:"Hoàn toàn"}, {w:"完成 (かんせい)", m:"Hoàn thành"}] },
            "盛": { hanviet: "THỊNH", mean: "Thịnh vượng", on: "セイ", kun: "さか.ん", radicals: "Mãnh (皿) + Thành (成)", tipImg: "Thành (成) công bày biện trên đĩa (皿) thịnh soạn.", tipSoundOn: "**Sei**dai long trọng.", tipSoundKun: "**Sakan** thịnh hành.", words: [{w:"盛ん (さかん)", m:"Thịnh vượng"}] },
            "様": { hanviet: "DẠNG", mean: "Hình dáng/Ngài", on: "ヨウ", kun: "さま", radicals: "Mộc (木) + Dương (羊)", tipImg: "Con dê (羊) ăn cây (木) ra dáng.", tipSoundOn: "**You**su tình trạng.", tipSoundKun: "**Sama**zama đa dạng.", words: [{w:"様々 (さまざま)", m:"Đa dạng"}, {w:"神様 (かみさま)", m:"Thần"}] },
            "可": { hanviet: "KHẢ", mean: "Có thể", on: "カ", kun: "", radicals: "Khẩu (口) + Đinh (丁)", tipImg: "Miệng nói đinh ninh là có thể.", tipSoundOn: "**Ka**nou khả năng.", tipSoundKun: "", words: [{w:"可能 (かのう)", m:"Khả năng"}] },
            "能": { hanviet: "NĂNG", mean: "Khả năng", on: "ノウ", kun: "", radicals: "Nguyệt (月)", tipImg: "Gấu có khả năng đứng bằng hai chân.", tipSoundOn: "Ka**nou** khả năng.", tipSoundKun: "", words: [{w:"可能 (かのう)", m:"Khả năng"}] },
            "基": { hanviet: "CƠ", mean: "Cơ bản", on: "キ", kun: "もと", radicals: "Thổ (土) + Kỳ (其)", tipImg: "Đất (土) ở kỳ (其) lạ làm cơ sở.", tipSoundOn: "**Ki**hon cơ bản.", tipSoundKun: "**Moto** cở sở.", words: [{w:"基本 (きほん)", m:"Cơ bản"}] },
            "際": { hanviet: "TẾ", mean: "Quốc tế/Dịp", on: "サイ", kun: "きわ", radicals: "Phụ (阝) + Tế (祭)", tipImg: "Gò đất (阝) làm lễ tế (祭).", tipSoundOn: "Koku**sai** quốc tế.", tipSoundKun: "**Kiwa** mép.", words: [{w:"国際 (こくさい)", m:"Quốc tế"}] },
            "乱": { hanviet: "LOẠN", mean: "Rối loạn", on: "ラン", kun: "みだ.れる", radicals: "Ất (乙) + Thiệt (舌)", tipImg: "Lưỡi (舌) nói lung tung gây rối loạn.", tipSoundOn: "Kon**ran** hỗn loạn.", tipSoundKun: "Barabara rải rác.", words: [{w:"ばらばら", m:"Rải rác/Lung tung"}] },
            "演": { hanviet: "DIỄN", mean: "Diễn xuất", on: "エン", kun: "", radicals: "Thủy (氵) + Dần (寅)", tipImg: "Nước (氵) chảy dần (寅) diễn ra.", tipSoundOn: "**En**sou biểu diễn.", tipSoundKun: "", words: [{w:"演奏 (えんそう)", m:"Biểu diễn"}] },
            "奏": { hanviet: "TẤU", mean: "Diễn tấu", on: "ソウ", kun: "かな.でる", radicals: "Thiên (天) + Thảo (艹)", tipImg: "Dâng cỏ (艹) lên trời (天) tấu nhạc.", tipSoundOn: "En**sou** biểu diễn.", tipSoundKun: "**Kana**deru chơi nhạc.", words: [{w:"演奏 (えんそう)", m:"Biểu diễn"}] },
            "芸": { hanviet: "NGHỆ", mean: "Nghệ thuật", on: "ゲイ", kun: "", radicals: "Thảo (艹) + Vân (云)", tipImg: "Cỏ (艹) mọc như mây (云) là nghệ thuật.", tipSoundOn: "**Gei**jutsu nghệ thuật.", tipSoundKun: "", words: [{w:"芸術 (げいじゅつ)", m:"Nghệ thuật"}] },
            "検": { hanviet: "KIỂM", mean: "Kiểm tra", on: "ケン", kun: "", radicals: "Mộc (木) + Kiếm (佥)", tipImg: "Cây (木) bị kiếm (佥) tra xét.", tipSoundOn: "**Ken**sa kiểm tra.", tipSoundKun: "", words: [{w:"検査 (けんさ)", m:"Kiểm tra"}] },
            "査": { hanviet: "TRA", mean: "Điều tra", on: "サ", kun: "", radicals: "Mộc (木) + Thả (且)", tipImg: "Cây (木) và (且) đi điều tra.", tipSoundOn: "Ken**sa** kiểm tra.", tipSoundKun: "", words: [{w:"検査 (けんさ)", m:"Kiểm tra"}] },
            "胃": { hanviet: "VỊ", mean: "Dạ dày", on: "イ", kun: "", radicals: "Điền (田) + Nhục (月)", tipImg: "Ruộng (田) thịt (月) nuôi dạ dày.", tipSoundOn: "**I** dạ dày.", tipSoundKun: "", words: [{w:"胃 (い)", m:"Dạ dày"}] },
            "液": { hanviet: "DỊCH", mean: "Chất lỏng", on: "エキ", kun: "", radicals: "Thủy (氵) + Dạ (夜)", tipImg: "Nước (氵) chảy trong đêm (夜) là dịch.", tipSoundOn: "Ketsu**eki** máu.", tipSoundKun: "", words: [{w:"血液 (けつえき)", m:"Máu"}] },
            "療": { hanviet: "LIỆU", mean: "Trị liệu", on: "リョウ", kun: "", radicals: "Nạch (疒)", tipImg: "Chữa bệnh (疒) liệu pháp.", tipSoundOn: "Chi**ryou** trị liệu.", tipSoundKun: "", words: [{w:"治療 (ちりょう)", m:"Trị liệu"}] },
            "症": { hanviet: "CHỨNG", mean: "Triệu chứng", on: "ショウ", kun: "", radicals: "Nạch (疒) + Chính (正)", tipImg: "Bệnh (疒) chính (正) xác có triệu chứng.", tipSoundOn: "**Shou**jou triệu chứng.", tipSoundKun: "", words: [{w:"症状 (しょうじょう)", m:"Triệu chứng"}] },
            "状": { hanviet: "TRẠNG", mean: "Trạng thái", on: "ジョウ", kun: "", radicals: "Tường (爿) + Khuyển (犬)", tipImg: "Con chó (犬) đứng bên tường (爿) tạo dáng.", tipSoundOn: "Shou**jou** triệu chứng.", tipSoundKun: "", words: [{w:"症状 (しょうじょう)", m:"Triệu chứng"}] },
            "鼻": { hanviet: "TỊ", mean: "Mũi", on: "ビ", kun: "はな", radicals: "Tự (自) + Điền (田)", tipImg: "Tự (自) mình làm ruộng (田) bằng mũi.", tipSoundOn: "Ji**bi**ka khoa tai mũi họng.", tipSoundKun: "**Hana** mũi.", words: [{w:"鼻水 (はなみず)", m:"Nước mũi"}] },
            "予": { hanviet: "DỰ", mean: "Dự báo", on: "ヨ", kun: "", radicals: "Dự (予)", tipImg: "Cái mâu dự báo.", tipSoundOn: "**Yo**bou dự phòng.", tipSoundKun: "", words: [{w:"予防 (よぼう)", m:"Dự phòng"}] },
            "防": { hanviet: "PHÒNG", mean: "Đề phòng", on: "ボウ", kun: "ふせ.ぐ", radicals: "Phụ (阝) + Phương (方)", tipImg: "Gò đất (阝) phương (方) này để phòng thủ.", tipSoundOn: "Yo**bou** dự phòng.", tipSoundKun: "**Fuse**gu phòng ngự.", words: [{w:"予防 (よぼう)", m:"Dự phòng"}] },
            "栄": { hanviet: "VINH", mean: "Vinh quang", on: "エイ", kun: "さか.える", radicals: "Mộc (木)", tipImg: "Cây (木) nở hoa vinh quang.", tipSoundOn: "**Ei**you dinh dưỡng.", tipSoundKun: "**Saka**eru phồn vinh.", words: [{w:"栄養 (えいよう)", m:"Dinh dưỡng"}] },
            "養": { hanviet: "DƯỠNG", mean: "Nuôi dưỡng", on: "ヨウ", kun: "やしな.う", radicals: "Dương (羊) + Thực (食)", tipImg: "Nuôi dê (羊) để ăn (食).", tipSoundOn: "Ei**you** dinh dưỡng.", tipSoundKun: "**Yashina**u nuôi nấng.", words: [{w:"栄養 (えいよう)", m:"Dinh dưỡng"}] },
            "誤": { hanviet: "NGỘ", mean: "Nhầm lẫn", on: "ゴ", kun: "あやま.る", radicals: "Ngôn (言) + Ngô (吴)", tipImg: "Lời nói (言) của ngô (吴) bị hiểu lầm.", tipSoundOn: "**Go**kai hiểu lầm.", tipSoundKun: "**Ayama**ru mắc lỗi.", words: [{w:"誤解 (ごかい)", m:"Hiểu lầm"}] },
            "解": { hanviet: "GIẢI", mean: "Giải quyết", on: "カイ", kun: "と.く", radicals: "Giác (角) + Đao (刀) + Ngưu (牛)", tipImg: "Dùng dao (刀) giải quyết sừng (角) trâu (牛).", tipSoundOn: "Go**kai** hiểu lầm.", tipSoundKun: "**To**ku giải.", words: [{w:"誤解 (ごかい)", m:"Hiểu lầm"}] },
            "悔": { hanviet: "HỐI", mean: "Hối hận", on: "カイ", kun: "く.やむ", radicals: "Tâm (忄) + Mỗi (毎)", tipImg: "Tâm (忄) mỗi (毎) ngày đều hối hận.", tipSoundOn: "Kou**kai** hối hận.", tipSoundKun: "**Ku**yamu tiếc nuối.", words: [{w:"後悔 (こうかい)", m:"Hối hận"}] },
            "態": { hanviet: "THÁI", mean: "Thái độ", on: "タイ", kun: "", radicals: "Tâm (心) + Năng (能)", tipImg: "Tâm (心) có khả năng (能) thái độ.", tipSoundOn: "**Tai**do thái độ.", tipSoundKun: "", words: [{w:"態度 (たいど)", m:"Thái độ"}] },
            "癖": { hanviet: "PHÍCH", mean: "Tật xấu", on: "ヘキ", kun: "くせ", radicals: "Nạch (疒) + Tích (辟)", tipImg: "Bệnh (疒) tích (辟) tụ thành tật.", tipSoundOn: "Kepp**eki** ưa sạch.", tipSoundKun: "**Kuse** thói hư.", words: [{w:"癖 (くせ)", m:"Tật xấu"}] },
            "儀": { hanviet: "NGHI", mean: "Nghi thức", on: "ギ", kun: "", radicals: "Nhân (亻) + Nghĩa (義)", tipImg: "Người (亻) làm việc nghĩa (義) theo nghi thức.", tipSoundOn: "Rei**gi** lễ nghi.", tipSoundKun: "", words: [{w:"礼儀 (れいぎ)", m:"Lễ nghi"}] },
            "句": { hanviet: "CÚ", mean: "Câu/Cụm từ", on: "ク", kun: "", radicals: "Khẩu (口) + Bao (勹)", tipImg: "Miệng (口) bao (勹) quanh câu từ.", tipSoundOn: "Mon**ku** phàn nàn.", tipSoundKun: "", words: [{w:"文句 (もんく)", m:"Phàn nàn"}] },
            "情": { hanviet: "TÌNH", mean: "Tình cảm", on: "ジョウ", kun: "なさ.け", radicals: "Tâm (忄) + Thanh (青)", tipImg: "Tâm (忄) thanh (青) thản tình cảm.", tipSoundOn: "Hyou**jou** biểu cảm.", tipSoundKun: "**Nasa**ke cảm thông.", words: [{w:"表情 (ひょうじょう)", m:"Biểu cảm"}] },
            "禁": { hanviet: "CẤM", mean: "Cấm", on: "キン", kun: "", radicals: "Lâm (林) + Thị (示)", tipImg: "Rừng cấm tế lễ.", tipSoundOn: "**Kin**en cấm hút thuốc.", tipSoundKun: "", words: [{w:"禁煙 (きんえん)", m:"Cấm hút thuốc"}] },
            "煙": { hanviet: "YÊN", mean: "Khói", on: "エン", kun: "けむり", radicals: "Hỏa (火)", tipImg: "Lửa đốt đất tây bốc khói.", tipSoundOn: "Kin**en** cấm hút thuốc.", tipSoundKun: "**Kemuri** khói.", words: [{w:"禁煙 (きんえん)", m:"Cấm hút thuốc"}] },
            "完": { hanviet: "HOÀN", mean: "Hoàn thành", on: "カン", kun: "", radicals: "Miên (宀) + Nguyên (元)", tipImg: "Ngôi nhà nguyên vẹn.", tipSoundOn: "**Kan**sei hoàn thành.", tipSoundKun: "", words: [{w:"完成 (かんせい)", m:"Hoàn thành"}] },
            "課": { hanviet: "KHÓA", mean: "Bài học", on: "カ", kun: "", radicals: "Ngôn (言) + Quả (果)", tipImg: "Lời nói và quả.", tipSoundOn: "**Ka**dai chủ đề.", tipSoundKun: "", words: [{w:"課題 (かだい)", m:"Bài tập/Chủ đề"}] },
            "例": { hanviet: "LỆ", mean: "Ví dụ", on: "レイ", kun: "たと.える", radicals: "Nhân (亻) + Liệt (列)", tipImg: "Người xếp hàng làm ví dụ.", tipSoundOn: "**Rei**gai ngoại lệ.", tipSoundKun: "**Tato**eba ví dụ.", words: [{w:"例外 (れいがい)", m:"Ngoại lệ"}] },
            "録": { hanviet: "LỤC", mean: "Ghi chép", on: "ロク", kun: "", radicals: "Kim (金) + Lục (录)", tipImg: "Dùng kim loại ghi lục.", tipSoundOn: "Ki**roku** kỷ lục.", tipSoundKun: "", words: [{w:"記録 (きろく)", m:"Ghi chép"}] },
            "状": { hanviet: "TRẠNG", mean: "Trạng thái", on: "ジョウ", kun: "", radicals: "Tường (爿) + Khuyển (犬)", tipImg: "Chó đứng bên tường.", tipSoundOn: "**Jou**tai trạng thái.", tipSoundKun: "", words: [{w:"状態 (じょうたい)", m:"Trạng thái"}] },
            "案": { hanviet: "ÁN", mean: "Đề án", on: "アン", kun: "", radicals: "An (安) + Mộc (木)", tipImg: "An tâm dưới cây.", tipSoundOn: "Tei**an** đề xuất.", tipSoundKun: "", words: [{w:"提案 (ていあん)", m:"Đề xuất"}] },
            "識": { hanviet: "THỨC", mean: "Kiến thức", on: "シキ", kun: "", radicals: "Ngôn (言) + Chức (戠)", tipImg: "Lời nói có chức phận là kiến thức.", tipSoundOn: "Chi**shiki** kiến thức.", tipSoundKun: "", words: [{w:"知識 (ちしき)", m:"Kiến thức"}] },
            "効": { hanviet: "HIỆU", mean: "Hiệu quả", on: "コウ", kun: "き.く", radicals: "Giao (交) + Lực (力)", tipImg: "Giao lưu sức lực hiệu quả.", tipSoundOn: "**Kou**ka hiệu quả.", tipSoundKun: "**Ki**ku có tác dụng.", words: [{w:"効果 (こうか)", m:"Hiệu quả"}] },
            "印": { hanviet: "ẤN", mean: "Dấu ấn", on: "イン", kun: "しるし", radicals: "Tiết (卩)", tipImg: "Dấu ấn xác nhận.", tipSoundOn: "**In**shou ấn tượng.", tipSoundKun: "**Shirushi** dấu hiệu.", words: [{w:"印象 (いんしょう)", m:"Ấn tượng"}, {w:"印 (しるし)", m:"Dấu"}] },
            "共": { hanviet: "CỘNG", mean: "Cùng nhau", on: "キョウ", kun: "とも", radicals: "Bát (八)", tipImg: "Cùng nhau nâng bát.", tipSoundOn: "**Kyou**tsuu chung.", tipSoundKun: "**Tomo** cùng.", words: [{w:"共通 (きょうつう)", m:"Điểm chung"}] },
            "調": { hanviet: "ĐIỀU", mean: "Điều tra/Giai điệu", on: "チョウ", kun: "しら.べる", radicals: "Ngôn (言) + Chu (周)", tipImg: "Lời nói chu toàn.", tipSoundOn: "Kyou**chou** nhấn mạnh.", tipSoundKun: "**Shira**beru điều tra.", words: [{w:"強調 (きょうちょう)", m:"Nhấn mạnh"}] },
            "略": { hanviet: "LƯỢC", mean: "Lược bỏ", on: "リャク", kun: "", radicals: "Điền (田) + Các (各)", tipImg: "Ruộng của mỗi người lược bớt.", tipSoundOn: "Shou**ryaku** lược bỏ.", tipSoundKun: "", words: [{w:"省略 (しょうりゃく)", m:"Lược bỏ"}] },
            "詳": { hanviet: "TƯỜNG", mean: "Chi tiết", on: "ショウ", kun: "くわ.しい", radicals: "Ngôn (言) + Dương (羊)", tipImg: "Lời nói về con dê chi tiết.", tipSoundOn: "**Shou**sai chi tiết.", tipSoundKun: "**Kuwa**shii tường tận.", words: [{w:"詳細 (しょうさい)", m:"Chi tiết"}] },
            "挑": { hanviet: "KHIÊU", mean: "Khiêu chiến", on: "チョウ", kun: "いど.む", radicals: "Thủ (扌) + Triệu (兆)", tipImg: "Tay triệu tập khiêu chiến.", tipSoundOn: "**Chou**sen thử thách.", tipSoundKun: "**Ido**mu thách thức.", words: [{w:"挑戦 (ちょうせん)", m:"Thử thách"}] },
            "弁": { hanviet: "BIỆN", mean: "Biện luận", on: "ベン", kun: "", radicals: "Củng (廾)", tipImg: "Hai tay nâng mũ.", tipSoundOn: "**Ben**goshi luật sư.", tipSoundKun: "", words: [{w:"弁護士 (べんごし)", m:"Luật sư"}] },
            "申": { hanviet: "THÂN", mean: "Xưng tên", on: "シン", kun: "もう.す", radicals: "Điền (田)", tipImg: "Nói tên.", tipSoundOn: "**Shin**sei thỉnh cầu.", tipSoundKun: "**Mou**su nói.", words: [{w:"申請 (しんせい)", m:"Đăng ký"}] },
            "帳": { hanviet: "TRƯỚNG", mean: "Sổ tay", on: "チョウ", kun: "", radicals: "Cân (巾) + Trường (長)", tipImg: "Khăn dài làm sổ.", tipSoundOn: "Tsuu**chou** sổ tiết kiệm.", tipSoundKun: "", words: [{w:"通帳 (つうちょう)", m:"Sổ tiết kiệm"}] },
            "貯": { hanviet: "TRỮ", mean: "Tích trữ", on: "チョ", kun: "た.める", radicals: "Bối (貝) + Trữ (宁)", tipImg: "Tiền trong nhà kho.", tipSoundOn: "**Cho**kin tiết kiệm.", tipSoundKun: "**Ta**meru để dành.", words: [{w:"貯金 (ちょきん)", m:"Tiết kiệm"}] },
            "契": { hanviet: "KHẾ", mean: "Hợp đồng", on: "ケイ", kun: "ちぎ.る", radicals: "Đại (大)", tipImg: "Ký kết lớn.", tipSoundOn: "**Kei**yaku hợp đồng.", tipSoundKun: "**Chigi**ru thề ước.", words: [{w:"契約 (けいやく)", m:"Hợp đồng"}] },
            "証": { hanviet: "CHỨNG", mean: "Chứng minh", on: "ショウ", kun: "", radicals: "Ngôn (言) + Chính (正)", tipImg: "Lời nói chính xác là bằng chứng.", tipSoundOn: "**Shou**mei chứng minh.", tipSoundKun: "", words: [{w:"証明 (しょうめい)", m:"Chứng minh"}] },
            "更": { hanviet: "CANH", mean: "Canh tân", on: "コウ", kun: "さら", radicals: "Nhật (日)", tipImg: "Ngày mới canh tân.", tipSoundOn: "Hen**kou** thay đổi.", tipSoundKun: "**Sara** mới.", words: [{w:"変更 (へんこう)", m:"Thay đổi"}] },
            "存": { hanviet: "TỒN", mean: "Tồn tại", on: "ソン", kun: "", radicals: "Tử (子)", tipImg: "Đứa trẻ còn đó.", tipSoundOn: "Ho**zon** bảo tồn.", tipSoundKun: "", words: [{w:"保存 (ほぞん)", m:"Lưu"}] },
            "護": { hanviet: "HỘ", mean: "Bảo hộ", on: "ゴ", kun: "まも.る", radicals: "Ngôn (言)", tipImg: "Lời nói bảo vệ.", tipSoundOn: "Ho**go** bảo hộ.", tipSoundKun: "**Mamo**ru bảo vệ.", words: [{w:"保護 (ほご)", m:"Bảo vệ"}] },
            "効": { hanviet: "HIỆU", mean: "Hiệu quả", on: "コウ", kun: "き.く", radicals: "Lực (力)", tipImg: "Sức lực có hiệu quả.", tipSoundOn: "Yuu**kou** hữu hiệu.", tipSoundKun: "**Ki**ku có tác dụng.", words: [{w:"有効 (ゆうこう)", m:"Hữu hiệu"}] }
        };

        // --- 4. APP LOGIC (Standard Day 1 Logic) ---
        let currentIndex = 0; 
        let currentQuizItem = null; 
        let score = 0; 
        let currentStrokeSvg = null;

        function init() {
            renderList();
            renderGrammarMenu();
            loadWord(0);
            
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', e => { 
                    const t = e.target.value.toLowerCase(); 
                    document.querySelectorAll('.vocab-item').forEach(el => el.style.display = el.innerText.toLowerCase().includes(t) ? 'block' : 'none'); 
                });
            }

            const mobileSearchInput = document.getElementById('mobileSearchInput');
            if (mobileSearchInput) {
                mobileSearchInput.addEventListener('input', e => { 
                    const t = e.target.value.toLowerCase(); 
                    document.querySelectorAll('.vocab-item').forEach(el => el.style.display = el.innerText.toLowerCase().includes(t) ? 'block' : 'none'); 
                });
            }

            const quizInput = document.getElementById('quiz-input');
            if (quizInput) {
                quizInput.addEventListener('keypress', e => { if(e.key === 'Enter') checkAnswer(); });
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            document.getElementById('learn-section').classList.toggle('hidden', tab !== 'learn');
            document.getElementById('quiz-section').classList.toggle('hidden', tab !== 'quiz');
            if(tab === 'quiz') nextQuestion();
        }

        function renderList() {
            const listD = document.getElementById('vocabList'); 
            const listM = document.getElementById('mobileVocabList');
            const html = vocabData.map((item, i) => `
                <div class="vocab-item p-3 border-b hover:bg-gray-50 cursor-pointer rounded-lg mx-1 my-1" data-index="${i}" onclick="loadWord(${i}); if(window.innerWidth < 768) toggleDrawer();">
                    <div class="flex justify-between font-bold items-center">
                        <span class="text-gray-800 ja-text">${item.Kanji || item.Furigana}</span>
                        <span class="text-gray-300 text-xs font-mono">#${item.STT}</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1 truncate">${item.Nghĩa}</div>
                </div>`).join('');
            if (listD) listD.innerHTML = html;
            if (listM) listM.innerHTML = html;
        }

        function loadWord(idx) {
            currentIndex = idx; 
            const word = vocabData[idx];
            document.querySelectorAll('.vocab-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll(`.vocab-item[data-index="${idx}"]`).forEach(el => el.classList.add('active'));
            
            const activeItem = document.querySelector(`.vocab-item[data-index="${idx}"]`);
            if (activeItem) activeItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            document.getElementById('headerProgress').innerText = `${idx+1}/${vocabData.length}`;
            document.getElementById('wordIndex').innerText = `#${word.STT}`;
            document.getElementById('cardKanji').innerText = word.Kanji || word.Furigana;
            document.getElementById('cardFurigana').innerText = word.Furigana;
            document.getElementById('cardMeaning').innerText = word.Nghĩa;
            document.getElementById('wordType').innerText = word.type.toUpperCase();
            
            const hasKanji = word.Kanji && word.Kanji !== word.Furigana;
            document.getElementById('strokeBtn').classList.toggle('hidden', !hasKanji);
            
            renderShadowing(word);
        }

        function renderShadowing(word) {
            const cont = document.getElementById('sentenceList'); 
            cont.innerHTML = '';
            
            if(!word.conv) { 
                document.getElementById('emptyState').classList.remove('hidden'); 
                return; 
            }
            document.getElementById('emptyState').classList.add('hidden');
            
            const types = [
                { k:'polite', l:'Lịch sự', m:word.conv.pVi, i:'user-tie', c:'indigo' }, 
                { k:'casual', l:'Thân mật', m:word.conv.cVi, i:'comments', c:'pink' }
            ];
            
            types.forEach(t => {
                const grammarBtn = word.conv.gIds && word.conv.gIds.length > 0 
                    ? `<button onclick="openExplan('${word.conv.gIds.join(',')}')" class="text-xs text-indigo-500 hover:text-indigo-700 font-bold px-2 py-1 rounded hover:bg-indigo-50 transition"><i class="fas fa-info-circle"></i> Ngữ pháp</button>`
                    : '';

                cont.innerHTML += `
                    <div class="shadow-card bg-white rounded-2xl p-4 border border-gray-100">
                        <div class="flex justify-between border-b border-gray-100 pb-2 mb-3">
                            <div class="flex gap-2 items-center">
                                <div class="bg-${t.c}-50 p-1.5 rounded text-${t.c}-600"><i class="fas fa-${t.i}"></i></div>
                                <span class="text-xs font-bold text-gray-400 uppercase tracking-wide">${t.l}</span>
                            </div>
                            ${grammarBtn}
                        </div>
                        <div class="flex justify-between items-start gap-3">
                            <div>
                                <div class="text-lg md:text-xl ja-text font-medium text-gray-800 mb-1 cursor-pointer hover:text-indigo-600 transition-colors" onclick="speakText('${word.conv[t.k]}')">${word.conv[t.k]}</div>
                                <div class="text-sm text-gray-500 italic">${t.m}</div>
                            </div>
                            <button onclick="speakText('${word.conv[t.k]}')" class="audio-btn text-${t.c}-400 hover:text-${t.c}-600 p-2 rounded-full hover:bg-${t.c}-50 transition-colors flex-shrink-0">
                                <i class="fas fa-volume-up text-xl"></i>
                            </button>
                        </div>
                    </div>`;
            });
        }

        function openExplan(idsStr) {
            const ids = idsStr.split(','); 
            const f = document.getElementById('dgFormula'); 
            const e = document.getElementById('dgExplanation');
            
            f.innerText = ids.map(id => grammarRepo[id] ? grammarRepo[id].formula : "N/A").join("  /  ");
            e.innerHTML = ids.map(id => {
                if (!grammarRepo[id]) return `<div class="text-red-500">Missing grammar: ${id}</div>`;
                return `
                <div class="pb-2 border-b border-gray-100 last:border-0">
                    <strong class="text-indigo-700 block mb-1">${grammarRepo[id].title} <span class="text-xs font-normal text-gray-400">(${grammarRepo[id].desc.split(':')[0]})</span></strong>
                    <p>${grammarRepo[id].desc.split(':').slice(1).join(':') || grammarRepo[id].desc}</p>
                    <p class="text-xs text-gray-400 mt-1 italic">Vd: ${grammarRepo[id].ex}</p>
                </div>`;
            }).join("");
            
            showModal('detailGrammarModal');
        }

        function renderGrammarMenu() {
            const grid = document.getElementById('grammarGrid'); 
            grid.innerHTML = '';
            Object.keys(grammarRepo).forEach(key => {
                const r = grammarRepo[key];
                grid.innerHTML += `
                    <div class="bg-white p-4 rounded-xl border border-gray-100 flex flex-col justify-between hover:shadow-md transition cursor-pointer" onclick="speakText('${r.ex}')">
                        <div>
                            <div class="font-bold text-sm text-indigo-600 mb-1 flex items-center gap-2"><i class="fas fa-tag text-xs"></i> ${r.title}</div>
                            <code class="text-xs block bg-gray-50 p-1.5 rounded mb-2 border border-gray-200 font-mono text-gray-700">${r.formula}</code>
                            <p class="text-xs text-gray-500 mb-2 line-clamp-2">${r.desc}</p>
                        </div>
                        <div class="bg-indigo-50 p-2 rounded flex justify-between items-center gap-2 mt-2">
                            <span class="text-[11px] font-medium text-indigo-800 ja-text truncate">${r.ex}</span>
                            <i class="fas fa-volume-up text-indigo-400 text-xs"></i>
                        </div>
                    </div>`;
            });
        }

        function showModal(id) { 
            const modal = document.getElementById(id);
            modal.classList.remove('hidden'); 
            setTimeout(() => { 
                document.getElementById(id.replace('Modal','Backdrop')).classList.remove('opacity-0'); 
                document.getElementById(id.replace('Modal','Panel')).classList.remove('opacity-0', 'scale-95'); 
            }, 10); 
        }
        function closeModal(id) { 
            const b = document.getElementById(id.replace('Modal','Backdrop')); 
            const p = document.getElementById(id.replace('Modal','Panel'));
            if(b) b.classList.add('opacity-0'); 
            if(p) p.classList.add('opacity-0', 'scale-95');
            setTimeout(() => document.getElementById(id).classList.add('hidden'), 200); 
        }
        function openGrammarList() { showModal('grammarListModal'); }

        async function openStrokeModal(char) {
            const word = vocabData[currentIndex]; 
            const kanjis = word.Kanji.match(/[\u4e00-\u9faf]/g) || [];
            if(kanjis.length === 0) return;
            const target = char || kanjis[0];
            const tabs = document.getElementById('strokeTabs'); 
            tabs.innerHTML = '';
            if(kanjis.length > 1) {
                kanjis.forEach(k => {
                    const b = document.createElement('button'); 
                    b.innerText = k;
                    b.className = `w-12 h-12 text-xl rounded-xl font-bold border transition ja-text ${k===target ? 'bg-pink-600 text-white border-pink-600 shadow-lg' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}`;
                    b.onclick = () => showKanjiStroke(k); 
                    tabs.appendChild(b);
                });
            }
            showModal('strokeModal'); 
            await showKanjiStroke(target);
        }

        async function showKanjiStroke(k) {
            const d = kanjiDetails[k]; 
            const c = document.getElementById('kanjiDetailContent'); 
            const e = document.getElementById('kanjiDetailEmpty');
            if(d) {
                c.classList.remove('hidden'); e.classList.add('hidden');
                document.getElementById('detailKanji').innerText = k; 
                document.getElementById('detailHanViet').innerText = d.hanviet || '?';
                document.getElementById('detailMeaning').innerText = d.mean || ''; 
                document.getElementById('detailOn').innerText = d.on || '-'; 
                document.getElementById('detailKun').innerText = d.kun || '-';
                document.getElementById('detailRadicals').innerText = d.radicals || '...';
                
                const fmt = s => s.replace(/\*\*(.*?)\*\*/g, '<span class="font-bold text-gray-900">$1</span>');
                document.getElementById('detailTipImg').innerHTML = fmt(d.tipImg || ''); 
                
                let soundContent = d.tipSound || '';
                if (!soundContent && (d.tipSoundOn || d.tipSoundKun)) {
                    soundContent = [d.tipSoundOn, d.tipSoundKun].filter(Boolean).join(' / ');
                }
                document.getElementById('detailTipSound').innerHTML = fmt(soundContent);
                
                document.getElementById('btnPlayOn').onclick = () => speakText(d.on);
                document.getElementById('btnPlayKun').onclick = () => speakText(d.kun);

                const wc = document.getElementById('detailWords'); 
                wc.innerHTML = '';
                if(d.words) {
                    d.words.forEach(w => wc.innerHTML += `<div class="flex justify-between items-center bg-gray-50 p-2 rounded hover:bg-gray-100 cursor-pointer border border-transparent hover:border-gray-200 transition" onclick="speakText('${w.w}')"><span class="text-lg font-bold text-indigo-700 ja-text">${w.w}</span><span class="text-xs text-gray-500 font-medium">${w.m}</span></div>`);
                }
            } else { 
                c.classList.add('hidden'); e.classList.remove('hidden'); 
            }
            const anim = document.getElementById('strokeAnimContainer'); 
            const grid = document.getElementById('strokeGridContainer');
            anim.innerHTML = '<i class="fas fa-spinner fa-spin text-gray-300 text-2xl"></i>'; 
            grid.innerHTML = '';
            try {
                const r = await fetch(`https://cdn.jsdelivr.net/gh/KanjiVG/kanjivg/kanji/${getKanjiHex(k)}.svg`);
                if(!r.ok) throw new Error();
                const svgText = await r.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(svgText, "image/svg+xml");
                doc.querySelectorAll('path').forEach(p => p.setAttribute('style', 'opacity:0; stroke:#333; stroke-width:3; fill:none; stroke-linecap:round; stroke-linejoin:round;')); 
                anim.innerHTML = new XMLSerializer().serializeToString(doc.documentElement);
                const mainSvg = anim.querySelector('svg');
                mainSvg.setAttribute('width','100%'); mainSvg.setAttribute('height','100%');
                currentStrokeSvg = mainSvg;
                replayStrokeAnimation();
                const cleanDoc = parser.parseFromString(svgText, "image/svg+xml"); 
                cleanDoc.querySelectorAll('path').forEach((p, i) => {
                    const b = document.createElement('div'); 
                    b.className = "w-16 h-16 stroke-grid-box flex items-center justify-center rounded bg-white shadow-sm";
                    const clone = cleanDoc.documentElement.cloneNode(true);
                    clone.setAttribute('width','100%'); clone.setAttribute('height','100%');
                    clone.querySelectorAll('path').forEach((pp, idx) => {
                        pp.style.fill="none"; pp.style.strokeLinecap="round"; pp.style.strokeLinejoin="round";
                        if(idx<i) { pp.style.stroke="#e5e7eb"; pp.style.strokeWidth="3"; }
                        else if(idx===i) { pp.style.stroke="#db2777"; pp.style.strokeWidth="4"; } 
                        else pp.style.display="none";
                    });
                    b.appendChild(clone); grid.appendChild(b);
                });
            } catch(e) { anim.innerHTML = "<span class='text-xs text-red-400'>Lỗi tải nét viết</span>"; }
        }

        function replayStrokeAnimation() {
            if(!currentStrokeSvg) return;
            const paths = currentStrokeSvg.querySelectorAll('path');
            paths.forEach(p => { p.style.transition='none'; p.style.opacity='0'; });
            void currentStrokeSvg.offsetWidth;
            let delay = 0;
            paths.forEach(p => {
                const len = p.getTotalLength();
                p.style.strokeDasharray = len; p.style.strokeDashoffset = len; p.style.opacity = '1';
                setTimeout(() => { p.style.transition = `stroke-dashoffset 0.6s ease-in-out`; p.style.strokeDashoffset = '0'; }, delay * 1000);
                delay += 0.6;
            });
        }

        function getKanjiHex(k) { return k.charCodeAt(0).toString(16).padStart(5, '0'); }
        function speakText(t) { if ('speechSynthesis' in window) { const u = new SpeechSynthesisUtterance(t); u.lang = 'ja-JP'; u.rate = 0.9; speechSynthesis.speak(u); } }
        function speakCurrent() { speakText(vocabData[currentIndex].Furigana); }
        function toggleDrawer() { const d = document.getElementById('mobileDrawer'); const c = document.getElementById('drawerContent'); const b = document.getElementById('drawerBackdrop'); if(d.classList.contains('pointer-events-none')) { d.classList.remove('pointer-events-none'); c.classList.remove('-translate-x-full'); b.classList.remove('opacity-0'); } else { c.classList.add('-translate-x-full'); b.classList.add('opacity-0'); setTimeout(() => d.classList.add('pointer-events-none'), 300); } }

        function nextQuestion() {
            document.getElementById('feedback-area').classList.add('hidden'); document.getElementById('btn-check').classList.remove('hidden'); document.getElementById('btn-next').classList.add('hidden');
            document.getElementById('quiz-kanji').className = "text-6xl ja-text font-bold text-gray-800 mb-4 transition-all inline-block";
            const inp = document.getElementById('quiz-input'); inp.value = ''; inp.disabled = false; inp.focus();
            const valid = vocabData.filter(v => v.Furigana !== "...");
            currentQuizItem = valid[Math.floor(Math.random() * valid.length)];
            document.getElementById('quiz-kanji').innerText = currentQuizItem.Kanji || currentQuizItem.Furigana;
            document.getElementById('quiz-meaning').innerText = currentQuizItem.Nghĩa;
        }
        function checkAnswer() {
            const inp = document.getElementById('quiz-input'); if(!inp.value.trim()) return;
            inp.disabled = true; 
            const correct = inp.value.trim() === currentQuizItem.Furigana;
            const k = document.getElementById('quiz-kanji'); const fbTitle = document.getElementById('feedback-title'); const fbArea = document.getElementById('feedback-area');
            if(correct) { 
                score += 10; k.classList.add("text-green-600", "correct-anim"); 
                fbTitle.innerHTML = '<span class="text-green-600"><i class="fas fa-check-circle mr-2"></i> Chính xác!</span>';
                fbArea.className = fbArea.className.replace("bg-red-50 border-red-200", "") + " bg-green-50 border-green-200";
                speakText(currentQuizItem.Furigana); 
            } else { 
                score = Math.max(0, score - 5); k.classList.add("text-red-500", "wrong-anim"); 
                fbTitle.innerHTML = '<span class="text-red-600"><i class="fas fa-times-circle mr-2"></i> Sai rồi!</span>';
                fbArea.className = fbArea.className.replace("bg-green-50 border-green-200", "") + " bg-red-50 border-red-200";
            }
            document.getElementById('score-display').innerText = score; document.getElementById('correct-answer').innerText = currentQuizItem.Furigana;
            document.getElementById('feedback-area').classList.remove('hidden'); document.getElementById('btn-check').classList.add('hidden'); document.getElementById('btn-next').classList.remove('hidden');
        }
        function playQuizAudio() { if(currentQuizItem) speakText(currentQuizItem.Furigana); }
        function prevWord() { if(currentIndex > 0) loadWord(currentIndex - 1); }
        function nextWord() { if(currentIndex < vocabData.length - 1) loadWord(currentIndex + 1); }

        window.speakCurrent = speakCurrent;
        window.switchTab = switchTab;
        window.openGrammarList = openGrammarList;
        window.openStrokeModal = openStrokeModal;
        window.replayStrokeAnimation = replayStrokeAnimation;
        window.speakText = speakText;
        window.toggleDrawer = toggleDrawer;
        window.nextQuestion = nextQuestion;
        window.checkAnswer = checkAnswer;
        window.playQuizAudio = playQuizAudio;
        window.prevWord = prevWord;
        window.nextWord = nextWord;
        window.loadWord = loadWord;
        window.openExplan = openExplan;
        window.closeModal = closeModal;
        window.showModal = showModal;

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
