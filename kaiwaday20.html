<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AzaKanji - Hội Thoại & Ngữ Pháp (Day 20)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #f3f4f6; overflow-x: hidden; }
        .kanji-font { font-family: 'Noto Sans JP', sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Ruby Text Styling */
        ruby rt { font-size: 0.6em; color: #64748b; user-select: none; }
        .hide-furigana ruby rt { visibility: hidden; }

        /* Animations */
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .card-transition { transition: all 0.3s ease-in-out; }
        
        /* Highlight classes for Typing */
        .correct-char { color: #16a34a; font-weight: bold; }
        .incorrect-char { color: #dc2626; text-decoration: underline; font-weight: bold; }
        .correct-input { border-color: #22c55e !important; background-color: #f0fdf4 !important; }
        .wrong-input { border-color: #ef4444 !important; background-color: #fef2f2 !important; }
        
        /* Microphone Animation */
        .mic-listening { animation: pulse-red 1.5s infinite; color: #dc2626 !important; border-color: #dc2626 !important; }
        @keyframes pulse-red { 
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); } 
            70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); } 
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } 
        }

        /* Tab Transitions */
        .tab-btn { transition: all 0.3s ease; }
        .tab-active { background-color: #0284c7; color: white; shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .tab-inactive { background-color: #f3f4f6; color: #4b5563; }
        .tab-inactive:hover { background-color: #e5e7eb; }

        /* Progress Bar */
        .progress-container { background-color: #e5e7eb; border-radius: 999px; height: 8px; width: 100%; overflow: hidden; margin-top: 10px; }
        .progress-fill { background-color: #10b981; height: 100%; width: 0%; transition: width 0.5s ease-in-out; }

        /* Active playing line */
        .playing-line { border-left: 4px solid #0ea5e9; background-color: #f0f9ff !important; }

        /* STROKE ORDER STYLES */
        .stroke-path {
            fill: none;
            stroke: #333;
            stroke-width: 3;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .stroke-grid-box {
            border: 1px solid #e5e7eb;
            background-color: white;
            position: relative;
        }
        /* Dotted lines for kanji grid */
        .stroke-grid-box::after {
            content: ''; position: absolute; top: 0; left: 50%; width: 1px; height: 100%;
            background: repeating-linear-gradient(to bottom, #ddd 0, #ddd 4px, transparent 4px, transparent 8px); z-index: 0;
        }
        .stroke-grid-box::before {
            content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 1px;
            background: repeating-linear-gradient(to right, #ddd 0, #ddd 4px, transparent 4px, transparent 8px); z-index: 0;
        }

        /* Mobile Optimization for Quiz Options */
        .quiz-option {
            touch-action: manipulation; /* Improves touch response */
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Header -->
    <header class="bg-sky-700 text-white shadow-lg sticky top-0 z-40">
        <div class="container mx-auto px-4 py-3">
            <div class="flex flex-col md:flex-row justify-between items-center gap-3">
                <!-- Logo Area -->
                <div class="flex items-center space-x-3 cursor-pointer self-start md:self-auto" onclick="location.reload()">
                    <i class="fas fa-torii-gate text-2xl md:text-3xl text-yellow-300"></i>
                    <div>
                        <h1 class="text-lg md:text-xl font-bold uppercase tracking-wider leading-tight">AzaKanji Kaiwa</h1>
                        <p class="text-[10px] md:text-xs text-sky-200">Học Hội Thoại & Ngữ Pháp (Day 20)</p>
                    </div>
                </div>
                
                <!-- Controls (Scrollable on mobile) -->
                <div class="w-full md:w-auto flex items-center overflow-x-auto pb-1 md:pb-0 no-scrollbar">
                    <div class="flex bg-sky-800 rounded-lg p-1 text-sm whitespace-nowrap mx-auto md:mx-0">
                        <button id="btn-toggle-furigana" class="px-2 md:px-3 py-1.5 rounded transition hover:bg-sky-600 text-white flex items-center" title="Bật/Tắt cách đọc Kanji">
                            <i class="fas fa-eye mr-1 md:mr-2"></i> Furi
                        </button>
                        <button id="btn-toggle-romaji" class="px-2 md:px-3 py-1.5 rounded transition hover:bg-sky-600 text-white flex items-center ml-1" title="Bật/Tắt phiên âm Romaji">
                            <i class="fas fa-font mr-1 md:mr-2"></i> Romaji
                        </button>
                        <button id="btn-toggle-vi" class="px-2 md:px-3 py-1.5 rounded transition bg-white text-sky-800 font-bold ml-1 flex items-center" title="Bật/Tắt dịch tiếng Việt">
                            <i class="fas fa-language mr-1 md:mr-2"></i> Việt
                        </button>
                        
                        <!-- Audio Speed Control -->
                        <div class="flex items-center px-2 ml-1 border-l border-sky-600 text-white">
                            <i class="fas fa-tachometer-alt mr-1 text-sky-300 text-xs"></i>
                            <select id="audio-speed" class="bg-transparent border-none focus:ring-0 text-white font-bold cursor-pointer text-xs p-0">
                                <option value="0.75" class="text-gray-800">0.75x</option>
                                <option value="1.0" class="text-gray-800" selected>1.0x</option>
                                <option value="1.25" class="text-gray-800">1.25x</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-3 md:px-4 py-4 md:py-8 flex-grow space-y-6 md:space-y-8" id="app">
        
        <!-- Progress Section -->
        <div class="w-full max-w-4xl mx-auto mb-2 bg-white p-3 rounded-lg shadow-sm border border-gray-100">
            <div class="flex justify-between text-xs text-gray-500 mb-1 font-bold">
                <span>Tiến độ học tập</span>
                <span id="progress-text">0%</span>
            </div>
            <div class="progress-container">
                <div id="progress-bar" class="progress-fill"></div>
            </div>
        </div>

        <!-- 1. Conversation Section -->
        <section class="bg-white rounded-xl md:rounded-2xl shadow-md overflow-hidden fade-in border border-gray-100">
            <div class="bg-sky-50 px-4 md:px-6 py-3 md:py-4 border-b border-sky-100">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-3">
                    <h2 class="text-lg md:text-xl font-bold text-sky-800 flex items-center flex-wrap">
                        <span class="flex items-center"><i class="fas fa-comments mr-2"></i>Hội Thoại: Kế Hoạch Tương Lai</span>
                        <button onclick="playAllConversation()" class="ml-auto md:ml-3 text-xs md:text-sm bg-sky-100 text-sky-700 hover:bg-sky-200 px-3 py-1 rounded-full transition flex items-center whitespace-nowrap">
                            <i class="fas fa-play mr-1"></i> Nghe hết
                        </button>
                    </h2>
                    
                    <!-- Mode Tabs -->
                    <div class="flex bg-white rounded-lg p-1 shadow-sm border border-gray-200 w-full md:w-auto">
                        <button onclick="switchMode('polite')" id="tab-polite" class="tab-btn tab-active flex-1 md:flex-none px-2 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-bold text-center">Lịch sự</button>
                        <button onclick="switchMode('casual')" id="tab-casual" class="tab-btn tab-inactive flex-1 md:flex-none px-2 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-bold ml-1 text-center">Thông thường</button>
                    </div>
                </div>
            </div>
            
            <div class="p-3 md:p-6 space-y-4 md:space-y-6" id="conversation-container">
                <!-- Dialogue injected by JS -->
            </div>
        </section>

        <!-- 2. Reading Section -->
        <section class="bg-white rounded-xl md:rounded-2xl shadow-md overflow-hidden fade-in border border-gray-100">
            <div class="bg-orange-50 px-4 md:px-6 py-3 md:py-4 border-b border-orange-100">
                <h2 class="text-lg md:text-xl font-bold text-orange-800"><i class="fas fa-book-open mr-2"></i>Bài Đọc: Chăm Sóc Thú Cưng</h2>
            </div>
            <div class="p-4 md:p-6">
                <div class="bg-orange-50/30 p-3 md:p-5 rounded-xl border border-orange-100 leading-loose text-base md:text-lg kanji-font mb-2 text-justify" id="reading-text"></div>
                <div class="text-gray-500 text-sm mb-4 italic hidden romaji-text" id="reading-romaji"></div>
                <div class="text-gray-700 text-sm mb-4 hidden vi-trans border-t border-orange-100 pt-2" id="reading-vi"></div>
                
                <!-- Reading Practice Area -->
                <div class="mt-6 pt-4 border-t border-gray-100">
                    <h4 class="text-sm font-bold text-gray-500 mb-2 uppercase flex items-center"><i class="fas fa-keyboard mr-2"></i> Luyện gõ lại bài đọc:</h4>
                    <textarea id="reading-input" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-200 bg-gray-50 text-base kanji-font h-32" placeholder="Gõ lại nội dung bài đọc bằng tiếng Nhật vào đây..."></textarea>
                    <div id="reading-feedback" class="text-sm mt-2 min-h-[1.5rem]"></div>
                </div>
            </div>
        </section>

        <!-- 3. Grammar Section -->
        <section class="bg-white rounded-xl md:rounded-2xl shadow-md overflow-hidden fade-in border border-gray-100">
            <div class="bg-purple-50 px-4 md:px-6 py-3 md:py-4 border-b border-purple-100">
                <h2 class="text-lg md:text-xl font-bold text-purple-800"><i class="fas fa-star mr-2"></i>Ngữ Pháp Quan Trọng</h2>
            </div>
            <div class="p-4 md:p-6 grid grid-cols-1 md:grid-cols-2 gap-4" id="grammar-container"></div>
        </section>

        <!-- 4. Vocabulary Flashcards -->
        <section class="fade-in">
            <div class="flex items-center justify-between mb-4 px-2">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800"><i class="fas fa-tags mr-2 text-sky-600"></i>Thẻ Kanji</h2>
                <div class="flex items-center gap-2">
                    <button onclick="shuffleVocab()" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1 rounded-full font-bold transition flex items-center">
                        <i class="fas fa-random mr-1"></i> Shuffle
                    </button>
                    <span class="text-xs md:text-sm text-gray-500 bg-white px-3 py-1 rounded-full shadow-sm" id="vocab-counter">1 / 18</span>
                </div>
            </div>
            
            <div class="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden relative min-h-[450px] md:min-h-[500px]" id="vocab-card-container">
                <!-- Navigation buttons customized for mobile to not cover content -->
                <button onclick="prevVocab()" class="absolute left-0 top-0 bottom-0 px-2 md:px-4 text-gray-400 hover:text-sky-600 hover:bg-sky-50 transition z-10 focus:outline-none bg-white/50 md:bg-transparent"><i class="fas fa-chevron-left text-2xl md:text-3xl"></i></button>
                <button onclick="nextVocab()" class="absolute right-0 top-0 bottom-0 px-2 md:px-4 text-gray-400 hover:text-sky-600 hover:bg-sky-50 transition z-10 focus:outline-none bg-white/50 md:bg-transparent"><i class="fas fa-chevron-right text-2xl md:text-3xl"></i></button>
                
                <div id="vocab-content" class="p-6 md:p-12 text-center card-transition h-full flex flex-col justify-center"></div>
            </div>
        </section>

        <!-- 5. Quiz Section -->
        <section class="bg-white rounded-xl md:rounded-2xl shadow-md overflow-hidden fade-in border border-gray-100 mb-8 md:mb-12">
            <div class="bg-emerald-50 px-4 md:px-6 py-3 md:py-4 border-b border-emerald-100 flex justify-between items-center">
                <h2 class="text-lg md:text-xl font-bold text-emerald-800"><i class="fas fa-question-circle mr-2"></i>Thực Hành</h2>
                <span class="text-xs md:text-sm bg-emerald-200 text-emerald-800 px-3 py-1 rounded-full font-bold" id="quiz-score">0/10</span>
            </div>
            <div class="p-4 md:p-6 space-y-6" id="quiz-container"></div>
            <div class="px-6 py-4 bg-gray-50 border-t border-gray-100 text-center">
                <button onclick="checkQuiz()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-10 rounded-full shadow-lg transform transition active:scale-95 text-sm md:text-base w-full md:w-auto">Nộp Bài</button>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-gray-400 py-6 md:py-8 mt-6">
        <div class="container mx-auto px-4 text-center text-sm">
            <p>&copy; 2025 AzaKanji Kaiwa.</p>
        </div>
    </footer>

    <!-- STROKE ORDER MODAL -->
    <div id="stroke-modal" class="fixed inset-0 z-50 hidden overflow-y-auto" role="dialog" aria-modal="true">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity backdrop-blur-sm" onclick="closeStrokeModal()"></div>
            <div class="inline-block align-bottom bg-white rounded-xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl w-full modal-enter relative">
                <div class="bg-sky-600 px-4 py-3 flex justify-between items-center text-white">
                    <h3 class="font-bold text-lg"><i class="fas fa-pen-nib mr-2"></i>Tập Viết Kanji: <span id="stroke-modal-char" class="text-2xl ml-2"></span></h3>
                    <button onclick="closeStrokeModal()" class="hover:text-gray-200 p-2"><i class="fas fa-times text-xl"></i></button>
                </div>
                <div class="p-4 md:p-6 bg-gray-50 max-h-[80vh] overflow-y-auto">
                    <div class="flex flex-col md:flex-row gap-6 md:gap-8 items-center md:items-start justify-center">
                        <div class="bg-white p-4 rounded-lg shadow border border-gray-200 text-center w-full md:w-auto">
                            <p class="text-sm text-gray-500 mb-2 font-bold uppercase">Mô phỏng</p>
                            <div id="stroke-animation-container" class="w-40 h-40 mx-auto bg-white border border-gray-300 relative stroke-grid-box flex items-center justify-center">
                                <span class="text-gray-400 text-xs">Đang tải...</span>
                            </div>
                            <button onclick="replayStrokeAnimation()" class="mt-3 text-sm bg-sky-100 text-sky-700 px-4 py-2 rounded hover:bg-sky-200 transition w-full"><i class="fas fa-redo mr-1"></i> Viết lại</button>
                        </div>
                        <div class="flex-1 w-full">
                            <p class="text-sm text-gray-500 mb-3 font-bold uppercase text-center md:text-left">Thứ tự nét</p>
                            <div id="stroke-grid-container" class="flex flex-wrap gap-2 justify-center md:justify-start"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA DAY 20 ---
        const lessonData = {
            conversation: {
                polite: [
                    { role: "Tanaka", jp: "鈴木[すずき]さん、日本[にほん]にいるうちに、何[なに]かしたいことがありますか。", romaji: "Suzuki-san, Nihon ni iru uchi ni, nani ka shitai koto ga arimasu ka.", vi: "Anh Suzuki, nhân lúc còn ở Nhật, anh có muốn làm điều gì không?" },
                    { role: "Suzuki", jp: "そうですね。若[わか]いうちに、いろいろな場所[ばしょ]へ旅行[りょこう]したいです。国[くに]によって習慣[しゅうかん]が違[ちが]うので、面白[おもしろ]いと思[おも]います。", romaji: "Sou desu ne. Wakai uchi ni, iroiro na basho e ryokou shitai desu. Kuni ni yotte shuukan ga chigau node, omoshiroi to omoimasu.", vi: "Để xem nào. Nhân lúc còn trẻ, tôi muốn đi du lịch nhiều nơi. Tùy mỗi quốc gia mà phong tục khác nhau nên tôi nghĩ sẽ rất thú vị." },
                    { role: "Tanaka", jp: "いいですね。私[わたし]は父[ちち]のかわりに、会社[かいしゃ]を継[つ]ぐ予定[よてい]です。", romaji: "Ii desu ne. Watashi wa chichi no kawari ni, kaisha o tsugu yotei desu.", vi: "Hay quá nhỉ. Tôi thì dự định sẽ kế nghiệp công ty thay cho bố tôi." },
                    { role: "Suzuki", jp: "すごいですね。でも、社長[しゃちょう]になってからでないと、自由[じゆう]な時間[じかん]がなくなりますよ。", romaji: "Sugoi desu ne. Demo, shachou ni natte kara denaito, jiyuu na jikan ga naku narimasu yo.", vi: "Tuyệt thật. Nhưng mà, nếu chưa trở thành giám đốc thì sẽ không còn thời gian tự do nữa đâu." },
                    { role: "Tanaka", jp: "分[わ]かっています。ちょうど今[いま]、新[あたら]しいプロジェクトを始[はじ]めるところです。話[はな]しているうちに、アイデアを思[おも]いつきました。", romaji: "Wakatte imasu. Choudo ima, atarashii purojekuto o hajimeru tokoro desu. Hanashite iru uchi ni, aidea o omoitsukimashita.", vi: "Tôi hiểu mà. Đúng lúc tôi đang chuẩn bị bắt đầu một dự án mới. Trong lúc nói chuyện, tôi đã nảy ra một ý tưởng." },
                    { role: "Suzuki", jp: "それは良[よ]かったです。", romaji: "Sore wa yokatta desu.", vi: "Thế thì tốt quá." }
                ],
                casual: [
                    { role: "Tanaka", jp: "鈴木[すずき]くん、日本[にほん]にいるうちに、何[なに]かしたいことある？", romaji: "Suzuki-kun, Nihon ni iru uchi ni, nani ka shitai koto aru?", vi: "Suzuki, nhân lúc còn ở Nhật, có muốn làm gì không?" },
                    { role: "Suzuki", jp: "そうだね。若[わか]いうちに、いろいろ旅行[りょこう]したいな。国[くに]によって習慣[しゅうかん]が違[ちが]うから、面白[おもしろ]いと思[おも]うんだ。", romaji: "Sou da ne. Wakai uchi ni, iroiro ryokou shitai na. Kuni ni yotte shuukan ga chigau kara, omoshiroi to omoun da.", vi: "Ừm. Nhân lúc còn trẻ, tớ muốn đi du lịch nhiều nơi. Vì mỗi nước phong tục lại khác nhau nên tớ nghĩ sẽ thú vị lắm." },
                    { role: "Tanaka", jp: "いいね。俺[おれ]は親父[おやじ]のかわりに、会社[かいしゃ]を継[つ]ぐ予定[よてい]だよ。", romaji: "Ii ne. Ore wa oyaji no kawari ni, kaisha o tsugu yotei da yo.", vi: "Hay đó. Tớ thì định kế nghiệp công ty thay bố." },
                    { role: "Suzuki", jp: "マジか。でも、社長[しゃちょう]になってからじゃないと、自由[じゆう]な時間[じかん]がなくなるよ。", romaji: "Maji ka. Demo, shachou ni natte kara ja nai to, jiyuu na jikan ga naku naru yo.", vi: "Thật á? Nhưng mà, nếu chưa làm giám đốc thì sẽ không có thời gian rảnh đâu." },
                    { role: "Tanaka", jp: "分[わ]かってるよ。ちょうど今[いま]、新[あたら]しいプロジェクトを始[はじ]めるところなんだ。話[はな]してるうちに、アイデア浮[う]かんできた。", romaji: "Wakatteru yo. Choudo ima, atarashii purojekuto o hajimeru tokoro nanda. Hanashiteru uchi ni, aidea ukande kita.", vi: "Tớ biết mà. Đúng lúc tớ đang chuẩn bị bắt đầu dự án mới. Trong lúc nói chuyện lại nảy ra ý tưởng." },
                    { role: "Suzuki", jp: "そりゃよかった。", romaji: "Sorya yokatta.", vi: "Thế thì tốt." }
                ]
            },
            reading: {
                jp: "私[わたし]は旅行[りょこう]で留守[るす]の間[あいだ]、友達[ともだち]にペットの世話[せわ]を頼[たの]みました。友達[ともだち]は私[わたし]のかわりに、毎日[まいにち]えさをくれました。旅行[りょこう]から帰[かえ]ってきたところに、ペットが元気[げんき]に迎[むか]えてくれました。安心[あんしん]してからでないと、ゆっくり休[やす]めません。国[くに]によってペットの育[そだ]て方[かた]も違[ちが]うそうです。日本[にほん]にいるうちに、もっと多[おお]くの文化[ぶんか]に触[ふ]れたいです。",
                romaji: "Watashi wa ryokou de rusu no aida, tomodachi ni petto no sewa o tanomimashita. Tomodachi wa watashi no kawari ni, mainichi esa o kuremashita. Ryokou kara kaette kita tokoro ni, petto ga genki ni mukaete kuremashita. Anshin shite kara denaito, yukkuri yasumemasen. Kuni ni yotte petto no sodatekata mo chigau sou desu. Nihon ni iru uchi ni, motto ooku no bunka ni furetai desu.",
                vi: "Trong khi tôi đi du lịch vắng nhà, tôi đã nhờ bạn bè chăm sóc thú cưng. Bạn tôi đã thay tôi cho chúng ăn mỗi ngày. Đúng lúc tôi vừa từ chuyến du lịch trở về thì thú cưng đã khỏe mạnh chào đón. Nếu chưa yên tâm thì tôi không thể nghỉ ngơi thong thả được. Nghe nói tùy mỗi quốc gia mà cách nuôi thú cưng cũng khác nhau. Nhân lúc còn ở Nhật, tôi muốn được tiếp xúc với nhiều nền văn hóa hơn nữa."
            },
            grammar: [
                { rule: "～うちに", formula: "Vる/Vている/Vない/Aい/Aな/Nの + うちに", mean: "Nhân lúc, trong khi (trước khi tình trạng thay đổi).", ex: "雨[あめ]が降[ふ]らないうちに、帰[かえ]りましょう。", vi: "Nhân lúc trời chưa mưa, chúng ta hãy về thôi." },
                { rule: "～間 / 間に", formula: "Vる/Vている/Nの + 間/間に", mean: "Trong khi, trong suốt (hành động diễn ra song song).", ex: "お母[かあ]さんが昼寝[ひるね]をしている間[あいだ]、子供[こども]たちはテレビを見[み]ていた。", vi: "Trong khi mẹ ngủ trưa, lũ trẻ đã xem TV." },
                { rule: "～てからでないと", formula: "Vてから + でないと / でなければ", mean: "Nếu chưa ... thì không thể ... (Điều kiện kiên quyết).", ex: "運転免許[うんてんめんきょ]を取[と]ってからでなければ、車[くるま]を運転[うんてん]してはいけない。", vi: "Nếu chưa lấy được bằng lái xe thì không được lái xe." },
                { rule: "～ところです", formula: "Vる/Vている/Vた + ところです", mean: "Đúng lúc sắp/đang/vừa mới... (nhấn mạnh thời điểm).", ex: "ちょうど今[いま]から料理[りょうり]を始[はじ]めるところです。", vi: "Đúng lúc bây giờ tôi sắp bắt đầu nấu ăn." },
                { rule: "～によって", formula: "N + によって", mean: "Tùy thuộc vào... / Bởi...", ex: "人[ひと]によって考[かんが]え方[かた]が違[ちが]います。", vi: "Tùy mỗi người mà cách suy nghĩ khác nhau." },
                { rule: "～のかわりに", formula: "Nの + かわりに", mean: "Thay cho... / Bù lại...", ex: "今日[きょう]は母[はは]のかわりに、私[わたし]が晩[ばん]ごはんを作[つく]ります。", vi: "Hôm nay tôi sẽ nấu bữa tối thay cho mẹ." }
            ],
            vocab: [
                { 
                    k: "若", h: "わか", on: "ジャク", kun: "わか.い", m: "Nhược/Trẻ", hv: "NHƯỢC", 
                    ti: "Người tay phải (**右**) cầm Cỏ (**艹**) thường rất Trẻ.", 
                    ta: "**Oa cà** (**Waka**) phê quá, uống vào thấy **Trẻ** ra.", 
                    compounds: [{w: "若い", r: "わかい", m: "Trẻ"}] 
                },
                { 
                    k: "旅", h: "たび", on: "リョ", kun: "たび", m: "Lữ/Du lịch", hv: "LỮ", 
                    ti: "Phương (**方**) trời xa có người nằm (**𠂉**) ăn mặc rách rưới (**衣**) đi Lữ hành.", 
                    ta: "Đi **Du lịch** mà mang theo cái **Rổ** (**Ryo**) làm gì?", 
                    compounds: [{w: "旅行", r: "りょこう", m: "Du lịch"}] 
                },
                { 
                    k: "慣", h: "な", on: "カン", kun: "な.れる", m: "Quán/Quen", hv: "QUÁN", 
                    ti: "Tâm (**忄**) Quen với việc Xuyên (**貫**) qua khó khăn.", 
                    ta: "**Can** (**Kan**) ngăn mãi nhưng nó vẫn **Quen** thói cũ.", 
                    compounds: [{w: "習慣", r: "しゅうかん", m: "Tập quán/Thói quen"}] 
                },
                { 
                    k: "継", h: "つ", on: "ケイ", kun: "つ.ぐ", m: "Kế/Kế thừa", hv: "KẾ", 
                    ti: "Sợi tơ (**糸**) nối tiếp nhau như hạt gạo (**米**) được bao bọc (**乚**) để Kế thừa.", 
                    ta: "Kế toán trưởng tên là **Kê** (**Kei**).", 
                    compounds: [{w: "継ぐ", r: "つぐ", m: "Kế thừa"}] 
                },
                { 
                    k: "定", h: "さだ", on: "テイ", kun: "さだ.める", m: "Định/Quyết định", hv: "ĐỊNH", 
                    ti: "Dưới mái nhà (**宀**) Chân (**疋**) đứng vững là sự ổn Định.", 
                    ta: "Cái **Tay** (**Tei**) này **Định** làm gì đấy?", 
                    compounds: [{w: "予定", r: "よてい", m: "Dự định"}] 
                },
                { 
                    k: "由", h: "よし", on: "ユ", kun: "よし", m: "Do/Lý do", hv: "DO", 
                    ti: "Ruộng (**田**) mọc lên cây lúa là Do tự nhiên.", 
                    ta: "Lý **Do** là **You** (**Yu**) đó.", 
                    compounds: [{w: "自由", r: "じゆう", m: "Tự do"}] 
                },
                { 
                    k: "留", h: "と", on: "リュウ", kun: "と.める", m: "Lưu/Ở lại", hv: "LƯU", 
                    ti: "Ở ngoài đồng (**田**) dùng dao (**卯**) để Lưu giữ lại.", 
                    ta: "**Lưu** lại đây uống **Rượu** (**Ryuu**) nào.", 
                    compounds: [{w: "留守", r: "るす", m: "Vắng nhà"}] 
                },
                { 
                    k: "守", h: "まも", on: "シュ", kun: "まも.る", m: "Thủ/Bảo vệ", hv: "THỦ", 
                    ti: "Ở trong nhà (**宀**) dùng Tấc (**寸**) sắt để Thủ tiêu kẻ địch.", 
                    ta: "Cầu **Thủ** (**Shu**) bảo vệ khung thành.", 
                    compounds: [{w: "留守", r: "るす", m: "Vắng nhà"}, {w: "守る", r: "まもる", m: "Bảo vệ"}] 
                },
                { 
                    k: "世", h: "よ", on: "セ", kun: "よ", m: "Thế/Thế giới", hv: "THẾ", 
                    ti: "Ba mươi (**卅**) năm là một Thế hệ.", 
                    ta: "**Xe** (**Se**) cộ chạy đầy **Thế** giới.", 
                    compounds: [{w: "世話", r: "せわ", m: "Chăm sóc"}] 
                },
                { 
                    k: "頼", h: "たの", on: "ライ", kun: "たの.む", m: "Lại/Nhờ cậy", hv: "LẠI", 
                    ti: "Thúc (**束**) ép người ta phải tiêu Tiền (**貝**) là ỷ Lại.", 
                    ta: "Tương **Lai** (**Rai**) phải **Nhờ** cậy vào bạn.", 
                    compounds: [{w: "頼む", r: "たのむ", m: "Nhờ cậy"}] 
                },
                { 
                    k: "育", h: "そだ", on: "イク", kun: "そだ.てる", m: "Dục/Nuôi", hv: "DỤC", 
                    ti: "Đứa con (**厶**) lớn lên nhờ Thịt (**月**) là Giáo Dục/Nuôi dưỡng.", 
                    ta: "**Đi cư** (**Iku**) trú để **Nuôi** con.", 
                    compounds: [{w: "育てる", r: "そだてる", m: "Nuôi nấng"}] 
                },
                { 
                    k: "触", h: "さわ", on: "ショク", kun: "ふ.れる", m: "Xúc/Chạm", hv: "XÚC", 
                    ti: "Cái Sừng (**角**) chạm vào Con trùng (**虫**) là Tiếp xúc.", 
                    ta: "Tiếp **Xúc** gây **Sốc** (**Shoku**).", 
                    compounds: [{w: "触れる", r: "ふれる", m: "Tiếp xúc/Chạm"}] 
                },
                { 
                    k: "違", h: "ちが", on: "イ", kun: "ちが.う", m: "Vi/Khác", hv: "VI", 
                    ti: "Vi (**韋**) phạm luật giao thông khi đi đường (**辶**) Khác.", 
                    ta: "**Chi gà** (**Chiga**) này **Khác** chi gà kia.", 
                    compounds: [{w: "違う", r: "ちがう", m: "Khác/Sai"}] 
                },
                { 
                    k: "迎", h: "むか", on: "ゲイ", kun: "むか.える", m: "Nghênh/Đón", hv: "NGHÊNH", 
                    ti: "Đi (**辶**) ra Ngẩng cao đầu (**卬**) Nghênh đón.", 
                    ta: "Người **Gay** (**Gei**) đi **Đón** khách.", 
                    compounds: [{w: "迎える", r: "むかえる", m: "Đón"}] 
                },
                { 
                    k: "安", h: "やす", on: "アン", kun: "やす.い", m: "An/Rẻ", hv: "AN", 
                    ti: "Người phụ nữ (**女**) ở trong nhà (**宀**) thì An toàn.", 
                    ta: "**Ăn** (**An**) toàn là trên hết.", 
                    compounds: [{w: "安心", r: "あんしん", m: "An tâm"}] 
                },
                { 
                    k: "文", h: "ふみ", on: "ブン", kun: "-", m: "Văn/Văn hóa", hv: "VĂN", 
                    ti: "Đầu (**亠**) đội nón chéo chân (**乂**) làm Văn.", 
                    ta: "Nhật **Bản** (**Bun**) có nền **Văn** hóa đặc sắc.", 
                    compounds: [{w: "文化", r: "ぶんか", m: "Văn hóa"}] 
                },
                { 
                    k: "化", h: "ば", on: "カ", kun: "か.わる", m: "Hóa/Biến hóa", hv: "HÓA", 
                    ti: "Người (**亻**) ngồi so (**匕**) găng Biến hóa.", 
                    ta: "**Ca** (**Ka**) sĩ **Hóa** trang.", 
                    compounds: [{w: "文化", r: "ぶんか", m: "Văn hóa"}] 
                },
                { 
                    k: "掃", h: "は", on: "ソウ", kun: "は.く", m: "Tảo/Quét", hv: "TẢO", 
                    ti: "Tay (**扌**) cầm cái chổi (**帚**) để Quét dọn.", 
                    ta: "**Xô** (**Sou**) chậu dùng để **Quét** dọn.", 
                    compounds: [{w: "掃除", r: "そうじ", m: "Dọn dẹp"}] 
                }
            ],
            quiz: [
                { type: 'mcq', question: "若[わか]い（___）、たくさん勉強[べんきょう]したいです。", options: ["うちに", "間に", "ところで"], correct: 0, explain: "～うちに: Nhân lúc (trạng thái còn chưa thay đổi) - Nhân lúc còn trẻ." },
                { type: 'fill', question: "夏休[なつやす]みの（___）、ずっと田舎[いなか]にいました。", answer: "間", explain: "～間 (Aida): Trong suốt khoảng thời gian (hành động liên tục)." },
                { type: 'mcq', question: "人[ひと]（___）考[かんが]え方[かた]が違[ちが]います。", options: ["のかわりに", "によって", "の途中で"], correct: 1, explain: "～によって: Tùy thuộc vào (Mỗi người có cách suy nghĩ khác nhau)." },
                { type: 'audio', question: "Nghe và gõ lại câu bạn vừa nghe:", jp: "お母さんが昼寝をしている間、子供たちはテレビを見ていた。", explain: "Okaasan ga hirune o shiteiru aida, kodomotachi wa terebi o miteita (Trong lúc mẹ ngủ, bọn trẻ xem TV)." },
                { type: 'mcq', question: "日本[にほん]にいる（___）、富士山[ふじさん]に登[のぼ]りたいです。", options: ["間に", "うちに", "あとで"], correct: 1, explain: "～うちに: Nhân lúc còn ở Nhật (cơ hội)." },
                { type: 'fill', question: "父[ちち]の（___）、私[わたし]が会議[かいぎ]に出[で]ます。", answer: "かわりに", explain: "～のかわりに: Thay cho (Thay cho bố)." },
                { type: 'mcq', question: "よく考[かんが]えてから（___）、返事[へんじ]ができません。", options: ["でないと", "うちに", "最中に"], correct: 0, explain: "～てからでないと: Nếu chưa ... thì không thể (Nếu chưa suy nghĩ kỹ thì không thể trả lời)." },
                { type: 'mcq', question: "今[いま]、ちょうどご飯[はん]を食[た]べた（___）です。", options: ["ところ", "ばかり", "はず"], correct: 0, explain: "～たところ: Vừa mới làm xong (ngay tức thì)." },
                { type: 'mcq', question: "Từ '習慣' đọc là gì?", options: ["しゅうかん", "じゅかん", "きょうかん"], correct: 0, explain: "習慣 (Shuukan) - Tập quán/Thói quen." },
                { type: 'audio', question: "Nghe và điền từ còn thiếu: 国によってペットの___も違うそうです。", jp: "国によってペットの育て方も違うそうです。", explain: "Sodatekata (Cách nuôi)." }
            ]
        };

        // --- STATE MANAGEMENT & SETTINGS ---
        let currentMode = 'polite';
        let settings = { hideFurigana: false, showRomaji: false, showVietnamese: false, currentSpeed: 1.0 };
        let progress = { conversation: false, reading: false, grammar: false, vocab: 0, quiz: 0 };
        let vocabSeen = new Set();
        let currentVocabIndex = 0;
        let currentStrokeSvg = null;
        let quizScoreCurrent = 0;
        let jpVoice = null;
        let recognition = null;
        let isRecognizing = false;

        // --- AUDIO & SPEECH ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            if (type === 'correct') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(500, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1); gain.gain.setValueAtTime(0.2, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3); osc.start(); osc.stop(audioCtx.currentTime + 0.3);
            } else {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(200, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.2); gain.gain.setValueAtTime(0.2, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2); osc.start(); osc.stop(audioCtx.currentTime + 0.2);
            }
        }

        function loadVoices() {
            const voices = window.speechSynthesis.getVoices();
            jpVoice = voices.find(v => v.name === 'Google 日本語') || voices.find(v => v.lang === 'ja-JP') || null;
        }
        window.speechSynthesis.onvoiceschanged = loadVoices;

        function cleanText(text) { return text ? text.replace(/\[.*?\]/g, '') : ''; }
        function parseFurigana(text) { return text ? text.replace(/([^\[\]]+)\[(.+?)\]/g, '<ruby>$1<rt>$2</rt></ruby>') : ''; }

        function speak(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(cleanText(text));
                u.lang = 'ja-JP'; u.rate = settings.currentSpeed;
                if(jpVoice) u.voice = jpVoice;
                window.speechSynthesis.speak(u);
            }
        }

        function initSpeech() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.lang = 'ja-JP';
                recognition.continuous = false;
                recognition.interimResults = false;
            }
        }

        function startListening(targetInputId) {
            if (!recognition) { alert("Trình duyệt không hỗ trợ nhận diện giọng nói."); return; }
            if (isRecognizing) { recognition.stop(); return; }
            const btn = document.getElementById(`mic-btn-${targetInputId}`);
            const input = document.getElementById(targetInputId);
            document.querySelectorAll('.mic-listening').forEach(el => el.classList.remove('mic-listening'));
            recognition.onstart = () => { isRecognizing = true; btn.classList.add('mic-listening'); };
            recognition.onend = () => { isRecognizing = false; btn.classList.remove('mic-listening'); };
            recognition.onresult = (event) => { input.value = event.results[0][0].transcript; input.dispatchEvent(new Event('input')); };
            try { recognition.start(); } catch (e) { isRecognizing = false; }
        }

        // --- CORE FUNCTIONS ---
        function saveSettings() { localStorage.setItem('azaSettings_day20', JSON.stringify(settings)); }
        function loadSettings() {
            const saved = localStorage.getItem('azaSettings_day20');
            if (saved) settings = { ...settings, ...JSON.parse(saved) };
        }

        function updateProgress() {
            let points = 0;
            const convoInputs = document.querySelectorAll('#conversation-container .correct-input');
            const totalConvoLines = lessonData.conversation.polite.length;
            if (totalConvoLines > 0) points += (convoInputs.length / totalConvoLines) * 30;
            const readingInput = document.getElementById('reading-input');
            if(readingInput && readingInput.value.length > 20) points += 10;
            if(lessonData.vocab.length > 0) points += (vocabSeen.size / lessonData.vocab.length) * 30;
            if(lessonData.quiz.length > 0) points += (quizScoreCurrent / lessonData.quiz.length) * 30;
            const percent = Math.min(100, Math.round(points));
            document.getElementById('progress-bar').style.width = `${percent}%`;
            document.getElementById('progress-text').innerText = `${percent}%`;
        }

        function checkTyping(input, correctText, feedbackDiv) {
            const userText = input.value;
            const targetText = cleanText(correctText);
            let html = '';
            for (let i = 0; i < userText.length; i++) {
                if (i >= targetText.length) html += `<span class="incorrect-char">${userText[i]}</span>`;
                else if (userText[i] === targetText[i]) html += `<span class="correct-char">${userText[i]}</span>`;
                else html += `<span class="incorrect-char">${userText[i]}</span>`;
            }
            feedbackDiv.innerHTML = html;
            if (userText === targetText) {
                input.classList.add('correct-input'); input.classList.remove('wrong-input');
                feedbackDiv.innerHTML += ' <span class="text-green-600 ml-2 font-bold text-xs"><i class="fas fa-check-circle"></i> Chính xác!</span>';
                playSound('correct'); updateProgress();
            } else if (userText.length > 0) {
                input.classList.add('wrong-input'); input.classList.remove('correct-input');
            } else {
                input.classList.remove('correct-input', 'wrong-input');
            }
        }

        // --- RENDERERS ---
        function renderConversation() {
            const container = document.getElementById('conversation-container');
            const lines = lessonData.conversation[currentMode];
            container.innerHTML = lines.map((line, idx) => `
                <div class="flex gap-2 md:gap-4 fade-in ${line.role === 'Tanaka' ? '' : 'flex-row-reverse'} p-1 md:p-2 rounded-lg transition-colors duration-300">
                    <div class="flex-shrink-0 w-8 h-8 md:w-12 md:h-12 rounded-full flex items-center justify-center font-bold text-white shadow-md text-sm md:text-base ${line.role === 'Tanaka' ? 'bg-blue-500' : 'bg-green-500'}">${line.role[0]}</div>
                    <div class="flex-1 max-w-[95%] md:max-w-[90%]">
                        <div class="text-[10px] md:text-xs text-gray-500 mb-1 ${line.role === 'Tanaka' ? 'text-left' : 'text-right'}">${line.role}</div>
                        <div class="bg-white p-3 md:p-4 rounded-xl md:rounded-2xl shadow-sm border border-gray-200 relative group transition hover:shadow-md ${line.role === 'Tanaka' ? 'rounded-tl-none' : 'rounded-tr-none bg-green-50'}">
                            <p class="text-base md:text-lg text-gray-800 kanji-font leading-relaxed mb-1 pr-6 md:pr-0">${parseFurigana(line.jp)}</p>
                            <p class="text-sm text-gray-500 romaji-text hidden italic mb-1">${line.romaji}</p>
                            <p class="text-xs md:text-sm text-gray-500 vi-trans border-t border-gray-100 pt-2 mt-2">${line.vi}</p>
                            <button onclick="speak('${line.jp}')" class="absolute top-2 right-2 text-gray-300 hover:text-sky-600 transition"><i class="fas fa-volume-up"></i></button>
                            <div class="mt-3 pt-2 border-t border-gray-100">
                                <div class="flex gap-2">
                                    <input type="text" id="convo-input-${idx}" class="flex-1 text-base p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-200 transition bg-gray-50 placeholder-gray-300 min-w-0" placeholder="Nghe và gõ lại..." oninput="checkTyping(this, '${line.jp}', this.parentElement.nextElementSibling)">
                                    <button id="mic-btn-convo-input-${idx}" onclick="startListening('convo-input-${idx}')" class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-2 md:px-3 rounded-lg transition flex-shrink-0"><i class="fas fa-microphone"></i></button>
                                </div>
                                <div class="h-auto md:h-5 mt-1 text-xs md:text-sm pl-1 kanji-font break-all"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            updateUI();
        }

        function playAllConversation() {
            const lines = lessonData.conversation[currentMode];
            let i = 0;
            function playNext() {
                if (i >= lines.length) return;
                const allLines = document.querySelectorAll('#conversation-container > div');
                allLines.forEach(el => el.classList.remove('playing-line'));
                if (allLines[i]) {
                    allLines[i].classList.add('playing-line');
                    allLines[i].scrollIntoView({behavior: "smooth", block: "center"});
                }
                speak(lines[i].jp);
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(cleanText(lines[i].jp));
                u.lang = 'ja-JP'; u.rate = settings.currentSpeed;
                if(jpVoice) u.voice = jpVoice;
                u.onend = () => { i++; setTimeout(playNext, 500); };
                window.speechSynthesis.speak(u);
            }
            window.speechSynthesis.cancel();
            playNext();
        }

        function switchMode(mode) {
            currentMode = mode;
            document.getElementById('tab-polite').className = mode === 'polite' ? "tab-btn tab-active flex-1 md:flex-none px-2 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-bold text-center" : "tab-btn tab-inactive flex-1 md:flex-none px-2 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-bold ml-1 text-center";
            document.getElementById('tab-casual').className = mode === 'casual' ? "tab-btn tab-active flex-1 md:flex-none px-2 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-bold ml-1 text-center" : "tab-btn tab-inactive flex-1 md:flex-none px-2 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-bold ml-1 text-center";
            renderConversation();
        }

        function renderReading() {
            document.getElementById('reading-text').innerHTML = parseFurigana(lessonData.reading.jp);
            document.getElementById('reading-romaji').innerText = lessonData.reading.romaji;
            document.getElementById('reading-vi').innerText = lessonData.reading.vi;
            const input = document.getElementById('reading-input');
            const feedback = document.getElementById('reading-feedback');
            input.oninput = () => {
                if(input.value.length > 50) updateProgress();
                checkTyping(input, lessonData.reading.jp, feedback); 
            };
            if(!document.getElementById('reading-play-btn')) {
                const btn = document.createElement('button');
                btn.id = 'reading-play-btn';
                btn.className = "mt-4 text-orange-500 hover:text-orange-700 font-bold flex items-center text-sm transition";
                btn.innerHTML = '<i class="fas fa-volume-up mr-2"></i> Nghe bài đọc';
                btn.onclick = () => speak(lessonData.reading.jp);
                document.getElementById('reading-text').parentNode.insertBefore(btn, document.getElementById('reading-text').nextSibling);
            }
        }

        function renderGrammar() {
            const container = document.getElementById('grammar-container');
            container.innerHTML = lessonData.grammar.map(g => `
                <div class="bg-white p-4 md:p-5 rounded-xl border border-purple-100 shadow-sm hover:border-purple-300 transition group">
                    <h3 class="font-bold text-purple-700 mb-1 text-base md:text-lg flex items-center"><span class="w-2 h-2 bg-purple-500 rounded-full mr-2 flex-shrink-0"></span>${g.rule}</h3>
                    <div class="mb-2 pl-4"><span class="bg-red-100 text-red-600 text-[10px] md:text-xs px-2 py-1 rounded font-bold">Công thức:</span> <span class="text-gray-700 text-xs md:text-sm kanji-font break-all">${g.formula}</span></div>
                    <p class="text-gray-600 text-xs md:text-sm mb-3 pl-4">${g.mean}</p>
                    <div class="bg-purple-50 p-3 rounded-lg text-xs md:text-sm text-gray-700 kanji-font relative pl-4">
                        <i class="fas fa-quote-left text-purple-200 absolute top-1 left-1 text-xs"></i>${parseFurigana(g.ex)}
                        <p class="text-[10px] md:text-xs text-purple-600 mt-1 italic">${g.vi}</p>
                        <button onclick="speak('${g.ex}')" class="absolute top-2 right-2 text-purple-300 hover:text-purple-600 transition md:opacity-0 md:group-hover:opacity-100"><i class="fas fa-volume-up"></i></button>
                    </div>
                </div>
            `).join('');
        }

        // --- VOCAB FLASHCARDS ---
        function getKanjiHex(kanji) { return kanji.charCodeAt(0).toString(16).padStart(5, '0'); }
        async function fetchKanjiSvg(hex) {
            try {
                const response = await fetch(`https://cdn.jsdelivr.net/gh/KanjiVG/kanjivg/kanji/${hex}.svg`);
                if (!response.ok) throw new Error('Not found');
                return await response.text();
            } catch (e) { return null; }
        }

        async function showStrokeOrder(kanji) {
            const hex = getKanjiHex(kanji);
            document.getElementById('stroke-modal').classList.remove('hidden');
            document.getElementById('stroke-modal-char').innerText = kanji;
            const animContainer = document.getElementById('stroke-animation-container');
            const gridContainer = document.getElementById('stroke-grid-container');
            animContainer.innerHTML = '<span class="text-gray-400 text-xs">Đang tải...</span>';
            const svgContent = await fetchKanjiSvg(hex);
            if (!svgContent) { animContainer.innerHTML = "<p class='text-red-500'>Lỗi</p>"; gridContainer.innerHTML = ""; return; }
            
            animContainer.innerHTML = svgContent;
            const mainSvg = animContainer.querySelector('svg');
            mainSvg.setAttribute('width', '100%'); mainSvg.setAttribute('height', '100%');
            const paths = mainSvg.querySelectorAll('path');
            paths.forEach(p => { 
                const len = p.getTotalLength(); p.style.strokeDasharray = len; p.style.strokeDashoffset = len; 
                p.style.stroke = "#333"; p.style.strokeWidth = "4"; p.style.fill = "none"; 
                p.style.strokeLinecap = "round"; p.style.strokeLinejoin = "round"; 
            });
            currentStrokeSvg = mainSvg;
            replayStrokeAnimation();

            gridContainer.innerHTML = '';
            for(let i=0; i<paths.length; i++) {
                const box = document.createElement('div');
                box.className = "w-12 h-12 md:w-20 md:h-20 bg-white border border-gray-200 relative stroke-grid-box flex items-center justify-center";
                const parser = new DOMParser();
                const svgClone = parser.parseFromString(svgContent, "image/svg+xml").querySelector('svg');
                svgClone.setAttribute('width', '100%'); svgClone.setAttribute('height', '100%');
                svgClone.querySelectorAll('path').forEach((p, idx) => {
                    p.style.fill="none"; p.style.strokeLinecap="round"; p.style.strokeLinejoin="round";
                    if(idx < i) { p.style.stroke="#9ca3af"; p.style.strokeWidth="3"; }
                    else if(idx === i) { p.style.stroke="#000"; p.style.strokeWidth="4"; }
                    else p.style.display="none";
                });
                box.appendChild(svgClone);
                gridContainer.appendChild(box);
            }
        }

        function replayStrokeAnimation() {
            if(!currentStrokeSvg) return;
            const paths = currentStrokeSvg.querySelectorAll('path');
            paths.forEach(p => { p.style.transition = 'none'; p.style.strokeDashoffset = p.getTotalLength(); });
            void currentStrokeSvg.offsetWidth;
            let delay = 0;
            paths.forEach(p => {
                p.style.transition = `stroke-dashoffset 0.6s ease-in-out ${delay}s`;
                p.style.strokeDashoffset = '0';
                delay += 0.6;
            });
        }
        function closeStrokeModal() { document.getElementById('stroke-modal').classList.add('hidden'); }

        function renderVocab() {
            vocabSeen.add(currentVocabIndex);
            updateProgress();
            const container = document.getElementById('vocab-content');
            const v = lessonData.vocab[currentVocabIndex];
            const compoundsHtml = v.compounds ? v.compounds.map(c => 
                `<div class="flex justify-between items-center bg-gray-50 px-3 py-2 rounded mb-1 cursor-pointer hover:bg-gray-100" onclick="speak('${c.r}')">
                    <span class="text-gray-800 font-bold">${c.w}</span>
                    <span class="text-gray-500 text-xs">${c.r}</span>
                    <span class="text-sky-600 text-xs text-right">${c.m}</span>
                    <i class="fas fa-volume-up text-xs text-gray-300 ml-2"></i>
                </div>`
            ).join('') : '';

            container.innerHTML = `
                <div class="animate-fade-in relative">
                    <div class="text-5xl md:text-6xl font-bold text-gray-800 kanji-font mb-2 cursor-pointer hover:text-sky-600 transition" onclick="showStrokeOrder('${v.k}')" title="Bấm để xem cách viết">${v.k}</div>
                    <button onclick="showStrokeOrder('${v.k}')" class="text-xs bg-sky-100 text-sky-700 px-3 py-1 rounded-full mb-2 hover:bg-sky-200 transition"><i class="fas fa-pen-nib mr-1"></i> Tập viết</button>
                    <div class="grid grid-cols-2 gap-2 md:gap-4 text-center mb-4 text-sm bg-gray-50 p-2 rounded-lg">
                        <div class="flex flex-col items-center"><span class="text-[10px] md:text-xs text-gray-400 block uppercase font-bold mb-1">On'yomi</span>
                            <div class="flex items-center gap-1 md:gap-2 flex-wrap justify-center"><span class="text-gray-800 font-bold text-xs md:text-sm">${v.on}</span><button onclick="speak('${v.on}')" class="w-5 h-5 rounded-full bg-white shadow-sm flex items-center justify-center text-sky-500 hover:bg-sky-50"><i class="fas fa-volume-up text-[10px]"></i></button></div>
                        </div>
                        <div class="flex flex-col items-center"><span class="text-[10px] md:text-xs text-gray-400 block uppercase font-bold mb-1">Kun'yomi</span>
                            <div class="flex items-center gap-1 md:gap-2 flex-wrap justify-center"><span class="text-gray-800 font-bold text-xs md:text-sm">${v.kun}</span><button onclick="speak('${v.kun.replace(/\./g, '')}')" class="w-5 h-5 rounded-full bg-white shadow-sm flex items-center justify-center text-sky-500 hover:bg-sky-50"><i class="fas fa-volume-up text-[10px]"></i></button></div>
                        </div>
                    </div>
                    <div class="inline-block text-[10px] md:text-xs font-bold text-white bg-gray-400 px-3 py-1 rounded-full mb-3 md:mb-4 tracking-wide">${v.hv}</div>
                    <div class="text-sky-700 font-bold text-xl md:text-2xl mb-4 md:mb-6 border-b border-gray-100 pb-2 md:pb-4">${v.m}</div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 text-left max-w-2xl mx-auto">
                        <div class="bg-orange-50 p-3 md:p-4 rounded-xl border border-orange-100"><div class="font-bold text-orange-600 mb-2 flex items-center text-sm"><i class="fas fa-image mr-2"></i> Mẹo Hình Ảnh</div><div class="text-gray-700 text-xs md:text-sm leading-relaxed">${v.ti.replace(/\*\*(.*?)\*\*/g, '<span class="text-red-600 font-bold">$1</span>')}</div></div>
                        <div class="bg-blue-50 p-3 md:p-4 rounded-xl border border-blue-100"><div class="font-bold text-blue-600 mb-2 flex items-center text-sm"><i class="fas fa-volume-up mr-2"></i> Mẹo Âm Thanh</div><div class="text-gray-700 text-xs md:text-sm leading-relaxed">${v.ta.replace(/\*\*(.*?)\*\*/g, '<span class="text-indigo-600 font-bold">$1</span>')}</div></div>
                    </div>
                    ${compoundsHtml ? `<div class="mt-6 md:mt-8 pt-4 md:pt-6 border-t border-gray-100"><div class="text-xs md:text-sm text-gray-400 mb-2 font-bold uppercase tracking-wide text-center">Từ ghép</div><div class="kanji-font text-gray-600 max-w-sm mx-auto text-left">${compoundsHtml}</div></div>` : ''}
                </div>
            `;
            document.getElementById('vocab-counter').innerText = `${currentVocabIndex + 1} / ${lessonData.vocab.length}`;
        }
        function prevVocab() { if (currentVocabIndex > 0) { currentVocabIndex--; renderVocab(); } }
        function nextVocab() { if (currentVocabIndex < lessonData.vocab.length - 1) { currentVocabIndex++; renderVocab(); } }
        function shuffleVocab() {
            for (let i = lessonData.vocab.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [lessonData.vocab[i], lessonData.vocab[j]] = [lessonData.vocab[j], lessonData.vocab[i]]; }
            currentVocabIndex = 0; renderVocab();
        }
        document.addEventListener('keydown', (e) => { if (e.key === 'ArrowLeft') prevVocab(); if (e.key === 'ArrowRight') nextVocab(); });

        // --- QUIZ ---
        function renderQuiz() {
            const container = document.getElementById('quiz-container');
            container.innerHTML = lessonData.quiz.map((q, idx) => `
                <div class="quiz-item border-b border-gray-100 pb-4 last:border-0">
                    <p class="font-bold text-gray-800 mb-2 md:mb-3 text-sm md:text-base"><span class="text-emerald-600 mr-2">Câu ${idx + 1}:</span> ${q.type === 'audio' ? q.question : parseFurigana(q.question)}</p>
                    <div class="space-y-2">
                        ${q.type === 'audio' ? `<button class="speak-btn mb-2 flex items-center text-sky-600 font-bold text-sm" onclick="speak('${q.jp}')"><i class="fas fa-volume-up mr-2"></i> Nghe câu hỏi</button><input type="text" class="w-full p-2 border rounded text-base" placeholder="Nhập câu bạn nghe được..." data-idx="${idx}">` 
                        : q.type === 'fill' ? `<input type="text" class="w-full p-2 border rounded fill-input text-base" placeholder="Điền từ còn thiếu..." data-idx="${idx}">` 
                        : q.options.map((opt, optIdx) => `<label class="flex items-center p-2 md:p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition quiz-option text-sm md:text-base" data-q="${idx}" data-opt="${optIdx}"><input type="radio" name="q${idx}" value="${optIdx}" class="mr-3 text-emerald-600 focus:ring-emerald-500"><span class="kanji-font">${parseFurigana(opt)}</span></label>`).join('')}
                    </div>
                    <div class="quiz-feedback hidden mt-3 p-3 rounded-lg text-sm" id="feedback-${idx}"></div>
                </div>
            `).join('');
            document.getElementById('quiz-score').innerText = `0/${lessonData.quiz.length}`;
        }

        function checkQuiz() {
            let score = 0;
            lessonData.quiz.forEach((q, idx) => {
                const feedbackEl = document.getElementById(`feedback-${idx}`);
                feedbackEl.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
                let isCorrect = false;
                if (q.type === 'audio') {
                    const input = document.querySelector(`input[data-idx="${idx}"]`);
                    isCorrect = input.value.trim() === cleanText(q.jp);
                } else if (q.type === 'fill') {
                    const input = document.querySelector(`input[data-idx="${idx}"]`);
                    isCorrect = input.value.trim() === q.answer;
                } else {
                    const selected = document.querySelector(`input[name="q${idx}"]:checked`);
                    if (selected && q.options && q.options[q.correct]) {
                         isCorrect = selected.parentElement.innerText.trim() === q.options[q.correct]; // Match text content
                    } else if (selected && typeof q.correct !== 'undefined') {
                         isCorrect = parseInt(selected.value) === q.correct;
                    }
                }
                
                if (isCorrect) {
                    score++;
                    feedbackEl.innerHTML = `<i class="fas fa-check-circle mr-2"></i> Chính xác! <br><span class="text-xs mt-1 block opacity-80">${q.explain || ''}</span>`;
                    feedbackEl.classList.add('bg-green-100', 'text-green-800');
                } else {
                    const ans = q.type === 'mcq' ? q.options[q.correct] : (q.type === 'audio' ? q.jp : q.answer);
                    feedbackEl.innerHTML = `<i class="fas fa-times-circle mr-2"></i> Sai rồi. Đáp án: <strong>${ans}</strong><br><span class="text-xs mt-1 block opacity-80">${q.explain || ''}</span>`;
                    feedbackEl.classList.add('bg-red-100', 'text-red-800');
                }
            });
            if(score === lessonData.quiz.length) playSound('correct'); else playSound('wrong');
            quizScoreCurrent = score;
            document.getElementById('quiz-score').innerText = `${score}/${lessonData.quiz.length}`;
            updateProgress();
        }

        function updateUI() {
            document.querySelectorAll('rt').forEach(rt => rt.style.visibility = settings.hideFurigana ? 'hidden' : 'visible');
            document.getElementById('btn-toggle-furigana').className = !settings.hideFurigana ? "px-2 md:px-3 py-1.5 rounded transition bg-sky-600 text-white flex items-center shadow" : "px-2 md:px-3 py-1.5 rounded transition bg-gray-200 text-gray-600 flex items-center";
            document.querySelectorAll('.romaji-text').forEach(el => el.classList.toggle('hidden', !settings.showRomaji));
            document.getElementById('btn-toggle-romaji').className = settings.showRomaji ? "px-2 md:px-3 py-1.5 rounded transition bg-sky-600 text-white flex items-center shadow ml-1" : "px-2 md:px-3 py-1.5 rounded transition bg-gray-200 text-gray-600 flex items-center ml-1";
            document.querySelectorAll('.vi-trans').forEach(p => p.style.display = settings.showVietnamese ? 'block' : 'none');
            document.getElementById('btn-toggle-vi').className = settings.showVietnamese ? "px-2 md:px-3 py-1.5 rounded transition bg-white text-sky-800 font-bold ml-1 flex items-center border border-sky-200 shadow-sm" : "px-2 md:px-3 py-1.5 rounded transition bg-gray-200 text-gray-500 font-bold ml-1 flex items-center";
            const speedSelect = document.getElementById('audio-speed');
            speedSelect.value = settings.currentSpeed;
            speedSelect.onchange = (e) => { settings.currentSpeed = parseFloat(e.target.value); saveSettings(); };
        }

        document.getElementById('btn-toggle-furigana').onclick = () => { settings.hideFurigana = !settings.hideFurigana; updateUI(); saveSettings(); };
        document.getElementById('btn-toggle-romaji').onclick = () => { settings.showRomaji = !settings.showRomaji; updateUI(); saveSettings(); };
        document.getElementById('btn-toggle-vi').onclick = () => { settings.showVietnamese = !settings.showVietnamese; updateUI(); saveSettings(); };

        document.addEventListener('DOMContentLoaded', () => {
            initSpeech(); loadSettings();
            renderConversation(); renderReading(); renderGrammar(); renderVocab(); renderQuiz();
            updateUI(); updateProgress();
            setTimeout(loadVoices, 100);
        });
    </script>
</body>
</html>
