<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AzaKanji Tango - Ngày 5: Đếm & Sinh hoạt</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    
    <style>
        /* Base Configuration */
        :root {
            --primary: #4f46e5;
            --secondary: #db2777;
        }

        body { 
            font-family: 'Nunito', 'Inter', sans-serif; 
            background-color: #f3f4f6; 
            height: 100vh; height: 100dvh; 
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .ja-text, .kanji-font { font-family: 'Noto Sans JP', sans-serif; }
        
        /* Custom Scrollbar */
        .scroller { -webkit-overflow-scrolling: touch; }
        .scroller::-webkit-scrollbar { width: 6px; }
        .scroller::-webkit-scrollbar-track { background: transparent; }
        .scroller::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .scroller::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }

        /* Animations */
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .correct-anim { animation: bounce 0.5s; }
        @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        
        .wrong-anim { animation: shake 0.5s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* UI Components */
        .vocab-item { transition: all 0.2s ease; }
        .vocab-item.active { 
            background-color: #eef2ff; 
            border-left: 4px solid var(--primary);
            color: #4338ca;
            padding-left: 12px;
        }
        
        .shadow-card {
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.2s;
        }
        .shadow-card:active { transform: scale(0.98); }

        .glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid rgba(255, 255, 255, 0.5);
        }

        /* Tabs */
        .tab-btn { color: #a5b4fc; }
        .tab-btn.active {
            background-color: white;
            color: #312e81;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .tab-btn:hover:not(.active) { color: white; background-color: rgba(255,255,255,0.1); }

        /* Kanji Drawing Grid */
        .stroke-grid-box {
            border: 1px solid #e5e7eb;
            background-color: white;
            position: relative;
        }
        .stroke-grid-box::after {
            content: ''; position: absolute; top: 0; left: 50%; width: 1px; height: 100%;
            background: repeating-linear-gradient(to bottom, #ddd 0, #ddd 4px, transparent 4px, transparent 8px); z-index: 0;
        }
        .stroke-grid-box::before {
            content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 1px;
            background: repeating-linear-gradient(to right, #ddd 0, #ddd 4px, transparent 4px, transparent 8px); z-index: 0;
        }
    </style>
</head>
<body class="flex flex-col text-slate-800">

    <!-- HEADER -->
    <header class="bg-indigo-700 text-white shadow-lg flex-none z-40 relative">
        <div class="container mx-auto px-4 py-2 md:py-3">
            <div class="flex flex-col md:flex-row justify-between items-center gap-3">
                <div class="flex items-center space-x-3 cursor-pointer select-none w-full md:w-auto justify-between md:justify-start">
                    <div class="flex items-center gap-3" onclick="location.reload()">
                        <div class="bg-white/10 p-2 rounded-lg">
                            <i class="fas fa-torii-gate text-2xl text-white"></i>
                        </div>
                        <div>
                            <h1 class="text-lg md:text-xl font-bold uppercase tracking-wider leading-none">AzaKanji Tango</h1>
                            <p class="text-[10px] md:text-xs text-indigo-200 mt-0.5">Ngày 5: Đếm & Sinh hoạt</p>
                        </div>
                    </div>
                    <div class="md:hidden text-xs font-semibold bg-indigo-800/80 px-3 py-1 rounded-full border border-indigo-500/50 backdrop-blur-sm">
                        <span id="headerProgress">1/87</span>
                    </div>
                </div>

                <div class="flex items-center gap-3 w-full md:w-auto">
                    <div class="flex bg-indigo-900/50 rounded-lg p-1 w-full md:w-auto overflow-x-auto no-scrollbar gap-1">
                        <button onclick="switchTab('learn')" id="tab-learn" class="tab-btn active flex-1 md:flex-none px-4 py-1.5 rounded-md text-sm font-bold transition whitespace-nowrap flex items-center justify-center gap-2">
                            <i class="fas fa-book-open"></i> Học Từ
                        </button>
                        <button onclick="switchTab('quiz')" id="tab-quiz" class="tab-btn flex-1 md:flex-none px-4 py-1.5 rounded-md text-sm font-bold transition whitespace-nowrap flex items-center justify-center gap-2">
                            <i class="fas fa-keyboard"></i> Kiểm Tra
                        </button>
                        <div class="w-px bg-indigo-600/50 mx-1"></div>
                        <button onclick="openGrammarList()" class="tab-btn flex-1 md:flex-none px-4 py-1.5 rounded-md text-sm font-bold transition whitespace-nowrap flex items-center justify-center gap-2">
                            <i class="fas fa-scroll"></i> Ngữ Pháp
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- MAIN CONTAINER -->
    <div class="flex flex-1 overflow-hidden relative w-full">
        
        <!-- SECTION 1: LEARN (SHADOWING UI) -->
        <div id="learn-section" class="flex flex-1 w-full overflow-hidden absolute inset-0 fade-in">
            <!-- Sidebar (Desktop) -->
            <aside class="hidden md:flex w-72 bg-white border-r border-gray-200 flex-col z-10">
                <div class="p-4 border-b border-gray-100 bg-gray-50">
                    <div class="relative group">
                        <span class="material-symbols-rounded absolute left-3 top-2.5 text-gray-400 text-xl">search</span>
                        <input type="text" id="searchInput" placeholder="Tìm kiếm từ..." class="w-full pl-10 pr-4 py-2 bg-white border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all shadow-sm">
                    </div>
                </div>
                <div id="vocabList" class="flex-1 overflow-y-auto scroller p-2 space-y-1"></div>
            </aside>

            <!-- Main Content -->
            <main id="mainContent" class="flex-1 overflow-y-auto scroller bg-slate-50 p-4 pb-28 md:pb-8 w-full scroll-smooth">
                <div class="max-w-3xl mx-auto flex flex-col items-center">
                    
                    <!-- Flashcard -->
                    <div class="w-full bg-white rounded-2xl p-6 shadow-sm border border-gray-200 mb-6 relative overflow-hidden group hover:shadow-md transition-shadow">
                        <!-- Decorative BG -->
                        <div class="absolute top-0 right-0 w-40 h-40 bg-gradient-to-br from-indigo-50 to-pink-50 rounded-bl-full -mr-10 -mt-10 z-0 opacity-70"></div>
                        
                        <div class="relative z-10 text-center">
                            <div class="inline-flex items-center gap-2 bg-gray-50 px-3 py-1 rounded-full mb-6 border border-gray-100 shadow-sm">
                                <span id="wordType" class="text-[10px] font-bold uppercase tracking-wider text-indigo-500">WORD</span>
                                <div class="w-px h-3 bg-gray-300"></div>
                                <span class="text-[10px] text-gray-400 font-mono" id="wordIndex">#1</span>
                            </div>
                            
                            <div class="relative inline-block group mb-2">
                                <h2 id="cardKanji" class="text-5xl md:text-7xl font-bold text-gray-800 ja-text tracking-tight cursor-pointer hover:text-indigo-700 transition-colors select-none" onclick="speakCurrent()">ケーキ</h2>
                                <button id="strokeBtn" onclick="openStrokeModal()" class="absolute -right-12 top-0 w-9 h-9 bg-pink-50 text-pink-600 rounded-full flex items-center justify-center shadow-sm hover:bg-pink-100 hover:scale-110 transition-all hidden" title="Tập viết Kanji">
                                    <i class="fas fa-pen-nib text-sm"></i>
                                </button>
                            </div>

                            <div class="flex flex-col items-center gap-1 cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition-colors" onclick="speakCurrent()">
                                <span id="cardFurigana" class="text-xl text-indigo-600 font-medium ja-text">ケーキ</span>
                                <span id="cardMeaning" class="text-lg text-gray-500 font-medium">Bánh ngọt</span>
                            </div>
                        </div>
                    </div>

                    <!-- Context Examples -->
                    <div class="w-full">
                        <div class="flex items-center gap-2 mb-4 px-1">
                            <div class="bg-gradient-to-br from-pink-100 to-red-50 text-pink-600 p-1.5 rounded-lg shadow-sm">
                                <i class="fas fa-comments"></i>
                            </div>
                            <h3 class="font-bold text-gray-700 text-lg">Mẫu Câu Ứng Dụng</h3>
                        </div>
                        <div id="sentenceList" class="space-y-4"></div>
                        
                        <!-- Empty State -->
                        <div id="emptyState" class="hidden flex-col items-center justify-center p-12 text-center bg-white rounded-2xl border border-dashed border-gray-300">
                            <div class="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mb-3 text-gray-300">
                                <i class="fas fa-comment-slash text-2xl"></i>
                            </div>
                            <p class="text-sm text-gray-500 font-medium">Từ này đặc biệt, chưa có mẫu câu tự động.</p>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Mobile Navigation Bar -->
            <div class="fixed bottom-0 left-0 right-0 glass px-4 py-3 pb-6 md:pb-4 z-30 flex items-center justify-between gap-4 md:hidden shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                <button onclick="prevWord()" class="w-12 h-12 rounded-xl bg-white border border-gray-200 text-gray-600 flex items-center justify-center shadow-sm active:bg-gray-50 active:scale-95 transition-all"><i class="fas fa-chevron-left"></i></button>
                <button onclick="toggleDrawer()" class="flex-1 h-12 rounded-xl bg-indigo-600 text-white font-bold flex items-center justify-center shadow-lg shadow-indigo-200 active:bg-indigo-700 active:scale-95 transition-all gap-2"><i class="fas fa-list-ul"></i> Danh Sách</button>
                <button onclick="nextWord()" class="w-12 h-12 rounded-xl bg-white border border-gray-200 text-gray-600 flex items-center justify-center shadow-sm active:bg-gray-50 active:scale-95 transition-all"><i class="fas fa-chevron-right"></i></button>
            </div>

            <!-- Desktop Floating Nav -->
            <div class="hidden md:flex fixed bottom-8 right-8 gap-3 z-30">
                 <button onclick="prevWord()" class="w-14 h-14 rounded-full bg-white border border-gray-200 text-gray-600 flex items-center justify-center shadow-lg hover:bg-gray-50 transition-transform hover:-translate-y-1"><i class="fas fa-chevron-left text-lg"></i></button>
                 <button onclick="nextWord()" class="w-14 h-14 rounded-full bg-indigo-600 text-white flex items-center justify-center shadow-xl shadow-indigo-200 hover:bg-indigo-700 transition-transform hover:-translate-y-1"><i class="fas fa-chevron-right text-lg"></i></button>
            </div>
        </div>

        <!-- SECTION 2: QUIZ UI -->
        <div id="quiz-section" class="hidden flex-1 w-full overflow-y-auto scroller bg-slate-100 p-4 absolute inset-0 fade-in z-20">
            <div class="max-w-xl mx-auto mt-4 md:mt-12">
                <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-200 relative">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-6 text-white flex justify-between items-center relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-40 h-40 bg-white opacity-10 rounded-full -mr-12 -mt-12 pointer-events-none"></div>
                        <div class="relative z-10">
                            <h2 class="text-2xl font-bold flex items-center gap-2"><i class="fas fa-graduation-cap"></i> Thử Thách</h2>
                            <p class="text-indigo-100 text-sm mt-1">Nhìn Kanji - Đoán Hiragana</p>
                        </div>
                        <div class="text-right relative z-10">
                            <div class="text-[10px] text-indigo-200 uppercase font-bold tracking-widest">ĐIỂM SỐ</div>
                            <div class="text-4xl font-bold font-mono leading-none" id="score-display">0</div>
                        </div>
                    </div>
                    
                    <!-- Content -->
                    <div class="p-6 md:p-10 text-center">
                        <div class="mb-8">
                            <div class="text-xs text-gray-400 mb-2 uppercase tracking-wide font-bold">Từ này đọc là gì?</div>
                            <div id="quiz-kanji" class="text-6xl md:text-7xl kanji-font font-bold text-gray-800 mb-4 transition-all py-4"></div>
                            <div id="quiz-meaning" class="text-lg text-indigo-600 font-bold mb-2"></div>
                        </div>

                        <div class="relative max-w-sm mx-auto mb-8">
                            <input type="text" id="quiz-input" class="w-full text-center text-2xl p-4 border-2 border-gray-300 rounded-xl focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 focus:outline-none transition-all kanji-font placeholder-gray-300" placeholder="nhập hiragana..." autocomplete="off">
                        </div>

                        <div id="feedback-area" class="hidden rounded-xl p-5 bg-gray-50 border border-gray-200 text-left mb-6 fade-in">
                            <div id="feedback-title" class="font-bold text-lg mb-2 flex items-center"></div>
                            <div class="text-gray-700 mb-3 flex items-center flex-wrap gap-2">
                                Đáp án đúng: <span id="correct-answer" class="font-bold text-xl text-indigo-600 px-3 py-1 bg-white rounded border border-indigo-100 ja-text shadow-sm"></span>
                                <button onclick="playQuizAudio()" class="w-8 h-8 rounded-full flex items-center justify-center hover:bg-gray-200 text-gray-500 transition-colors"><i class="fas fa-volume-up"></i></button>
                            </div>
                        </div>

                        <div>
                            <button id="btn-check" onclick="checkAnswer()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-indigo-200 transform transition active:scale-95 text-lg flex items-center justify-center gap-2"><i class="fas fa-check"></i> Kiểm Tra</button>
                            <button id="btn-next" onclick="nextQuestion()" class="hidden w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-4 rounded-xl shadow-lg transform transition active:scale-95 text-lg flex items-center justify-center gap-2">Câu Tiếp Theo <i class="fas fa-arrow-right"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MOBILE DRAWER -->
    <div id="mobileDrawer" class="fixed inset-0 z-50 pointer-events-none md:hidden">
        <div id="drawerBackdrop" class="absolute inset-0 bg-black/40 opacity-0 transition-opacity duration-300" onclick="toggleDrawer()"></div>
        <div id="drawerContent" class="absolute inset-y-0 bottom-0 left-0 w-[85%] max-w-sm bg-white shadow-2xl transform -translate-x-full transition-transform duration-300 flex flex-col pointer-events-auto">
            <div class="p-4 border-b border-gray-100 bg-gray-50 flex items-center justify-between">
                <h3 class="font-bold text-lg text-gray-800 flex items-center gap-2"><i class="fas fa-list text-indigo-600"></i> Danh Sách Từ</h3>
                <button onclick="toggleDrawer()" class="w-8 h-8 rounded-full bg-white border border-gray-200 flex items-center justify-center text-gray-500 shadow-sm active:scale-95"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-3 border-b border-gray-100">
                <input type="text" id="mobileSearchInput" placeholder="Tìm nhanh..." class="w-full px-4 py-2.5 bg-gray-100 border-transparent rounded-xl text-sm focus:bg-white focus:ring-2 focus:ring-indigo-500 transition-all">
            </div>
            <div id="mobileVocabList" class="flex-1 overflow-y-auto scroller p-2 space-y-1"></div>
        </div>
    </div>

    <!-- GRAMMAR LIST MODAL -->
    <div id="grammarListModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity opacity-0" id="grammarListBackdrop" onclick="closeModal('grammarListModal')"></div>
        <div class="bg-white rounded-2xl w-full max-w-4xl relative z-10 shadow-2xl transform transition-all scale-95 opacity-0 flex flex-col max-h-[85vh]" id="grammarListPanel">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-indigo-50 rounded-t-2xl">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-600 text-white p-2 rounded-lg shadow-md shadow-indigo-200"><i class="fas fa-book"></i></div>
                    <div><h3 class="text-xl font-bold text-gray-800">Cẩm Nang Ngữ Pháp</h3><p class="text-xs text-gray-500">Các mẫu câu trọng điểm (Bài 5)</p></div>
                </div>
                <button onclick="closeModal('grammarListModal')" class="w-8 h-8 rounded-full hover:bg-white flex items-center justify-center text-gray-500 transition-colors"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto scroller bg-slate-50">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="grammarGrid"></div>
            </div>
            <div class="p-4 border-t border-gray-100 bg-white rounded-b-2xl flex justify-end">
                <button onclick="closeModal('grammarListModal')" class="px-6 py-2 bg-gray-800 hover:bg-gray-900 text-white font-bold rounded-full text-sm transition-transform active:scale-95 shadow-lg">Đóng</button>
            </div>
        </div>
    </div>

    <!-- GRAMMAR DETAIL MODAL -->
    <div id="detailModal" class="fixed inset-0 z-[70] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity opacity-0" id="detailBackdrop" onclick="closeModal('detailModal')"></div>
        <div class="bg-white rounded-2xl w-full max-w-md relative z-10 shadow-2xl transform transition-all scale-95 opacity-0 flex flex-col" id="detailPanel">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 rounded-t-2xl">
                <div class="flex items-center gap-2">
                    <div class="bg-indigo-100 p-1.5 rounded-lg text-indigo-600"><i id="modalIcon" class="fas fa-info-circle"></i></div>
                    <h3 class="text-lg font-bold text-gray-800" id="modalTitle">Chi tiết</h3>
                </div>
                <button onclick="closeModal('detailModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6">
                <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-4 text-center mb-5">
                    <code class="text-lg font-bold text-indigo-700 font-mono" id="modalFormula"></code>
                </div>
                <p class="text-gray-600 text-sm mb-5 leading-relaxed" id="modalExplanation"></p>
                <div class="bg-white rounded-xl p-4 border border-gray-200 shadow-sm">
                    <div class="text-[10px] font-bold text-gray-400 uppercase mb-3 tracking-wider">Ví dụ minh họa</div>
                    <div class="flex justify-between items-start gap-3">
                        <div>
                            <p class="ja-text font-medium text-gray-800 mb-1 text-lg" id="modalExampleJa"></p>
                            <p class="text-xs text-gray-500 italic" id="modalExampleVi"></p>
                        </div>
                        <button id="modalPlayBtn" class="text-indigo-500 hover:text-indigo-700 bg-indigo-50 w-8 h-8 rounded-full flex items-center justify-center"><i class="fas fa-volume-up"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- STROKE ORDER MODAL -->
    <div id="strokeModal" class="fixed inset-0 z-[80] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-gray-900/80 backdrop-blur-sm transition-opacity opacity-0" id="strokeBackdrop" onclick="closeModal('strokeModal')"></div>
        <div class="bg-white rounded-2xl w-full max-w-5xl relative z-10 shadow-2xl transform transition-all scale-95 opacity-0 flex flex-col max-h-[90vh]" id="strokePanel">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-pink-50 rounded-t-2xl">
                <h3 class="text-lg font-bold text-pink-700 flex items-center gap-2">
                    <i class="fas fa-pen-nib"></i> Tập Viết & Chi Tiết Kanji
                </h3>
                <button onclick="closeModal('strokeModal')" class="w-8 h-8 rounded-full hover:bg-white flex items-center justify-center text-gray-500 transition-colors"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto scroller bg-slate-50 flex-1">
                <div id="strokeTabs" class="flex justify-center gap-2 mb-6 flex-wrap"></div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Left: Writing -->
                    <div class="flex flex-col gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 text-center relative">
                            <p class="text-xs text-gray-400 mb-4 font-bold uppercase tracking-wider">Mô phỏng nét viết</p>
                            <div id="strokeAnimContainer" class="w-48 h-48 mx-auto bg-white border border-gray-300 relative stroke-grid-box flex items-center justify-center rounded-lg shadow-inner">
                                <span class="text-xs text-gray-400 animate-pulse">Đang tải dữ liệu...</span>
                            </div>
                            <button onclick="replayStrokeAnimation()" class="absolute top-4 right-4 bg-pink-50 text-pink-600 w-10 h-10 rounded-full flex items-center justify-center hover:bg-pink-100 transition shadow-sm hover:rotate-180 duration-500" title="Viết lại"><i class="fas fa-redo text-sm"></i></button>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <p class="text-xs text-gray-400 mb-4 font-bold uppercase tracking-wider">Thứ tự từng nét</p>
                            <div id="strokeGridContainer" class="flex flex-wrap gap-2 justify-center lg:justify-start"></div>
                        </div>
                    </div>
                    <!-- Right: Info -->
                    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200 flex flex-col h-full">
                        <div id="kanjiDetailContent">
                            <div class="flex items-center justify-between mb-6 border-b border-gray-100 pb-4">
                                <div>
                                    <h2 id="detailKanji" class="text-6xl font-bold text-gray-800 ja-text mb-2"></h2>
                                    <div class="text-xs font-bold bg-indigo-100 text-indigo-700 px-2 py-1 rounded inline-block tracking-wider" id="detailHanViet"></div>
                                </div>
                                <div class="text-right"><div class="text-2xl font-bold text-gray-600 capitalize" id="detailMeaning"></div></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <div class="bg-slate-50 p-3 rounded-lg border border-slate-100"><span class="text-[10px] font-bold text-gray-400 uppercase block mb-1">On (Âm Nhật)</span><span class="text-lg font-bold text-indigo-600 ja-text" id="detailOn"></span></div>
                                <div class="bg-slate-50 p-3 rounded-lg border border-slate-100"><span class="text-[10px] font-bold text-gray-400 uppercase block mb-1">Kun (Âm Hán)</span><span class="text-lg font-bold text-pink-600 ja-text" id="detailKun"></span></div>
                            </div>
                            <div class="space-y-4 mb-6">
                                <div class="bg-green-50 p-4 rounded-lg border border-green-100 relative overflow-hidden">
                                    <div class="absolute right-0 top-0 opacity-10 text-green-600 text-4xl p-2"><i class="fas fa-image"></i></div>
                                    <h4 class="text-xs font-bold text-green-800 mb-1 uppercase">Mẹo nhớ hình ảnh</h4>
                                    <p class="text-sm text-green-900 leading-relaxed font-medium" id="detailTipImg"></p>
                                </div>
                                <div class="bg-orange-50 p-4 rounded-lg border border-orange-100 relative overflow-hidden">
                                    <div class="absolute right-0 top-0 opacity-10 text-orange-600 text-4xl p-2"><i class="fas fa-music"></i></div>
                                    <h4 class="text-xs font-bold text-orange-800 mb-1 uppercase">Mẹo nhớ âm thanh</h4>
                                    <p class="text-sm text-orange-900 leading-relaxed font-medium" id="detailTipSound"></p>
                                </div>
                            </div>
                            <div>
                                <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Từ vựng liên quan</h4>
                                <div class="space-y-2 max-h-40 overflow-y-auto scroller pr-1" id="detailWords"></div>
                            </div>
                        </div>
                        <div id="kanjiDetailEmpty" class="hidden h-full flex flex-col items-center justify-center text-center p-4">
                            <i class="fas fa-book-open text-gray-200 text-6xl mb-4"></i>
                            <p class="text-gray-400 font-medium">Đang cập nhật thông tin chi tiết.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. DATA: KANJI & VOCAB & GRAMMAR ---
        
        // KANJI DATABASE (Specific for Day 5)
        const kanjiDetails = {
            "掃": { hanviet: "TẢO", mean: "Quét dọn", on: "ソウ", kun: "は.く", tipImg: "Tay (**扌**) cầm cái chổi (**帚**) quét.", tipSound: "**Sou**ji quét nhà.", words: [{w:"掃除 (そうじ)", m:"Dọn dẹp"}, {w:"清掃 (せいそう)", m:"Vệ sinh"}] },
            "除": { hanviet: "TRỪ", mean: "Loại bỏ", on: "ジョ, ジ", kun: "のぞ.く", tipImg: "Ở gò đất (**阝**) dư (**余**) thừa thì loại bỏ.", tipSound: "**Jo** (Giơ) tay loại bỏ.", words: [{w:"掃除 (そうじ)", m:"Dọn dẹp"}, {w:"削除 (さくじょ)", m:"Xóa bỏ"}] },
            "働": { hanviet: "ĐỘNG", mean: "Làm việc", on: "ドウ", kun: "はたら.く", tipImg: "Người (**亻**) dùng sức (**力**) chuyển động (**重**).", tipSound: "**Hataraku** làm việc.", words: [{w:"働きます (はたらきます)", m:"Làm việc"}, {w:"労働 (ろうどう)", m:"Lao động"}] },
            "選": { hanviet: "TUYỂN", mean: "Chọn", on: "セン", kun: "えら.ぶ", tipImg: "Hai con rắn (**己**) cùng đi (**⻌**) thi tuyển.", tipSound: "**Erabu** chọn lựa.", words: [{w:"選びます (えらびます)", m:"Chọn"}, {w:"選挙 (せんきょ)", m:"Bầu cử"}] },
            "回": { hanviet: "HỒI", mean: "Lần/Vòng", on: "カイ", kun: "まわ.る", tipImg: "Hai cái miệng (**口**) xoay vòng.", tipSound: "**Kai** (cái) lần.", words: [{w:"〜回 (かい)", m:"Lần"}, {w:"回復 (かいふく)", m:"Hồi phục"}] },
            "台": { hanviet: "ĐÀI", mean: "Cái (máy)", on: "ダイ, タイ", kun: "", tipImg: "Cái miệng (**口**) nói chuyện riêng (**ム**) trên đài.", tipSound: "**Dai** đài.", words: [{w:"〜台 (だい)", m:"Cái (máy)"}, {w:"台所 (だいどころ)", m:"Nhà bếp"}] },
            "枚": { hanviet: "MAI", mean: "Tờ/Tấm", on: "マイ", kun: "", tipImg: "Cây (**木**) bị đánh (**攵**) thành từng tấm mỏng.", tipSound: "**Mai** (mái) nhà lợp từng tấm.", words: [{w:"〜枚 (まい)", m:"Tờ/Tấm"}, {w:"枚数 (まいすう)", m:"Số tờ"}] },
            "本": { hanviet: "BẢN", mean: "Sách/Cây/Cái", on: "ホン", kun: "もと", tipImg: "Gốc cây (**木**) được đánh dấu.", tipSound: "**Hon** (hôn) vào sách.", words: [{w:"〜本 (ほん)", m:"Cái (thon dài)"}, {w:"本 (ほん)", m:"Sách"}] },
            "手": { hanviet: "THỦ", mean: "Tay", on: "シュ", kun: "て", tipImg: "Hình bàn tay xòe ra.", tipSound: "**Te** tay.", words: [{w:"手紙 (てがみ)", m:"Thư"}, {w:"手 (て)", m:"Tay"}] },
            "紙": { hanviet: "CHỈ", mean: "Giấy", on: "シ", kun: "かみ", tipImg: "Sợi chỉ (**糸**) dệt thành giấy cho thị (**氏**) tộc.", tipSound: "**Kami** giấy.", words: [{w:"手紙 (てがみ)", m:"Thư"}, {w:"紙 (かみ)", m:"Giấy"}] },
            "寺": { hanviet: "TỰ", mean: "Chùa", on: "ジ", kun: "てら", tipImg: "Đất (**土**) có thốn (**寸**) cỏ là chùa.", tipSound: "**Tera** chùa.", words: [{w:"お寺 (おてら)", m:"Chùa"}, {w:"寺院 (じいん)", m:"Đền thờ"}] },
            "郵": { hanviet: "BƯU", mean: "Bưu chính", on: "ユウ", kun: "", tipImg: "Vùng đất (**阝**) xa xôi (**垂**) cần gửi thư.", tipSound: "**Yuu** bưu điện.", words: [{w:"郵便局 (ゆうびんきょく)", m:"Bưu điện"}, {w:"郵送 (ゆうそう)", m:"Gửi thư"}] },
            "便": { hanviet: "TIỆN", mean: "Tiện/Thư", on: "ベン, ビン", kun: "たよ.り", tipImg: "Người (**亻**) canh (**更**) cửa rất tiện.", tipSound: "**Bin** thư.", words: [{w:"郵便局 (ゆうびんきょく)", m:"Bưu điện"}, {w:"便利 (べんり)", m:"Tiện lợi"}] },
            "局": { hanviet: "CỤC", mean: "Cục/Phòng", on: "キョク", kun: "", tipImg: "Xác chết (**尸**) trong cái bao (**勹**) ở cục cảnh sát.", tipSound: "**Kyoku** cục.", words: [{w:"郵便局 (ゆうびんきょく)", m:"Bưu điện"}, {w:"薬局 (やっきょく)", m:"Hiệu thuốc"}] },
            "買": { hanviet: "MÃI", mean: "Mua", on: "バイ", kun: "か.う", tipImg: "Lưới (**罒**) chụp tiền (**貝**) để mua.", tipSound: "**Ka**u mua.", words: [{w:"買い物 (かいもの)", m:"Mua sắm"}, {w:"買います (かいます)", m:"Mua"}] },
            "物": { hanviet: "VẬT", mean: "Đồ vật", on: "ブツ, モツ", kun: "もの", tipImg: "Con bò (**牛**) chê không (**勿**) phải đồ vật.", tipSound: "**Mono** vật.", words: [{w:"買い物 (かいもの)", m:"Mua sắm"}, {w:"荷物 (にもつ)", m:"Hành lý"}] },
            "出": { hanviet: "XUẤT", mean: "Ra/Nộp", on: "シュツ", kun: "だ.す", tipImg: "Hai ngọn núi chồng lên nhau xuất hiện.", tipSound: "**Da**su đưa ra.", words: [{w:"出します (だします)", m:"Nộp/Đổ (rác)"}, {w:"出口 (でぐち)", m:"Cửa ra"}] },
            "祈": { hanviet: "KỲ", mean: "Cầu nguyện", on: "キ", kun: "いの.る", tipImg: "Thần đất (**礻**) cầm rìu (**斤**) cầu nguyện.", tipSound: "**Ino**ru cầu.", words: [{w:"祈ります (いのります)", m:"Cầu nguyện"}, {w:"祈願 (きがん)", m:"Lời cầu nguyện"}] },
            "見": { hanviet: "KIẾN", mean: "Nhìn", on: "ケン", kun: "み.る", tipImg: "Mắt trên chân đi kiến tập.", tipSound: "**Ken**gaku kiến tập.", words: [{w:"見学 (けんがく)", m:"Tham quan học tập"}, {w:"見ます (みます)", m:"Nhìn"}] },
            "学": { hanviet: "HỌC", mean: "Học", on: "ガク", kun: "まな.ぶ", tipImg: "Đứa trẻ đội mũ đi học.", tipSound: "**Gaku** học.", words: [{w:"見学 (けんがく)", m:"Tham quan học tập"}, {w:"学校 (がっこう)", m:"Trường học"}] },
            "番": { hanviet: "PHIÊN", mean: "Số/Lượt", on: "バン", kun: "", tipImg: "Gạo (**米**) trên ruộng (**田**) được đánh số.", tipSound: "**Ban** số.", words: [{w:"一番 (いちばん)", m:"Nhất/Số 1"}, {w:"交番 (こうばん)", m:"Đồn cảnh sát"}] },
            "世": { hanviet: "THẾ", mean: "Thế giới", on: "セイ, セ", kun: "よ", tipImg: "Ba mươi (**卅**) năm là một thế hệ.", tipSound: "**Se**kai thế giới.", words: [{w:"世界 (せかい)", m:"Thế giới"}, {w:"世話 (せわ)", m:"Chăm sóc"}] },
            "界": { hanviet: "GIỚI", mean: "Giới hạn", on: "カイ", kun: "", tipImg: "Ruộng (**田**) bị giới (**介**) hạn.", tipSound: "**Kai** giới.", words: [{w:"世界 (せかい)", m:"Thế giới"}, {w:"限界 (げんかい)", m:"Giới hạn"}] },
            "季": { hanviet: "QUÝ", mean: "Mùa", on: "キ", kun: "", tipImg: "Cây lúa (**禾**) non trẻ (**子**) theo mùa.", tipSound: "**Ki**setsu mùa.", words: [{w:"季節 (きせつ)", m:"Mùa"}, {w:"四季 (しき)", m:"Bốn mùa"}] },
            "節": { hanviet: "TIẾT", mean: "Tiết/Mùa", on: "セツ", kun: "ふし", tipImg: "Tre (**竹**) tức (**即**) khí tiết.", tipSound: "**Setsu** tiết.", words: [{w:"季節 (きせつ)", m:"Mùa"}, {w:"調節 (ちょうせつ)", m:"Điều tiết"}] },
            "春": { hanviet: "XUÂN", mean: "Mùa xuân", on: "シュン", kun: "はる", tipImg: "Ba người (**三**) ngắm mặt trời (**日**) mùa xuân.", tipSound: "**Haru** xuân.", words: [{w:"春 (はる)", m:"Mùa xuân"}, {w:"青春 (せいしゅん)", m:"Thanh xuân"}] },
            "夏": { hanviet: "HẠ", mean: "Mùa hè", on: "カ", kun: "なつ", tipImg: "Trăm (**百**) người đi lại (**夂**) mùa hè.", tipSound: "**Natsu** hạ.", words: [{w:"夏 (なつ)", m:"Mùa hè"}, {w:"夏休み (なつやすみ)", m:"Nghỉ hè"}] },
            "秋": { hanviet: "THU", mean: "Mùa thu", on: "シュウ", kun: "あき", tipImg: "Cây lúa (**禾**) chín vàng như lửa (**火**) mùa thu.", tipSound: "**Aki** thu.", words: [{w:"秋 (あき)", m:"Mùa thu"}, {w:"秋分 (しゅうぶん)", m:"Thu phân"}] },
            "冬": { hanviet: "ĐÔNG", mean: "Mùa đông", on: "トウ", kun: "ふゆ", tipImg: "Bước đi (**夂**) trên băng (**冫**) mùa đông.", tipSound: "**Fuyu** đông.", words: [{w:"冬 (ふゆ)", m:"Mùa đông"}, {w:"冬休み (ふゆやすみ)", m:"Nghỉ đông"}] },
            "食": { hanviet: "THỰC", mean: "Ăn", on: "ショク", kun: "た.べる", tipImg: "Người tốt (**良**) có lương thực.", tipSound: "**Ta**beru ăn.", words: [{w:"食べ物 (たべもの)", m:"Đồ ăn"}, {w:"食堂 (しょくどう)", m:"Nhà ăn"}] },
            "飲": { hanviet: "ẨM", mean: "Uống", on: "イン", kun: "の.む", tipImg: "Ăn (**食**) thiếu (**欠**) nước phải uống.", tipSound: "**No**miono đồ uống.", words: [{w:"飲み物 (のみもの)", m:"Đồ uống"}, {w:"飲食店 (いんしょくてん)", m:"Nhà hàng"}] },
            "乗": { hanviet: "THỪA", mean: "Lên xe", on: "ジョウ", kun: "の.る", tipImg: "Cây lúa (**禾**) trên xe.", tipSound: "**Nori**mono phương tiện.", words: [{w:"乗り物 (のりもの)", m:"Phương tiện"}, {w:"乗車 (じょうしゃ)", m:"Lên tàu"}] },
            "変": { hanviet: "BIẾN", mean: "Biến đổi/Vất vả", on: "ヘン", kun: "か.わる", tipImg: "Cũng (**亦**) đánh nhẹ (**攵**) để thay đổi.", tipSound: "**Taihen** vất vả.", words: [{w:"大変 (たいへん)", m:"Vất vả"}, {w:"変化 (へんか)", m:"Biến hóa"}] },
            "嬉": { hanviet: "HI", mean: "Vui mừng", on: "キ", kun: "うれ.しい", tipImg: "Phụ nữ (**女**) vui mừng (**喜**) rỡ.", tipSound: "**Ure**shii vui.", words: [{w:"嬉しい (うれしい)", m:"Vui mừng"}] },
            "週": { hanviet: "CHU", mean: "Tuần", on: "シュウ", kun: "", tipImg: "Đi vòng quanh (**周**) một tuần.", tipSound: "**Shuu** tuần.", words: [{w:"週末 (しゅうまつ)", m:"Cuối tuần"}, {w:"来週 (らいしゅう)", m:"Tuần sau"}] },
            "末": { hanviet: "MẠT", mean: "Cuối", on: "マツ", kun: "すえ", tipImg: "Cây (**木**) có ngọn dài hơn gốc.", tipSound: "**Matsu** cuối.", words: [{w:"週末 (しゅうまつ)", m:"Cuối tuần"}, {w:"月末 (げつまつ)", m:"Cuối tháng"}] },
            "面": { hanviet: "DIỆN", mean: "Mặt", on: "メン", kun: "おも", tipImg: "Mặt trong khung.", tipSound: "**Men** diện.", words: [{w:"面積 (めんせき)", m:"Diện tích"}, {w:"画面 (がめん)", m:"Màn hình"}] },
            "積": { hanviet: "TÍCH", mean: "Tích tụ", on: "セキ", kun: "つ.む", tipImg: "Lúa (**禾**) chất trách (**責**) đống tích tụ.", tipSound: "**Seki** tích.", words: [{w:"面積 (めんせき)", m:"Diện tích"}, {w:"積雪 (せきせつ)", m:"Tuyết phủ"}] },
            "腹": { hanviet: "PHÚC", mean: "Bụng", on: "フク", kun: "はら, おなか", tipImg: "Phần cơ thể (**月**) phục (**复**) hồi là bụng.", tipSound: "**Onaka** bụng.", words: [{w:"お腹 (おなか)", m:"Bụng"}, {w:"空腹 (くうふく)", m:"Đói bụng"}] },
            "空": { hanviet: "KHÔNG", mean: "Trống rỗng", on: "クウ", kun: "す.く", tipImg: "Dưới hang (**穴**) thợ (**工**) làm việc không trung.", tipSound: "**Su**ku trống.", words: [{w:"空きます (すきます)", m:"Trống/Đói"}, {w:"空気 (くうき)", m:"Không khí"}] },
            "電": { hanviet: "ĐIỆN", mean: "Điện", on: "デン", kun: "", tipImg: "Mưa (**雨**) có sét.", tipSound: "**Den**ki điện.", words: [{w:"電気 (でんき)", m:"Điện/Đèn"}, {w:"電話 (でんわ)", m:"Điện thoại"}] },
            "気": { hanviet: "KHÍ", mean: "Khí chất", on: "キ", kun: "", tipImg: "Hơi nước (**气**) bốc lên từ gạo (**米**).", tipSound: "**Ki** khí.", words: [{w:"電気 (でんき)", m:"Điện"}, {w:"元気 (げんき)", m:"Khỏe mạnh"}] },
            "風": { hanviet: "PHONG", mean: "Gió", on: "フウ", kun: "かぜ", tipImg: "Con sâu (**虫**) trong gió.", tipSound: "**Fu**ro bồn tắm.", words: [{w:"お風呂 (おふろ)", m:"Bồn tắm"}, {w:"台風 (たいふう)", m:"Bão"}] },
            "呂": { hanviet: "LỮ", mean: "Xương sống", on: "ロ", kun: "", tipImg: "Hai đốt xương sống.", tipSound: "**Ro** lữ.", words: [{w:"お風呂 (おふろ)", m:"Bồn tắm"}] },
            "鍵": { hanviet: "KIỆN", mean: "Chìa khóa", on: "ケン", kun: "かぎ", tipImg: "Kim loại (**金**) kiến (**建**) thiết chìa khóa.", tipSound: "**Kagi** khóa.", words: [{w:"鍵 (かぎ)", m:"Chìa khóa"}] },
            "新": { hanviet: "TÂN", mean: "Mới", on: "シン", kun: "あたら.しい", tipImg: "Rìu (**斤**) đẽo cây (**木**) đứng (**立**) làm đồ mới.", tipSound: "**Shin**bun báo.", words: [{w:"新聞 (しんぶん)", m:"Báo"}, {w:"新年 (しんねん)", m:"Năm mới"}] },
            "聞": { hanviet: "VĂN", mean: "Nghe", on: "ブン", kun: "き.く", tipImg: "Tai (**耳**) ở cổng (**門**) nghe tin.", tipSound: "**Bun** văn.", words: [{w:"新聞 (しんぶん)", m:"Báo"}, {w:"見聞 (けんぶん)", m:"Kiến thức"}] },
            "雑": { hanviet: "TẠP", mean: "Tạp nham", on: "ザツ", kun: "", tipImg: "Chín (**九**) con chim đậu trên cây (**木**) tạp nham.", tipSound: "**Zas**shi tạp chí.", words: [{w:"雑誌 (ざっし)", m:"Tạp chí"}, {w:"複雑 (ふくざつ)", m:"Phức tạp"}] },
            "誌": { hanviet: "CHÍ", mean: "Ghi chép", on: "シ", kun: "", tipImg: "Lời nói (**言**) ghi chép ý chí (**志**).", tipSound: "**Shi** chí.", words: [{w:"雑誌 (ざっし)", m:"Tạp chí"}, {w:"日誌 (にっし)", m:"Nhật ký"}] },
            "消": { hanviet: "TIÊU", mean: "Tắt/Xóa", on: "ショウ", kun: "け.す", tipImg: "Nước (**氵**) tiêu (**肖**) tan lửa.", tipSound: "**Ke**su tắt.", words: [{w:"消します (けします)", m:"Tắt"}, {w:"消防車 (しょうぼうしゃ)", m:"Xe cứu hỏa"}] },
            "浴": { hanviet: "DỤC", mean: "Tắm", on: "ヨク", kun: "あ.びる", tipImg: "Nước (**氵**) chảy trong thung lũng (**谷**) để tắm.", tipSound: "**Abi**ru tắm.", words: [{w:"浴びます (あびます)", m:"Tắm (vòi sen)"}, {w:"浴室 (よくしつ)", m:"Phòng tắm"}] },
            "入": { hanviet: "NHẬP", mean: "Vào", on: "ニュウ", kun: "はい.る", tipImg: "Người đi vào.", tipSound: "**Hai**ru vào.", words: [{w:"入ります (はいります)", m:"Vào/Tắm bồn"}, {w:"入口 (いりぐち)", m:"Cửa vào"}] },
            "掛": { hanviet: "QUẢI", mean: "Treo/Khóa", on: "カイ", kun: "か.ける", tipImg: "Tay (**扌**) cầm quẻ (**卦**) treo lên.", tipSound: "**Ka**keru khóa.", words: [{w:"掛けます (かけます)", m:"Khóa (cửa)"}] },
            "押": { hanviet: "ÁP", mean: "Ấn/Đẩy", on: "オウ", kun: "お.す", tipImg: "Tay (**扌**) ấn cái giáp (**甲**).", tipSound: "**O**su ấn.", words: [{w:"押します (おします)", m:"Ấn/Đẩy"}] },
            "洗": { hanviet: "TẨY", mean: "Rửa", on: "セン", kun: "あら.う", tipImg: "Nước (**氵**) tẩy sạch trước (**先**).", tipSound: "**Sen**taku giặt.", words: [{w:"洗濯 (せんたく)", m:"Giặt giũ"}, {w:"洗います (あらいます)", m:"Rửa"}] },
            "濯": { hanviet: "TRẠC", mean: "Giặt", on: "タク", kun: "", tipImg: "Nước (**氵**) giặt lông chim (**翟**).", tipSound: "**Taku** trạc.", words: [{w:"洗濯機 (せんたくき)", m:"Máy giặt"}] },
            "機": { hanviet: "CƠ", mean: "Máy", on: "キ", kun: "はた", tipImg: "Cây (**木**) bên mấy (**幾**) cái máy.", tipSound: "**Ki** cơ.", words: [{w:"洗濯機 (せんたくき)", m:"Máy giặt"}, {w:"機械 (きかい)", m:"Cơ khí"}] },
            "独": { hanviet: "ĐỘC", mean: "Một mình", on: "ドク", kun: "ひと.り", tipImg: "Con chó (**犭**) bị con sâu (**虫**) cắn một mình.", tipSound: "**Doku**shin độc thân.", words: [{w:"独身 (どくしん)", m:"Độc thân"}, {w:"独特 (どくとく)", m:"Độc đáo"}] },
            "身": { hanviet: "THÂN", mean: "Thân thể", on: "シン", kun: "み", tipImg: "Thân thể mang bầu.", tipSound: "**Shin** thân.", words: [{w:"独身 (どくしん)", m:"Độc thân"}, {w:"身体 (しんたい)", m:"Cơ thể"}] },
            "資": { hanviet: "TƯ", mean: "Tư liệu/Vốn", on: "シ", kun: "", tipImg: "Tiền (**貝**) thứ (**次**) yếu là vốn.", tipSound: "**Shi**ryou tài liệu.", words: [{w:"資料 (しりょう)", m:"Tài liệu"}, {w:"資本 (しほん)", m:"Tư bản"}] },
            "料": { hanviet: "LIỆU", mean: "Nguyên liệu", on: "リョウ", kun: "", tipImg: "Gạo (**米**) đong đấu (**斗**) làm nguyên liệu.", tipSound: "**Ryou** liệu.", words: [{w:"資料 (しりょう)", m:"Tài liệu"}, {w:"料理 (りょうり)", m:"Món ăn"}] },
            "話": { hanviet: "THOẠI", mean: "Nói chuyện", on: "ワ", kun: "はな.す", tipImg: "Lời nói (**言**) bằng lưỡi (**舌**).", tipSound: "**Wa** thoại.", words: [{w:"電話 (でんわ)", m:"Điện thoại"}, {w:"会話 (かいわ)", m:"Hội thoại"}] },
            "予": { hanviet: "DỰ", mean: "Dự báo", on: "ヨ", kun: "", tipImg: "Cái mâu (**矛**) dự báo chiến tranh.", tipSound: "**Yo**yaku đặt trước.", words: [{w:"予約 (よやく)", m:"Đặt trước"}, {w:"予定 (よてい)", m:"Dự định"}] },
            "約": { hanviet: "ƯỚC", mean: "Lời hứa", on: "ヤク", kun: "", tipImg: "Sợi chỉ (**糸**) buộc cái muôi (**勺**) là lời hứa.", tipSound: "**Yaku** ước.", words: [{w:"予約 (よやく)", m:"Đặt trước"}, {w:"約束 (やくそく)", m:"Lời hứa"}] },
            "歯": { hanviet: "XỈ", mean: "Răng", on: "シ", kun: "は", tipImg: "Dừng (**止**) lại để nhe răng.", tipSound: "**Ha** răng.", words: [{w:"歯 (は)", m:"Răng"}, {w:"歯科 (しか)", m:"Nha khoa"}] },
            "顔": { hanviet: "NHAN", mean: "Mặt", on: "ガン", kun: "かお", tipImg: "Đầu (**頁**) có nhan sắc (**彦**).", tipSound: "**Kao** mặt.", words: [{w:"顔 (かお)", m:"Khuôn mặt"}, {w:"洗顔 (せんがん)", m:"Rửa mặt"}] },
            "試": { hanviet: "THÍ", mean: "Thử", on: "シ", kun: "ため.す", tipImg: "Lời nói (**言**) theo thức (**式**) là thi thử.", tipSound: "**Shi**ai trận đấu.", words: [{w:"試合 (しあい)", m:"Trận đấu"}, {w:"試験 (しけん)", m:"Kỳ thi"}] },
            "合": { hanviet: "HỢP", mean: "Hợp/Gặp", on: "ゴウ", kun: "あ.う", tipImg: "Một (**一**) người (**人**) miệng (**口**) hợp lại.", tipSound: "**Ai** hợp.", words: [{w:"試合 (しあい)", m:"Trận đấu"}, {w:"間に合う (まにあう)", m:"Kịp giờ"}] },
            "砂": { hanviet: "SA", mean: "Cát", on: "サ", kun: "すな", tipImg: "Đá (**石**) nhỏ thiếu (**少**) là cát.", tipSound: "**Sa**tou đường.", words: [{w:"砂糖 (さとう)", m:"Đường"}, {w:"砂漠 (さばく)", m:"Sa mạc"}] },
            "糖": { hanviet: "ĐƯỜNG", mean: "Đường ăn", on: "トウ", kun: "", tipImg: "Gạo (**米**) nhà đường (**唐**) rất ngọt.", tipSound: "**Tou** đường.", words: [{w:"砂糖 (さとう)", m:"Đường"}] },
            "塩": { hanviet: "DIÊM", mean: "Muối", on: "エン", kun: "しお", tipImg: "Người nằm (**亻**) trên đất (**土**) ăn muối trong đĩa (**皿**).", tipSound: "**Shio** muối.", words: [{w:"塩 (しお)", m:"Muối"}, {w:"食塩 (しょくえん)", m:"Muối ăn"}] },
            "油": { hanviet: "DU", mean: "Dầu", on: "ユ", kun: "あぶら", tipImg: "Nước (**氵**) do (**由**) dầu tạo ra.", tipSound: "**Yu** du.", words: [{w:"醤油 (しょうゆ)", m:"Nước tương"}, {w:"石油 (せきゆ)", m:"Dầu mỏ"}] },
            "住": { hanviet: "TRÚ", mean: "Sống", on: "ジュウ", kun: "す.む", tipImg: "Người (**亻**) làm chủ (**主**) nơi ở.", tipSound: "**Juu**sho địa chỉ.", words: [{w:"住所 (じゅうしょ)", m:"Địa chỉ"}, {w:"住みます (すみます)", m:"Sống"}] },
            "所": { hanviet: "SỞ", mean: "Nơi chốn", on: "ショ", kun: "ところ", tipImg: "Cửa (**戸**) có rìu (**斤**) canh giữ.", tipSound: "**Sho** sở.", words: [{w:"住所 (じゅうしょ)", m:"Địa chỉ"}, {w:"場所 (ばしょ)", m:"Nơi chốn"}] },
            "交": { hanviet: "GIAO", mean: "Giao nhau", on: "コウ", kun: "まじ.わる", tipImg: "Cha (**父**) đi giao lưu.", tipSound: "**Kou**saten ngã tư.", words: [{w:"交差点 (こうさてん)", m:"Ngã tư"}, {w:"交流 (こうりゅう)", m:"Giao lưu"}] },
            "差": { hanviet: "SAI", mean: "Khác biệt", on: "サ", kun: "さ.す", tipImg: "Dê (**⺶**) làm việc công (**工**) bị sai.", tipSound: "**Sa** sai.", words: [{w:"交差点 (こうさてん)", m:"Ngã tư"}, {w:"差別 (さべつ)", m:"Phân biệt"}] },
            "点": { hanviet: "ĐIỂM", mean: "Điểm", on: "テン", kun: "", tipImg: "Chiếm (**占**) lấy lửa (**灬**) là điểm nóng.", tipSound: "**Ten** điểm.", words: [{w:"交差点 (こうさてん)", m:"Ngã tư"}, {w:"点数 (てんすう)", m:"Điểm số"}] },
            "信": { hanviet: "TÍN", mean: "Tin tưởng", on: "シン", kun: "", tipImg: "Lời nói (**言**) của người (**亻**) có uy tín.", tipSound: "**Shin**gou đèn tín hiệu.", words: [{w:"信号 (しんごう)", m:"Đèn giao thông"}, {w:"信用 (しんよう)", m:"Tin dùng"}] },
            "号": { hanviet: "HIỆU", mean: "Số hiệu", on: "ゴウ", kun: "", tipImg: "Miệng (**口**) kêu gào số 5 (**亏**).", tipSound: "**Gou** hiệu.", words: [{w:"信号 (しんごう)", m:"Đèn giao thông"}, {w:"番号 (ばんごう)", m:"Số hiệu"}] },
            "曲": { hanviet: "KHÚC", mean: "Cong/Rẽ", on: "キョク", kun: "ま.がる", tipImg: "Ruộng (**田**) bị uốn cong.", tipSound: "**Ma**garu rẽ.", words: [{w:"曲がります (まがります)", m:"Rẽ/Quẹo"}, {w:"曲 (きょく)", m:"Ca khúc"}] },
            "付": { hanviet: "PHÓ", mean: "Gắn vào", on: "フ", kun: "つ.ける", tipImg: "Người (**亻**) trao tấc (**寸**) lòng.", tipSound: "**Tsu**kemasu chú ý.", words: [{w:"気を付けます (きをつけます)", m:"Chú ý"}, {w:"受付 (うけつけ)", m:"Lễ tân"}] },
            "急": { hanviet: "CẤP", mean: "Vội", on: "キュウ", kun: "いそ.ぐ", tipImg: "Tim (**心**) bị đè nén (**刍**) rất gấp.", tipSound: "**Iso**gu vội.", words: [{w:"急ぎます (いそぎます)", m:"Vội/Gấp"}, {w:"急行 (きゅうこう)", m:"Tàu tốc hành"}] },
            "止": { hanviet: "CHỈ", mean: "Dừng", on: "シ", kun: "と.める", tipImg: "Dấu chân dừng lại.", tipSound: "**To**memasu dừng.", words: [{w:"止めます (とめます)", m:"Dừng xe"}, {w:"中止 (ちゅうし)", m:"Hủy bỏ"}] },
            "雨": { hanviet: "VŨ", mean: "Mưa", on: "ウ", kun: "あめ", tipImg: "Những hạt mưa rơi.", tipSound: "**Ame** mưa.", words: [{w:"雨 (あめ)", m:"Mưa"}, {w:"雨季 (うき)", m:"Mùa mưa"}] },
            "磨": { hanviet: "MA", mean: "Mài", on: "マ", kun: "みが.く", tipImg: "Cây gai (**麻**) mài lên đá (**石**).", tipSound: "**Miga**ku đánh răng.", words: [{w:"磨きます (みがきます)", m:"Đánh răng/Mài"}, {w:"研磨 (けんま)", m:"Mài giũa"}] }
        };

        // --- GRAMMAR CONFIGURATION ---
        const grammarDefs = {
            hoshii: {
                id: 'hoshii', label: 'Muốn có (Hoshii)', icon: 'favorite', type: 'noun',
                color: 'text-pink-600', bg: 'bg-pink-100',
                validFor: ['noun', 'food', 'clothes'],
                formula: 'N が ほしい',
                meaning: 'Diễn tả mong muốn sở hữu vật gì đó.',
                example: { ja: '新しい車が欲しいです。', vi: 'Tôi muốn có xe mới.' },
                gen: (w, f) => ({
                    polite: `${w.Furigana}が欲しいです。`,
                    politeVi: `Tôi muốn có ${w['Nghĩa tiếng Việt'].toLowerCase()}.`,
                    casual: `${w.Furigana}が欲しい。`,
                    casualVi: `Muốn có ${w['Nghĩa tiếng Việt'].toLowerCase()}.`
                })
            },
            tai: { 
                id: 'tai', label: 'Muốn làm (V-tai)', icon: 'directions_run', type: 'verb', 
                color: 'text-purple-600', bg: 'bg-purple-100',
                validFor: ['verb'], 
                formula: 'Vます(bỏ ます) + たい',
                meaning: 'Diễn tả mong muốn thực hiện hành động.',
                example: { ja: '日本へ行きたいです。', vi: 'Tôi muốn đi Nhật.' },
                gen: (w, f) => ({
                    polite: `${f.stem}たいです。`,
                    politeVi: `Tôi muốn ${w['Nghĩa tiếng Việt'].toLowerCase()}.`,
                    casual: `${f.stem}たい。`,
                    casualVi: `Muốn ${w['Nghĩa tiếng Việt'].toLowerCase()}.`
                })
            },
            te_kudasai: {
                id: 'te_kudasai', label: 'Hãy làm (Kudasai)', icon: 'back_hand', type: 'verb',
                color: 'text-blue-600', bg: 'bg-blue-100',
                validFor: ['verb'],
                formula: 'Vて + ください',
                meaning: 'Yêu cầu, sai khiến lịch sự.',
                example: { ja: 'ちょっと待ってください。', vi: 'Xin hãy chờ một chút.' },
                gen: (w, f) => ({
                    polite: `${f.te}ください。`,
                    politeVi: `Hãy ${w['Nghĩa tiếng Việt'].toLowerCase()}.`,
                    casual: `${f.te}。`,
                    casualVi: `${w['Nghĩa tiếng Việt']} đi.`
                })
            },
            counter: {
                id: 'counter', label: 'Số lượng', icon: 'looks_one', type: 'noun',
                color: 'text-green-600', bg: 'bg-green-100',
                validFor: ['counter'],
                formula: 'N + ga + [Số lượng] + arimasu/imasu',
                meaning: 'Đếm số lượng vật hoặc người.',
                example: { ja: 'りんごが二つあります。', vi: 'Có 2 quả táo.' },
                gen: (w, f) => ({
                    polite: `これが${w.Furigana}あります。`,
                    politeVi: `Có ${w['Nghĩa tiếng Việt'].toLowerCase()} cái này.`,
                    casual: `これ、${w.Furigana}あるよ。`,
                    casualVi: `Cái này có ${w['Nghĩa tiếng Việt'].toLowerCase()} đấy.`
                })
            },
            // Added Day 5 specific grammar
            comparison: {
                id: 'comparison', label: 'So sánh (Hơn/Nhất)', icon: 'leaderboard', type: 'noun',
                color: 'text-indigo-600', bg: 'bg-indigo-100',
                validFor: ['noun', 'place', 'food'],
                formula: 'N1 wa N2 yori...',
                meaning: 'So sánh hơn hoặc nhất.',
                example: { ja: '日本はベトナムより寒いです。', vi: 'Nhật Bản lạnh hơn Việt Nam.' },
                gen: (w, f) => ({
                    polite: `${w.Furigana}が一番好きです。`,
                    politeVi: `Tôi thích ${w['Nghĩa tiếng Việt'].toLowerCase()} nhất.`,
                    casual: `${w.Furigana}が一番好き。`,
                    casualVi: `Thích ${w['Nghĩa tiếng Việt'].toLowerCase()} nhất.`
                })
            },
            purpose: {
                id: 'purpose', label: 'Đi để... (Ni ikimasu)', icon: 'flight_takeoff', type: 'verb',
                color: 'text-orange-600', bg: 'bg-orange-100',
                validFor: ['verb'],
                formula: 'V(stem) + に + 行きます',
                meaning: 'Đi đâu đó để làm gì.',
                example: { ja: '日本へ働きに行きます。', vi: 'Tôi đi Nhật để làm việc.' },
                gen: (w, f) => ({
                    polite: `${f.stem}に行きます。`,
                    politeVi: `Đi để ${w['Nghĩa tiếng Việt'].toLowerCase()}.`,
                    casual: `${f.stem}に行く。`,
                    casualVi: `Đi ${w['Nghĩa tiếng Việt'].toLowerCase()} đây.`
                })
            }
        };

        // Helper to conjugate verbs
        const teFormMap = {'そうじします':'そうじして', 'はたらきます':'はたらいて', 'えらびます':'えらんで', 'かかります':'かかって', 'かいます':'かって', 'だします':'だして', 'いのります':'いのって', 'けんがくします':'けんがくして', 'かわきます':'かわいて', 'すきます':'すいて', 'つけます':'つけて', 'けします':'けして', 'あびます':'あびて', 'はいります':'はいって', 'でかけます':'でかけて', 'かけます':'かけて', 'おします':'おして', 'よやくします':'よやくして', 'まがります':'まがって', 'きをつけます':'きをつけて', 'いそぎます':'いそいで', 'とめます':'とめて', 'いれます':'いれて', 'やみます':'やんで', 'みがきます':'みがいて'};
        
        function getForms(furigana) {
            const stem = furigana.replace('ます', '');
            const te = teFormMap[furigana] || stem + 'て'; 
            const ta = te.replace('て', 'た').replace('で', 'だ');
            return { stem, te, ta };
        }

        // --- VOCABULARY DATA (Day 5 - 87 Words) ---
        const vocabData = [
            // Nouns & Food
            { "STT": 1, "Kanji": "", "Nghĩa tiếng Việt": "Bánh ngọt", "Furigana": "ケーキ", "type": "food" },
            { "STT": 2, "Kanji": "", "Nghĩa tiếng Việt": "Cả hai", "Furigana": "どちらも", "type": "noun" },
            // Verbs
            { "STT": 3, "Kanji": "掃除します", "Nghĩa tiếng Việt": "Dọn dẹp", "Furigana": "そうじします", "type": "verb" },
            { "STT": 4, "Kanji": "働きます", "Nghĩa tiếng Việt": "Làm việc", "Furigana": "はたらきます", "type": "verb" },
            { "STT": 5, "Kanji": "選びます", "Nghĩa tiếng Việt": "Chọn", "Furigana": "えらびます", "type": "verb" },
            // Units
            { "STT": 6, "Kanji": "", "Nghĩa tiếng Việt": "Mét", "Furigana": "メートル", "type": "counter" },
            { "STT": 7, "Kanji": "", "Nghĩa tiếng Việt": "Gram", "Furigana": "グラム", "type": "counter" },
            { "STT": 8, "Kanji": "", "Nghĩa tiếng Việt": "Tốn (tiền/thời gian)", "Furigana": "かかります", "type": "verb" },
            { "STT": 9, "Kanji": "", "Nghĩa tiếng Việt": "Khoảng", "Furigana": "ぐらい", "type": "noun" },
            { "STT": 10, "Kanji": "", "Nghĩa tiếng Việt": "Bao lâu", "Furigana": "どのぐらい", "type": "noun" },
            // Counters (General)
            { "STT": 11, "Kanji": "一つ", "Nghĩa tiếng Việt": "1 cái", "Furigana": "ひとつ", "type": "counter" },
            { "STT": 12, "Kanji": "二つ", "Nghĩa tiếng Việt": "2 cái", "Furigana": "ふたつ", "type": "counter" },
            { "STT": 13, "Kanji": "三つ", "Nghĩa tiếng Việt": "3 cái", "Furigana": "みっつ", "type": "counter" },
            { "STT": 14, "Kanji": "四つ", "Nghĩa tiếng Việt": "4 cái", "Furigana": "よっつ", "type": "counter" },
            { "STT": 15, "Kanji": "五つ", "Nghĩa tiếng Việt": "5 cái", "Furigana": "いつつ", "type": "counter" },
            { "STT": 16, "Kanji": "六つ", "Nghĩa tiếng Việt": "6 cái", "Furigana": "むっつ", "type": "counter" },
            { "STT": 17, "Kanji": "七つ", "Nghĩa tiếng Việt": "7 cái", "Furigana": "ななつ", "type": "counter" },
            { "STT": 18, "Kanji": "八つ", "Nghĩa tiếng Việt": "8 cái", "Furigana": "やっつ", "type": "counter" },
            { "STT": 19, "Kanji": "九つ", "Nghĩa tiếng Việt": "9 cái", "Furigana": "ここのつ", "type": "counter" },
            { "STT": 20, "Kanji": "十", "Nghĩa tiếng Việt": "10 cái", "Furigana": "とお", "type": "counter" },
            { "STT": 21, "Kanji": "", "Nghĩa tiếng Việt": "Bao nhiêu cái", "Furigana": "いくつ", "type": "noun" },
            // Specific Counters
            { "STT": 22, "Kanji": "〜回", "Nghĩa tiếng Việt": "Lần", "Furigana": "かい", "type": "counter" },
            { "STT": 23, "Kanji": "〜台", "Nghĩa tiếng Việt": "Cái (máy móc)", "Furigana": "だい", "type": "counter" },
            { "STT": 24, "Kanji": "〜枚", "Nghĩa tiếng Việt": "Tờ/tấm", "Furigana": "まい", "type": "counter" },
            { "STT": 25, "Kanji": "〜本", "Nghĩa tiếng Việt": "Cây/chai (thon dài)", "Furigana": "ほん", "type": "counter" },
            // Objects & Places
            { "STT": 26, "Kanji": "手紙", "Nghĩa tiếng Việt": "Bức thư", "Furigana": "てがみ", "type": "noun" },
            { "STT": 27, "Kanji": "", "Nghĩa tiếng Việt": "Rác", "Furigana": "ごみ", "type": "noun" },
            { "STT": 28, "Kanji": "お寺", "Nghĩa tiếng Việt": "Chùa", "Furigana": "おてら", "type": "place" },
            { "STT": 29, "Kanji": "郵便局", "Nghĩa tiếng Việt": "Bưu điện", "Furigana": "ゆうびんきょく", "type": "place" },
            { "STT": 30, "Kanji": "", "Nghĩa tiếng Việt": "TTTM", "Furigana": "デパート", "type": "place" },
            // Actions
            { "STT": 31, "Kanji": "買い物します", "Nghĩa tiếng Việt": "Mua sắm", "Furigana": "かいものします", "type": "verb" },
            { "STT": 32, "Kanji": "ごみを出します", "Nghĩa tiếng Việt": "Đổ rác", "Furigana": "ごみをだします", "type": "verb" },
            { "STT": 33, "Kanji": "祈ります", "Nghĩa tiếng Việt": "Cầu nguyện", "Furigana": "いのります", "type": "verb" },
            { "STT": 34, "Kanji": "見学します", "Nghĩa tiếng Việt": "Tham quan học tập", "Furigana": "けんがくします", "type": "verb" },
            // Adverbs/Nouns
            { "STT": 35, "Kanji": "一番", "Nghĩa tiếng Việt": "Nhất/Số 1", "Furigana": "いちばん", "type": "noun" },
            { "STT": 36, "Kanji": "世界", "Nghĩa tiếng Việt": "Thế giới", "Furigana": "せかい", "type": "noun" },
            // Seasons
            { "STT": 37, "Kanji": "季節", "Nghĩa tiếng Việt": "Mùa", "Furigana": "きせつ", "type": "noun" },
            { "STT": 38, "Kanji": "春", "Nghĩa tiếng Việt": "Mùa xuân", "Furigana": "はる", "type": "noun" },
            { "STT": 39, "Kanji": "夏", "Nghĩa tiếng Việt": "Mùa hè", "Furigana": "なつ", "type": "noun" },
            { "STT": 40, "Kanji": "秋", "Nghĩa tiếng Việt": "Mùa thu", "Furigana": "あき", "type": "noun" },
            { "STT": 41, "Kanji": "冬", "Nghĩa tiếng Việt": "Mùa đông", "Furigana": "ふゆ", "type": "noun" },
            // Categories
            { "STT": 42, "Kanji": "食べ物", "Nghĩa tiếng Việt": "Đồ ăn", "Furigana": "たべもの", "type": "food" },
            { "STT": 43, "Kanji": "飲み物", "Nghĩa tiếng Việt": "Đồ uống", "Furigana": "のみもの", "type": "food" },
            { "STT": 44, "Kanji": "乗り物", "Nghĩa tiếng Việt": "Phương tiện", "Furigana": "のりもの", "type": "noun" },
            { "STT": 45, "Kanji": "", "Nghĩa tiếng Việt": "Lớp học", "Furigana": "クラス", "type": "noun" },
            // Adjectives
            { "STT": 46, "Kanji": "大変", "Nghĩa tiếng Việt": "Vất vả", "Furigana": "たいへん", "type": "adj_na" },
            { "STT": 47, "Kanji": "嬉しい", "Nghĩa tiếng Việt": "Vui mừng", "Furigana": "うれしい", "type": "adj_i" },
            { "STT": 48, "Kanji": "週末", "Nghĩa tiếng Việt": "Cuối tuần", "Furigana": "しゅうまつ", "type": "noun" },
            { "STT": 49, "Kanji": "面積", "Nghĩa tiếng Việt": "Diện tích", "Furigana": "めんせき", "type": "noun" },
            // Phrases
            { "STT": 50, "Kanji": "のどが渇きます", "Nghĩa tiếng Việt": "Khát nước", "Furigana": "のどがかわきます", "type": "verb" },
            { "STT": 51, "Kanji": "お腹が空きます", "Nghĩa tiếng Việt": "Đói bụng", "Furigana": "おなかがすきます", "type": "verb" },
            // House Objects
            { "STT": 52, "Kanji": "電気", "Nghĩa tiếng Việt": "Điện/Đèn", "Furigana": "でんき", "type": "noun" },
            { "STT": 53, "Kanji": "お風呂", "Nghĩa tiếng Việt": "Bồn tắm", "Furigana": "おふろ", "type": "noun" },
            { "STT": 54, "Kanji": "鍵", "Nghĩa tiếng Việt": "Chìa khóa", "Furigana": "かぎ", "type": "noun" },
            { "STT": 55, "Kanji": "新聞", "Nghĩa tiếng Việt": "Báo", "Furigana": "しんぶん", "type": "noun" },
            { "STT": 56, "Kanji": "雑誌", "Nghĩa tiếng Việt": "Tạp chí", "Furigana": "ざっし", "type": "noun" },
            // Verbs (House)
            { "STT": 57, "Kanji": "", "Nghĩa tiếng Việt": "Bật (điện)", "Furigana": "つけます", "type": "verb" },
            { "STT": 58, "Kanji": "消します", "Nghĩa tiếng Việt": "Tắt (điện)", "Furigana": "けします", "type": "verb" },
            { "STT": 59, "Kanji": "浴びます", "Nghĩa tiếng Việt": "Tắm (sen)", "Furigana": "あびます", "type": "verb" },
            { "STT": 60, "Kanji": "入ります", "Nghĩa tiếng Việt": "Vào (bồn)", "Furigana": "はいります", "type": "verb" },
            { "STT": 61, "Kanji": "出かけます", "Nghĩa tiếng Việt": "Ra ngoài", "Furigana": "でかけます", "type": "verb" },
            { "STT": 62, "Kanji": "鍵を掛けます", "Nghĩa tiếng Việt": "Khóa cửa", "Furigana": "かぎをかけます", "type": "verb" },
            { "STT": 63, "Kanji": "押します", "Nghĩa tiếng Việt": "Ấn/Đẩy", "Furigana": "おします", "type": "verb" },
            { "STT": 64, "Kanji": "洗濯機", "Nghĩa tiếng Việt": "Máy giặt", "Furigana": "せんたくき", "type": "noun" },
            { "STT": 65, "Kanji": "", "Nghĩa tiếng Việt": "Sau đó", "Furigana": "それから", "type": "noun" },
            // Activities & Nouns
            { "STT": 66, "Kanji": "", "Nghĩa tiếng Việt": "Hòa nhạc", "Furigana": "コンサート", "type": "noun" },
            { "STT": 67, "Kanji": "独身", "Nghĩa tiếng Việt": "Độc thân", "Furigana": "どくしん", "type": "noun" },
            { "STT": 68, "Kanji": "資料", "Nghĩa tiếng Việt": "Tài liệu", "Furigana": "しりょう", "type": "noun" },
            { "STT": 69, "Kanji": "電話", "Nghĩa tiếng Việt": "Điện thoại", "Furigana": "でんわ", "type": "noun" },
            { "STT": 70, "Kanji": "予約", "Nghĩa tiếng Việt": "Đặt trước", "Furigana": "よやく", "type": "noun" },
            { "STT": 71, "Kanji": "歯", "Nghĩa tiếng Việt": "Răng", "Furigana": "は", "type": "noun" },
            { "STT": 72, "Kanji": "顔", "Nghĩa tiếng Việt": "Mặt", "Furigana": "かお", "type": "noun" },
            { "STT": 73, "Kanji": "試合", "Nghĩa tiếng Việt": "Trận đấu", "Furigana": "しあい", "type": "noun" },
            { "STT": 74, "Kanji": "", "Nghĩa tiếng Việt": "Báo cáo", "Furigana": "レポート", "type": "noun" },
            // Seasonings
            { "STT": 75, "Kanji": "砂糖", "Nghĩa tiếng Việt": "Đường", "Furigana": "さとう", "type": "food" },
            { "STT": 76, "Kanji": "塩", "Nghĩa tiếng Việt": "Muối", "Furigana": "しお", "type": "food" },
            { "STT": 77, "Kanji": "", "Nghĩa tiếng Việt": "Nước tương", "Furigana": "しょうゆ", "type": "food" },
            // Traffic & Directions
            { "STT": 78, "Kanji": "住所", "Nghĩa tiếng Việt": "Địa chỉ", "Furigana": "じゅうしょ", "type": "noun" },
            { "STT": 79, "Kanji": "交差点", "Nghĩa tiếng Việt": "Ngã tư", "Furigana": "こうさてん", "type": "place" },
            { "STT": 80, "Kanji": "信号", "Nghĩa tiếng Việt": "Đèn giao thông", "Furigana": "しんごう", "type": "noun" },
            { "STT": 81, "Kanji": "曲がります", "Nghĩa tiếng Việt": "Rẽ/Quẹo", "Furigana": "まがります", "type": "verb" },
            { "STT": 82, "Kanji": "気を付けます", "Nghĩa tiếng Việt": "Chú ý", "Furigana": "きをつけます", "type": "verb" },
            { "STT": 83, "Kanji": "急ぎます", "Nghĩa tiếng Việt": "Vội/Gấp", "Furigana": "いそぎます", "type": "verb" },
            { "STT": 84, "Kanji": "止めます", "Nghĩa tiếng Việt": "Dừng", "Furigana": "とめます", "type": "verb" },
            { "STT": 85, "Kanji": "入れます", "Nghĩa tiếng Việt": "Cho vào", "Furigana": "いれます", "type": "verb" },
            { "STT": 86, "Kanji": "雨がやみます", "Nghĩa tiếng Việt": "Tạnh mưa", "Furigana": "あめがやみます", "type": "verb" },
            { "STT": 87, "Kanji": "磨きます", "Nghĩa tiếng Việt": "Đánh răng/Mài", "Furigana": "みがきます", "type": "verb" }
        ].filter(i => i.Furigana);

        let currentIndex = 0; let currentQuiz = null; let score = 0; let currentStrokeSvg = null;

        // --- CORE FUNCTIONS ---
        function init() { renderList(); renderGrammarList(); loadWord(0); }
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            document.getElementById('learn-section').classList.toggle('hidden', tab!=='learn');
            document.getElementById('quiz-section').classList.toggle('hidden', tab!=='quiz');
            if(tab === 'quiz') nextQuestion();
        }
        function renderList() {
            const listD = document.getElementById('vocabList'); const listM = document.getElementById('mobileVocabList');
            const html = vocabData.map((item, i) => `
                <div class="vocab-item p-3 mb-1 rounded-xl cursor-pointer hover:bg-indigo-50 transition-colors border-l-4 border-transparent ${i===0?'active':''}" 
                     data-index="${i}" onclick="loadWord(${i}); if(window.innerWidth<768) toggleDrawer();">
                    <div class="flex justify-between items-center"><span class="font-bold text-gray-800 ja-text">${item.Kanji||item.Furigana}</span><span class="text-[10px] font-bold text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded">#${item.STT}</span></div>
                    <div class="text-xs text-gray-500 truncate mt-0.5">${item['Nghĩa tiếng Việt']}</div>
                </div>`).join('');
            if(listD) listD.innerHTML = html; if(listM) listM.innerHTML = html;
        }
        function loadWord(idx) {
            currentIndex = idx; const word = vocabData[idx];
            document.querySelectorAll('.vocab-item').forEach(el => { el.classList.remove('active'); el.classList.add('border-transparent'); });
            document.querySelectorAll(`.vocab-item[data-index="${idx}"]`).forEach(el => { el.classList.add('active'); el.classList.remove('border-transparent'); });
            
            document.getElementById('headerProgress').innerText = `${idx+1}/${vocabData.length}`;
            const wi = document.getElementById('wordIndex'); if(wi) wi.innerText = `#${word.STT}`;
            document.getElementById('cardKanji').innerText = word.Kanji || word.Furigana;
            document.getElementById('cardFurigana').innerText = word.Furigana;
            document.getElementById('cardMeaning').innerText = word['Nghĩa tiếng Việt'];
            document.getElementById('wordType').innerText = word.type.toUpperCase();
            
            const hasK = word.Kanji && word.Kanji !== word.Furigana;
            const sb = document.getElementById('strokeBtn'); if(sb) sb.classList.toggle('hidden', !hasK);
            renderContexts(word);
        }
        function renderContexts(word) {
            const cont = document.getElementById('sentenceList'); const empty = document.getElementById('emptyState');
            cont.innerHTML = ''; let hasContext = false;
            Object.values(grammarDefs).forEach(rule => {
                const subType = word.subType || 'general';
                if (!rule.validFor.includes(word.type) && !rule.validFor.includes(subType)) return;
                
                let forms = {};
                if(word.type==='verb') forms = getForms(word.Furigana);
                
                const data = rule.gen(word, forms);
                if(!data) return;
                hasContext = true;
                
                const card = document.createElement('div');
                card.className = "shadow-card bg-white rounded-2xl p-4 border border-gray-100";
                card.innerHTML = `
                    <div class="flex items-center justify-between mb-3 border-b border-gray-50 pb-2">
                        <div class="flex items-center gap-2"><div class="${rule.bg} p-1.5 rounded-lg ${rule.color}"><i class="fas fa-${rule.icon}"></i></div><span class="text-xs font-bold text-gray-500 uppercase tracking-wide">${rule.label}</span></div>
                        <button onclick="openGrammarDetail('${rule.id}')" class="text-xs text-indigo-500 bg-indigo-50 hover:bg-indigo-100 px-3 py-1 rounded-full transition flex items-center gap-1"><i class="fas fa-book-open"></i> Ngữ pháp</button>
                    </div>
                    <div class="mb-3 pl-3 border-l-2 border-indigo-200">
                        <div class="flex justify-between items-start"><div><div class="text-base font-medium text-gray-800 ja-text leading-relaxed">${data.polite}</div><div class="text-xs text-gray-500 italic mt-0.5">${data.politeVi}</div></div><button onclick="speakText('${data.polite}')" class="audio-btn text-indigo-400 hover:text-indigo-600 p-1"><i class="fas fa-volume-up"></i></button></div>
                    </div>
                    <div class="pl-3 border-l-2 border-pink-200">
                        <div class="flex justify-between items-start"><div><div class="flex items-center gap-2"><div class="text-base font-medium text-gray-800 ja-text leading-relaxed">${data.casual}</div><span class="text-[10px] bg-pink-50 text-pink-600 px-1.5 rounded font-bold">Thân mật</span></div><div class="text-xs text-gray-500 italic mt-0.5">${data.casualVi}</div></div><button onclick="speakText('${data.casual}')" class="audio-btn text-pink-400 hover:text-pink-600 p-1"><i class="fas fa-volume-up"></i></button></div>
                    </div>`;
                cont.appendChild(card);
            });
            empty.classList.toggle('hidden', hasContext); empty.classList.toggle('flex', !hasContext);
        }
        
        // --- MODAL LOGIC ---
        function renderGrammarList() {
            const grid = document.getElementById('grammarGrid'); grid.innerHTML = '';
            Object.values(grammarDefs).forEach(r => {
                grid.innerHTML += `<div class="bg-white rounded-xl border border-gray-100 p-4 shadow-sm hover:shadow-md transition cursor-pointer" onclick="closeModal('grammarListModal'); openGrammarDetail('${r.id}')"><div class="flex items-center gap-3 mb-3"><div class="w-10 h-10 rounded-full ${r.bg} ${r.color} flex items-center justify-center shadow-sm"><i class="fas fa-${r.icon} text-sm"></i></div><h4 class="font-bold text-gray-800 text-sm">${r.label}</h4></div><div class="bg-slate-50 rounded px-2 py-1 text-xs font-mono text-slate-600 mb-2 inline-block border border-slate-100">${r.formula}</div><p class="text-xs text-gray-500 line-clamp-2 leading-relaxed">${r.meaning}</p></div>`;
            });
        }
        function openGrammarList() { showModal('grammarListModal'); }
        function openGrammarDetail(id) {
            const r = grammarDefs[id]; if(!r) return;
            document.getElementById('modalTitle').innerText = r.label; document.getElementById('modalIcon').className = `fas fa-${r.icon}`;
            document.getElementById('modalFormula').innerText = r.formula; document.getElementById('modalExplanation').innerText = r.meaning;
            document.getElementById('modalExampleJa').innerText = r.example.ja; document.getElementById('modalExampleVi').innerText = r.example.vi;
            document.getElementById('modalPlayBtn').onclick = () => speakText(r.example.ja);
            showModal('detailModal');
        }
        function showModal(id) {
            document.getElementById(id).classList.remove('hidden');
            requestAnimationFrame(() => {
                document.getElementById(id.replace('Modal','Backdrop')).classList.remove('opacity-0'); 
                document.getElementById(id.replace('Modal','Panel')).classList.remove('opacity-0', 'scale-95');
            });
        }
        function closeModal(id) {
            document.getElementById(id.replace('Modal','Backdrop')).classList.add('opacity-0');
            document.getElementById(id.replace('Modal','Panel')).classList.add('opacity-0', 'scale-95');
            setTimeout(() => document.getElementById(id).classList.add('hidden'), 200);
        }
        
        async function openStrokeModal(char) {
            const word = vocabData[currentIndex]; const kanjis = word.Kanji.match(/[\u4e00-\u9faf]/g)||[];
            if(kanjis.length===0) return;
            const target = char || kanjis[0];
            const tabs = document.getElementById('strokeTabs'); tabs.innerHTML = '';
            if(kanjis.length>1) kanjis.forEach(k => {
                const b = document.createElement('button'); b.innerText = k;
                b.className = `w-12 h-12 rounded-xl font-bold border-2 transition text-lg ${k===target?'bg-pink-600 border-pink-600 text-white shadow-lg':'bg-white border-gray-100 text-gray-400 hover:border-pink-200'}`;
                b.onclick = () => showKanjiStroke(k); tabs.appendChild(b);
            });
            showModal('strokeModal'); await showKanjiStroke(target);
        }
        function getKanjiHex(k) { return k.charCodeAt(0).toString(16).padStart(5, '0'); }
        async function showKanjiStroke(k) {
            const d = kanjiDetails[k]; const content = document.getElementById('kanjiDetailContent'); const empty = document.getElementById('kanjiDetailEmpty');
            if(d) {
                content.classList.remove('hidden'); empty.classList.add('hidden');
                document.getElementById('detailKanji').innerText=k; document.getElementById('detailHanViet').innerText=d.hanviet;
                document.getElementById('detailMeaning').innerText=d.mean; document.getElementById('detailOn').innerText=d.on; document.getElementById('detailKun').innerText=d.kun;
                const fmt = s => s.replace(/\*\*(.*?)\*\*/g, '<span class="font-bold text-gray-900">$1</span>');
                document.getElementById('detailTipImg').innerHTML=fmt(d.tipImg); document.getElementById('detailTipSound').innerHTML=fmt(d.tipSound);
                const wc = document.getElementById('detailWords'); wc.innerHTML='';
                d.words.forEach(w => wc.innerHTML+=`<div class="flex justify-between items-center bg-gray-50 p-2 rounded hover:bg-gray-100 cursor-pointer border border-transparent hover:border-indigo-100 transition-colors" onclick="speakText('${w.w.split(' ')[0]}')"><span class="text-sm font-bold text-indigo-700 ja-text">${w.w}</span><span class="text-xs text-gray-500">${w.m}</span></div>`);
            } else { content.classList.add('hidden'); empty.classList.remove('hidden'); }
            
            const anim = document.getElementById('strokeAnimContainer'); const grid = document.getElementById('strokeGridContainer');
            anim.innerHTML = '<span class="text-xs text-gray-400 animate-pulse">Đang tải...</span>'; grid.innerHTML='';
            try {
                // Using jsDelivr for better CDN reliability
                const r = await fetch(`https://cdn.jsdelivr.net/gh/KanjiVG/kanjivg/kanji/${getKanjiHex(k)}.svg`);
                if(!r.ok) throw new Error();
                const svg = await r.text();
                anim.innerHTML = svg;
                const mainSvg = anim.querySelector('svg'); mainSvg.setAttribute('width','100%'); mainSvg.setAttribute('height','100%');
                currentStrokeSvg = mainSvg;
                const paths = mainSvg.querySelectorAll('path');
                paths.forEach(p => { p.style.stroke="#333"; p.style.strokeWidth="4"; p.style.fill="none"; p.style.strokeLinecap="round"; p.style.strokeLinejoin="round"; });
                replayStrokeAnimation();
                const parser = new DOMParser();
                paths.forEach((_, i) => {
                    const box = document.createElement('div'); box.className="w-16 h-16 bg-white border border-gray-200 relative stroke-grid-box flex items-center justify-center rounded";
                    const cloneDoc = parser.parseFromString(svg, "image/svg+xml"); const clone = cloneDoc.querySelector('svg');
                    clone.setAttribute('width','100%'); clone.setAttribute('height','100%');
                    clone.querySelectorAll('path').forEach((p, idx) => {
                        p.style.fill="none"; p.style.strokeLinecap="round"; p.style.strokeLinejoin="round";
                        if(idx<i) { p.style.stroke="#d1d5db"; p.style.strokeWidth="3"; }
                        else if(idx===i) { p.style.stroke="#db2777"; p.style.strokeWidth="4"; }
                        else p.style.display="none";
                    });
                    box.appendChild(clone); grid.appendChild(box);
                });
            } catch(e) { anim.innerHTML="<p class='text-xs text-red-500'>Lỗi tải</p>"; }
        }
        function replayStrokeAnimation() {
            if(!currentStrokeSvg) return;
            const paths = currentStrokeSvg.querySelectorAll('path');
            paths.forEach(p => { p.style.transition='none'; p.style.strokeDasharray=p.getTotalLength(); p.style.strokeDashoffset=p.getTotalLength(); });
            void currentStrokeSvg.offsetWidth;
            let d = 0;
            paths.forEach(p => { p.style.transition=`stroke-dashoffset 0.8s ease-in-out ${d}s`; p.style.strokeDashoffset='0'; d+=0.8; });
        }

        // --- UTILS ---
        function speakText(t) { 
            const u = new SpeechSynthesisUtterance(t); 
            u.lang='ja-JP'; 
            u.rate = 0.9; // Slightly slower for learning
            speechSynthesis.speak(u); 
        }
        function speakCurrent() { speakText(vocabData[currentIndex].Furigana); }
        function playQuizAudio() { if(currentQuiz) speakText(currentQuiz.Furigana); }
        function toggleDrawer() {
            const d = document.getElementById('mobileDrawer'); const c = document.getElementById('drawerContent'); const b = document.getElementById('drawerBackdrop');
            if(d.classList.contains('pointer-events-none')) { d.classList.remove('pointer-events-none'); requestAnimationFrame(() => { c.classList.remove('-translate-x-full'); b.classList.remove('opacity-0'); }); }
            else { c.classList.add('-translate-x-full'); b.classList.add('opacity-0'); setTimeout(() => d.classList.add('pointer-events-none'), 300); }
        }
        
        // --- QUIZ ---
        function nextQuestion() {
            document.getElementById('feedback-area').classList.add('hidden'); document.getElementById('btn-check').classList.remove('hidden'); document.getElementById('btn-next').classList.add('hidden');
            const inp = document.getElementById('quiz-input'); inp.value=''; inp.disabled=false; inp.focus();
            currentQuiz = vocabData[Math.floor(Math.random()*vocabData.length)];
            document.getElementById('quiz-kanji').innerText = currentQuiz.Kanji || currentQuiz.Furigana;
            document.getElementById('quiz-meaning').innerText = currentQuiz['Nghĩa tiếng Việt'];
            document.getElementById('quiz-kanji').className = "text-6xl md:text-7xl kanji-font font-bold text-gray-800 mb-4 transition-all py-4";
        }
        function checkAnswer() {
            const inp = document.getElementById('quiz-input'); if(!inp.value.trim()) return;
            inp.disabled=true; const correct = inp.value.trim()===currentQuiz.Furigana;
            const k = document.getElementById('quiz-kanji'); const fb = document.getElementById('feedback-title');
            if(correct) { score+=10; k.className+=" text-green-600 correct-anim"; fb.innerHTML='<i class="fas fa-check-circle text-green-600 mr-2"></i> Chính xác!'; speakText(currentQuiz.Furigana); }
            else { score=Math.max(0,score-5); k.className+=" text-red-600 wrong-anim"; fb.innerHTML='<i class="fas fa-times-circle text-red-600 mr-2"></i> Sai rồi!'; }
            document.getElementById('score-display').innerText=score; document.getElementById('correct-answer').innerText=currentQuiz.Furigana;
            document.getElementById('feedback-area').classList.remove('hidden'); document.getElementById('btn-check').classList.add('hidden'); document.getElementById('btn-next').classList.remove('hidden'); document.getElementById('btn-next').focus();
        }

        // Listeners
        function nextWord() { if(currentIndex<vocabData.length-1) loadWord(currentIndex+1); }
        function prevWord() { if(currentIndex>0) loadWord(currentIndex-1); }
        document.getElementById('searchInput').addEventListener('input', e => { const t = e.target.value.toLowerCase(); document.querySelectorAll('.vocab-item').forEach(el => el.style.display = el.innerText.toLowerCase().includes(t) ? 'block' : 'none'); });
        document.getElementById('mobileSearchInput').addEventListener('input', e => { const t = e.target.value.toLowerCase(); document.querySelectorAll('.vocab-item').forEach(el => el.style.display = el.innerText.toLowerCase().includes(t) ? 'block' : 'none'); });
        document.getElementById('quiz-input').addEventListener('keypress', e => { if(e.key==='Enter') checkAnswer(); });

        init();
    </script>
</body>
</html>
