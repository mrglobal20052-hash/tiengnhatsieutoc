<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AzaKanji Tango - Ngày 29: Truyền đạt & Phủ định</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Base Settings */
        body { font-family: 'Nunito', 'Inter', sans-serif; background-color: #f3f4f6; height: 100dvh; overflow: hidden; }
        .ja-text { font-family: 'Noto Sans JP', sans-serif; }
        
        /* Custom Scrollbar */
        .scroller { -webkit-overflow-scrolling: touch; overflow-y: auto; }
        .scroller::-webkit-scrollbar { width: 5px; height: 5px; }
        .scroller::-webkit-scrollbar-track { background: transparent; }
        .scroller::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* UI Components */
        .vocab-item { transition: all 0.2s; }
        .vocab-item.active { background-color: #eef2ff; border-left: 4px solid #4f46e5; color: #4338ca; padding-left: 0.75rem; }
        
        .shadow-card { transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.2s; }
        .shadow-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border-top: 1px solid rgba(255, 255, 255, 0.3); }
        
        .tab-btn.active { background-color: white; color: #312e81; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); }
        .tab-btn { color: #a5b4fc; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .wrong-anim { animation: shake 0.3s ease-in-out; }
        
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .correct-anim { animation: pop 0.3s ease-in-out; }

        /* Stroke Order Logic CSS */
        .stroke-grid-box { border: 1px solid #e5e7eb; background-color: white; position: relative; }
        .stroke-grid-box::after { content: ''; position: absolute; top: 0; left: 50%; width: 1px; height: 100%; background: repeating-linear-gradient(to bottom, #ddd 0, #ddd 4px, transparent 4px, transparent 8px); pointer-events: none; }
        .stroke-grid-box::before { content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 1px; background: repeating-linear-gradient(to right, #ddd 0, #ddd 4px, transparent 4px, transparent 8px); pointer-events: none; }
        
        /* Hide stroke paths initially for animation */
        #strokeAnimContainer svg path { opacity: 0; }
    </style>
</head>
<body class="flex flex-col text-slate-800">

    <!-- HEADER -->
    <header class="bg-indigo-700 text-white shadow-lg flex-none z-40 relative">
        <div class="container mx-auto px-4 py-2 md:py-3">
            <div class="flex flex-col md:flex-row justify-between items-center gap-3">
                <div class="flex items-center gap-3 cursor-pointer select-none w-full md:w-auto justify-between" onclick="location.reload()">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-torii-gate text-3xl text-white"></i>
                        <div>
                            <h1 class="text-lg md:text-xl font-bold uppercase tracking-wider">AzaKanji Tango</h1>
                            <p class="text-[10px] md:text-xs text-indigo-200">Ngày 29: Truyền đạt & Phủ định</p>
                        </div>
                    </div>
                    <div class="md:hidden text-xs font-semibold bg-indigo-800 px-3 py-1 rounded-full border border-indigo-500/50"><span id="headerProgress">1/87</span></div>
                </div>
                <div class="flex items-center gap-3 w-full md:w-auto">
                    <div class="flex bg-indigo-900/50 rounded-lg p-1 w-full md:w-auto overflow-x-auto no-scrollbar">
                        <button onclick="switchTab('learn')" id="tab-learn" class="tab-btn active flex-1 md:flex-none px-4 py-1.5 rounded-md text-sm font-bold transition flex items-center justify-center gap-2 whitespace-nowrap"><i class="fas fa-book-open"></i> Học Từ</button>
                        <button onclick="switchTab('quiz')" id="tab-quiz" class="tab-btn flex-1 md:flex-none px-4 py-1.5 rounded-md text-sm font-bold transition flex items-center justify-center gap-2 whitespace-nowrap"><i class="fas fa-keyboard"></i> Kiểm Tra</button>
                        <div class="w-px bg-indigo-600 mx-1"></div>
                        <button onclick="openGrammarList()" class="tab-btn flex-1 md:flex-none px-4 py-1.5 rounded-md text-sm font-bold transition flex items-center justify-center gap-2 whitespace-nowrap"><i class="fas fa-scroll"></i> Cẩm Nang</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative w-full">
        <!-- DESKTOP SIDEBAR -->
        <aside class="hidden md:flex w-72 bg-white border-r border-gray-200 flex-col z-10">
            <div class="p-4 border-b border-gray-100 bg-gray-50">
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i>
                    <input type="text" id="searchInput" placeholder="Tìm kiếm từ..." class="w-full pl-9 pr-4 py-2 bg-white border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 transition-all shadow-sm outline-none">
                </div>
            </div>
            <div id="vocabList" class="flex-1 scroller p-2 space-y-1"></div>
        </aside>

        <!-- MAIN CONTENT (LEARN MODE) -->
        <main id="learn-section" class="flex-1 overflow-y-auto scroller bg-slate-50 p-4 pb-28 w-full scroll-smooth">
            <div class="max-w-3xl mx-auto flex flex-col items-center animate-fade-in">
                <!-- Flashcard -->
                <div class="w-full bg-white rounded-2xl p-6 shadow-sm border border-gray-200 mb-6 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-indigo-50 to-pink-50 rounded-bl-full -mr-8 -mt-8 z-0 opacity-60 transition-transform group-hover:scale-110 duration-700"></div>
                    <div class="relative z-10 text-center">
                        <div class="inline-flex items-center gap-2 bg-gray-50 px-3 py-1 rounded-full mb-4 border border-gray-100">
                            <span id="wordType" class="text-[10px] font-bold uppercase text-indigo-500">WORD</span>
                            <div class="w-px h-3 bg-gray-300"></div>
                            <span class="text-[10px] text-gray-400 font-mono" id="wordIndex">#1</span>
                        </div>
                        <div class="relative inline-block mb-2">
                            <h2 id="cardKanji" class="text-5xl md:text-6xl font-bold text-gray-800 ja-text tracking-tight cursor-pointer hover:text-indigo-700 transition-colors" onclick="speakCurrent()">混雑する</h2>
                            <button id="strokeBtn" onclick="openStrokeModal()" class="absolute -right-10 top-2 w-8 h-8 bg-pink-100 text-pink-600 rounded-full flex items-center justify-center shadow-sm hover:bg-pink-200 hover:scale-110 transition-all hidden" title="Tập viết">
                                <i class="fas fa-pen-nib text-sm"></i>
                            </button>
                        </div>
                        <div class="flex flex-col items-center gap-1 cursor-pointer" onclick="speakCurrent()">
                            <span id="cardFurigana" class="text-xl text-indigo-600 font-medium ja-text">こんざつする</span>
                            <span id="cardMeaning" class="text-lg text-gray-500 font-medium">Đông đúc</span>
                        </div>
                    </div>
                </div>

                <!-- Shadowing Sentences -->
                <div class="w-full">
                    <div class="flex items-center gap-2 mb-4 px-1">
                        <div class="bg-pink-100 text-pink-600 p-1.5 rounded-lg text-sm"><i class="fas fa-comments"></i></div>
                        <h3 class="font-bold text-gray-700 text-lg">Hội thoại & Ví dụ</h3>
                    </div>
                    <div id="sentenceList" class="space-y-4"></div>
                    
                    <!-- Empty State -->
                    <div id="emptyState" class="hidden flex-col items-center justify-center p-8 text-center bg-white rounded-2xl border border-dashed border-gray-300 text-gray-400">
                        <i class="fas fa-comment-dots text-4xl mb-2 text-gray-300"></i>
                        <p class="text-sm">Chưa có hội thoại mẫu cho từ này.</p>
                        <p class="text-xs text-gray-300 mt-1">(Dữ liệu đang cập nhật)</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- QUIZ MODE -->
        <div id="quiz-section" class="hidden flex-1 w-full overflow-y-auto scroller bg-slate-100 p-4 absolute inset-0 z-20">
            <div class="max-w-2xl mx-auto mt-4 md:mt-10 animate-fade-in">
                <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-200">
                    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-6 text-white flex justify-between items-center relative overflow-hidden">
                        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                        <div class="relative z-10">
                            <h2 class="text-2xl font-bold flex items-center gap-2"><i class="fas fa-graduation-cap"></i> Thử Thách</h2>
                            <p class="text-indigo-100 text-sm">Nhìn Kanji - Đoán Hiragana</p>
                        </div>
                        <div class="text-right relative z-10 bg-white/10 p-2 rounded-lg backdrop-blur-sm">
                            <div class="text-[10px] text-indigo-100 uppercase font-bold tracking-wider">Điểm số</div>
                            <div class="text-3xl font-bold font-mono" id="score-display">0</div>
                        </div>
                    </div>
                    
                    <div class="p-6 md:p-10 text-center">
                        <div class="mb-8 relative">
                            <div class="text-xs text-gray-400 mb-2 uppercase font-bold tracking-widest">Từ này đọc là gì?</div>
                            <div id="quiz-kanji" class="text-6xl ja-text font-bold text-gray-800 mb-4 transition-all inline-block"></div>
                            <div id="quiz-meaning" class="text-lg text-indigo-600 font-bold mb-2"></div>
                        </div>
                        
                        <div class="relative max-w-md mx-auto mb-8">
                            <input type="text" id="quiz-input" class="w-full text-center text-2xl p-4 border-2 border-gray-300 rounded-xl focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 outline-none transition-all ja-text placeholder:text-gray-300" placeholder="nhập hiragana..." autocomplete="off">
                        </div>
                        
                        <div id="feedback-area" class="hidden rounded-xl p-5 bg-gray-50 border border-gray-200 text-left mb-6 animate-fade-in shadow-inner">
                            <div id="feedback-title" class="font-bold text-lg mb-2 flex items-center"></div>
                            <div class="text-gray-700 mb-3 flex items-center flex-wrap gap-2">
                                Đáp án đúng: <span id="correct-answer" class="font-bold text-xl text-indigo-600 px-3 py-1 bg-white border border-indigo-100 rounded-lg ja-text shadow-sm"></span>
                                <button onclick="playQuizAudio()" class="text-gray-400 hover:text-indigo-600 transition-colors w-8 h-8 rounded-full flex items-center justify-center hover:bg-gray-200 border border-transparent hover:border-gray-300"><i class="fas fa-volume-up"></i></button>
                            </div>
                        </div>
                        
                        <div>
                            <button id="btn-check" onclick="checkAnswer()" class="w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 px-10 rounded-xl shadow-lg transition active:scale-95 text-lg flex items-center justify-center gap-2 mx-auto">
                                <i class="fas fa-check"></i> Kiểm Tra
                            </button>
                            <button id="btn-next" onclick="nextQuestion()" class="hidden w-full md:w-auto bg-gray-800 hover:bg-gray-900 text-white font-bold py-3.5 px-10 rounded-xl shadow-lg transition active:scale-95 text-lg flex items-center justify-center gap-2 mx-auto">
                                Câu Tiếp Theo <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MOBILE BOTTOM BAR -->
        <div class="fixed bottom-0 left-0 right-0 glass px-4 py-3 pb-6 z-30 flex items-center justify-between gap-4 md:hidden shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] border-t border-gray-200">
            <button onclick="prevWord()" class="w-12 h-12 rounded-xl bg-white border border-gray-200 text-gray-600 flex items-center justify-center shadow-sm active:bg-gray-50 active:scale-95 transition">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button onclick="toggleDrawer()" class="flex-1 h-12 rounded-xl bg-indigo-600 text-white font-bold flex items-center justify-center shadow-lg gap-2 active:scale-95 transition active:bg-indigo-700">
                <i class="fas fa-list-ul"></i> Danh Sách
            </button>
            <button onclick="nextWord()" class="w-12 h-12 rounded-xl bg-white border border-gray-200 text-gray-600 flex items-center justify-center shadow-sm active:bg-gray-50 active:scale-95 transition">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        
        <!-- MOBILE DRAWER -->
        <div id="mobileDrawer" class="fixed inset-0 z-50 pointer-events-none flex">
            <div id="drawerBackdrop" class="absolute inset-0 bg-gray-900/50 opacity-0 transition-opacity" onclick="toggleDrawer()"></div>
            <div id="drawerContent" class="relative w-72 bg-white h-full shadow-2xl transition-transform -translate-x-full flex flex-col pointer-events-auto">
                <div class="p-4 bg-indigo-700 text-white flex justify-between items-center">
                    <h2 class="font-bold">Danh sách từ vựng</h2>
                    <button onclick="toggleDrawer()"><i class="fas fa-times"></i></button>
                </div>
                <div class="p-4 border-b border-gray-100 bg-gray-50">
                    <input type="text" id="mobileSearchInput" placeholder="Tìm kiếm nhanh..." class="w-full px-4 py-2 bg-white border border-gray-200 rounded-xl text-sm outline-none">
                </div>
                <div id="mobileVocabList" class="flex-1 overflow-y-auto scroller p-2 space-y-1"></div>
            </div>
        </div>
    </div>

    <!-- MODAL: GRAMMAR LIST -->
    <div id="grammarListModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-gray-900/70 backdrop-blur-sm transition-opacity opacity-0" id="grammarListBackdrop" onclick="closeModal('grammarListModal')"></div>
        <div class="bg-white rounded-2xl w-full max-w-4xl relative z-10 shadow-2xl transform transition-all scale-95 opacity-0 flex flex-col max-h-[85vh]" id="grammarListPanel">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-indigo-50 rounded-t-2xl">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-600 text-white p-2 rounded-lg shadow-sm"><i class="fas fa-book"></i></div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-800">Cẩm Nang Ngữ Pháp</h3>
                        <p class="text-xs text-gray-500">Thư viện ngữ pháp Day 29</p>
                    </div>
                </div>
                <button onclick="closeModal('grammarListModal')" class="w-8 h-8 rounded-full hover:bg-white flex items-center justify-center text-gray-500 transition-colors"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto scroller bg-slate-50">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="grammarGrid"></div>
            </div>
            <div class="p-4 border-t border-gray-100 bg-white rounded-b-2xl flex justify-end">
                <button onclick="closeModal('grammarListModal')" class="px-6 py-2 bg-gray-800 text-white font-bold rounded-full text-sm transition active:scale-95 shadow-lg hover:bg-gray-700">Đã Hiểu</button>
            </div>
        </div>
    </div>

    <!-- MODAL: GRAMMAR DETAIL -->
    <div id="detailGrammarModal" class="fixed inset-0 z-[90] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity opacity-0" id="detailGrammarBackdrop" onclick="closeModal('detailGrammarModal')"></div>
        <div class="bg-white rounded-2xl w-full max-w-md relative z-10 shadow-2xl transform transition-all scale-95 opacity-0 flex flex-col" id="detailGrammarPanel">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 rounded-t-2xl">
                <div class="flex items-center gap-2">
                    <div class="bg-indigo-100 p-1.5 rounded-lg text-indigo-600"><i class="fas fa-info-circle"></i></div>
                    <h3 class="text-lg font-bold text-gray-800">Giải thích Ngữ pháp</h3>
                </div>
                <button onclick="closeModal('detailGrammarModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6">
                <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-3 text-center mb-4 shadow-sm">
                    <code class="text-lg font-bold text-indigo-700 font-mono" id="dgFormula"></code>
                </div>
                <div id="dgExplanation" class="text-gray-600 text-sm mb-4 space-y-3 leading-relaxed"></div>
            </div>
        </div>
    </div>

    <!-- MODAL: KANJI STROKE -->
    <div id="strokeModal" class="fixed inset-0 z-[80] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-gray-900/80 backdrop-blur-sm transition-opacity opacity-0" id="strokeBackdrop" onclick="closeModal('strokeModal')"></div>
        <div class="bg-white rounded-2xl w-full max-w-5xl relative z-10 shadow-2xl transform transition-all scale-95 opacity-0 flex flex-col max-h-[90vh]" id="strokePanel">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-pink-50 rounded-t-2xl">
                <h3 class="text-lg font-bold text-pink-700 flex items-center gap-2"><i class="fas fa-pen-nib"></i> Tập Viết & Chi Tiết Kanji</h3>
                <button onclick="closeModal('strokeModal')" class="w-8 h-8 rounded-full hover:bg-white flex items-center justify-center text-gray-500 transition-colors"><i class="fas fa-times text-lg"></i></button>
            </div>
            <div class="p-6 overflow-y-auto scroller bg-slate-50 flex-1">
                <div id="strokeTabs" class="flex justify-center gap-2 mb-6 flex-wrap"></div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="flex flex-col gap-6 text-center">
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 relative">
                            <p class="text-xs text-gray-400 mb-2 font-bold uppercase tracking-wider">Mô phỏng nét viết</p>
                            <div id="strokeAnimContainer" class="w-48 h-48 mx-auto bg-white border border-gray-300 relative stroke-grid-box flex items-center justify-center rounded-lg cursor-pointer" onclick="replayStrokeAnimation()"></div>
                            <button onclick="replayStrokeAnimation()" class="absolute top-4 right-4 bg-pink-50 text-pink-600 w-8 h-8 rounded-full flex items-center justify-center hover:bg-pink-100 transition shadow-sm z-10"><i class="fas fa-redo text-sm"></i></button>
                            <p class="text-[10px] text-gray-400 mt-2">Nhấn vào ô để chạy lại</p>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 text-left">
                            <p class="text-xs text-gray-400 mb-3 font-bold uppercase tracking-wider text-center">Thứ tự từng nét</p>
                            <div id="strokeGridContainer" class="flex flex-wrap gap-2 justify-center"></div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200 flex flex-col h-full text-left">
                        <div id="kanjiDetailContent">
                            <div class="flex items-center justify-between mb-6 border-b border-gray-100 pb-4">
                                <div><h2 id="detailKanji" class="text-6xl font-bold text-gray-800 ja-text mb-1 leading-none"></h2><div class="text-xs font-bold bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded inline-block mt-2" id="detailHanViet"></div></div>
                                <div class="text-right"><div class="text-2xl font-bold text-gray-600 capitalize" id="detailMeaning"></div></div>
                            </div>
                            <!-- Radicals -->
                            <div class="mb-4 bg-indigo-50 p-3 rounded-lg border border-indigo-100">
                                <span class="text-xs font-bold text-indigo-500 uppercase block mb-1"><i class="fas fa-layer-group mr-1"></i> Bộ thủ (Thành phần)</span>
                                <span class="text-sm font-medium text-indigo-900" id="detailRadicals">...</span>
                            </div>
                            <!-- On/Kun -->
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <div class="bg-slate-50 p-3 rounded-lg border border-slate-100 flex justify-between items-center group cursor-pointer" onclick="document.getElementById('btnPlayOn').click()"><div class="flex flex-col"><span class="text-xs font-bold text-gray-400 uppercase">On</span><span class="text-lg font-bold text-indigo-600 ja-text" id="detailOn"></span></div><button id="btnPlayOn" class="text-indigo-300 group-hover:text-indigo-600"><i class="fas fa-volume-up"></i></button></div>
                                <div class="bg-slate-50 p-3 rounded-lg border border-slate-100 flex justify-between items-center group cursor-pointer" onclick="document.getElementById('btnPlayKun').click()"><div class="flex flex-col"><span class="text-xs font-bold text-gray-400 uppercase">Kun</span><span class="text-lg font-bold text-pink-600 ja-text" id="detailKun"></span></div><button id="btnPlayKun" class="text-pink-300 group-hover:text-pink-600"><i class="fas fa-volume-up"></i></button></div>
                            </div>
                            <!-- Tips -->
                            <div class="space-y-4 mb-6">
                                <div class="bg-green-50 p-4 rounded-lg border border-green-100">
                                    <h4 class="text-sm font-bold text-green-800 mb-2 flex items-center gap-2"><i class="fas fa-image"></i> Ghi nhớ hình ảnh</h4>
                                    <p class="text-sm text-green-700 leading-relaxed" id="detailTipImg"></p>
                                </div>
                                <div class="bg-orange-50 p-4 rounded-lg border border-orange-100">
                                    <h4 class="text-sm font-bold text-orange-800 mb-2 flex items-center gap-2"><i class="fas fa-music"></i> Mẹo nhớ âm thanh</h4>
                                    <p class="text-sm text-orange-700" id="detailTipSound"></p>
                                </div>
                            </div>
                            <!-- Related Words -->
                            <div>
                                <h4 class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-3">Từ vựng liên quan</h4>
                                <div class="space-y-2" id="detailWords"></div>
                            </div>
                        </div>
                        <div id="kanjiDetailEmpty" class="hidden h-full flex flex-col items-center justify-center text-center p-4 text-gray-400"><i class="fas fa-book-open text-4xl mb-3 opacity-30"></i><p class="text-sm">Chưa có dữ liệu chi tiết cho chữ Hán này.</p></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. GRAMMAR REPO (Day 29) ---
        const grammarRepo = {
            "sae_ba": { title: "Chỉ cần... thì...", formula: "N + さえ + ...ば", desc: "Điều kiện tối thiểu để sự việc xảy ra.", ex: "薬さえ飲めば治る。" },
            "ta_tokoro_de": { title: "Dù có... thì cũng (vô ích)", formula: "Vた + ところで", desc: "Giả định dù có làm A thì kết quả B (tiêu cực/không như ý) vẫn xảy ra.", ex: "謝ったところで許さない。" },
            "to_iu_koto_da": { title: "Nghe nói là (Trang trọng)", formula: "Thể thường + ということだ/とのことだ", desc: "Truyền đạt lại thông tin từ nguồn khác (bản tin, thông báo).", ex: "来週は暑くなるということだ。" },
            "toka_hearsay": { title: "Nghe đồn là...", formula: "Thể thường + とか", desc: "Tin đồn không chắc chắn, nghe phong thanh.", ex: "彼が辞めるとか聞いた。" },
            "tte_hearsay": { title: "Nghe nói (Hội thoại)", formula: "Thể thường + って", desc: "Dùng trong văn nói thân mật để trích dẫn.", ex: "明日雨だって。" },
            "to_iu_hearsay": { title: "Nghe nói (Văn viết)", formula: "Thể thường + という", desc: "Dùng trong văn viết, kể chuyện, mang tính trang trọng.", ex: "昔、ここに城があったという。" },
            "hazu_wake_ga_nai": { title: "Chắc chắn không / Lẽ nào lại", formula: "Thể thường + はずがない/わけがない", desc: "Phủ định mạnh mẽ dựa trên căn cứ.", ex: "彼が嘘をつくわけがない。" },
            "ni_kagiru": { title: "Tốt nhất là", formula: "Vる/Vない/N + に限る", desc: "Lời khuyên chủ quan.", ex: "夏はビールに限る。" },
            "no_de": { title: "Vì... nên...", formula: "Thể thường + ので", desc: "Nguyên nhân, lý do khách quan.", ex: "用事があるので帰ります。" },
            "tame_ni": { title: "Vì... / Để...", formula: "Thể thường + ため(に)", desc: "Nguyên nhân hoặc mục đích.", ex: "健康のために走る。" },
            "to_iu_yori": { title: "Nói là... thì đúng hơn", formula: "A というより B", desc: "Dùng để đính chính, B diễn tả bản chất chính xác hơn A.", ex: "彼は医者というより、科学者だ。" },
            "ni_taishite": { title: "Đối với / Ngược lại", formula: "N + に対して", desc: "Chỉ đối tượng hướng tới hoặc sự đối lập.", ex: "先生に対して敬語を使う。" },
            "okage_sei": { title: "Nhờ... / Tại...", formula: "Thể thường + おかげで / せいで", desc: "Okage de: Nhờ (kết quả tốt). Sei de: Tại (kết quả xấu).", ex: "先生のおかげで合格しました。" },
            "mashou_ka": { title: "Tôi... nhé? / Chúng ta...", formula: "Vましょう + か", desc: "Đề nghị làm giúp người khác hoặc rủ rê cùng làm.", ex: "荷物を持ちましょうか。" }
        };

        // --- 2. VOCABULARY DATA (Day 29 - 87 words) ---
        const vocabData = [
            { "STT": 1, "Kanji": "混雑する", "Nghĩa": "Đông đúc", "Furigana": "こんざつする", "type": "verb", "conv": { "polite": "駅はいつも混雑しているとのことだ。", "pVi": "Nghe nói ga luôn đông đúc.", "casual": "駅混んでるらしいよ。", "cVi": "Nghe bảo ga đông lắm.", "gIds": ["to_iu_koto_da"] } },
            { "STT": 2, "Kanji": "渋滞する", "Nghĩa": "Tắc đường", "Furigana": "じゅうたいする", "type": "verb", "conv": { "polite": "渋滞したところで、会議には間に合わない。", "pVi": "Cho dù tắc đường thì cũng không kịp cuộc họp (ý là dù lý do là tắc đường).", "casual": "渋滞したって間に合わないよ。", "cVi": "Dù tắc đường cũng muộn rồi.", "gIds": ["ta_tokoro_de"] } },
            { "STT": 3, "Kanji": "衝突する", "Nghĩa": "Va chạm/Xung đột", "Furigana": "しょうとつする", "type": "verb", "conv": { "polite": "車が衝突したって。", "pVi": "Nghe nói xe đã va chạm.", "casual": "衝突事故あったって。", "cVi": "Nghe bảo có va chạm xe.", "gIds": ["tte_hearsay"] } },
            { "STT": 4, "Kanji": "場面", "Nghĩa": "Tình huống/Bối cảnh", "Furigana": "ばめん", "type": "noun", "conv": { "polite": "どんな場面でも、落ち着いて行動するに限る。", "pVi": "Trong bất kỳ tình huống nào, tốt nhất là nên hành động bình tĩnh.", "casual": "どんな時も落ち着くのが一番。", "cVi": "Lúc nào cũng phải bình tĩnh là nhất.", "gIds": ["ni_kagiru"] } },
            { "STT": 5, "Kanji": "現れる", "Nghĩa": "Xuất hiện", "Furigana": "あらわれる", "type": "verb", "conv": { "polite": "幽霊が現れたって。", "pVi": "Nghe nói ma đã xuất hiện.", "casual": "お化け出たってよ。", "cVi": "Nghe bảo có ma đấy.", "gIds": ["tte_hearsay"] } },
            { "STT": 6, "Kanji": "現す", "Nghĩa": "Thể hiện/Làm hiện ra", "Furigana": "あらわす", "type": "verb", "conv": { "polite": "彼は感情を顔に現すことはない。", "pVi": "Anh ấy không bao giờ thể hiện cảm xúc ra mặt.", "casual": "彼、顔に出さないよね。", "cVi": "Hắn chả bao giờ lộ ra mặt.", "gIds": [] } },
            { "STT": 7, "Kanji": "表れる", "Nghĩa": "Biểu hiện (tự nhiên)", "Furigana": "あらわれる", "type": "verb", "conv": { "polite": "彼の努力が成績に表れている。", "pVi": "Nỗ lực của anh ấy đang thể hiện rõ trên thành tích.", "casual": "努力が成績に出てるね。", "cVi": "Cố gắng nên điểm cao hẳn.", "gIds": [] } },
            { "STT": 8, "Kanji": "表す", "Nghĩa": "Biểu thị/Biểu lộ", "Furigana": "あらわす", "type": "verb", "conv": { "polite": "感謝の気持ちを表すために、手紙を書いた。", "pVi": "Tôi đã viết thư để bày tỏ lòng biết ơn.", "casual": "感謝伝えたくて手紙書いた。", "cVi": "Muốn cảm ơn nên viết thư.", "gIds": ["tame_ni"] } },
            { "STT": 9, "Kanji": "被害", "Nghĩa": "Thiệt hại", "Furigana": "ひがい", "type": "noun", "conv": { "polite": "台風の被害は大きかったとのことだ。", "pVi": "Nghe nói thiệt hại do bão rất lớn.", "casual": "被害でかかったらしいよ。", "cVi": "Thiệt hại to lắm đấy.", "gIds": ["to_iu_koto_da"] } },
            { "STT": 10, "Kanji": "録画", "Nghĩa": "Ghi hình", "Furigana": "ろくが", "type": "noun", "conv": { "polite": "テレビ番組を録画したところで、見る時間がない。", "pVi": "Cho dù đã ghi hình chương trình TV thì cũng không có thời gian để xem.", "casual": "録画しても見る時間ないわ。", "cVi": "Ghi lại cũng có xem được đâu.", "gIds": ["ta_tokoro_de"] } },
            { "STT": 11, "Kanji": "事故", "Nghĩa": "Tai nạn", "Furigana": "じこ", "type": "noun", "conv": { "polite": "事故があったということだ。", "pVi": "Nghe nói đã có tai nạn.", "casual": "事故あったんだって。", "cVi": "Nghe bảo có tai nạn.", "gIds": ["to_iu_koto_da"] } },
            { "STT": 12, "Kanji": "事件", "Nghĩa": "Vụ án/Sự kiện", "Furigana": "じけん", "type": "noun", "conv": { "polite": "事件があったとか。", "pVi": "Nghe nói đã có vụ án (tin đồn).", "casual": "事件あったとか聞いたよ。", "cVi": "Nghe phong thanh có vụ án.", "gIds": ["toka_hearsay"] } },
            { "STT": 13, "Kanji": "故障する", "Nghĩa": "Hỏng hóc", "Furigana": "こしょうする", "type": "verb", "conv": { "polite": "パソコンが故障したって。", "pVi": "Nghe nói máy tính bị hỏng.", "casual": "PC壊れたって。", "cVi": "Máy tính hỏng rồi kìa.", "gIds": ["tte_hearsay"] } },
            { "STT": 14, "Kanji": "修理する", "Nghĩa": "Sửa chữa", "Furigana": "しゅうりする", "type": "verb", "conv": { "polite": "パソコンを修理したところで、すぐにまた壊れるだろう。", "pVi": "Cho dù đã sửa máy tính thì cũng sẽ hỏng lại ngay thôi.", "casual": "直してもすぐ壊れるよ。", "cVi": "Sửa xong lại hỏng thôi.", "gIds": ["ta_tokoro_de"] } },
            { "STT": 15, "Kanji": "停電", "Nghĩa": "Mất điện", "Furigana": "ていでん", "type": "noun", "conv": { "polite": "停電したとのことだ。", "pVi": "Nghe nói đã mất điện.", "casual": "停電したらしい。", "cVi": "Nghe bảo mất điện.", "gIds": ["to_iu_koto_da"] } },
            { "STT": 16, "Kanji": "雷", "Nghĩa": "Sấm sét", "Furigana": "かみなり", "type": "noun", "conv": { "polite": "雷が鳴っているとか。", "pVi": "Nghe nói sấm đang kêu (tin đồn/không chắc).", "casual": "雷鳴ってるとか聞いた。", "cVi": "Hình như có sấm đấy.", "gIds": ["toka_hearsay"] } },
            { "STT": 17, "Kanji": "調子", "Nghĩa": "Tình trạng", "Furigana": "ちょうし", "type": "noun", "conv": { "polite": "体の調子が悪いって。", "pVi": "Nghe nói sức khỏe không tốt.", "casual": "調子悪いんだって。", "cVi": "Nghe bảo đang ốm.", "gIds": ["tte_hearsay"] } },
            { "STT": 18, "Kanji": "自信", "Nghĩa": "Tự tin", "Furigana": "じしん", "type": "noun", "conv": { "polite": "彼は自信があるというより、傲慢だ。", "pVi": "Anh ấy nói là tự tin thì đúng hơn là kiêu ngạo.", "casual": "自信っていうか傲慢だよね。", "cVi": "Tự tin gì, kiêu ngạo thì có.", "gIds": ["to_iu_yori"] } },
            { "STT": 19, "Kanji": "自慢", "Nghĩa": "Tự mãn/Khoe khoang", "Furigana": "じまん", "type": "noun", "conv": { "polite": "彼は自分の才能を自慢するばかりだ。", "pVi": "Anh ấy chỉ toàn khoe khoang tài năng của mình.", "casual": "自慢ばっかしてる。", "cVi": "Toàn khoe mẽ thôi.", "gIds": [] } },
            { "STT": 20, "Kanji": "関心", "Nghĩa": "Quan tâm", "Furigana": "かんしん", "type": "noun", "conv": { "polite": "彼は政治に関心があるとのことだ。", "pVi": "Nghe nói anh ấy quan tâm đến chính trị.", "casual": "政治に関心あるらしいよ。", "cVi": "Nghe bảo hắn quan tâm chính trị.", "gIds": ["to_iu_koto_da"] } },
            { "STT": 21, "Kanji": "感動する", "Nghĩa": "Cảm động", "Furigana": "かんどうする", "type": "verb", "conv": { "polite": "彼の話に感動したとか。", "pVi": "Nghe nói đã cảm động trước câu chuyện của anh ấy.", "casual": "感動したとか言ってた。", "cVi": "Thấy bảo cảm động lắm.", "gIds": ["toka_hearsay"] } },
            { "STT": 22, "Kanji": "興奮する", "Nghĩa": "Hưng phấn", "Furigana": "こうふんする", "type": "verb", "conv": { "polite": "試合を見て興奮したって。", "pVi": "Nghe nói đã hưng phấn khi xem trận đấu.", "casual": "試合見て興奮したってさ。", "cVi": "Nghe bảo xem trận đấu phấn khích lắm.", "gIds": ["tte_hearsay"] } },
            { "STT": 23, "Kanji": "感想", "Nghĩa": "Cảm tưởng", "Furigana": "かんそう", "type": "noun", "conv": { "polite": "彼の感想は、私の感想とは違う。", "pVi": "Cảm tưởng của anh ấy khác với cảm tưởng của tôi.", "casual": "感想違うね。", "cVi": "Cảm nhận khác nhau nhỉ.", "gIds": [] } },
            { "STT": 24, "Kanji": "予想する", "Nghĩa": "Dự đoán", "Furigana": "よそうする", "type": "verb", "conv": { "polite": "彼の予想は当たるはずがない。", "pVi": "Dự đoán của anh ấy chắc chắn không đúng.", "casual": "予想当たるわけないよ。", "cVi": "Đoán trúng thế nào được.", "gIds": ["hazu_wake_ga_nai"] } },
            { "STT": 25, "Kanji": "専門", "Nghĩa": "Chuyên môn", "Furigana": "せんもん", "type": "noun", "conv": { "polite": "彼は専門家だとか。", "pVi": "Nghe nói anh ấy là chuyên gia.", "casual": "専門家らしいよ。", "cVi": "Nghe đâu là chuyên gia đấy.", "gIds": ["toka_hearsay"] } },
            { "STT": 26, "Kanji": "研究する", "Nghĩa": "Nghiên cứu", "Furigana": "けんきゅうする", "type": "verb", "conv": { "polite": "彼は新しい技術を研究しているとのことだ。", "pVi": "Nghe nói anh ấy đang nghiên cứu công nghệ mới.", "casual": "新技術研究してるらしい。", "cVi": "Nghe bảo đang nghiên cứu cái mới.", "gIds": ["to_iu_koto_da"] } },
            { "STT": 27, "Kanji": "調査する", "Nghĩa": "Điều tra", "Furigana": "ちょうさする", "type": "verb", "conv": { "polite": "警察が事件を調査しているって。", "pVi": "Nghe nói cảnh sát đang điều tra vụ án.", "casual": "警察調査してるってさ。", "cVi": "Cảnh sát đang điều tra đấy.", "gIds": ["tte_hearsay"] } },
            { "STT": 28, "Kanji": "原因", "Nghĩa": "Nguyên nhân", "Furigana": "げんいん", "type": "noun", "conv": { "polite": "事故の原因は不明だとか。", "pVi": "Nghe nói nguyên nhân vụ tai nạn không rõ.", "casual": "原因わかんないとか聞いた。", "cVi": "Thấy bảo chưa rõ nguyên nhân.", "gIds": ["toka_hearsay"] } },
            { "STT": 29, "Kanji": "結果", "Nghĩa": "Kết quả", "Furigana": "けっか", "type": "noun", "conv": { "polite": "試験の結果はまだだそう。", "pVi": "Nghe nói kết quả thi vẫn chưa có.", "casual": "結果まだらしいよ。", "cVi": "Vẫn chưa có kết quả đâu.", "gIds": [] } },
            { "STT": 30, "Kanji": "解決", "Nghĩa": "Giải quyết", "Furigana": "かいけつ", "type": "noun", "conv": { "polite": "問題は解決したとのことだ。", "pVi": "Nghe nói vấn đề đã được giải quyết.", "casual": "解決したらしい。", "cVi": "Nghe bảo xong rồi.", "gIds": ["to_iu_koto_da"] } },
            { "STT": 31, "Kanji": "確かめる", "Nghĩa": "Xác nhận", "Furigana": "たしかめる", "type": "verb", "conv": { "polite": "情報を確かめたところで、真実がわかるわけがない。", "pVi": "Cho dù đã xác nhận thông tin thì cũng không thể biết được sự thật.", "casual": "確かめてもわかんないよ。", "cVi": "Check rồi cũng có biết đâu.", "gIds": ["ta_tokoro_de", "hazu_wake_ga_nai"] } },
            { "STT": 32, "Kanji": "間違う", "Nghĩa": "Sai/Nhầm", "Furigana": "まちがう", "type": "verb", "conv": { "polite": "彼の答えは間違っているって。", "pVi": "Nghe nói câu trả lời của anh ấy bị sai.", "casual": "間違ってるってさ。", "cVi": "Thấy bảo sai rồi.", "gIds": ["tte_hearsay"] } },
            { "STT": 33, "Kanji": "利用する", "Nghĩa": "Sử dụng", "Furigana": "りようする", "type": "verb", "conv": { "polite": "この施設は誰でも利用できるとのことだ。", "pVi": "Nghe nói cơ sở này ai cũng có thể sử dụng.", "casual": "誰でも使えるらしいよ。", "cVi": "Nghe nói ai cũng dùng được.", "gIds": ["to_iu_koto_da"] } },
            { "STT": 34, "Kanji": "減少する", "Nghĩa": "Giảm thiểu", "Furigana": "げんしょうする", "type": "verb", "conv": { "polite": "人口が減少しているということだ。", "pVi": "Nghe nói dân số đang giảm.", "casual": "人口減ってるらしい。", "cVi": "Dân số đang giảm đấy.", "gIds": ["to_iu_koto_da"] } },
            { "STT": 35, "Kanji": "理解する", "Nghĩa": "Hiểu/Lý giải", "Furigana": "りかいする", "type": "verb", "conv": { "polite": "彼の気持ちを理解したところで、どうすることもできない。", "pVi": "Cho dù đã hiểu cảm xúc của anh ấy thì cũng không thể làm gì được.", "casual": "理解してもどうにもなんないよ。", "cVi": "Hiểu rồi cũng chẳng làm gì được.", "gIds": ["ta_tokoro_de"] } },
            { "STT": 36, "Kanji": "発見する", "Nghĩa": "Phát hiện", "Furigana": "はっけんする", "type": "verb", "conv": { "polite": "新しい星が発見されたって。", "pVi": "Nghe nói một ngôi sao mới đã được phát hiện.", "casual": "新星見つかったって。", "cVi": "Nghe bảo tìm thấy sao mới.", "gIds": ["tte_hearsay"] } },
            { "STT": 37, "Kanji": "発明する", "Nghĩa": "Phát minh", "Furigana": "はつめいする", "type": "verb", "conv": { "polite": "エジソンは電球を発明したという。", "pVi": "Nghe nói Edison đã phát minh ra bóng đèn.", "casual": "エジソンが発明したんだって。", "cVi": "Thấy bảo Edison phát minh đấy.", "gIds": ["to_iu_hearsay"] } },
            { "STT": 38, "Kanji": "関係する", "Nghĩa": "Liên quan", "Furigana": "かんけいする", "type": "verb", "conv": { "polite": "この事件に関係しているはずがない。", "pVi": "Chắc chắn không liên quan đến vụ án này.", "casual": "関係してるわけないよ。", "cVi": "Làm gì có chuyện liên quan.", "gIds": ["hazu_wake_ga_nai"] } },
            { "STT": 39, "Kanji": "団体", "Nghĩa": "Đoàn thể", "Furigana": "だんたい", "type": "noun", "conv": { "polite": "彼はその団体に入っているとか。", "pVi": "Nghe nói anh ấy đang tham gia đoàn thể đó.", "casual": "その団体に入ってるらしいよ。", "cVi": "Nghe đồn hắn vào hội đó rồi.", "gIds": ["toka_hearsay"] } },
            { "STT": 40, "Kanji": "博物館", "Nghĩa": "Bảo tàng", "Furigana": "はくぶつかん", "type": "noun", "conv": { "polite": "博物館は明日から開館するとのことだ。", "pVi": "Nghe nói bảo tàng sẽ mở cửa từ ngày mai.", "casual": "明日から開くらしい。", "cVi": "Mai mở cửa đấy.", "gIds": ["to_iu_koto_da"] } },
            { "STT": 41, "Kanji": "選挙", "Nghĩa": "Bầu cử", "Furigana": "せんきょ", "type": "noun", "conv": { "polite": "選挙は来月行われるということだ。", "pVi": "Nghe nói cuộc bầu cử sẽ diễn ra vào tháng tới.", "casual": "来月選挙らしいよ。", "cVi": "Tháng sau bầu cử đấy.", "gIds": ["to_iu_koto_da"] } },
            { "STT": 42, "Kanji": "行う", "Nghĩa": "Tổ chức/Tiến hành", "Furigana": "おこなう", "type": "verb", "conv": { "polite": "会議は予定通り行われるとのことだ。", "pVi": "Nghe nói cuộc họp sẽ diễn ra đúng như dự kiến.", "casual": "予定通りやるらしい。", "cVi": "Vẫn họp như lịch đấy.", "gIds": ["to_iu_koto_da"] } },
            { "STT": 43, "Kanji": "税金", "Nghĩa": "Tiền thuế", "Furigana": "ぜいきん", "type": "noun", "conv": { "polite": "税金を払うのは国民の義務だという。", "pVi": "Nghe nói việc đóng thuế là nghĩa vụ của công dân.", "casual": "税金払うの義務だってさ。", "cVi": "Nghe bảo đóng thuế là nghĩa vụ.", "gIds": ["to_iu_hearsay"] } },
            { "STT": 44, "Kanji": "責任", "Nghĩa": "Trách nhiệm", "Furigana": "せきにん", "type": "noun", "conv": { "polite": "彼は自分の行動に責任を持つはずだ。", "pVi": "Anh ấy chắc chắn phải chịu trách nhiệm về hành động của mình.", "casual": "責任持つはずだよ。", "cVi": "Hắn phải chịu trách nhiệm chứ.", "gIds": [] } },
            { "STT": 45, "Kanji": "書類", "Nghĩa": "Hồ sơ/Giấy tờ", "Furigana": "しょるい", "type": "noun", "conv": { "polite": "書類を提出したところで、すぐに返事は来ないだろう。", "pVi": "Cho dù đã nộp hồ sơ thì cũng không có phản hồi ngay đâu.", "casual": "出してもすぐ返事来ないよ。", "cVi": "Nộp rồi cũng còn lâu mới trả lời.", "gIds": ["ta_tokoro_de"] } },
            { "STT": 46, "Kanji": "題名", "Nghĩa": "Tên/Nhan đề", "Furigana": "だいめい", "type": "noun", "conv": { "polite": "この本の題名は「夢」ということだ。", "pVi": "Tên của cuốn sách này là 「Giấc mơ」.", "casual": "題名は「夢」らしいよ。", "cVi": "Tên sách là 'Giấc mơ' đấy.", "gIds": ["to_iu_koto_da"] } },
            { "STT": 47, "Kanji": "条件", "Nghĩa": "Điều kiện", "Furigana": "じょうけん", "type": "noun", "conv": { "polite": "彼の提案にはいくつかの条件があるとのことだ。", "pVi": "Nghe nói đề xuất của anh ấy có một vài điều kiện.", "casual": "条件あるらしい。", "cVi": "Nghe bảo có điều kiện đấy.", "gIds": ["to_iu_koto_da"] } },
            { "STT": 48, "Kanji": "採用", "Nghĩa": "Tuyển dụng", "Furigana": "さいよう", "type": "noun", "conv": { "polite": "新しい社員が採用されたとか。", "pVi": "Nghe nói đã có nhân viên mới được tuyển dụng.", "casual": "新入社員入ったとか。", "cVi": "Thấy bảo có nhân viên mới.", "gIds": ["toka_hearsay"] } },
            { "STT": 49, "Kanji": "締め切り", "Nghĩa": "Hạn chót", "Furigana": "しめきり", "type": "noun", "conv": { "polite": "締め切りは明日だとか。", "pVi": "Nghe nói hạn chót là ngày mai.", "casual": "締め切り明日だって。", "cVi": "Mai là hạn chót đấy.", "gIds": ["toka_hearsay"] } },
            { "STT": 50, "Kanji": "期間", "Nghĩa": "Thời hạn/Kỳ hạn", "Furigana": "きかん", "type": "noun", "conv": { "polite": "このキャンペーンは期間限定だという。", "pVi": "Nghe nói chiến dịch này có thời hạn.", "casual": "期間限定らしいよ。", "cVi": "Có hạn thôi đấy.", "gIds": ["to_iu_hearsay"] } },
            { "STT": 51, "Kanji": "倍", "Nghĩa": "Gấp đôi", "Furigana": "ばい", "type": "noun", "conv": { "polite": "給料が倍になったとか。", "pVi": "Nghe nói lương đã tăng gấp đôi.", "casual": "給料倍になったらしい。", "cVi": "Lương gấp đôi rồi kìa.", "gIds": ["toka_hearsay"] } },
            { "STT": 52, "Kanji": "近道", "Nghĩa": "Đường tắt", "Furigana": "ちかみち", "type": "noun", "conv": { "polite": "近道を通ったところで、あまり時間は変わらないだろう。", "pVi": "Cho dù đi đường tắt thì thời gian cũng không thay đổi nhiều đâu.", "casual": "近道しても変わんないよ。", "cVi": "Đi tắt cũng thế thôi.", "gIds": ["ta_tokoro_de"] } },
            { "STT": 53, "Kanji": "中心", "Nghĩa": "Trung tâm", "Furigana": "ちゅうしん", "type": "noun", "conv": { "polite": "この町は、駅が中心だ。", "pVi": "Thị trấn này, nhà ga là trung tâm.", "casual": "駅が中心だね。", "cVi": "Ga là trung tâm đấy.", "gIds": [] } },
            { "STT": 54, "Kanji": "辺り", "Nghĩa": "Vùng lân cận", "Furigana": "あたり", "type": "noun", "conv": { "polite": "この辺りは静かだという。", "pVi": "Nghe nói khu vực này yên tĩnh.", "casual": "ここ静からしいよ。", "cVi": "Chỗ này yên tĩnh lắm.", "gIds": ["to_iu_hearsay"] } },
            { "STT": 55, "Kanji": "周り", "Nghĩa": "Xung quanh", "Furigana": "まわり", "type": "noun", "conv": { "polite": "彼の周りにはいつも人が集まっている。", "pVi": "Xung quanh anh ấy luôn có người tụ tập.", "casual": "彼の周りいつも人いるね。", "cVi": "Quanh hắn lúc nào cũng đông.", "gIds": [] } },
            { "STT": 56, "Kanji": "穴", "Nghĩa": "Lỗ/Hố", "Furigana": "あな", "type": "noun", "conv": { "polite": "穴を掘ったところで、何も見つからないだろう。", "pVi": "Cho dù đã đào hố thì cũng không tìm thấy gì đâu.", "casual": "掘っても何もないよ。", "cVi": "Đào cũng chả thấy gì đâu.", "gIds": ["ta_tokoro_de"] } },
            { "STT": 57, "Kanji": "地面", "Nghĩa": "Mặt đất", "Furigana": "じめん", "type": "noun", "conv": { "polite": "地面に座るというより、寝転んでいるようだ。", "pVi": "Nói là ngồi trên mặt đất thì đúng hơn là đang nằm.", "casual": "座るっていうか寝てるね。", "cVi": "Nằm ra đất chứ ngồi gì.", "gIds": ["to_iu_yori"] } },
            { "STT": 58, "Kanji": "掘る", "Nghĩa": "Đào", "Furigana": "ほる", "type": "verb", "conv": { "polite": "宝を掘り当てたとか。", "pVi": "Nghe nói đã đào được kho báu.", "casual": "宝掘ったらしいよ。", "cVi": "Nghe đâu đào được vàng.", "gIds": ["toka_hearsay"] } },
            { "STT": 59, "Kanji": "列", "Nghĩa": "Hàng", "Furigana": "れつ", "type": "noun", "conv": { "polite": "長い列に並んだところで、すぐに順番は来ないだろう。", "pVi": "Cho dù đã xếp hàng dài thì cũng không đến lượt ngay đâu.", "casual": "並んでもすぐには無理だよ。", "cVi": "Xếp hàng cũng còn lâu mới tới.", "gIds": ["ta_tokoro_de"] } },
            { "STT": 60, "Kanji": "幅", "Nghĩa": "Chiều rộng", "Furigana": "はば", "type": "noun", "conv": { "polite": "この道の幅は広いという。", "pVi": "Nghe nói chiều rộng của con đường này lớn.", "casual": "ここ広いらしい。", "cVi": "Đường này rộng lắm.", "gIds": ["to_iu_hearsay"] } },
            { "STT": 61, "Kanji": "範囲", "Nghĩa": "Phạm vi", "Furigana": "はんい", "type": "noun", "conv": { "polite": "試験の範囲は広いとのことだ。", "pVi": "Nghe nói phạm vi thi rộng.", "casual": "範囲広いらしいよ。", "cVi": "Phạm vi thi rộng lắm.", "gIds": ["to_iu_koto_da"] } },
            { "STT": 62, "Kanji": "内容", "Nghĩa": "Nội dung", "Furigana": "ないよう", "type": "noun", "conv": { "polite": "会議の内容は、まだ秘密だとか。", "pVi": "Nghe nói nội dung cuộc họp vẫn còn là bí mật.", "casual": "内容秘密だって。", "cVi": "Nội dung bí mật đấy.", "gIds": ["toka_hearsay"] } },
            { "STT": 63, "Kanji": "中身", "Nghĩa": "Bên trong", "Furigana": "なかみ", "type": "noun", "conv": { "polite": "箱の中身は、まだわからないって。", "pVi": "Nghe nói nội dung bên trong hộp vẫn chưa biết.", "casual": "中身わかんないらしい。", "cVi": "Chưa biết bên trong có gì đâu.", "gIds": ["tte_hearsay"] } },
            { "STT": 64, "Kanji": "特徴", "Nghĩa": "Đặc trưng", "Furigana": "とくちょう", "type": "noun", "conv": { "polite": "この製品の特徴は、デザインだという。", "pVi": "Đặc trưng của sản phẩm này là thiết kế.", "casual": "特徴はデザインらしいよ。", "cVi": "Đặc trưng là thiết kế đấy.", "gIds": ["to_iu_hearsay"] } },
            { "STT": 65, "Kanji": "普通", "Nghĩa": "Bình thường", "Furigana": "ふつう", "type": "adj", "conv": { "polite": "普通の生活を送るのが一番だ。", "pVi": "Sống một cuộc sống bình thường là tốt nhất.", "casual": "普通が一番だよ。", "cVi": "Bình thường là nhất.", "gIds": [] } },
            { "STT": 66, "Kanji": "当たり前", "Nghĩa": "Đương nhiên", "Furigana": "あたりまえ", "type": "adj", "conv": { "polite": "努力すれば成功するのは当たり前だという。", "pVi": "Nghe nói nỗ lực thì thành công là điều đương nhiên.", "casual": "努力すれば成功して当たり前。", "cVi": "Cố gắng thành công là cái chắc.", "gIds": ["to_iu_hearsay"] } },
            { "STT": 67, "Kanji": "偽", "Nghĩa": "Giả", "Furigana": "にせ", "type": "noun", "conv": { "polite": "このブランド品は偽物だとか。", "pVi": "Nghe nói hàng hiệu này là hàng giả.", "casual": "これ偽物らしいよ。", "cVi": "Cái này hàng fake đấy.", "gIds": ["toka_hearsay"] } },
            { "STT": 68, "Kanji": "別れる", "Nghĩa": "Chia tay", "Furigana": "わかれる", "type": "verb", "conv": { "polite": "彼女と別れるのは悲しいって。", "pVi": "Nghe nói chia tay cô ấy rất buồn.", "casual": "別れるの悲しいらしい。", "cVi": "Thấy bảo chia tay buồn lắm.", "gIds": ["tte_hearsay"] } },
            { "STT": 69, "Kanji": "隠れる", "Nghĩa": "Trốn", "Furigana": "かくれる", "type": "verb", "conv": { "polite": "猫が隠れているはずがない。", "pVi": "Mèo chắc chắn không ẩn nấp.", "casual": "隠れてるわけないよ。", "cVi": "Mèo trốn thế nào được.", "gIds": ["hazu_wake_ga_nai"] } },
            { "STT": 70, "Kanji": "隠す", "Nghĩa": "Giấu", "Furigana": "かくす", "type": "verb", "conv": { "polite": "秘密を隠したところで、いつかバレるだろう。", "pVi": "Cho dù đã che giấu bí mật thì một ngày nào đó cũng sẽ bị lộ.", "casual": "隠してもバレるよ。", "cVi": "Giấu cũng lộ thôi.", "gIds": ["ta_tokoro_de"] } },
            { "STT": 71, "Kanji": "埋まる", "Nghĩa": "Bị chôn", "Furigana": "うまる", "type": "verb", "conv": { "polite": "穴が埋まったとのことだ。", "pVi": "Nghe nói cái hố đã được lấp.", "casual": "穴埋まったらしい。", "cVi": "Hố lấp xong rồi.", "gIds": ["to_iu_koto_da"] } },
            { "STT": 72, "Kanji": "埋める", "Nghĩa": "Chôn", "Furigana": "うめる", "type": "verb", "conv": { "polite": "宝を埋めたとか。", "pVi": "Nghe nói đã chôn kho báu.", "casual": "宝埋めたらしいよ。", "cVi": "Chôn kho báu rồi đấy.", "gIds": ["toka_hearsay"] } },
            { "STT": 73, "Kanji": "詰まる", "Nghĩa": "Đầy/Tắc", "Furigana": "つまる", "type": "verb", "conv": { "polite": "箱に本が詰まっているって。", "pVi": "Nghe nói sách đầy trong hộp.", "casual": "本詰まってるらしい。", "cVi": "Sách đầy hộp rồi.", "gIds": ["tte_hearsay"] } },
            { "STT": 74, "Kanji": "詰める", "Nghĩa": "Nhét vào", "Furigana": "つめる", "type": "verb", "conv": { "polite": "荷物を詰めたところで、出発できないだろう。", "pVi": "Cho dù đã nhét hành lý thì cũng không thể xuất phát được đâu.", "casual": "詰めても行けないよ。", "cVi": "Đóng đồ xong cũng chưa đi được đâu.", "gIds": ["ta_tokoro_de"] } },
            { "STT": 75, "Kanji": "開く", "Nghĩa": "Mở", "Furigana": "ひらく", "type": "verb", "conv": { "polite": "ドアが開いたとのことだ。", "pVi": "Nghe nói cửa đã mở.", "casual": "ドア開いたらしい。", "cVi": "Cửa mở rồi kìa.", "gIds": ["to_iu_koto_da"] } },
            { "STT": 76, "Kanji": "閉じる", "Nghĩa": "Đóng", "Furigana": "とじる", "type": "verb", "conv": { "polite": "目を閉じたところで、何も変わらない。", "pVi": "Cho dù nhắm mắt thì cũng không có gì thay đổi.", "casual": "閉じても変わんないよ。", "cVi": "Nhắm mắt cũng thế thôi.", "gIds": ["ta_tokoro_de"] } },
            { "STT": 77, "Kanji": "飛ぶ", "Nghĩa": "Bay", "Furigana": "とぶ", "type": "verb", "conv": { "polite": "鳥が飛んでいるって。", "pVi": "Nghe nói chim đang bay.", "casual": "鳥飛んでるらしい。", "cVi": "Chim đang bay đấy.", "gIds": ["tte_hearsay"] } },
            { "STT": 78, "Kanji": "飛ばす", "Nghĩa": "Làm bay", "Furigana": "とばす", "type": "verb", "conv": { "polite": "紙飛行機を飛ばしたところで、遠くへは行かないだろう。", "pVi": "Cho dù đã phóng máy bay giấy thì cũng không bay xa đâu.", "casual": "飛ばしても遠く行かないよ。", "cVi": "Phóng cũng chả bay xa được đâu.", "gIds": ["ta_tokoro_de"] } },
            { "STT": 79, "Kanji": "見かける", "Nghĩa": "Tình cờ thấy", "Furigana": "みかける", "type": "verb", "conv": { "polite": "昔の友達を見かけたとか。", "pVi": "Nghe nói đã tình cờ gặp bạn cũ.", "casual": "友達見かけたらしい。", "cVi": "Thấy bảo gặp bạn cũ.", "gIds": ["toka_hearsay"] } },
            { "STT": 80, "Kanji": "確かめる", "Nghĩa": "Xác nhận", "Furigana": "たしかめる", "type": "verb", "conv": { "polite": "情報を確かめるのは、専門家だという。", "pVi": "Nghe nói việc xác nhận thông tin là của chuyên gia.", "casual": "専門家が確かめるらしい。", "cVi": "Chuyên gia check đấy.", "gIds": ["to_iu_hearsay"] } },
            { "STT": 81, "Kanji": "試す", "Nghĩa": "Thử", "Furigana": "ためす", "type": "verb", "conv": { "polite": "新しい料理を試したところで、美味しいわけがない。", "pVi": "Cho dù đã thử món ăn mới thì cũng không thể ngon được đâu.", "casual": "試しても美味しくないよ。", "cVi": "Thử cũng chả ngon đâu.", "gIds": ["ta_tokoro_de", "hazu_wake_ga_nai"] } },
            { "STT": 82, "Kanji": "洋服", "Nghĩa": "Quần áo Tây", "Furigana": "ようふく", "type": "noun", "conv": { "polite": "この洋服は洗いにくいって。", "pVi": "Nghe nói bộ quần áo này khó giặt.", "casual": "これ洗いにくいらしい。", "cVi": "Bộ này khó giặt lắm.", "gIds": ["tte_hearsay"] } },
            { "STT": 83, "Kanji": "繰り返す", "Nghĩa": "Lặp lại", "Furigana": "くりかえす", "type": "verb", "conv": { "polite": "同じ間違いを繰り返すのは、よくないという。", "pVi": "Nghe nói việc lặp lại cùng một lỗi là không tốt.", "casual": "繰り返すのよくないって。", "cVi": "Lặp lại lỗi sai là dở đấy.", "gIds": ["to_iu_hearsay"] } },
            { "STT": 84, "Kanji": "体操する", "Nghĩa": "Tập thể dục", "Furigana": "たいそうする", "type": "verb", "conv": { "polite": "毎日体操するのは、健康にいいという。", "pVi": "Nghe nói việc tập thể dục mỗi ngày tốt cho sức khỏe.", "casual": "体操体にいいらしいよ。", "cVi": "Tập thể dục tốt lắm.", "gIds": ["to_iu_hearsay"] } },
            { "STT": 85, "Kanji": "訳す", "Nghĩa": "Dịch", "Furigana": "やくす", "type": "verb", "conv": { "polite": "この文章を日本語に訳したところで、理解できるわけがない。", "pVi": "Cho dù đã dịch đoạn văn này sang tiếng Nhật thì cũng không thể hiểu được đâu.", "casual": "訳してもわかんないよ。", "cVi": "Dịch ra cũng chả hiểu đâu.", "gIds": ["ta_tokoro_de", "hazu_wake_ga_nai"] } },
            { "STT": 86, "Kanji": "進行する", "Nghĩa": "Tiến hành", "Furigana": "しんこうする", "type": "verb", "conv": { "polite": "会議は順調に進行しているとのことだ。", "pVi": "Nghe nói cuộc họp đang tiến triển thuận lợi.", "casual": "順調らしいよ。", "cVi": "Mọi việc đang êm xuôi.", "gIds": ["to_iu_koto_da"] } },
            { "STT": 87, "Kanji": "間違う", "Nghĩa": "Sai/Nhầm", "Furigana": "まちがう", "type": "verb", "conv": { "polite": "答えが間違っているって。", "pVi": "Nghe nói câu trả lời bị sai.", "casual": "間違ってるらしい。", "cVi": "Sai rồi đấy.", "gIds": ["tte_hearsay"] } }
        ];

        // --- 3. KANJI DETAILS (Updated for Day 29) ---
        const kanjiDetails = {
            "混": { hanviet: "HỖN", mean: "Hỗn loạn", on: "コン", kun: "ま.ぜる", radicals: "Thủy (氵)", tipImg: "Nước trộn lẫn.", tipSoundOn: "**Kon**zatsu hỗn tạp.", words: [{w:"混雑 (こんざつ)", m:"Đông đúc"}, {w:"混ぜる (まぜる)", m:"Trộn"}] },
            "雑": { hanviet: "TẠP", mean: "Tạp nham", on: "ザツ", kun: "", radicals: "Chuy (隹) + Mộc (木)", tipImg: "Chim đậu cây tạp.", tipSoundOn: "Kon**zatsu** hỗn tạp.", words: [{w:"雑誌 (ざっし)", m:"Tạp chí"}] },
            "渋": { hanviet: "SÁP", mean: "Chát/Tắc", on: "ジュウ", kun: "しぶ.い", radicals: "Thủy (氵) + Chỉ (止)", tipImg: "Nước ngừng chảy.", tipSoundOn: "**Juu**tai tắc đường.", tipSoundKun: "**Shibu**i chát.", words: [{w:"渋滞 (じゅうたい)", m:"Tắc đường"}] },
            "滞": { hanviet: "TRỆ", mean: "Đình trệ", on: "タイ", kun: "とどこお.る", radicals: "Thủy (氵) + Đái (帯)", tipImg: "Nước đọng lại.", tipSoundOn: "Juu**tai** tắc đường.", words: [{w:"停滞 (ていたい)", m:"Đình trệ"}] },
            "衝": { hanviet: "XUNG", mean: "Xung đột", on: "ショウ", kun: "", radicals: "Hành (行) + Trọng (重)", tipImg: "Đi va vào vật nặng.", tipSoundOn: "**Shou**totsu xung đột.", words: [{w:"衝突 (しょうとつ)", m:"Va chạm"}] },
            "突": { hanviet: "ĐỘT", mean: "Đột nhiên", on: "トツ", kun: "つ.く", radicals: "Huyệt (穴) + Khuyển (犬)", tipImg: "Chó lao ra khỏi hang.", tipSoundOn: "Shou**totsu** xung đột.", tipSoundKun: "**Tsu**ku đâm.", words: [{w:"突然 (とつぜん)", m:"Đột nhiên"}] },
            "場": { hanviet: "TRƯỜNG", mean: "Nơi chốn", on: "ジョウ", kun: "ば", radicals: "Thổ (土)", tipImg: "Đất rộng.", tipSoundOn: "**Ba**men bối cảnh.", words: [{w:"場所 (ばしょ)", m:"Địa điểm"}] },
            "現": { hanviet: "HIỆN", mean: "Xuất hiện", on: "ゲン", kun: "あらわ.れる", radicals: "Ngọc (王) + Kiến (見)", tipImg: "Vua nhìn hiện thực.", tipSoundOn: "**Gen**kin tiền mặt.", tipSoundKun: "**Arawa**reru xuất hiện.", words: [{w:"現れる (あらわれる)", m:"Xuất hiện"}] },
            "表": { hanviet: "BIỂU", mean: "Biểu hiện", on: "ヒョウ", kun: "あらわ.れる", radicals: "Y (衣)", tipImg: "Mặt ngoài áo.", tipSoundOn: "**Hyou**ji hiển thị.", tipSoundKun: "**Arawa**su biểu thị.", words: [{w:"表れる (あらわれる)", m:"Lộ ra"}] },
            "被": { hanviet: "BỊ", mean: "Bị/Đội", on: "ヒ", kun: "こうむ.る", radicals: "Y (衤) + Bì (皮)", tipImg: "Bị trùm da thú.", tipSoundOn: "**Hi**gai thiệt hại.", words: [{w:"被害 (ひがい)", m:"Thiệt hại"}] },
            "害": { hanviet: "HẠI", mean: "Tác hại", on: "ガイ", kun: "", radicals: "Miên (宀)", tipImg: "Lời nói hại trong nhà.", tipSoundOn: "Hi**gai** thiệt hại.", words: [{w:"公害 (こうがい)", m:"Ô nhiễm"}] },
            "録": { hanviet: "LỤC", mean: "Ghi chép", on: "ロク", kun: "", radicals: "Kim (金)", tipImg: "Khắc lên kim loại.", tipSoundOn: "**Roku**ga ghi hình.", words: [{w:"記録 (きろく)", m:"Kỷ lục"}] },
            "故": { hanviet: "CỐ", mean: "Sự cố", on: "コ", kun: "", radicals: "Phốc (攴)", tipImg: "Đánh vào cái cũ.", tipSoundOn: "Ji**ko** tai nạn.", words: [{w:"故障 (こしょう)", m:"Hỏng hóc"}] },
            "件": { hanviet: "KIỆN", mean: "Sự kiện", on: "ケン", kun: "", radicals: "Nhân (亻) + Ngưu (牛)", tipImg: "Người dắt bò là một sự kiện.", tipSoundOn: "Ji**ken** vụ án.", words: [{w:"用件 (ようけん)", m:"Việc bận"}] },
            "障": { hanviet: "CHƯỚNG", mean: "Chướng ngại", on: "ショウ", kun: "さわ.る", radicals: "Ấp (阝) + Chương (章)", tipImg: "Văn chương ở ấp bị cản trở.", tipSoundOn: "Ko**shou** hỏng.", words: [{w:"障害 (しょうがい)", m:"Trở ngại"}] },
            "修": { hanviet: "TU", mean: "Tu sửa", on: "シュウ", kun: "おさ.める", radicals: "Nhân (亻)", tipImg: "Người cầm gậy sửa.", tipSoundOn: "**Shuu**ri sửa chữa.", words: [{w:"修理 (しゅうり)", m:"Sửa chữa"}] },
            "停": { hanviet: "ĐÌNH", mean: "Dừng", on: "テイ", kun: "と.まる", radicals: "Nhân (亻) + Đình (亭)", tipImg: "Người dừng ở đình.", tipSoundOn: "**Tei**den mất điện.", words: [{w:"停止 (ていし)", m:"Đình chỉ"}] },
            "雷": { hanviet: "LÔI", mean: "Sấm", on: "ライ", kun: "かみなり", radicals: "Vũ (雨) + Điền (田)", tipImg: "Mưa xuống ruộng có sấm.", tipSoundOn: "", tipSoundKun: "**Kaminari** sấm.", words: [{w:"雷 (かみなり)", m:"Sấm sét"}] },
            "調": { hanviet: "ĐIỀU", mean: "Điều tra", on: "チョウ", kun: "しら.べる", radicals: "Ngôn (言)", tipImg: "Nói lời điều hòa.", tipSoundOn: "**Chou**shi tình trạng.", words: [{w:"順調 (じゅんちょう)", m:"Thuận lợi"}] },
            "自": { hanviet: "TỰ", mean: "Tự mình", on: "ジ, シ", kun: "みずか.ら", radicals: "Tự (自)", tipImg: "Cái mũi.", tipSoundOn: "**Ji**shin tự tin.", words: [{w:"自分 (じぶん)", m:"Bản thân"}] },
            "信": { hanviet: "TÍN", mean: "Tin tưởng", on: "シン", kun: "", radicals: "Nhân (亻) + Ngôn (言)", tipImg: "Lời người nói đáng tin.", tipSoundOn: "Ji**shin** tự tin.", words: [{w:"信用 (しんよう)", m:"Tin dùng"}] },
            "慢": { hanviet: "MẠN", mean: "Tự mãn", on: "マン", kun: "", radicals: "Tâm (忄)", tipImg: "Tâm ngạo mạn.", tipSoundOn: "Ji**man** tự mãn.", words: [{w:"我慢 (がまん)", m:"Chịu đựng"}] },
            "関": { hanviet: "QUAN", mean: "Liên quan", on: "カン", kun: "せき", radicals: "Môn (門)", tipImg: "Cổng quan.", tipSoundOn: "**Kan**shin quan tâm.", words: [{w:"関係 (かんけい)", m:"Quan hệ"}] },
            "感": { hanviet: "CẢM", mean: "Cảm giác", on: "カン", kun: "", radicals: "Tâm (心)", tipImg: "Cảm nhận từ tim.", tipSoundOn: "**Kan**dou cảm động.", words: [{w:"感想 (かんそう)", m:"Cảm tưởng"}] },
            "興": { hanviet: "HƯNG", mean: "Hứng thú", on: "コウ, キョウ", kun: "おこ.す", radicals: "Cữu (臼)", tipImg: "Cùng nhau nâng lên.", tipSoundOn: "**Kou**fun hưng phấn.", words: [{w:"興味 (きょうみ)", m:"Hứng thú"}] },
            "奮": { hanviet: "PHẤN", mean: "Phấn đấu", on: "フン", kun: "ふる.う", radicals: "Đại (大) + Chuy (隹) + Điền (田)", tipImg: "Chim lớn bay trên ruộng phấn khích.", tipSoundOn: "Kou**fun** hưng phấn.", words: [{w:"奮闘 (ふんとう)", m:"Phấn đấu"}] },
            "想": { hanviet: "TƯỞNG", mean: "Tưởng tượng", on: "ソウ", kun: "", radicals: "Tâm (心)", tipImg: "Tâm tương tư.", tipSoundOn: "Kan**sou** cảm tưởng.", words: [{w:"予想 (よそう)", m:"Dự đoán"}] },
            "予": { hanviet: "DỰ", mean: "Dự báo", on: "ヨ", kun: "", radicals: "Mã (予)", tipImg: "Dự báo trước.", tipSoundOn: "**Yo**sou dự đoán.", words: [{w:"予定 (よてい)", m:"Dự định"}] },
            "専": { hanviet: "CHUYÊN", mean: "Chuyên môn", on: "セン", kun: "もっぱ.ら", radicals: "Thốn (寸)", tipImg: "Chuyên tâm một tấc lòng.", tipSoundOn: "**Sen**mon chuyên môn.", words: [{w:"専用 (せんよう)", m:"Chuyên dùng"}] },
            "研": { hanviet: "NGHIÊN", mean: "Mài/Nghiên cứu", on: "ケン", kun: "と.ぐ", radicals: "Thạch (石)", tipImg: "Mài đá.", tipSoundOn: "**Ken**kyuu nghiên cứu.", words: [{w:"研修 (けんしゅう)", m:"Tu nghiệp"}] },
            "究": { hanviet: "CỨU", mean: "Nghiên cứu", on: "キュウ", kun: "きわ.める", radicals: "Huyệt (穴) + Cửu (九)", tipImg: "Đào chín cái lỗ nghiên cứu.", tipSoundOn: "Ken**kyuu** nghiên cứu.", words: [{w:"究明 (きゅうめい)", m:"Làm rõ"}] },
            "査": { hanviet: "TRA", mean: "Điều tra", on: "サ", kun: "", radicals: "Mộc (木)", tipImg: "Kiểm tra cây.", tipSoundOn: "Chou**sa** điều tra.", words: [{w:"検査 (けんさ)", m:"Kiểm tra"}] },
            "原": { hanviet: "NGUYÊN", mean: "Nguyên nhân", on: "ゲン", kun: "はら", radicals: "Nha (厂)", tipImg: "Nguồn gốc từ sườn núi.", tipSoundOn: "**Gen**in nguyên nhân.", words: [{w:"原料 (げんりょう)", m:"Nguyên liệu"}] },
            "因": { hanviet: "NHÂN", mean: "Nguyên nhân", on: "イン", kun: "よ.る", radicals: "Vi (囗) + Đại (大)", tipImg: "Người nằm trong khung là nhân quả.", tipSoundOn: "Gen**in** nguyên nhân.", words: [{w:"原因 (げんいん)", m:"Nguyên nhân"}] },
            "果": { hanviet: "QUẢ", mean: "Kết quả", on: "カ", kun: "は.たす", radicals: "Mộc (木)", tipImg: "Quả trên cây.", tipSoundOn: "Kek**ka** kết quả.", words: [{w:"果物 (くだもの)", m:"Trái cây"}] },
            "解": { hanviet: "GIẢI", mean: "Giải quyết", on: "カイ", kun: "と.く", radicals: "Giác (角) + Đao (刀) + Ngưu (牛)", tipImg: "Dùng dao mổ sừng bò.", tipSoundOn: "**Kai**ketsu giải quyết.", words: [{w:"理解 (りかい)", m:"Lý giải"}] },
            "決": { hanviet: "QUYẾT", mean: "Quyết định", on: "ケツ", kun: "き.める", radicals: "Thủy (氵)", tipImg: "Dòng nước quyết liệt.", tipSoundOn: "Kai**ketsu** giải quyết.", words: [{w:"決定 (けってい)", m:"Quyết định"}] },
            "確": { hanviet: "XÁC", mean: "Chính xác", on: "カク", kun: "たし.か", radicals: "Thạch (石)", tipImg: "Đá chắc chắn.", tipSoundOn: "Sei**kaku** chính xác.", tipSoundKun: "**Tashi**kameru xác nhận.", words: [{w:"確かめる (たしかめる)", m:"Xác nhận"}] },
            "利": { hanviet: "LỢI", mean: "Tiện lợi", on: "リ", kun: "き.く", radicals: "Hòa (禾) + Đao (刂)", tipImg: "Dao gặt lúa sắc bén.", tipSoundOn: "**Ri**you sử dụng.", words: [{w:"便利 (べんり)", m:"Tiện lợi"}] },
            "用": { hanviet: "DỤNG", mean: "Sử dụng", on: "ヨウ", kun: "もち.いる", radicals: "Dụng (用)", tipImg: "Cái chuông.", tipSoundOn: "Ri**you** sử dụng.", words: [{w:"用意 (ようい)", m:"Chuẩn bị"}] },
            "減": { hanviet: "GIẢM", mean: "Giảm", on: "ゲン", kun: "へ.る", radicals: "Thủy (氵)", tipImg: "Nước giảm.", tipSoundOn: "**Gen**shou giảm thiểu.", words: [{w:"減る (へる)", m:"Giảm"}] },
            "少": { hanviet: "THIỂU", mean: "Ít", on: "ショウ", kun: "すく.ない", radicals: "Tiểu (小)", tipImg: "Nhỏ và ít.", tipSoundOn: "Gen**shou** giảm thiểu.", tipSoundKun: "**Suko**shi một chút.", words: [{w:"少年 (しょうねん)", m:"Thiếu niên"}] },
            "理": { hanviet: "LÝ", mean: "Lý lẽ", on: "リ", kun: "", radicals: "Ngọc (王)", tipImg: "Vua có lý lẽ.", tipSoundOn: "**Ri**kai lý giải.", words: [{w:"理由 (りゆう)", m:"Lý do"}] },
            "発": { hanviet: "PHÁT", mean: "Phát hiện", on: "ハツ", kun: "", radicals: "Bát (癶)", tipImg: "Bắn tên.", tipSoundOn: "**Hat**sumei phát minh.", words: [{w:"発表 (はっぴょう)", m:"Phát biểu"}] },
            "見": { hanviet: "KIẾN", mean: "Nhìn", on: "ケン", kun: "み.る", radicals: "Kiến (見)", tipImg: "Con mắt.", tipSoundOn: "Hak**ken** phát hiện.", words: [{w:"意見 (いけん)", m:"Ý kiến"}] },
            "明": { hanviet: "MINH", mean: "Sáng", on: "メイ", kun: "あか.るい", radicals: "Nhật (日) + Nguyệt (月)", tipImg: "Sáng.", tipSoundOn: "Hatsu**mei** phát minh.", words: [{w:"説明 (せつめい)", m:"Giải thích"}] },
            "団": { hanviet: "ĐOÀN", mean: "Đoàn thể", on: "ダン", kun: "", radicals: "Vi (囗) + Chuyên (专)", tipImg: "Chuyên tâm trong một nhóm.", tipSoundOn: "**Dan**tai đoàn thể.", words: [{w:"団結 (だんけつ)", m:"Đoàn kết"}] },
            "体": { hanviet: "THỂ", mean: "Cơ thể", on: "タイ", kun: "からだ", radicals: "Nhân (亻) + Bản (本)", tipImg: "Người là gốc.", tipSoundOn: "Dan**tai** đoàn thể.", words: [{w:"体重 (たいじゅう)", m:"Cân nặng"}] },
            "博": { hanviet: "BÁC", mean: "Uyên bác", on: "ハク", kun: "", radicals: "Thập (十)", tipImg: "Mười chuyên môn uyên bác.", tipSoundOn: "**Haku**butsukan bảo tàng.", words: [{w:"博士 (はくし)", m:"Tiến sĩ"}] },
            "物": { hanviet: "VẬT", mean: "Đồ vật", on: "ブツ, モツ", kun: "もの", radicals: "Ngưu (牛)", tipImg: "Con bò.", tipSoundOn: "Haku**butsu**kan bảo tàng.", words: [{w:"動物 (どうぶつ)", m:"Động vật"}] },
            "館": { hanviet: "QUÁN", mean: "Hội quán", on: "カン", kun: "やかた", radicals: "Thực (饣) + Quan (官)", tipImg: "Quan ăn ở quán.", tipSoundOn: "Hakubutsu**kan** bảo tàng.", words: [{w:"図書館 (としょかん)", m:"Thư viện"}] },
            "選": { hanviet: "TUYỂN", mean: "Tuyển chọn", on: "セン", kun: "えら.ぶ", radicals: "Xước (⻌)", tipImg: "Đi chọn.", tipSoundOn: "**Sen**kyo bầu cử.", words: [{w:"選ぶ (えらぶ)", m:"Chọn"}] },
            "挙": { hanviet: "CỬ", mean: "Tiến cử", on: "キョ", kun: "あ.げる", radicals: "Thủ (手)", tipImg: "Giơ tay bầu cử.", tipSoundOn: "Sen**kyo** bầu cử.", words: [{w:"挙げる (あげる)", m:"Giơ lên"}] },
            "行": { hanviet: "HÀNH", mean: "Tổ chức", on: "コウ, ギョウ", kun: "おこな.う", radicals: "Hành (行)", tipImg: "Đi lại.", tipSoundOn: "Ryokou du lịch.", tipSoundKun: "**Okona**u tổ chức.", words: [{w:"行動 (こうどう)", m:"Hành động"}] },
            "税": { hanviet: "THUẾ", mean: "Thuế", on: "ゼイ", kun: "", radicals: "Hòa (禾) + Duyệt (兑)", tipImg: "Lúa vui vẻ nộp thuế.", tipSoundOn: "**Zei**kin tiền thuế.", words: [{w:"税関 (ぜいかん)", m:"Hải quan"}] },
            "責": { hanviet: "TRÁCH", mean: "Trách nhiệm", on: "セキ", kun: "せ.める", radicals: "Bối (貝)", tipImg: "Tiền nợ là trách nhiệm.", tipSoundOn: "**Seki**nin trách nhiệm.", words: [{w:"責める (せめる)", m:"Đổ lỗi"}] },
            "任": { hanviet: "NHIỆM", mean: "Nhiệm vụ", on: "ニン", kun: "まか.せる", radicals: "Nhân (亻)", tipImg: "Người gánh vác.", tipSoundOn: "Seki**nin** trách nhiệm.", words: [{w:"任せる (まかせる)", m:"Giao phó"}] },
            "書": { hanviet: "THƯ", mean: "Viết", on: "ショ", kun: "か.く", radicals: "Viết (曰)", tipImg: "Cầm bút viết.", tipSoundOn: "**Sho**rui tài liệu.", words: [{w:"図書館 (としょかん)", m:"Thư viện"}] },
            "類": { hanviet: "LOẠI", mean: "Chủng loại", on: "ルイ", kun: "", radicals: "Mễ (米) + Đại (大) + Hiệt (頁)", tipImg: "Gạo đầu to cùng loại.", tipSoundOn: "Sho**rui** tài liệu.", words: [{w:"種類 (しゅるい)", m:"Chủng loại"}] },
            "題": { hanviet: "ĐỀ", mean: "Đề bài", on: "ダイ", kun: "", radicals: "Hiệt (頁) + Thị (是)", tipImg: "Đề bài đúng đắn.", tipSoundOn: "**Dai**mei nhan đề.", words: [{w:"問題 (もんだい)", m:"Vấn đề"}] },
            "条": { hanviet: "ĐIỀU", mean: "Điều kiện", on: "ジョウ", kun: "", radicals: "Mộc (木)", tipImg: "Cành cây.", tipSoundOn: "**Jou**ken điều kiện.", words: [{w:"条件 (じょうけん)", m:"Điều kiện"}] },
            "採": { hanviet: "THẢI", mean: "Hái/Tuyển", on: "サイ", kun: "と.る", radicals: "Thủ (扌)", tipImg: "Tay hái.", tipSoundOn: "**Sai**you tuyển dụng.", words: [{w:"採点 (さいてん)", m:"Chấm điểm"}] },
            "締": { hanviet: "ĐẾ", mean: "Buộc/Ký kết", on: "テイ", kun: "し.める", radicals: "Mịch (糸)", tipImg: "Dây buộc vua.", tipSoundOn: "", tipSoundKun: "**Shi**mekiri hạn chót.", words: [{w:"締める (しめる)", m:"Thắt"}] },
            "期": { hanviet: "KỲ", mean: "Thời kỳ", on: "キ", kun: "", radicals: "Nguyệt (月)", tipImg: "Trăng đúng kỳ.", tipSoundOn: "**Ki**kan thời hạn.", words: [{w:"期間 (きかん)", m:"Thời gian"}] },
            "倍": { hanviet: "BỘI", mean: "Gấp bội", on: "バイ", kun: "", radicals: "Nhân (亻)", tipImg: "Người đứng lên miệng.", tipSoundOn: "**Bai** gấp đôi.", words: [{w:"倍 (ばい)", m:"Gấp đôi"}] },
            "近": { hanviet: "CẬN", mean: "Gần", on: "キン", kun: "ちか.い", radicals: "Xước (⻌) + Cân (斤)", tipImg: "Rìu ở gần.", tipSoundOn: "", tipSoundKun: "**Chika**michi đường tắt.", words: [{w:"近い (ちかい)", m:"Gần"}] },
            "中": { hanviet: "TRUNG", mean: "Ở giữa", on: "チュウ", kun: "なか", radicals: "Trung (丨)", tipImg: "Ở giữa.", tipSoundOn: "**Chuu**shin trung tâm.", words: [{w:"真ん中 (まんなか)", m:"Chính giữa"}] },
            "心": { hanviet: "TÂM", mean: "Tim", on: "シン", kun: "こころ", radicals: "Tâm (心)", tipImg: "Trái tim.", tipSoundOn: "Chuu**shin** trung tâm.", words: [{w:"心配 (しんぱい)", m:"Lo lắng"}] },
            "辺": { hanviet: "BIÊN", mean: "Vùng", on: "ヘン", kun: "あた.り", radicals: "Xước (⻌) + Đao (刀)", tipImg: "Đi bên dao.", tipSoundOn: "", tipSoundKun: "**Atari** vùng lân cận.", words: [{w:"辺り (あたり)", m:"Xung quanh"}] },
            "周": { hanviet: "CHU", mean: "Chu vi", on: "シュウ", kun: "まわ.り", radicals: "Khẩu (口)", tipImg: "Ruộng xung quanh.", tipSoundOn: "", tipSoundKun: "**Mawari** xung quanh.", words: [{w:"周辺 (しゅうへん)", m:"Vùng xung quanh"}] },
            "穴": { hanviet: "HUYỆT", mean: "Lỗ", on: "ケツ", kun: "あな", radicals: "Huyệt (穴)", tipImg: "Cái hang.", tipSoundOn: "", tipSoundKun: "**Ana** lỗ.", words: [{w:"穴 (あな)", m:"Lỗ"}] },
            "地": { hanviet: "ĐỊA", mean: "Đất", on: "チ, ジ", kun: "", radicals: "Thổ (土)", tipImg: "Đất.", tipSoundOn: "**Ji**men mặt đất.", words: [{w:"地下 (ちか)", m:"Dưới đất"}] },
            "掘": { hanviet: "QUẬT", mean: "Đào", on: "クツ", kun: "ほ.る", radicals: "Thủ (扌) + Khuất (屈)", tipImg: "Tay đào đất khuất.", tipSoundOn: "Hak**kutsu** khai quật.", tipSoundKun: "**Ho**ru đào.", words: [{w:"掘る (ほる)", m:"Đào"}] },
            "列": { hanviet: "LIỆT", mean: "Hàng lối", on: "レツ", kun: "", radicals: "Đao (刂)", tipImg: "Dao xếp hàng.", tipSoundOn: "**Retsu** hàng.", words: [{w:"行列 (ぎょうれつ)", m:"Hàng người"}] },
            "幅": { hanviet: "PHÚC", mean: "Chiều rộng", on: "フク", kun: "はば", radicals: "Cân (巾)", tipImg: "Khăn rộng phúc đức.", tipSoundOn: "Zen**puku** toàn bộ.", tipSoundKun: "**Haba** chiều rộng.", words: [{w:"幅 (はば)", m:"Chiều rộng"}] },
            "範": { hanviet: "PHẠM", mean: "Phạm vi", on: "ハン", kun: "", radicals: "Trúc (竹)", tipImg: "Xe tre trong phạm vi.", tipSoundOn: "**Han**i phạm vi.", words: [{w:"模範 (もはん)", m:"Mô phạm"}] },
            "囲": { hanviet: "VI", mean: "Bao quanh", on: "イ", kun: "かこ.む", radicals: "Vi (囗) + Tỉnh (井)", tipImg: "Giếng trong vây.", tipSoundOn: "Han**'i** phạm vi.", words: [{w:"周囲 (しゅうい)", m:"Chu vi"}] },
            "内": { hanviet: "NỘI", mean: "Bên trong", on: "ナイ", kun: "うち", radicals: "Nội (冂)", tipImg: "Người bên trong.", tipSoundOn: "**Nai**you nội dung.", words: [{w:"案内 (あんない)", m:"Hướng dẫn"}] },
            "容": { hanviet: "DUNG", mean: "Nội dung", on: "ヨウ", kun: "", radicals: "Miên (宀) + Cốc (谷)", tipImg: "Thung lũng dưới mái nhà chứa đựng.", tipSoundOn: "Nai**you** nội dung.", words: [{w:"美容 (びよう)", m:"Làm đẹp"}] },
            "特": { hanviet: "ĐẶC", mean: "Đặc biệt", on: "トク", kun: "", radicals: "Ngưu (牛) + Tự (寺)", tipImg: "Bò chùa đặc biệt.", tipSoundOn: "**Toku**chou đặc trưng.", words: [{w:"特別 (とくべつ)", m:"Đặc biệt"}] },
            "徴": { hanviet: "TRƯNG", mean: "Đặc trưng", on: "チョウ", kun: "", radicals: "Xích (彳)", tipImg: "Vua đi vi hành đặc trưng.", tipSoundOn: "Toku**chou** đặc trưng.", words: [{w:"特徴 (とくちょう)", m:"Đặc trưng"}] },
            "普": { hanviet: "PHỔ", mean: "Phổ thông", on: "フ", kun: "", radicals: "Nhật (日)", tipImg: "Mặt trời chiếu khắp.", tipSoundOn: "**Futsu**u bình thường.", words: [{w:"普及 (ふきゅう)", m:"Phổ cập"}] },
            "通": { hanviet: "THÔNG", mean: "Đi qua", on: "ツウ", kun: "とお.る", radicals: "Xước (⻌)", tipImg: "Đi thông.", tipSoundOn: "Fu**tsuu** bình thường.", words: [{w:"交通 (こうつう)", m:"Giao thông"}] },
            "当": { hanviet: "ĐƯƠNG", mean: "Đúng", on: "トウ", kun: "あ.たる", radicals: "Tiểu (⺌)", tipImg: "Đương nhiên.", tipSoundOn: "**Atari**mae đương nhiên.", words: [{w:"本当 (ほんとう)", m:"Thật sự"}] },
            "偽": { hanviet: "NGỤY", mean: "Giả", on: "ギ", kun: "にせ", radicals: "Nhân (亻) + Vi (為)", tipImg: "Người làm giả.", tipSoundOn: "", tipSoundKun: "**Nise** giả.", words: [{w:"偽物 (にせもの)", m:"Đồ giả"}] }
        };

        // --- 4. APP LOGIC ---
        let currentIndex = 0; 
        let currentQuizItem = null; 
        let score = 0; 
        let currentStrokeSvg = null;

        function init() {
            renderList();
            renderGrammarMenu();
            loadWord(0);
            
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', e => { 
                    const t = e.target.value.toLowerCase(); 
                    document.querySelectorAll('.vocab-item').forEach(el => el.style.display = el.innerText.toLowerCase().includes(t) ? 'block' : 'none'); 
                });
            }

            const mobileSearchInput = document.getElementById('mobileSearchInput');
            if (mobileSearchInput) {
                mobileSearchInput.addEventListener('input', e => { 
                    const t = e.target.value.toLowerCase(); 
                    document.querySelectorAll('.vocab-item').forEach(el => el.style.display = el.innerText.toLowerCase().includes(t) ? 'block' : 'none'); 
                });
            }

            const quizInput = document.getElementById('quiz-input');
            if (quizInput) {
                quizInput.addEventListener('keypress', e => { if(e.key === 'Enter') checkAnswer(); });
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            document.getElementById('learn-section').classList.toggle('hidden', tab !== 'learn');
            document.getElementById('quiz-section').classList.toggle('hidden', tab !== 'quiz');
            if(tab === 'quiz') nextQuestion();
        }

        function renderList() {
            const listD = document.getElementById('vocabList'); 
            const listM = document.getElementById('mobileVocabList');
            const html = vocabData.map((item, i) => `
                <div class="vocab-item p-3 border-b hover:bg-gray-50 cursor-pointer rounded-lg mx-1 my-1" data-index="${i}" onclick="loadWord(${i}); if(window.innerWidth < 768) toggleDrawer();">
                    <div class="flex justify-between font-bold items-center">
                        <span class="text-gray-800 ja-text">${item.Kanji || item.Furigana}</span>
                        <span class="text-gray-300 text-xs font-mono">#${item.STT}</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1 truncate">${item.Nghĩa}</div>
                </div>`).join('');
            if (listD) listD.innerHTML = html;
            if (listM) listM.innerHTML = html;
        }

        function loadWord(idx) {
            currentIndex = idx; 
            const word = vocabData[idx];
            document.querySelectorAll('.vocab-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll(`.vocab-item[data-index="${idx}"]`).forEach(el => el.classList.add('active'));
            
            const activeItem = document.querySelector(`.vocab-item[data-index="${idx}"]`);
            if (activeItem) activeItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            document.getElementById('headerProgress').innerText = `${idx+1}/${vocabData.length}`;
            document.getElementById('wordIndex').innerText = `#${word.STT}`;
            document.getElementById('cardKanji').innerText = word.Kanji || word.Furigana;
            document.getElementById('cardFurigana').innerText = word.Furigana;
            document.getElementById('cardMeaning').innerText = word.Nghĩa;
            document.getElementById('wordType').innerText = word.type.toUpperCase();
            
            const hasKanji = word.Kanji && word.Kanji !== word.Furigana;
            document.getElementById('strokeBtn').classList.toggle('hidden', !hasKanji);
            
            renderShadowing(word);
        }

        function renderShadowing(word) {
            const cont = document.getElementById('sentenceList'); 
            cont.innerHTML = '';
            
            if(!word.conv) { 
                document.getElementById('emptyState').classList.remove('hidden'); 
                return; 
            }
            document.getElementById('emptyState').classList.add('hidden');
            
            const types = [
                { k:'polite', l:'Lịch sự', m:word.conv.pVi, i:'user-tie', c:'indigo' }, 
                { k:'casual', l:'Thân mật', m:word.conv.cVi, i:'comments', c:'pink' }
            ];
            
            types.forEach(t => {
                const grammarBtn = word.conv.gIds && word.conv.gIds.length > 0 
                    ? `<button onclick="openExplan('${word.conv.gIds.join(',')}')" class="text-xs text-indigo-500 hover:text-indigo-700 font-bold px-2 py-1 rounded hover:bg-indigo-50 transition"><i class="fas fa-info-circle"></i> Ngữ pháp</button>`
                    : '';

                cont.innerHTML += `
                    <div class="shadow-card bg-white rounded-2xl p-4 border border-gray-100">
                        <div class="flex justify-between border-b border-gray-100 pb-2 mb-3">
                            <div class="flex gap-2 items-center">
                                <div class="bg-${t.c}-50 p-1.5 rounded text-${t.c}-600"><i class="fas fa-${t.i}"></i></div>
                                <span class="text-xs font-bold text-gray-400 uppercase tracking-wide">${t.l}</span>
                            </div>
                            ${grammarBtn}
                        </div>
                        <div class="flex justify-between items-start gap-3">
                            <div>
                                <div class="text-lg md:text-xl ja-text font-medium text-gray-800 mb-1 cursor-pointer hover:text-indigo-600 transition-colors" onclick="speakText('${word.conv[t.k]}')">${word.conv[t.k]}</div>
                                <div class="text-sm text-gray-500 italic">${t.m}</div>
                            </div>
                            <button onclick="speakText('${word.conv[t.k]}')" class="audio-btn text-${t.c}-400 hover:text-${t.c}-600 p-2 rounded-full hover:bg-${t.c}-50 transition-colors flex-shrink-0">
                                <i class="fas fa-volume-up text-xl"></i>
                            </button>
                        </div>
                    </div>`;
            });
        }

        function openExplan(idsStr) {
            const ids = idsStr.split(','); 
            const f = document.getElementById('dgFormula'); 
            const e = document.getElementById('dgExplanation');
            
            f.innerText = ids.map(id => grammarRepo[id] ? grammarRepo[id].formula : "N/A").join("  /  ");
            e.innerHTML = ids.map(id => {
                if (!grammarRepo[id]) return `<div class="text-red-500">Missing grammar: ${id}</div>`;
                return `
                <div class="pb-2 border-b border-gray-100 last:border-0">
                    <strong class="text-indigo-700 block mb-1">${grammarRepo[id].title} <span class="text-xs font-normal text-gray-400">(${grammarRepo[id].desc.split(':')[0]})</span></strong>
                    <p>${grammarRepo[id].desc.split(':').slice(1).join(':') || grammarRepo[id].desc}</p>
                    <p class="text-xs text-gray-400 mt-1 italic">Vd: ${grammarRepo[id].ex}</p>
                </div>`;
            }).join("");
            
            showModal('detailGrammarModal');
        }

        function renderGrammarMenu() {
            const grid = document.getElementById('grammarGrid'); 
            grid.innerHTML = '';
            Object.keys(grammarRepo).forEach(key => {
                const r = grammarRepo[key];
                grid.innerHTML += `
                    <div class="bg-white p-4 rounded-xl border border-gray-100 flex flex-col justify-between hover:shadow-md transition cursor-pointer" onclick="speakText('${r.ex}')">
                        <div>
                            <div class="font-bold text-sm text-indigo-600 mb-1 flex items-center gap-2"><i class="fas fa-tag text-xs"></i> ${r.title}</div>
                            <code class="text-xs block bg-gray-50 p-1.5 rounded mb-2 border border-gray-200 font-mono text-gray-700">${r.formula}</code>
                            <p class="text-xs text-gray-500 mb-2 line-clamp-2">${r.desc}</p>
                        </div>
                        <div class="bg-indigo-50 p-2 rounded flex justify-between items-center gap-2 mt-2">
                            <span class="text-[11px] font-medium text-indigo-800 ja-text truncate">${r.ex}</span>
                            <i class="fas fa-volume-up text-indigo-400 text-xs"></i>
                        </div>
                    </div>`;
            });
        }

        function showModal(id) { 
            const modal = document.getElementById(id);
            modal.classList.remove('hidden'); 
            setTimeout(() => { 
                document.getElementById(id.replace('Modal','Backdrop')).classList.remove('opacity-0'); 
                document.getElementById(id.replace('Modal','Panel')).classList.remove('opacity-0', 'scale-95'); 
            }, 10); 
        }

        function closeModal(id) { 
            const b = document.getElementById(id.replace('Modal','Backdrop')); 
            const p = document.getElementById(id.replace('Modal','Panel'));
            if(b) b.classList.add('opacity-0'); 
            if(p) p.classList.add('opacity-0', 'scale-95');
            setTimeout(() => document.getElementById(id).classList.add('hidden'), 200); 
        }

        function openGrammarList() { showModal('grammarListModal'); }

        async function openStrokeModal(char) {
            const word = vocabData[currentIndex]; 
            const kanjis = word.Kanji.match(/[\u4e00-\u9faf]/g) || [];
            if(kanjis.length === 0) return;
            const target = char || kanjis[0];
            const tabs = document.getElementById('strokeTabs'); 
            tabs.innerHTML = '';
            if(kanjis.length > 1) {
                kanjis.forEach(k => {
                    const b = document.createElement('button'); 
                    b.innerText = k;
                    b.className = `w-12 h-12 text-xl rounded-xl font-bold border transition ja-text ${k===target ? 'bg-pink-600 text-white border-pink-600 shadow-lg' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}`;
                    b.onclick = () => showKanjiStroke(k); 
                    tabs.appendChild(b);
                });
            }
            showModal('strokeModal'); 
            await showKanjiStroke(target);
        }

        async function showKanjiStroke(k) {
            const d = kanjiDetails[k]; 
            const c = document.getElementById('kanjiDetailContent'); 
            const e = document.getElementById('kanjiDetailEmpty');
            if(d) {
                c.classList.remove('hidden'); e.classList.add('hidden');
                document.getElementById('detailKanji').innerText = k; 
                document.getElementById('detailHanViet').innerText = d.hanviet || '?';
                document.getElementById('detailMeaning').innerText = d.mean || ''; 
                document.getElementById('detailOn').innerText = d.on || '-'; 
                document.getElementById('detailKun').innerText = d.kun || '-';
                document.getElementById('detailRadicals').innerText = d.radicals || '...';
                
                const fmt = s => s.replace(/\*\*(.*?)\*\*/g, '<span class="font-bold text-gray-900">$1</span>');
                document.getElementById('detailTipImg').innerHTML = fmt(d.tipImg || ''); 
                
                let soundContent = d.tipSound || '';
                if (!soundContent && (d.tipSoundOn || d.tipSoundKun)) {
                    soundContent = [d.tipSoundOn, d.tipSoundKun].filter(Boolean).join(' / ');
                }
                document.getElementById('detailTipSound').innerHTML = fmt(soundContent);
                
                document.getElementById('btnPlayOn').onclick = () => speakText(d.on);
                document.getElementById('btnPlayKun').onclick = () => speakText(d.kun);

                const wc = document.getElementById('detailWords'); 
                wc.innerHTML = '';
                if(d.words) {
                    d.words.forEach(w => wc.innerHTML += `<div class="flex justify-between items-center bg-gray-50 p-2 rounded hover:bg-gray-100 cursor-pointer border border-transparent hover:border-gray-200 transition" onclick="speakText('${w.w}')"><span class="text-lg font-bold text-indigo-700 ja-text">${w.w}</span><span class="text-xs text-gray-500 font-medium">${w.m}</span></div>`);
                }
            } else { 
                c.classList.add('hidden'); e.classList.remove('hidden'); 
            }
            const anim = document.getElementById('strokeAnimContainer'); 
            const grid = document.getElementById('strokeGridContainer');
            anim.innerHTML = '<i class="fas fa-spinner fa-spin text-gray-300 text-2xl"></i>'; 
            grid.innerHTML = '';
            try {
                const r = await fetch(`https://cdn.jsdelivr.net/gh/KanjiVG/kanjivg/kanji/${getKanjiHex(k)}.svg`);
                if(!r.ok) throw new Error();
                const svgText = await r.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(svgText, "image/svg+xml");
                doc.querySelectorAll('path').forEach(p => p.setAttribute('style', 'opacity:0; stroke:#333; stroke-width:3; fill:none; stroke-linecap:round; stroke-linejoin:round;')); 
                anim.innerHTML = new XMLSerializer().serializeToString(doc.documentElement);
                const mainSvg = anim.querySelector('svg');
                mainSvg.setAttribute('width','100%'); mainSvg.setAttribute('height','100%');
                currentStrokeSvg = mainSvg;
                replayStrokeAnimation();
                const cleanDoc = parser.parseFromString(svgText, "image/svg+xml"); 
                cleanDoc.querySelectorAll('path').forEach((p, i) => {
                    const b = document.createElement('div'); 
                    b.className = "w-16 h-16 stroke-grid-box flex items-center justify-center rounded bg-white shadow-sm";
                    const clone = cleanDoc.documentElement.cloneNode(true);
                    clone.setAttribute('width','100%'); clone.setAttribute('height','100%');
                    clone.querySelectorAll('path').forEach((pp, idx) => {
                        pp.style.fill="none"; pp.style.strokeLinecap="round"; pp.style.strokeLinejoin="round";
                        if(idx<i) { pp.style.stroke="#e5e7eb"; pp.style.strokeWidth="3"; }
                        else if(idx===i) { pp.style.stroke="#db2777"; pp.style.strokeWidth="4"; } 
                        else pp.style.display="none";
                    });
                    b.appendChild(clone); grid.appendChild(b);
                });
            } catch(e) { anim.innerHTML = "<span class='text-xs text-red-400'>Lỗi tải nét viết</span>"; }
        }

        function replayStrokeAnimation() {
            if(!currentStrokeSvg) return;
            const paths = currentStrokeSvg.querySelectorAll('path');
            paths.forEach(p => { p.style.transition='none'; p.style.opacity='0'; });
            void currentStrokeSvg.offsetWidth;
            let delay = 0;
            paths.forEach(p => {
                const len = p.getTotalLength();
                p.style.strokeDasharray = len; p.style.strokeDashoffset = len; p.style.opacity = '1';
                setTimeout(() => { p.style.transition = `stroke-dashoffset 0.6s ease-in-out`; p.style.strokeDashoffset = '0'; }, delay * 1000);
                delay += 0.6;
            });
        }

        function getKanjiHex(k) { return k.charCodeAt(0).toString(16).padStart(5, '0'); }
        function speakText(t) { if ('speechSynthesis' in window) { const u = new SpeechSynthesisUtterance(t); u.lang = 'ja-JP'; u.rate = 0.9; speechSynthesis.speak(u); } }
        function speakCurrent() { speakText(vocabData[currentIndex].Furigana); }
        function toggleDrawer() { const d = document.getElementById('mobileDrawer'); const c = document.getElementById('drawerContent'); const b = document.getElementById('drawerBackdrop'); if(d.classList.contains('pointer-events-none')) { d.classList.remove('pointer-events-none'); c.classList.remove('-translate-x-full'); b.classList.remove('opacity-0'); } else { c.classList.add('-translate-x-full'); b.classList.add('opacity-0'); setTimeout(() => d.classList.add('pointer-events-none'), 300); } }

        function nextQuestion() {
            document.getElementById('feedback-area').classList.add('hidden'); document.getElementById('btn-check').classList.remove('hidden'); document.getElementById('btn-next').classList.add('hidden');
            document.getElementById('quiz-kanji').className = "text-6xl ja-text font-bold text-gray-800 mb-4 transition-all inline-block";
            const inp = document.getElementById('quiz-input'); inp.value = ''; inp.disabled = false; inp.focus();
            const valid = vocabData.filter(v => v.Furigana !== "...");
            currentQuizItem = valid[Math.floor(Math.random() * valid.length)];
            document.getElementById('quiz-kanji').innerText = currentQuizItem.Kanji || currentQuizItem.Furigana;
            document.getElementById('quiz-meaning').innerText = currentQuizItem.Nghĩa;
        }
        
        function checkAnswer() {
            const inp = document.getElementById('quiz-input'); if(!inp.value.trim()) return;
            inp.disabled = true; 
            const correct = inp.value.trim() === currentQuizItem.Furigana;
            const k = document.getElementById('quiz-kanji'); const fbTitle = document.getElementById('feedback-title'); const fbArea = document.getElementById('feedback-area');
            if(correct) { 
                score += 10; k.classList.add("text-green-600", "correct-anim"); 
                fbTitle.innerHTML = '<span class="text-green-600"><i class="fas fa-check-circle mr-2"></i> Chính xác!</span>';
                fbArea.className = fbArea.className.replace("bg-red-50 border-red-200", "") + " bg-green-50 border-green-200";
                speakText(currentQuizItem.Furigana); 
            } else { 
                score = Math.max(0, score - 5); k.classList.add("text-red-500", "wrong-anim"); 
                fbTitle.innerHTML = '<span class="text-red-600"><i class="fas fa-times-circle mr-2"></i> Sai rồi!</span>';
                fbArea.className = fbArea.className.replace("bg-green-50 border-green-200", "") + " bg-red-50 border-red-200";
            }
            document.getElementById('score-display').innerText = score; document.getElementById('correct-answer').innerText = currentQuizItem.Furigana;
            document.getElementById('feedback-area').classList.remove('hidden'); document.getElementById('btn-check').classList.add('hidden'); document.getElementById('btn-next').classList.remove('hidden');
        }
        
        function playQuizAudio() { if(currentQuizItem) speakText(currentQuizItem.Furigana); }
        function prevWord() { if(currentIndex > 0) loadWord(currentIndex - 1); }
        function nextWord() { if(currentIndex < vocabData.length - 1) loadWord(currentIndex + 1); }

        window.speakCurrent = speakCurrent;
        window.switchTab = switchTab;
        window.openGrammarList = openGrammarList;
        window.openStrokeModal = openStrokeModal;
        window.replayStrokeAnimation = replayStrokeAnimation;
        window.speakText = speakText;
        window.toggleDrawer = toggleDrawer;
        window.nextQuestion = nextQuestion;
        window.checkAnswer = checkAnswer;
        window.playQuizAudio = playQuizAudio;
        window.prevWord = prevWord;
        window.nextWord = nextWord;
        window.loadWord = loadWord;
        window.openExplan = openExplan;
        window.closeModal = closeModal;
        window.showModal = showModal;

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
