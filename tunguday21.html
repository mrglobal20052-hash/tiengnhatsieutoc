<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AzaKanji Tango - Ngày 21: Nguyên nhân & Suy đoán</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Base Settings */
        body { font-family: 'Nunito', 'Inter', sans-serif; background-color: #f3f4f6; height: 100dvh; overflow: hidden; }
        .ja-text { font-family: 'Noto Sans JP', sans-serif; }
        
        /* Custom Scrollbar */
        .scroller { -webkit-overflow-scrolling: touch; overflow-y: auto; }
        .scroller::-webkit-scrollbar { width: 5px; height: 5px; }
        .scroller::-webkit-scrollbar-track { background: transparent; }
        .scroller::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* UI Components */
        .vocab-item { transition: all 0.2s; }
        .vocab-item.active { background-color: #eef2ff; border-left: 4px solid #4f46e5; color: #4338ca; padding-left: 0.75rem; }
        
        .shadow-card { transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.2s; }
        .shadow-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border-top: 1px solid rgba(255, 255, 255, 0.3); }
        
        .tab-btn.active { background-color: white; color: #312e81; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); }
        .tab-btn { color: #a5b4fc; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .wrong-anim { animation: shake 0.3s ease-in-out; }
        
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .correct-anim { animation: pop 0.3s ease-in-out; }

        /* Stroke Order Logic CSS */
        .stroke-grid-box { border: 1px solid #e5e7eb; background-color: white; position: relative; }
        .stroke-grid-box::after { content: ''; position: absolute; top: 0; left: 50%; width: 1px; height: 100%; background: repeating-linear-gradient(to bottom, #ddd 0, #ddd 4px, transparent 4px, transparent 8px); pointer-events: none; }
        .stroke-grid-box::before { content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 1px; background: repeating-linear-gradient(to right, #ddd 0, #ddd 4px, transparent 4px, transparent 8px); pointer-events: none; }
        
        /* Hide stroke paths initially for animation */
        #strokeAnimContainer svg path { opacity: 0; }
    </style>
</head>
<body class="flex flex-col text-slate-800">

    <!-- HEADER -->
    <header class="bg-indigo-700 text-white shadow-lg flex-none z-40 relative">
        <div class="container mx-auto px-4 py-2 md:py-3">
            <div class="flex flex-col md:flex-row justify-between items-center gap-3">
                <div class="flex items-center gap-3 cursor-pointer select-none w-full md:w-auto justify-between" onclick="location.reload()">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-torii-gate text-3xl text-white"></i>
                        <div>
                            <h1 class="text-lg md:text-xl font-bold uppercase tracking-wider">AzaKanji Tango</h1>
                            <p class="text-[10px] md:text-xs text-indigo-200">Ngày 21: Nguyên nhân & Suy đoán</p>
                        </div>
                    </div>
                    <div class="md:hidden text-xs font-semibold bg-indigo-800 px-3 py-1 rounded-full border border-indigo-500/50"><span id="headerProgress">1/87</span></div>
                </div>
                <div class="flex items-center gap-3 w-full md:w-auto">
                    <div class="flex bg-indigo-900/50 rounded-lg p-1 w-full md:w-auto overflow-x-auto no-scrollbar">
                        <button onclick="switchTab('learn')" id="tab-learn" class="tab-btn active flex-1 md:flex-none px-4 py-1.5 rounded-md text-sm font-bold transition flex items-center justify-center gap-2 whitespace-nowrap"><i class="fas fa-book-open"></i> Học Từ</button>
                        <button onclick="switchTab('quiz')" id="tab-quiz" class="tab-btn flex-1 md:flex-none px-4 py-1.5 rounded-md text-sm font-bold transition flex items-center justify-center gap-2 whitespace-nowrap"><i class="fas fa-keyboard"></i> Kiểm Tra</button>
                        <div class="w-px bg-indigo-600 mx-1"></div>
                        <button onclick="openGrammarList()" class="tab-btn flex-1 md:flex-none px-4 py-1.5 rounded-md text-sm font-bold transition flex items-center justify-center gap-2 whitespace-nowrap"><i class="fas fa-scroll"></i> Cẩm Nang</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative w-full">
        <!-- DESKTOP SIDEBAR -->
        <aside class="hidden md:flex w-72 bg-white border-r border-gray-200 flex-col z-10">
            <div class="p-4 border-b border-gray-100 bg-gray-50">
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i>
                    <input type="text" id="searchInput" placeholder="Tìm kiếm từ..." class="w-full pl-9 pr-4 py-2 bg-white border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 transition-all shadow-sm outline-none">
                </div>
            </div>
            <div id="vocabList" class="flex-1 scroller p-2 space-y-1"></div>
        </aside>

        <!-- MAIN CONTENT (LEARN MODE) -->
        <main id="learn-section" class="flex-1 overflow-y-auto scroller bg-slate-50 p-4 pb-28 w-full scroll-smooth">
            <div class="max-w-3xl mx-auto flex flex-col items-center animate-fade-in">
                <!-- Flashcard -->
                <div class="w-full bg-white rounded-2xl p-6 shadow-sm border border-gray-200 mb-6 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-indigo-50 to-pink-50 rounded-bl-full -mr-8 -mt-8 z-0 opacity-60 transition-transform group-hover:scale-110 duration-700"></div>
                    <div class="relative z-10 text-center">
                        <div class="inline-flex items-center gap-2 bg-gray-50 px-3 py-1 rounded-full mb-4 border border-gray-100">
                            <span id="wordType" class="text-[10px] font-bold uppercase text-indigo-500">WORD</span>
                            <div class="w-px h-3 bg-gray-300"></div>
                            <span class="text-[10px] text-gray-400 font-mono" id="wordIndex">#1</span>
                        </div>
                        <div class="relative inline-block mb-2">
                            <h2 id="cardKanji" class="text-5xl md:text-6xl font-bold text-gray-800 ja-text tracking-tight cursor-pointer hover:text-indigo-700 transition-colors" onclick="speakCurrent()">整理する</h2>
                            <button id="strokeBtn" onclick="openStrokeModal()" class="absolute -right-10 top-2 w-8 h-8 bg-pink-100 text-pink-600 rounded-full flex items-center justify-center shadow-sm hover:bg-pink-200 hover:scale-110 transition-all hidden" title="Tập viết">
                                <i class="fas fa-pen-nib text-sm"></i>
                            </button>
                        </div>
                        <div class="flex flex-col items-center gap-1 cursor-pointer" onclick="speakCurrent()">
                            <span id="cardFurigana" class="text-xl text-indigo-600 font-medium ja-text">せいりする</span>
                            <span id="cardMeaning" class="text-lg text-gray-500 font-medium">Sắp xếp</span>
                        </div>
                    </div>
                </div>

                <!-- Shadowing Sentences -->
                <div class="w-full">
                    <div class="flex items-center gap-2 mb-4 px-1">
                        <div class="bg-pink-100 text-pink-600 p-1.5 rounded-lg text-sm"><i class="fas fa-comments"></i></div>
                        <h3 class="font-bold text-gray-700 text-lg">Hội thoại & Ví dụ</h3>
                    </div>
                    <div id="sentenceList" class="space-y-4"></div>
                    
                    <!-- Empty State -->
                    <div id="emptyState" class="hidden flex-col items-center justify-center p-8 text-center bg-white rounded-2xl border border-dashed border-gray-300 text-gray-400">
                        <i class="fas fa-comment-dots text-4xl mb-2 text-gray-300"></i>
                        <p class="text-sm">Chưa có hội thoại mẫu cho từ này.</p>
                        <p class="text-xs text-gray-300 mt-1">(Dữ liệu đang cập nhật)</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- QUIZ MODE -->
        <div id="quiz-section" class="hidden flex-1 w-full overflow-y-auto scroller bg-slate-100 p-4 absolute inset-0 z-20">
            <div class="max-w-2xl mx-auto mt-4 md:mt-10 animate-fade-in">
                <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-200">
                    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-6 text-white flex justify-between items-center relative overflow-hidden">
                        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                        <div class="relative z-10">
                            <h2 class="text-2xl font-bold flex items-center gap-2"><i class="fas fa-graduation-cap"></i> Thử Thách</h2>
                            <p class="text-indigo-100 text-sm">Nhìn Kanji - Đoán Hiragana</p>
                        </div>
                        <div class="text-right relative z-10 bg-white/10 p-2 rounded-lg backdrop-blur-sm">
                            <div class="text-[10px] text-indigo-100 uppercase font-bold tracking-wider">Điểm số</div>
                            <div class="text-3xl font-bold font-mono" id="score-display">0</div>
                        </div>
                    </div>
                    
                    <div class="p-6 md:p-10 text-center">
                        <div class="mb-8 relative">
                            <div class="text-xs text-gray-400 mb-2 uppercase font-bold tracking-widest">Từ này đọc là gì?</div>
                            <div id="quiz-kanji" class="text-6xl ja-text font-bold text-gray-800 mb-4 transition-all inline-block"></div>
                            <div id="quiz-meaning" class="text-lg text-indigo-600 font-bold mb-2"></div>
                        </div>
                        
                        <div class="relative max-w-md mx-auto mb-8">
                            <input type="text" id="quiz-input" class="w-full text-center text-2xl p-4 border-2 border-gray-300 rounded-xl focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 outline-none transition-all ja-text placeholder:text-gray-300" placeholder="nhập hiragana..." autocomplete="off">
                        </div>
                        
                        <div id="feedback-area" class="hidden rounded-xl p-5 bg-gray-50 border border-gray-200 text-left mb-6 animate-fade-in shadow-inner">
                            <div id="feedback-title" class="font-bold text-lg mb-2 flex items-center"></div>
                            <div class="text-gray-700 mb-3 flex items-center flex-wrap gap-2">
                                Đáp án đúng: <span id="correct-answer" class="font-bold text-xl text-indigo-600 px-3 py-1 bg-white border border-indigo-100 rounded-lg ja-text shadow-sm"></span>
                                <button onclick="playQuizAudio()" class="text-gray-400 hover:text-indigo-600 transition-colors w-8 h-8 rounded-full flex items-center justify-center hover:bg-gray-200 border border-transparent hover:border-gray-300"><i class="fas fa-volume-up"></i></button>
                            </div>
                        </div>
                        
                        <div>
                            <button id="btn-check" onclick="checkAnswer()" class="w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 px-10 rounded-xl shadow-lg transition active:scale-95 text-lg flex items-center justify-center gap-2 mx-auto">
                                <i class="fas fa-check"></i> Kiểm Tra
                            </button>
                            <button id="btn-next" onclick="nextQuestion()" class="hidden w-full md:w-auto bg-gray-800 hover:bg-gray-900 text-white font-bold py-3.5 px-10 rounded-xl shadow-lg transition active:scale-95 text-lg flex items-center justify-center gap-2 mx-auto">
                                Câu Tiếp Theo <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MOBILE BOTTOM BAR -->
        <div class="fixed bottom-0 left-0 right-0 glass px-4 py-3 pb-6 z-30 flex items-center justify-between gap-4 md:hidden shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] border-t border-gray-200">
            <button onclick="prevWord()" class="w-12 h-12 rounded-xl bg-white border border-gray-200 text-gray-600 flex items-center justify-center shadow-sm active:bg-gray-50 active:scale-95 transition">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button onclick="toggleDrawer()" class="flex-1 h-12 rounded-xl bg-indigo-600 text-white font-bold flex items-center justify-center shadow-lg gap-2 active:scale-95 transition active:bg-indigo-700">
                <i class="fas fa-list-ul"></i> Danh Sách
            </button>
            <button onclick="nextWord()" class="w-12 h-12 rounded-xl bg-white border border-gray-200 text-gray-600 flex items-center justify-center shadow-sm active:bg-gray-50 active:scale-95 transition">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        
        <!-- MOBILE DRAWER -->
        <div id="mobileDrawer" class="fixed inset-0 z-50 pointer-events-none flex">
            <div id="drawerBackdrop" class="absolute inset-0 bg-gray-900/50 opacity-0 transition-opacity" onclick="toggleDrawer()"></div>
            <div id="drawerContent" class="relative w-72 bg-white h-full shadow-2xl transition-transform -translate-x-full flex flex-col pointer-events-auto">
                <div class="p-4 bg-indigo-700 text-white flex justify-between items-center">
                    <h2 class="font-bold">Danh sách từ vựng</h2>
                    <button onclick="toggleDrawer()"><i class="fas fa-times"></i></button>
                </div>
                <div class="p-4 border-b border-gray-100 bg-gray-50">
                    <input type="text" id="mobileSearchInput" placeholder="Tìm kiếm nhanh..." class="w-full px-4 py-2 bg-white border border-gray-200 rounded-xl text-sm outline-none">
                </div>
                <div id="mobileVocabList" class="flex-1 overflow-y-auto scroller p-2 space-y-1"></div>
            </div>
        </div>
    </div>

    <!-- MODAL: GRAMMAR LIST -->
    <div id="grammarListModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-gray-900/70 backdrop-blur-sm transition-opacity opacity-0" id="grammarListBackdrop" onclick="closeModal('grammarListModal')"></div>
        <div class="bg-white rounded-2xl w-full max-w-4xl relative z-10 shadow-2xl transform transition-all scale-95 opacity-0 flex flex-col max-h-[85vh]" id="grammarListPanel">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-indigo-50 rounded-t-2xl">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-600 text-white p-2 rounded-lg shadow-sm"><i class="fas fa-book"></i></div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-800">Cẩm Nang Ngữ Pháp</h3>
                        <p class="text-xs text-gray-500">Thư viện ngữ pháp Day 21</p>
                    </div>
                </div>
                <button onclick="closeModal('grammarListModal')" class="w-8 h-8 rounded-full hover:bg-white flex items-center justify-center text-gray-500 transition-colors"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto scroller bg-slate-50">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="grammarGrid"></div>
            </div>
            <div class="p-4 border-t border-gray-100 bg-white rounded-b-2xl flex justify-end">
                <button onclick="closeModal('grammarListModal')" class="px-6 py-2 bg-gray-800 text-white font-bold rounded-full text-sm transition active:scale-95 shadow-lg hover:bg-gray-700">Đã Hiểu</button>
            </div>
        </div>
    </div>

    <!-- MODAL: GRAMMAR DETAIL -->
    <div id="detailGrammarModal" class="fixed inset-0 z-[90] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity opacity-0" id="detailGrammarBackdrop" onclick="closeModal('detailGrammarModal')"></div>
        <div class="bg-white rounded-2xl w-full max-w-md relative z-10 shadow-2xl transform transition-all scale-95 opacity-0 flex flex-col" id="detailGrammarPanel">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 rounded-t-2xl">
                <div class="flex items-center gap-2">
                    <div class="bg-indigo-100 p-1.5 rounded-lg text-indigo-600"><i class="fas fa-info-circle"></i></div>
                    <h3 class="text-lg font-bold text-gray-800">Giải thích Ngữ pháp</h3>
                </div>
                <button onclick="closeModal('detailGrammarModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6">
                <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-3 text-center mb-4 shadow-sm">
                    <code class="text-lg font-bold text-indigo-700 font-mono" id="dgFormula"></code>
                </div>
                <div id="dgExplanation" class="text-gray-600 text-sm mb-4 space-y-3 leading-relaxed"></div>
            </div>
        </div>
    </div>

    <!-- MODAL: KANJI STROKE -->
    <div id="strokeModal" class="fixed inset-0 z-[80] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-gray-900/80 backdrop-blur-sm transition-opacity opacity-0" id="strokeBackdrop" onclick="closeModal('strokeModal')"></div>
        <div class="bg-white rounded-2xl w-full max-w-5xl relative z-10 shadow-2xl transform transition-all scale-95 opacity-0 flex flex-col max-h-[90vh]" id="strokePanel">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-pink-50 rounded-t-2xl">
                <h3 class="text-lg font-bold text-pink-700 flex items-center gap-2"><i class="fas fa-pen-nib"></i> Tập Viết & Chi Tiết Kanji</h3>
                <button onclick="closeModal('strokeModal')" class="w-8 h-8 rounded-full hover:bg-white flex items-center justify-center text-gray-500 transition-colors"><i class="fas fa-times text-lg"></i></button>
            </div>
            <div class="p-6 overflow-y-auto scroller bg-slate-50 flex-1">
                <div id="strokeTabs" class="flex justify-center gap-2 mb-6 flex-wrap"></div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="flex flex-col gap-6 text-center">
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 relative">
                            <p class="text-xs text-gray-400 mb-2 font-bold uppercase tracking-wider">Mô phỏng nét viết</p>
                            <div id="strokeAnimContainer" class="w-48 h-48 mx-auto bg-white border border-gray-300 relative stroke-grid-box flex items-center justify-center rounded-lg cursor-pointer" onclick="replayStrokeAnimation()"></div>
                            <button onclick="replayStrokeAnimation()" class="absolute top-4 right-4 bg-pink-50 text-pink-600 w-8 h-8 rounded-full flex items-center justify-center hover:bg-pink-100 transition shadow-sm z-10"><i class="fas fa-redo text-sm"></i></button>
                            <p class="text-[10px] text-gray-400 mt-2">Nhấn vào ô để chạy lại</p>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 text-left">
                            <p class="text-xs text-gray-400 mb-3 font-bold uppercase tracking-wider text-center">Thứ tự từng nét</p>
                            <div id="strokeGridContainer" class="flex flex-wrap gap-2 justify-center"></div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200 flex flex-col h-full text-left">
                        <div id="kanjiDetailContent">
                            <div class="flex items-center justify-between mb-6 border-b border-gray-100 pb-4">
                                <div><h2 id="detailKanji" class="text-6xl font-bold text-gray-800 ja-text mb-1 leading-none"></h2><div class="text-xs font-bold bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded inline-block mt-2" id="detailHanViet"></div></div>
                                <div class="text-right"><div class="text-2xl font-bold text-gray-600 capitalize" id="detailMeaning"></div></div>
                            </div>
                            <!-- Radicals -->
                            <div class="mb-4 bg-indigo-50 p-3 rounded-lg border border-indigo-100">
                                <span class="text-xs font-bold text-indigo-500 uppercase block mb-1"><i class="fas fa-layer-group mr-1"></i> Bộ thủ (Thành phần)</span>
                                <span class="text-sm font-medium text-indigo-900" id="detailRadicals">...</span>
                            </div>
                            <!-- On/Kun -->
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <div class="bg-slate-50 p-3 rounded-lg border border-slate-100 flex justify-between items-center group cursor-pointer" onclick="document.getElementById('btnPlayOn').click()"><div class="flex flex-col"><span class="text-xs font-bold text-gray-400 uppercase">On</span><span class="text-lg font-bold text-indigo-600 ja-text" id="detailOn"></span></div><button id="btnPlayOn" class="text-indigo-300 group-hover:text-indigo-600"><i class="fas fa-volume-up"></i></button></div>
                                <div class="bg-slate-50 p-3 rounded-lg border border-slate-100 flex justify-between items-center group cursor-pointer" onclick="document.getElementById('btnPlayKun').click()"><div class="flex flex-col"><span class="text-xs font-bold text-gray-400 uppercase">Kun</span><span class="text-lg font-bold text-pink-600 ja-text" id="detailKun"></span></div><button id="btnPlayKun" class="text-pink-300 group-hover:text-pink-600"><i class="fas fa-volume-up"></i></button></div>
                            </div>
                            <!-- Tips -->
                            <div class="space-y-4 mb-6">
                                <div class="bg-green-50 p-4 rounded-lg border border-green-100">
                                    <h4 class="text-sm font-bold text-green-800 mb-2 flex items-center gap-2"><i class="fas fa-image"></i> Ghi nhớ hình ảnh</h4>
                                    <p class="text-sm text-green-700 leading-relaxed" id="detailTipImg"></p>
                                </div>
                                <div class="bg-orange-50 p-4 rounded-lg border border-orange-100">
                                    <h4 class="text-sm font-bold text-orange-800 mb-2 flex items-center gap-2"><i class="fas fa-music"></i> Mẹo nhớ âm thanh</h4>
                                    <p class="text-sm text-orange-700" id="detailTipSound"></p>
                                </div>
                            </div>
                            <!-- Related Words -->
                            <div>
                                <h4 class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-3">Từ vựng liên quan</h4>
                                <div class="space-y-2" id="detailWords"></div>
                            </div>
                        </div>
                        <div id="kanjiDetailEmpty" class="hidden h-full flex flex-col items-center justify-center text-center p-4 text-gray-400"><i class="fas fa-book-open text-4xl mb-3 opacity-30"></i><p class="text-sm">Chưa có dữ liệu chi tiết cho chữ Hán này.</p></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. GRAMMAR REPO (Day 21) ---
        const grammarRepo = {
            "ga_shimasu": { title: "Có cảm giác/mùi/vị", formula: "N + がします", desc: "Dùng cho các cảm giác thu nhận được qua 5 giác quan (trừ thị giác).", ex: "変なにおいがします。" },
            "sugimasu": { title: "Quá...", formula: "V(bỏ mas) / A / N + すぎます", desc: "Diễn tả sự vượt quá mức độ bình thường (thường mang nghĩa tiêu cực).", ex: "昨日お酒を飲みすぎました。" },
            "node": { title: "Vì/Do", formula: "Thể thường + ので", desc: "Nêu nguyên nhân, lý do một cách khách quan, nhẹ nhàng.", ex: "渋滞なので、遅れました。" },
            "no_wa": { title: "Việc (Danh từ hóa)", formula: "Vる + のは + A/N", desc: "Biến động từ thành danh từ để làm chủ ngữ.", ex: "サッカーを見るのはとても面白いです。" },
            "sou_desu": { title: "Trông có vẻ", formula: "V(bỏ mas)/A(bỏ i/na) + そうです", desc: "Phán đoán dựa trên thị giác (nhìn thấy và cảm thấy sắp xảy ra).", ex: "雨が降りそうです。" },
            "sou_desu_hearsay": { title: "Nghe nói là...", formula: "Thể thường + そうです", desc: "Truyền đạt lại thông tin nghe được từ người khác hoặc nguồn khác.", ex: "台風が来るそうです。" },
            "te_cause": { title: "Vì (Nguyên nhân)", formula: "Vて / Aくて / Nで", desc: "Chỉ nguyên nhân dẫn đến kết quả (cảm xúc, khả năng, quá khứ).", ex: "ニュースを聞いて、びっくりしました。" },
            "yasui_nikui": { title: "Dễ / Khó làm gì", formula: "V(bỏ mas) + やすい・にくい", desc: "Diễn tả tính chất dễ hoặc khó thực hiện của hành động.", ex: "この本は読みやすいです。" },
            "ni_yotte": { title: "Bởi / Do", formula: "N + によって", desc: "Chỉ chủ thể thực hiện hành động trong câu bị động (đặc biệt là sáng chế, phát minh).", ex: "このビルは有名な建築家によって設計されました。" }
        };

        // --- 2. VOCABULARY DATA (Day 21 - 87 words) ---
        const vocabData = [
            { "STT": 1, "Kanji": "整理する", "Nghĩa": "Sắp xếp", "Furigana": "せいりする", "type": "verb", "conv": { "polite": "この部屋は整理しにくいです。", "pVi": "Căn phòng này khó sắp xếp.", "casual": "この部屋は整理しにくい。", "cVi": "Phòng này khó xếp quá.", "gIds": ["yasui_nikui"] } },
            { "STT": 2, "Kanji": "冊", "Nghĩa": "Quyển (đếm sách)", "Furigana": "さつ", "type": "noun", "conv": { "polite": "この本は読みやすいです。", "pVi": "Cuốn sách này dễ đọc.", "casual": "この本、読みやすいよ。", "cVi": "Sách này dễ đọc đấy.", "gIds": ["yasui_nikui"] } },
            { "STT": 3, "Kanji": "判子", "Nghĩa": "Con dấu", "Furigana": "はんこ", "type": "noun", "conv": { "polite": "この判子は押しにくいです。", "pVi": "Con dấu này khó đóng.", "casual": "この判子、押しにくいな。", "cVi": "Con dấu này khó đóng thật.", "gIds": ["yasui_nikui"] } },
            { "STT": 4, "Kanji": "押す", "Nghĩa": "Đóng (dấu)/Ấn", "Furigana": "おす", "type": "verb", "conv": { "polite": "ボタンを押すと、音がします。", "pVi": "Khi ấn nút, có tiếng động.", "casual": "ボタン押すと音がするよ。", "cVi": "Ấn nút là có tiếng đấy.", "gIds": ["ga_shimasu"] } },
            { "STT": 5, "Kanji": "双子", "Nghĩa": "Cặp sinh đôi", "Furigana": "ふたご", "type": "noun", "conv": { "polite": "双子の赤ちゃんはとても可愛いそうです。", "pVi": "Nghe nói em bé sinh đôi rất dễ thương.", "casual": "双子の赤ちゃん、可愛いらしいよ。", "cVi": "Nghe bảo cặp sinh đôi dễ thương lắm.", "gIds": ["sou_desu_hearsay"] } },
            { "STT": 6, "Kanji": "姉妹", "Nghĩa": "Chị em gái", "Furigana": "しまい", "type": "noun", "conv": { "polite": "彼女たちは姉妹なので、よく似ています。", "pVi": "Vì họ là chị em gái nên rất giống nhau.", "casual": "彼女たち姉妹だから、似てるね。", "cVi": "Hai người đó là chị em nên giống nhau ghê.", "gIds": ["node"] } },
            { "STT": 7, "Kanji": "似ている", "Nghĩa": "Giống", "Furigana": "にている", "type": "verb", "conv": { "polite": "彼女は母親に似ているそうです。", "pVi": "Nghe nói cô ấy giống mẹ.", "casual": "彼女、母親に似てるって。", "cVi": "Nghe bảo cô ấy giống mẹ.", "gIds": ["sou_desu_hearsay"] } },
            { "STT": 8, "Kanji": "性格", "Nghĩa": "Tính cách", "Furigana": "せいかく", "type": "noun", "conv": { "polite": "彼の性格はとても優しいそうです。", "pVi": "Nghe nói tính cách của anh ấy rất hiền lành.", "casual": "彼、性格優しいらしいよ。", "cVi": "Nghe nói tính anh ấy hiền lắm.", "gIds": ["sou_desu_hearsay"] } },
            { "STT": 9, "Kanji": "大人しい", "Nghĩa": "Hiền lành/Trầm", "Furigana": "おとなしい", "type": "adj", "conv": { "polite": "彼女は大人しいので、話しやすいです。", "pVi": "Vì cô ấy trầm tính nên dễ nói chuyện.", "casual": "彼女大人しいから話しやすいよ。", "cVi": "Cổ hiền nên dễ nói chuyện.", "gIds": ["node", "yasui_nikui"] } },
            { "STT": 10, "Kanji": "世話をする", "Nghĩa": "Chăm sóc", "Furigana": "せわをする", "type": "verb", "conv": { "polite": "子供の世話をするのは大変です。", "pVi": "Việc chăm sóc con cái rất vất vả.", "casual": "子供の世話って大変だよね。", "cVi": "Chăm con mệt thật đấy.", "gIds": ["no_wa"] } },
            { "STT": 11, "Kanji": "時間が経つ", "Nghĩa": "Thời gian trôi", "Furigana": "じかんがたつ", "type": "phrase", "conv": { "polite": "時間が経つのは早いですね。", "pVi": "Thời gian trôi qua nhanh thật nhỉ.", "casual": "時間経つの早いね。", "cVi": "Thời gian trôi nhanh ha.", "gIds": ["no_wa"] } },
            { "STT": 12, "Kanji": "大好き", "Nghĩa": "Rất thích", "Furigana": "だいすき", "type": "adj", "conv": { "polite": "私はアニメが大好きなので、毎日見ています。", "pVi": "Vì tôi rất thích anime nên xem mỗi ngày.", "casual": "アニメ大好きだから毎日見てる。", "cVi": "Tớ mê anime nên ngày nào cũng xem.", "gIds": ["node"] } },
            { "STT": 13, "Kanji": "点", "Nghĩa": "Điểm", "Furigana": "てん", "type": "noun", "conv": { "polite": "試験の点数が悪くて、がっかりしました。", "pVi": "Vì điểm thi kém nên tôi đã thất vọng.", "casual": "点数悪くてがっかりだよ。", "cVi": "Điểm thấp chán quá.", "gIds": ["te_cause"] } },
            { "STT": 14, "Kanji": "喧嘩する", "Nghĩa": "Cãi nhau", "Furigana": "けんかする", "type": "verb", "conv": { "polite": "友達と喧嘩したので、悲しいです。", "pVi": "Vì cãi nhau với bạn nên tôi buồn.", "casual": "友達と喧嘩して悲しい。", "cVi": "Cãi nhau với bạn buồn ghê.", "gIds": ["node"] } },
            { "STT": 15, "Kanji": "不思議", "Nghĩa": "Kì lạ/Bí ẩn", "Furigana": "ふしぎ", "type": "adj", "conv": { "polite": "この場所は不思議なところなので、人気があります。", "pVi": "Vì nơi này là một nơi kỳ lạ nên được yêu thích.", "casual": "ここ不思議な場所だから人気あるんだ。", "cVi": "Chỗ này lạ nên hot lắm.", "gIds": ["node"] } },
            { "STT": 16, "Kanji": "答える", "Nghĩa": "Trả lời", "Furigana": "こたえる", "type": "verb", "conv": { "polite": "質問に答えるのは難しいです。", "pVi": "Việc trả lời câu hỏi rất khó.", "casual": "質問答えるの難しいよ。", "cVi": "Trả lời câu hỏi khó thật.", "gIds": ["no_wa"] } },
            { "STT": 17, "Kanji": "倒れる", "Nghĩa": "Đổ/Ngã", "Furigana": "たおれる", "type": "verb", "conv": { "polite": "木が倒れそうです。", "pVi": "Cây có vẻ sắp đổ.", "casual": "木が倒れそう！", "cVi": "Cây sắp đổ kìa!", "gIds": ["sou_desu"] } },
            { "STT": 18, "Kanji": "焼ける", "Nghĩa": "Cháy/Nướng", "Furigana": "やける", "type": "verb", "conv": { "polite": "パンが焼けそうです。", "pVi": "Bánh mì có vẻ sắp cháy/chín.", "casual": "パン焼けそうだよ。", "cVi": "Bánh sắp được rồi đấy.", "gIds": ["sou_desu"] } },
            { "STT": 19, "Kanji": "通る", "Nghĩa": "Đi qua", "Furigana": "とおる", "type": "verb", "conv": { "polite": "この道は車が通りやすいです。", "pVi": "Con đường này ô tô dễ đi qua.", "casual": "ここ車通りやすいね。", "cVi": "Đường này dễ đi xe ha.", "gIds": ["yasui_nikui"] } },
            { "STT": 20, "Kanji": "死ぬ", "Nghĩa": "Chết", "Furigana": "しぬ", "type": "verb", "conv": { "polite": "彼は病気で死んだそうです。", "pVi": "Nghe nói anh ấy đã mất vì bệnh.", "casual": "彼、病気で亡くなったって。", "cVi": "Nghe nói anh ấy mất do bệnh.", "gIds": ["sou_desu_hearsay"] } },
            { "STT": 21, "Kanji": "びっくりする", "Nghĩa": "Ngạc nhiên", "Furigana": "びっくりする", "type": "verb", "conv": { "polite": "ニュースを聞いて、びっくりしました。", "pVi": "Vì nghe tin tức nên tôi đã ngạc nhiên.", "casual": "ニュース聞いてびっくりしたよ。", "cVi": "Nghe tin mà hết hồn.", "gIds": ["te_cause"] } },
            { "STT": 22, "Kanji": "がっかりする", "Nghĩa": "Thất vọng", "Furigana": "がっかりする", "type": "verb", "conv": { "polite": "試験に失敗して、がっかりしました。", "pVi": "Vì thi trượt nên tôi đã thất vọng.", "casual": "試験ダメでがっかり。", "cVi": "Thi trượt chán quá.", "gIds": ["te_cause"] } },
            { "STT": 23, "Kanji": "安心する", "Nghĩa": "Yên tâm", "Furigana": "あんしんする", "type": "verb", "conv": { "polite": "連絡が来て、安心しました。", "pVi": "Vì có liên lạc đến nên tôi đã yên tâm.", "casual": "連絡来て安心した。", "cVi": "Có tin nhắn là yên tâm rồi.", "gIds": ["te_cause"] } },
            { "STT": 24, "Kanji": "遅刻する", "Nghĩa": "Đến muộn", "Furigana": "ちこくする", "type": "verb", "conv": { "polite": "交通渋滞なので、遅刻しそうです。", "pVi": "Vì tắc đường nên có vẻ sẽ đến muộn.", "casual": "渋滞だから遅刻しそう。", "cVi": "Tắc đường chắc đến muộn quá.", "gIds": ["node", "sou_desu"] } },
            { "STT": 25, "Kanji": "早退する", "Nghĩa": "Về sớm", "Furigana": "そうたいする", "type": "verb", "conv": { "polite": "体調が悪いので、早退しそうです。", "pVi": "Vì sức khỏe không tốt nên có vẻ sẽ về sớm.", "casual": "具合悪いから早退しそう。", "cVi": "Mệt quá chắc về sớm thôi.", "gIds": ["node", "sou_desu"] } },
            { "STT": 26, "Kanji": "離婚する", "Nghĩa": "Ly hôn", "Furigana": "りこんする", "type": "verb", "conv": { "polite": "彼女は離婚したそうです。", "pVi": "Nghe nói cô ấy đã ly hôn.", "casual": "彼女離婚したらしいよ。", "cVi": "Nghe bảo cổ ly hôn rồi.", "gIds": ["sou_desu_hearsay"] } },
            { "STT": 27, "Kanji": "複雑", "Nghĩa": "Phức tạp", "Furigana": "ふくざつ", "type": "adj", "conv": { "polite": "この問題は複雑なので、解きにくいです。", "pVi": "Vấn đề này phức tạp nên khó giải quyết.", "casual": "これ複雑で解きにくいな。", "cVi": "Cái này phức tạp khó giải quá.", "gIds": ["node", "yasui_nikui"] } },
            { "STT": 28, "Kanji": "邪魔", "Nghĩa": "Phiền hà/Cản trở", "Furigana": "じゃま", "type": "adj", "conv": { "polite": "邪魔なものがあるので、どけてください。", "pVi": "Vì có vật cản nên xin hãy dẹp đi.", "casual": "邪魔なのがあるからどけて。", "cVi": "Vướng quá, dẹp hộ cái.", "gIds": ["node"] } },
            { "STT": 29, "Kanji": "汚い", "Nghĩa": "Bẩn", "Furigana": "きたない", "type": "adj", "conv": { "polite": "部屋が汚いので、掃除しにくいです。", "pVi": "Vì phòng bẩn nên khó dọn dẹp.", "casual": "部屋汚くて掃除しにくいよ。", "cVi": "Phòng bẩn quá khó dọn ghê.", "gIds": ["node", "yasui_nikui"] } },
            { "STT": 30, "Kanji": "嬉しい", "Nghĩa": "Vui sướng", "Furigana": "うれしい", "type": "adj", "conv": { "polite": "嬉しいニュースを聞いて、嬉しかったです。", "pVi": "Nghe tin vui, tôi đã rất vui.", "casual": "いいニュース聞いて嬉しい！", "cVi": "Nghe tin vui sướng quá!", "gIds": ["te_cause"] } },
            { "STT": 31, "Kanji": "悲しい", "Nghĩa": "Buồn", "Furigana": "かなしい", "type": "adj", "conv": { "polite": "悲しい映画を見て、泣きました。", "pVi": "Xem phim buồn, tôi đã khóc.", "casual": "悲しい映画見て泣いちゃった。", "cVi": "Xem phim buồn khóc hết nước mắt.", "gIds": ["te_cause"] } },
            { "STT": 32, "Kanji": "恥ずかしい", "Nghĩa": "Xấu hổ", "Furigana": "はずかしい", "type": "adj", "conv": { "polite": "失敗して、恥ずかしかったです。", "pVi": "Thất bại, tôi đã xấu hổ.", "casual": "失敗して恥ずかしかったー。", "cVi": "Fail quá, ngại ghê.", "gIds": ["te_cause"] } },
            { "STT": 33, "Kanji": "地震", "Nghĩa": "Động đất", "Furigana": "じしん", "type": "noun", "conv": { "polite": "地震が起きそうです。", "pVi": "Có vẻ sắp có động đất.", "casual": "地震起きそう！", "cVi": "Sắp động đất hay sao ấy!", "gIds": ["sou_desu"] } },
            { "STT": 34, "Kanji": "台風", "Nghĩa": "Bão", "Furigana": "たいふう", "type": "noun", "conv": { "polite": "台風が来るそうです。", "pVi": "Nghe nói bão sẽ đến.", "casual": "台風来るらしいよ。", "cVi": "Nghe bảo bão về đấy.", "gIds": ["sou_desu_hearsay"] } },
            { "STT": 35, "Kanji": "火事", "Nghĩa": "Hỏa hoạn", "Furigana": "かじ", "type": "noun", "conv": { "polite": "火事があったそうです。", "pVi": "Nghe nói đã có hỏa hoạn.", "casual": "火事あったんだって。", "cVi": "Nghe bảo cháy nhà kìa.", "gIds": ["sou_desu_hearsay"] } },
            { "STT": 36, "Kanji": "事故", "Nghĩa": "Tai nạn", "Furigana": "じこ", "type": "noun", "conv": { "polite": "事故が起きやすい場所です。", "pVi": "Đây là nơi dễ xảy ra tai nạn.", "casual": "ここ事故起きやすいよ。", "cVi": "Chỗ này dễ tai nạn lắm.", "gIds": ["yasui_nikui"] } },
            { "STT": 37, "Kanji": "お見合い", "Nghĩa": "Xem mắt", "Furigana": "おみあい", "type": "noun", "conv": { "polite": "お見合いをするそうです。", "pVi": "Nghe nói sẽ đi xem mắt.", "casual": "お見合いするらしいよ。", "cVi": "Nghe bảo đi xem mắt đấy.", "gIds": ["sou_desu_hearsay"] } },
            { "STT": 38, "Kanji": "電話代", "Nghĩa": "Tiền điện thoại", "Furigana": "でんわだい", "type": "noun", "conv": { "polite": "電話代が高いそうです。", "pVi": "Nghe nói tiền điện thoại đắt.", "casual": "電話代高いって。", "cVi": "Tiền điện thoại đắt lòi.", "gIds": ["sou_desu_hearsay"] } },
            { "STT": 39, "Kanji": "〜号室", "Nghĩa": "Phòng số ~", "Furigana": "ごうしつ", "type": "suffix", "conv": { "polite": "301号室は空いているそうです。", "pVi": "Nghe nói phòng 301 đang trống.", "casual": "301号室空いてるらしい。", "cVi": "Phòng 301 trống đấy.", "gIds": ["sou_desu_hearsay"] } },
            { "STT": 40, "Kanji": "汗", "Nghĩa": "Mồ hôi", "Furigana": "あせ", "type": "noun", "conv": { "polite": "汗がたくさん出そうです。", "pVi": "Có vẻ sẽ đổ nhiều mồ hôi.", "casual": "汗めっちゃ出そう。", "cVi": "Chắc toát mồ hôi hột quá.", "gIds": ["sou_desu"] } },
            { "STT": 41, "Kanji": "石鹸", "Nghĩa": "Xà phòng", "Furigana": "せっけん", "type": "noun", "conv": { "polite": "この石鹸は使いやすいです。", "pVi": "Xà phòng này dễ dùng.", "casual": "この石鹸使いやすいよ。", "cVi": "Xà bông này dễ dùng này.", "gIds": ["yasui_nikui"] } },
            { "STT": 42, "Kanji": "大勢", "Nghĩa": "Nhiều người", "Furigana": "おおぜい", "type": "noun", "conv": { "polite": "大勢の人が集まりそうです。", "pVi": "Có vẻ sẽ có nhiều người tập trung.", "casual": "大勢集まりそうだな。", "cVi": "Chắc đông người lắm đây.", "gIds": ["sou_desu"] } },
            { "STT": 43, "Kanji": "お疲れ様", "Nghĩa": "Vất vả rồi (Chào)", "Furigana": "おつかれさま", "type": "phrase", "conv": { "polite": "仕事が終わって、お疲れ様でした。", "pVi": "Công việc kết thúc, cảm ơn bạn đã vất vả.", "casual": "お疲れー。", "cVi": "Vất vả rồi nhé.", "gIds": ["te_cause"] } },
            { "STT": 44, "Kanji": "伺います", "Nghĩa": "Đến thăm (Khiêm nhường)", "Furigana": "うかがいます", "type": "verb", "conv": { "polite": "先生の家へ伺うのは緊張します。", "pVi": "Việc đến thăm nhà giáo viên rất căng thẳng.", "casual": "先生んち伺うの緊張する。", "cVi": "Đến nhà thầy run quá.", "gIds": ["no_wa"] } },
            { "STT": 45, "Kanji": "途中で", "Nghĩa": "Giữa đường", "Furigana": "とちゅうで", "type": "adv", "conv": { "polite": "途中で事故があったそうです。", "pVi": "Nghe nói có tai nạn giữa đường.", "casual": "途中で事故あったって。", "cVi": "Nghe bảo có tai nạn giữa đường.", "gIds": ["sou_desu_hearsay"] } },
            { "STT": 46, "Kanji": "ぶつかる", "Nghĩa": "Đâm/Va chạm", "Furigana": "ぶつかる", "type": "verb", "conv": { "polite": "車にぶつかって、怪我しました。", "pVi": "Bị xe đâm, tôi đã bị thương.", "casual": "車にぶつかって怪我した。", "cVi": "Bị xe tông bị thương rồi.", "gIds": ["te_cause"] } },
            { "STT": 47, "Kanji": "並ぶ", "Nghĩa": "Xếp hàng", "Furigana": "ならぶ", "type": "verb", "conv": { "polite": "レストランで並ぶのは時間がかかります。", "pVi": "Việc xếp hàng ở nhà hàng tốn thời gian.", "casual": "並ぶの時間かかるよね。", "cVi": "Xếp hàng tốn thời gian quá.", "gIds": ["no_wa"] } },
            { "STT": 48, "Kanji": "大人", "Nghĩa": "Người lớn", "Furigana": "おとな", "type": "noun", "conv": { "polite": "大人は子供より背が高いそうです。", "pVi": "Nghe nói người lớn cao hơn trẻ con.", "casual": "大人は背高いらしいよ。", "cVi": "Người lớn thì cao hơn mà.", "gIds": ["sou_desu_hearsay"] } },
            { "STT": 49, "Kanji": "洋服", "Nghĩa": "Quần áo Tây", "Furigana": "ようふく", "type": "noun", "conv": { "polite": "この洋服は洗いにくいです。", "pVi": "Bộ quần áo này khó giặt.", "casual": "この服洗いにくいな。", "cVi": "Bộ này khó giặt thật.", "gIds": ["yasui_nikui"] } },
            { "STT": 50, "Kanji": "西洋化", "Nghĩa": "Tây Âu hóa", "Furigana": "せいようか", "type": "noun", "conv": { "polite": "日本は西洋化しているそうです。", "pVi": "Nghe nói Nhật Bản đang Tây Âu hóa.", "casual": "日本も西洋化してるらしい。", "cVi": "Nhật cũng Tây hóa rồi.", "gIds": ["sou_desu_hearsay"] } },
            { "STT": 51, "Kanji": "合う", "Nghĩa": "Vừa/Hợp", "Furigana": "あう", "type": "verb", "conv": { "polite": "この服は私に合うそうです。", "pVi": "Nghe nói bộ quần áo này hợp với tôi.", "casual": "これ私に合うって。", "cVi": "Cái này hợp với tớ đấy.", "gIds": ["sou_desu_hearsay"] } },
            { "STT": 52, "Kanji": "今では", "Nghĩa": "Bây giờ thì", "Furigana": "いまでは", "type": "adv", "conv": { "polite": "今ではパソコンはとても便利になりました。", "pVi": "Bây giờ thì máy tính đã trở nên rất tiện lợi.", "casual": "今じゃパソコン便利だよね。", "cVi": "Giờ máy tính tiện ghê.", "gIds": [] } },
            { "STT": 53, "Kanji": "成人式", "Nghĩa": "Lễ trưởng thành", "Furigana": "せいじんしき", "type": "noun", "conv": { "polite": "成人式は来年だそうです。", "pVi": "Nghe nói lễ trưởng thành là vào năm sau.", "casual": "成人式来年だって。", "cVi": "Lễ trưởng thành là năm sau đấy.", "gIds": ["sou_desu_hearsay"] } },
            { "STT": 54, "Kanji": "数える", "Nghĩa": "Đếm", "Furigana": "かぞえる", "type": "verb", "conv": { "polite": "お金を数えるのは簡単です。", "pVi": "Việc đếm tiền rất dễ.", "casual": "お金数えるの簡単だよ。", "cVi": "Đếm tiền dễ ợt.", "gIds": ["no_wa"] } },
            { "STT": 55, "Kanji": "測る", "Nghĩa": "Đo/Cân", "Furigana": "はかる", "type": "verb", "conv": { "polite": "体重を測るのは健康にいいです。", "pVi": "Việc cân nặng tốt cho sức khỏe.", "casual": "体重測るの健康にいいよ。", "cVi": "Cân thường xuyên tốt đấy.", "gIds": ["no_wa"] } },
            { "STT": 56, "Kanji": "確かめる", "Nghĩa": "Xác nhận", "Furigana": "たしかめる", "type": "verb", "conv": { "polite": "情報を確かめるのは大切です。", "pVi": "Việc xác nhận thông tin rất quan trọng.", "casual": "確かめるの大事だよ。", "cVi": "Check lại quan trọng lắm.", "gIds": ["no_wa"] } },
            { "STT": 57, "Kanji": "似合う", "Nghĩa": "Hợp (thời trang)", "Furigana": "にあう", "type": "verb", "conv": { "polite": "この帽子はあなたに似合うそうです。", "pVi": "Nghe nói chiếc mũ này hợp với bạn.", "casual": "その帽子似合うって。", "cVi": "Mũ đó hợp với cậu đấy.", "gIds": ["sou_desu_hearsay"] } },
            { "STT": 58, "Kanji": "出発する", "Nghĩa": "Xuất phát", "Furigana": "しゅっぱつする", "type": "verb", "conv": { "polite": "彼はもうすぐ出発するそうです。", "pVi": "Nghe nói anh ấy sắp xuất phát rồi.", "casual": "彼もうすぐ出発するらしい。", "cVi": "Hắn sắp đi rồi đấy.", "gIds": ["sou_desu_hearsay"] } },
            { "STT": 59, "Kanji": "到着する", "Nghĩa": "Đến nơi", "Furigana": "とうちゃくする", "type": "verb", "conv": { "polite": "電車はもうすぐ駅に到着するそうです。", "pVi": "Nghe nói tàu sắp đến ga rồi.", "casual": "電車もうすぐ着くって。", "cVi": "Tàu sắp tới rồi.", "gIds": ["sou_desu_hearsay"] } },
            { "STT": 60, "Kanji": "酔う", "Nghĩa": "Say", "Furigana": "よう", "type": "verb", "conv": { "polite": "お酒を飲みすぎると、酔いやすいです。", "pVi": "Nếu uống quá nhiều rượu, dễ say.", "casual": "飲みすぎると酔いやすいよ。", "cVi": "Uống lắm dễ say lắm.", "gIds": ["sugimasu", "yasui_nikui"] } },
            { "STT": 61, "Kanji": "危険", "Nghĩa": "Nguy hiểm", "Furigana": "きけん", "type": "adj", "conv": { "polite": "この場所は危険なので、近づかないほうがいいです。", "pVi": "Vì nơi này nguy hiểm nên không nên đến gần.", "casual": "ここ危険だから近づかないで。", "cVi": "Chỗ này nguy hiểm đừng lại gần.", "gIds": ["node"] } },
            { "STT": 62, "Kanji": "必要", "Nghĩa": "Cần thiết", "Furigana": "ひつよう", "type": "adj", "conv": { "polite": "必要なものは買っておきましょう。", "pVi": "Hãy mua sẵn những thứ cần thiết.", "casual": "必要なもの買っとこう。", "cVi": "Mua đồ cần thiết đi.", "gIds": [] } },
            { "STT": 63, "Kanji": "会議", "Nghĩa": "Hội nghị/Họp", "Furigana": "かいぎ", "type": "noun", "conv": { "polite": "会議はもう終わったそうです。", "pVi": "Nghe nói cuộc họp đã kết thúc rồi.", "casual": "会議終わったらしいよ。", "cVi": "Họp xong rồi đấy.", "gIds": ["sou_desu_hearsay"] } },
            { "STT": 64, "Kanji": "会場", "Nghĩa": "Hội trường", "Furigana": "かいじょう", "type": "noun", "conv": { "polite": "会場は広いそうです。", "pVi": "Nghe nói hội trường rộng.", "casual": "会場広いって。", "cVi": "Hội trường rộng lắm.", "gIds": ["sou_desu_hearsay"] } },
            { "STT": 65, "Kanji": "二次会", "Nghĩa": "Tăng hai", "Furigana": "にじかい", "type": "noun", "conv": { "polite": "二次会は楽しいそうです。", "pVi": "Nghe nói tăng hai vui.", "casual": "二次会楽しいらしいよ。", "cVi": "Tăng hai vui lắm đấy.", "gIds": ["sou_desu_hearsay"] } },
            { "STT": 66, "Kanji": "大会", "Nghĩa": "Đại hội/Thi đấu", "Furigana": "たいかい", "type": "noun", "conv": { "polite": "大会で優勝するのは難しいです。", "pVi": "Việc vô địch đại hội rất khó.", "casual": "優勝するの難しいよ。", "cVi": "Vô địch khó lắm.", "gIds": ["no_wa"] } },
            { "STT": 67, "Kanji": "表", "Nghĩa": "Mặt trước", "Furigana": "おもて", "type": "noun", "conv": { "polite": "表に名前が書いてあるそうです。", "pVi": "Nghe nói tên được viết ở mặt trước.", "casual": "表に名前あるって。", "cVi": "Tên viết ở mặt trước kìa.", "gIds": ["sou_desu_hearsay"] } },
            { "STT": 68, "Kanji": "裏", "Nghĩa": "Mặt sau", "Furigana": "うら", "type": "noun", "conv": { "polite": "裏に何も書いてないそうです。", "pVi": "Nghe nói mặt sau không viết gì cả.", "casual": "裏何も書いてないらしい。", "cVi": "Mặt sau chả có gì đâu.", "gIds": ["sou_desu_hearsay"] } },
            { "STT": 69, "Kanji": "返事", "Nghĩa": "Hồi âm", "Furigana": "へんじ", "type": "noun", "conv": { "polite": "返事を書くのは時間がかかります。", "pVi": "Việc viết thư trả lời tốn thời gian.", "casual": "返事書くの時間かかる。", "cVi": "Viết hồi âm lâu quá.", "gIds": ["no_wa"] } },
            { "STT": 70, "Kanji": "米", "Nghĩa": "Gạo", "Furigana": "こめ", "type": "noun", "conv": { "polite": "米は日本でたくさん作られているそうです。", "pVi": "Nghe nói gạo được sản xuất rất nhiều ở Nhật Bản.", "casual": "米、日本でいっぱい作ってるって。", "cVi": "Gạo Nhật trồng nhiều lắm.", "gIds": ["sou_desu_hearsay"] } },
            { "STT": 71, "Kanji": "麦", "Nghĩa": "Lúa mạch", "Furigana": "むぎ", "type": "noun", "conv": { "polite": "麦はパンを作るのに使われるそうです。", "pVi": "Nghe nói lúa mạch được dùng để làm bánh mì.", "casual": "麦ってパンに使うらしいよ。", "cVi": "Lúa mạch làm bánh mì đấy.", "gIds": ["sou_desu_hearsay"] } },
            { "STT": 72, "Kanji": "石油", "Nghĩa": "Dầu mỏ", "Furigana": "せきゆ", "type": "noun", "conv": { "polite": "石油の値段は上がるそうです。", "pVi": "Nghe nói giá dầu mỏ sẽ tăng.", "casual": "石油の値段上がるって。", "cVi": "Giá dầu sắp tăng đấy.", "gIds": ["sou_desu_hearsay"] } },
            { "STT": 73, "Kanji": "原料", "Nghĩa": "Nguyên liệu", "Furigana": "げんりょう", "type": "noun", "conv": { "polite": "この製品はどんな原料によって作られているそうですか。", "pVi": "Nghe nói sản phẩm này được làm từ loại nguyên liệu nào?", "casual": "これ何の原料で作ってるの？", "cVi": "Cái này làm từ gì thế?", "gIds": ["ni_yotte", "sou_desu_hearsay"] } },
            { "STT": 74, "Kanji": "泥棒", "Nghĩa": "Kẻ trộm", "Furigana": "どろぼう", "type": "noun", "conv": { "polite": "泥棒は警察に捕まえられたそうです。", "pVi": "Nghe nói kẻ trộm đã bị cảnh sát bắt.", "casual": "泥棒捕まったらしいよ。", "cVi": "Trộm bị tóm rồi.", "gIds": ["sou_desu_hearsay"] } },
            { "STT": 75, "Kanji": "警官", "Nghĩa": "Cảnh sát", "Furigana": "けいかん", "type": "noun", "conv": { "polite": "彼は警官になったそうです。", "pVi": "Nghe nói anh ấy đã trở thành cảnh sát.", "casual": "彼、警官になったって。", "cVi": "Nó làm cảnh sát rồi đấy.", "gIds": ["sou_desu_hearsay"] } },
            { "STT": 76, "Kanji": "建築家", "Nghĩa": "Kiến trúc sư", "Furigana": "けんちくか", "type": "noun", "conv": { "polite": "このビルは有名な建築家によって設計されたそうです。", "pVi": "Nghe nói tòa nhà này được thiết kế bởi một kiến trúc sư nổi tiếng.", "casual": "ここ有名な建築家が作ったらしいよ。", "cVi": "Nhà này kiến trúc sư xịn làm đấy.", "gIds": ["ni_yotte", "sou_desu_hearsay"] } },
            { "STT": 77, "Kanji": "科学者", "Nghĩa": "Nhà khoa học", "Furigana": "かがくしゃ", "type": "noun", "conv": { "polite": "科学者は新しい発見をしたそうです。", "pVi": "Nghe nói nhà khoa học đã có phát hiện mới.", "casual": "科学者が新発見したって。", "cVi": "Mấy ổng phát hiện cái mới rồi.", "gIds": ["sou_desu_hearsay"] } },
            { "STT": 78, "Kanji": "世界中", "Nghĩa": "Khắp thế giới", "Furigana": "せかいじゅう", "type": "noun", "conv": { "polite": "日本語は世界中で使われているそうです。", "pVi": "Nghe nói tiếng Nhật đang được sử dụng trên toàn thế giới.", "casual": "日本語、世界中で使われてるらしい。", "cVi": "Tiếng Nhật giờ dùng khắp nơi.", "gIds": ["sou_desu_hearsay"] } },
            { "STT": 79, "Kanji": "〜によって", "Nghĩa": "Do/Bởi", "Furigana": "によって", "type": "phrase", "conv": { "polite": "この歌は有名な歌手によって歌われているそうです。", "pVi": "Nghe nói bài hát này được hát bởi một ca sĩ nổi tiếng.", "casual": "この歌、有名な歌手が歌ってるって。", "cVi": "Bài này ca sĩ nổi tiếng hát đấy.", "gIds": ["ni_yotte", "sou_desu_hearsay"] } },
            { "STT": 80, "Kanji": "埋め立てる", "Nghĩa": "Lấp (biển)", "Furigana": "うめたてる", "type": "verb", "conv": { "polite": "海を埋め立てるのは大変だそうです。", "pVi": "Nghe nói việc lấp biển rất vất vả.", "casual": "埋め立てるの大変らしいよ。", "cVi": "Lấp biển cực lắm.", "gIds": ["no_wa", "sou_desu_hearsay"] } },
            { "STT": 81, "Kanji": "技術", "Nghĩa": "Kỹ thuật", "Furigana": "ぎじゅつ", "type": "noun", "conv": { "polite": "日本の技術は世界中で使われているそうです。", "pVi": "Nghe nói kỹ thuật của Nhật Bản đang được sử dụng trên toàn thế giới.", "casual": "日本の技術すごいらしいよ。", "cVi": "Kỹ thuật Nhật xịn lắm.", "gIds": ["sou_desu_hearsay"] } },
            { "STT": 82, "Kanji": "土地", "Nghĩa": "Đất đai", "Furigana": "とち", "type": "noun", "conv": { "polite": "土地を買うのはお金がかかるそうです。", "pVi": "Nghe nói việc mua đất tốn tiền.", "casual": "土地買うの高いって。", "cVi": "Mua đất tốn kém lắm.", "gIds": ["no_wa", "sou_desu_hearsay"] } },
            { "STT": 83, "Kanji": "騒音", "Nghĩa": "Tiếng ồn", "Furigana": "そうおん", "type": "noun", "conv": { "polite": "騒音は健康に悪いそうです。", "pVi": "Nghe nói tiếng ồn không tốt cho sức khỏe.", "casual": "騒音って体に悪いらしい。", "cVi": "Ồn ào hại sức khỏe lắm.", "gIds": ["sou_desu_hearsay"] } },
            { "STT": 84, "Kanji": "使用する", "Nghĩa": "Sử dụng", "Furigana": "しようする", "type": "verb", "conv": { "polite": "この機械は誰でも使用できるそうです。", "pVi": "Nghe nói máy này ai cũng có thể sử dụng.", "casual": "これ誰でも使えるって。", "cVi": "Cái này ai cũng dùng được.", "gIds": ["sou_desu_hearsay"] } },
            { "STT": 85, "Kanji": "世間", "Nghĩa": "Thế gian", "Furigana": "せけん", "type": "noun", "conv": { "polite": "世間の話は面白いそうです。", "pVi": "Nghe nói chuyện thế gian thú vị.", "casual": "世間の話面白いって。", "cVi": "Chuyện thiên hạ vui lắm.", "gIds": ["sou_desu_hearsay"] } },
            { "STT": 86, "Kanji": "豪華", "Nghĩa": "Hào hoa/Sang trọng", "Furigana": "ごうか", "type": "adj", "conv": { "polite": "豪華なホテルに泊まったそうです。", "pVi": "Nghe nói đã ở khách sạn sang trọng.", "casual": "豪華なホテル泊まったらしいよ。", "cVi": "Ở khách sạn xịn sò lắm.", "gIds": ["sou_desu_hearsay"] } },
            { "STT": 87, "Kanji": "彫刻", "Nghĩa": "Điêu khắc", "Furigana": "ちょうこく", "type": "noun", "conv": { "polite": "彫刻は美しいそうです。", "pVi": "Nghe nói tác phẩm điêu khắc đẹp.", "casual": "彫刻きれいらしいよ。", "cVi": "Điêu khắc đẹp lắm.", "gIds": ["sou_desu_hearsay"] } }
        ];

        // --- 3. KANJI DETAILS (Updated for Day 21) ---
        const kanjiDetails = {
            "整": { hanviet: "CHỈNH", mean: "Sắp xếp", on: "セイ", kun: "ととの.う", radicals: "Phốc (攴)", tipImg: "Chỉnh đốn bó lúa.", tipSoundOn: "**Sei**ri chỉnh lý.", tipSoundKun: "**Totono**u được sắp xếp.", words: [{w:"整理 (せいり)", m:"Sắp xếp"}, {w:"調整 (ちょうせい)", m:"Điều chỉnh"}] },
            "理": { hanviet: "LÝ", mean: "Lý lẽ", on: "リ", kun: "", radicals: "Ngọc (王) + Lý (里)", tipImg: "Vua (王) cai quản làng (里) có lý lẽ.", tipSoundOn: "**Ri**yuu lý do.", words: [{w:"整理 (せいり)", m:"Sắp xếp"}, {w:"理由 (りゆう)", m:"Lý do"}] },
            "冊": { hanviet: "SÁCH", mean: "Quyển sách", on: "サツ", kun: "", radicals: "Quynh (冂)", tipImg: "Hình ảnh các thanh tre ghép lại thành sách.", tipSoundOn: "Issatsu một quyển.", words: [{w:"一冊 (いっさつ)", m:"Một quyển"}] },
            "判": { hanviet: "PHÁN", mean: "Phán đoán/Con dấu", on: "ハン, バン", kun: "", radicals: "Đao (刂)", tipImg: "Dùng dao (刂) chia đôi (半) để phán xét.", tipSoundOn: "**Han**ko con dấu.", words: [{w:"判子 (はんこ)", m:"Con dấu"}, {w:"判断 (はんだん)", m:"Phán đoán"}] },
            "押": { hanviet: "ÁP", mean: "Ấn/Đẩy", on: "オウ", kun: "お.す", radicals: "Thủ (扌) + Giáp (甲)", tipImg: "Tay (扌) ấn lên cái khiên (甲).", tipSoundOn: "", tipSoundKun: "**O**su ấn.", words: [{w:"押す (おす)", m:"Ấn/Đẩy"}, {w:"押入れ (おしいれ)", m:"Tủ âm tường"}] },
            "双": { hanviet: "SONG", mean: "Đôi/Cặp", on: "ソウ", kun: "ふた", radicals: "Hựu (又)", tipImg: "Hai bàn tay (又) là một đôi.", tipSoundOn: "", tipSoundKun: "**Futa**go sinh đôi.", words: [{w:"双子 (ふたご)", m:"Sinh đôi"}] },
            "姉": { hanviet: "TỶ", mean: "Chị gái", on: "シ", kun: "あね", radicals: "Nữ (女) + Thị (市)", tipImg: "Người con gái (女) đi chợ (市) là chị.", tipSoundOn: "**Shi**mai chị em.", tipSoundKun: "**Ane** chị tôi.", words: [{w:"姉妹 (しまい)", m:"Chị em"}, {w:"お姉さん (おねえさん)", m:"Chị (người khác)"}] },
            "妹": { hanviet: "MUỘI", mean: "Em gái", on: "マイ", kun: "いもうと", radicals: "Nữ (女) + Vị (未)", tipImg: "Cô gái (女) chưa (未) lớn là em.", tipSoundOn: "Shi**mai** chị em.", tipSoundKun: "**Imouto** em gái.", words: [{w:"妹 (いもうと)", m:"Em gái"}] },
            "似": { hanviet: "TỰ", mean: "Giống", on: "ジ", kun: "に.る", radicals: "Nhân (亻) + Dĩ (以)", tipImg: "Người (亻) dùng (以) làm mẫu để giống.", tipSoundOn: "", tipSoundKun: "**Ni**ru giống.", words: [{w:"似る (にる)", m:"Giống"}, {w:"似合う (にあう)", m:"Hợp"}] },
            "性": { hanviet: "TÍNH", mean: "Tính cách/Giới tính", on: "セイ, ショウ", kun: "", radicals: "Tâm (忄) + Sinh (生)", tipImg: "Tâm (忄) sinh (生) ra tính cách.", tipSoundOn: "**Sei**kaku tính cách.", words: [{w:"性格 (せいかく)", m:"Tính cách"}, {w:"男性 (だんせい)", m:"Nam giới"}] },
            "格": { hanviet: "CÁCH", mean: "Tư cách/Hạng", on: "カク", kun: "", radicals: "Mộc (木) + Các (各)", tipImg: "Mỗi (各) cây (木) đều có cốt cách riêng.", tipSoundOn: "Sei**kaku** tính cách.", words: [{w:"合格 (ごうかく)", m:"Thi đậu"}] },
            "答": { hanviet: "ĐÁP", mean: "Trả lời", on: "トウ", kun: "こた.える", radicals: "Trúc (竹) + Hợp (合)", tipImg: "Trúc (竹) hợp (合) lại làm giấy để đáp lời.", tipSoundOn: "Kai**tou** giải đáp.", tipSoundKun: "**Kota**eru trả lời.", words: [{w:"答える (こたえる)", m:"Trả lời"}, {w:"答え (こたえ)", m:"Câu trả lời"}] },
            "倒": { hanviet: "ĐẢO", mean: "Đổ/Ngã", on: "トウ", kun: "たお.れる", radicals: "Nhân (亻) + Đáo (到)", tipImg: "Người đến thì ngã.", tipSoundOn: "**Tou**san phá sản.", tipSoundKun: "**Tao**reru đổ.", words: [{w:"倒れる (たおれる)", m:"Đổ/Ngã"}] },
            "焼": { hanviet: "THIÊU", mean: "Nướng/Cháy", on: "ショウ", kun: "や.ける", radicals: "Hỏa (火)", tipImg: "Lửa thiêu đốt.", tipSoundOn: "Nen**shou** nhiên thiếu.", tipSoundKun: "**Ya**keru cháy.", words: [{w:"焼ける (やける)", m:"Cháy/Nướng"}, {w:"焼く (やく)", m:"Nướng"}] },
            "死": { hanviet: "TỬ", mean: "Chết", on: "シ", kun: "し.ぬ", radicals: "Ngạt (歹) + Chủy (匕)", tipImg: "Xương tàn (歹) bên cái thìa (匕).", tipSoundOn: "**Shi**bou tử vong.", tipSoundKun: "**Shi**nu chết.", words: [{w:"死ぬ (しぬ)", m:"Chết"}] },
            "安": { hanviet: "AN", mean: "An toàn/Rẻ", on: "アン", kun: "やす.い", radicals: "Miên (宀) + Nữ (女)", tipImg: "Người nữ (女) ở trong nhà (宀) thì an toàn.", tipSoundOn: "**An**shin yên tâm.", tipSoundKun: "**Yasu**i rẻ.", words: [{w:"安心 (あんしん)", m:"Yên tâm"}, {w:"安全 (あんぜん)", m:"An toàn"}] },
            "心": { hanviet: "TÂM", mean: "Tim/Tâm", on: "シン", kun: "こころ", radicals: "Tâm (心)", tipImg: "Hình trái tim.", tipSoundOn: "An**shin** yên tâm.", tipSoundKun: "**Kokoro** tấm lòng.", words: [{w:"心 (こころ)", m:"Tim"}] },
            "遅": { hanviet: "TRÌ", mean: "Muộn/Chậm", on: "チ", kun: "おそ.い", radicals: "Xước (⻌) + Tê (犀)", tipImg: "Con tê giác đi chậm.", tipSoundOn: "**Chi**koku đến muộn.", tipSoundKun: "**Oso**i chậm.", words: [{w:"遅刻 (ちこく)", m:"Đến muộn"}, {w:"遅い (おそい)", m:"Muộn"}] },
            "刻": { hanviet: "KHẮC", mean: "Khắc/Thời gian", on: "コク", kun: "きざ.む", radicals: "Đao (刂) + Hợi (亥)", tipImg: "Dùng dao khắc giờ Hợi.", tipSoundOn: "Chi**koku** đến muộn.", words: [{w:"遅刻 (ちこく)", m:"Đến muộn"}] },
            "早": { hanviet: "TẢO", mean: "Sớm", on: "ソウ", kun: "はや.い", radicals: "Nhật (日) + Thập (十)", tipImg: "Mặt trời mọc trên ngọn cây.", tipSoundOn: "**Sou**tai về sớm.", tipSoundKun: "**Haya**i sớm.", words: [{w:"早退 (そうたい)", m:"Về sớm"}, {w:"早い (はやい)", m:"Sớm"}] },
            "退": { hanviet: "THOÁI", mean: "Rút lui", on: "タイ", kun: "しりぞ.く", radicals: "Xước (⻌) + Cấn (艮)", tipImg: "Mắt (艮) nhìn đường lui (⻌).", tipSoundOn: "Sou**tai** về sớm.", words: [{w:"早退 (そうたい)", m:"Về sớm"}] },
            "離": { hanviet: "LY", mean: "Tách rời", on: "リ", kun: "はな.れる", radicals: "Chuy (隹)", tipImg: "Chim bay đi ly biệt.", tipSoundOn: "**Ri**kon ly hôn.", tipSoundKun: "**Hana**reru rời xa.", words: [{w:"離婚 (りこん)", m:"Ly hôn"}] },
            "婚": { hanviet: "HÔN", mean: "Kết hôn", on: "コン", kun: "", radicals: "Nữ (女) + Hôn (昏)", tipImg: "Phụ nữ kết hôn lúc hoàng hôn.", tipSoundOn: "Kek**kon** kết hôn.", words: [{w:"離婚 (りこん)", m:"Ly hôn"}, {w:"結婚 (けっこん)", m:"Kết hôn"}] },
            "複": { hanviet: "PHỨC", mean: "Phức tạp/Kép", on: "フク", kun: "", radicals: "Y (衤)", tipImg: "Áo nhiều lớp phức tạp.", tipSoundOn: "**Fuku**zatsu phức tạp.", words: [{w:"複雑 (ふくざつ)", m:"Phức tạp"}] },
            "雑": { hanviet: "TẠP", mean: "Tạp nham", on: "ザツ", kun: "", radicals: "Chuy (隹) + Mộc (木)", tipImg: "Chim đậu trên cây tạp nham.", tipSoundOn: "Fuku**zatsu** phức tạp.", words: [{w:"雑誌 (ざっし)", m:"Tạp chí"}] },
            "邪": { hanviet: "TÀ", mean: "Tà ác", on: "ジャ", kun: "", radicals: "Ấp (阝) + Nha (牙)", tipImg: "Răng (牙) của quỷ ở ấp (阝).", tipSoundOn: "**Ja**ma phiền hà.", words: [{w:"邪魔 (じゃま)", m:"Phiền hà"}] },
            "魔": { hanviet: "MA", mean: "Ma quỷ", on: "マ", kun: "", radicals: "Ma (麻) + Quỷ (鬼)", tipImg: "Ma (鬼) trốn trong rừng gai (麻).", tipSoundOn: "Ja**ma** phiền hà.", words: [{w:"悪魔 (あくま)", m:"Ác ma"}] },
            "汚": { hanviet: "Ô", mean: "Bẩn", on: "オ", kun: "きたな.い", radicals: "Thủy (氵) + Vu (于)", tipImg: "Nước (氵) bị ô nhiễm.", tipSoundOn: "**O**sen ô nhiễm.", tipSoundKun: "**Kitana**i bẩn.", words: [{w:"汚い (きたない)", m:"Bẩn"}, {w:"汚れる (よごれる)", m:"Vấy bẩn"}] },
            "嬉": { hanviet: "HI", mean: "Vui mừng", on: "キ", kun: "うれ.しい", radicals: "Nữ (女) + Hỉ (喜)", tipImg: "Phụ nữ vui mừng.", tipSoundOn: "", tipSoundKun: "**Ure**shii vui.", words: [{w:"嬉しい (うれしい)", m:"Vui sướng"}] },
            "悲": { hanviet: "BI", mean: "Buồn", on: "ヒ", kun: "かな.しい", radicals: "Tâm (心) + Phi (非)", tipImg: "Tâm (心) phiền muộn là bi ai.", tipSoundOn: "**Hi**geki bi kịch.", tipSoundKun: "**Kana**shii buồn.", words: [{w:"悲しい (かなしい)", m:"Buồn"}] },
            "恥": { hanviet: "SỈ", mean: "Xấu hổ", on: "チ", kun: "はず.かしい", radicals: "Nhĩ (耳) + Tâm (心)", tipImg: "Tai (耳) đỏ lên vì tâm (心) xấu hổ.", tipSoundOn: "", tipSoundKun: "**Hazu**kashii xấu hổ.", words: [{w:"恥ずかしい (はずかしい)", m:"Xấu hổ"}] },
            "震": { hanviet: "CHẤN", mean: "Rung động", on: "シン", kun: "ふる.える", radicals: "Vũ (雨) + Thần (辰)", tipImg: "Thần (辰) làm mưa (雨) chấn động.", tipSoundOn: "Ji**shin** động đất.", tipSoundKun: "**Furu**eru run rẩy.", words: [{w:"地震 (じしん)", m:"Động đất"}] },
            "台": { hanviet: "ĐÀI", mean: "Cái bệ/Đài", on: "ダイ, タイ", kun: "", radicals: "Khẩu (口) + Tư (ム)", tipImg: "Cái đài cao.", tipSoundOn: "**Tai**fuu bão.", words: [{w:"台風 (たいふう)", m:"Bão"}, {w:"台所 (だいどころ)", m:"Nhà bếp"}] },
            "風": { hanviet: "PHONG", mean: "Gió", on: "フウ", kun: "かぜ", radicals: "Phong (風)", tipImg: "Gió thổi.", tipSoundOn: "Tai**fuu** bão.", tipSoundKun: "**Kaze** gió.", words: [{w:"風 (かぜ)", m:"Gió"}] },
            "事": { hanviet: "SỰ", mean: "Sự việc", on: "ジ", kun: "こと", radicals: "Quyết (亅)", tipImg: "Tay cầm bút ghi chép sự việc.", tipSoundOn: "**Ji**ko tai nạn.", tipSoundKun: "**Koto** việc.", words: [{w:"事故 (じこ)", m:"Tai nạn"}, {w:"仕事 (しごと)", m:"Công việc"}] },
            "故": { hanviet: "CỐ", mean: "Cũ/Sự cố", on: "コ", kun: "", radicals: "Phốc (攴) + Cổ (古)", tipImg: "Đánh (攴) vào cái cũ (古) gây sự cố.", tipSoundOn: "Ji**ko** tai nạn.", words: [{w:"事故 (じこ)", m:"Tai nạn"}] },
            "汗": { hanviet: "HÃN", mean: "Mồ hôi", on: "カン", kun: "あせ", radicals: "Thủy (氵) + Can (干)", tipImg: "Nước (氵) chảy ra khi làm việc khô (干) là mồ hôi.", tipSoundOn: "", tipSoundKun: "**Ase** mồ hôi.", words: [{w:"汗 (あせ)", m:"Mồ hôi"}] },
            "勢": { hanviet: "THẾ", mean: "Thế lực", on: "セイ", kun: "いきお.い", radicals: "Lực (力)", tipImg: "Thế lực mạnh.", tipSoundOn: "Oo**zei** nhiều người.", tipSoundKun: "**Ikio**i khí thế.", words: [{w:"大勢 (おおぜい)", m:"Nhiều người"}] },
            "疲": { hanviet: "BÌ", mean: "Mệt mỏi", on: "ヒ", kun: "つか.れる", radicals: "Nạch (疒) + Bì (皮)", tipImg: "Bệnh (疒) ngoài da (皮) gây mệt mỏi.", tipSoundOn: "**Hi**rou mệt mỏi.", tipSoundKun: "**Tsuka**reru mệt.", words: [{w:"お疲れ様 (おつかれさま)", m:"Vất vả rồi"}] },
            "伺": { hanviet: "TỨ", mean: "Hỏi thăm", on: "シ", kun: "うかが.う", radicals: "Nhân (亻) + Ty (司)", tipImg: "Người (亻) quản lý (司) đi hỏi thăm.", tipSoundOn: "", tipSoundKun: "**Ukaga**u đến thăm/hỏi.", words: [{w:"伺う (うかがう)", m:"Đến thăm (khiêm nhường)"}] },
            "途": { hanviet: "ĐỒ", mean: "Đường", on: "ト", kun: "", radicals: "Xước (⻌) + Dư (余)", tipImg: "Dư (余) đường đi (⻌).", tipSoundOn: "**To**chuu giữa đường.", words: [{w:"途中 (とちゅう)", m:"Giữa đường"}] },
            "並": { hanviet: "TỊNH", mean: "Xếp hàng", on: "ヘイ", kun: "なら.ぶ", radicals: "Nhất (一)", tipImg: "Hai người đứng ngang hàng.", tipSoundOn: "**Hei**retsu song song.", tipSoundKun: "**Nara**bu xếp hàng.", words: [{w:"並ぶ (ならぶ)", m:"Xếp hàng"}] },
            "洋": { hanviet: "DƯƠNG", mean: "Đại dương/Tây", on: "ヨウ", kun: "", radicals: "Thủy (氵) + Dương (羊)", tipImg: "Nước (氵) biển mênh mông như đàn cừu (羊).", tipSoundOn: "**You**fuku âu phục.", words: [{w:"洋服 (ようふく)", m:"Quần áo Tây"}] },
            "服": { hanviet: "PHỤC", mean: "Quần áo", on: "フク", kun: "", radicals: "Nguyệt (月)", tipImg: "Mặc áo phục vụ.", tipSoundOn: "You**fuku** âu phục.", words: [{w:"洋服 (ようふく)", m:"Quần áo Tây"}] },
            "成": { hanviet: "THÀNH", mean: "Thành đạt", on: "セイ", kun: "な.る", radicals: "Qua (戈)", tipImg: "Thành công.", tipSoundOn: "**Sei**jinshiki lễ trưởng thành.", tipSoundKun: "**Na**ru trở thành.", words: [{w:"成人式 (せいじんしき)", m:"Lễ trưởng thành"}] },
            "数": { hanviet: "SỐ", mean: "Đếm/Số", on: "スウ", kun: "かぞ.える", radicals: "Phốc (攴)", tipImg: "Đếm số.", tipSoundOn: "**Suu**gaku toán học.", tipSoundKun: "**Kazo**eru đếm.", words: [{w:"数える (かぞえる)", m:"Đếm"}] },
            "測": { hanviet: "TRẮC", mean: "Đo lường", on: "ソク", kun: "はか.る", radicals: "Thủy (氵) + Tắc (則)", tipImg: "Dùng nước đo quy tắc.", tipSoundOn: "So**ku**tei đo đạc.", tipSoundKun: "**Haka**ru đo.", words: [{w:"測る (はかる)", m:"Đo (kích thước)"}] },
            "確": { hanviet: "XÁC", mean: "Chính xác", on: "カク", kun: "たし.か", radicals: "Thạch (石)", tipImg: "Đá (石) cứng chắc.", tipSoundOn: "**Kaku**nin xác nhận.", tipSoundKun: "**Tashika**meru xác nhận.", words: [{w:"確かめる (たしかめる)", m:"Kiểm tra"}] },
            "発": { hanviet: "PHÁT", mean: "Xuất phát", on: "ハツ", kun: "", radicals: "Bát (癶)", tipImg: "Bắn tên.", tipSoundOn: "Shup**patsu** xuất phát.", words: [{w:"出発 (しゅっぱつ)", m:"Xuất phát"}] },
            "着": { hanviet: "TRƯỚC", mean: "Đến/Mặc", on: "チャク", kun: "つ.く", radicals: "Dương (羊)", tipImg: "Đến nơi mặc áo len cừu.", tipSoundOn: "Tou**chaku** đến nơi.", tipSoundKun: "**Ki**ru mặc.", words: [{w:"到着 (とうちゃく)", m:"Đến nơi"}, {w:"着る (きる)", m:"Mặc"}] },
            "酔": { hanviet: "TÚY", mean: "Say", on: "スイ", kun: "よ.う", radicals: "Dậu (酉) + Tốt (卒)", tipImg: "Uống rượu (酉) tốt (卒) nghiệp là say.", tipSoundOn: "Ma**sui** gây mê.", tipSoundKun: "**Yo**u say.", words: [{w:"酔う (よう)", m:"Say"}] },
            "危": { hanviet: "NGUY", mean: "Nguy hiểm", on: "キ", kun: "あぶ.ない", radicals: "Tiết (卩)", tipImg: "Người quỳ bên vách đá.", tipSoundOn: "**Ki**ken nguy hiểm.", tipSoundKun: "**Abu**nai nguy hiểm.", words: [{w:"危険 (きけん)", m:"Nguy hiểm"}] },
            "険": { hanviet: "HIỂM", mean: "Hiểm trở", on: "ケン", kun: "けわ.しい", radicals: "Ấp (阝)", tipImg: "Núi non hiểm trở.", tipSoundOn: "Ki**ken** nguy hiểm.", words: [{w:"危険 (きけん)", m:"Nguy hiểm"}] },
            "必": { hanviet: "TẤT", mean: "Tất yếu", on: "ヒツ", kun: "かなら.ず", radicals: "Tâm (心)", tipImg: "Tâm quyết tâm.", tipSoundOn: "**Hitsu**you cần thiết.", tipSoundKun: "**Kanara**zu nhất định.", words: [{w:"必要 (ひつよう)", m:"Cần thiết"}] },
            "要": { hanviet: "YẾU", mean: "Quan trọng", on: "ヨウ", kun: "い.る", radicals: "Tây (西) + Nữ (女)", tipImg: "Người nữ phương tây quan trọng.", tipSoundOn: "Hitsu**you** cần thiết.", tipSoundKun: "**I**ru cần.", words: [{w:"必要 (ひつよう)", m:"Cần thiết"}] },
            "議": { hanviet: "NGHỊ", mean: "Hội nghị", on: "ギ", kun: "", radicals: "Ngôn (言) + Nghĩa (義)", tipImg: "Nói (言) điều nghĩa (義) ở hội nghị.", tipSoundOn: "Kai**gi** hội nghị.", words: [{w:"会議 (かいぎ)", m:"Cuộc họp"}] },
            "場": { hanviet: "TRƯỜNG", mean: "Nơi chốn", on: "ジョウ", kun: "ば", radicals: "Thổ (土)", tipImg: "Đất rộng.", tipSoundOn: "Kai**jou** hội trường.", tipSoundKun: "**Ba**sho địa điểm.", words: [{w:"会場 (かいじょう)", m:"Hội trường"}] },
            "表": { hanviet: "BIỂU", mean: "Mặt trước/Biểu", on: "ヒョウ", kun: "おもて", radicals: "Y (衣)", tipImg: "Mặt ngoài của áo.", tipSoundOn: "**Hyou** bảng biểu.", tipSoundKun: "**Omote** mặt trước.", words: [{w:"表 (おもて)", m:"Mặt trước"}] },
            "裏": { hanviet: "LÝ", mean: "Mặt sau", on: "リ", kun: "うら", radicals: "Y (衣) + Lý (里)", tipImg: "Bên trong (里) áo (衣).", tipSoundOn: "", tipSoundKun: "**Ura** mặt sau.", words: [{w:"裏 (うら)", m:"Mặt sau"}] },
            "返": { hanviet: "PHẢN", mean: "Trả lại", on: "ヘン", kun: "かえ.す", radicals: "Xước (⻌) + Phản (反)", tipImg: "Đi về (⻌) trả lại (反).", tipSoundOn: "**Hen**ji hồi âm.", tipSoundKun: "**Kae**su trả lại.", words: [{w:"返事 (へんじ)", m:"Hồi âm"}] },
            "米": { hanviet: "MỄ", mean: "Gạo", on: "ベイ, マイ", kun: "こめ", radicals: "Mễ (米)", tipImg: "Hạt gạo.", tipSoundOn: "**Bei**koku nước Mỹ.", tipSoundKun: "**Kome** gạo.", words: [{w:"米 (こめ)", m:"Gạo"}] },
            "麦": { hanviet: "MẠCH", mean: "Lúa mạch", on: "バク", kun: "むぎ", radicals: "Mạch (麦)", tipImg: "Cây lúa mạch.", tipSoundOn: "", tipSoundKun: "**Mugi** lúa mạch.", words: [{w:"麦 (むぎ)", m:"Lúa mạch"}] },
            "油": { hanviet: "DU", mean: "Dầu", on: "ユ", kun: "あぶら", radicals: "Thủy (氵) + Do (由)", tipImg: "Nước (氵) chảy từ ruộng (由) là dầu (?).", tipSoundOn: "Seki**yu** dầu mỏ.", tipSoundKun: "**Abura** dầu.", words: [{w:"石油 (せきゆ)", m:"Dầu mỏ"}] },
            "原": { hanviet: "NGUYÊN", mean: "Nguyên bản/Cánh đồng", on: "ゲン", kun: "はら", radicals: "Nha (厂) + Tuyền (泉)", tipImg: "Suối (泉) chảy từ sườn núi (厂).", tipSoundOn: "**Gen**ryou nguyên liệu.", tipSoundKun: "**Hara** cánh đồng.", words: [{w:"原料 (げんりょう)", m:"Nguyên liệu"}] },
            "料": { hanviet: "LIỆU", mean: "Nguyên liệu/Phí", on: "リョウ", kun: "", radicals: "Mễ (米) + Đấu (斗)", tipImg: "Đong gạo (米) bằng đấu (斗).", tipSoundOn: "Gen**ryou** nguyên liệu.", words: [{w:"料理 (りょうり)", m:"Món ăn"}] },
            "泥": { hanviet: "NÊ", mean: "Bùn", on: "デイ", kun: "どろ", radicals: "Thủy (氵) + Ni (尼)", tipImg: "Nước (氵) trộn đất sét.", tipSoundOn: "", tipSoundKun: "**Doro**bou kẻ trộm.", words: [{w:"泥棒 (どろぼう)", m:"Kẻ trộm"}] },
            "棒": { hanviet: "BỔNG", mean: "Gậy", on: "ボウ", kun: "", radicals: "Mộc (木) + Phụng (奉)", tipImg: "Cây gậy gỗ.", tipSoundOn: "Doro**bou** kẻ trộm.", words: [{w:"棒 (ぼう)", m:"Gậy"}] },
            "警": { hanviet: "CẢNH", mean: "Cảnh báo", on: "ケイ", kun: "", radicals: "Ngôn (言) + Kính (敬)", tipImg: "Nói (言) lời cung kính (敬) để cảnh báo.", tipSoundOn: "**Kei**kan cảnh sát.", words: [{w:"警察 (けいさつ)", m:"Cảnh sát"}] },
            "官": { hanviet: "QUAN", mean: "Quan lại", on: "カン", kun: "", radicals: "Miên (宀)", tipImg: "Quan làm việc trong nhà.", tipSoundOn: "Kei**kan** cảnh sát.", words: [{w:"警官 (けいかん)", m:"Cảnh sát"}] },
            "建": { hanviet: "KIẾN", mean: "Xây dựng", on: "ケン", kun: "た.てる", radicals: "Dẫn (廴) + Duật (聿)", tipImg: "Cầm bút vẽ bản đồ xây dựng.", tipSoundOn: "**Ken**chikuka kiến trúc sư.", tipSoundKun: "**Ta**teru xây.", words: [{w:"建築 (けんちく)", m:"Kiến trúc"}] },
            "築": { hanviet: "TRÚC", mean: "Xây đắp", on: "チク", kun: "きず.く", radicals: "Trúc (竹)", tipImg: "Dùng tre xây nhà.", tipSoundOn: "Ken**chiku** kiến trúc.", words: [{w:"建築家 (けんちくか)", m:"Kiến trúc sư"}] },
            "科": { hanviet: "KHOA", mean: "Khoa học", on: "カ", kun: "", radicals: "Hòa (禾) + Đấu (斗)", tipImg: "Đong lúa bằng đấu một cách khoa học.", tipSoundOn: "**Ka**gaku khoa học.", words: [{w:"科学 (かがく)", m:"Khoa học"}] },
            "埋": { hanviet: "MAI", mean: "Chôn/Lấp", on: "マイ", kun: "う.める", radicals: "Thổ (土) + Lý (里)", tipImg: "Chôn xuống đất (土) ở làng (里).", tipSoundOn: "**Mai**zou chôn cất.", tipSoundKun: "**U**meru chôn.", words: [{w:"埋める (うめる)", m:"Chôn/Lấp"}] },
            "技": { hanviet: "KỸ", mean: "Kỹ thuật", on: "ギ", kun: "わざ", radicals: "Thủ (扌) + Chi (支)", tipImg: "Tay (扌) chống (支) kỹ thuật.", tipSoundOn: "**Gi**jutsu kỹ thuật.", tipSoundKun: "**Waza** chiêu thức.", words: [{w:"技術 (ぎじゅつ)", m:"Kỹ thuật"}] },
            "術": { hanviet: "THUẬT", mean: "Nghệ thuật", on: "ジュツ", kun: "", radicals: "Hành (行) + Thuật (术)", tipImg: "Đi (行) học thuật (术).", tipSoundOn: "Gi**jutsu** kỹ thuật.", words: [{w:"美術 (びじゅつ)", m:"Mỹ thuật"}] },
            "土": { hanviet: "THỔ", mean: "Đất", on: "ド, ト", kun: "つち", radicals: "Thổ (土)", tipImg: "Cây mọc trên đất.", tipSoundOn: "**To**chi đất đai.", tipSoundKun: "**Tsuchi** đất.", words: [{w:"土地 (とち)", m:"Đất đai"}] },
            "騒": { hanviet: "TAO", mean: "Ồn ào", on: "ソウ", kun: "さわ.ぐ", radicals: "Mã (馬) + Trảo (蚤)", tipImg: "Ngựa (馬) bị bọ chét (蚤) cắn nên làm ồn.", tipSoundOn: "**Sou**on tiếng ồn.", tipSoundKun: "**Sawa**gu làm ồn.", words: [{w:"騒音 (そうおん)", m:"Tiếng ồn"}] },
            "音": { hanviet: "ÂM", mean: "Âm thanh", on: "オン", kun: "おと", radicals: "Âm (音)", tipImg: "Mặt trời mọc có tiếng động (?).", tipSoundOn: "Sou**on** tiếng ồn.", tipSoundKun: "**Oto** âm thanh.", words: [{w:"音楽 (おんがく)", m:"Âm nhạc"}] },
            "使": { hanviet: "SỬ", mean: "Sử dụng", on: "シ", kun: "つか.う", radicals: "Nhân (亻) + Lại (吏)", tipImg: "Người (亻) sai khiến quan lại (吏).", tipSoundOn: "**Shi**you sử dụng.", tipSoundKun: "**Tsuka**u dùng.", words: [{w:"使用 (しよう)", m:"Sử dụng"}] },
            "用": { hanviet: "DỤNG", mean: "Sử dụng/Việc", on: "ヨウ", kun: "もち.いる", radicals: "Dụng (用)", tipImg: "Cái chuông.", tipSoundOn: "Shi**you** sử dụng.", tipSoundKun: "**Mochi**iru dùng.", words: [{w:"用意 (ようい)", m:"Chuẩn bị"}] },
            "豪": { hanviet: "HÀO", mean: "Hào hoa", on: "ゴウ", kun: "", radicals: "Thỉ (豕)", tipImg: "Con heo (豕) hào phóng.", tipSoundOn: "**Gou**ka hào hoa.", words: [{w:"豪華 (ごうか)", m:"Sang trọng"}] },
            "華": { hanviet: "HOA", mean: "Hoa/Đẹp", on: "カ", kun: "はな", radicals: "Thảo (艹)", tipImg: "Hoa cỏ đẹp đẽ.", tipSoundOn: "Gou**ka** hào hoa.", tipSoundKun: "**Hana**yaka rực rỡ.", words: [{w:"華やか (はなやか)", m:"Lộng lẫy"}] },
            "彫": { hanviet: "ĐIÊU", mean: "Điêu khắc", on: "チョウ", kun: "ほ.る", radicals: "Chu (周) + Sam (彡)", tipImg: "Khắc họa tiết chu vi (周) rực rỡ (彡).", tipSoundOn: "**Chou**koku điêu khắc.", tipSoundKun: "**Ho**ru khắc.", words: [{w:"彫刻 (ちょうこく)", m:"Điêu khắc"}] },
            "刻": { hanviet: "KHẮC", mean: "Khắc", on: "コク", kun: "きざ.む", radicals: "Đao (刂)", tipImg: "Dùng dao khắc.", tipSoundOn: "Chou**koku** điêu khắc.", tipSoundKun: "**Kiza**mu thái/băm.", words: [{w:"彫刻 (ちょうこく)", m:"Điêu khắc"}] }
        };

        // --- 4. APP LOGIC ---
        let currentIndex = 0; 
        let currentQuizItem = null; 
        let score = 0; 
        let currentStrokeSvg = null;

        function init() {
            renderList();
            renderGrammarMenu();
            loadWord(0);
            
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', e => { 
                    const t = e.target.value.toLowerCase(); 
                    document.querySelectorAll('.vocab-item').forEach(el => el.style.display = el.innerText.toLowerCase().includes(t) ? 'block' : 'none'); 
                });
            }

            const mobileSearchInput = document.getElementById('mobileSearchInput');
            if (mobileSearchInput) {
                mobileSearchInput.addEventListener('input', e => { 
                    const t = e.target.value.toLowerCase(); 
                    document.querySelectorAll('.vocab-item').forEach(el => el.style.display = el.innerText.toLowerCase().includes(t) ? 'block' : 'none'); 
                });
            }

            const quizInput = document.getElementById('quiz-input');
            if (quizInput) {
                quizInput.addEventListener('keypress', e => { if(e.key === 'Enter') checkAnswer(); });
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            document.getElementById('learn-section').classList.toggle('hidden', tab !== 'learn');
            document.getElementById('quiz-section').classList.toggle('hidden', tab !== 'quiz');
            if(tab === 'quiz') nextQuestion();
        }

        function renderList() {
            const listD = document.getElementById('vocabList'); 
            const listM = document.getElementById('mobileVocabList');
            const html = vocabData.map((item, i) => `
                <div class="vocab-item p-3 border-b hover:bg-gray-50 cursor-pointer rounded-lg mx-1 my-1" data-index="${i}" onclick="loadWord(${i}); if(window.innerWidth < 768) toggleDrawer();">
                    <div class="flex justify-between font-bold items-center">
                        <span class="text-gray-800 ja-text">${item.Kanji || item.Furigana}</span>
                        <span class="text-gray-300 text-xs font-mono">#${item.STT}</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1 truncate">${item.Nghĩa}</div>
                </div>`).join('');
            if (listD) listD.innerHTML = html;
            if (listM) listM.innerHTML = html;
        }

        function loadWord(idx) {
            currentIndex = idx; 
            const word = vocabData[idx];
            document.querySelectorAll('.vocab-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll(`.vocab-item[data-index="${idx}"]`).forEach(el => el.classList.add('active'));
            
            const activeItem = document.querySelector(`.vocab-item[data-index="${idx}"]`);
            if (activeItem) activeItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            document.getElementById('headerProgress').innerText = `${idx+1}/${vocabData.length}`;
            document.getElementById('wordIndex').innerText = `#${word.STT}`;
            document.getElementById('cardKanji').innerText = word.Kanji || word.Furigana;
            document.getElementById('cardFurigana').innerText = word.Furigana;
            document.getElementById('cardMeaning').innerText = word.Nghĩa;
            document.getElementById('wordType').innerText = word.type.toUpperCase();
            
            const hasKanji = word.Kanji && word.Kanji !== word.Furigana;
            document.getElementById('strokeBtn').classList.toggle('hidden', !hasKanji);
            
            renderShadowing(word);
        }

        function renderShadowing(word) {
            const cont = document.getElementById('sentenceList'); 
            cont.innerHTML = '';
            
            if(!word.conv) { 
                document.getElementById('emptyState').classList.remove('hidden'); 
                return; 
            }
            document.getElementById('emptyState').classList.add('hidden');
            
            const types = [
                { k:'polite', l:'Lịch sự', m:word.conv.pVi, i:'user-tie', c:'indigo' }, 
                { k:'casual', l:'Thân mật', m:word.conv.cVi, i:'comments', c:'pink' }
            ];
            
            types.forEach(t => {
                const grammarBtn = word.conv.gIds && word.conv.gIds.length > 0 
                    ? `<button onclick="openExplan('${word.conv.gIds.join(',')}')" class="text-xs text-indigo-500 hover:text-indigo-700 font-bold px-2 py-1 rounded hover:bg-indigo-50 transition"><i class="fas fa-info-circle"></i> Ngữ pháp</button>`
                    : '';

                cont.innerHTML += `
                    <div class="shadow-card bg-white rounded-2xl p-4 border border-gray-100">
                        <div class="flex justify-between border-b border-gray-100 pb-2 mb-3">
                            <div class="flex gap-2 items-center">
                                <div class="bg-${t.c}-50 p-1.5 rounded text-${t.c}-600"><i class="fas fa-${t.i}"></i></div>
                                <span class="text-xs font-bold text-gray-400 uppercase tracking-wide">${t.l}</span>
                            </div>
                            ${grammarBtn}
                        </div>
                        <div class="flex justify-between items-start gap-3">
                            <div>
                                <div class="text-lg md:text-xl ja-text font-medium text-gray-800 mb-1 cursor-pointer hover:text-indigo-600 transition-colors" onclick="speakText('${word.conv[t.k]}')">${word.conv[t.k]}</div>
                                <div class="text-sm text-gray-500 italic">${t.m}</div>
                            </div>
                            <button onclick="speakText('${word.conv[t.k]}')" class="audio-btn text-${t.c}-400 hover:text-${t.c}-600 p-2 rounded-full hover:bg-${t.c}-50 transition-colors flex-shrink-0">
                                <i class="fas fa-volume-up text-xl"></i>
                            </button>
                        </div>
                    </div>`;
            });
        }

        function openExplan(idsStr) {
            const ids = idsStr.split(','); 
            const f = document.getElementById('dgFormula'); 
            const e = document.getElementById('dgExplanation');
            
            f.innerText = ids.map(id => grammarRepo[id] ? grammarRepo[id].formula : "N/A").join("  /  ");
            e.innerHTML = ids.map(id => {
                if (!grammarRepo[id]) return `<div class="text-red-500">Missing grammar: ${id}</div>`;
                return `
                <div class="pb-2 border-b border-gray-100 last:border-0">
                    <strong class="text-indigo-700 block mb-1">${grammarRepo[id].title} <span class="text-xs font-normal text-gray-400">(${grammarRepo[id].desc.split(':')[0]})</span></strong>
                    <p>${grammarRepo[id].desc.split(':').slice(1).join(':') || grammarRepo[id].desc}</p>
                    <p class="text-xs text-gray-400 mt-1 italic">Vd: ${grammarRepo[id].ex}</p>
                </div>`;
            }).join("");
            
            showModal('detailGrammarModal');
        }

        function renderGrammarMenu() {
            const grid = document.getElementById('grammarGrid'); 
            grid.innerHTML = '';
            Object.keys(grammarRepo).forEach(key => {
                const r = grammarRepo[key];
                grid.innerHTML += `
                    <div class="bg-white p-4 rounded-xl border border-gray-100 flex flex-col justify-between hover:shadow-md transition cursor-pointer" onclick="speakText('${r.ex}')">
                        <div>
                            <div class="font-bold text-sm text-indigo-600 mb-1 flex items-center gap-2"><i class="fas fa-tag text-xs"></i> ${r.title}</div>
                            <code class="text-xs block bg-gray-50 p-1.5 rounded mb-2 border border-gray-200 font-mono text-gray-700">${r.formula}</code>
                            <p class="text-xs text-gray-500 mb-2 line-clamp-2">${r.desc}</p>
                        </div>
                        <div class="bg-indigo-50 p-2 rounded flex justify-between items-center gap-2 mt-2">
                            <span class="text-[11px] font-medium text-indigo-800 ja-text truncate">${r.ex}</span>
                            <i class="fas fa-volume-up text-indigo-400 text-xs"></i>
                        </div>
                    </div>`;
            });
        }

        function showModal(id) { 
            const modal = document.getElementById(id);
            modal.classList.remove('hidden'); 
            setTimeout(() => { 
                document.getElementById(id.replace('Modal','Backdrop')).classList.remove('opacity-0'); 
                document.getElementById(id.replace('Modal','Panel')).classList.remove('opacity-0', 'scale-95'); 
            }, 10); 
        }

        function closeModal(id) { 
            const b = document.getElementById(id.replace('Modal','Backdrop')); 
            const p = document.getElementById(id.replace('Modal','Panel'));
            if(b) b.classList.add('opacity-0'); 
            if(p) p.classList.add('opacity-0', 'scale-95');
            setTimeout(() => document.getElementById(id).classList.add('hidden'), 200); 
        }

        function openGrammarList() { showModal('grammarListModal'); }

        async function openStrokeModal(char) {
            const word = vocabData[currentIndex]; 
            const kanjis = word.Kanji.match(/[\u4e00-\u9faf]/g) || [];
            if(kanjis.length === 0) return;
            const target = char || kanjis[0];
            const tabs = document.getElementById('strokeTabs'); 
            tabs.innerHTML = '';
            if(kanjis.length > 1) {
                kanjis.forEach(k => {
                    const b = document.createElement('button'); 
                    b.innerText = k;
                    b.className = `w-12 h-12 text-xl rounded-xl font-bold border transition ja-text ${k===target ? 'bg-pink-600 text-white border-pink-600 shadow-lg' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}`;
                    b.onclick = () => showKanjiStroke(k); 
                    tabs.appendChild(b);
                });
            }
            showModal('strokeModal'); 
            await showKanjiStroke(target);
        }

        async function showKanjiStroke(k) {
            const d = kanjiDetails[k]; 
            const c = document.getElementById('kanjiDetailContent'); 
            const e = document.getElementById('kanjiDetailEmpty');
            if(d) {
                c.classList.remove('hidden'); e.classList.add('hidden');
                document.getElementById('detailKanji').innerText = k; 
                document.getElementById('detailHanViet').innerText = d.hanviet || '?';
                document.getElementById('detailMeaning').innerText = d.mean || ''; 
                document.getElementById('detailOn').innerText = d.on || '-'; 
                document.getElementById('detailKun').innerText = d.kun || '-';
                document.getElementById('detailRadicals').innerText = d.radicals || '...';
                
                const fmt = s => s.replace(/\*\*(.*?)\*\*/g, '<span class="font-bold text-gray-900">$1</span>');
                document.getElementById('detailTipImg').innerHTML = fmt(d.tipImg || ''); 
                
                let soundContent = d.tipSound || '';
                if (!soundContent && (d.tipSoundOn || d.tipSoundKun)) {
                    soundContent = [d.tipSoundOn, d.tipSoundKun].filter(Boolean).join(' / ');
                }
                document.getElementById('detailTipSound').innerHTML = fmt(soundContent);
                
                document.getElementById('btnPlayOn').onclick = () => speakText(d.on);
                document.getElementById('btnPlayKun').onclick = () => speakText(d.kun);

                const wc = document.getElementById('detailWords'); 
                wc.innerHTML = '';
                if(d.words) {
                    d.words.forEach(w => wc.innerHTML += `<div class="flex justify-between items-center bg-gray-50 p-2 rounded hover:bg-gray-100 cursor-pointer border border-transparent hover:border-gray-200 transition" onclick="speakText('${w.w}')"><span class="text-lg font-bold text-indigo-700 ja-text">${w.w}</span><span class="text-xs text-gray-500 font-medium">${w.m}</span></div>`);
                }
            } else { 
                c.classList.add('hidden'); e.classList.remove('hidden'); 
            }
            const anim = document.getElementById('strokeAnimContainer'); 
            const grid = document.getElementById('strokeGridContainer');
            anim.innerHTML = '<i class="fas fa-spinner fa-spin text-gray-300 text-2xl"></i>'; 
            grid.innerHTML = '';
            try {
                const r = await fetch(`https://cdn.jsdelivr.net/gh/KanjiVG/kanjivg/kanji/${getKanjiHex(k)}.svg`);
                if(!r.ok) throw new Error();
                const svgText = await r.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(svgText, "image/svg+xml");
                doc.querySelectorAll('path').forEach(p => p.setAttribute('style', 'opacity:0; stroke:#333; stroke-width:3; fill:none; stroke-linecap:round; stroke-linejoin:round;')); 
                anim.innerHTML = new XMLSerializer().serializeToString(doc.documentElement);
                const mainSvg = anim.querySelector('svg');
                mainSvg.setAttribute('width','100%'); mainSvg.setAttribute('height','100%');
                currentStrokeSvg = mainSvg;
                replayStrokeAnimation();
                const cleanDoc = parser.parseFromString(svgText, "image/svg+xml"); 
                cleanDoc.querySelectorAll('path').forEach((p, i) => {
                    const b = document.createElement('div'); 
                    b.className = "w-16 h-16 stroke-grid-box flex items-center justify-center rounded bg-white shadow-sm";
                    const clone = cleanDoc.documentElement.cloneNode(true);
                    clone.setAttribute('width','100%'); clone.setAttribute('height','100%');
                    clone.querySelectorAll('path').forEach((pp, idx) => {
                        pp.style.fill="none"; pp.style.strokeLinecap="round"; pp.style.strokeLinejoin="round";
                        if(idx<i) { pp.style.stroke="#e5e7eb"; pp.style.strokeWidth="3"; }
                        else if(idx===i) { pp.style.stroke="#db2777"; pp.style.strokeWidth="4"; } 
                        else pp.style.display="none";
                    });
                    b.appendChild(clone); grid.appendChild(b);
                });
            } catch(e) { anim.innerHTML = "<span class='text-xs text-red-400'>Lỗi tải nét viết</span>"; }
        }

        function replayStrokeAnimation() {
            if(!currentStrokeSvg) return;
            const paths = currentStrokeSvg.querySelectorAll('path');
            paths.forEach(p => { p.style.transition='none'; p.style.opacity='0'; });
            void currentStrokeSvg.offsetWidth;
            let delay = 0;
            paths.forEach(p => {
                const len = p.getTotalLength();
                p.style.strokeDasharray = len; p.style.strokeDashoffset = len; p.style.opacity = '1';
                setTimeout(() => { p.style.transition = `stroke-dashoffset 0.6s ease-in-out`; p.style.strokeDashoffset = '0'; }, delay * 1000);
                delay += 0.6;
            });
        }

        function getKanjiHex(k) { return k.charCodeAt(0).toString(16).padStart(5, '0'); }
        function speakText(t) { if ('speechSynthesis' in window) { const u = new SpeechSynthesisUtterance(t); u.lang = 'ja-JP'; u.rate = 0.9; speechSynthesis.speak(u); } }
        function speakCurrent() { speakText(vocabData[currentIndex].Furigana); }
        function toggleDrawer() { const d = document.getElementById('mobileDrawer'); const c = document.getElementById('drawerContent'); const b = document.getElementById('drawerBackdrop'); if(d.classList.contains('pointer-events-none')) { d.classList.remove('pointer-events-none'); c.classList.remove('-translate-x-full'); b.classList.remove('opacity-0'); } else { c.classList.add('-translate-x-full'); b.classList.add('opacity-0'); setTimeout(() => d.classList.add('pointer-events-none'), 300); } }

        function nextQuestion() {
            document.getElementById('feedback-area').classList.add('hidden'); document.getElementById('btn-check').classList.remove('hidden'); document.getElementById('btn-next').classList.add('hidden');
            document.getElementById('quiz-kanji').className = "text-6xl ja-text font-bold text-gray-800 mb-4 transition-all inline-block";
            const inp = document.getElementById('quiz-input'); inp.value = ''; inp.disabled = false; inp.focus();
            const valid = vocabData.filter(v => v.Furigana !== "...");
            currentQuizItem = valid[Math.floor(Math.random() * valid.length)];
            document.getElementById('quiz-kanji').innerText = currentQuizItem.Kanji || currentQuizItem.Furigana;
            document.getElementById('quiz-meaning').innerText = currentQuizItem.Nghĩa;
        }
        
        function checkAnswer() {
            const inp = document.getElementById('quiz-input'); if(!inp.value.trim()) return;
            inp.disabled = true; 
            const correct = inp.value.trim() === currentQuizItem.Furigana;
            const k = document.getElementById('quiz-kanji'); const fbTitle = document.getElementById('feedback-title'); const fbArea = document.getElementById('feedback-area');
            if(correct) { 
                score += 10; k.classList.add("text-green-600", "correct-anim"); 
                fbTitle.innerHTML = '<span class="text-green-600"><i class="fas fa-check-circle mr-2"></i> Chính xác!</span>';
                fbArea.className = fbArea.className.replace("bg-red-50 border-red-200", "") + " bg-green-50 border-green-200";
                speakText(currentQuizItem.Furigana); 
            } else { 
                score = Math.max(0, score - 5); k.classList.add("text-red-500", "wrong-anim"); 
                fbTitle.innerHTML = '<span class="text-red-600"><i class="fas fa-times-circle mr-2"></i> Sai rồi!</span>';
                fbArea.className = fbArea.className.replace("bg-green-50 border-green-200", "") + " bg-red-50 border-red-200";
            }
            document.getElementById('score-display').innerText = score; document.getElementById('correct-answer').innerText = currentQuizItem.Furigana;
            document.getElementById('feedback-area').classList.remove('hidden'); document.getElementById('btn-check').classList.add('hidden'); document.getElementById('btn-next').classList.remove('hidden');
        }
        
        function playQuizAudio() { if(currentQuizItem) speakText(currentQuizItem.Furigana); }
        function prevWord() { if(currentIndex > 0) loadWord(currentIndex - 1); }
        function nextWord() { if(currentIndex < vocabData.length - 1) loadWord(currentIndex + 1); }

        window.speakCurrent = speakCurrent;
        window.switchTab = switchTab;
        window.openGrammarList = openGrammarList;
        window.openStrokeModal = openStrokeModal;
        window.replayStrokeAnimation = replayStrokeAnimation;
        window.speakText = speakText;
        window.toggleDrawer = toggleDrawer;
        window.nextQuestion = nextQuestion;
        window.checkAnswer = checkAnswer;
        window.playQuizAudio = playQuizAudio;
        window.prevWord = prevWord;
        window.nextWord = nextWord;
        window.loadWord = loadWord;
        window.openExplan = openExplan;
        window.closeModal = closeModal;
        window.showModal = showModal;

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
