<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AzaKanji Tango - Ngày 2: Động từ & Sinh hoạt</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Nunito', 'Inter', sans-serif; background-color: #f3f4f6; height: 100dvh; overflow: hidden; }
        .ja-text { font-family: 'Noto Sans JP', sans-serif; }
        .scroller { -webkit-overflow-scrolling: touch; overflow-y: auto; }
        .scroller::-webkit-scrollbar { width: 5px; height: 5px; }
        .scroller::-webkit-scrollbar-track { background: transparent; }
        .scroller::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        
        .vocab-item { transition: all 0.2s; }
        .vocab-item.active { background-color: #eef2ff; border-left: 4px solid #4f46e5; color: #4338ca; padding-left: 0.75rem; }
        
        .shadow-card { transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.2s; }
        .shadow-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border-top: 1px solid rgba(255, 255, 255, 0.3); }
        
        .tab-btn.active { background-color: white; color: #312e81; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); }
        .tab-btn { color: #a5b4fc; }
        
        /* Animation Classes */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .wrong-anim { animation: shake 0.3s ease-in-out; }
        
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .correct-anim { animation: pop 0.3s ease-in-out; }

        /* Stroke Order Styles */
        .stroke-grid-box { border: 1px solid #e5e7eb; background-color: white; position: relative; }
        .stroke-grid-box::after { content: ''; position: absolute; top: 0; left: 50%; width: 1px; height: 100%; background: repeating-linear-gradient(to bottom, #ddd 0, #ddd 4px, transparent 4px, transparent 8px); pointer-events: none; }
        .stroke-grid-box::before { content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 1px; background: repeating-linear-gradient(to right, #ddd 0, #ddd 4px, transparent 4px, transparent 8px); pointer-events: none; }
        
        /* Hide stroke paths initially */
        #strokeAnimContainer svg path { opacity: 0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="flex flex-col text-slate-800">

    <!-- HEADER -->
    <header class="bg-indigo-700 text-white shadow-lg flex-none z-40 relative">
        <div class="container mx-auto px-4 py-2 md:py-3">
            <div class="flex flex-col md:flex-row justify-between items-center gap-3">
                <div class="flex items-center gap-3 cursor-pointer select-none w-full md:w-auto justify-between" onclick="location.reload()">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-torii-gate text-3xl text-white"></i>
                        <div>
                            <h1 class="text-lg md:text-xl font-bold uppercase tracking-wider">AzaKanji Tango</h1>
                            <p class="text-[10px] md:text-xs text-indigo-200">Ngày 2: Động từ & Sinh hoạt</p>
                        </div>
                    </div>
                    <div class="md:hidden text-xs font-semibold bg-indigo-800 px-3 py-1 rounded-full border border-indigo-500/50"><span id="headerProgress">1/87</span></div>
                </div>
                <div class="flex items-center gap-3 w-full md:w-auto">
                    <div class="flex bg-indigo-900/50 rounded-lg p-1 w-full md:w-auto overflow-x-auto no-scrollbar">
                        <button onclick="switchTab('learn')" id="tab-learn" class="tab-btn active flex-1 md:flex-none px-4 py-1.5 rounded-md text-sm font-bold transition flex items-center justify-center gap-2 whitespace-nowrap"><i class="fas fa-book-open"></i> Học Từ</button>
                        <button onclick="switchTab('quiz')" id="tab-quiz" class="tab-btn flex-1 md:flex-none px-4 py-1.5 rounded-md text-sm font-bold transition flex items-center justify-center gap-2 whitespace-nowrap"><i class="fas fa-keyboard"></i> Kiểm Tra</button>
                        <div class="w-px bg-indigo-600 mx-1"></div>
                        <button onclick="openGrammarList()" class="tab-btn flex-1 md:flex-none px-4 py-1.5 rounded-md text-sm font-bold transition flex items-center justify-center gap-2 whitespace-nowrap"><i class="fas fa-scroll"></i> Cẩm Nang</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative w-full">
        <!-- DESKTOP SIDEBAR -->
        <aside class="hidden md:flex w-72 bg-white border-r border-gray-200 flex-col z-10">
            <div class="p-4 border-b border-gray-100 bg-gray-50">
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i>
                    <input type="text" id="searchInput" placeholder="Tìm kiếm từ..." class="w-full pl-9 pr-4 py-2 bg-white border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 transition-all shadow-sm outline-none">
                </div>
            </div>
            <div id="vocabList" class="flex-1 scroller p-2 space-y-1"></div>
        </aside>

        <!-- MAIN CONTENT (LEARN MODE) -->
        <main id="learn-section" class="flex-1 overflow-y-auto scroller bg-slate-50 p-4 pb-28 w-full scroll-smooth">
            <div class="max-w-3xl mx-auto flex flex-col items-center animate-fade-in">
                <!-- Flashcard -->
                <div class="w-full bg-white rounded-2xl p-6 shadow-sm border border-gray-200 mb-6 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-indigo-50 to-pink-50 rounded-bl-full -mr-8 -mt-8 z-0 opacity-60 transition-transform group-hover:scale-110 duration-700"></div>
                    <div class="relative z-10 text-center">
                        <div class="inline-flex items-center gap-2 bg-gray-50 px-3 py-1 rounded-full mb-4 border border-gray-100">
                            <span id="wordType" class="text-[10px] font-bold uppercase text-indigo-500">VERB</span>
                            <div class="w-px h-3 bg-gray-300"></div>
                            <span class="text-[10px] text-gray-400 font-mono" id="wordIndex">#1</span>
                        </div>
                        <div class="relative inline-block mb-2">
                            <h2 id="cardKanji" class="text-5xl md:text-6xl font-bold text-gray-800 ja-text tracking-tight cursor-pointer hover:text-indigo-700 transition-colors" onclick="speakCurrent()">見ます</h2>
                            <button id="strokeBtn" onclick="openStrokeModal()" class="absolute -right-10 top-2 w-8 h-8 bg-pink-100 text-pink-600 rounded-full flex items-center justify-center shadow-sm hover:bg-pink-200 hover:scale-110 transition-all hidden" title="Tập viết">
                                <i class="fas fa-pen-nib text-sm"></i>
                            </button>
                        </div>
                        <div class="flex flex-col items-center gap-1 cursor-pointer" onclick="speakCurrent()">
                            <span id="cardFurigana" class="text-xl text-indigo-600 font-medium ja-text">みます</span>
                            <span id="cardMeaning" class="text-lg text-gray-500 font-medium">xem</span>
                        </div>
                    </div>
                </div>

                <!-- Shadowing Sentences -->
                <div class="w-full">
                    <div class="flex items-center gap-2 mb-4 px-1">
                        <div class="bg-pink-100 text-pink-600 p-1.5 rounded-lg text-sm"><i class="fas fa-comments"></i></div>
                        <h3 class="font-bold text-gray-700 text-lg">Hội thoại đời sống</h3>
                    </div>
                    <div id="sentenceList" class="space-y-4"></div>
                    
                    <!-- Empty State -->
                    <div id="emptyState" class="hidden flex-col items-center justify-center p-8 text-center bg-white rounded-2xl border border-dashed border-gray-300 text-gray-400">
                        <i class="fas fa-comment-dots text-4xl mb-2 text-gray-300"></i>
                        <p class="text-sm">Chưa có hội thoại mẫu cho từ này.</p>
                        <p class="text-xs text-gray-300 mt-1">(Dữ liệu đang cập nhật)</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- QUIZ MODE -->
        <div id="quiz-section" class="hidden flex-1 w-full overflow-y-auto scroller bg-slate-100 p-4 absolute inset-0 z-20">
            <div class="max-w-2xl mx-auto mt-4 md:mt-10 animate-fade-in">
                <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-200">
                    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-6 text-white flex justify-between items-center relative overflow-hidden">
                        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                        <div class="relative z-10">
                            <h2 class="text-2xl font-bold flex items-center gap-2"><i class="fas fa-graduation-cap"></i> Thử Thách</h2>
                            <p class="text-indigo-100 text-sm">Nhìn Kanji - Đoán Hiragana</p>
                        </div>
                        <div class="text-right relative z-10 bg-white/10 p-2 rounded-lg backdrop-blur-sm">
                            <div class="text-[10px] text-indigo-100 uppercase font-bold tracking-wider">Điểm số</div>
                            <div class="text-3xl font-bold font-mono" id="score-display">0</div>
                        </div>
                    </div>
                    
                    <div class="p-6 md:p-10 text-center">
                        <div class="mb-8 relative">
                            <div class="text-xs text-gray-400 mb-2 uppercase font-bold tracking-widest">Từ này đọc là gì?</div>
                            <div id="quiz-kanji" class="text-6xl ja-text font-bold text-gray-800 mb-4 transition-all inline-block"></div>
                            <div id="quiz-meaning" class="text-lg text-indigo-600 font-bold mb-2"></div>
                        </div>
                        
                        <div class="relative max-w-md mx-auto mb-8">
                            <input type="text" id="quiz-input" class="w-full text-center text-2xl p-4 border-2 border-gray-300 rounded-xl focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 outline-none transition-all ja-text placeholder:text-gray-300" placeholder="nhập hiragana..." autocomplete="off">
                        </div>
                        
                        <div id="feedback-area" class="hidden rounded-xl p-5 bg-gray-50 border border-gray-200 text-left mb-6 animate-fade-in shadow-inner">
                            <div id="feedback-title" class="font-bold text-lg mb-2 flex items-center"></div>
                            <div class="text-gray-700 mb-3 flex items-center flex-wrap gap-2">
                                Đáp án đúng: <span id="correct-answer" class="font-bold text-xl text-indigo-600 px-3 py-1 bg-white border border-indigo-100 rounded-lg ja-text shadow-sm"></span>
                                <button onclick="playQuizAudio()" class="text-gray-400 hover:text-indigo-600 transition-colors w-8 h-8 rounded-full flex items-center justify-center hover:bg-gray-200 border border-transparent hover:border-gray-300"><i class="fas fa-volume-up"></i></button>
                            </div>
                        </div>
                        
                        <div>
                            <button id="btn-check" onclick="checkAnswer()" class="w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 px-10 rounded-xl shadow-lg transition active:scale-95 text-lg flex items-center justify-center gap-2 mx-auto">
                                <i class="fas fa-check"></i> Kiểm Tra
                            </button>
                            <button id="btn-next" onclick="nextQuestion()" class="hidden w-full md:w-auto bg-gray-800 hover:bg-gray-900 text-white font-bold py-3.5 px-10 rounded-xl shadow-lg transition active:scale-95 text-lg flex items-center justify-center gap-2 mx-auto">
                                Câu Tiếp Theo <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MOBILE BOTTOM BAR -->
        <div class="fixed bottom-0 left-0 right-0 glass px-4 py-3 pb-6 z-30 flex items-center justify-between gap-4 md:hidden shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] border-t border-gray-200">
            <button onclick="prevWord()" class="w-12 h-12 rounded-xl bg-white border border-gray-200 text-gray-600 flex items-center justify-center shadow-sm active:bg-gray-50 active:scale-95 transition">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button onclick="toggleDrawer()" class="flex-1 h-12 rounded-xl bg-indigo-600 text-white font-bold flex items-center justify-center shadow-lg gap-2 active:scale-95 transition active:bg-indigo-700">
                <i class="fas fa-list-ul"></i> Danh Sách
            </button>
            <button onclick="nextWord()" class="w-12 h-12 rounded-xl bg-white border border-gray-200 text-gray-600 flex items-center justify-center shadow-sm active:bg-gray-50 active:scale-95 transition">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>

    <!-- MODAL: GRAMMAR LIST -->
    <div id="grammarListModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-gray-900/70 backdrop-blur-sm transition-opacity opacity-0" id="grammarListBackdrop" onclick="closeModal('grammarListModal')"></div>
        <div class="bg-white rounded-2xl w-full max-w-4xl relative z-10 shadow-2xl transform transition-all scale-95 opacity-0 flex flex-col max-h-[85vh]" id="grammarListPanel">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-indigo-50 rounded-t-2xl">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-600 text-white p-2 rounded-lg shadow-sm"><i class="fas fa-book"></i></div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-800">Cẩm Nang Ngữ Pháp</h3>
                        <p class="text-xs text-gray-500">Thư viện ngữ pháp Day 2 (N5 - N1)</p>
                    </div>
                </div>
                <button onclick="closeModal('grammarListModal')" class="w-8 h-8 rounded-full hover:bg-white flex items-center justify-center text-gray-500 transition-colors"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto scroller bg-slate-50">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="grammarGrid"></div>
            </div>
            <div class="p-4 border-t border-gray-100 bg-white rounded-b-2xl flex justify-end">
                <button onclick="closeModal('grammarListModal')" class="px-6 py-2 bg-gray-800 text-white font-bold rounded-full text-sm transition active:scale-95 shadow-lg hover:bg-gray-700">Đã Hiểu</button>
            </div>
        </div>
    </div>

    <!-- MODAL: GRAMMAR DETAIL -->
    <div id="detailGrammarModal" class="fixed inset-0 z-[90] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity opacity-0" id="detailGrammarBackdrop" onclick="closeModal('detailGrammarModal')"></div>
        <div class="bg-white rounded-2xl w-full max-w-md relative z-10 shadow-2xl transform transition-all scale-95 opacity-0 flex flex-col" id="detailGrammarPanel">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 rounded-t-2xl">
                <div class="flex items-center gap-2">
                    <div class="bg-indigo-100 p-1.5 rounded-lg text-indigo-600"><i class="fas fa-info-circle"></i></div>
                    <h3 class="text-lg font-bold text-gray-800">Giải thích Ngữ pháp</h3>
                </div>
                <button onclick="closeModal('detailGrammarModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6">
                <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-3 text-center mb-4 shadow-sm">
                    <code class="text-lg font-bold text-indigo-700 font-mono" id="dgFormula"></code>
                </div>
                <div id="dgExplanation" class="text-gray-600 text-sm mb-4 space-y-3 leading-relaxed"></div>
            </div>
        </div>
    </div>

    <!-- MODAL: KANJI STROKE -->
    <div id="strokeModal" class="fixed inset-0 z-[80] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-gray-900/80 backdrop-blur-sm transition-opacity opacity-0" id="strokeBackdrop" onclick="closeModal('strokeModal')"></div>
        <div class="bg-white rounded-2xl w-full max-w-5xl relative z-10 shadow-2xl transform transition-all scale-95 opacity-0 flex flex-col max-h-[90vh]" id="strokePanel">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-pink-50 rounded-t-2xl">
                <h3 class="text-lg font-bold text-pink-700 flex items-center gap-2"><i class="fas fa-pen-nib"></i> Tập Viết & Chi Tiết Kanji</h3>
                <button onclick="closeModal('strokeModal')" class="w-8 h-8 rounded-full hover:bg-white flex items-center justify-center text-gray-500 transition-colors"><i class="fas fa-times text-lg"></i></button>
            </div>
            <div class="p-6 overflow-y-auto scroller bg-slate-50 flex-1">
                <div id="strokeTabs" class="flex justify-center gap-2 mb-6 flex-wrap"></div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="flex flex-col gap-6 text-center">
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 relative">
                            <p class="text-xs text-gray-400 mb-2 font-bold uppercase tracking-wider">Mô phỏng nét viết</p>
                            <div id="strokeAnimContainer" class="w-48 h-48 mx-auto bg-white border border-gray-300 relative stroke-grid-box flex items-center justify-center rounded-lg cursor-pointer" onclick="replayStrokeAnimation()"></div>
                            <button onclick="replayStrokeAnimation()" class="absolute top-4 right-4 bg-pink-50 text-pink-600 w-8 h-8 rounded-full flex items-center justify-center hover:bg-pink-100 transition shadow-sm z-10"><i class="fas fa-redo text-sm"></i></button>
                            <p class="text-[10px] text-gray-400 mt-2">Nhấn vào ô để chạy lại</p>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 text-left">
                            <p class="text-xs text-gray-400 mb-3 font-bold uppercase tracking-wider text-center">Thứ tự từng nét</p>
                            <div id="strokeGridContainer" class="flex flex-wrap gap-2 justify-center"></div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200 flex flex-col h-full text-left">
                        <div id="kanjiDetailContent">
                            <div class="flex items-center justify-between mb-6 border-b border-gray-100 pb-4">
                                <div><h2 id="detailKanji" class="text-6xl font-bold text-gray-800 ja-text mb-1 leading-none"></h2><div class="text-xs font-bold bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded inline-block mt-2" id="detailHanViet"></div></div>
                                <div class="text-right"><div class="text-2xl font-bold text-gray-600 capitalize" id="detailMeaning"></div></div>
                            </div>
                            <!-- Radicals -->
                            <div class="mb-4 bg-indigo-50 p-3 rounded-lg border border-indigo-100">
                                <span class="text-xs font-bold text-indigo-500 uppercase block mb-1"><i class="fas fa-layer-group mr-1"></i> Bộ thủ (Thành phần)</span>
                                <span class="text-sm font-medium text-indigo-900" id="detailRadicals">...</span>
                            </div>
                            <!-- On/Kun -->
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <div class="bg-slate-50 p-3 rounded-lg border border-slate-100 flex justify-between items-center group cursor-pointer" onclick="document.getElementById('btnPlayOn').click()"><div class="flex flex-col"><span class="text-xs font-bold text-gray-400 uppercase">On</span><span class="text-lg font-bold text-indigo-600 ja-text" id="detailOn"></span></div><button id="btnPlayOn" class="text-indigo-300 group-hover:text-indigo-600"><i class="fas fa-volume-up"></i></button></div>
                                <div class="bg-slate-50 p-3 rounded-lg border border-slate-100 flex justify-between items-center group cursor-pointer" onclick="document.getElementById('btnPlayKun').click()"><div class="flex flex-col"><span class="text-xs font-bold text-gray-400 uppercase">Kun</span><span class="text-lg font-bold text-pink-600 ja-text" id="detailKun"></span></div><button id="btnPlayKun" class="text-pink-300 group-hover:text-pink-600"><i class="fas fa-volume-up"></i></button></div>
                            </div>
                            <!-- Tips -->
                            <div class="space-y-4 mb-6">
                                <div class="bg-green-50 p-4 rounded-lg border border-green-100">
                                    <h4 class="text-sm font-bold text-green-800 mb-2 flex items-center gap-2"><i class="fas fa-image"></i> Ghi nhớ hình ảnh</h4>
                                    <p class="text-sm text-green-700 leading-relaxed" id="detailTipImg"></p>
                                </div>
                                <div class="bg-orange-50 p-4 rounded-lg border border-orange-100">
                                    <h4 class="text-sm font-bold text-orange-800 mb-2 flex items-center gap-2"><i class="fas fa-music"></i> Mẹo nhớ âm thanh</h4>
                                    <div class="space-y-2">
                                        <p class="text-sm text-orange-700 flex items-start gap-2"><span class="font-bold text-[10px] bg-orange-200 px-1.5 py-0.5 rounded text-orange-800 min-w-[30px] text-center mt-0.5">ON</span> <span id="detailTipSoundOn"></span></p>
                                        <p class="text-sm text-orange-700 flex items-start gap-2"><span class="font-bold text-[10px] bg-pink-200 px-1.5 py-0.5 rounded text-pink-800 min-w-[30px] text-center mt-0.5">KUN</span> <span id="detailTipSoundKun"></span></p>
                                    </div>
                                </div>
                            </div>
                            <!-- Related Words -->
                            <div>
                                <h4 class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-3">Từ vựng liên quan</h4>
                                <div class="space-y-2" id="detailWords"></div>
                            </div>
                        </div>
                        <div id="kanjiDetailEmpty" class="hidden h-full flex flex-col items-center justify-center text-center p-4 text-gray-400"><i class="fas fa-book-open text-4xl mb-3 opacity-30"></i><p class="text-sm">Chưa có dữ liệu chi tiết cho chữ Hán này.</p></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. GRAMMAR REPO (N5 - N1) ---
        const grammarRepo = {
            "ni_iku": { title: "Đi để làm gì (Mục đích)", formula: "V(bỏ masu) / N + に 行く/来る", desc: "N4: Chỉ mục đích của chuyển động.", ex: "映画を見に行きます。" },
            "mashou_ka": { title: "Lời mời/Đề nghị", formula: "Vましょうか", desc: "N5: Rủ rê cùng làm hoặc đề nghị giúp đỡ.", ex: "手伝いましょうか。" },
            "ta_form": { title: "Thể quá khứ ngắn", formula: "Vた", desc: "N5: Dùng trong văn nói thân mật để hỏi hoặc kể lại việc đã qua.", ex: "もうご飯食べた？" },
            "te_kudasai": { title: "Yêu cầu lịch sự", formula: "Vてください", desc: "N5: Xin hãy làm V.", ex: "書いてください。" },
            "koto_ni_naru": { title: "Quyết định (Khách quan)", formula: "Vる + ことになる", desc: "N3: Được quyết định là, trở thành quy định (không do ý chí bản thân).", ex: "来週、日本へ行くことになりました。" },
            "nakucha": { title: "Phải làm (Văn nói)", formula: "Vなくちゃ (Vなければなりません)", desc: "N3: Dạng rút gọn của 'phải làm gì đó' trong hội thoại.", ex: "もう行かなくちゃ。" },
            "you_ni": { title: "Cố gắng làm gì", formula: "Vる + ようにする", desc: "N3: Biểu thị sự nỗ lực, cố gắng tạo thói quen.", ex: "毎日日本語を話すようにしています。" },
            "te_shimau": { title: "Hoàn thành/Lỡ làm", formula: "Vてしまう (Vちゃう)", desc: "N4: Làm xong hết hoặc lỡ làm điều không mong muốn.", ex: "宿題を忘れてしまった。" },
            "zaru_wo_enai": { title: "Đành phải", formula: "Vない(bỏ nai) + ざるを得ない", desc: "N2: Không muốn nhưng buộc phải làm.", ex: "嫌だが、行かざるを得ない。" },
            "yara_yara": { title: "Liệt kê (Nào là... nào là...)", formula: "AやらBやら", desc: "N2: Liệt kê ví dụ (thường hàm ý nhiều, lộn xộn).", ex: "宿題やらバイトやらで忙しい。" },
            "mono_da": { title: "Hồi tưởng quá khứ", formula: "Vた + ものだ", desc: "N2: Nhớ lại thói quen trong quá khứ với cảm xúc.", ex: "子供の頃、よくこの公園で遊んだものだ。" },
            "tara_dou": { title: "Lời khuyên", formula: "Vたらどうですか", desc: "N4: Thử làm V xem sao?", ex: "先生に聞いたらどうですか。" },
            "temo": { title: "Cho dù", formula: "Vても", desc: "N4: Dù làm V thì kết quả vẫn vậy.", ex: "高くても買います。" },
            "yaru": { title: "Làm/Cho (người dưới)", formula: "Vやる", desc: "N4: Làm cho động vật, cây cối hoặc người dưới.", ex: "花に水をやる。" },
            "kan": { title: "Cảm giác", formula: "N + 感", desc: "N3/N2: Cảm giác về cái gì đó.", ex: "責任感 (Tinh thần trách nhiệm)." },
            "nagara": { title: "Vừa... vừa...", formula: "V(bỏ masu) + ながら", desc: "N4: Thực hiện 2 hành động cùng lúc.", ex: "音楽を聞きながら勉強します。" },
            "te_morau": { title: "Được ai làm cho", formula: "Vてもらう", desc: "N4: Biết ơn vì được ai đó làm gì cho.", ex: "友達に本を貸してもらった。" },
            "shi_shi": { title: "Liệt kê lý do", formula: "～し、～し", desc: "N4: Vừa thế này, vừa thế kia (dẫn đến kết luận).", ex: "頭もいいし、親切だし、彼が好きだ。" },
            "hazug": { title: "Chắc chắn là", formula: "V/A/N + はずだ", desc: "N3: Phán đoán dựa trên căn cứ logic.", ex: "彼は今日来るはずだ。" },
            "datte": { title: "Nghe nói là (Văn nói)", formula: "～だって", desc: "N3/N2: Trích dẫn lại lời nghe được (thân mật).", ex: "明日雨だって。" },
            "koto_wa_nai": { title: "Không cần phải", formula: "Vる + ことはない", desc: "N2: Không cần thiết làm V.", ex: "心配することはないよ。" },
            "hodo": { title: "Đến mức", formula: "V/N + ほど", desc: "N3: So sánh mức độ.", ex: "死ぬほど疲れた。" },
            "volitional": { title: "Thể ý định", formula: "Vよう", desc: "N4: Cùng làm nhé / Định làm gì.", ex: "帰ろう！ (Về thôi!)" },
            "te_kuru": { title: "Thay đổi theo hướng về mình", formula: "Vてくる", desc: "N4: Hành động hướng về phía người nói.", ex: "犬が走ってきた。" },
            "tai": { title: "Mong muốn", formula: "Vたい", desc: "N5: Muốn làm gì đó.", ex: "日本へ行きたい。" },
            "te_iru": { title: "Trạng thái/Thói quen", formula: "Vている", desc: "N5/N4: Đang diễn ra hoặc là thói quen lặp lại.", ex: "毎日走っています。" }
        };

        // --- 2. VOCABULARY DATA (Full Day 2 with RICH Context) ---
        const vocabData = [
            { "STT": 1, "Kanji": "見ます", "Nghĩa": "xem, nhìn", "Furigana": "みます", "type": "verb", "conv": { "polite": "週末、映画を見に行きませんか。", "pVi": "Cuối tuần bạn có muốn đi xem phim không?", "casual": "週末、映画見に行かない？", "cVi": "Cuối tuần đi xem phim hông?", "gIds": ["ni_iku", "mashou_ka"] } },
            { "STT": 2, "Kanji": "聞きます", "Nghĩa": "nghe", "Furigana": "ききます", "type": "verb", "conv": { "polite": "先生に詳しいことを聞きました。", "pVi": "Tôi đã hỏi giáo viên chi tiết.", "casual": "先生に詳しいこと聞いたよ。", "cVi": "Tớ hỏi thầy chi tiết rồi.", "gIds": ["ta_form"] } },
            { "STT": 3, "Kanji": "読みます", "Nghĩa": "đọc", "Furigana": "よみます", "type": "verb", "conv": { "polite": "この本を読んでみてください。", "pVi": "Hãy thử đọc quyển sách này xem.", "casual": "この本、読んでみて。", "cVi": "Đọc thử quyển này xem.", "gIds": ["te_kudasai", "tara_dou"] } },
            { "STT": 4, "Kanji": "書きます", "Nghĩa": "viết", "Furigana": "かきます", "type": "verb", "conv": { "polite": "ここに名前を書いてください。", "pVi": "Xin hãy viết tên vào đây.", "casual": "ここに名前書いて。", "cVi": "Viết tên vào đây đi.", "gIds": ["te_kudasai"] } },
            { "STT": 5, "Kanji": "します", "Nghĩa": "làm", "Furigana": "します", "type": "verb", "conv": { "polite": "週末は何をしますか。", "pVi": "Cuối tuần bạn sẽ làm gì?", "casual": "週末、何する？", "cVi": "Cuối tuần làm gì?", "gIds": ["volitional"] } },
            { "STT": 6, "Kanji": "来ます", "Nghĩa": "đến", "Furigana": "きます", "type": "verb", "conv": { "polite": "また遊びに来てくださいね。", "pVi": "Hãy lại đến chơi nhé.", "casual": "また遊びに来てね。", "cVi": "Lại đến chơi nha.", "gIds": ["te_kudasai"] } },
            { "STT": 7, "Kanji": "行きます", "Nghĩa": "đi", "Furigana": "いきます", "type": "verb", "conv": { "polite": "もう行かなくてはいけません。", "pVi": "Tôi phải đi bây giờ.", "casual": "もう行かなくちゃ。", "cVi": "Phải đi rồi.", "gIds": ["nakucha"] } },
            { "STT": 8, "Kanji": "帰ります", "Nghĩa": "về", "Furigana": "かえります", "type": "verb", "conv": { "polite": "そろそろ失礼します。帰ります。", "pVi": "Tôi xin phép. Tôi về đây ạ.", "casual": "そろそろ帰るよ。", "cVi": "Tớ về đây.", "gIds": ["volitional"] } },
            { "STT": 9, "Kanji": "遊びます", "Nghĩa": "chơi", "Furigana": "あそびます", "type": "verb", "conv": { "polite": "子供の頃、よくこの公園で遊びました。", "pVi": "Hồi nhỏ tôi thường chơi ở công viên này.", "casual": "子供の頃、よくここで遊んだものだ。", "cVi": "Hồi nhỏ hay chơi ở đây ghê.", "gIds": ["mono_da"] } },
            { "STT": 10, "Kanji": "持ちます", "Nghĩa": "cầm, mang", "Furigana": "もちます", "type": "verb", "conv": { "polite": "荷物を持ちましょうか。", "pVi": "Để tôi mang hành lý giúp nhé?", "casual": "荷物、持とうか？", "cVi": "Để tớ xách cho nhé?", "gIds": ["mashou_ka", "volitional"] } },
            { "STT": 11, "Kanji": "運びます", "Nghĩa": "vận chuyển", "Furigana": "はこびます", "type": "verb", "conv": { "polite": "この机を運ぶのを手伝ってください。", "pVi": "Xin hãy giúp tôi chuyển cái bàn này.", "casual": "これ運ぶの手伝って。", "cVi": "Giúp tớ khiêng cái này với.", "gIds": ["te_kudasai"] } },
            { "STT": 12, "Kanji": "買います", "Nghĩa": "mua", "Furigana": "かいます", "type": "verb", "conv": { "polite": "高くても、必要な本なら買います。", "pVi": "Dù đắt nhưng nếu là sách cần thiết tôi sẽ mua.", "casual": "高くても、必要なら買うよ。", "cVi": "Đắt mấy mà cần thì vẫn mua.", "gIds": ["temo"] } },
            { "STT": 13, "Kanji": "売ります", "Nghĩa": "bán", "Furigana": "うります", "type": "verb", "conv": { "polite": "この店では古い本を売っています。", "pVi": "Cửa hàng này có bán sách cũ.", "casual": "ここ、古い本売ってるよ。", "cVi": "Chỗ này bán sách cũ đấy.", "gIds": ["te_kuru"] } },
            { "STT": 14, "Kanji": "払います", "Nghĩa": "thanh toán", "Furigana": "はらいます", "type": "verb", "conv": { "polite": "カードで払うことはできますか。", "pVi": "Tôi có thể trả bằng thẻ không?", "casual": "カードで払える？", "cVi": "Trả thẻ được không?", "gIds": ["mashou_ka"] } },
            { "STT": 15, "Kanji": "乗ります", "Nghĩa": "lên xe", "Furigana": "のります", "type": "verb", "conv": { "polite": "バスに乗って会社へ行きます。", "pVi": "Tôi lên xe buýt đi đến công ty.", "casual": "バスに乗って会社行く。", "cVi": "Bắt xe buýt đi làm.", "gIds": ["te_kudasai"] } },
            { "STT": 16, "Kanji": "降ります", "Nghĩa": "xuống xe", "Furigana": "おります", "type": "verb", "conv": { "polite": "次の駅で降ります。", "pVi": "Tôi sẽ xuống ở ga tiếp theo.", "casual": "次の駅で降りる。", "cVi": "Xuống ga sau nhé.", "gIds": ["volitional"] } },
            { "STT": 17, "Kanji": "入ります", "Nghĩa": "vào", "Furigana": "はいります", "type": "verb", "conv": { "polite": "どうぞ、中に入ってください。", "pVi": "Xin mời vào trong.", "casual": "中に入って。", "cVi": "Vào trong đi.", "gIds": ["te_kudasai"] } },
            { "STT": 18, "Kanji": "出ます", "Nghĩa": "ra, rời khỏi", "Furigana": "でます", "type": "verb", "conv": { "polite": "会議に出なくてはいけません。", "pVi": "Tôi phải tham dự cuộc họp.", "casual": "会議に出なくちゃ。", "cVi": "Phải đi họp đây.", "gIds": ["nakucha"] } },
            { "STT": 19, "Kanji": "開けます", "Nghĩa": "mở", "Furigana": "あけます", "type": "verb", "conv": { "polite": "暑いですから、窓を開けましょうか。", "pVi": "Nóng quá, tôi mở cửa sổ nhé?", "casual": "暑いから、窓開けようか？", "cVi": "Nóng nhỉ, mở cửa sổ hông?", "gIds": ["mashou_ka", "volitional"] } },
            { "STT": 20, "Kanji": "閉めます", "Nghĩa": "đóng", "Furigana": "しめます", "type": "verb", "conv": { "polite": "ドアを閉めてください。", "pVi": "Xin hãy đóng cửa lại.", "casual": "ドア閉めて。", "cVi": "Đóng cửa lại đi.", "gIds": ["te_kudasai"] } },
            { "STT": 21, "Kanji": "覚えます", "Nghĩa": "nhớ", "Furigana": "おぼえます", "type": "verb", "conv": { "polite": "毎日単語を覚えるようにしています。", "pVi": "Tôi đang cố gắng nhớ từ vựng mỗi ngày.", "casual": "毎日単語覚えるようにしてる。", "cVi": "Ngày nào tớ cũng cố học từ vựng.", "gIds": ["you_ni"] } },
            { "STT": 22, "Kanji": "忘れます", "Nghĩa": "quên", "Furigana": "わすれます", "type": "verb", "conv": { "polite": "パスポートを忘れないでください。", "pVi": "Xin đừng quên hộ chiếu.", "casual": "パスポート忘れないでね。", "cVi": "Đừng quên hộ chiếu đấy.", "gIds": ["te_kudasai"] } },
            { "STT": 23, "Kanji": "送ります", "Nghĩa": "gửi/tiễn", "Furigana": "おくります", "type": "verb", "conv": { "polite": "後でメールを送ります。", "pVi": "Lát nữa tôi sẽ gửi email.", "casual": "後でメール送るね。", "cVi": "Tí tớ gửi mail cho.", "gIds": ["volitional"] } },
            { "STT": 24, "Kanji": "迎えます", "Nghĩa": "đón", "Furigana": "むかえます", "type": "verb", "conv": { "polite": "空港へ友達を迎えに行きます。", "pVi": "Tôi đi ra sân bay đón bạn.", "casual": "空港へ友達迎えに行く。", "cVi": "Ra sân bay đón bạn đây.", "gIds": ["ni_iku"] } },
            { "STT": 25, "Kanji": "貸します", "Nghĩa": "cho mượn", "Furigana": "かします", "type": "verb", "conv": { "polite": "ペンを貸してくださいませんか。", "pVi": "Có thể cho tôi mượn bút không?", "casual": "ペン貸して。", "cVi": "Cho mượn cái bút đi.", "gIds": ["te_kudasai"] } },
            { "STT": 26, "Kanji": "借ります", "Nghĩa": "mượn", "Furigana": "かります", "type": "verb", "conv": { "polite": "図書館で本を借りました。", "pVi": "Tôi đã mượn sách ở thư viện.", "casual": "図書館で本借りたよ。", "cVi": "Tớ mượn sách ở thư viện rồi.", "gIds": ["ta_form"] } },
            { "STT": 27, "Kanji": "教えます", "Nghĩa": "dạy/chỉ", "Furigana": "おしえます", "type": "verb", "conv": { "polite": "日本語を教えていただきませんか。", "pVi": "Bạn có thể dạy tiếng Nhật cho tôi không?", "casual": "日本語教えて。", "cVi": "Dạy tiếng Nhật cho tớ đi.", "gIds": ["te_kudasai"] } },
            { "STT": 28, "Kanji": "習います", "Nghĩa": "học (có người dạy)", "Furigana": "ならいます", "type": "verb", "conv": { "polite": "ピアノを習いたいですが、時間がありません。", "pVi": "Tôi muốn học piano nhưng không có thời gian.", "casual": "ピアノ習いたいけど、時間がない。", "cVi": "Muốn học piano mà không có thời gian.", "gIds": ["tai"] } },
            { "STT": 29, "Kanji": "あげます", "Nghĩa": "tặng/cho", "Furigana": "あげます", "type": "verb", "conv": { "polite": "母に花をあげました。", "pVi": "Tôi đã tặng hoa cho mẹ.", "casual": "母に花あげたよ。", "cVi": "Tớ tặng hoa cho mẹ rồi.", "gIds": ["ta_form"] } },
            { "STT": 30, "Kanji": "くれます", "Nghĩa": "cho (tôi)", "Furigana": "くれます", "type": "verb", "conv": { "polite": "部長がプレゼントをくださいました。", "pVi": "Trưởng phòng đã tặng quà cho tôi (kính ngữ).", "casual": "彼がプレゼントくれた！", "cVi": "Anh ấy tặng quà cho tớ!", "gIds": ["ta_form"] } },
            { "STT": 31, "Kanji": "もらいます", "Nghĩa": "nhận", "Furigana": "もらいます", "type": "verb", "conv": { "polite": "先生に本をもらいました。", "pVi": "Tôi đã nhận sách từ thầy giáo.", "casual": "先生に本もらった。", "cVi": "Tớ được thầy cho sách.", "gIds": ["ta_form", "te_morau"] } },
            { "STT": 32, "Kanji": "言います", "Nghĩa": "nói", "Furigana": "いいます", "type": "verb", "conv": { "polite": "もう一度言ってください。", "pVi": "Xin hãy nói lại lần nữa.", "casual": "もう一回言って。", "cVi": "Nói lại lần nữa đi.", "gIds": ["te_kudasai"] } },
            { "STT": 33, "Kanji": "伝えます", "Nghĩa": "truyền đạt", "Furigana": "つたえます", "type": "verb", "conv": { "polite": "社長に伝えておきます。", "pVi": "Tôi sẽ nhắn lại với giám đốc.", "casual": "社長に伝えとくよ。", "cVi": "Để tớ nhắn lại với sếp.", "gIds": ["te_kudasai"] } },
            { "STT": 34, "Kanji": "始めます", "Nghĩa": "bắt đầu", "Furigana": "はじめます", "type": "verb", "conv": { "polite": "会議を始めましょう。", "pVi": "Chúng ta bắt đầu họp nào.", "casual": "会議始めよう。", "cVi": "Họp thôi nào.", "gIds": ["mashou_ka", "volitional"] } },
            { "STT": 35, "Kanji": "終わります", "Nghĩa": "kết thúc", "Furigana": "おわります", "type": "verb", "conv": { "polite": "仕事がやっと終わりました。", "pVi": "Cuối cùng công việc cũng xong.", "casual": "仕事やっと終わった。", "cVi": "Cuối cùng cũng xong việc.", "gIds": ["ta_form"] } },
            { "STT": 36, "Kanji": "考えます", "Nghĩa": "suy nghĩ", "Furigana": "かんがえます", "type": "verb", "conv": { "polite": "よく考えてから返事します。", "pVi": "Tôi sẽ suy nghĩ kỹ rồi trả lời.", "casual": "よく考えてから返事する。", "cVi": "Để nghĩ kỹ rồi trả lời sau.", "gIds": ["te_kudasai"] } },
            { "STT": 37, "Kanji": "思います", "Nghĩa": "nghĩ", "Furigana": "おもいます", "type": "verb", "conv": { "polite": "彼は来ないと思います。", "pVi": "Tôi nghĩ anh ấy sẽ không đến.", "casual": "彼は来ないと思う。", "cVi": "Tớ nghĩ hắn không đến đâu.", "gIds": ["volitional"] } },
            { "STT": 38, "Kanji": "います", "Nghĩa": "có (người)", "Furigana": "います", "type": "verb", "conv": { "polite": "あそこに田中さんがいます。", "pVi": "Anh Tanaka ở đằng kia.", "casual": "あそこに田中さんいるよ。", "cVi": "Tanaka ở đằng kia kìa.", "gIds": ["ta_form"] } },
            { "STT": 39, "Kanji": "あります", "Nghĩa": "có (vật)", "Furigana": "あります", "type": "verb", "conv": { "polite": "質問があります。", "pVi": "Tôi có câu hỏi.", "casual": "質問ある？", "cVi": "Có câu hỏi gì không?", "gIds": ["ta_form"] } },
            { "STT": 40, "Kanji": "待ちます", "Nghĩa": "đợi", "Furigana": "まちます", "type": "verb", "conv": { "polite": "ここで待っています。", "pVi": "Tôi sẽ đợi ở đây.", "casual": "ここで待ってる。", "cVi": "Tớ đợi ở đây.", "gIds": ["te_kudasai"] } },
            { "STT": 41, "Kanji": "さん", "Nghĩa": "anh/chị", "Furigana": "さん", "type": "noun", "conv": { "polite": "田中さんは明日休みだそうです。", "pVi": "Nghe nói anh Tanaka mai nghỉ.", "casual": "田中さん、明日休みだって。", "cVi": "Nghe bảo mai Tanaka nghỉ.", "gIds": ["datte"] } },
            { "STT": 42, "Kanji": "ちゃん", "Nghĩa": "bé (gái)", "Furigana": "ちゃん", "type": "noun", "conv": { "polite": "花子ちゃんは元気ですか。", "pVi": "Bé Hanako có khỏe không?", "casual": "花子ちゃん、元気？", "cVi": "Bé Hanako khỏe không?", "gIds": ["ta_form"] } },
            { "STT": 43, "Kanji": "くん", "Nghĩa": "bé (trai)", "Furigana": "くん", "type": "noun", "conv": { "polite": "太郎くんは小学生です。", "pVi": "Bé Taro là học sinh tiểu học.", "casual": "太郎くんは小学生だよ。", "cVi": "Taro là học sinh tiểu học đấy.", "gIds": ["ta_form"] } },
            { "STT": 44, "Kanji": "先生", "Nghĩa": "giáo viên", "Furigana": "せんせい", "type": "noun", "conv": { "polite": "先生に聞いたらどうですか。", "pVi": "Bạn thử hỏi giáo viên xem sao?", "casual": "先生に聞いたらどう？", "cVi": "Thử hỏi thầy xem sao?", "gIds": ["tara_dou"] } },
            { "STT": 45, "Kanji": "教師", "Nghĩa": "giáo viên (nghề)", "Furigana": "きょうし", "type": "noun", "conv": { "polite": "彼は日本語の教師です。", "pVi": "Anh ấy là giáo viên tiếng Nhật.", "casual": "彼は日本語の教師だよ。", "cVi": "Anh ấy là giáo viên tiếng Nhật đấy.", "gIds": ["ta_form"] } },
            { "STT": 46, "Kanji": "学生", "Nghĩa": "học sinh", "Furigana": "がくせい", "type": "noun", "conv": { "polite": "私は学生です。", "pVi": "Tôi là sinh viên.", "casual": "私は学生だよ。", "cVi": "Tớ là sinh viên.", "gIds": ["ta_form"] } },
            { "STT": 47, "Kanji": "会社員", "Nghĩa": "nhân viên", "Furigana": "かいしゃいん", "type": "noun", "conv": { "polite": "父は会社員です。", "pVi": "Bố tôi là nhân viên công ty.", "casual": "父は会社員だよ。", "cVi": "Bố tớ là nhân viên công ty.", "gIds": ["ta_form"] } },
            { "STT": 48, "Kanji": "医者", "Nghĩa": "bác sĩ", "Furigana": "いしゃ", "type": "noun", "conv": { "polite": "医者に行かなくてはいけません。", "pVi": "Tôi phải đi khám bác sĩ.", "casual": "医者に行かなくちゃ。", "cVi": "Phải đi bác sĩ thôi.", "gIds": ["nakucha"] } },
            { "STT": 49, "Kanji": "警察官", "Nghĩa": "cảnh sát", "Furigana": "けいさつかん", "type": "noun", "conv": { "polite": "警察官に道を聞きました。", "pVi": "Tôi đã hỏi đường cảnh sát.", "casual": "警察官に道聞いた。", "cVi": "Tớ hỏi đường cảnh sát rồi.", "gIds": ["ta_form"] } },
            { "STT": 50, "Kanji": "エンジニア", "Nghĩa": "kỹ sư", "Furigana": "エンジニア", "type": "noun", "conv": { "polite": "私はエンジニアとして働いています。", "pVi": "Tôi đang làm việc với tư cách kỹ sư.", "casual": "エンジニアとして働いてるよ。", "cVi": "Tớ đang làm kỹ sư.", "gIds": ["te_kuru"] } },
            { "STT": 51, "Kanji": "銀行員", "Nghĩa": "nhân viên NH", "Furigana": "ぎんこういん", "type": "noun", "conv": { "polite": "彼女は銀行員です。", "pVi": "Cô ấy là nhân viên ngân hàng.", "casual": "彼女は銀行員だよ。", "cVi": "Cô ấy là nhân viên ngân hàng đấy.", "gIds": ["ta_form"] } },
            { "STT": 52, "Kanji": "実習生", "Nghĩa": "thực tập sinh", "Furigana": "じっしゅうせい", "type": "noun", "conv": { "polite": "ベトナムからの実習生です。", "pVi": "Là thực tập sinh đến từ Việt Nam.", "casual": "ベトナムからの実習生だよ。", "cVi": "Là thực tập sinh Việt Nam đấy.", "gIds": ["ta_form"] } },
            { "STT": 53, "Kanji": "留学生", "Nghĩa": "du học sinh", "Furigana": "りゅうがくせい", "type": "noun", "conv": { "polite": "留学生が増えています。", "pVi": "Du học sinh đang tăng lên.", "casual": "留学生が増えてるね。", "cVi": "Du học sinh tăng lên nhỉ.", "gIds": ["te_kuru"] } },
            { "STT": 54, "Kanji": "ベトナム", "Nghĩa": "Việt Nam", "Furigana": "ベトナム", "type": "noun", "conv": { "polite": "ベトナムへ行ったことがありますか。", "pVi": "Bạn đã từng đến Việt Nam chưa?", "casual": "ベトナム行ったことある？", "cVi": "Đã đi Việt Nam bao giờ chưa?", "gIds": ["ta_form"] } },
            { "STT": 55, "Kanji": "日本", "Nghĩa": "Nhật Bản", "Furigana": "にほん", "type": "noun", "conv": { "polite": "日本へ行きたいです。", "pVi": "Tôi muốn đi Nhật.", "casual": "日本へ行きたい。", "cVi": "Muốn đi Nhật ghê.", "gIds": ["tai"] } },
            { "STT": 56, "Kanji": "中国", "Nghĩa": "Trung Quốc", "Furigana": "ちゅうごく", "type": "noun", "conv": { "polite": "中国は広いです。", "pVi": "Trung Quốc rất rộng.", "casual": "中国は広いね。", "cVi": "Trung Quốc rộng thật.", "gIds": ["ta_form"] } },
            { "STT": 57, "Kanji": "韓国", "Nghĩa": "Hàn Quốc", "Furigana": "かんこく", "type": "noun", "conv": { "polite": "韓国ドラマが好きです。", "pVi": "Tôi thích phim Hàn Quốc.", "casual": "韓国ドラマが好き。", "cVi": "Tớ thích phim Hàn.", "gIds": ["ta_form"] } },
            { "STT": 58, "Kanji": "トイレ", "Nghĩa": "nhà vệ sinh", "Furigana": "トイレ", "type": "noun", "conv": { "polite": "トイレに行ってもいいですか。", "pVi": "Tôi đi vệ sinh được không?", "casual": "トイレ行ってもいい？", "cVi": "Đi vệ sinh được không?", "gIds": ["te_kudasai"] } },
            { "STT": 59, "Kanji": "時計", "Nghĩa": "đồng hồ", "Furigana": "とけい", "type": "noun", "conv": { "polite": "素敵な時計ですね。", "pVi": "Đồng hồ đẹp quá nhỉ.", "casual": "素敵な時計だね。", "cVi": "Đồng hồ đẹp thế.", "gIds": ["ta_form"] } },
            { "STT": 60, "Kanji": "そうです", "Nghĩa": "đúng vậy", "Furigana": "そうです", "type": "phrase", "conv": { "polite": "はい、そうです。", "pVi": "Vâng, đúng vậy ạ.", "casual": "うん、そうだよ。", "cVi": "Ừ, đúng rồi.", "gIds": ["ta_form"] } },
            { "STT": 61, "Kanji": "違います", "Nghĩa": "sai rồi", "Furigana": "ちがいます", "type": "phrase", "conv": { "polite": "いいえ、違います。", "pVi": "Không, nhầm rồi ạ.", "casual": "ううん、違うよ。", "cVi": "Không, nhầm rồi.", "gIds": ["ta_form"] } },
            { "STT": 62, "Kanji": "ご飯", "Nghĩa": "cơm", "Furigana": "ごはん", "type": "noun", "conv": { "polite": "ご飯を食べに行きませんか。", "pVi": "Đi ăn cơm không?", "casual": "ご飯食べに行かない？", "cVi": "Đi ăn cơm hông?", "gIds": ["ni_iku", "mashou_ka"] } },
            { "STT": 63, "Kanji": "肉", "Nghĩa": "thịt", "Furigana": "にく", "type": "noun", "conv": { "polite": "私は肉が好きです。", "pVi": "Tôi thích thịt.", "casual": "私は肉が好き。", "cVi": "Tớ thích thịt.", "gIds": ["ta_form"] } },
            { "STT": 64, "Kanji": "パン", "Nghĩa": "bánh mì", "Furigana": "パン", "type": "noun", "conv": { "polite": "パンを食べながら歩きます。", "pVi": "Tôi vừa đi vừa ăn bánh mì.", "casual": "パン食べながら歩く。", "cVi": "Vừa đi vừa gặm bánh mì.", "gIds": ["nagara"] } },
            { "STT": 65, "Kanji": "卵", "Nghĩa": "trứng", "Furigana": "たまご", "type": "noun", "conv": { "polite": "卵を割ってしまいました。", "pVi": "Tôi lỡ làm vỡ trứng rồi.", "casual": "卵割っちゃった。", "cVi": "Lỡ làm vỡ trứng rồi.", "gIds": ["te_shimau"] } },
            { "STT": 66, "Kanji": "野菜", "Nghĩa": "rau", "Furigana": "やさい", "type": "noun", "conv": { "polite": "野菜を食べたほうがいいですよ。", "pVi": "Nên ăn rau thì hơn.", "casual": "野菜食べたほうがいいよ。", "cVi": "Ăn rau đi thì hơn.", "gIds": ["ta_form"] } },
            { "STT": 67, "Kanji": "スープ", "Nghĩa": "súp", "Furigana": "スープ", "type": "noun", "conv": { "polite": "温かいスープを飲みましょう。", "pVi": "Cùng uống súp nóng nào.", "casual": "温かいスープ飲もう。", "cVi": "Uống súp nóng đi.", "gIds": ["mashou_ka", "volitional"] } },
            { "STT": 68, "Kanji": "料理", "Nghĩa": "món ăn", "Furigana": "りょうり", "type": "noun", "conv": { "polite": "料理を作ってもらいました。", "pVi": "Tôi được (ai đó) nấu ăn cho.", "casual": "料理作ってもらった。", "cVi": "Được nấu ăn cho nè.", "gIds": ["te_morau"] } },
            { "STT": 69, "Kanji": "水", "Nghĩa": "nước", "Furigana": "みず", "type": "noun", "conv": { "polite": "お水をください。", "pVi": "Cho tôi xin nước.", "casual": "水ちょうだい。", "cVi": "Cho xin ít nước.", "gIds": ["te_kudasai"] } },
            { "STT": 70, "Kanji": "ビール", "Nghĩa": "bia", "Furigana": "ビール", "type": "noun", "conv": { "polite": "ビールを飲みましょう。", "pVi": "Uống bia nào.", "casual": "ビール飲もう。", "cVi": "Uống bia đi.", "gIds": ["mashou_ka", "volitional"] } },
            { "STT": 71, "Kanji": "牛乳", "Nghĩa": "sữa bò", "Furigana": "ぎゅうにゅう", "type": "noun", "conv": { "polite": "牛乳を買わなくてはいけません。", "pVi": "Tôi phải mua sữa.", "casual": "牛乳買わなくちゃ。", "cVi": "Phải mua sữa thôi.", "gIds": ["nakucha"] } },
            { "STT": 72, "Kanji": "映画", "Nghĩa": "phim", "Furigana": "えいが", "type": "noun", "conv": { "polite": "映画を見に行きましょう。", "pVi": "Cùng đi xem phim nào.", "casual": "映画見に行こう。", "cVi": "Đi xem phim đi.", "gIds": ["ni_iku", "volitional"] } },
            { "STT": 73, "Kanji": "スポーツ", "Nghĩa": "thể thao", "Furigana": "スポーツ", "type": "noun", "conv": { "polite": "スポーツをしましょう。", "pVi": "Cùng chơi thể thao nào.", "casual": "スポーツしよう。", "cVi": "Chơi thể thao đi.", "gIds": ["mashou_ka", "volitional"] } },
            { "STT": 74, "Kanji": "サッカー", "Nghĩa": "bóng đá", "Furigana": "サッカー", "type": "noun", "conv": { "polite": "サッカーを見に行きます。", "pVi": "Tôi đi xem bóng đá.", "casual": "サッカー見に行く。", "cVi": "Đi xem bóng đá đây.", "gIds": ["ni_iku"] } },
            { "STT": 75, "Kanji": "野球", "Nghĩa": "bóng chày", "Furigana": "やきゅう", "type": "noun", "conv": { "polite": "野球の試合があります。", "pVi": "Có trận đấu bóng chày.", "casual": "野球の試合あるよ。", "cVi": "Có trận bóng chày đấy.", "gIds": ["ta_form"] } },
            { "STT": 76, "Kanji": "パーティー", "Nghĩa": "bữa tiệc", "Furigana": "パーティー", "type": "noun", "conv": { "polite": "パーティーに行かざるを得ない。", "pVi": "Đành phải đi dự tiệc (dù không muốn).", "casual": "パーティー行かなきゃなんない。", "cVi": "Phải đi ăn tiệc rồi.", "gIds": ["zaru_wo_enai"] } },
            { "STT": 77, "Kanji": "宿題", "Nghĩa": "bài tập", "Furigana": "しゅくだい", "type": "noun", "conv": { "polite": "宿題やらレポートやらで忙しいです。", "pVi": "Bận tối mắt vì nào bài tập, nào báo cáo.", "casual": "宿題やらレポートやらで忙しい。", "cVi": "Bận sấp mặt vì bài tập với báo cáo.", "gIds": ["yara_yara"] } },
            { "STT": 78, "Kanji": "作ります", "Nghĩa": "làm, chế tạo", "Furigana": "つくります", "type": "verb", "conv": { "polite": "ケーキを作りました。", "pVi": "Tôi đã làm bánh kem.", "casual": "ケーキ作ったよ。", "cVi": "Tớ làm bánh kem rồi.", "gIds": ["ta_form"] } },
            { "STT": 79, "Kanji": "語", "Nghĩa": "tiếng", "Furigana": "ご", "type": "noun", "conv": { "polite": "何語を話せますか。", "pVi": "Bạn nói được tiếng gì?", "casual": "何語話せる？", "cVi": "Nói được tiếng gì?", "gIds": ["ta_form"] } },
            { "STT": 80, "Kanji": "英語", "Nghĩa": "tiếng Anh", "Furigana": "えいご", "type": "noun", "conv": { "polite": "英語を話せるようになりたいです。", "pVi": "Tôi muốn trở nên nói được tiếng Anh.", "casual": "英語話せるようになりたい。", "cVi": "Muốn nói được tiếng Anh ghê.", "gIds": ["tai", "you_ni"] } },
            { "STT": 81, "Kanji": "たくさん", "Nghĩa": "nhiều", "Furigana": "たくさん", "type": "adverb", "conv": { "polite": "死ぬほどたくさん食べました。", "pVi": "Tôi đã ăn nhiều muốn chết.", "casual": "死ぬほどたくさん食べた。", "cVi": "Ăn nhiều muốn chết luôn.", "gIds": ["hodo"] } },
            { "STT": 82, "Kanji": "少し", "Nghĩa": "một chút", "Furigana": "すこし", "type": "adverb", "conv": { "polite": "少し休んだらどうですか。", "pVi": "Bạn nghỉ một chút xem sao?", "casual": "少し休んだら？", "cVi": "Nghỉ chút đi?", "gIds": ["tara_dou"] } },
            { "STT": 83, "Kanji": "全然", "Nghĩa": "hoàn toàn (không)", "Furigana": "ぜんぜん", "type": "adverb", "conv": { "polite": "心配することはありません。全然大丈夫です。", "pVi": "Không cần phải lo lắng. Hoàn toàn ổn ạ.", "casual": "心配することないよ。全然平気。", "cVi": "Khỏi lo. Ổn cả mà.", "gIds": ["koto_wa_nai"] } },
            { "STT": 84, "Kanji": "朝", "Nghĩa": "buổi sáng", "Furigana": "あさ", "type": "noun", "conv": { "polite": "朝はパンと決めています。", "pVi": "Sáng nào tôi cũng quyết định ăn bánh mì (thói quen).", "casual": "朝はパンって決めてる。", "cVi": "Sáng là cứ phải bánh mì.", "gIds": ["te_iru"] } },
            { "STT": 85, "Kanji": "今朝", "Nghĩa": "sáng nay", "Furigana": "けさ", "type": "noun", "conv": { "polite": "今朝は寒かったですね。", "pVi": "Sáng nay lạnh nhỉ.", "casual": "今朝は寒かったね。", "cVi": "Sáng nay lạnh ghê.", "gIds": ["ta_form"] } },
            { "STT": 86, "Kanji": "昼", "Nghĩa": "buổi trưa", "Furigana": "ひる", "type": "noun", "conv": { "polite": "昼ごはんを食べに行きましょう。", "pVi": "Cùng đi ăn trưa nào.", "casual": "昼ごはん食べに行こう。", "cVi": "Đi ăn trưa đi.", "gIds": ["ni_iku", "volitional"] } },
            { "STT": 87, "Kanji": "夕方", "Nghĩa": "chiều tối", "Furigana": "ゆうがた", "type": "noun", "conv": { "polite": "夕方から雨が降るそうです。", "pVi": "Nghe nói chiều tối trời mưa.", "casual": "夕方から雨だって。", "cVi": "Nghe bảo chiều tối mưa đấy.", "gIds": ["datte"] } }
        ];

        // --- 3. KANJI DETAILS (Tips & Mnemonics) ---
        const kanjiDetails = {
            "見": { hanviet: "KIẾN", mean: "Nhìn", on: "ケン", kun: "み.る", radicals: "Mục (目)", tipImg: "Mắt (目) mọc chân (儿) để đi nhìn.", tipSoundOn: "**Ken** kiến trúc sư đang nhìn.", tipSoundKun: "**Mi** nhìn mi kìa.", words: [{w:"見学",m:"Tham quan"}, {w:"意見",m:"Ý kiến"}] },
            "聞": { hanviet: "VĂN", mean: "Nghe", on: "ブン", kun: "き.く", radicals: "Môn (門) + Nhĩ (耳)", tipImg: "Ghé tai (耳) vào cổng (門) để nghe.", tipSoundOn: "**Bun** văn chương.", tipSoundKun: "**Ki** nghe kỹ.", words: [{w:"新聞",m:"Tờ báo"}] },
            "読": { hanviet: "ĐỘC", mean: "Đọc", on: "ドク", kun: "よ.む", radicals: "Ngôn (言) + Mại (売)", tipImg: "Nói (言) lời bán (売) sách để đọc.", tipSoundOn: "**Doku** độc dược.", tipSoundKun: "**Yo** đọc vô.", words: [{w:"読書",m:"Việc đọc sách"}] },
            "書": { hanviet: "THƯ", mean: "Viết", on: "ショ", kun: "か.く", radicals: "Duật (聿) + Nhật (日)", tipImg: "Tay cầm bút viết hàng ngày (日).", tipSoundOn: "**Sho** thư ký.", tipSoundKun: "**Ka** viết ca khúc.", words: [{w:"辞書",m:"Từ điển"}] },
            "来": { hanviet: "LAI", mean: "Đến", on: "ライ", kun: "く.る", radicals: "Mộc (木)", tipImg: "Người đến nấp sau cây (木).", tipSoundOn: "**Rai** tương lai.", tipSoundKun: "**Ku** đến khu này.", words: [{w:"来月",m:"Tháng sau"}, {w:"未来",m:"Tương lai"}] },
            "行": { hanviet: "HÀNH", mean: "Đi", on: "コウ", kun: "い.く", radicals: "Hành (行)", tipImg: "Ngã tư đường để đi.", tipSoundOn: "**Kou** ngân hàng.", tipSoundKun: "**I** đi í ới.", words: [{w:"銀行",m:"Ngân hàng"}, {w:"旅行",m:"Du lịch"}] },
            "帰": { hanviet: "QUY", mean: "Về", on: "キ", kun: "かえ.る", radicals: "Đao (刂)", tipImg: "Cầm dao (刂) đi về nhà.", tipSoundOn: "**Ki** quy hồi.", tipSoundKun: "**Kae** về kẻo muộn.", words: [{w:"帰国",m:"Về nước"}] },
            "遊": { hanviet: "DU", mean: "Chơi", on: "ユウ", kun: "あそ.ぶ", radicals: "Xước (⻌) + Phương (方)", tipImg: "Trẻ con đi chơi khắp phương trời.", tipSoundOn: "**Yuu** du lịch.", tipSoundKun: "**Aso** đi chơi a.", words: [{w:"遊園地",m:"Công viên giải trí"}] },
            "持": { hanviet: "TRÌ", mean: "Cầm", on: "ジ", kun: "も.つ", radicals: "Thủ (扌) + Tự (寺)", tipImg: "Tay (扌) cầm đồ vào chùa (寺).", tipSoundOn: "**Ji** duy trì.", tipSoundKun: "**Mo** cầm mỏ lết.", words: [{w:"気持ち",m:"Cảm giác"}] },
            "運": { hanviet: "VẬN", mean: "Vận chuyển", on: "ウン", kun: "はこ.ぶ", radicals: "Xước (⻌) + Quân (軍)", tipImg: "Xe quân đội (軍) đang vận chuyển.", tipSoundOn: "**Un** vận may.", tipSoundKun: "**Hako** cái hộp.", words: [{w:"運動",m:"Vận động"}] },
            "買": { hanviet: "MÃI", mean: "Mua", on: "バイ", kun: "か.う", radicals: "Võng (罒) + Bối (貝)", tipImg: "Dùng lưới (罒) bắt tiền (貝) đi mua.", tipSoundOn: "**Bai** mãi mãi.", tipSoundKun: "**Ka** mua cà.", words: [{w:"買い物",m:"Mua sắm"}] },
            "売": { hanviet: "MẠI", mean: "Bán", on: "バイ", kun: "う.る", radicals: "Sĩ (士) + Quan (冖) + Nhân (儿)", tipImg: "Kẻ sĩ (士) đội mũ bán hàng.", tipSoundOn: "**Bai** thương mại.", tipSoundKun: "**U** bán ưu đãi.", words: [{w:"売店",m:"Quầy bán hàng"}] },
            "払": { hanviet: "PHẤT", mean: "Trả", on: "フツ", kun: "はら.う", radicals: "Thủ (扌) + Tư (厶)", tipImg: "Tay (扌) gạt tư lợi (厶) để trả tiền.", tipSoundOn: "**Futsu** phất.", tipSoundKun: "**Hara** trả hết.", words: [{w:"支払い",m:"Thanh toán"}] },
            "乗": { hanviet: "THỪA", mean: "Lên xe", on: "ジョウ", kun: "の.る", radicals: "Thiên (千) + Mộc (木)", tipImg: "Ngồi trên cây (木) như lên xe.", tipSoundOn: "**Jou** thượng thừa.", tipSoundKun: "**No** nó lên xe.", words: [{w:"乗車",m:"Lên xe"}] },
            "降": { hanviet: "GIÁNG", mean: "Xuống", on: "コウ", kun: "お.りる", radicals: "Ấp (阝)", tipImg: "Đi bộ xuống dốc.", tipSoundOn: "**Kou** giáng trần.", tipSoundKun: "**O** xuống ô tô.", words: [{w:"降雨",m:"Mưa rơi"}] },
            "入": { hanviet: "NHẬP", mean: "Vào", on: "ニュウ", kun: "はい.る", radicals: "Nhập (入)", tipImg: "Người đi vào cửa.", tipSoundOn: "**Nyuu** nhập khẩu.", tipSoundKun: "**Hai** hái lộc vào nhà.", words: [{w:"入口",m:"Lối vào"}] },
            "出": { hanviet: "XUẤT", mean: "Ra", on: "シュツ", kun: "で.る", radicals: "Khảm (凵)", tipImg: "Hai ngọn núi chồng lên nhau.", tipSoundOn: "**Shutsu** xuất khẩu.", tipSoundKun: "**De** đi ra đê.", words: [{w:"出口",m:"Lối ra"}] },
            "開": { hanviet: "KHAI", mean: "Mở", on: "カイ", kun: "あ.ける", radicals: "Môn (門)", tipImg: "Hai tay mở cổng (門).", tipSoundOn: "**Kai** khai mạc.", tipSoundKun: "**A** mở a ra.", words: [{w:"開店",m:"Mở cửa hàng"}] },
            "閉": { hanviet: "BẾ", mean: "Đóng", on: "ヘイ", kun: "し.める", radicals: "Môn (門) + Tài (才)", tipImg: "Đóng cửa (門) tài năng (才).", tipSoundOn: "**Hei** bế mạc.", tipSoundKun: "**Shi** đóng lại đi.", words: [{w:"閉会",m:"Bế mạc"}] },
            "覚": { hanviet: "GIÁC", mean: "Nhớ", on: "カク", kun: "おぼ.える", radicals: "Kiến (見)", tipImg: "Học nhìn (見) để nhớ.", tipSoundOn: "**Kaku** cảm giác.", tipSoundKun: "**Obo** ồ bố nhớ rồi.", words: [{w:"感覚",m:"Cảm giác"}] },
            "忘": { hanviet: "VONG", mean: "Quên", on: "ボウ", kun: "わす.れる", radicals: "Tâm (心) + Vong (亡)", tipImg: "Tim (心) chết (亡) là quên.", tipSoundOn: "**Bou** vong mạng.", tipSoundKun: "**Wasu** quên wa.", words: [{w:"忘年会",m:"Tiệc tất niên"}] },
            "送": { hanviet: "TỐNG", mean: "Gửi", on: "ソウ", kun: "おく.る", radicals: "Xước (⻌)", tipImg: "Người đi (⻌) tiễn đưa.", tipSoundOn: "**Sou** tống giam.", tipSoundKun: "**Oku** gửi okurimono.", words: [{w:"送料",m:"Phí gửi"}] },
            "迎": { hanviet: "NGHÊNH", mean: "Đón", on: "ゲイ", kun: "むか.える", radicals: "Xước (⻌)", tipImg: "Người đi (⻌) đón chào.", tipSoundOn: "**Gei** nghênh tiếp.", tipSoundKun: "**Muka** đón mukaeru.", words: [{w:"歓迎",m:"Hoan nghênh"}] },
            "貸": { hanviet: "THẢI", mean: "Cho mượn", on: "タイ", kun: "か.す", radicals: "Bối (貝) + Đại (代)", tipImg: "Tiền (貝) thay thế (代) cho vay.", tipSoundOn: "**Tai** cho vay tiền.", tipSoundKun: "**Ka** cho mượn ca.", words: [{w:"貸借",m:"Vay mượn"}] },
            "借": { hanviet: "TÁ", mean: "Mượn", on: "シャク", kun: "か.りる", radicals: "Nhân (亻) + Tích (昔)", tipImg: "Người (亻) xưa (昔) đi vay.", tipSoundOn: "**Shaku** tá điền.", tipSoundKun: "**Ka** mượn cà.", words: [{w:"借金",m:"Tiền nợ"}] },
            "教": { hanviet: "GIÁO", mean: "Dạy", on: "キョウ", kun: "おし.える", radicals: "Phộc (攵)", tipImg: "Cầm roi dạy trẻ hiếu thảo.", tipSoundOn: "**Kyou** giáo dục.", tipSoundKun: "**Oshi** ô xin dạy.", words: [{w:"教育",m:"Giáo dục"}] },
            "習": { hanviet: "TẬP", mean: "Học", on: "シュウ", kun: "なら.う", radicals: "Vũ (羽) + Bạch (白)", tipImg: "Chim trắng (白) tập bay (羽).", tipSoundOn: "**Shuu** tập san.", tipSoundKun: "**Nara** học nà.", words: [{w:"練習",m:"Luyện tập"}] },
            "言": { hanviet: "NGÔN", mean: "Nói", on: "ゲン", kun: "い.う", radicals: "Ngôn (言)", tipImg: "Mồm nói ra lời.", tipSoundOn: "**Gen** ngôn ngữ.", tipSoundKun: "**I** nói ít thôi.", words: [{w:"言葉",m:"Từ vựng"}] },
            "伝": { hanviet: "TRUYỀN", mean: "Truyền", on: "デン", kun: "つた.える", radicals: "Nhân (亻) + Vân (云)", tipImg: "Người (亻) nói chuyện mây (云) trôi.", tipSoundOn: "**Den** truyền điện.", tipSoundKun: "**Tsuta** thư tá.", words: [{w:"伝説",m:"Truyền thuyết"}] },
            "始": { hanviet: "THỦY", mean: "Bắt đầu", on: "シ", kun: "はじ.める", radicals: "Nữ (女) + Thai (台)", tipImg: "Người nữ (女) bắt đầu lên đài (台).", tipSoundOn: "**Shi** thủy tổ.", tipSoundKun: "**Haji** haji mê.", words: [{w:"開始",m:"Bắt đầu"}] },
            "終": { hanviet: "CHUNG", mean: "Kết thúc", on: "シュウ", kun: "お.わる", radicals: "Mịch (糸) + Đông (冬)", tipImg: "Sợi chỉ (糸) mùa đông (冬) là kết thúc.", tipSoundOn: "**Shuu** chung kết.", tipSoundKun: "**O** xong rồi ố.", words: [{w:"終了",m:"Kết thúc"}] },
            "考": { hanviet: "KHẢO", mean: "Suy nghĩ", on: "コウ", kun: "かんが.える", radicals: "Lão (耂)", tipImg: "Người già (耂) suy nghĩ.", tipSoundOn: "**Kou** khảo sát.", tipSoundKun: "**Kanga** căng quá.", words: [{w:"参考",m:"Tham khảo"}] },
            "思": { hanviet: "TƯ", mean: "Nghĩ", on: "シ", kun: "おも.う", radicals: "Tâm (心) + Điền (田)", tipImg: "Ruộng (田) trong tim (心) là tương tư.", tipSoundOn: "**Shi** suy tư.", tipSoundKun: "**Omo** ô mô.", words: [{w:"思い出",m:"Kỷ niệm"}] },
            "待": { hanviet: "ĐÃI", mean: "Đợi", on: "タイ", kun: "ま.つ", radicals: "Xích (彳) + Tự (寺)", tipImg: "Đứng (彳) ở chùa (寺) đợi.", tipSoundOn: "**Tai** chiêu đãi.", tipSoundKun: "**Ma** ma cứ đợi.", words: [{w:"招待",m:"Chiêu đãi"}] },
            "先": { hanviet: "TIÊN", mean: "Trước", on: "セン", kun: "さき", radicals: "Nhân (儿)", tipImg: "Người đi trước.", tipSoundOn: "**Sen** tiên sinh.", tipSoundKun: "**Saki** saki đi trước.", words: [{w:"先月",m:"Tháng trước"}] },
            "生": { hanviet: "SINH", mean: "Sinh", on: "セイ", kun: "い.きる", radicals: "Sinh (生)", tipImg: "Cây nảy mầm.", tipSoundOn: "**Sei** học sinh.", tipSoundKun: "**I** sinh sống.", words: [{w:"生活",m:"Cuộc sống"}] },
            "師": { hanviet: "SƯ", mean: "Thầy", on: "シ", kun: "", radicals: "Cân (巾)", tipImg: "Thầy giáo cầm khăn.", tipSoundOn: "**Shi** sư phụ.", tipSoundKun: "", words: [{w:"医師",m:"Bác sĩ"}] },
            "学": { hanviet: "HỌC", mean: "Học", on: "ガク", kun: "まな.ぶ", radicals: "Tử (子)", tipImg: "Trẻ con đội mũ đi học.", tipSoundOn: "**Gaku** đại học.", tipSoundKun: "**Mana** học mana.", words: [{w:"学生",m:"Học sinh"}] },
            "会": { hanviet: "HỘI", mean: "Gặp", on: "カイ", kun: "あ.う", radicals: "Nhân (人)", tipImg: "Mọi người (人) gặp nhau dưới mái nhà.", tipSoundOn: "**Kai** hội họp.", tipSoundKun: "**A** a gặp rồi.", words: [{w:"会話",m:"Hội thoại"}] },
            "社": { hanviet: "XÃ", mean: "Xã hội", on: "シャ", kun: "やしろ", radicals: "Kỳ (礻)", tipImg: "Thần đất xã hội.", tipSoundOn: "**Sha** xã hội.", tipSoundKun: "**Yashiro** đền.", words: [{w:"社会",m:"Xã hội"}] },
            "員": { hanviet: "VIÊN", mean: "Thành viên", on: "イン", kun: "", radicals: "Khẩu (口) + Bối (貝)", tipImg: "Nhân viên đếm tiền.", tipSoundOn: "**In** nhân viên.", tipSoundKun: "", words: [{w:"社員",m:"Nhân viên công ty"}] },
            "医": { hanviet: "Y", mean: "Y học", on: "イ", kun: "", radicals: "Dậu (酉)", tipImg: "Mũi tên trong hộp y tế.", tipSoundOn: "**I** y học.", tipSoundKun: "", words: [{w:"医院",m:"Phòng khám"}] },
            "者": { hanviet: "GIẢ", mean: "Người", on: "シャ", kun: "もの", radicals: "Lão (耂)", tipImg: "Người già.", tipSoundOn: "**Sha** tác giả.", tipSoundKun: "**Mono** kẻ đó.", words: [{w:"若者",m:"Người trẻ"}] },
            "警": { hanviet: "CẢNH", mean: "Cảnh sát", on: "ケイ", kun: "", radicals: "Ngôn (言) + Kính (敬)", tipImg: "Lời nói kính trọng cảnh sát.", tipSoundOn: "**Kei** cảnh sát.", tipSoundKun: "", words: [{w:"警察",m:"Cảnh sát"}] },
            "察": { hanviet: "SÁT", mean: "Quan sát", on: "サツ", kun: "", radicals: "Miên (宀) + Tế (祭)", tipImg: "Cúng tế trong nhà để quan sát.", tipSoundOn: "**Satsu** cảnh sát.", tipSoundKun: "", words: [{w:"観察",m:"Quan sát"}] },
            "官": { hanviet: "QUAN", mean: "Quan chức", on: "カン", kun: "", radicals: "Miên (宀)", tipImg: "Quan đội mũ trong nhà.", tipSoundOn: "**Kan** quan chức.", tipSoundKun: "", words: [{w:"警官",m:"Cảnh sát viên"}] },
            "銀": { hanviet: "NGÂN", mean: "Bạc", on: "ギン", kun: "", radicals: "Kim (金) + Cấn (艮)", tipImg: "Vàng tốt là bạc.", tipSoundOn: "**Gin** ngân hàng.", tipSoundKun: "", words: [{w:"銀行",m:"Ngân hàng"}] },
            "実": { hanviet: "THỰC", mean: "Thực tế", on: "ジツ", kun: "み", radicals: "Miên (宀)", tipImg: "Quả thật trong nhà.", tipSoundOn: "**Jitsu** sự thật.", tipSoundKun: "**Mi** quả.", words: [{w:"事実",m:"Sự thật"}] },
            "留": { hanviet: "LƯU", mean: "Lưu lại", on: "リュウ", kun: "と.める", radicals: "Điền (田)", tipImg: "Ở lại ruộng.", tipSoundOn: "**Ryuu** du học.", tipSoundKun: "**To** dừng lại.", words: [{w:"留学",m:"Du học"}] },
            "日": { hanviet: "NHẬT", mean: "Ngày", on: "ニチ", kun: "ひ", radicals: "Nhật (日)", tipImg: "Mặt trời.", tipSoundOn: "**Nichi** chủ nhật.", tipSoundKun: "**Hi** hi hi.", words: [{w:"日曜日",m:"Chủ nhật"}] },
            "本": { hanviet: "BẢN", mean: "Sách/Gốc", on: "ホン", kun: "もと", radicals: "Mộc (木)", tipImg: "Gạch gốc cây (木).", tipSoundOn: "**Hon** hòn bản.", tipSoundKun: "**Moto** mô tô.", words: [{w:"日本",m:"Nhật Bản"}] },
            "中": { hanviet: "TRUNG", mean: "Trong", on: "チュウ", kun: "なか", radicals: "Côn (丨)", tipImg: "Ở giữa.", tipSoundOn: "**Chuu** trung tâm.", tipSoundKun: "**Naka** bên trong.", words: [{w:"中心",m:"Trung tâm"}] },
            "国": { hanviet: "QUỐC", mean: "Nước", on: "コク", kun: "くに", radicals: "Vi (囗)", tipImg: "Vua giữ ngọc trong nước.", tipSoundOn: "**Koku** quốc gia.", tipSoundKun: "**Kuni** đất nước.", words: [{w:"外国",m:"Nước ngoài"}] },
            "韓": { hanviet: "HÀN", mean: "Hàn Quốc", on: "カン", kun: "", radicals: "Vi (韋)", tipImg: "Hàn Quốc.", tipSoundOn: "**Kan** Hàn Quốc.", tipSoundKun: "", words: [{w:"韓国",m:"Hàn Quốc"}] },
            "時": { hanviet: "THỜI", mean: "Thời gian", on: "ジ", kun: "とき", radicals: "Nhật (日) + Tự (寺)", tipImg: "Mặt trời mọc ở chùa đúng giờ.", tipSoundOn: "**Ji** thời gian.", tipSoundKun: "**Toki** khi.", words: [{w:"時間",m:"Thời gian"}] },
            "計": { hanviet: "KẾ", mean: "Đo", on: "ケイ", kun: "はか.る", radicals: "Ngôn (言) + Thập (十)", tipImg: "Lời nói mười lần là kế hoạch.", tipSoundOn: "**Kei** kế hoạch.", tipSoundKun: "**Haka** đo lường.", words: [{w:"計画",m:"Kế hoạch"}] },
            "違": { hanviet: "VI", mean: "Sai/Khác", on: "イ", kun: "ちが.う", radicals: "Xước (⻌) + Vi (韋)", tipImg: "Đi trái đường.", tipSoundOn: "**I** vi phạm.", tipSoundKun: "**Chiga** sai rồi.", words: [{w:"違反",m:"Vi phạm"}] },
            "飯": { hanviet: "PHẠN", mean: "Cơm", on: "ハン", kun: "めし", radicals: "Thực (饣) + Phản (反)", tipImg: "Ăn lại cơm.", tipSoundOn: "**Han** cơm.", tipSoundKun: "**Meshi** cơm.", words: [{w:"夕飯",m:"Cơm tối"}] },
            "肉": { hanviet: "NHỤC", mean: "Thịt", on: "ニク", kun: "", radicals: "Nhục (肉)", tipImg: "Miếng thịt.", tipSoundOn: "**Niku** thịt.", tipSoundKun: "", words: [{w:"牛肉",m:"Thịt bò"}] },
            "卵": { hanviet: "NOÃN", mean: "Trứng", on: "ラン", kun: "たまご", radicals: "Tiết (卩)", tipImg: "Hai quả trứng.", tipSoundOn: "**Ran** noãn.", tipSoundKun: "**Tamago** trứng.", words: [{w:"卵焼き",m:"Trứng rán"}] },
            "野": { hanviet: "DÃ", mean: "Cánh đồng", on: "ヤ", kun: "の", radicals: "Lý (里)", tipImg: "Làng quê có cánh đồng.", tipSoundOn: "**Ya** bóng chày.", tipSoundKun: "**No** cánh đồng.", words: [{w:"野球",m:"Bóng chày"}] },
            "菜": { hanviet: "THÁI", mean: "Rau", on: "サイ", kun: "な", radicals: "Thảo (艹)", tipImg: "Hái rau ngoài đồng.", tipSoundOn: "**Sai** rau.", tipSoundKun: "**Na** rau cải.", words: [{w:"野菜",m:"Rau"}] },
            "料": { hanviet: "LIỆU", mean: "Nguyên liệu", on: "リョウ", kun: "", radicals: "Mễ (米) + Đấu (斗)", tipImg: "Đong gạo làm nguyên liệu.", tipSoundOn: "**Ryou** liệu.", tipSoundKun: "", words: [{w:"料金",m:"Phí"}] },
            "理": { hanviet: "LÝ", mean: "Lý lẽ", on: "リ", kun: "", radicals: "Vương (王)", tipImg: "Vua có lý lẽ.", tipSoundOn: "**Ri** lý do.", tipSoundKun: "", words: [{w:"理由",m:"Lý do"}] },
            "水": { hanviet: "THỦY", mean: "Nước", on: "スイ", kun: "みず", radicals: "Thủy (水)", tipImg: "Dòng nước chảy.", tipSoundOn: "**Sui** thủy lợi.", tipSoundKun: "**Mizu** nước.", words: [{w:"水泳",m:"Bơi lội"}] },
            "牛": { hanviet: "NGƯU", mean: "Bò", on: "ギュウ", kun: "うし", radicals: "Ngưu (牛)", tipImg: "Con bò có sừng.", tipSoundOn: "**Gyuu** ngưu.", tipSoundKun: "**Ushi** bò.", words: [{w:"牛乳",m:"Sữa bò"}] },
            "乳": { hanviet: "NHŨ", mean: "Sữa", on: "ニュウ", kun: "ちち", radicals: "Ất (乙)", tipImg: "Chim cho con bú sữa.", tipSoundOn: "**Nyuu** sữa.", tipSoundKun: "**Chichi** vú.", words: [{w:"母乳",m:"Sữa mẹ"}] },
            "映": { hanviet: "ÁNH", mean: "Chiếu", on: "エイ", kun: "うつ.る", radicals: "Nhật (日)", tipImg: "Nắng chiếu giữa nhà.", tipSoundOn: "**Ei** điện ảnh.", tipSoundKun: "**Utsu** phản chiếu.", words: [{w:"映画",m:"Phim"}] },
            "画": { hanviet: "HỌA", mean: "Vẽ", on: "ガ", kun: "", radicals: "Điền (田)", tipImg: "Vẽ ruộng.", tipSoundOn: "**Ga** họa sĩ.", tipSoundKun: "", words: [{w:"画家",m:"Họa sĩ"}] },
            "球": { hanviet: "CẦU", mean: "Quả bóng", on: "キュウ", kun: "たま", radicals: "Vương (王) + Cầu (求)", tipImg: "Vua cầu xin quả bóng.", tipSoundOn: "**Kyuu** địa cầu.", tipSoundKun: "**Tama** bóng.", words: [{w:"地球",m:"Trái đất"}] },
            "宿": { hanviet: "TÚC", mean: "Trọ", on: "シュク", kun: "やど", radicals: "Miên (宀) + Nhân (亻) + Bách (百)", tipImg: "Trăm người trọ trong nhà.", tipSoundOn: "**Shuku** túc trực.", tipSoundKun: "**Yado** nhà trọ.", words: [{w:"宿題",m:"Bài tập"}] },
            "題": { hanviet: "ĐỀ", mean: "Đề bài", on: "ダイ", kun: "", radicals: "Thị (是) + Hiệt (頁)", tipImg: "Đề bài viết trên giấy.", tipSoundOn: "**Dai** vấn đề.", tipSoundKun: "", words: [{w:"問題",m:"Vấn đề"}] },
            "作": { hanviet: "TÁC", mean: "Làm", on: "サク", kun: "つく.る", radicals: "Nhân (亻)", tipImg: "Người làm việc.", tipSoundOn: "**Saku** tác phẩm.", tipSoundKun: "**Tsuku** chế tạo.", words: [{w:"作文",m:"Bài văn"}] },
            "語": { hanviet: "NGỮ", mean: "Ngôn ngữ", on: "ゴ", kun: "かた.る", radicals: "Ngôn (言) + Ngũ (五) + Khẩu (口)", tipImg: "Năm cái miệng nói ngôn ngữ.", tipSoundOn: "**Go** ngôn ngữ.", tipSoundKun: "**Kata** kể chuyện.", words: [{w:"英語",m:"Tiếng Anh"}] },
            "英": { hanviet: "ANH", mean: "Anh", on: "エイ", kun: "", radicals: "Thảo (艹) + Ương (央)", tipImg: "Cỏ mọc ở trung ương nước Anh.", tipSoundOn: "**Ei** tiếng Anh.", tipSoundKun: "", words: [{w:"英雄",m:"Anh hùng"}] },
            "少": { hanviet: "THIỂU", mean: "Ít", on: "ショウ", kun: "すこ.し", radicals: "Tiểu (小)", tipImg: "Nhỏ bé là ít.", tipSoundOn: "**Shou** thiểu số.", tipSoundKun: "**Suko** một chút.", words: [{w:"少女",m:"Thiếu nữ"}] },
            "全": { hanviet: "TOÀN", mean: "Toàn bộ", on: "ゼン", kun: "まった.く", radicals: "Nhập (入) + Vương (王)", tipImg: "Vua cai quản toàn bộ.", tipSoundOn: "**Zen** toàn bộ.", tipSoundKun: "**Matta** hoàn toàn.", words: [{w:"全部",m:"Toàn bộ"}] },
            "然": { hanviet: "NHIÊN", mean: "Nhiên", on: "ゼン", kun: "", radicals: "Hỏa (灬)", tipImg: "Tự nhiên như lửa cháy.", tipSoundOn: "**Zen** thiên nhiên.", tipSoundKun: "", words: [{w:"自然",m:"Thiên nhiên"}] },
            "朝": { hanviet: "TRIỀU", mean: "Sáng", on: "チョウ", kun: "あさ", radicals: "Nguyệt (月)", tipImg: "Mặt trăng buổi sáng sớm.", tipSoundOn: "**Chou** triều đình.", tipSoundKun: "**Asa** buổi sáng.", words: [{w:"朝食",m:"Bữa sáng"}] },
            "今": { hanviet: "KIM", mean: "Bây giờ", on: "コン", kun: "いま", radicals: "Nhân (人)", tipImg: "Bây giờ dưới mái nhà.", tipSoundOn: "**Kon** kim nay.", tipSoundKun: "**Ima** bây giờ.", words: [{w:"今日",m:"Hôm nay"}] },
            "昼": { hanviet: "TRÚ", mean: "Trưa", on: "チュウ", kun: "ひる", radicals: "Nhật (日)", tipImg: "Mặt trời buổi trưa.", tipSoundOn: "**Chuu** trú ngụ.", tipSoundKun: "**Hiru** buổi trưa.", words: [{w:"昼食",m:"Bữa trưa"}] },
            "夕": { hanviet: "TỊCH", mean: "Chiều", on: "セキ", kun: "ゆう", radicals: "Tịch (夕)", tipImg: "Trăng lưỡi liềm buổi chiều.", tipSoundOn: "**Seki** tịch dương.", tipSoundKun: "**Yuu** chiều tối.", words: [{w:"夕食",m:"Bữa tối"}] },
            "方": { hanviet: "PHƯƠNG", mean: "Hướng", on: "ホウ", kun: "かた", radicals: "Phương (方)", tipImg: "Cờ bay chỉ hướng.", tipSoundOn: "**Hou** phương hướng.", tipSoundKun: "**Kata** vị.", words: [{w:"方法",m:"Phương pháp"}] }
        };

        // --- 4. APP LOGIC (Standard Day 1 Logic) ---
        let currentIndex = 0; 
        let currentQuizItem = null; 
        let score = 0; 
        let currentStrokeSvg = null;

        function init() {
            renderList();
            renderGrammarMenu();
            loadWord(0);
            
            // Move event listeners here to ensure DOM is ready
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', e => { 
                    const t = e.target.value.toLowerCase(); 
                    document.querySelectorAll('.vocab-item').forEach(el => el.style.display = el.innerText.toLowerCase().includes(t) ? 'block' : 'none'); 
                });
            }

            const mobileSearchInput = document.getElementById('mobileSearchInput');
            if (mobileSearchInput) {
                mobileSearchInput.addEventListener('input', e => { 
                    const t = e.target.value.toLowerCase(); 
                    document.querySelectorAll('.vocab-item').forEach(el => el.style.display = el.innerText.toLowerCase().includes(t) ? 'block' : 'none'); 
                });
            }

            const quizInput = document.getElementById('quiz-input');
            if (quizInput) {
                quizInput.addEventListener('keypress', e => { if(e.key === 'Enter') checkAnswer(); });
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            document.getElementById('learn-section').classList.toggle('hidden', tab !== 'learn');
            document.getElementById('quiz-section').classList.toggle('hidden', tab !== 'quiz');
            if(tab === 'quiz') nextQuestion();
        }

        function renderList() {
            const listD = document.getElementById('vocabList'); 
            const listM = document.getElementById('mobileVocabList');
            const html = vocabData.map((item, i) => `
                <div class="vocab-item p-3 border-b hover:bg-gray-50 cursor-pointer rounded-lg mx-1 my-1" data-index="${i}" onclick="loadWord(${i}); if(window.innerWidth < 768) toggleDrawer();">
                    <div class="flex justify-between font-bold items-center">
                        <span class="text-gray-800 ja-text">${item.Kanji || item.Furigana}</span>
                        <span class="text-gray-300 text-xs font-mono">#${item.STT}</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1 truncate">${item.Nghĩa}</div>
                </div>`).join('');
            if (listD) listD.innerHTML = html;
            if (listM) listM.innerHTML = html;
        }

        function loadWord(idx) {
            currentIndex = idx; 
            const word = vocabData[idx];
            document.querySelectorAll('.vocab-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll(`.vocab-item[data-index="${idx}"]`).forEach(el => el.classList.add('active'));
            
            const activeItem = document.querySelector(`.vocab-item[data-index="${idx}"]`);
            if (activeItem) activeItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            document.getElementById('headerProgress').innerText = `${idx+1}/${vocabData.length}`;
            document.getElementById('wordIndex').innerText = `#${word.STT}`;
            document.getElementById('cardKanji').innerText = word.Kanji || word.Furigana;
            document.getElementById('cardFurigana').innerText = word.Furigana;
            document.getElementById('cardMeaning').innerText = word.Nghĩa;
            document.getElementById('wordType').innerText = word.type.toUpperCase();
            
            const hasKanji = word.Kanji && word.Kanji !== word.Furigana;
            document.getElementById('strokeBtn').classList.toggle('hidden', !hasKanji);
            
            renderShadowing(word);
        }

        function renderShadowing(word) {
            const cont = document.getElementById('sentenceList'); 
            cont.innerHTML = '';
            
            if(!word.conv) { 
                document.getElementById('emptyState').classList.remove('hidden'); 
                return; 
            }
            document.getElementById('emptyState').classList.add('hidden');
            
            const types = [
                { k:'polite', l:'Lịch sự', m:word.conv.pVi, i:'user-tie', c:'indigo' }, 
                { k:'casual', l:'Thân mật', m:word.conv.cVi, i:'comments', c:'pink' }
            ];
            
            types.forEach(t => {
                const grammarBtn = word.conv.gIds && word.conv.gIds.length > 0 
                    ? `<button onclick="openExplan('${word.conv.gIds.join(',')}')" class="text-xs text-indigo-500 hover:text-indigo-700 font-bold px-2 py-1 rounded hover:bg-indigo-50 transition"><i class="fas fa-info-circle"></i> Ngữ pháp</button>`
                    : '';

                cont.innerHTML += `
                    <div class="shadow-card bg-white rounded-2xl p-4 border border-gray-100">
                        <div class="flex justify-between border-b border-gray-100 pb-2 mb-3">
                            <div class="flex gap-2 items-center">
                                <div class="bg-${t.c}-50 p-1.5 rounded text-${t.c}-600"><i class="fas fa-${t.i}"></i></div>
                                <span class="text-xs font-bold text-gray-400 uppercase tracking-wide">${t.l}</span>
                            </div>
                            ${grammarBtn}
                        </div>
                        <div class="flex justify-between items-start gap-3">
                            <div>
                                <div class="text-lg md:text-xl ja-text font-medium text-gray-800 mb-1 cursor-pointer hover:text-indigo-600 transition-colors" onclick="speakText('${word.conv[t.k]}')">${word.conv[t.k]}</div>
                                <div class="text-sm text-gray-500 italic">${t.m}</div>
                            </div>
                            <button onclick="speakText('${word.conv[t.k]}')" class="audio-btn text-${t.c}-400 hover:text-${t.c}-600 p-2 rounded-full hover:bg-${t.c}-50 transition-colors flex-shrink-0">
                                <i class="fas fa-volume-up text-xl"></i>
                            </button>
                        </div>
                    </div>`;
            });
        }

        function openExplan(idsStr) {
            const ids = idsStr.split(','); 
            const f = document.getElementById('dgFormula'); 
            const e = document.getElementById('dgExplanation');
            
            f.innerText = ids.map(id => grammarRepo[id].formula).join("  /  ");
            e.innerHTML = ids.map(id => `
                <div class="pb-2 border-b border-gray-100 last:border-0">
                    <strong class="text-indigo-700 block mb-1">${grammarRepo[id].title} <span class="text-xs font-normal text-gray-400">(${grammarRepo[id].desc.split(':')[0]})</span></strong>
                    <p>${grammarRepo[id].desc.split(':').slice(1).join(':') || grammarRepo[id].desc}</p>
                    <p class="text-xs text-gray-400 mt-1 italic">Vd: ${grammarRepo[id].ex}</p>
                </div>`).join("");
            
            showModal('detailGrammarModal');
        }

        function renderGrammarMenu() {
            const grid = document.getElementById('grammarGrid'); 
            grid.innerHTML = '';
            Object.keys(grammarRepo).forEach(key => {
                const r = grammarRepo[key];
                grid.innerHTML += `
                    <div class="bg-white p-4 rounded-xl border border-gray-100 flex flex-col justify-between hover:shadow-md transition cursor-pointer" onclick="speakText('${r.ex}')">
                        <div>
                            <div class="font-bold text-sm text-indigo-600 mb-1 flex items-center gap-2"><i class="fas fa-tag text-xs"></i> ${r.title}</div>
                            <code class="text-xs block bg-gray-50 p-1.5 rounded mb-2 border border-gray-200 font-mono text-gray-700">${r.formula}</code>
                            <p class="text-xs text-gray-500 mb-2 line-clamp-2">${r.desc}</p>
                        </div>
                        <div class="bg-indigo-50 p-2 rounded flex justify-between items-center gap-2 mt-2">
                            <span class="text-[11px] font-medium text-indigo-800 ja-text truncate">${r.ex}</span>
                            <i class="fas fa-volume-up text-indigo-400 text-xs"></i>
                        </div>
                    </div>`;
            });
        }

        function showModal(id) { 
            const modal = document.getElementById(id);
            modal.classList.remove('hidden'); 
            setTimeout(() => { 
                document.getElementById(id.replace('Modal','Backdrop')).classList.remove('opacity-0'); 
                document.getElementById(id.replace('Modal','Panel')).classList.remove('opacity-0', 'scale-95'); 
            }, 10); 
        }
        function closeModal(id) { 
            const b = document.getElementById(id.replace('Modal','Backdrop')); 
            const p = document.getElementById(id.replace('Modal','Panel'));
            if(b) b.classList.add('opacity-0'); 
            if(p) p.classList.add('opacity-0', 'scale-95');
            setTimeout(() => document.getElementById(id).classList.add('hidden'), 200); 
        }
        function openGrammarList() { showModal('grammarListModal'); }

        async function openStrokeModal(char) {
            const word = vocabData[currentIndex]; 
            const kanjis = word.Kanji.match(/[\u4e00-\u9faf]/g) || [];
            if(kanjis.length === 0) return;
            const target = char || kanjis[0];
            const tabs = document.getElementById('strokeTabs'); 
            tabs.innerHTML = '';
            if(kanjis.length > 1) {
                kanjis.forEach(k => {
                    const b = document.createElement('button'); 
                    b.innerText = k;
                    b.className = `w-12 h-12 text-xl rounded-xl font-bold border transition ja-text ${k===target ? 'bg-pink-600 text-white border-pink-600 shadow-lg' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}`;
                    b.onclick = () => showKanjiStroke(k); 
                    tabs.appendChild(b);
                });
            }
            showModal('strokeModal'); 
            await showKanjiStroke(target);
        }

        async function showKanjiStroke(k) {
            const d = kanjiDetails[k]; 
            const c = document.getElementById('kanjiDetailContent'); 
            const e = document.getElementById('kanjiDetailEmpty');
            if(d) {
                c.classList.remove('hidden'); e.classList.add('hidden');
                document.getElementById('detailKanji').innerText = k; 
                document.getElementById('detailHanViet').innerText = d.hanviet || '?';
                document.getElementById('detailMeaning').innerText = d.mean || ''; 
                document.getElementById('detailOn').innerText = d.on || '-'; 
                document.getElementById('detailKun').innerText = d.kun || '-';
                document.getElementById('detailRadicals').innerText = d.radicals || '...';
                
                const fmt = s => s.replace(/\*\*(.*?)\*\*/g, '<span class="font-bold text-gray-900">$1</span>');
                document.getElementById('detailTipImg').innerHTML = fmt(d.tipImg || ''); 
                document.getElementById('detailTipSoundOn').innerHTML = fmt(d.tipSoundOn || ''); 
                document.getElementById('detailTipSoundKun').innerHTML = fmt(d.tipSoundKun || '');
                
                document.getElementById('btnPlayOn').onclick = () => speakText(d.on);
                document.getElementById('btnPlayKun').onclick = () => speakText(d.kun);

                const wc = document.getElementById('detailWords'); 
                wc.innerHTML = '';
                if(d.words) {
                    d.words.forEach(w => wc.innerHTML += `<div class="flex justify-between items-center bg-gray-50 p-2 rounded hover:bg-gray-100 cursor-pointer border border-transparent hover:border-gray-200 transition" onclick="speakText('${w.w}')"><span class="text-lg font-bold text-indigo-700 ja-text">${w.w}</span><span class="text-xs text-gray-500 font-medium">${w.m}</span></div>`);
                }
            } else { 
                c.classList.add('hidden'); e.classList.remove('hidden'); 
            }
            const anim = document.getElementById('strokeAnimContainer'); 
            const grid = document.getElementById('strokeGridContainer');
            anim.innerHTML = '<i class="fas fa-spinner fa-spin text-gray-300 text-2xl"></i>'; 
            grid.innerHTML = '';
            try {
                const r = await fetch(`https://cdn.jsdelivr.net/gh/KanjiVG/kanjivg/kanji/${getKanjiHex(k)}.svg`);
                if(!r.ok) throw new Error();
                const svgText = await r.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(svgText, "image/svg+xml");
                doc.querySelectorAll('path').forEach(p => p.setAttribute('style', 'opacity:0; stroke:#333; stroke-width:3; fill:none; stroke-linecap:round; stroke-linejoin:round;')); 
                anim.innerHTML = new XMLSerializer().serializeToString(doc.documentElement);
                const mainSvg = anim.querySelector('svg');
                mainSvg.setAttribute('width','100%'); mainSvg.setAttribute('height','100%');
                currentStrokeSvg = mainSvg;
                replayStrokeAnimation();
                const cleanDoc = parser.parseFromString(svgText, "image/svg+xml"); 
                cleanDoc.querySelectorAll('path').forEach((p, i) => {
                    const b = document.createElement('div'); 
                    b.className = "w-16 h-16 stroke-grid-box flex items-center justify-center rounded bg-white shadow-sm";
                    const clone = cleanDoc.documentElement.cloneNode(true);
                    clone.setAttribute('width','100%'); clone.setAttribute('height','100%');
                    clone.querySelectorAll('path').forEach((pp, idx) => {
                        pp.style.fill="none"; pp.style.strokeLinecap="round"; pp.style.strokeLinejoin="round";
                        if(idx<i) { pp.style.stroke="#e5e7eb"; pp.style.strokeWidth="3"; }
                        else if(idx===i) { pp.style.stroke="#db2777"; pp.style.strokeWidth="4"; } 
                        else pp.style.display="none";
                    });
                    b.appendChild(clone); grid.appendChild(b);
                });
            } catch(e) { anim.innerHTML = "<span class='text-xs text-red-400'>Lỗi tải nét viết</span>"; }
        }

        function replayStrokeAnimation() {
            if(!currentStrokeSvg) return;
            const paths = currentStrokeSvg.querySelectorAll('path');
            paths.forEach(p => { p.style.transition='none'; p.style.opacity='0'; });
            void currentStrokeSvg.offsetWidth;
            let delay = 0;
            paths.forEach(p => {
                const len = p.getTotalLength();
                p.style.strokeDasharray = len; p.style.strokeDashoffset = len; p.style.opacity = '1';
                setTimeout(() => { p.style.transition = `stroke-dashoffset 0.6s ease-in-out`; p.style.strokeDashoffset = '0'; }, delay * 1000);
                delay += 0.6;
            });
        }

        function getKanjiHex(k) { return k.charCodeAt(0).toString(16).padStart(5, '0'); }
        function speakText(t) { if ('speechSynthesis' in window) { const u = new SpeechSynthesisUtterance(t); u.lang = 'ja-JP'; u.rate = 0.9; speechSynthesis.speak(u); } }
        function speakCurrent() { speakText(vocabData[currentIndex].Furigana); }
        function toggleDrawer() { const d = document.getElementById('mobileDrawer'); const c = document.getElementById('drawerContent'); const b = document.getElementById('drawerBackdrop'); if(d.classList.contains('pointer-events-none')) { d.classList.remove('pointer-events-none'); c.classList.remove('-translate-x-full'); b.classList.remove('opacity-0'); } else { c.classList.add('-translate-x-full'); b.classList.add('opacity-0'); setTimeout(() => d.classList.add('pointer-events-none'), 300); } }

        function nextQuestion() {
            document.getElementById('feedback-area').classList.add('hidden'); document.getElementById('btn-check').classList.remove('hidden'); document.getElementById('btn-next').classList.add('hidden');
            document.getElementById('quiz-kanji').className = "text-6xl ja-text font-bold text-gray-800 mb-4 transition-all inline-block";
            const inp = document.getElementById('quiz-input'); inp.value = ''; inp.disabled = false; inp.focus();
            const valid = vocabData.filter(v => v.Furigana !== "...");
            currentQuizItem = valid[Math.floor(Math.random() * valid.length)];
            document.getElementById('quiz-kanji').innerText = currentQuizItem.Kanji || currentQuizItem.Furigana;
            document.getElementById('quiz-meaning').innerText = currentQuizItem.Nghĩa;
        }
        function checkAnswer() {
            const inp = document.getElementById('quiz-input'); if(!inp.value.trim()) return;
            inp.disabled = true; 
            const correct = inp.value.trim() === currentQuizItem.Furigana;
            const k = document.getElementById('quiz-kanji'); const fbTitle = document.getElementById('feedback-title'); const fbArea = document.getElementById('feedback-area');
            if(correct) { 
                score += 10; k.classList.add("text-green-600", "correct-anim"); 
                fbTitle.innerHTML = '<span class="text-green-600"><i class="fas fa-check-circle mr-2"></i> Chính xác!</span>';
                fbArea.className = fbArea.className.replace("bg-red-50 border-red-200", "") + " bg-green-50 border-green-200";
                speakText(currentQuizItem.Furigana); 
            } else { 
                score = Math.max(0, score - 5); k.classList.add("text-red-500", "wrong-anim"); 
                fbTitle.innerHTML = '<span class="text-red-600"><i class="fas fa-times-circle mr-2"></i> Sai rồi!</span>';
                fbArea.className = fbArea.className.replace("bg-green-50 border-green-200", "") + " bg-red-50 border-red-200";
            }
            document.getElementById('score-display').innerText = score; document.getElementById('correct-answer').innerText = currentQuizItem.Furigana;
            document.getElementById('feedback-area').classList.remove('hidden'); document.getElementById('btn-check').classList.add('hidden'); document.getElementById('btn-next').classList.remove('hidden');
        }
        function playQuizAudio() { if(currentQuizItem) speakText(currentQuizItem.Furigana); }
        function prevWord() { if(currentIndex > 0) loadWord(currentIndex - 1); }
        function nextWord() { if(currentIndex < vocabData.length - 1) loadWord(currentIndex + 1); }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
