<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AzaKanji Tango - Ngày 2: Động từ & Đời sống</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Material Symbols -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    
    <style>
        /* Base Styles */
        body { 
            font-family: 'Nunito', 'Inter', sans-serif; 
            background-color: #f3f4f6; 
            height: 100vh; height: 100dvh; 
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        .ja-text { font-family: 'Noto Sans JP', sans-serif; }
        .kanji-font { font-family: 'Noto Sans JP', sans-serif; }
        
        /* Scrollbar */
        .scroller { -webkit-overflow-scrolling: touch; }
        .scroller::-webkit-scrollbar { width: 5px; }
        .scroller::-webkit-scrollbar-track { background: transparent; }
        .scroller::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }

        /* Animations */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .correct-anim { animation: bounce 0.5s; }
        @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        
        .wrong-anim { animation: shake 0.5s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* Components */
        .vocab-item.active { 
            background-color: #eef2ff; 
            border-left: 4px solid #4f46e5;
            color: #4338ca;
        }
        
        .shadow-card {
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.2s;
        }
        .shadow-card:active { transform: scale(0.98); }

        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid rgba(255, 255, 255, 0.3);
        }

        .tab-btn.active {
            background-color: white;
            color: #312e81;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        .tab-btn { color: #a5b4fc; }
        .tab-btn:hover:not(.active) { color: white; }

        /* Custom Audio Button */
        .audio-btn:active { transform: scale(0.9); }

        /* Kanji Stroke Styles */
        .stroke-path {
            fill: none;
            stroke: #333;
            stroke-width: 3;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .stroke-grid-box {
            border: 1px solid #e5e7eb;
            background-color: white;
            position: relative;
        }
        .stroke-grid-box::after {
            content: ''; position: absolute; top: 0; left: 50%; width: 1px; height: 100%;
            background: repeating-linear-gradient(to bottom, #ddd 0, #ddd 4px, transparent 4px, transparent 8px); z-index: 0;
        }
        .stroke-grid-box::before {
            content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 1px;
            background: repeating-linear-gradient(to right, #ddd 0, #ddd 4px, transparent 4px, transparent 8px); z-index: 0;
        }
    </style>
</head>
<body class="flex flex-col text-slate-800">

    <!-- HEADER -->
    <header class="bg-indigo-700 text-white shadow-lg flex-none z-40 relative">
        <div class="container mx-auto px-4 py-2 md:py-3">
            <div class="flex flex-col md:flex-row justify-between items-center gap-3">
                <div class="flex items-center space-x-3 cursor-pointer select-none w-full md:w-auto justify-between md:justify-start">
                    <div class="flex items-center gap-3" onclick="location.reload()">
                        <i class="fas fa-torii-gate text-3xl text-white"></i>
                        <div>
                            <h1 class="text-lg md:text-xl font-bold uppercase tracking-wider">AzaKanji Tango</h1>
                            <p class="text-[10px] md:text-xs text-indigo-200">Shadowing & Quiz - Ngày 2</p>
                        </div>
                    </div>
                    <div class="md:hidden text-xs font-semibold bg-indigo-800 px-3 py-1 rounded-full border border-indigo-500/50">
                        <span id="headerProgress">1/87</span>
                    </div>
                </div>

                <div class="flex items-center gap-3 w-full md:w-auto">
                    <div class="flex bg-indigo-900/50 rounded-lg p-1 w-full md:w-auto overflow-x-auto no-scrollbar">
                        <button onclick="switchTab('learn')" id="tab-learn" class="tab-btn active flex-1 md:flex-none px-4 py-1.5 rounded-md text-sm font-bold transition whitespace-nowrap flex items-center justify-center gap-2">
                            <i class="fas fa-book-open"></i> Học Từ
                        </button>
                        <button onclick="switchTab('quiz')" id="tab-quiz" class="tab-btn flex-1 md:flex-none px-4 py-1.5 rounded-md text-sm font-bold transition whitespace-nowrap flex items-center justify-center gap-2">
                            <i class="fas fa-keyboard"></i> Kiểm Tra
                        </button>
                        <div class="w-px bg-indigo-600 mx-1"></div>
                        <button onclick="openGrammarList()" class="tab-btn flex-1 md:flex-none px-4 py-1.5 rounded-md text-sm font-bold transition whitespace-nowrap flex items-center justify-center gap-2">
                            <i class="fas fa-scroll"></i> Cẩm Nang
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- MAIN CONTAINER -->
    <div class="flex flex-1 overflow-hidden relative w-full">
        
        <!-- SECTION 1: LEARN (SHADOWING UI) -->
        <div id="learn-section" class="flex flex-1 w-full overflow-hidden absolute inset-0 fade-in">
            <!-- Sidebar (Desktop) -->
            <aside class="hidden md:flex w-72 bg-white border-r border-gray-200 flex-col z-10">
                <div class="p-4 border-b border-gray-100 bg-gray-50">
                    <div class="relative group">
                        <span class="material-symbols-rounded absolute left-3 top-2.5 text-gray-400 text-xl">search</span>
                        <input type="text" id="searchInput" placeholder="Tìm kiếm từ..." class="w-full pl-10 pr-4 py-2 bg-white border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all shadow-sm">
                    </div>
                </div>
                <div id="vocabList" class="flex-1 overflow-y-auto scroller p-2 space-y-1"></div>
            </aside>

            <!-- Main Shadowing Content -->
            <main id="mainContent" class="flex-1 overflow-y-auto scroller bg-slate-50 p-4 pb-28 md:pb-8 w-full scroll-smooth">
                <div class="max-w-3xl mx-auto flex flex-col items-center">
                    
                    <!-- Word Card -->
                    <div class="w-full bg-white rounded-2xl p-6 shadow-sm border border-gray-200 mb-6 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-indigo-50 to-pink-50 rounded-bl-full -mr-8 -mt-8 z-0 opacity-60"></div>
                        <div class="relative z-10 text-center">
                            <div class="inline-flex items-center gap-2 bg-gray-50 px-3 py-1 rounded-full mb-4 border border-gray-100 shadow-sm">
                                <span id="wordType" class="text-[10px] font-bold uppercase tracking-wider text-indigo-500">VERB</span>
                                <div class="w-px h-3 bg-gray-300"></div>
                                <span class="text-[10px] text-gray-400 font-mono" id="wordIndex">#1</span>
                            </div>
                            
                            <div class="relative inline-block group">
                                <h2 id="cardKanji" class="text-5xl md:text-6xl font-bold text-gray-800 mb-2 ja-text tracking-tight cursor-pointer hover:text-indigo-700 transition-colors" onclick="speakCurrent()">見ます</h2>
                                <!-- Visual hint for audio on hover (Desktop) -->
                                <div class="absolute -left-8 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity text-indigo-300 pointer-events-none hidden md:block">
                                    <i class="fas fa-volume-up"></i>
                                </div>
                                <button id="strokeBtn" onclick="openStrokeModal()" class="absolute -right-10 top-2 w-8 h-8 bg-pink-100 text-pink-600 rounded-full flex items-center justify-center shadow-sm hover:bg-pink-200 hover:scale-110 transition-all hidden" title="Tập viết Kanji">
                                    <i class="fas fa-pen-nib text-sm"></i>
                                </button>
                            </div>

                            <div class="flex flex-col items-center gap-1 cursor-pointer" onclick="speakCurrent()">
                                <span id="cardFurigana" class="text-xl text-indigo-600 font-medium ja-text">みます</span>
                                <span id="cardMeaning" class="text-lg text-gray-500">Xem, nhìn, trông</span>
                            </div>
                        </div>
                    </div>

                    <!-- Sentence Contexts -->
                    <div class="w-full">
                        <div class="flex items-center gap-2 mb-4 px-1">
                            <div class="bg-pink-100 text-pink-600 p-1.5 rounded-lg"><i class="fas fa-comments"></i></div>
                            <h3 class="font-bold text-gray-700 text-lg">Hội Thoại Thực Tế (Lịch sự & Thân mật)</h3>
                        </div>
                        <div id="sentenceList" class="space-y-4"></div>
                        <div id="emptyState" class="hidden flex-col items-center justify-center p-8 text-center bg-white rounded-2xl border border-dashed border-gray-300">
                            <i class="fas fa-comment-slash text-gray-300 text-4xl mb-2"></i>
                            <p class="text-sm text-gray-500">Từ này đặc biệt, chưa có mẫu hội thoại phù hợp.</p>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Mobile Navigation -->
            <div class="fixed bottom-0 left-0 right-0 glass px-4 py-3 pb-6 md:pb-4 z-30 flex items-center justify-between gap-4 md:hidden shadow-lg border-t border-gray-200">
                <button onclick="prevWord()" class="w-12 h-12 rounded-xl bg-white border border-gray-200 text-gray-600 flex items-center justify-center shadow-sm active:bg-gray-50 transition-colors"><i class="fas fa-chevron-left"></i></button>
                <button onclick="toggleDrawer()" class="flex-1 h-12 rounded-xl bg-indigo-600 text-white font-bold flex items-center justify-center shadow-lg shadow-indigo-200 active:bg-indigo-700 transition-colors gap-2"><i class="fas fa-list-ul"></i> Danh Sách</button>
                <button onclick="nextWord()" class="w-12 h-12 rounded-xl bg-white border border-gray-200 text-gray-600 flex items-center justify-center shadow-sm active:bg-gray-50 transition-colors"><i class="fas fa-chevron-right"></i></button>
            </div>

            <!-- Desktop Floating Nav -->
            <div class="hidden md:flex fixed bottom-8 right-8 gap-3 z-30">
                 <button onclick="prevWord()" class="w-12 h-12 rounded-full bg-white border border-gray-200 text-gray-600 flex items-center justify-center shadow-lg hover:bg-gray-50 transition-transform hover:-translate-y-1"><i class="fas fa-chevron-left"></i></button>
                 <button onclick="nextWord()" class="w-12 h-12 rounded-full bg-indigo-600 text-white flex items-center justify-center shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-transform hover:-translate-y-1"><i class="fas fa-chevron-right"></i></button>
            </div>
        </div>

        <!-- SECTION 2: QUIZ UI -->
        <div id="quiz-section" class="hidden flex-1 w-full overflow-y-auto scroller bg-slate-100 p-4 absolute inset-0 fade-in z-20">
            <div class="max-w-2xl mx-auto mt-4 md:mt-10">
                <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-200">
                    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-6 text-white flex justify-between items-center relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-white opacity-10 rounded-full -mr-10 -mt-10"></div>
                        <div class="relative z-10">
                            <h2 class="text-2xl font-bold flex items-center gap-2"><i class="fas fa-graduation-cap"></i> Thử Thách</h2>
                            <p class="text-indigo-100 text-sm">Nhìn Kanji - Đoán Hiragana</p>
                        </div>
                        <div class="text-right relative z-10">
                            <div class="text-xs text-indigo-200 uppercase font-bold">Điểm số</div>
                            <div class="text-4xl font-bold font-mono" id="score-display">0</div>
                        </div>
                    </div>
                    <div class="p-6 md:p-10 text-center">
                        <div class="mb-8">
                            <div class="text-xs text-gray-400 mb-2 uppercase tracking-wide font-bold">Từ này đọc là gì?</div>
                            <div id="quiz-kanji" class="text-6xl md:text-7xl kanji-font font-bold text-gray-800 mb-4 transition-all"></div>
                            <div id="quiz-meaning" class="text-lg text-indigo-600 font-bold mb-2"></div>
                        </div>
                        <div class="relative max-w-md mx-auto mb-8">
                            <input type="text" id="quiz-input" class="w-full text-center text-2xl p-4 border-2 border-gray-300 rounded-xl focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 focus:outline-none transition-all kanji-font placeholder-gray-300" placeholder="nhập hiragana..." autocomplete="off">
                        </div>
                        <div id="feedback-area" class="hidden rounded-xl p-5 bg-gray-50 border border-gray-200 text-left mb-6 animate-fade-in">
                            <div id="feedback-title" class="font-bold text-lg mb-2 flex items-center"></div>
                            <div class="text-gray-700 mb-3 flex items-center flex-wrap gap-2">
                                Đáp án đúng: <span id="correct-answer" class="font-bold text-xl text-indigo-600 px-2 py-0.5 bg-indigo-50 rounded border border-indigo-100 ja-text"></span>
                                <button onclick="playQuizAudio()" class="text-gray-400 hover:text-indigo-600 transition-colors w-8 h-8 rounded-full flex items-center justify-center hover:bg-gray-200"><i class="fas fa-volume-up"></i></button>
                            </div>
                        </div>
                        <div>
                            <button id="btn-check" onclick="checkAnswer()" class="w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 px-10 rounded-xl shadow-lg shadow-indigo-200 transform transition active:scale-95 text-lg flex items-center justify-center gap-2 mx-auto"><i class="fas fa-check"></i> Kiểm Tra</button>
                            <button id="btn-next" onclick="nextQuestion()" class="hidden w-full md:w-auto bg-gray-800 hover:bg-gray-900 text-white font-bold py-3.5 px-10 rounded-xl shadow-lg transform transition active:scale-95 text-lg flex items-center justify-center gap-2 mx-auto">Câu Tiếp Theo <i class="fas fa-arrow-right"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MOBILE DRAWER -->
    <div id="mobileDrawer" class="fixed inset-0 z-50 pointer-events-none md:hidden">
        <div id="drawerBackdrop" class="absolute inset-0 bg-black/40 opacity-0 transition-opacity duration-300" onclick="toggleDrawer()"></div>
        <div id="drawerContent" class="absolute inset-y-0 bottom-0 left-0 w-[85%] max-w-sm bg-white shadow-2xl transform -translate-x-full transition-transform duration-300 flex flex-col pointer-events-auto">
            <div class="p-4 border-b border-gray-100 bg-gray-50 flex items-center justify-between">
                <h3 class="font-bold text-lg text-gray-800 flex items-center gap-2"><i class="fas fa-list text-indigo-600"></i> Danh Sách Từ</h3>
                <button onclick="toggleDrawer()" class="w-8 h-8 rounded-full bg-white border border-gray-200 flex items-center justify-center text-gray-500 shadow-sm active:scale-95"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-3 border-b border-gray-100">
                <input type="text" id="mobileSearchInput" placeholder="Tìm nhanh..." class="w-full px-4 py-2.5 bg-gray-100 border-transparent rounded-xl text-sm focus:bg-white focus:ring-2 focus:ring-indigo-500 transition-all">
            </div>
            <div id="mobileVocabList" class="flex-1 overflow-y-auto scroller p-2 space-y-1"></div>
        </div>
    </div>

    <!-- GRAMMAR LIST MODAL (General Menu) -->
    <div id="grammarListModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-gray-900/70 backdrop-blur-sm transition-opacity opacity-0" id="grammarListBackdrop" onclick="closeModal('grammarListModal')"></div>
        <div class="bg-white rounded-2xl w-full max-w-4xl relative z-10 shadow-2xl transform transition-all scale-95 opacity-0 flex flex-col max-h-[85vh]" id="grammarListPanel">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-indigo-50 rounded-t-2xl">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-600 text-white p-2 rounded-lg"><i class="fas fa-book"></i></div>
                    <div><h3 class="text-xl font-bold text-gray-800">Cẩm Nang Ngữ Pháp</h3><p class="text-xs text-gray-500">7 Mẫu câu trọng điểm (Ngày 2)</p></div>
                </div>
                <button onclick="closeModal('grammarListModal')" class="w-8 h-8 rounded-full hover:bg-white flex items-center justify-center text-gray-500 transition-colors"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto scroller bg-slate-50">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="grammarGrid"></div>
            </div>
            <div class="p-4 border-t border-gray-100 bg-white rounded-b-2xl flex justify-end">
                <button onclick="closeModal('grammarListModal')" class="px-6 py-2 bg-gray-800 hover:bg-gray-900 text-white font-bold rounded-full text-sm transition-transform active:scale-95 shadow-lg">Đã Hiểu</button>
            </div>
        </div>
    </div>

    <!-- GRAMMAR DETAIL MODAL (Specific) -->
    <div id="detailModal" class="fixed inset-0 z-[70] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity opacity-0" id="detailBackdrop" onclick="closeModal('detailModal')"></div>
        <div class="bg-white rounded-2xl w-full max-w-md relative z-10 shadow-2xl transform transition-all scale-95 opacity-0 flex flex-col" id="detailPanel">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 rounded-t-2xl">
                <div class="flex items-center gap-2">
                    <div class="bg-indigo-100 p-1.5 rounded-lg text-indigo-600"><i id="modalIcon" class="fas fa-info-circle"></i></div>
                    <h3 class="text-lg font-bold text-gray-800" id="modalTitle">Chi tiết</h3>
                </div>
                <button onclick="closeModal('detailModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6">
                <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-3 text-center mb-4">
                    <code class="text-lg font-bold text-indigo-700 font-mono" id="modalFormula"></code>
                </div>
                <p class="text-gray-600 text-sm mb-4 leading-relaxed" id="modalExplanation"></p>
                <div class="bg-gray-50 rounded-lg p-3 border border-gray-100">
                    <div class="text-xs font-bold text-gray-400 uppercase mb-2">Ví dụ điển hình</div>
                    <div class="flex justify-between items-start gap-3">
                        <div>
                            <p class="ja-text font-medium text-gray-800 mb-1" id="modalExampleJa"></p>
                            <p class="text-xs text-gray-500 italic" id="modalExampleVi"></p>
                        </div>
                        <button id="modalPlayBtn" class="text-indigo-500 hover:text-indigo-700 p-1"><i class="fas fa-volume-up"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- STROKE ORDER MODAL -->
    <div id="strokeModal" class="fixed inset-0 z-[80] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-gray-900/80 backdrop-blur-sm transition-opacity opacity-0" id="strokeBackdrop" onclick="closeModal('strokeModal')"></div>
        <div class="bg-white rounded-2xl w-full max-w-5xl relative z-10 shadow-2xl transform transition-all scale-95 opacity-0 flex flex-col max-h-[90vh]" id="strokePanel">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-pink-50 rounded-t-2xl">
                <h3 class="text-lg font-bold text-pink-700 flex items-center gap-2">
                    <i class="fas fa-pen-nib"></i> Tập Viết & Chi Tiết Kanji
                </h3>
                <button onclick="closeModal('strokeModal')" class="w-8 h-8 rounded-full hover:bg-white flex items-center justify-center text-gray-500 transition-colors"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto scroller bg-slate-50 flex-1">
                <div id="strokeTabs" class="flex justify-center gap-2 mb-6"></div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Left: Writing -->
                    <div class="flex flex-col gap-6">
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 text-center relative">
                            <p class="text-xs text-gray-400 mb-2 font-bold uppercase tracking-wider">Mô phỏng nét viết</p>
                            <div id="strokeAnimContainer" class="w-48 h-48 mx-auto bg-white border border-gray-300 relative stroke-grid-box flex items-center justify-center rounded-lg"><span class="text-xs text-gray-400">Đang tải...</span></div>
                            <button onclick="replayStrokeAnimation()" class="absolute top-4 right-4 bg-pink-50 text-pink-600 w-8 h-8 rounded-full flex items-center justify-center hover:bg-pink-100 transition shadow-sm" title="Viết lại"><i class="fas fa-redo text-sm"></i></button>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                            <p class="text-xs text-gray-400 mb-3 font-bold uppercase tracking-wider">Thứ tự từng nét</p>
                            <div id="strokeGridContainer" class="flex flex-wrap gap-2 justify-center lg:justify-start"></div>
                        </div>
                    </div>
                    <!-- Right: Info -->
                    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200 flex flex-col h-full">
                        <div id="kanjiDetailContent">
                            <div class="flex items-center justify-between mb-6 border-b border-gray-100 pb-4">
                                <div>
                                    <h2 id="detailKanji" class="text-6xl font-bold text-gray-800 ja-text mb-1"></h2>
                                    <div class="text-xs font-bold bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded inline-block" id="detailHanViet"></div>
                                </div>
                                <div class="text-right"><div class="text-2xl font-bold text-gray-600 capitalize" id="detailMeaning"></div></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <div class="bg-slate-50 p-3 rounded-lg border border-slate-100"><span class="text-xs font-bold text-gray-400 uppercase block mb-1">On (Âm Nhật)</span><span class="text-lg font-bold text-indigo-600" id="detailOn"></span></div>
                                <div class="bg-slate-50 p-3 rounded-lg border border-slate-100"><span class="text-xs font-bold text-gray-400 uppercase block mb-1">Kun (Âm Hán)</span><span class="text-lg font-bold text-pink-600" id="detailKun"></span></div>
                            </div>
                            <div class="space-y-4 mb-6">
                                <div class="bg-green-50 p-4 rounded-lg border border-green-100"><h4 class="text-sm font-bold text-green-800 mb-2 flex items-center gap-2"><i class="fas fa-image"></i> Mẹo nhớ hình ảnh</h4><p class="text-sm text-green-700 leading-relaxed" id="detailTipImg"></p></div>
                                <div class="bg-orange-50 p-4 rounded-lg border border-orange-100"><h4 class="text-sm font-bold text-orange-800 mb-2 flex items-center gap-2"><i class="fas fa-music"></i> Mẹo nhớ âm thanh</h4><p class="text-sm text-orange-700 leading-relaxed" id="detailTipSound"></p></div>
                            </div>
                            <div>
                                <h4 class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-3">Từ vựng liên quan</h4>
                                <div class="space-y-2" id="detailWords"></div>
                            </div>
                        </div>
                        <div id="kanjiDetailEmpty" class="hidden h-full flex flex-col items-center justify-center text-center p-4">
                            <i class="fas fa-book-open text-gray-200 text-6xl mb-4"></i>
                            <p class="text-gray-400">Đang cập nhật thông tin chi tiết.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. DATA: KANJI DATABASE (Full 80+ Kanji) ---
        const kanjiDetails = {
            "見": { hanviet: "KIẾN", mean: "Nhìn", on: "ケン", kun: "み.る", tipImg: "Mắt (**目**) gắn trên chân người (**儿**) đi **KIẾN** tập.", tipSound: "**Mi Rủ** (**Miru**) nhìn gì đấy?", words: [{w:"見ます",m:"Xem, nhìn"}, {w:"意見",m:"Ý kiến"}, {w:"見学",m:"Kiến tập"}] },
            "聞": { hanviet: "VĂN", mean: "Nghe", on: "ブン, モン", kun: "き.く", tipImg: "Ghé tai (**耳**) vào cổng (**門**) để nghe tin **VĂN**.", tipSound: "**Ki Cụ** (**Kiku**) đang nghe đài.", words: [{w:"聞きます",m:"Nghe"}, {w:"新聞",m:"Báo chí"}] },
            "読": { hanviet: "ĐỘC", mean: "Đọc", on: "ドク", kun: "よ.む", tipImg: "Nói (**言**) về chuyện bán (**売**) sách cho người **ĐỘC** giả.", tipSound: "**Dô** (**Yo**) **Mụ** (**mu**) đang đọc sách.", words: [{w:"読みます",m:"Đọc"}, {w:"読書",m:"Đọc sách"}] },
            "書": { hanviet: "THƯ", mean: "Viết", on: "ショ", kun: "か.く", tipImg: "Tay cầm bút (**聿**) viết chuyện hàng Ngày (**日**) vào **THƯ** tịch.", tipSound: "**Ca Cứ** (**Kaku**) hát khi viết.", words: [{w:"書きます",m:"Viết"}, {w:"辞書",m:"Từ điển"}] },
            "来": { hanviet: "LAI", mean: "Đến", on: "ライ", kun: "く.る", tipImg: "Cây (**木**) mọc 2 nhánh (**丷**) báo hiệu tương **LAI**.", tipSound: "**Cu Rũ** (**Kuru**) vì chờ mãi mới đến.", words: [{w:"来ます",m:"Đến"}, {w:"来週",m:"Tuần sau"}, {w:"未来",m:"Tương lai"}] },
            "行": { hanviet: "HÀNH", mean: "Đi", on: "コウ, ギョウ", kun: "い.く", tipImg: "Bước chân trái (**彳**) bước chân phải (**亍**) là **HÀNH** động đi.", tipSound: "**I Cư** (**Iku**) đi đâu đấy?", words: [{w:"行きます",m:"Đi"}, {w:"旅行",m:"Du lịch"}, {w:"銀行",m:"Ngân hàng"}] },
            "帰": { hanviet: "QUY", mean: "Về", on: "キ", kun: "かえ.る", tipImg: "Cầm cái chổi (**帚**) quét nhà đón chồng **QUY** hồi.", tipSound: "**Ca Ế** (**Kae**) mang về kho.", words: [{w:"帰ります",m:"Về"}, {w:"帰国",m:"Về nước"}] },
            "遊": { hanviet: "DU", mean: "Chơi", on: "ユウ", kun: "あそ.ぶ", tipImg: "Đứa trẻ (**子**) cầm cờ Vuông (**方**) chạy lăng xăng đi **DU** chơi.", tipSound: "**A Xô Bự** (**Asobu**) chơi.", words: [{w:"遊びます",m:"Chơi"}, {w:"遊園地",m:"Công viên giải trí"}] },
            "持": { hanviet: "TRÌ", mean: "Cầm", on: "ジ", kun: "も.つ", tipImg: "Tay (**扌**) cầm đồ vật ở Chùa (**寺**) để duy **TRÌ**.", tipSound: "**Mô Trự** (**Motsu**) cầm đồ.", words: [{w:"持ちます",m:"Cầm, mang"}, {w:"気持ち",m:"Cảm giác"}] },
            "運": { hanviet: "VẬN", mean: "Vận chuyển", on: "ウン", kun: "はこ.ぶ", tipImg: "Quân lính (**軍**) di chuyển (**⻌**) **VẬN** lương thực.", tipSound: "**Ha Cô** (**Hako**) đi vận chuyển.", words: [{w:"運びます",m:"Vận chuyển"}, {w:"運動",m:"Vận động"}, {w:"運",m:"Vận may"}] },
            "買": { hanviet: "MÃI", mean: "Mua", on: "バイ", kun: "か.う", tipImg: "Cái lưới (**罒**) chụp tiền (**貝**) để **MÃI** (mua).", tipSound: "**Ca U** (**Kau**) sầu vì mua hớ.", words: [{w:"買います",m:"Mua"}, {w:"買い物",m:"Mua sắm"}] },
            "売": { hanviet: "MẠI", mean: "Bán", on: "バイ", kun: "う.る", tipImg: "Kẻ sĩ (**士**) trùm khăn (**冖**) đi bán chân (**儿**) là **MẠI**.", tipSound: "**U Rũ** (**Uru**) rượi vì bán ế.", words: [{w:"売ります",m:"Bán"}, {w:"売店",m:"Quầy bán hàng"}] },
            "払": { hanviet: "PHẤT", mean: "Trả tiền", on: "フツ", kun: "はら.う", tipImg: "Tay (**扌**) trả tiền cho việc tư (**ム**) rồi **PHẤT** áo ra đi.", tipSound: "**Ha Rau** (**Harau**) trả tiền rau.", words: [{w:"払います",m:"Trả tiền"}, {w:"支払い",m:"Thanh toán"}] },
            "乗": { hanviet: "THỪA", mean: "Lên xe", on: "ジョウ", kun: "の.る", tipImg: "Cây lúa (**禾**) đặt trên đỉnh ngàn (**千**) chiếc xe.", tipSound: "**Nô** (**No**) đùa rủ lên xe.", words: [{w:"乗ります",m:"Lên xe"}, {w:"乗車",m:"Lên tàu xe"}] },
            "降": { hanviet: "GIÁNG", mean: "Xuống", on: "コウ", kun: "お.りる", tipImg: "Gò đất (**阝**) có bước chân (**夅**) đi xuống là **GIÁNG** trần.", tipSound: "**Ô Ri** (**Ori**) xuống xe.", words: [{w:"降ります",m:"Xuống xe"}, {w:"降雨",m:"Mưa rơi"}] },
            "入": { hanviet: "NHẬP", mean: "Vào", on: "ニュウ", kun: "はい.る", tipImg: "Người đi vào cái lều.", tipSound: "**Hai** (**Hai**) người đi vào.", words: [{w:"入ります",m:"Vào"}, {w:"入学",m:"Nhập học"}, {w:"入口",m:"Cửa vào"}] },
            "出": { hanviet: "XUẤT", mean: "Ra", on: "シュツ", kun: "で.る", tipImg: "Hai ngọn núi (**山**) chồng lên nhau **XUẤT** hiện.", tipSound: "**Đê** (**De**) vỡ nước chảy ra.", words: [{w:"出ます",m:"Ra"}, {w:"出口",m:"Cửa ra"}, {w:"出発",m:"Xuất phát"}] },
            "開": { hanviet: "KHAI", mean: "Mở", on: "カイ", kun: "あ.ける", tipImg: "Hai tay mở cổng (**門**) **KHAI** trương.", tipSound: "**A Kê** (**Ake**) cứ mở đi.", words: [{w:"開けます",m:"Mở"}, {w:"開店",m:"Mở cửa hàng"}] },
            "閉": { hanviet: "BẾ", mean: "Đóng", on: "ヘイ", kun: "し.める", tipImg: "Đóng cửa (**門**) lại để trọng dụng nhân tài (**才**).", tipSound: "**Si Mê** (**Shime**) đóng cửa lòng.", words: [{w:"閉めます",m:"Đóng"}, {w:"閉会",m:"Bế mạc"}] },
            "覚": { hanviet: "GIÁC", mean: "Nhớ", on: "カク", kun: "おぼ.える", tipImg: "Ở dưới nhà (**冖**) sáng suốt (**⺍**) nhìn (**見**) là sẽ **GIÁC** ngộ.", tipSound: "**Ô Bố Ê** (**Oboe**) nhớ bài chưa?", words: [{w:"覚えます",m:"Nhớ"}, {w:"感覚",m:"Cảm giác"}] },
            "忘": { hanviet: "VONG", mean: "Quên", on: "ボウ", kun: "わす.れる", tipImg: "Tim (**心**) chết (**亡**) thì sẽ **VONG** tình (quên).", tipSound: "**Wa Su Rê** (**Wasure**) quên hết.", words: [{w:"忘れます",m:"Quên"}, {w:"忘年会",m:"Tiệc tất niên"}] },
            "送": { hanviet: "TỐNG", mean: "Gửi", on: "ソウ", kun: "おく.る", tipImg: "Quan lớn (**关**) đi đường (**⻌**) được **TỐNG** tiễn.", tipSound: "**Ô Cư** (**Oku**) gửi đồ.", words: [{w:"送ります",m:"Gửi"}, {w:"送信",m:"Gửi tin"}] },
            "迎": { hanviet: "NGHÊNH", mean: "Đón", on: "ゲイ", kun: "むか.える", tipImg: "Vừa đi (**⻌**) vừa ngẩng đầu (**卬**) đón tiếp.", tipSound: "**Mụ Cá Ê** (**Mukae**) ra đón.", words: [{w:"迎えます",m:"Đón"}, {w:"歓迎",m:"Hoan nghênh"}] },
            "貸": { hanviet: "THẢI", mean: "Cho mượn", on: "タイ", kun: "か.す", tipImg: "Đổi (**代**) lấy tiền (**貝**) là cho vay mượn.", tipSound: "**Ca Sư** (**Kasu**) cho mượn tiền.", words: [{w:"貸します",m:"Cho mượn"}, {w:"賃貸",m:"Cho thuê"}] },
            "借": { hanviet: "TÁ", mean: "Mượn", on: "シャク", kun: "か.りる", tipImg: "Người (**亻**) xưa (**昔**) hay đi **TÁ** túc.", tipSound: "**Ca Ri** (**Kari**) đi mượn.", words: [{w:"借ります",m:"Mượn"}, {w:"借金",m:"Tiền nợ"}] },
            "教": { hanviet: "GIÁO", mean: "Dạy", on: "キョウ", kun: "おし.える", tipImg: "Dạy trẻ (**子**) hiếu thảo (**孝**) bằng roi (**攵**).", tipSound: "**Ô Si Ê** (**Oshie**) dạy học.", words: [{w:"教えます",m:"Dạy"}, {w:"教師",m:"Giáo viên"}, {w:"教科書",m:"Sách GK"}] },
            "習": { hanviet: "TẬP", mean: "Học", on: "シュウ", kun: "なら.う", tipImg: "Chim non tập vỗ đôi cánh (**羽**) trắng (**白**).", tipSound: "**Na Ra** (**Nara**) đi học.", words: [{w:"習います",m:"Học"}, {w:"練習",m:"Luyện tập"}] },
            "言": { hanviet: "NGÔN", mean: "Nói", on: "ゲン", kun: "い.う", tipImg: "Miệng (**口**) phát ra lời nói.", tipSound: "**I U** (**Iu**-Yêu) thì nói đi.", words: [{w:"言います",m:"Nói"}, {w:"言葉",m:"Từ vựng"}] },
            "伝": { hanviet: "TRUYỀN", mean: "Truyền đạt", on: "デン", kun: "つた.える", tipImg: "Người (**亻**) **TRUYỀN** tin qua mây (**云**).", tipSound: "**Tsu Ta Ê** (**Tsutae**) truyền tin.", words: [{w:"伝えます",m:"Truyền đạt"}, {w:"手伝う",m:"Giúp đỡ"}] },
            "始": { hanviet: "THỦY", mean: "Bắt đầu", on: "シ", kun: "はじ.める", tipImg: "Người phụ nữ (**女**) đứng trên đài (**台**) bắt đầu buổi lễ.", tipSound: "**Ha Ji Mê** (**Hajime**) bắt đầu.", words: [{w:"始めます",m:"Bắt đầu"}, {w:"開始",m:"Khai mạc"}] },
            "終": { hanviet: "CHUNG", mean: "Kết thúc", on: "シュウ", kun: "お.わる", tipImg: "Sợi tơ (**糸**) dệt xong vào mùa đông (**冬**).", tipSound: "**Ô Wa** (**Owa**) hết rồi.", words: [{w:"終わります",m:"Kết thúc"}, {w:"終了",m:"Chấm dứt"}] },
            "考": { hanviet: "KHẢO", mean: "Suy nghĩ", on: "コウ", kun: "かんが.える", tipImg: "Ông già (**耂**) chống gậy suy nghĩ (**丂**).", tipSound: "**Can Ga Ê** (**Kangae**) suy nghĩ.", words: [{w:"考えます",m:"Suy nghĩ"}, {w:"参考",m:"Tham khảo"}] },
            "思": { hanviet: "TƯ", mean: "Nghĩ", on: "シ", kun: "おも.う", tipImg: "Ruộng (**田**) trong tim (**心**) là nỗi nhớ.", tipSound: "**Ô Mô** (**Omo**) nhớ mong.", words: [{w:"思います",m:"Nghĩ"}, {w:"思い出",m:"Kỷ niệm"}] },
            "待": { hanviet: "ĐÃI", mean: "Đợi", on: "タイ", kun: "ま.つ", tipImg: "Đi (**彳**) đến chùa (**寺**) để **ĐÃI** (đợi).", tipSound: "**Ma Trự** (**Matsu**) đợi chờ.", words: [{w:"待ちます",m:"Đợi"}, {w:"招待",m:"Chiêu đãi"}] },
            "食": { hanviet: "THỰC", mean: "Ăn", on: "ショク", kun: "た.べる", tipImg: "Người (**人**) tốt (**良**) có lương **THỰC**.", tipSound: "**Ta Bê** (**Tabe**) đi ăn.", words: [{w:"食べます",m:"Ăn"}, {w:"食堂",m:"Nhà ăn"}, {w:"食事",m:"Bữa ăn"}] },
            "飲": { hanviet: "ẨM", mean: "Uống", on: "イン", kun: "の.む", tipImg: "Ăn (**食**) xong thiếu (**欠**) nước phải **ẨM** (uống).", tipSound: "**Nô Mư** (**Nomu**) uống nước.", words: [{w:"飲みます",m:"Uống"}, {w:"飲料",m:"Đồ uống"}] },
            "朝": { hanviet: "TRIỀU", mean: "Sáng", on: "チョウ", kun: "あさ", tipImg: "Mặt trời mọc trong cỏ, trăng lặn.", tipSound: "**A Sa** (**Asa**) sáng rồi.", words: [{w:"朝 (あさ)",m:"Buổi sáng"}, {w:"今朝 (けさ)",m:"Sáng nay"}, {w:"朝食",m:"Bữa sáng"}] },
            "昼": { hanviet: "TRÚ", mean: "Trưa", on: "チュウ", kun: "ひる", tipImg: "Cái thước (**尺**) đo bóng nắng buổi trưa (**旦**).", tipSound: "**Hi Rư** (**Hiru**) buổi trưa.", words: [{w:"昼 (ひる)",m:"Buổi trưa"}, {w:"昼食",m:"Bữa trưa"}] },
            "夕": { hanviet: "TỊCH", mean: "Chiều tối", on: "セキ", kun: "ゆう", tipImg: "Vầng trăng khuyết buổi tối.", tipSound: "**Yuu** tối rồi.", words: [{w:"夕方 (ゆうがた)",m:"Chiều tối"}, {w:"夕食",m:"Bữa tối"}] },
            "晩": { hanviet: "VÃN", mean: "Tối", on: "バン", kun: "", tipImg: "Mặt trời (**日**) lặn, miễn (**免**) làm việc.", tipSound: "**Ban** đêm.", words: [{w:"今晩 (こんばん)",m:"Tối nay"}, {w:"晩ご飯",m:"Cơm tối"}] },
            "飯": { hanviet: "PHẠN", mean: "Cơm", on: "ハン", kun: "めし", tipImg: "Ăn (**食**) cơm ngược (**反**) lại.", tipSound: "**Han** trong gohan.", words: [{w:"ご飯 (ごはん)",m:"Cơm"}, {w:"炊飯器",m:"Nồi cơm điện"}] },
            "肉": { hanviet: "NHỤC", mean: "Thịt", on: "ニク", kun: "", tipImg: "Miếng thịt trong khung.", tipSound: "**Ni Cư** (**Niku**) thịt.", words: [{w:"肉 (にく)",m:"Thịt"}, {w:"牛肉",m:"Thịt bò"}] },
            "卵": { hanviet: "NOÃN", mean: "Trứng", on: "ラン", kun: "たまご", tipImg: "Hình hai quả trứng.", tipSound: "**Ta Ma Gô** (**Tamago**) trứng.", words: [{w:"卵 (たまご)",m:"Trứng"}, {w:"卵焼き",m:"Trứng chiên"}] },
            "野": { hanviet: "DÃ", mean: "Cánh đồng", on: "ヤ", kun: "の", tipImg: "Ở làng (**里**) báo trước (**予**) ra đồng.", tipSound: "**Ya** sai.", words: [{w:"野菜 (やさい)",m:"Rau"}, {w:"野球 (やきゅう)",m:"Bóng chày"}] },
            "菜": { hanviet: "THÁI", mean: "Rau", on: "サイ", kun: "な", tipImg: "Cỏ (**艹**) hái (**採**) về làm rau.", tipSound: "**Sai** trong yasai.", words: [{w:"野菜 (やさい)",m:"Rau"}, {w:"菜食",m:"Ăn chay"}] },
            "牛": { hanviet: "NGƯU", mean: "Bò", on: "ギュウ", kun: "うし", tipImg: "Hình con bò có sừng.", tipSound: "**U Si** (**Ushi**) con bò.", words: [{w:"牛乳 (ぎゅうにゅう)",m:"Sữa bò"}, {w:"牛肉",m:"Thịt bò"}] },
            "乳": { hanviet: "NHŨ", mean: "Sữa", on: "ニュウ", kun: "ちち", tipImg: "Đứa trẻ (**子**) dùng móng vuốt (**爫**) bấu lấy bầu sữa.", tipSound: "**Nyuu** sữa.", words: [{w:"牛乳 (ぎゅうにゅう)",m:"Sữa bò"}, {w:"母乳",m:"Sữa mẹ"}] },
            "映": { hanviet: "ÁNH", mean: "Chiếu", on: "エイ", kun: "うつ.る", tipImg: "Mặt trời (**日**) chiếu sáng ở trung ương (**央**).", tipSound: "**Ê** (**Ei**) chiếu phim.", words: [{w:"映画 (えいが)",m:"Phim"}, {w:"上映",m:"Trình chiếu"}] },
            "画": { hanviet: "HỌA", mean: "Tranh", on: "ガ, カク", kun: "", tipImg: "Ruộng (**田**) được vẽ trong khung.", tipSound: "**Ga** trong eiga.", words: [{w:"映画 (えいが)",m:"Phim"}, {w:"計画",m:"Kế hoạch"}] },
            "英": { hanviet: "ANH", mean: "Anh quốc", on: "エイ", kun: "", tipImg: "Cỏ (**艹**) ở trung ương (**央**) là tinh hoa.", tipSound: "**Ê** (**Ei**) tiếng Anh.", words: [{w:"英語 (えいご)",m:"Tiếng Anh"}, {w:"英国",m:"Nước Anh"}] },
            "語": { hanviet: "NGỮ", mean: "Ngôn ngữ", on: "ゴ", kun: "かた.る", tipImg: "Lời nói (**言**) của tôi (**吾**).", tipSound: "**Gô** (**Go**) ngôn ngữ.", words: [{w:"英語 (えいご)",m:"Tiếng Anh"}, {w:"日本語",m:"Tiếng Nhật"}] },
            "勉": { hanviet: "MIỄN", mean: "Cố gắng", on: "ベン", kun: "", tipImg: "Dùng sức (**力**) để miễn (**免**) dịch ngu dốt.", tipSound: "**Ben** học bài.", words: [{w:"勉強 (べんきょう)",m:"Học tập"}, {w:"勤勉",m:"Cần cù"}] },
            "強": { hanviet: "CƯỜNG", mean: "Mạnh", on: "キョウ", kun: "つよ.い", tipImg: "Cung (**弓**) bắn trùng (**虫**) rất mạnh.", tipSound: "**Kyou** khỏe.", words: [{w:"勉強 (べんきょう)",m:"Học tập"}, {w:"強い",m:"Mạnh"}] },
            "作": { hanviet: "TÁC", mean: "Làm", on: "サク", kun: "つく.る", tipImg: "Người (**亻**) làm ra tác phẩm bỗng nhiên (**乍**).", tipSound: "**Tsư Cư** (**Tsuku**) làm.", words: [{w:"作ります",m:"Làm"}, {w:"作家",m:"Tác giả"}] },
            "先": { hanviet: "TIÊN", mean: "Trước", on: "セン", kun: "さき", tipImg: "Chân đi trước (**儿**) đầu (**土**).", tipSound: "**Sen** nở trước.", words: [{w:"先生 (せんせい)",m:"Giáo viên"}, {w:"先週",m:"Tuần trước"}] },
            "生": { hanviet: "SINH", mean: "Sống", on: "セイ, ショウ", kun: "い.きる, う.まれる", tipImg: "Cây cỏ mọc trên đất.", tipSound: "**Sê** (**Sei**) ra sự sống.", words: [{w:"先生",m:"Giáo viên"}, {w:"学生",m:"Học sinh"}] },
            "師": { hanviet: "SƯ", mean: "Thầy giáo", on: "シ", kun: "", tipImg: "Thầy giáo cầm khăn (**巾**) đi vòng quanh (**帀**).", tipSound: "**Si** (**Shi**) là thầy.", words: [{w:"教師 (きょうし)",m:"Giáo viên"}, {w:"医師",m:"Bác sĩ"}] },
            "員": { hanviet: "VIÊN", mean: "Thành viên", on: "イン", kun: "", tipImg: "Miệng (**口**) ăn tiền (**貝**) là nhân viên.", tipSound: "**In** thẻ nhân viên.", words: [{w:"会社員",m:"Nhân viên"}, {w:"銀行員",m:"NV ngân hàng"}] },
            "医": { hanviet: "Y", mean: "Y học", on: "イ", kun: "", tipImg: "Mũi tên (**矢**) trong hộp (**匚**) cứu người.", tipSound: "**I** tá.", words: [{w:"医者 (いしゃ)",m:"Bác sĩ"}, {w:"医学",m:"Y học"}] },
            "者": { hanviet: "GIẢ", mean: "Người", on: "シャ", kun: "もの", tipImg: "Ông già chống gậy dưới đất (**土**).", tipSound: "**Xa** (**Sha**) là người.", words: [{w:"医者 (いしゃ)",m:"Bác sĩ"}, {w:"若者",m:"Người trẻ"}] },
            "警": { hanviet: "CẢNH", mean: "Cảnh sát", on: "ケイ", kun: "", tipImg: "Lời nói (**言**) tôn kính (**敬**) cảnh sát.", tipSound: "**Kê** (**Kei**) khai.", words: [{w:"警察官 (けいさつかん)",m:"Cảnh sát"}, {w:"警告",m:"Cảnh cáo"}] },
            "察": { hanviet: "SÁT", mean: "Quan sát", on: "サツ", kun: "", tipImg: "Trong nhà (**宀**) tế lễ (**祭**) cần quan sát.", tipSound: "**Sa Tsư** (**Satsu**) quan sát.", words: [{w:"警察 (けいさつ)",m:"Cảnh sát"}, {w:"観察",m:"Quan sát"}] },
            "官": { hanviet: "QUAN", mean: "Quan chức", on: "カン", kun: "", tipImg: "Quan đội mũ trong nhà (**宀**).", tipSound: "**Can** (**Kan**) ngăn quan lại.", words: [{w:"警察官",m:"Cảnh sát"}, {w:"外交官",m:"Nhà ngoại giao"}] },
            "銀": { hanviet: "NGÂN", mean: "Bạc", on: "ギン", kun: "", tipImg: "Kim loại (**金**) tốt (**艮**) là bạc.", tipSound: "**Ghin** (**Gin**) giữ bạc.", words: [{w:"銀行 (ぎんこう)",m:"Ngân hàng"}, {w:"水銀",m:"Thủy ngân"}] },
            "実": { hanviet: "THỰC", mean: "Thực tế", on: "ジツ", kun: "み", tipImg: "Trong nhà (**宀**) có ba người (**三**) rất thực tế.", tipSound: "**Ji Tsư** (**Jitsu**) sự thật.", words: [{w:"実習生 (じっしゅうせい)",m:"Thực tập sinh"}, {w:"事実",m:"Sự thật"}] },
            "留": { hanviet: "LƯU", mean: "Ở lại", on: "リュウ", kun: "と.める", tipImg: "Dưới ruộng (**田**) có dao (**刀**) phải lưu lại.", tipSound: "**Riu** (**Ryuu**) lại.", words: [{w:"留学生 (りゅうがくせい)",m:"Du học sinh"}, {w:"留守",m:"Vắng nhà"}] },
            "日": { hanviet: "NHẬT", mean: "Ngày", on: "ニチ", kun: "ひ", tipImg: "Hình mặt trời.", tipSound: "**Ni Chi** ngày.", words: [{w:"日本 (にほん)",m:"Nhật Bản"}, {w:"日曜日",m:"Chủ nhật"}] },
            "本": { hanviet: "BẢN", mean: "Sách, gốc", on: "ホン", kun: "もと", tipImg: "Gốc cây (**木**) được đánh dấu (**一**).", tipSound: "**Hôn** (**Hon**) vào sách.", words: [{w:"日本 (にほん)",m:"Nhật Bản"}, {w:"本",m:"Sách"}] },
            "中": { hanviet: "TRUNG", mean: "Giữa", on: "チュウ", kun: "なか", tipImg: "Cái que cắm ở giữa.", tipSound: "**Chuu** tâm.", words: [{w:"中国 (ちゅうごく)",m:"Trung Quốc"}, {w:"背中",m:"Lưng"}] },
            "韓": { hanviet: "HÀN", mean: "Hàn Quốc", on: "カン", kun: "", tipImg: "Mười (**十**) ngày (**早**) làm da (**韋**) ở Hàn.", tipSound: "**Can** (**Kan**) ngăn Hàn Quốc.", words: [{w:"韓国 (かんこく)",m:"Hàn Quốc"}] },
            "時": { hanviet: "THỜI", mean: "Thời gian", on: "ジ", kun: "とき", tipImg: "Mặt trời (**日**) chiếu ở chùa (**寺**) báo giờ.", tipSound: "**Ji** giờ.", words: [{w:"時計 (とけい)",m:"Đồng hồ"}, {w:"時間",m:"Thời gian"}] },
            "計": { hanviet: "KẾ", mean: "Đo", on: "ケイ", kun: "はか.る", tipImg: "Lời nói (**言**) mười (**十**) lần là kế hoạch.", tipSound: "**Kê** (**Kei**) khai.", words: [{w:"時計 (とけい)",m:"Đồng hồ"}, {w:"計画",m:"Kế hoạch"}] },
            "少": { hanviet: "THIỂU", mean: "Ít", on: "ショウ", kun: "すこ.し", tipImg: "Tiểu (**小**) thêm một phẩy là ít.", tipSound: "**Siêu** (**Shou**) ít.", words: [{w:"少し (すこし)",m:"Một chút"}, {w:"少年",m:"Thiếu niên"}] },
            "全": { hanviet: "TOÀN", mean: "Toàn bộ", on: "ゼン", kun: "まった.く", tipImg: "Vua (**王**) dưới nón (**入**) cai quản toàn bộ.", tipSound: "**Zen** bộ.", words: [{w:"全然 (ぜんぜん)",m:"Hoàn toàn"}, {w:"全部",m:"Tất cả"}] },
            "然": { hanviet: "NHIÊN", mean: "Tự nhiên", on: "ゼン", kun: "", tipImg: "Thịt chó (**肰**) nướng trên lửa (**灬**) rất tự nhiên.", tipSound: "**Zen** nhiên.", words: [{w:"全然 (ぜんぜん)",m:"Hoàn toàn"}, {w:"自然",m:"Tự nhiên"}] },
            "今": { hanviet: "KIM", mean: "Bây giờ", on: "コン", kun: "いま", tipImg: "Dưới mái nhà (**亼**) có cái đồng hồ.", tipSound: "**Côn** (**Kon**) nay.", words: [{w:"今朝 (けさ)",m:"Sáng nay"}, {w:"今日",m:"Hôm nay"}] },
            "方": { hanviet: "PHƯƠNG", mean: "Hướng", on: "ホウ", kun: "かた", tipImg: "Lá cờ bay.", tipSound: "**Hô** (**Hou**) phương hướng.", words: [{w:"夕方 (ゆうがた)",m:"Chiều tối"}, {w:"方法",m:"Phương pháp"}] },
            "球": { hanviet: "CẦU", mean: "Quả bóng", on: "キュウ", kun: "たま", tipImg: "Vua (**王**) cầu (**求**) quả bóng.", tipSound: "**Cứu** (**Kyuu**) quả bóng.", words: [{w:"野球 (やきゅう)",m:"Bóng chày"}, {w:"地球",m:"Trái đất"}] },
            "宿": { hanviet: "TÚC", mean: "Trọ", on: "シュク", kun: "やど", tipImg: "Trăm (**百**) người (**亻**) trọ trong nhà (**宀**).", tipSound: "**Su Cư** (**Shuku**) đi trọ.", words: [{w:"宿題 (しゅくだい)",m:"Bài tập"}, {w:"宿泊",m:"Trọ lại"}] },
            "題": { hanviet: "ĐỀ", mean: "Vấn đề", on: "ダイ", kun: "", tipImg: "Đúng (**是**) là cái đầu (**頁**) có vấn đề.", tipSound: "**Đai** (**Dai**) đề.", words: [{w:"宿題 (しゅくだい)",m:"Bài tập"}, {w:"問題",m:"Vấn đề"}] }
        };

        // --- SMART GRAMMAR LOGIC ---
        const grammarDefs = {
            // Updated Grammar Logic with "validFor" Type Checking
            past: { 
                id: 'past', label: 'Đã xong (Hoàn thành)', icon: 'check-circle', type: 'verb', 
                color: 'text-green-600', bg: 'bg-green-50',
                validFor: ['verb'], 
                formula: 'もう + Vました',
                meaning: 'Diễn tả hành động đã hoàn thành trong quá khứ.',
                example: { ja: 'もう昼ご飯を食べました。', vi: 'Tôi đã ăn trưa rồi.' },
                gen: (w, f) => ({
                    polite: `もう${f.stem}ました。`,
                    politeVi: `Tôi đã ${w['Nghĩa tiếng Việt']} rồi.`,
                    casual: `もう${f.ta}。`,
                    casualVi: `Đã ${w['Nghĩa tiếng Việt']} rồi đấy.`
                })
            },
            cont: { 
                id: 'cont', label: 'Đang làm (Tiếp diễn)', icon: 'clock', type: 'verb',
                color: 'text-blue-600', bg: 'bg-blue-50',
                validFor: ['verb'],
                formula: 'まだ + Vています',
                meaning: 'Hành động vẫn đang tiếp diễn.',
                example: { ja: 'まだ雨が降っています。', vi: 'Trời vẫn đang mưa.' },
                gen: (w, f) => ({
                    polite: `まだ${f.te}います。`,
                    politeVi: `Tôi vẫn đang ${w['Nghĩa tiếng Việt']}.`,
                    casual: `まだ${f.te}るよ。`, 
                    casualVi: `Vẫn đang ${w['Nghĩa tiếng Việt']} nè.`
                })
            },
            neg_cont: { 
                id: 'neg_cont', label: 'Chưa làm (Phủ định)', icon: 'hourglass-half', type: 'verb',
                color: 'text-orange-600', bg: 'bg-orange-50',
                validFor: ['verb'],
                formula: 'まだ + Vていません',
                meaning: 'Hành động chưa xảy ra tại thời điểm nói.',
                example: { ja: 'まだ宿題をしていません。', vi: 'Tôi vẫn chưa làm bài tập.' },
                gen: (w, f) => ({
                    polite: `まだ${f.te}いません。`,
                    politeVi: `Tôi vẫn chưa ${w['Nghĩa tiếng Việt']}.`,
                    casual: `まだ${f.te}ない。`,
                    casualVi: `Vẫn chưa ${w['Nghĩa tiếng Việt']} đâu.`
                })
            },
            choice: {
                id: 'choice', label: 'Lựa chọn', icon: 'code-branch', type: 'noun',
                color: 'text-purple-600', bg: 'bg-purple-50',
                validFor: ['food', 'object', 'place', 'activity'], 
                formula: 'N1 か N2',
                meaning: 'Lựa chọn giữa cái này hoặc cái kia.',
                example: { ja: 'コーヒーかお茶にします。', vi: 'Tôi sẽ chọn cà phê hoặc trà.' },
                gen: (w, f) => ({
                    polite: `${w.Furigana}かこれにします。`,
                    politeVi: `Tôi chọn ${w['Nghĩa tiếng Việt']} hoặc cái này.`,
                    casual: `${w.Furigana}かこれにする。`,
                    casualVi: `Chọn ${w['Nghĩa tiếng Việt']} hay cái này đây.`
                })
            },
            how: {
                id: 'how', label: 'Như thế nào?', icon: 'question-circle', type: 'noun',
                color: 'text-teal-600', bg: 'bg-teal-50',
                validFor: ['place', 'food', 'object', 'activity'], 
                formula: 'Nは どうですか',
                meaning: 'Hỏi về cảm nhận hoặc đề nghị.',
                example: { ja: 'この映画はどうですか。', vi: 'Bộ phim này thế nào?' },
                gen: (w, f) => ({
                    polite: `${w.Furigana}はどうですか。`,
                    politeVi: `${w['Nghĩa tiếng Việt']} thì thế nào?`,
                    casual: `${w.Furigana}はどう？`,
                    casualVi: `${w['Nghĩa tiếng Việt']} thế nào?`
                })
            },
            what_kind: {
                id: 'what_kind', label: 'Loại nào?', icon: 'tags', type: 'noun',
                color: 'text-pink-600', bg: 'bg-pink-50',
                validFor: ['person', 'object', 'food', 'place', 'activity'], 
                formula: 'どんな + N',
                meaning: 'Hỏi về tính chất, chủng loại cụ thể.',
                example: { ja: 'どんなスポーツが好きですか。', vi: 'Bạn thích môn thể thao nào?' },
                gen: (w, f) => ({
                    polite: `どんな${w.Furigana}が好きですか。`,
                    politeVi: `Bạn thích ${w['Nghĩa tiếng Việt']} kiểu nào?`,
                    casual: `どんな${w.Furigana}が好き？`,
                    casualVi: `Thích ${w['Nghĩa tiếng Việt']} kiểu gì?`
                })
            },
            // Added Day 2 specific Grammar: Place Donna
             place_donna: {
                id: 'place_donna', label: 'Tính chất 2', icon: 'search', type: 'noun',
                color: 'text-indigo-600', bg: 'bg-indigo-50',
                validFor: ['place'],
                formula: 'N1 wa donna N2 desu ka',
                meaning: 'Hỏi chi tiết về tính chất của địa điểm/người.',
                example: { ja: 'ハノイはどんな町ですか。', vi: 'Hà Nội là thành phố như thế nào?' },
                gen: (w, f) => ({
                    polite: `それはどんな${w.Furigana}ですか。`,
                    politeVi: `Đó là ${w['Nghĩa tiếng Việt']} như thế nào?`,
                    casual: `それ、どんな${w.Furigana}？`,
                    casualVi: `Đó là ${w['Nghĩa tiếng Việt']} kiểu gì?`
                })
            }
        };

        // Helper to conjugate verbs
        const teFormMap = {'みます':'みて', 'ききます':'きいて', 'よみます':'よんで', 'かきます':'かいて', 'します':'して', 'きます':'きて', 'いきます':'いって', 'かえります':'かえって', 'あそびます':'あそんで', 'もちます':'もって', 'はこびます':'はこんで', 'かいます':'かって', 'うります':'うって', 'はらいます':'はらって', 'のります':'のって', 'おります':'おりて', 'はいります':'はいって', 'でます':'でて', 'あけます':'あけて', 'しめます':'しめて', 'おぼえます':'おぼえて', 'わすれます':'わすれて', 'おくります':'おくって', 'むかえます':'むかえて', 'かします':'かして', 'かります':'かりて', 'おしえます':'おしえて', 'ならいます':'ならって', 'あげます':'あげて', 'くれます':'くれて', 'もらいます':'もらって', 'いいます':'いって', 'つたえます':'つたえて', 'はじめます':'はじめて', 'おわります':'おわって', 'かんがえます':'かんがえて', 'おもいます':'おもって', 'います':'いて', 'あります':'あって', 'まちます':'まって', 'つくります':'つくって'};
        
        function getForms(furigana) {
            const stem = furigana.replace('ます', '');
            const te = teFormMap[furigana] || stem + 'て'; 
            const ta = te.replace('て', 'た').replace('で', 'だ');
            return { stem, te, ta };
        }

        // --- 2. VOCABULARY DATA (Day 2 - 87 Words) ---
        const vocabData = [
            { "STT": 1, "Kanji": "見ます", "Nghĩa tiếng Việt": "xem", "Furigana": "みます", "type": "verb" },
            { "STT": 2, "Kanji": "聞きます", "Nghĩa tiếng Việt": "nghe", "Furigana": "ききます", "type": "verb" },
            { "STT": 3, "Kanji": "読みます", "Nghĩa tiếng Việt": "đọc", "Furigana": "よみます", "type": "verb" },
            { "STT": 4, "Kanji": "書きます", "Nghĩa tiếng Việt": "viết", "Furigana": "かきます", "type": "verb" },
            { "STT": 5, "Kanji": "します", "Nghĩa tiếng Việt": "làm", "Furigana": "します", "type": "verb" },
            { "STT": 6, "Kanji": "来ます", "Nghĩa tiếng Việt": "đến", "Furigana": "きます", "type": "verb" },
            { "STT": 7, "Kanji": "行きます", "Nghĩa tiếng Việt": "đi", "Furigana": "いきます", "type": "verb" },
            { "STT": 8, "Kanji": "帰ります", "Nghĩa tiếng Việt": "về", "Furigana": "かえります", "type": "verb" },
            { "STT": 9, "Kanji": "遊びます", "Nghĩa tiếng Việt": "chơi", "Furigana": "あそびます", "type": "verb" },
            { "STT": 10, "Kanji": "持ちます", "Nghĩa tiếng Việt": "cầm", "Furigana": "もちます", "type": "verb" },
            { "STT": 11, "Kanji": "運びます", "Nghĩa tiếng Việt": "vận chuyển", "Furigana": "はこびます", "type": "verb" },
            { "STT": 12, "Kanji": "買います", "Nghĩa tiếng Việt": "mua", "Furigana": "かいます", "type": "verb" },
            { "STT": 13, "Kanji": "売ります", "Nghĩa tiếng Việt": "bán", "Furigana": "うります", "type": "verb" },
            { "STT": 14, "Kanji": "払います", "Nghĩa tiếng Việt": "thanh toán", "Furigana": "はらいます", "type": "verb" },
            { "STT": 15, "Kanji": "乗ります", "Nghĩa tiếng Việt": "lên xe", "Furigana": "のります", "type": "verb" },
            { "STT": 16, "Kanji": "降ります", "Nghĩa tiếng Việt": "xuống xe", "Furigana": "おります", "type": "verb" },
            { "STT": 17, "Kanji": "入ります", "Nghĩa tiếng Việt": "vào", "Furigana": "はいります", "type": "verb" },
            { "STT": 18, "Kanji": "出ます", "Nghĩa tiếng Việt": "ra", "Furigana": "でます", "type": "verb" },
            { "STT": 19, "Kanji": "開けます", "Nghĩa tiếng Việt": "mở", "Furigana": "あけます", "type": "verb" },
            { "STT": 20, "Kanji": "閉めます", "Nghĩa tiếng Việt": "đóng", "Furigana": "しめます", "type": "verb" },
            { "STT": 21, "Kanji": "覚えます", "Nghĩa tiếng Việt": "nhớ", "Furigana": "おぼえます", "type": "verb" },
            { "STT": 22, "Kanji": "忘れます", "Nghĩa tiếng Việt": "quên", "Furigana": "わすれます", "type": "verb" },
            { "STT": 23, "Kanji": "送ります", "Nghĩa tiếng Việt": "gửi", "Furigana": "おくります", "type": "verb" },
            { "STT": 24, "Kanji": "迎えます", "Nghĩa tiếng Việt": "đón", "Furigana": "むかえます", "type": "verb" },
            { "STT": 25, "Kanji": "貸します", "Nghĩa tiếng Việt": "cho mượn", "Furigana": "かします", "type": "verb" },
            { "STT": 26, "Kanji": "借ります", "Nghĩa tiếng Việt": "mượn", "Furigana": "かります", "type": "verb" },
            { "STT": 27, "Kanji": "教えます", "Nghĩa tiếng Việt": "dạy", "Furigana": "おしえます", "type": "verb" },
            { "STT": 28, "Kanji": "習います", "Nghĩa tiếng Việt": "học", "Furigana": "ならいます", "type": "verb" },
            { "STT": 29, "Kanji": "あげます", "Nghĩa tiếng Việt": "tặng", "Furigana": "あげます", "type": "verb" },
            { "STT": 30, "Kanji": "くれます", "Nghĩa tiếng Việt": "cho (tôi)", "Furigana": "くれます", "type": "verb" },
            { "STT": 31, "Kanji": "もらいます", "Nghĩa tiếng Việt": "nhận", "Furigana": "もらいます", "type": "verb" },
            { "STT": 32, "Kanji": "言います", "Nghĩa tiếng Việt": "nói", "Furigana": "いいます", "type": "verb" },
            { "STT": 33, "Kanji": "伝えます", "Nghĩa tiếng Việt": "truyền đạt", "Furigana": "つたえます", "type": "verb" },
            { "STT": 34, "Kanji": "始めます", "Nghĩa tiếng Việt": "bắt đầu", "Furigana": "はじめます", "type": "verb" },
            { "STT": 35, "Kanji": "終わります", "Nghĩa tiếng Việt": "kết thúc", "Furigana": "おわります", "type": "verb" },
            { "STT": 36, "Kanji": "考えます", "Nghĩa tiếng Việt": "suy nghĩ", "Furigana": "かんがえます", "type": "verb" },
            { "STT": 37, "Kanji": "思います", "Nghĩa tiếng Việt": "nghĩ", "Furigana": "おもいます", "type": "verb" },
            { "STT": 38, "Kanji": "います", "Nghĩa tiếng Việt": "có (người)", "Furigana": "います", "type": "verb" },
            { "STT": 39, "Kanji": "あります", "Nghĩa tiếng Việt": "có (vật)", "Furigana": "あります", "type": "verb" },
            { "STT": 40, "Kanji": "待ちます", "Nghĩa tiếng Việt": "đợi", "Furigana": "まちます", "type": "verb" },
            { "STT": 41, "Kanji": "さん", "Nghĩa tiếng Việt": "anh/chị", "Furigana": "さん", "type": "noun", "subType": "suffix" },
            { "STT": 42, "Kanji": "ちゃん", "Nghĩa tiếng Việt": "bé (gái)", "Furigana": "ちゃん", "type": "noun", "subType": "suffix" },
            { "STT": 43, "Kanji": "くん", "Nghĩa tiếng Việt": "bé (trai)", "Furigana": "くん", "type": "noun", "subType": "suffix" },
            { "STT": 44, "Kanji": "先生", "Nghĩa tiếng Việt": "giáo viên", "Furigana": "せんせい", "type": "noun", "subType": "person" },
            { "STT": 45, "Kanji": "教師", "Nghĩa tiếng Việt": "giáo viên (nghề)", "Furigana": "きょうし", "type": "noun", "subType": "person" },
            { "STT": 46, "Kanji": "学生", "Nghĩa tiếng Việt": "học sinh", "Furigana": "がくせい", "type": "noun", "subType": "person" },
            { "STT": 47, "Kanji": "会社員", "Nghĩa tiếng Việt": "nhân viên", "Furigana": "かいしゃいん", "type": "noun", "subType": "person" },
            { "STT": 48, "Kanji": "医者", "Nghĩa tiếng Việt": "bác sĩ", "Furigana": "いしゃ", "type": "noun", "subType": "person" },
            { "STT": 49, "Kanji": "警察官", "Nghĩa tiếng Việt": "cảnh sát", "Furigana": "けいさつかん", "type": "noun", "subType": "person" },
            { "STT": 50, "Kanji": "エンジニア", "Nghĩa tiếng Việt": "kỹ sư", "Furigana": "エンジニア", "type": "noun", "subType": "person" },
            { "STT": 51, "Kanji": "銀行員", "Nghĩa tiếng Việt": "nhân viên NH", "Furigana": "ぎんこういん", "type": "noun", "subType": "person" },
            { "STT": 52, "Kanji": "実習生", "Nghĩa tiếng Việt": "thực tập sinh", "Furigana": "じっしゅうせい", "type": "noun", "subType": "person" },
            { "STT": 53, "Kanji": "留学生", "Nghĩa tiếng Việt": "du học sinh", "Furigana": "りゅうがくせい", "type": "noun", "subType": "person" },
            { "STT": 54, "Kanji": "ベトナム", "Nghĩa tiếng Việt": "Việt Nam", "Furigana": "ベトナム", "type": "noun", "subType": "place" },
            { "STT": 55, "Kanji": "日本", "Nghĩa tiếng Việt": "Nhật Bản", "Furigana": "にほん", "type": "noun", "subType": "place" },
            { "STT": 56, "Kanji": "中国", "Nghĩa tiếng Việt": "Trung Quốc", "Furigana": "ちゅうごく", "type": "noun", "subType": "place" },
            { "STT": 57, "Kanji": "韓国", "Nghĩa tiếng Việt": "Hàn Quốc", "Furigana": "かんこく", "type": "noun", "subType": "place" },
            { "STT": 58, "Kanji": "トイレ", "Nghĩa tiếng Việt": "nhà vệ sinh", "Furigana": "トイレ", "type": "noun", "subType": "place" },
            { "STT": 59, "Kanji": "時計", "Nghĩa tiếng Việt": "đồng hồ", "Furigana": "とけい", "type": "noun", "subType": "object" },
            { "STT": 60, "Kanji": "そうです", "Nghĩa tiếng Việt": "đúng vậy", "Furigana": "そうです", "type": "phrase", "subType": "abstract" },
            { "STT": 61, "Kanji": "違います", "Nghĩa tiếng Việt": "sai rồi", "Furigana": "ちがいます", "type": "phrase", "subType": "abstract" },
            { "STT": 62, "Kanji": "ご飯", "Nghĩa tiếng Việt": "cơm", "Furigana": "ごはん", "type": "noun", "subType": "food" },
            { "STT": 63, "Kanji": "肉", "Nghĩa tiếng Việt": "thịt", "Furigana": "にく", "type": "noun", "subType": "food" },
            { "STT": 64, "Kanji": "パン", "Nghĩa tiếng Việt": "bánh mì", "Furigana": "パン", "type": "noun", "subType": "food" },
            { "STT": 65, "Kanji": "卵", "Nghĩa tiếng Việt": "trứng", "Furigana": "たまご", "type": "noun", "subType": "food" },
            { "STT": 66, "Kanji": "野菜", "Nghĩa tiếng Việt": "rau", "Furigana": "やさい", "type": "noun", "subType": "food" },
            { "STT": 67, "Kanji": "スープ", "Nghĩa tiếng Việt": "súp", "Furigana": "スープ", "type": "noun", "subType": "food" },
            { "STT": 68, "Kanji": "料理", "Nghĩa tiếng Việt": "món ăn", "Furigana": "りょうり", "type": "noun", "subType": "food" },
            { "STT": 69, "Kanji": "水", "Nghĩa tiếng Việt": "nước", "Furigana": "みず", "type": "noun", "subType": "food" },
            { "STT": 70, "Kanji": "ビール", "Nghĩa tiếng Việt": "bia", "Furigana": "ビール", "type": "noun", "subType": "food" },
            { "STT": 71, "Kanji": "牛乳", "Nghĩa tiếng Việt": "sữa bò", "Furigana": "ぎゅうにゅう", "type": "noun", "subType": "food" },
            { "STT": 72, "Kanji": "映画", "Nghĩa tiếng Việt": "phim", "Furigana": "えいが", "type": "noun", "subType": "activity" },
            { "STT": 73, "Kanji": "スポーツ", "Nghĩa tiếng Việt": "thể thao", "Furigana": "スポーツ", "type": "noun", "subType": "activity" },
            { "STT": 74, "Kanji": "サッカー", "Nghĩa tiếng Việt": "bóng đá", "Furigana": "サッカー", "type": "noun", "subType": "activity" },
            { "STT": 75, "Kanji": "野球", "Nghĩa tiếng Việt": "bóng chày", "Furigana": "やきゅう", "type": "noun", "subType": "activity" },
            { "STT": 76, "Kanji": "パーティー", "Nghĩa tiếng Việt": "bữa tiệc", "Furigana": "パーティー", "type": "noun", "subType": "activity" },
            { "STT": 77, "Kanji": "宿題", "Nghĩa tiếng Việt": "bài tập", "Furigana": "しゅくだい", "type": "noun", "subType": "object" },
            { "STT": 78, "Kanji": "作ります", "Nghĩa tiếng Việt": "làm, chế tạo", "Furigana": "つくります", "type": "verb" },
            { "STT": 79, "Kanji": "語", "Nghĩa tiếng Việt": "tiếng", "Furigana": "ご", "type": "noun", "subType": "abstract" },
            { "STT": 80, "Kanji": "英語", "Nghĩa tiếng Việt": "tiếng Anh", "Furigana": "えいご", "type": "noun", "subType": "abstract" },
            { "STT": 81, "Kanji": "たくさん", "Nghĩa tiếng Việt": "nhiều", "Furigana": "たくさん", "type": "adverb", "subType": "abstract" },
            { "STT": 82, "Kanji": "少し", "Nghĩa tiếng Việt": "một chút", "Furigana": "すこし", "type": "adverb", "subType": "abstract" },
            { "STT": 83, "Kanji": "全然", "Nghĩa tiếng Việt": "hoàn toàn (không)", "Furigana": "ぜんぜん", "type": "adverb", "subType": "abstract" },
            { "STT": 84, "Kanji": "朝", "Nghĩa tiếng Việt": "buổi sáng", "Furigana": "あさ", "type": "noun", "subType": "time" },
            { "STT": 85, "Kanji": "今朝", "Nghĩa tiếng Việt": "sáng nay", "Furigana": "けさ", "type": "noun", "subType": "time" },
            { "STT": 86, "Kanji": "昼", "Nghĩa tiếng Việt": "buổi trưa", "Furigana": "ひる", "type": "noun", "subType": "time" },
            { "STT": 87, "Kanji": "夕方", "Nghĩa tiếng Việt": "chiều tối", "Furigana": "ゆうがた", "type": "noun", "subType": "time" }
        ];

        let currentIndex = 0; let currentQuiz = null; let score = 0; let currentStrokeSvg = null;

        // --- CORE FUNCTIONS ---
        function init() { renderList(); renderGrammarList(); loadWord(0); }
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            document.getElementById('learn-section').classList.toggle('hidden', tab!=='learn');
            document.getElementById('quiz-section').classList.toggle('hidden', tab!=='quiz');
            if(tab === 'quiz') nextQuestion();
        }
        function renderList() {
            const listD = document.getElementById('vocabList'); const listM = document.getElementById('mobileVocabList');
            const html = vocabData.map((item, i) => `
                <div class="vocab-item p-3 mb-1 rounded-xl cursor-pointer hover:bg-indigo-50 transition-colors border border-transparent ${i===0?'active':''}" 
                     data-index="${i}" onclick="loadWord(${i}); if(window.innerWidth<768) toggleDrawer();">
                    <div class="flex justify-between items-center"><span class="font-bold text-gray-800 ja-text">${item.Kanji||item.Furigana}</span><span class="text-[10px] font-bold text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded">#${item.STT}</span></div>
                    <div class="text-xs text-gray-500 truncate mt-0.5">${item['Nghĩa tiếng Việt']}</div>
                </div>`).join('');
            if(listD) listD.innerHTML = html; if(listM) listM.innerHTML = html;
        }
        function loadWord(idx) {
            currentIndex = idx; const word = vocabData[idx];
            document.querySelectorAll('.vocab-item').forEach(el => { el.classList.remove('active'); el.classList.add('border-transparent'); });
            document.querySelectorAll(`.vocab-item[data-index="${idx}"]`).forEach(el => { el.classList.add('active'); el.classList.remove('border-transparent'); });
            
            document.getElementById('headerProgress').innerText = `${idx+1}/${vocabData.length}`;
            const wi = document.getElementById('wordIndex'); if(wi) wi.innerText = `#${word.STT}`;
            document.getElementById('cardKanji').innerText = word.Kanji || word.Furigana;
            document.getElementById('cardFurigana').innerText = word.Furigana;
            document.getElementById('cardMeaning').innerText = word['Nghĩa tiếng Việt'];
            document.getElementById('wordType').innerText = word.type.toUpperCase();
            
            const hasK = word.Kanji && word.Kanji !== word.Furigana;
            const sb = document.getElementById('strokeBtn'); if(sb) sb.classList.toggle('hidden', !hasK);
            renderContexts(word);
        }
        function renderContexts(word) {
            const cont = document.getElementById('sentenceList'); const empty = document.getElementById('emptyState');
            cont.innerHTML = ''; let hasContext = false;
            Object.values(grammarDefs).forEach(rule => {
                const subType = word.subType || 'general';
                if (!rule.validFor.includes(word.type) && !rule.validFor.includes(subType)) return;
                
                let forms = {};
                if(word.type==='verb') forms = getForms(word.Furigana);
                
                const data = rule.gen(word, forms);
                if(!data) return;
                hasContext = true;
                
                const card = document.createElement('div');
                card.className = "shadow-card bg-white rounded-2xl p-4 border border-gray-100";
                card.innerHTML = `
                    <div class="flex items-center justify-between mb-3 border-b border-gray-50 pb-2">
                        <div class="flex items-center gap-2"><div class="bg-indigo-50 p-1.5 rounded-lg text-indigo-600"><i class="fas fa-${rule.icon}"></i></div><span class="text-xs font-bold text-gray-500 uppercase tracking-wide">${rule.label}</span></div>
                        <button onclick="openGrammarDetail('${rule.id}')" class="text-xs text-indigo-500 bg-indigo-50 hover:bg-indigo-100 px-2 py-1 rounded-full transition flex items-center gap-1"><i class="fas fa-book-open"></i> Ngữ pháp</button>
                    </div>
                    <div class="mb-3 pl-2 border-l-2 border-indigo-200">
                        <div class="flex justify-between items-start"><div><div class="text-base font-medium text-gray-800 ja-text">${data.polite}</div><div class="text-xs text-gray-500 italic">${data.politeVi}</div></div><button onclick="speakText('${data.polite}')" class="audio-btn text-indigo-400 hover:text-indigo-600 p-1"><i class="fas fa-volume-up"></i></button></div>
                    </div>
                    <div class="pl-2 border-l-2 border-pink-200">
                        <div class="flex justify-between items-start"><div><div class="flex items-center gap-2"><div class="text-base font-medium text-gray-800 ja-text">${data.casual}</div><span class="text-[10px] bg-pink-50 text-pink-600 px-1.5 rounded font-bold">Thân mật</span></div><div class="text-xs text-gray-500 italic">${data.casualVi}</div></div><button onclick="speakText('${data.casual}')" class="audio-btn text-pink-400 hover:text-pink-600 p-1"><i class="fas fa-volume-up"></i></button></div>
                    </div>`;
                cont.appendChild(card);
            });
            empty.classList.toggle('hidden', hasContext); empty.classList.toggle('flex', !hasContext);
        }
        
        // --- MODAL LOGIC ---
        function renderGrammarList() {
            const grid = document.getElementById('grammarGrid'); grid.innerHTML = '';
            Object.values(grammarDefs).forEach(r => {
                grid.innerHTML += `<div class="bg-white rounded-xl border border-gray-100 p-4 shadow-sm hover:shadow-md transition cursor-pointer" onclick="closeModal('grammarListModal'); openGrammarDetail('${r.id}')"><div class="flex items-center gap-3 mb-2"><div class="w-8 h-8 rounded-full ${r.bg} ${r.color} flex items-center justify-center"><i class="fas fa-${r.icon} text-sm"></i></div><h4 class="font-bold text-gray-800 text-sm">${r.label}</h4></div><div class="bg-slate-50 rounded px-2 py-1 text-xs font-mono text-slate-600 mb-2 inline-block">${r.formula}</div><p class="text-xs text-gray-500 line-clamp-2">${r.meaning}</p></div>`;
            });
        }
        function openGrammarList() { showModal('grammarListModal'); }
        function openGrammarDetail(id) {
            const r = grammarDefs[id]; if(!r) return;
            document.getElementById('modalTitle').innerText = r.label; document.getElementById('modalIcon').className = `fas fa-${r.icon}`;
            document.getElementById('modalFormula').innerText = r.formula; document.getElementById('modalExplanation').innerText = r.meaning;
            document.getElementById('modalExampleJa').innerText = r.example.ja; document.getElementById('modalExampleVi').innerText = r.example.vi;
            document.getElementById('modalPlayBtn').onclick = () => speakText(r.example.ja);
            showModal('detailModal');
        }
        function showModal(id) {
            document.getElementById(id).classList.remove('hidden');
            setTimeout(() => { document.getElementById(id.replace('Modal','Backdrop')).classList.remove('opacity-0'); document.getElementById(id.replace('Modal','Panel')).classList.remove('opacity-0', 'scale-95'); }, 10);
        }
        function closeModal(id) {
            document.getElementById(id.replace('Modal','Backdrop')).classList.add('opacity-0');
            document.getElementById(id.replace('Modal','Panel')).classList.add('opacity-0', 'scale-95');
            setTimeout(() => document.getElementById(id).classList.add('hidden'), 200);
        }
        
        async function openStrokeModal(char) {
            const word = vocabData[currentIndex]; const kanjis = word.Kanji.match(/[\u4e00-\u9faf]/g)||[];
            if(kanjis.length===0) return;
            const target = char || kanjis[0];
            const tabs = document.getElementById('strokeTabs'); tabs.innerHTML = '';
            if(kanjis.length>1) kanjis.forEach(k => {
                const b = document.createElement('button'); b.innerText = k;
                b.className = `w-10 h-10 rounded-lg font-bold border transition ${k===target?'bg-pink-600 text-white':'bg-white text-gray-600'}`;
                b.onclick = () => showKanjiStroke(k); tabs.appendChild(b);
            });
            showModal('strokeModal'); await showKanjiStroke(target);
        }
        function getKanjiHex(k) { return k.charCodeAt(0).toString(16).padStart(5, '0'); }
        async function showKanjiStroke(k) {
            const d = kanjiDetails[k]; const content = document.getElementById('kanjiDetailContent'); const empty = document.getElementById('kanjiDetailEmpty');
            if(d) {
                content.classList.remove('hidden'); empty.classList.add('hidden');
                document.getElementById('detailKanji').innerText=k; document.getElementById('detailHanViet').innerText=d.hanviet;
                document.getElementById('detailMeaning').innerText=d.mean; document.getElementById('detailOn').innerText=d.on; document.getElementById('detailKun').innerText=d.kun;
                const fmt = s => s.replace(/\*\*(.*?)\*\*/g, '<span class="font-bold text-gray-900">$1</span>');
                document.getElementById('detailTipImg').innerHTML=fmt(d.tipImg); document.getElementById('detailTipSound').innerHTML=fmt(d.tipSound);
                const wc = document.getElementById('detailWords'); wc.innerHTML='';
                d.words.forEach(w => wc.innerHTML+=`<div class="flex justify-between items-center bg-gray-50 p-2 rounded hover:bg-gray-100 cursor-pointer" onclick="speakText('${w.w.split(' ')[0]}')"><span class="text-sm font-bold text-indigo-700 ja-text">${w.w}</span><span class="text-xs text-gray-500">${w.m}</span></div>`);
            } else { content.classList.add('hidden'); empty.classList.remove('hidden'); }
            
            const anim = document.getElementById('strokeAnimContainer'); const grid = document.getElementById('strokeGridContainer');
            anim.innerHTML = '<span class="text-xs text-gray-400">Loading...</span>'; grid.innerHTML='';
            try {
                const r = await fetch(`https://cdn.jsdelivr.net/gh/KanjiVG/kanjivg/kanji/${getKanjiHex(k)}.svg`);
                if(!r.ok) throw new Error();
                const svg = await r.text();
                anim.innerHTML = svg;
                const mainSvg = anim.querySelector('svg'); mainSvg.setAttribute('width','100%'); mainSvg.setAttribute('height','100%');
                currentStrokeSvg = mainSvg;
                const paths = mainSvg.querySelectorAll('path');
                paths.forEach(p => { p.style.stroke="#333"; p.style.strokeWidth="4"; p.style.fill="none"; p.style.strokeLinecap="round"; p.style.strokeLinejoin="round"; });
                replayStrokeAnimation();
                const parser = new DOMParser();
                paths.forEach((_, i) => {
                    const box = document.createElement('div'); box.className="w-16 h-16 bg-white border border-gray-200 relative stroke-grid-box flex items-center justify-center rounded";
                    const cloneDoc = parser.parseFromString(svg, "image/svg+xml"); const clone = cloneDoc.querySelector('svg');
                    clone.setAttribute('width','100%'); clone.setAttribute('height','100%');
                    clone.querySelectorAll('path').forEach((p, idx) => {
                        p.style.fill="none"; p.style.strokeLinecap="round"; p.style.strokeLinejoin="round";
                        if(idx<i) { p.style.stroke="#e5e7eb"; p.style.strokeWidth="3"; }
                        else if(idx===i) { p.style.stroke="#db2777"; p.style.strokeWidth="4"; }
                        else p.style.display="none";
                    });
                    box.appendChild(clone); grid.appendChild(box);
                });
            } catch(e) { anim.innerHTML="<p class='text-xs text-red-500'>Error</p>"; }
        }
        function replayStrokeAnimation() {
            if(!currentStrokeSvg) return;
            const paths = currentStrokeSvg.querySelectorAll('path');
            paths.forEach(p => { p.style.transition='none'; p.style.strokeDasharray=p.getTotalLength(); p.style.strokeDashoffset=p.getTotalLength(); });
            void currentStrokeSvg.offsetWidth;
            let d = 0;
            paths.forEach(p => { p.style.transition=`stroke-dashoffset 0.8s ease-in-out ${d}s`; p.style.strokeDashoffset='0'; d+=0.8; });
        }

        // --- UTILS ---
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            document.getElementById('learn-section').classList.toggle('hidden', tab!=='learn');
            document.getElementById('quiz-section').classList.toggle('hidden', tab!=='quiz');
            if(tab === 'quiz') nextQuestion();
        }

        function speakText(t) { const u = new SpeechSynthesisUtterance(t); u.lang='ja-JP'; speechSynthesis.speak(u); }
        function speakCurrent() { speakText(vocabData[currentIndex].Furigana); }
        function playQuizAudio() { if(currentQuiz) speakText(currentQuiz.Furigana); }
        function toggleDrawer() {
            const d = document.getElementById('mobileDrawer'); const c = document.getElementById('drawerContent'); const b = document.getElementById('drawerBackdrop');
            if(d.classList.contains('pointer-events-none')) { d.classList.remove('pointer-events-none'); requestAnimationFrame(() => { c.classList.remove('-translate-x-full'); b.classList.remove('opacity-0'); }); }
            else { c.classList.add('-translate-x-full'); b.classList.add('opacity-0'); setTimeout(() => d.classList.add('pointer-events-none'), 300); }
        }
        
        // --- QUIZ ---
        function nextQuestion() {
            document.getElementById('feedback-area').classList.add('hidden'); document.getElementById('btn-check').classList.remove('hidden'); document.getElementById('btn-next').classList.add('hidden');
            const inp = document.getElementById('quiz-input'); inp.value=''; inp.disabled=false; inp.focus();
            currentQuiz = vocabData[Math.floor(Math.random()*vocabData.length)];
            document.getElementById('quiz-kanji').innerText = currentQuiz.Kanji || currentQuiz.Furigana;
            document.getElementById('quiz-meaning').innerText = currentQuiz['Nghĩa tiếng Việt'];
            document.getElementById('quiz-kanji').className = "text-6xl md:text-7xl kanji-font font-bold text-gray-800 mb-4 transition-all";
        }
        function checkAnswer() {
            const inp = document.getElementById('quiz-input'); if(!inp.value.trim()) return;
            inp.disabled=true; const correct = inp.value.trim()===currentQuiz.Furigana;
            const k = document.getElementById('quiz-kanji'); const fb = document.getElementById('feedback-title');
            if(correct) { score+=10; k.className+=" text-green-600 correct-anim"; fb.innerHTML='<i class="fas fa-check-circle text-green-600 mr-2"></i> Chính xác!'; speakText(currentQuiz.Furigana); }
            else { score=Math.max(0,score-5); k.className+=" text-red-600 wrong-anim"; fb.innerHTML='<i class="fas fa-times-circle text-red-600 mr-2"></i> Sai rồi!'; }
            document.getElementById('score-display').innerText=score; document.getElementById('correct-answer').innerText=currentQuiz.Furigana;
            document.getElementById('feedback-area').classList.remove('hidden'); document.getElementById('btn-check').classList.add('hidden'); document.getElementById('btn-next').classList.remove('hidden'); document.getElementById('btn-next').focus();
        }

        // Listeners
        function nextWord() { if(currentIndex<vocabData.length-1) loadWord(currentIndex+1); }
        function prevWord() { if(currentIndex>0) loadWord(currentIndex-1); }
        document.getElementById('searchInput').addEventListener('input', e => { const t = e.target.value.toLowerCase(); document.querySelectorAll('.vocab-item').forEach(el => el.style.display = el.innerText.toLowerCase().includes(t) ? 'block' : 'none'); });
        document.getElementById('mobileSearchInput').addEventListener('input', e => { const t = e.target.value.toLowerCase(); document.querySelectorAll('.vocab-item').forEach(el => el.style.display = el.innerText.toLowerCase().includes(t) ? 'block' : 'none'); });
        document.getElementById('quiz-input').addEventListener('keypress', e => { if(e.key==='Enter') checkAnswer(); });

        init();
    </script>
</body>
</html>
