<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AzaKanji - Hội Thoại & Ngữ Pháp (Day 23)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #f3f4f6; overflow-x: hidden; }
        .kanji-font { font-family: 'Noto Sans JP', sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Ruby Text Styling */
        ruby rt { font-size: 0.6em; color: #64748b; user-select: none; }
        .hide-furigana ruby rt { visibility: hidden; }

        /* Animations */
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .card-transition { transition: all 0.3s ease-in-out; }
        
        /* Highlight classes for Typing */
        .correct-char { color: #16a34a; font-weight: bold; }
        .incorrect-char { color: #dc2626; text-decoration: underline; font-weight: bold; }
        .correct-input { border-color: #22c55e !important; background-color: #f0fdf4 !important; }
        .wrong-input { border-color: #ef4444 !important; background-color: #fef2f2 !important; }
        
        /* Microphone Animation */
        .mic-listening { animation: pulse-red 1.5s infinite; color: #dc2626 !important; border-color: #dc2626 !important; }
        @keyframes pulse-red { 
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); } 
            70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); } 
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } 
        }

        /* Tab Transitions */
        .tab-btn { transition: all 0.3s ease; }
        .tab-active { background-color: #0284c7; color: white; shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .tab-inactive { background-color: #f3f4f6; color: #4b5563; }
        .tab-inactive:hover { background-color: #e5e7eb; }

        /* Progress Bar */
        .progress-container { background-color: #e5e7eb; border-radius: 999px; height: 8px; width: 100%; overflow: hidden; margin-top: 10px; }
        .progress-fill { background-color: #10b981; height: 100%; width: 0%; transition: width 0.5s ease-in-out; }

        /* Active playing line */
        .playing-line { border-left: 4px solid #0ea5e9; background-color: #f0f9ff !important; }

        /* STROKE ORDER STYLES */
        .stroke-path {
            fill: none;
            stroke: #333;
            stroke-width: 3;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .stroke-grid-box {
            border: 1px solid #e5e7eb;
            background-color: white;
            position: relative;
        }
        /* Dotted lines for kanji grid */
        .stroke-grid-box::after {
            content: ''; position: absolute; top: 0; left: 50%; width: 1px; height: 100%;
            background: repeating-linear-gradient(to bottom, #ddd 0, #ddd 4px, transparent 4px, transparent 8px); z-index: 0;
        }
        .stroke-grid-box::before {
            content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 1px;
            background: repeating-linear-gradient(to right, #ddd 0, #ddd 4px, transparent 4px, transparent 8px); z-index: 0;
        }

        /* Mobile Optimization for Quiz Options */
        .quiz-option {
            touch-action: manipulation; /* Improves touch response */
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Header -->
    <header class="bg-sky-700 text-white shadow-lg sticky top-0 z-40">
        <div class="container mx-auto px-4 py-3">
            <div class="flex flex-col md:flex-row justify-between items-center gap-3">
                <!-- Logo Area -->
                <div class="flex items-center space-x-3 cursor-pointer self-start md:self-auto" onclick="location.reload()">
                    <i class="fas fa-torii-gate text-2xl md:text-3xl text-yellow-300"></i>
                    <div>
                        <h1 class="text-lg md:text-xl font-bold uppercase tracking-wider leading-tight">AzaKanji Kaiwa</h1>
                        <p class="text-[10px] md:text-xs text-sky-200">Học Hội Thoại & Ngữ Pháp (Day 23)</p>
                    </div>
                </div>
                
                <!-- Controls (Scrollable on mobile) -->
                <div class="w-full md:w-auto flex items-center overflow-x-auto pb-1 md:pb-0 no-scrollbar">
                    <div class="flex bg-sky-800 rounded-lg p-1 text-sm whitespace-nowrap mx-auto md:mx-0">
                        <button id="btn-toggle-furigana" class="px-2 md:px-3 py-1.5 rounded transition hover:bg-sky-600 text-white flex items-center" title="Bật/Tắt cách đọc Kanji">
                            <i class="fas fa-eye mr-1 md:mr-2"></i> Furi
                        </button>
                        <button id="btn-toggle-romaji" class="px-2 md:px-3 py-1.5 rounded transition hover:bg-sky-600 text-white flex items-center ml-1" title="Bật/Tắt phiên âm Romaji">
                            <i class="fas fa-font mr-1 md:mr-2"></i> Romaji
                        </button>
                        <button id="btn-toggle-vi" class="px-2 md:px-3 py-1.5 rounded transition bg-white text-sky-800 font-bold ml-1 flex items-center" title="Bật/Tắt dịch tiếng Việt">
                            <i class="fas fa-language mr-1 md:mr-2"></i> Việt
                        </button>
                        
                        <!-- Audio Speed Control -->
                        <div class="flex items-center px-2 ml-1 border-l border-sky-600 text-white">
                            <i class="fas fa-tachometer-alt mr-1 text-sky-300 text-xs"></i>
                            <select id="audio-speed" class="bg-transparent border-none focus:ring-0 text-white font-bold cursor-pointer text-xs p-0">
                                <option value="0.75" class="text-gray-800">0.75x</option>
                                <option value="1.0" class="text-gray-800" selected>1.0x</option>
                                <option value="1.25" class="text-gray-800">1.25x</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-3 md:px-4 py-4 md:py-8 flex-grow space-y-6 md:space-y-8" id="app">
        
        <!-- Progress Section -->
        <div class="w-full max-w-4xl mx-auto mb-2 bg-white p-3 rounded-lg shadow-sm border border-gray-100">
            <div class="flex justify-between text-xs text-gray-500 mb-1 font-bold">
                <span>Tiến độ học tập</span>
                <span id="progress-text">0%</span>
            </div>
            <div class="progress-container">
                <div id="progress-bar" class="progress-fill"></div>
            </div>
        </div>

        <!-- 1. Conversation Section -->
        <section class="bg-white rounded-xl md:rounded-2xl shadow-md overflow-hidden fade-in border border-gray-100">
            <div class="bg-sky-50 px-4 md:px-6 py-3 md:py-4 border-b border-sky-100">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-3">
                    <h2 class="text-lg md:text-xl font-bold text-sky-800 flex items-center flex-wrap">
                        <span class="flex items-center"><i class="fas fa-comments mr-2"></i>Hội Thoại: Tương Phản & Đề Xuất</span>
                        <button onclick="playAllConversation()" class="ml-auto md:ml-3 text-xs md:text-sm bg-sky-100 text-sky-700 hover:bg-sky-200 px-3 py-1 rounded-full transition flex items-center whitespace-nowrap">
                            <i class="fas fa-play mr-1"></i> Nghe hết
                        </button>
                    </h2>
                    
                    <!-- Mode Tabs -->
                    <div class="flex bg-white rounded-lg p-1 shadow-sm border border-gray-200 w-full md:w-auto">
                        <button onclick="switchMode('polite')" id="tab-polite" class="tab-btn tab-active flex-1 md:flex-none px-2 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-bold text-center">Lịch sự</button>
                        <button onclick="switchMode('casual')" id="tab-casual" class="tab-btn tab-inactive flex-1 md:flex-none px-2 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-bold ml-1 text-center">Thông thường</button>
                    </div>
                </div>
            </div>
            
            <div class="p-3 md:p-6 space-y-4 md:space-y-6" id="conversation-container">
                <!-- Dialogue injected by JS -->
            </div>
        </section>

        <!-- 2. Reading Section -->
        <section class="bg-white rounded-xl md:rounded-2xl shadow-md overflow-hidden fade-in border border-gray-100">
            <div class="bg-orange-50 px-4 md:px-6 py-3 md:py-4 border-b border-orange-100">
                <h2 class="text-lg md:text-xl font-bold text-orange-800"><i class="fas fa-book-open mr-2"></i>Bài Đọc: Công Việc & Sức Khỏe</h2>
            </div>
            <div class="p-4 md:p-6">
                <div class="bg-orange-50/30 p-3 md:p-5 rounded-xl border border-orange-100 leading-loose text-base md:text-lg kanji-font mb-2 text-justify" id="reading-text"></div>
                <div class="text-gray-500 text-sm mb-4 italic hidden romaji-text" id="reading-romaji"></div>
                <div class="text-gray-700 text-sm mb-4 hidden vi-trans border-t border-orange-100 pt-2" id="reading-vi"></div>
                
                <!-- Reading Practice Area -->
                <div class="mt-6 pt-4 border-t border-gray-100">
                    <h4 class="text-sm font-bold text-gray-500 mb-2 uppercase flex items-center"><i class="fas fa-keyboard mr-2"></i> Luyện gõ lại bài đọc:</h4>
                    <textarea id="reading-input" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-200 bg-gray-50 text-base kanji-font h-32" placeholder="Gõ lại nội dung bài đọc bằng tiếng Nhật vào đây..."></textarea>
                    <div id="reading-feedback" class="text-sm mt-2 min-h-[1.5rem]"></div>
                </div>
            </div>
        </section>

        <!-- 3. Grammar Section -->
        <section class="bg-white rounded-xl md:rounded-2xl shadow-md overflow-hidden fade-in border border-gray-100">
            <div class="bg-purple-50 px-4 md:px-6 py-3 md:py-4 border-b border-purple-100">
                <h2 class="text-lg md:text-xl font-bold text-purple-800"><i class="fas fa-star mr-2"></i>Ngữ Pháp Quan Trọng</h2>
            </div>
            <div class="p-4 md:p-6 grid grid-cols-1 md:grid-cols-2 gap-4" id="grammar-container"></div>
        </section>

        <!-- 4. Vocabulary Flashcards -->
        <section class="fade-in">
            <div class="flex items-center justify-between mb-4 px-2">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800"><i class="fas fa-tags mr-2 text-sky-600"></i>Thẻ Kanji</h2>
                <div class="flex items-center gap-2">
                    <button onclick="shuffleVocab()" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1 rounded-full font-bold transition flex items-center">
                        <i class="fas fa-random mr-1"></i> Shuffle
                    </button>
                    <span class="text-xs md:text-sm text-gray-500 bg-white px-3 py-1 rounded-full shadow-sm" id="vocab-counter">1 / 18</span>
                </div>
            </div>
            
            <div class="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden relative min-h-[450px] md:min-h-[500px]" id="vocab-card-container">
                <!-- Navigation buttons customized for mobile to not cover content -->
                <button onclick="prevVocab()" class="absolute left-0 top-0 bottom-0 px-2 md:px-4 text-gray-400 hover:text-sky-600 hover:bg-sky-50 transition z-10 focus:outline-none bg-white/50 md:bg-transparent"><i class="fas fa-chevron-left text-2xl md:text-3xl"></i></button>
                <button onclick="nextVocab()" class="absolute right-0 top-0 bottom-0 px-2 md:px-4 text-gray-400 hover:text-sky-600 hover:bg-sky-50 transition z-10 focus:outline-none bg-white/50 md:bg-transparent"><i class="fas fa-chevron-right text-2xl md:text-3xl"></i></button>
                
                <div id="vocab-content" class="p-6 md:p-12 text-center card-transition h-full flex flex-col justify-center"></div>
            </div>
        </section>

        <!-- 5. Quiz Section -->
        <section class="bg-white rounded-xl md:rounded-2xl shadow-md overflow-hidden fade-in border border-gray-100 mb-8 md:mb-12">
            <div class="bg-emerald-50 px-4 md:px-6 py-3 md:py-4 border-b border-emerald-100 flex justify-between items-center">
                <h2 class="text-lg md:text-xl font-bold text-emerald-800"><i class="fas fa-question-circle mr-2"></i>Thực Hành</h2>
                <span class="text-xs md:text-sm bg-emerald-200 text-emerald-800 px-3 py-1 rounded-full font-bold" id="quiz-score">0/10</span>
            </div>
            <div class="p-4 md:p-6 space-y-6" id="quiz-container"></div>
            <div class="px-6 py-4 bg-gray-50 border-t border-gray-100 text-center">
                <button onclick="checkQuiz()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-10 rounded-full shadow-lg transform transition active:scale-95 text-sm md:text-base w-full md:w-auto">Nộp Bài</button>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-gray-400 py-6 md:py-8 mt-6">
        <div class="container mx-auto px-4 text-center text-sm">
            <p>&copy; 2025 AzaKanji Kaiwa.</p>
        </div>
    </footer>

    <!-- STROKE ORDER MODAL -->
    <div id="stroke-modal" class="fixed inset-0 z-50 hidden overflow-y-auto" role="dialog" aria-modal="true">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity backdrop-blur-sm" onclick="closeStrokeModal()"></div>
            <div class="inline-block align-bottom bg-white rounded-xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl w-full modal-enter relative">
                <div class="bg-sky-600 px-4 py-3 flex justify-between items-center text-white">
                    <h3 class="font-bold text-lg"><i class="fas fa-pen-nib mr-2"></i>Tập Viết Kanji: <span id="stroke-modal-char" class="text-2xl ml-2"></span></h3>
                    <button onclick="closeStrokeModal()" class="hover:text-gray-200 p-2"><i class="fas fa-times text-xl"></i></button>
                </div>
                <div class="p-4 md:p-6 bg-gray-50 max-h-[80vh] overflow-y-auto">
                    <div class="flex flex-col md:flex-row gap-6 md:gap-8 items-center md:items-start justify-center">
                        <div class="bg-white p-4 rounded-lg shadow border border-gray-200 text-center w-full md:w-auto">
                            <p class="text-sm text-gray-500 mb-2 font-bold uppercase">Mô phỏng</p>
                            <div id="stroke-animation-container" class="w-40 h-40 mx-auto bg-white border border-gray-300 relative stroke-grid-box flex items-center justify-center">
                                <span class="text-gray-400 text-xs">Đang tải...</span>
                            </div>
                            <button onclick="replayStrokeAnimation()" class="mt-3 text-sm bg-sky-100 text-sky-700 px-4 py-2 rounded hover:bg-sky-200 transition w-full"><i class="fas fa-redo mr-1"></i> Viết lại</button>
                        </div>
                        <div class="flex-1 w-full">
                            <p class="text-sm text-gray-500 mb-3 font-bold uppercase text-center md:text-left">Thứ tự nét</p>
                            <div id="stroke-grid-container" class="flex flex-wrap gap-2 justify-center md:justify-start"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA DAY 23 ---
        const lessonData = {
            conversation: {
                polite: [
                    { role: "Tanaka", jp: "鈴木[すずき]さん、山田[やまだ]さんは本当[ほんとう]に積極的[せっきょくてき]ですね。", romaji: "Suzuki-san, Yamada-san wa hontou ni sekkyokuteki desu ne.", vi: "Anh Suzuki, anh Yamada thật sự rất tích cực nhỉ." },
                    { role: "Suzuki", jp: "ええ。彼[かれ]は積極的[せっきょくてき]な一方[いっぽう]で、少[すこ]しせっかちなところがありますね。", romaji: "Ee. Kare wa sekkyokuteki na ippou de, sukoshi sekkachi na tokoro ga arimasu ne.", vi: "Vâng. Anh ấy tích cực nhưng đồng thời cũng có chút nóng vội." },
                    { role: "Tanaka", jp: "確[たし]かに。仕事[しごと]が大変[たいへん]なのだから、少[すこ]し休[やす]んだらどうですかと提案[ていあん]しました。", romaji: "Tashika ni. Shigoto ga taihen na no dakara, sukoshi yasundara dou desu ka to teian shimashita.", vi: "Chắc chắn rồi. Vì công việc vất vả nên tôi đã đề nghị anh ấy thử nghỉ ngơi một chút xem sao." },
                    { role: "Suzuki", jp: "いいですね。彼[かれ]は我慢強[がまんづよ]い反面[はんめん]、無理[むり]をしすぎるところがありますから。", romaji: "Ii desu ne. Kare wa gamanzuyoi hanmen, muri o shisugiru tokoro ga arimasu kara.", vi: "Hay đó. Vì anh ấy giỏi chịu đựng nhưng mặt khác lại hay làm việc quá sức." },
                    { role: "Tanaka", jp: "兄[あに]は彼[かれ]に対[たい]して、弟[おとうと]はとても消極的[しょうきょくてき]です。", romaji: "Ani wa kare ni taishite, otouto wa totemo shoukyokuteki desu.", vi: "Trái ngược với anh ấy, em trai tôi lại rất tiêu cực." },
                    { role: "Suzuki", jp: "人[ひと]はそれぞれですね。もし彼[かれ]が疲[つか]れているのなら、手伝[てつだ]ってあげたらどうですか。", romaji: "Hito wa sorezore desu ne. Moshi kare ga tsukarete iru no nara, tetsudatte agetara dou desu ka.", vi: "Mỗi người mỗi khác nhỉ. Nếu anh ấy mệt, sao anh không thử giúp một tay?" }
                ],
                casual: [
                    { role: "Tanaka", jp: "鈴木[すずき]くん、山田[やまだ]くんって本当[ほんとう]に積極的[せっきょくてき]だよね。", romaji: "Suzuki-kun, Yamada-kun tte hontou ni sekkyokuteki da yo ne.", vi: "Suzuki này, Yamada thật sự rất tích cực nhỉ." },
                    { role: "Suzuki", jp: "うん。彼[かれ]は積極的[せっきょくてき]な一方[いっぽう]で、ちょっとせっかちだけどね。", romaji: "Un. Kare wa sekkyokuteki na ippou de, chotto sekkachi da kedo ne.", vi: "Ừ. Cậu ấy tích cực nhưng mà cũng hơi nóng vội." },
                    { role: "Tanaka", jp: "確[たし]かに。仕事[しごと]が大変[たいへん]なんだから、少[すこ]し休[やす]んだらどうかって言[い]ってみたんだ。", romaji: "Tashika ni. Shigoto ga taihen nanda kara, sukoshi yasundara dou ka tte itte mitan da.", vi: "Đúng vậy. Vì công việc vất vả nên tớ đã thử bảo cậu ấy nghỉ ngơi một chút xem sao." },
                    { role: "Suzuki", jp: "いいね。彼[かれ]、我慢強[がまんづよ]い反面[はんめん]、無理[むり]しすぎるところがあるからさ。", romaji: "Ii ne. Kare, gamanzuyoi hanmen, muri shisugiru tokoro ga aru kara sa.", vi: "Hay đó. Cậu ấy giỏi chịu đựng nhưng mà lại hay cố quá." },
                    { role: "Tanaka", jp: "うちの兄貴[あにき]とは正反対[せいはんたい]だな。兄貴[あにき]は彼[かれ]に対[たい]して、弟[おとうと]はすごく消極的[しょうきょくてき]なんだ。", romaji: "Uchi no aniki to wa seihantai da na. Aniki wa kare ni taishite, otouto wa sugoku shoukyokuteki nanda.", vi: "Trái ngược hẳn với anh trai tớ. Anh trai tớ đối lập với cậu ấy, còn em trai thì cực kỳ tiêu cực." },
                    { role: "Suzuki", jp: "人[ひと]それぞれだね。もし彼[かれ]が疲[つか]れてるなら、手伝[てつだ]ってあげたらどう？", romaji: "Hito sorezore da ne. Moshi kare ga tsukareteru nara, tetsudatte agetara dou?", vi: "Mỗi người mỗi tính. Nếu cậu ấy mệt thì giúp một tay xem sao?" }
                ]
            },
            reading: {
                jp: "私[わたし]の仕事[しごと]は夏[なつ]は非常[ひじょう]に忙[いそが]しい一方[いっぽう]、冬[ふゆ]は暇[ひま]になります。忙[いそが]しいのは大変[たいへん]な反面[はんめん]、やりがいもあります。この会社[かいしゃ]は給料[きゅうりょう]がいいのに対[たい]して、残業[ざんぎょう]が多[おお]いです。体[からだ]のことが心配[しんぱい]なら、一度[いちど]健康診断[けんこうしんだん]を受[う]けたらどうでしょうか。健康[けんこう]なのだから、心配[しんぱい]ないと医者[いしゃ]は言[い]いますが、無理[むり]は禁物[きんもつ]です。",
                romaji: "Watashi no shigoto wa natsu wa hijou ni isogashii ippou, fuyu wa hima ni narimasu. Isogashii no wa taihen na hanmen, yarigai mo arimasu. Kono kaisha wa kyuuryou ga ii no ni taishite, zangyou ga ooi desu. Karada no koto ga shinpai nara, ichido kenkou shindan o uketara dou deshou ka. Kenkou na no dakara, shinpai nai to isha wa iimasu ga, muri wa kinmotsu desu.",
                vi: "Công việc của tôi mùa hè thì cực kỳ bận rộn, trái lại mùa đông thì rảnh rỗi. Bận rộn tuy vất vả nhưng mặt khác cũng rất đáng làm. Công ty này lương cao nhưng ngược lại tăng ca lại nhiều. Nếu lo lắng cho sức khỏe, sao bạn không thử đi khám sức khỏe một lần? Bác sĩ nói rằng vì bạn khỏe mạnh nên không có gì phải lo lắng, nhưng làm việc quá sức là điều cấm kỵ."
            },
            grammar: [
                { rule: "～のだから", formula: "Thể thông thường + のだから", mean: "Bởi vì... (lý do hiển nhiên, biện bạch)", ex: "そんなに食[た]べたいのなら、食[た]べたらどうですか。", vi: "Nếu mà muốn ăn đến thế thì sao không ăn thử đi?" },
                { rule: "～に対して", formula: "N / Thể thông thường + の + に対して", mean: "Đối với / Trái ngược với (Sự đối lập giữa hai sự vật/sự việc)", ex: "父[ちち]が背[せ]が高[たか]いのに対[たい]して、母[はは]は背[せ]が低[ひく]いです。", vi: "Trái với bố tôi cao, mẹ tôi lại thấp." },
                { rule: "～反面", formula: "Thể thông thường + 反面", mean: "Mặt khác, ngược lại (Hai mặt đối lập của cùng một vấn đề)", ex: "この薬[くすり]はよく効[き]く反面[はんめん]、副作用[ふくさよう]があります。", vi: "Thuốc này tác dụng tốt nhưng mặt khác lại có tác dụng phụ." },
                { rule: "～一方（で）", formula: "Thể thông thường + 一方（で）", mean: "Một mặt thì..., mặt khác thì... (Hai hành động/trạng thái song song)", ex: "会議[かいぎ]では自分[じぶん]の意見[いけん]を言[い]う一方[いっぽう]で、人[ひと]の話[はなし]もよく聞[き]きます。", vi: "Trong cuộc họp, một mặt tôi nói ý kiến của mình, mặt khác tôi cũng lắng nghe câu chuyện của người khác." },
                { rule: "～なら", formula: "Thể thông thường + なら", mean: "Nếu là... (Dựa vào bối cảnh để đưa ra lời khuyên, đề nghị)", ex: "日本[にほん]へ行[い]くなら、京都[きょうと]がおすすめですよ。", vi: "Nếu đi Nhật thì tôi gợi ý bạn nên đến Kyoto." },
                { rule: "～たらどうか", formula: "Vたら + どうか", mean: "Thử... xem sao? / Sao không...?", ex: "疲[つか]れているなら、少[すこ]し休[やす]んだらどうですか。", vi: "Nếu mệt thì sao không nghỉ ngơi một chút?" }
            ],
            vocab: [
                { 
                    k: "積", h: "せき", on: "セキ", kun: "つ.む", m: "Tích/Tích cực", hv: "TÍCH", 
                    ti: "Lúa (**禾**) chất đống (**責**) là Tích trữ.", 
                    ta: "Phân **Tích** (**Seki**) sự tích tụ.", 
                    compounds: [{w: "積極的", r: "せっきょくてき", m: "Tích cực"}] 
                },
                { 
                    k: "極", h: "きょく", on: "キョク", kun: "きわ.める", m: "Cực/Cực kỳ", hv: "CỰC", 
                    ti: "Cây (**木**) cao đến Cực điểm, người phải nói gấp (**亟**).", 
                    ta: "**Ca khúc** (**Kyoku**) này hay cực kỳ.", 
                    compounds: [{w: "積極的", r: "せっきょくてき", m: "Tích cực"}] 
                },
                { 
                    k: "提", h: "てい", on: "テイ", kun: "さ.げる", m: "Đề/Đề xuất", hv: "ĐỀ", 
                    ti: "Tay (**扌**) cầm Đúng (**是**) sự thật để Đề xuất.", 
                    ta: "**Tây** (**Tei**) ba lô đề xuất ý kiến.", 
                    compounds: [{w: "提案", r: "ていあん", m: "Đề án/Đề xuất"}] 
                },
                { 
                    k: "案", h: "あん", on: "アン", kun: "-", m: "Án/Đề án", hv: "ÁN", 
                    ti: "Cây (**木**) trồng An toàn (**安**) là phương Án tốt.", 
                    ta: "**Ăn** (**An**) cơm bàn phương án.", 
                    compounds: [{w: "提案", r: "ていあん", m: "Đề án"}] 
                },
                { 
                    k: "慢", h: "まん", on: "マン", kun: "-", m: "Mạn/Chịu đựng", hv: "MẠN", 
                    ti: "Tâm (**忄**) Mạn (**曼**) phép chịu đựng.", 
                    ta: "**Màn** (**Man**) kịch ngạo mạn.", 
                    compounds: [{w: "我慢強い", r: "がまんづよい", m: "Giỏi chịu đựng"}] 
                },
                { 
                    k: "反", h: "はん", on: "ハン", kun: "そ.る", m: "Phản/Ngược", hv: "PHẢN", 
                    ti: "Ở trong sườn núi (**厂**) lại đi ngược (**又**).", 
                    ta: "**Hằng** (**Han**) ngày phản đối.", 
                    compounds: [{w: "反面", r: "はんめん", m: "Mặt khác"}] 
                },
                { 
                    k: "面", h: "めん", on: "メン", kun: "おもて", m: "Diện/Mặt", hv: "DIỆN", 
                    ti: "Một trăm (**百**) cái mặt trong nhà.", 
                    ta: "Ăn **Mì** (**Men**) mặt đối mặt.", 
                    compounds: [{w: "反面", r: "はんめん", m: "Mặt khác"}] 
                },
                { 
                    k: "弟", h: "おとうと", on: "ダイ", kun: "おとうと", m: "Đệ/Em trai", hv: "ĐỆ", 
                    ti: "Cây cung (**弓**) và ngọn giáo là đồ chơi của Đệ.", 
                    ta: "**Ô tô to** (**Otouto**) của em trai.", 
                    compounds: [{w: "弟", r: "おとうと", m: "Em trai"}] 
                },
                { 
                    k: "消", h: "しょう", on: "ショウ", kun: "き.える", m: "Tiêu/Tắt", hv: "TIÊU", 
                    ti: "Nước (**氵**) làm Tiêu tan ánh trăng nhỏ (**肖**).", 
                    ta: "Chơi game **Show** (**Shou**) tiêu khiển.", 
                    compounds: [{w: "消極的", r: "しょうきょくてき", m: "Tiêu cực"}] 
                },
                { 
                    k: "非", h: "ひ", on: "ヒ", kun: "-", m: "Phi/Không", hv: "PHI", 
                    ti: "Hai cánh cửa mở ra hai bên trái phải.", 
                    ta: "**Hi** (**Hi**) hi, phi thường quá.", 
                    compounds: [{w: "非常に", r: "ひじょうに", m: "Rất/Khẩn cấp"}] 
                },
                { 
                    k: "常", h: "じょう", on: "ジョウ", kun: "つね", m: "Thường/Luôn", hv: "THƯỜNG", 
                    ti: "Ở trong nhà (**尚**) dùng khăn (**巾**) lau thường xuyên.", 
                    ta: "**Giấu** (**Jou**) tiền là chuyện thường.", 
                    compounds: [{w: "非常に", r: "ひじょうに", m: "Rất"}] 
                },
                { 
                    k: "給", h: "きゅう", on: "キュウ", kun: "たま.う", m: "Cấp/Lương", hv: "CẤP", 
                    ti: "Sợi tơ (**糸**) Hợp (**合**) lại để Cung cấp.", 
                    ta: "**Cứu** (**Kyuu**) viện cung cấp lương thực.", 
                    compounds: [{w: "給料", r: "きゅうりょう", m: "Tiền lương"}] 
                },
                { 
                    k: "残", h: "ざん", on: "ザン", kun: "のこ.る", m: "Tàn/Còn lại", hv: "TÀN", 
                    ti: "Cái chết (**歹**) của hai cái qua (**戈**) thật Tàn khốc.", 
                    ta: "Gian (**Zan**) ác tàn bạo.", 
                    compounds: [{w: "残業", r: "ざんぎょう", m: "Làm thêm giờ"}] 
                },
                { 
                    k: "業", h: "ぎょう", on: "ギョウ", kun: "わざ", m: "Nghiệp/Việc", hv: "NGHIỆP", 
                    ti: "Những con cừu (**䒑**) chưa xong (**未**) nghiệp chướng.", 
                    ta: "Sự **nghiệp** tiêu tan vì nghiệp chướng.", 
                    compounds: [{w: "残業", r: "ざんぎょう", m: "Làm thêm giờ"}] 
                },
                { 
                    k: "診", h: "しん", on: "シン", kun: "み.る", m: "Chẩn/Khám", hv: "CHẨN", 
                    ti: "Nói (**言**) về việc người (**人**) có tóc ba chỏm (**彡**) đi Khám.", 
                    ta: "**Xin** (**Shin**) bác sĩ chẩn đoán.", 
                    compounds: [{w: "健康診断", r: "けんこうしんだん", m: "Khám sức khỏe"}] 
                },
                { 
                    k: "断", h: "だん", on: "ダン", kun: "ことわ.る", m: "Đoạn/Từ chối", hv: "ĐOẠN", 
                    ti: "Dùng Rìu (**斤**) chặt đứt gạo (**米**) và móc câu (**乚**).", 
                    ta: "**Đàn** (**Dan**) ông phải quyết đoán.", 
                    compounds: [{w: "健康診断", r: "けんこうしんだん", m: "Khám sức khỏe"}] 
                },
                { 
                    k: "禁", h: "きん", on: "キン", kun: "-", m: "Cấm", hv: "CẤM", 
                    ti: "Cây (**林**) mọc trên bàn thờ (**示**) là điều Cấm kỵ.", 
                    ta: "Lấy **Kim** (**Kin**) tiêm là điều cấm.", 
                    compounds: [{w: "禁物", r: "きんもつ", m: "Điều cấm kỵ"}] 
                },
                { 
                    k: "物", h: "もの", on: "ブツ", kun: "もの", m: "Vật/Đồ", hv: "VẬT", 
                    ti: "Con Bò (**牛**) Chớ (**勿**) coi là đồ vật.", 
                    ta: "Đồ vật này **Bự** (**Butsu**) quá.", 
                    compounds: [{w: "禁物", r: "きんもつ", m: "Điều cấm kỵ"}] 
                }
            ],
            quiz: [
                { type: 'mcq', question: "兄[あに]は外向的[がいこうてき]なの（___）、私[わたし]は内向的[ないこうてき]です。", options: ["だから", "に対して", "反面"], correct: 1, explain: "～に対して: Đối lập giữa hai đối tượng (Anh trai >< Tôi)." },
                { type: 'fill', question: "このあたりは静[しず]かな（___）、買[か]い物[もの]に不便[ふべん]です。", answer: "反面", explain: "～反面: Mặt trái của cùng một vấn đề (Yên tĩnh nhưng bất tiện)." },
                { type: 'mcq', question: "そんなに好[す]きな（___）、告白[こくはく]したらどうですか。", options: ["なら", "のに", "から"], correct: 0, explain: "～なら: Nếu là... (Đưa ra lời khuyên dựa trên bối cảnh)." },
                { type: 'audio', question: "Nghe và gõ lại câu bạn vừa nghe:", jp: "この薬はよく効く反面、副作用がある。", explain: "Kono kusuri wa yoku kiku hanmen, fukusayou ga aru (Thuốc này tốt nhưng có tác dụng phụ)." },
                { type: 'mcq', question: "彼[かれ]は仕事[しごと]をする（___）、ボランティア活動[かつどう]もしています。", options: ["に対して", "一方", "反面"], correct: 1, explain: "～一方（で）: Một mặt làm cái này, mặt khác làm cái kia (song song)." },
                { type: 'mcq', question: "新[あたら]しいパソコンを買[か]う（___）、これがいいですよ。", options: ["なら", "たら", "と"], correct: 0, explain: "～なら: Lời khuyên (Nếu mua máy tính mới thì cái này tốt)." },
                { type: 'fill', question: "疲[つか]れているなら、早[はや]く（___）どうですか。", answer: "寝たら", explain: "～たらどうですか: Sao không... (Khuyên nhủ)." },
                { type: 'mcq', question: "彼[かれ]は金持[かねも]ちである（___）、幸[しあわ]せだとは限[かぎ]らない。", options: ["一方", "反面", "に対して"], correct: 1, explain: "～反面: Tuy giàu có nhưng mặt khác chưa chắc đã hạnh phúc." },
                { type: 'mcq', question: "Từ '積極的' đọc là gì?", options: ["しょうきょくてき", "せっきょくてき", "ぜっきょくてき"], correct: 1, explain: "積極的 (Sekkyokuteki) - Tích cực." },
                { type: 'audio', question: "Nghe và điền từ còn thiếu: 無理は___です。", jp: "無理は禁物です。", explain: "Kinmotsu (Cấm kỵ)." }
            ]
        };

        // --- STATE MANAGEMENT & SETTINGS ---
        let currentMode = 'polite';
        let settings = { hideFurigana: false, showRomaji: false, showVietnamese: false, currentSpeed: 1.0 };
        let progress = { conversation: false, reading: false, grammar: false, vocab: 0, quiz: 0 };
        let vocabSeen = new Set();
        let currentVocabIndex = 0;
        let currentStrokeSvg = null;
        let quizScoreCurrent = 0;
        let jpVoice = null;
        let recognition = null;
        let isRecognizing = false;

        // --- AUDIO & SPEECH ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            if (type === 'correct') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(500, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1); gain.gain.setValueAtTime(0.2, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3); osc.start(); osc.stop(audioCtx.currentTime + 0.3);
            } else {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(200, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.2); gain.gain.setValueAtTime(0.2, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2); osc.start(); osc.stop(audioCtx.currentTime + 0.2);
            }
        }

        function loadVoices() {
            const voices = window.speechSynthesis.getVoices();
            jpVoice = voices.find(v => v.name === 'Google 日本語') || voices.find(v => v.lang === 'ja-JP') || null;
        }
        window.speechSynthesis.onvoiceschanged = loadVoices;

        function cleanText(text) { return text ? text.replace(/\[.*?\]/g, '') : ''; }
        function parseFurigana(text) { return text ? text.replace(/([^\[\]]+)\[(.+?)\]/g, '<ruby>$1<rt>$2</rt></ruby>') : ''; }

        function speak(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(cleanText(text));
                u.lang = 'ja-JP'; u.rate = settings.currentSpeed;
                if(jpVoice) u.voice = jpVoice;
                window.speechSynthesis.speak(u);
            }
        }

        function initSpeech() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.lang = 'ja-JP';
                recognition.continuous = false;
                recognition.interimResults = false;
            }
        }

        function startListening(targetInputId) {
            if (!recognition) { alert("Trình duyệt không hỗ trợ nhận diện giọng nói."); return; }
            if (isRecognizing) { recognition.stop(); return; }
            const btn = document.getElementById(`mic-btn-${targetInputId}`);
            const input = document.getElementById(targetInputId);
            document.querySelectorAll('.mic-listening').forEach(el => el.classList.remove('mic-listening'));
            recognition.onstart = () => { isRecognizing = true; btn.classList.add('mic-listening'); };
            recognition.onend = () => { isRecognizing = false; btn.classList.remove('mic-listening'); };
            recognition.onresult = (event) => { input.value = event.results[0][0].transcript; input.dispatchEvent(new Event('input')); };
            try { recognition.start(); } catch (e) { isRecognizing = false; }
        }

        // --- CORE FUNCTIONS ---
        function saveSettings() { localStorage.setItem('azaSettings_day23', JSON.stringify(settings)); }
        function loadSettings() {
            const saved = localStorage.getItem('azaSettings_day23');
            if (saved) settings = { ...settings, ...JSON.parse(saved) };
        }

        function updateProgress() {
            let points = 0;
            const convoInputs = document.querySelectorAll('#conversation-container .correct-input');
            const totalConvoLines = lessonData.conversation.polite.length;
            if (totalConvoLines > 0) points += (convoInputs.length / totalConvoLines) * 30;
            const readingInput = document.getElementById('reading-input');
            if(readingInput && readingInput.value.length > 20) points += 10;
            if(lessonData.vocab.length > 0) points += (vocabSeen.size / lessonData.vocab.length) * 30;
            if(lessonData.quiz.length > 0) points += (quizScoreCurrent / lessonData.quiz.length) * 30;
            const percent = Math.min(100, Math.round(points));
            document.getElementById('progress-bar').style.width = `${percent}%`;
            document.getElementById('progress-text').innerText = `${percent}%`;
        }

        function checkTyping(input, correctText, feedbackDiv) {
            const userText = input.value;
            const targetText = cleanText(correctText);
            let html = '';
            for (let i = 0; i < userText.length; i++) {
                if (i >= targetText.length) html += `<span class="incorrect-char">${userText[i]}</span>`;
                else if (userText[i] === targetText[i]) html += `<span class="correct-char">${userText[i]}</span>`;
                else html += `<span class="incorrect-char">${userText[i]}</span>`;
            }
            feedbackDiv.innerHTML = html;
            if (userText === targetText) {
                input.classList.add('correct-input'); input.classList.remove('wrong-input');
                feedbackDiv.innerHTML += ' <span class="text-green-600 ml-2 font-bold text-xs"><i class="fas fa-check-circle"></i> Chính xác!</span>';
                playSound('correct'); updateProgress();
            } else if (userText.length > 0) {
                input.classList.add('wrong-input'); input.classList.remove('correct-input');
            } else {
                input.classList.remove('correct-input', 'wrong-input');
            }
        }

        // --- RENDERERS ---
        function renderConversation() {
            const container = document.getElementById('conversation-container');
            const lines = lessonData.conversation[currentMode];
            container.innerHTML = lines.map((line, idx) => `
                <div class="flex gap-2 md:gap-4 fade-in ${line.role === 'Tanaka' ? '' : 'flex-row-reverse'} p-1 md:p-2 rounded-lg transition-colors duration-300">
                    <div class="flex-shrink-0 w-8 h-8 md:w-12 md:h-12 rounded-full flex items-center justify-center font-bold text-white shadow-md text-sm md:text-base ${line.role === 'Tanaka' ? 'bg-blue-500' : 'bg-green-500'}">${line.role[0]}</div>
                    <div class="flex-1 max-w-[95%] md:max-w-[90%]">
                        <div class="text-[10px] md:text-xs text-gray-500 mb-1 ${line.role === 'Tanaka' ? 'text-left' : 'text-right'}">${line.role}</div>
                        <div class="bg-white p-3 md:p-4 rounded-xl md:rounded-2xl shadow-sm border border-gray-200 relative group transition hover:shadow-md ${line.role === 'Tanaka' ? 'rounded-tl-none' : 'rounded-tr-none bg-green-50'}">
                            <p class="text-base md:text-lg text-gray-800 kanji-font leading-relaxed mb-1 pr-6 md:pr-0">${parseFurigana(line.jp)}</p>
                            <p class="text-sm text-gray-500 romaji-text hidden italic mb-1">${line.romaji}</p>
                            <p class="text-xs md:text-sm text-gray-500 vi-trans border-t border-gray-100 pt-2 mt-2">${line.vi}</p>
                            <button onclick="speak('${line.jp}')" class="absolute top-2 right-2 text-gray-300 hover:text-sky-600 transition"><i class="fas fa-volume-up"></i></button>
                            <div class="mt-3 pt-2 border-t border-gray-100">
                                <div class="flex gap-2">
                                    <input type="text" id="convo-input-${idx}" class="flex-1 text-base p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-200 transition bg-gray-50 placeholder-gray-300 min-w-0" placeholder="Nghe và gõ lại..." oninput="checkTyping(this, '${line.jp}', this.parentElement.nextElementSibling)">
                                    <button id="mic-btn-convo-input-${idx}" onclick="startListening('convo-input-${idx}')" class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-2 md:px-3 rounded-lg transition flex-shrink-0"><i class="fas fa-microphone"></i></button>
                                </div>
                                <div class="h-auto md:h-5 mt-1 text-xs md:text-sm pl-1 kanji-font break-all"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            updateUI();
        }

        function playAllConversation() {
            const lines = lessonData.conversation[currentMode];
            let i = 0;
            function playNext() {
                if (i >= lines.length) return;
                const allLines = document.querySelectorAll('#conversation-container > div');
                allLines.forEach(el => el.classList.remove('playing-line'));
                if (allLines[i]) {
                    allLines[i].classList.add('playing-line');
                    allLines[i].scrollIntoView({behavior: "smooth", block: "center"});
                }
                speak(lines[i].jp);
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(cleanText(lines[i].jp));
                u.lang = 'ja-JP'; u.rate = settings.currentSpeed;
                if(jpVoice) u.voice = jpVoice;
                u.onend = () => { i++; setTimeout(playNext, 500); };
                window.speechSynthesis.speak(u);
            }
            window.speechSynthesis.cancel();
            playNext();
        }

        function switchMode(mode) {
            currentMode = mode;
            document.getElementById('tab-polite').className = mode === 'polite' ? "tab-btn tab-active flex-1 md:flex-none px-2 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-bold text-center" : "tab-btn tab-inactive flex-1 md:flex-none px-2 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-bold ml-1 text-center";
            document.getElementById('tab-casual').className = mode === 'casual' ? "tab-btn tab-active flex-1 md:flex-none px-2 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-bold ml-1 text-center" : "tab-btn tab-inactive flex-1 md:flex-none px-2 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-bold ml-1 text-center";
            renderConversation();
        }

        function renderReading() {
            document.getElementById('reading-text').innerHTML = parseFurigana(lessonData.reading.jp);
            document.getElementById('reading-romaji').innerText = lessonData.reading.romaji;
            document.getElementById('reading-vi').innerText = lessonData.reading.vi;
            const input = document.getElementById('reading-input');
            const feedback = document.getElementById('reading-feedback');
            input.oninput = () => {
                if(input.value.length > 50) updateProgress();
                checkTyping(input, lessonData.reading.jp, feedback); 
            };
            if(!document.getElementById('reading-play-btn')) {
                const btn = document.createElement('button');
                btn.id = 'reading-play-btn';
                btn.className = "mt-4 text-orange-500 hover:text-orange-700 font-bold flex items-center text-sm transition";
                btn.innerHTML = '<i class="fas fa-volume-up mr-2"></i> Nghe bài đọc';
                btn.onclick = () => speak(lessonData.reading.jp);
                document.getElementById('reading-text').parentNode.insertBefore(btn, document.getElementById('reading-text').nextSibling);
            }
        }

        function renderGrammar() {
            const container = document.getElementById('grammar-container');
            container.innerHTML = lessonData.grammar.map(g => `
                <div class="bg-white p-4 md:p-5 rounded-xl border border-purple-100 shadow-sm hover:border-purple-300 transition group">
                    <h3 class="font-bold text-purple-700 mb-1 text-base md:text-lg flex items-center"><span class="w-2 h-2 bg-purple-500 rounded-full mr-2 flex-shrink-0"></span>${g.rule}</h3>
                    <div class="mb-2 pl-4"><span class="bg-red-100 text-red-600 text-[10px] md:text-xs px-2 py-1 rounded font-bold">Công thức:</span> <span class="text-gray-700 text-xs md:text-sm kanji-font break-all">${g.formula}</span></div>
                    <p class="text-gray-600 text-xs md:text-sm mb-3 pl-4">${g.mean}</p>
                    <div class="bg-purple-50 p-3 rounded-lg text-xs md:text-sm text-gray-700 kanji-font relative pl-4">
                        <i class="fas fa-quote-left text-purple-200 absolute top-1 left-1 text-xs"></i>${parseFurigana(g.ex)}
                        <p class="text-[10px] md:text-xs text-purple-600 mt-1 italic">${g.vi}</p>
                        <button onclick="speak('${g.ex}')" class="absolute top-2 right-2 text-purple-300 hover:text-purple-600 transition md:opacity-0 md:group-hover:opacity-100"><i class="fas fa-volume-up"></i></button>
                    </div>
                </div>
            `).join('');
        }

        // --- VOCAB FLASHCARDS ---
        function getKanjiHex(kanji) { return kanji.charCodeAt(0).toString(16).padStart(5, '0'); }
        async function fetchKanjiSvg(hex) {
            try {
                const response = await fetch(`https://cdn.jsdelivr.net/gh/KanjiVG/kanjivg/kanji/${hex}.svg`);
                if (!response.ok) throw new Error('Not found');
                return await response.text();
            } catch (e) { return null; }
        }

        async function showStrokeOrder(kanji) {
            const hex = getKanjiHex(kanji);
            document.getElementById('stroke-modal').classList.remove('hidden');
            document.getElementById('stroke-modal-char').innerText = kanji;
            const animContainer = document.getElementById('stroke-animation-container');
            const gridContainer = document.getElementById('stroke-grid-container');
            animContainer.innerHTML = '<span class="text-gray-400 text-xs">Đang tải...</span>';
            const svgContent = await fetchKanjiSvg(hex);
            if (!svgContent) { animContainer.innerHTML = "<p class='text-red-500'>Lỗi</p>"; gridContainer.innerHTML = ""; return; }
            
            animContainer.innerHTML = svgContent;
            const mainSvg = animContainer.querySelector('svg');
            mainSvg.setAttribute('width', '100%'); mainSvg.setAttribute('height', '100%');
            const paths = mainSvg.querySelectorAll('path');
            paths.forEach(p => { 
                const len = p.getTotalLength(); p.style.strokeDasharray = len; p.style.strokeDashoffset = len; 
                p.style.stroke = "#333"; p.style.strokeWidth = "4"; p.style.fill = "none"; 
                p.style.strokeLinecap = "round"; p.style.strokeLinejoin = "round"; 
            });
            currentStrokeSvg = mainSvg;
            replayStrokeAnimation();

            gridContainer.innerHTML = '';
            for(let i=0; i<paths.length; i++) {
                const box = document.createElement('div');
                box.className = "w-12 h-12 md:w-20 md:h-20 bg-white border border-gray-200 relative stroke-grid-box flex items-center justify-center";
                const parser = new DOMParser();
                const svgClone = parser.parseFromString(svgContent, "image/svg+xml").querySelector('svg');
                svgClone.setAttribute('width', '100%'); svgClone.setAttribute('height', '100%');
                svgClone.querySelectorAll('path').forEach((p, idx) => {
                    p.style.fill="none"; p.style.strokeLinecap="round"; p.style.strokeLinejoin="round";
                    if(idx < i) { p.style.stroke="#9ca3af"; p.style.strokeWidth="3"; }
                    else if(idx === i) { p.style.stroke="#000"; p.style.strokeWidth="4"; }
                    else p.style.display="none";
                });
                box.appendChild(svgClone);
                gridContainer.appendChild(box);
            }
        }

        function replayStrokeAnimation() {
            if(!currentStrokeSvg) return;
            const paths = currentStrokeSvg.querySelectorAll('path');
            paths.forEach(p => { p.style.transition = 'none'; p.style.strokeDashoffset = p.getTotalLength(); });
            void currentStrokeSvg.offsetWidth;
            let delay = 0;
            paths.forEach(p => {
                p.style.transition = `stroke-dashoffset 0.6s ease-in-out ${delay}s`;
                p.style.strokeDashoffset = '0';
                delay += 0.6;
            });
        }
        function closeStrokeModal() { document.getElementById('stroke-modal').classList.add('hidden'); }

        function renderVocab() {
            vocabSeen.add(currentVocabIndex);
            updateProgress();
            const container = document.getElementById('vocab-content');
            const v = lessonData.vocab[currentVocabIndex];
            const compoundsHtml = v.compounds ? v.compounds.map(c => 
                `<div class="flex justify-between items-center bg-gray-50 px-3 py-2 rounded mb-1 cursor-pointer hover:bg-gray-100" onclick="speak('${c.r}')">
                    <span class="text-gray-800 font-bold">${c.w}</span>
                    <span class="text-gray-500 text-xs">${c.r}</span>
                    <span class="text-sky-600 text-xs text-right">${c.m}</span>
                    <i class="fas fa-volume-up text-xs text-gray-300 ml-2"></i>
                </div>`
            ).join('') : '';

            container.innerHTML = `
                <div class="animate-fade-in relative">
                    <div class="text-5xl md:text-6xl font-bold text-gray-800 kanji-font mb-2 cursor-pointer hover:text-sky-600 transition" onclick="showStrokeOrder('${v.k}')" title="Bấm để xem cách viết">${v.k}</div>
                    <button onclick="showStrokeOrder('${v.k}')" class="text-xs bg-sky-100 text-sky-700 px-3 py-1 rounded-full mb-2 hover:bg-sky-200 transition"><i class="fas fa-pen-nib mr-1"></i> Tập viết</button>
                    <div class="grid grid-cols-2 gap-2 md:gap-4 text-center mb-4 text-sm bg-gray-50 p-2 rounded-lg">
                        <div class="flex flex-col items-center"><span class="text-[10px] md:text-xs text-gray-400 block uppercase font-bold mb-1">On'yomi</span>
                            <div class="flex items-center gap-1 md:gap-2 flex-wrap justify-center"><span class="text-gray-800 font-bold text-xs md:text-sm">${v.on}</span><button onclick="speak('${v.on}')" class="w-5 h-5 rounded-full bg-white shadow-sm flex items-center justify-center text-sky-500 hover:bg-sky-50"><i class="fas fa-volume-up text-[10px]"></i></button></div>
                        </div>
                        <div class="flex flex-col items-center"><span class="text-[10px] md:text-xs text-gray-400 block uppercase font-bold mb-1">Kun'yomi</span>
                            <div class="flex items-center gap-1 md:gap-2 flex-wrap justify-center"><span class="text-gray-800 font-bold text-xs md:text-sm">${v.kun}</span><button onclick="speak('${v.kun.replace(/\./g, '')}')" class="w-5 h-5 rounded-full bg-white shadow-sm flex items-center justify-center text-sky-500 hover:bg-sky-50"><i class="fas fa-volume-up text-[10px]"></i></button></div>
                        </div>
                    </div>
                    <div class="inline-block text-[10px] md:text-xs font-bold text-white bg-gray-400 px-3 py-1 rounded-full mb-3 md:mb-4 tracking-wide">${v.hv}</div>
                    <div class="text-sky-700 font-bold text-xl md:text-2xl mb-4 md:mb-6 border-b border-gray-100 pb-2 md:pb-4">${v.m}</div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 text-left max-w-2xl mx-auto">
                        <div class="bg-orange-50 p-3 md:p-4 rounded-xl border border-orange-100"><div class="font-bold text-orange-600 mb-2 flex items-center text-sm"><i class="fas fa-image mr-2"></i> Mẹo Hình Ảnh</div><div class="text-gray-700 text-xs md:text-sm leading-relaxed">${v.ti.replace(/\*\*(.*?)\*\*/g, '<span class="text-red-600 font-bold">$1</span>')}</div></div>
                        <div class="bg-blue-50 p-3 md:p-4 rounded-xl border border-blue-100"><div class="font-bold text-blue-600 mb-2 flex items-center text-sm"><i class="fas fa-volume-up mr-2"></i> Mẹo Âm Thanh</div><div class="text-gray-700 text-xs md:text-sm leading-relaxed">${v.ta.replace(/\*\*(.*?)\*\*/g, '<span class="text-indigo-600 font-bold">$1</span>')}</div></div>
                    </div>
                    ${compoundsHtml ? `<div class="mt-6 md:mt-8 pt-4 md:pt-6 border-t border-gray-100"><div class="text-xs md:text-sm text-gray-400 mb-2 font-bold uppercase tracking-wide text-center">Từ ghép</div><div class="kanji-font text-gray-600 max-w-sm mx-auto text-left">${compoundsHtml}</div></div>` : ''}
                </div>
            `;
            document.getElementById('vocab-counter').innerText = `${currentVocabIndex + 1} / ${lessonData.vocab.length}`;
        }
        function prevVocab() { if (currentVocabIndex > 0) { currentVocabIndex--; renderVocab(); } }
        function nextVocab() { if (currentVocabIndex < lessonData.vocab.length - 1) { currentVocabIndex++; renderVocab(); } }
        function shuffleVocab() {
            for (let i = lessonData.vocab.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [lessonData.vocab[i], lessonData.vocab[j]] = [lessonData.vocab[j], lessonData.vocab[i]]; }
            currentVocabIndex = 0; renderVocab();
        }
        document.addEventListener('keydown', (e) => { if (e.key === 'ArrowLeft') prevVocab(); if (e.key === 'ArrowRight') nextVocab(); });

        // --- QUIZ ---
        function renderQuiz() {
            const container = document.getElementById('quiz-container');
            container.innerHTML = lessonData.quiz.map((q, idx) => `
                <div class="quiz-item border-b border-gray-100 pb-4 last:border-0">
                    <p class="font-bold text-gray-800 mb-2 md:mb-3 text-sm md:text-base"><span class="text-emerald-600 mr-2">Câu ${idx + 1}:</span> ${q.type === 'audio' ? q.question : parseFurigana(q.question)}</p>
                    <div class="space-y-2">
                        ${q.type === 'audio' ? `<button class="speak-btn mb-2 flex items-center text-sky-600 font-bold text-sm" onclick="speak('${q.jp}')"><i class="fas fa-volume-up mr-2"></i> Nghe câu hỏi</button><input type="text" class="w-full p-2 border rounded text-base" placeholder="Nhập câu bạn nghe được..." data-idx="${idx}">` 
                        : q.type === 'fill' ? `<input type="text" class="w-full p-2 border rounded fill-input text-base" placeholder="Điền từ còn thiếu..." data-idx="${idx}">` 
                        : q.options.map((opt, optIdx) => `<label class="flex items-center p-2 md:p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition quiz-option text-sm md:text-base" data-q="${idx}" data-opt="${optIdx}"><input type="radio" name="q${idx}" value="${optIdx}" class="mr-3 text-emerald-600 focus:ring-emerald-500"><span class="kanji-font">${parseFurigana(opt)}</span></label>`).join('')}
                    </div>
                    <div class="quiz-feedback hidden mt-3 p-3 rounded-lg text-sm" id="feedback-${idx}"></div>
                </div>
            `).join('');
            document.getElementById('quiz-score').innerText = `0/${lessonData.quiz.length}`;
        }

        function checkQuiz() {
            let score = 0;
            lessonData.quiz.forEach((q, idx) => {
                const feedbackEl = document.getElementById(`feedback-${idx}`);
                feedbackEl.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
                let isCorrect = false;
                if (q.type === 'audio') {
                    const input = document.querySelector(`input[data-idx="${idx}"]`);
                    isCorrect = input.value.trim() === cleanText(q.jp);
                } else if (q.type === 'fill') {
                    const input = document.querySelector(`input[data-idx="${idx}"]`);
                    isCorrect = input.value.trim() === q.answer;
                } else {
                    const selected = document.querySelector(`input[name="q${idx}"]:checked`);
                    if (selected && q.options && q.options[q.correct]) { // Fix logic for old string answers in MCQs
                         isCorrect = selected.parentElement.innerText.trim() === q.options[q.correct]; 
                    } else if (selected && typeof q.correct !== 'undefined') { // New logic for index-based correct answer
                         isCorrect = parseInt(selected.value) === q.correct;
                    }
                }
                
                if (isCorrect) {
                    score++;
                    feedbackEl.innerHTML = `<i class="fas fa-check-circle mr-2"></i> Chính xác! <br><span class="text-xs mt-1 block opacity-80">${q.explain || ''}</span>`;
                    feedbackEl.classList.add('bg-green-100', 'text-green-800');
                } else {
                    const ans = q.type === 'mcq' ? (q.options ? q.options[q.correct] : q.answer) : (q.type === 'audio' ? q.jp : q.answer);
                    feedbackEl.innerHTML = `<i class="fas fa-times-circle mr-2"></i> Sai rồi. Đáp án: <strong>${ans}</strong><br><span class="text-xs mt-1 block opacity-80">${q.explain || ''}</span>`;
                    feedbackEl.classList.add('bg-red-100', 'text-red-800');
                }
            });
            if(score === lessonData.quiz.length) playSound('correct'); else playSound('wrong');
            quizScoreCurrent = score;
            document.getElementById('quiz-score').innerText = `${score}/${lessonData.quiz.length}`;
            updateProgress();
        }

        function updateUI() {
            document.querySelectorAll('rt').forEach(rt => rt.style.visibility = settings.hideFurigana ? 'hidden' : 'visible');
            document.getElementById('btn-toggle-furigana').className = !settings.hideFurigana ? "px-2 md:px-3 py-1.5 rounded transition bg-sky-600 text-white flex items-center shadow" : "px-2 md:px-3 py-1.5 rounded transition bg-gray-200 text-gray-600 flex items-center";
            document.querySelectorAll('.romaji-text').forEach(el => el.classList.toggle('hidden', !settings.showRomaji));
            document.getElementById('btn-toggle-romaji').className = settings.showRomaji ? "px-2 md:px-3 py-1.5 rounded transition bg-sky-600 text-white flex items-center shadow ml-1" : "px-2 md:px-3 py-1.5 rounded transition bg-gray-200 text-gray-600 flex items-center ml-1";
            document.querySelectorAll('.vi-trans').forEach(p => p.style.display = settings.showVietnamese ? 'block' : 'none');
            document.getElementById('btn-toggle-vi').className = settings.showVietnamese ? "px-2 md:px-3 py-1.5 rounded transition bg-white text-sky-800 font-bold ml-1 flex items-center border border-sky-200 shadow-sm" : "px-2 md:px-3 py-1.5 rounded transition bg-gray-200 text-gray-500 font-bold ml-1 flex items-center";
            const speedSelect = document.getElementById('audio-speed');
            speedSelect.value = settings.currentSpeed;
            speedSelect.onchange = (e) => { settings.currentSpeed = parseFloat(e.target.value); saveSettings(); };
        }

        document.getElementById('btn-toggle-furigana').onclick = () => { settings.hideFurigana = !settings.hideFurigana; updateUI(); saveSettings(); };
        document.getElementById('btn-toggle-romaji').onclick = () => { settings.showRomaji = !settings.showRomaji; updateUI(); saveSettings(); };
        document.getElementById('btn-toggle-vi').onclick = () => { settings.showVietnamese = !settings.showVietnamese; updateUI(); saveSettings(); };

        document.addEventListener('DOMContentLoaded', () => {
            initSpeech(); loadSettings();
            renderConversation(); renderReading(); renderGrammar(); renderVocab(); renderQuiz();
            updateUI(); updateProgress();
            setTimeout(loadVoices, 100);
        });
    </script>
</body>
</html>
