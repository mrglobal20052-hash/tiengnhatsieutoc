<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AzaGrammar Master - Ngữ pháp Tình huống</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #f0f2f5; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        .ja-text { font-family: 'Noto Sans JP', sans-serif; }
        
        /* Custom Scrollbar */
        .scroller::-webkit-scrollbar { width: 6px; }
        .scroller::-webkit-scrollbar-track { background: transparent; }
        .scroller::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        
        /* Sidebar Item */
        .sit-header { transition: all 0.2s; }
        .sit-header:hover { background-color: #e0e7ff; }
        .sit-header.active { background-color: #4f46e5; color: white; }
        .sit-header.active i { color: white; }
        
        /* Situation Box */
        .sit-box { transition: transform 0.2s; }
        .sit-box:hover { transform: translateY(-2px); }
        
        /* Animation */
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-in { animation: slideIn 0.3s ease-out forwards; }
        
        /* Mobile Drawer */
        #mobileDrawer { transition: transform 0.3s ease-in-out; }
        #mobileDrawer.open { transform: translateX(0); }
        #mobileDrawer.closed { transform: translateX(-100%); }
    </style>
</head>
<body class="text-slate-800">

    <!-- HEADER -->
    <header class="bg-white border-b border-gray-200 flex-none z-30 h-14 md:h-16 flex items-center justify-between px-4 shadow-sm">
        <div class="flex items-center gap-3">
            <button class="md:hidden text-gray-500 text-xl" onclick="toggleMobileDrawer()"><i class="fas fa-bars"></i></button>
            <div class="flex items-center gap-2 text-indigo-600">
                <i class="fas fa-comments text-2xl"></i>
                <h1 class="font-extrabold text-lg md:text-xl tracking-tight">AzaGrammar <span class="text-xs bg-green-100 px-2 py-0.5 rounded-full text-green-700 ml-1">Situational N3</span></h1>
            </div>
        </div>
        <div class="flex gap-2">
             <button onclick="switchMode('study')" id="btn-study" class="px-4 py-1.5 rounded-lg text-sm font-bold bg-indigo-50 text-indigo-600 hover:bg-indigo-100 transition">Học Tập</button>
             <button onclick="switchMode('practice')" id="btn-practice" class="px-4 py-1.5 rounded-lg text-sm font-bold text-gray-500 hover:bg-gray-100 transition">Luyện Tập</button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- SIDEBAR (Situation List) -->
        <aside id="sidebar" class="hidden md:flex w-80 bg-white border-r border-gray-200 flex-col overflow-hidden z-20">
            <div class="p-4 border-b border-gray-100 bg-gray-50">
                <h2 class="font-bold text-gray-500 text-xs uppercase tracking-wider mb-2">Tình huống giao tiếp</h2>
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i>
                    <input type="text" id="searchInput" placeholder="Tìm tình huống..." class="w-full pl-9 pr-4 py-2 bg-white border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition">
                </div>
            </div>
            <div id="categoryList" class="flex-1 scroller overflow-y-auto pb-20 p-2 space-y-1">
                <!-- Categories will be injected here -->
            </div>
        </aside>

        <!-- MOBILE DRAWER -->
        <div id="mobileDrawer" class="fixed inset-y-0 left-0 w-3/4 max-w-xs bg-white shadow-2xl z-50 md:hidden closed flex flex-col">
            <div class="p-4 bg-indigo-600 text-white flex justify-between items-center">
                <h2 class="font-bold text-lg">Danh sách tình huống</h2>
                <button onclick="toggleMobileDrawer()"><i class="fas fa-times"></i></button>
            </div>
            <div id="mobileCategoryList" class="flex-1 scroller overflow-y-auto p-2"></div>
        </div>
        <div id="drawerBackdrop" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden glass" onclick="toggleMobileDrawer()"></div>

        <!-- MAIN CONTENT AREA -->
        <main class="flex-1 relative bg-[#f3f4f6] overflow-hidden flex flex-col">
            
            <!-- STUDY MODE -->
            <div id="study-view" class="flex-1 flex flex-col h-full overflow-y-auto scroller p-4 md:p-8">
                <div class="max-w-5xl mx-auto w-full pb-20 animate-slide-in">
                    
                    <!-- Title Card -->
                    <div class="mb-8 text-center">
                        <div class="inline-flex items-center gap-2 bg-white px-4 py-1.5 rounded-full shadow-sm mb-3">
                            <span class="w-2 h-2 rounded-full bg-green-500"></span>
                            <span class="text-xs font-bold text-gray-500 uppercase tracking-wider" id="c-cat-name">Situation</span>
                        </div>
                        <h2 class="text-3xl md:text-4xl font-extrabold text-gray-800 mb-2" id="c-title">Title</h2>
                        <p class="text-gray-500 max-w-2xl mx-auto" id="c-desc">Description</p>
                    </div>

                    <!-- Content Container -->
                    <div id="content-container" class="space-y-8">
                        <!-- Grammar Blocks will be injected here -->
                    </div>

                </div>
            </div>

            <!-- PRACTICE MODE (Quiz) -->
            <div id="practice-view" class="hidden flex-1 flex-col h-full bg-white relative">
                <div class="absolute inset-0 flex flex-col max-w-2xl mx-auto p-6 justify-center">
                    <div class="mb-8 text-center">
                        <div class="inline-block bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold mb-2" id="quiz-progress">Câu 1/10</div>
                        <h2 class="text-xl font-bold text-gray-800 mb-2">Sắp xếp câu hoàn chỉnh</h2>
                        <p class="text-gray-500 text-sm">Chọn các từ bên dưới theo đúng thứ tự</p>
                    </div>

                    <!-- Quiz Display -->
                    <div class="bg-gray-50 rounded-2xl p-6 border-2 border-dashed border-gray-200 mb-6 min-h-[120px] flex flex-wrap items-center gap-2 justify-center" id="quiz-answer-zone"></div>

                    <div class="mb-8">
                         <p class="text-center text-gray-600 text-sm mb-4" id="quiz-question-vi">...</p>
                         <div class="flex flex-wrap justify-center gap-3" id="quiz-options-zone"></div>
                    </div>

                    <div class="flex gap-4">
                        <button onclick="resetQuizQuestion()" class="flex-1 py-3 rounded-xl border border-gray-300 text-gray-600 font-bold hover:bg-gray-50 transition"><i class="fas fa-undo"></i> Làm lại</button>
                        <button onclick="checkQuizAnswer()" class="flex-1 py-3 rounded-xl bg-indigo-600 text-white font-bold hover:bg-indigo-700 shadow-lg transition shadow-indigo-200" id="btn-submit-quiz">Kiểm tra</button>
                    </div>
                    
                    <!-- Feedback Overlay -->
                    <div id="quiz-feedback" class="absolute inset-0 bg-white/90 backdrop-blur-sm z-10 hidden flex-col items-center justify-center text-center p-6 rounded-2xl">
                        <div class="text-6xl mb-4" id="fb-icon"></div>
                        <h3 class="text-2xl font-bold mb-2" id="fb-text"></h3>
                        <p class="text-gray-500 mb-6" id="fb-subtext"></p>
                        <button onclick="nextQuizQuestion()" class="bg-gray-900 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:scale-105 transition">Tiếp tục <i class="fas fa-arrow-right ml-2"></i></button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- MODAL: GRAMMAR DETAIL -->
    <div id="detailGrammarModal" class="fixed inset-0 z-[90] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity opacity-0" id="detailGrammarBackdrop" onclick="closeModal('detailGrammarModal')"></div>
        <div class="bg-white rounded-2xl w-full max-w-md relative z-10 shadow-2xl transform transition-all scale-95 opacity-0 flex flex-col" id="detailGrammarPanel">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 rounded-t-2xl">
                <div class="flex items-center gap-2">
                    <div class="bg-indigo-100 p-1.5 rounded-lg text-indigo-600"><i class="fas fa-info-circle"></i></div>
                    <h3 class="text-lg font-bold text-gray-800">Giải thích Ngữ pháp</h3>
                </div>
                <button onclick="closeModal('detailGrammarModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6">
                <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-3 text-center mb-4 shadow-sm">
                    <code class="text-lg font-bold text-indigo-700 font-mono" id="dgFormula"></code>
                </div>
                <div id="dgExplanation" class="text-gray-600 text-sm mb-4 space-y-3 leading-relaxed"></div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. GRAMMAR REPO (Day 35) ---
        const grammarRepo = {
            "hou_ga_ii": { title: "Nên / Không nên", formula: "Vた/Vない + ほうがいい", desc: "Lời khuyên trực tiếp, cho rằng làm (hoặc không làm) là tốt hơn.", ex: "早く寝たほうがいい。" },
            "tara_dou": { title: "Thử... xem sao?", formula: "Vたら + どうですか", desc: "Lời khuyên nhẹ nhàng, gợi ý, đề xuất.", ex: "医者に診てもらったらどうですか。" },
            "beki": { title: "Phải / Nên (Đạo đức)", formula: "Vる + べきだ", desc: "Lời khuyên mang tính nghĩa vụ, đạo đức, lẽ thường.", ex: "約束は守るべきだ。" },
            "noni": { title: "Thế mà (Bất mãn)", formula: "Thể thường + のに", desc: "Diễn tả sự ngạc nhiên, bất mãn vì kết quả trái ngược mong đợi.", ex: "一生懸命勉強したのに、不合格だった。" },
            "kuse_ni": { title: "Mặc dù... (Trách móc)", formula: "Thể thường + くせに", desc: "Giống 'noni' nhưng mang sắc thái khinh miệt, chỉ trích mạnh hơn.", ex: "知っているくせに、教えてくれない。" },
            "bakari": { title: "Toàn là / Chỉ toàn", formula: "N/Vて + ばかり", desc: "Chỉ toàn làm một việc gì đó (thường là tiêu cực).", ex: "遊んでばかりいる。" },
            "mitai": { title: "Hình như / Giống như", formula: "Thể thường + みたい", desc: "Phỏng đoán dựa trên cảm nhận, hoặc so sánh ví von.", ex: "雨が降るみたいだ。" },
            "rashii": { title: "Nghe nói / Đúng chất", formula: "Thể thường + らしい", desc: "Phỏng đoán có căn cứ (nghe nói), hoặc mang tính chất điển hình.", ex: "彼は来ないらしい。" },
            "ppoi": { title: "Có vẻ / Hay / Đầy", formula: "N/Vmas + っぽい", desc: "Cảm thấy như là (thường tiêu cực), hoặc tính chất (nhiều, hay).", ex: "安っぽい (trông rẻ tiền), 怒りっぽい (hay cáu)." },
            "okage": { title: "Nhờ có (Biết ơn)", formula: "Thể thường + おかげで", desc: "Nguyên nhân dẫn đến kết quả tốt.", ex: "先生のおかげです。" },
            "sei": { title: "Tại vì (Đổ lỗi)", formula: "Thể thường + せいで", desc: "Nguyên nhân dẫn đến kết quả xấu.", ex: "雨のせいで遅れた。" },
            "wake": { title: "Thảo nào / Hèn chi", formula: "Thể thường + わけだ", desc: "Hiểu ra lý do, kết luận logic.", ex: "暑いわけだ。エアコンが壊れている。" },
            "tokoro": { title: "Đúng lúc / Vừa mới", formula: "Vる/Vている/Vた + ところ", desc: "Nhấn mạnh thời điểm của hành động.", ex: "今帰ったところだ。" },
            "aida": { title: "Trong suốt", formula: "Vている/Nの + 間", desc: "Hành động diễn ra liên tục trong một khoảng thời gian.", ex: "待っている間、本を読んでいた。" },
            "uchi_ni": { title: "Nhân lúc / Trong lúc", formula: "Vる/Vない/A/Nの + うちに", desc: "Tranh thủ làm gì trước khi biến đổi, hoặc biến đổi tự nhiên trong khi...", ex: "温かいうちに食べて。" }
        };

        // --- DATA: Situational Grammar ---
        const situationData = {
            "advice": {
                name: "1. Khuyên bảo & Đề nghị",
                icon: "comment-medical",
                color: "blue",
                desc: "Các mẫu câu dùng để đưa ra lời khuyên, gợi ý cho người khác.",
                items: [
                    { 
                        title: "Nên làm gì...", 
                        patterns: [
                            { gId: "hou_ga_ii", name: "〜ほうがいい", usage: "Khuyên nên/không nên (khá mạnh)" },
                            { gId: "tara_dou", name: "〜たらどう", usage: "Gợi ý nhẹ nhàng, thử xem sao" },
                            { gId: "beki", name: "〜べき", usage: "Nên làm (đạo đức, nghĩa vụ)" }
                        ],
                        examples: [
                            {ja:"熱があるなら、早く寝たほうがいいですよ。", vi:"Nếu bị sốt thì nên ngủ sớm đi.", gIds:["hou_ga_ii"]},
                            {ja:"嫌いなことはしないほうがいい。", vi:"Không nên làm việc mình ghét.", gIds:["hou_ga_ii"]},
                            {ja:"もっと野菜を食べたらどうですか。", vi:"Bạn thử ăn nhiều rau hơn xem sao?", gIds:["tara_dou"]},
                            {ja:"先生に相談してみたらどうですか。", vi:"Thử thảo luận với thầy giáo xem sao?", gIds:["tara_dou"]},
                            {ja:"約束は守るべきだ。", vi:"Đã hứa thì phải giữ lời.", gIds:["beki"]},
                            {ja:"学生はもっと勉強するべきだ。", vi:"Học sinh thì nên học nhiều hơn.", gIds:["beki"]}
                        ]
                    }
                ]
            },
            "complaint": {
                name: "2. Phàn nàn & Tiếc nuối",
                icon: "tired",
                color: "red",
                desc: "Diễn tả sự bất mãn, kết quả không như ý hoặc phê phán.",
                items: [
                    { 
                        title: "Sự trái ngược, bất mãn", 
                        patterns: [
                            { gId: "noni", name: "〜のに", usage: "Thế mà... (Bất mãn, ngạc nhiên)" },
                            { gId: "kuse_ni", name: "〜くせに", usage: "Mặc dù... (Khinh miệt, trách móc)" },
                            { gId: "bakari", name: "〜ばかり", usage: "Toàn là... (Phê phán số lượng nhiều)" }
                        ],
                        examples: [
                            {ja:"一生懸命勉強したのに、テストが悪かった。", vi:"Đã học chăm chỉ thế mà bài kiểm tra lại kém.", gIds:["noni"]},
                            {ja:"日曜日なのに、働かなければなりません。", vi:"Chủ nhật mà vẫn phải làm việc.", gIds:["noni"]},
                            {ja:"知っているくせに、教えてくれない。", vi:"Biết mà không thèm chỉ cho tôi.", gIds:["kuse_ni"]},
                            {ja:"男のくせに、めめしい。", vi:"Đàn ông mà ủy mị quá.", gIds:["kuse_ni"]},
                            {ja:"弟は遊んでばかりいる。", vi:"Em trai tôi toàn chơi thôi.", gIds:["bakari"]},
                            {ja:"文句ばかり言わないでください。", vi:"Đừng có toàn phàn nàn như thế.", gIds:["bakari"]}
                        ]
                    }
                ]
            },
            "conjecture": {
                name: "3. Phán đoán & Cảm nhận",
                icon: "magic",
                color: "purple",
                desc: "Các cách diễn đạt sự suy đoán dựa trên các căn cứ khác nhau.",
                items: [
                    { 
                        title: "Hình như, Có vẻ...", 
                        patterns: [
                            { gId: "mitai", name: "〜みたい", usage: "Giống như, hình như (trực quan/ví von)" },
                            { gId: "rashii", name: "〜らしい", usage: "Nghe nói, đúng chất (khách quan)" },
                            { gId: "ppoi", name: "〜っぽい", usage: "Có vẻ, hay, đậm chất (cảm giác)" }
                        ],
                        examples: [
                            {ja:"彼は疲れているみたいだ。", vi:"Trông anh ấy có vẻ mệt (nhìn dáng vẻ).", gIds:["mitai"]},
                            {ja:"夢みたいだ。", vi:"Cứ như là mơ vậy.", gIds:["mitai"]},
                            {ja:"噂によると、彼は辞めるらしい。", vi:"Theo tin đồn thì hình như anh ấy sẽ nghỉ.", gIds:["rashii"]},
                            {ja:"今日は春らしい天気だ。", vi:"Hôm nay thời tiết đúng chất mùa xuân.", gIds:["rashii"]},
                            {ja:"あの人は子供っぽい。", vi:"Người đó tính trẻ con.", gIds:["ppoi"]},
                            {ja:"この服は安っぽい。", vi:"Bộ đồ này trông rẻ tiền.", gIds:["ppoi"]},
                            {ja:"彼は怒りっぽい。", vi:"Anh ta hay cáu gắt.", gIds:["ppoi"]}
                        ]
                    }
                ]
            },
            "reasoning": {
                name: "4. Nguyên nhân & Lý do",
                icon: "link",
                color: "green",
                desc: "Giải thích lý do dẫn đến kết quả tốt hoặc xấu, hoặc hiểu ra vấn đề.",
                items: [
                    { 
                        title: "Tại sao lại như vậy?", 
                        patterns: [
                            { gId: "okage", name: "〜おかげで", usage: "Nhờ có (Biết ơn)" },
                            { gId: "sei", name: "〜せいで", usage: "Tại vì (Đổ lỗi)" },
                            { gId: "wake", name: "〜わけだ", usage: "Thảo nào / Hèn chi (Kết luận logic)" }
                        ],
                        examples: [
                            {ja:"先生のおかげで、合格しました。", vi:"Nhờ có thầy mà em đã đỗ.", gIds:["okage"]},
                            {ja:"天気がいいおかげで、旅行が楽しかった。", vi:"Nhờ thời tiết đẹp mà chuyến đi vui.", gIds:["okage"]},
                            {ja:"バスが遅れたせいで、遅刻した。", vi:"Tại xe buýt trễ mà tôi đến muộn.", gIds:["sei"]},
                            {ja:"君のせいじゃないよ。", vi:"Không phải tại cậu đâu.", gIds:["sei"]},
                            {ja:"暑いわけだ。気温が38度もある。", vi:"Hèn chi nóng thế. Nhiệt độ tận 38 độ.", gIds:["wake"]},
                            {ja:"道理でできないわけだ。", vi:"Thảo nào mà không làm được.", gIds:["wake"]}
                        ]
                    }
                ]
            },
            "time_aspect": {
                name: "5. Thời điểm & Quá trình",
                icon: "history",
                color: "yellow",
                desc: "Diễn tả hành động trong mối tương quan với thời gian.",
                items: [
                    { 
                        title: "Khi nào?", 
                        patterns: [
                            { gId: "tokoro", name: "〜ところ", usage: "Đúng lúc (sắp/đang/vừa)" },
                            { gId: "uchi_ni", name: "〜うちに", usage: "Tranh thủ / Trong lúc (biến đổi)" },
                            { gId: "aida", name: "〜間・間に", usage: "Trong suốt / Trong khi (xen vào)" }
                        ],
                        examples: [
                            {ja:"今、出かけるところです。", vi:"Giờ tôi sắp ra ngoài.", gIds:["tokoro"]},
                            {ja:"ちょうどご飯を食べたところです。", vi:"Tôi vừa mới ăn cơm xong.", gIds:["tokoro"]},
                            {ja:"温かいうちに食べてください。", vi:"Hãy ăn khi còn nóng.", gIds:["uchi_ni"]},
                            {ja:"日本にいるうちに、富士山に登りたい。", vi:"Tranh thủ lúc ở Nhật muốn leo núi Phú Sĩ.", gIds:["uchi_ni"]},
                            {ja:"留守の間に友達が来た。", vi:"Bạn đến chơi lúc tôi vắng nhà.", gIds:["aida"]}
                        ]
                    }
                ]
            }
        };

        let currentSituation = 'advice';
        let currentQuizData = null;

        function init() {
            renderSidebar();
            selectSituation('advice');
            setupMobileDrawer();
        }

        function renderSidebar() {
            const list = document.getElementById('categoryList');
            const mobileList = document.getElementById('mobileCategoryList');
            let html = '';
            
            Object.keys(situationData).forEach(key => {
                const sit = situationData[key];
                html += `
                    <div onclick="selectSituation('${key}')" class="sit-header p-3 rounded-lg cursor-pointer flex items-center gap-3 font-bold text-gray-700 hover:bg-gray-100 mb-2" data-sit="${key}">
                        <div class="w-8 h-8 rounded-full bg-${sit.color}-100 text-${sit.color}-600 flex items-center justify-center"><i class="fas fa-${sit.icon}"></i></div>
                        <span>${sit.name}</span>
                    </div>
                `;
            });
            list.innerHTML = html;
            mobileList.innerHTML = html;
        }

        function selectSituation(key) {
            currentSituation = key;
            document.querySelectorAll('.sit-header').forEach(el => el.classList.remove('active'));
            document.querySelectorAll(`.sit-header[data-sit="${key}"]`).forEach(el => el.classList.add('active'));

            const data = situationData[key];
            
            // Render Main Content
            document.getElementById('c-cat-name').innerText = data.name;
            document.getElementById('c-title').innerText = "Các Mẫu Ngữ Pháp";
            document.getElementById('c-desc').innerText = data.desc;

            const container = document.getElementById('content-container');
            container.innerHTML = data.items.map(group => `
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden sit-box">
                    <div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                        <h3 class="font-bold text-xl text-gray-800">${group.title}</h3>
                    </div>
                    <div class="p-6">
                        <div class="flex flex-wrap gap-2 mb-6">
                            ${group.patterns.map(p => `
                                <span class="px-3 py-1 bg-indigo-50 text-indigo-700 rounded-full text-sm font-bold border border-indigo-100 cursor-pointer hover:bg-indigo-100" onclick="openExplan('${p.gId}')">
                                    ${p.name}
                                </span>
                            `).join('')}
                        </div>
                        <div class="space-y-4">
                            ${group.examples.map(ex => `
                                <div class="flex items-start gap-3 group">
                                    <button onclick="speakText('${ex.ja.replace(/'/g, "\\'")}')" class="mt-1 w-8 h-8 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center hover:bg-indigo-500 hover:text-white transition flex-shrink-0">
                                        <i class="fas fa-volume-up text-sm"></i>
                                    </button>
                                    <div>
                                        <p class="text-lg font-bold text-gray-800 ja-text">${ex.ja}</p>
                                        <p class="text-gray-500 text-sm">${ex.vi}</p>
                                        <div class="mt-1">
                                            ${ex.gIds ? ex.gIds.map(gid => `<span onclick="openExplan('${gid}')" class="text-[10px] text-gray-400 border border-gray-200 px-1.5 py-0.5 rounded cursor-pointer hover:text-indigo-600 hover:border-indigo-300 mr-1">GT</span>`).join('') : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `).join('');

            toggleMobileDrawer(false);
        }

        // --- GRAMMAR MODAL LOGIC ---
        function openExplan(idsStr) {
             const ids = idsStr.split(','); 
             const f = document.getElementById('dgFormula'); 
             const e = document.getElementById('dgExplanation');
             
             f.innerHTML = '';
             e.innerHTML = ids.map(id => {
                 const g = grammarRepo[id];
                 if (!g) return `<div class="text-red-400 text-xs">Mã ngữ pháp: ${id}</div>`;
                 return `
                 <div class="mb-4 last:mb-0">
                     <h4 class="font-bold text-indigo-700 flex items-center gap-2"><i class="fas fa-bookmark text-sm"></i> ${g.title}</h4>
                     <code class="block bg-gray-100 p-2 rounded text-sm font-mono my-2 text-gray-700">${g.formula}</code>
                     <p class="text-sm text-gray-600">${g.desc}</p>
                 </div>`;
             }).join('<hr class="my-4 border-gray-100">');
             
             document.getElementById('detailGrammarModal').classList.remove('hidden');
             setTimeout(() => {
                 document.getElementById('detailGrammarBackdrop').classList.remove('opacity-0');
                 document.getElementById('detailGrammarPanel').classList.remove('opacity-0', 'scale-95');
             }, 10);
        }

        function closeModal(id) {
            const b = document.getElementById('detailGrammarBackdrop');
            const p = document.getElementById('detailGrammarPanel');
            b.classList.add('opacity-0');
            p.classList.add('opacity-0', 'scale-95');
            setTimeout(() => document.getElementById(id).classList.add('hidden'), 200);
        }

        // --- QUIZ LOGIC ---
        function switchMode(mode) {
            document.getElementById('study-view').classList.toggle('hidden', mode !== 'study');
            document.getElementById('practice-view').classList.toggle('hidden', mode !== 'practice');
            
            const btnStudy = document.getElementById('btn-study');
            const btnPractice = document.getElementById('btn-practice');
            
            if(mode === 'study') {
                btnStudy.className = "px-4 py-1.5 rounded-lg text-sm font-bold bg-indigo-50 text-indigo-600 shadow-sm";
                btnPractice.className = "px-4 py-1.5 rounded-lg text-sm font-bold text-gray-500 hover:bg-gray-100";
            } else {
                btnPractice.className = "px-4 py-1.5 rounded-lg text-sm font-bold bg-green-50 text-green-600 shadow-sm";
                btnStudy.className = "px-4 py-1.5 rounded-lg text-sm font-bold text-gray-500 hover:bg-gray-100";
                generateQuiz();
            }
        }
        
        function generateQuiz() {
            // Pick random situation & item
            const sitKeys = Object.keys(situationData);
            const randSit = situationData[sitKeys[Math.floor(Math.random() * sitKeys.length)]];
            const randGroup = randSit.items[Math.floor(Math.random() * randSit.items.length)];
            const targetEx = randGroup.examples[Math.floor(Math.random() * randGroup.examples.length)];
            
            // Segment
            const segments = targetEx.ja.split(/(?=[をにがはの。て、])|(?<=[をにがはの。て、])/g).filter(s => s.trim().length > 0);
            
            currentQuizData = {
                original: targetEx.ja,
                vi: targetEx.vi,
                segments: shuffleArray([...segments])
            };

            document.getElementById('quiz-question-vi').innerText = `"${currentQuizData.vi}"`;
            document.getElementById('quiz-answer-zone').innerHTML = '<span class="text-gray-400 italic text-sm pointer-events-none">Kéo từ vào đây</span>';
            
            const optionsZone = document.getElementById('quiz-options-zone');
            optionsZone.innerHTML = '';
            currentQuizData.segments.forEach((seg) => {
                const btn = document.createElement('button');
                btn.className = "bg-white border-2 border-indigo-100 text-indigo-700 font-bold py-2 px-4 rounded-lg shadow-sm hover:bg-indigo-50 active:scale-95 transition ja-text text-lg";
                btn.innerText = seg;
                btn.onclick = () => addToAnswer(seg, btn);
                optionsZone.appendChild(btn);
            });

            document.getElementById('quiz-feedback').classList.add('hidden');
            document.getElementById('btn-submit-quiz').disabled = false;
        }

        function addToAnswer(text, btnElement) {
            const zone = document.getElementById('quiz-answer-zone');
            if (zone.children.length === 1 && zone.children[0].tagName === 'SPAN') zone.innerHTML = '';
            
            const chip = document.createElement('div');
            chip.className = "bg-indigo-600 text-white px-3 py-1 rounded-lg font-bold shadow-md cursor-pointer hover:bg-red-500 transition ja-text flex items-center gap-2 animate-slide-in";
            chip.innerHTML = `${text}`;
            chip.onclick = () => {
                chip.remove();
                btnElement.classList.remove('opacity-0', 'pointer-events-none');
                if(zone.children.length === 0) zone.innerHTML = '<span class="text-gray-400 italic text-sm pointer-events-none">Kéo từ vào đây</span>';
            };
            
            zone.appendChild(chip);
            btnElement.classList.add('opacity-0', 'pointer-events-none');
        }
        
        function resetQuizQuestion() { generateQuiz(); }

        function checkQuizAnswer() {
            const zone = document.getElementById('quiz-answer-zone');
            const userAnswer = Array.from(zone.children).map(c => c.innerText).join('');
            const isCorrect = userAnswer === currentQuizData.original.replace(/\s/g, '');
            
            const fb = document.getElementById('quiz-feedback');
            const icon = document.getElementById('fb-icon');
            const text = document.getElementById('fb-text');
            const sub = document.getElementById('fb-subtext');
            
            fb.classList.remove('hidden', 'flex');
            fb.classList.add('flex');
            
            if (isCorrect) {
                icon.innerHTML = '<i class="fas fa-check-circle text-green-500"></i>';
                text.innerText = "Chính xác!";
                text.className = "text-2xl font-bold mb-2 text-green-600";
                sub.innerText = currentQuizData.original;
                speakText(currentQuizData.original);
            } else {
                icon.innerHTML = '<i class="fas fa-times-circle text-red-500"></i>';
                text.innerText = "Tiếc quá!";
                text.className = "text-2xl font-bold mb-2 text-red-600";
                sub.innerText = `Đáp án đúng: ${currentQuizData.original}`;
            }
        }
        
        function nextQuizQuestion() { generateQuiz(); }

        // --- UTILS ---
        function toggleMobileDrawer(forceState) {
            const drawer = document.getElementById('mobileDrawer');
            const backdrop = document.getElementById('drawerBackdrop');
            const isOpen = forceState !== undefined ? forceState : !drawer.classList.contains('closed');
            if (!isOpen) { drawer.classList.remove('open'); drawer.classList.add('closed'); backdrop.classList.add('hidden'); }
            else { drawer.classList.remove('closed'); drawer.classList.add('open'); backdrop.classList.remove('hidden'); }
        }
        function setupMobileDrawer() { toggleMobileDrawer(false); }
        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }
        function speakText(text) { if ('speechSynthesis' in window) { const u = new SpeechSynthesisUtterance(text); u.lang = 'ja-JP'; u.rate = 0.9; speechSynthesis.speak(u); } }

        document.getElementById('searchInput').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
             // Simple search: filter headers
             document.querySelectorAll('.sit-header').forEach(item => {
                if(item.innerText.toLowerCase().includes(term)) item.style.display = 'flex';
                else item.style.display = 'none';
            });
        });

        init();
    </script>
</body>
</html>
