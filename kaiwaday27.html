<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Há»c Tiáº¿ng Nháº­t SiÃªu Tá»‘c - NgÃ y 27</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .jp-font {
            font-family: 'Noto Sans JP', sans-serif;
        }
        ruby rt {
            font-size: 0.7em;
            font-weight: 500;
            user-select: none;
        }
        .hide-furigana ruby rt {
            visibility: hidden;
        }
        .transition-height {
            transition: max-height 0.5s ease-in-out;
        }
        .correct-char { color: #16a34a; }
        .incorrect-char { color: #dc2626; text-decoration: underline; }
        
        /* --- NEW STYLES FOR UPGRADES --- */
        /* Progress Bar */
        .progress-bar-container {
            background-color: #e5e7eb; /* gray-200 */
            border-radius: 9999px;
            overflow: hidden;
        }
        .progress-bar {
            background-color: #22c55e; /* green-500 */
            transition: width 0.5s ease-in-out;
        }
        /* Fade transition for conversation */
        .content-fade {
            transition: opacity 0.3s ease-in-out;
        }
        .fading-out {
            opacity: 0;
        }
        /* Quiz feedback icons */
        .feedback-icon {
            display: inline-block;
            margin-right: 0.5rem;
            font-weight: bold;
        }
        .feedback-correct { color: #16a34a; }
        .feedback-incorrect { color: #dc2626; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-sky-700 jp-font" id="main-title"></h1>
            <p class="text-gray-500 mt-2">BÃ i há»c Ã´n táº­p vá» lÃ½ do, tÆ°Æ¡ng pháº£n vÃ  Ä‘á» xuáº¥t.</p>
        </header>

        <!-- Progress Bar Section -->
        <div class="mb-8">
            <h3 class="font-bold text-center mb-2">Tiáº¿n Ä‘á»™ bÃ i há»c</h3>
            <div class="progress-bar-container w-full h-4">
                <div id="lesson-progress-bar" class="progress-bar h-full text-xs text-white text-center" style="width: 0%;"></div>
            </div>
        </div>

        <main class="space-y-8">
            <!-- Settings Panel -->
            <div class="bg-white p-4 rounded-xl shadow-md border border-gray-200">
                <h3 class="font-bold text-lg mb-3 text-gray-700">Báº£ng Ä‘iá»u khiá»ƒn</h3>
                <div class="flex flex-wrap gap-4">
                    <button id="toggle-furigana" class="toggle-btn">Báº­t Furigana</button>
                    <button id="toggle-romaji" class="toggle-btn">Hiá»‡n Romaji</button>
                    <button id="toggle-vietnamese" class="toggle-btn">Hiá»‡n Tiáº¿ng Viá»‡t</button>
                </div>
            </div>

            <!-- Conversation Section -->
            <section id="conversation-section" class="lesson-section"></section>

            <!-- Reading Section -->
            <section id="reading-section" class="lesson-section"></section>

            <!-- Grammar Section -->
            <section id="grammar-section" class="lesson-section"></section>
            
            <!-- Quiz Section -->
            <section id="quiz-section" class="lesson-section"></section>
        </main>

        <footer class="text-center mt-12 text-gray-400 text-sm">
            <p>Copyright by AzaCan, 2025</p>
        </footer>
    </div>

    <script>
        // --- DATA FOR DAY 27 ---
        const day27Data = {
            title: "NgÃ y 27: Ã”n táº­p LÃ½ do vÃ  TÆ°Æ¡ng pháº£n",
            conversation: {
                id: 'conversation',
                title: "ä»Šæ—¥ã®ä¼šè©± (Há»™i thoáº¡i trong ngÃ y)",
                context: "Bá»‘i cáº£nh: Tanaka vÃ  Suzuki nÃ³i vá» cÃ´ng viá»‡c.",
                modes: {
                    polite: {
                        name: "Thá»ƒ lá»‹ch sá»± (ä¸å¯§å½¢)",
                        dialogue: [
                            { speaker: "Tanaka", jp: "éˆ´æœ¨[ã™ãšã]ã•ã‚“ã€æœ€è¿‘[ã•ã„ãã‚“]ãŠç–²[ã¤ã‹]ã‚Œã®ã‚ˆã†ã§ã™ã­ã€‚é¡”è‰²[ã‹ãŠã„ã‚]ãŒæ‚ª[ã‚ã‚‹]ã„ã§ã™ã‚ˆã€‚", romaji: "Suzuki-san, saikin o-tsukare no you desu ne. Kaoiro ga warui desu yo.", vi: "Anh Suzuki, dáº¡o nÃ y cÃ³ váº» anh má»‡t má»i nhá»‰. Sáº¯c máº·t anh khÃ´ng tá»‘t Ä‘Ã¢u." },
                            { speaker: "Suzuki", jp: "ãˆãˆã€‚ä»•äº‹[ã—ã”ã¨]ãŒå¿™[ã„ããŒ]ã—ã„åé¢[ã¯ã‚“ã‚ã‚“]ã€çµ¦æ–™[ãã‚…ã†ã‚Šã‚‡ã†]ãŒä¸Š[ã‚]ãŒã‚‰ãªã„ã®ã§ã€ã¡ã‚‡ã£ã¨ä¸æº€[ãµã¾ã‚“]ãªã‚“ã§ã™ã€‚", romaji: "Ee. Shigoto ga isogashii hanmen, kyuuryou ga agaranai node, chotto fuman nan desu.", vi: "VÃ¢ng. CÃ´ng viá»‡c báº­n rá»™n nhÆ°ng máº·t khÃ¡c lÆ°Æ¡ng láº¡i khÃ´ng tÄƒng nÃªn tÃ´i hÆ¡i báº¥t mÃ£n má»™t chÃºt." },
                            { speaker: "Tanaka", jp: "ãã‚Œã¯å¤§å¤‰[ãŸã„ã¸ã‚“]ã§ã™ã­ã€‚ã§ã‚‚ã€ã‚„ã‚ŠãŒã„ãŒã‚ã‚‹ä»•äº‹[ã—ã”ã¨]ãªã®ã ã‹ã‚‰ã€ã‚‚ã†å°‘ã—é ‘å¼µ[ãŒã‚“ã°]ã£ãŸã‚‰ã©ã†ã§ã™ã‹ã€‚", romaji: "Sore wa taihen desu ne. Demo, yarigai ga aru shigoto na no dakara, mou sukoshi ganbattara dou desu ka.", vi: "Tháº¿ thÃ¬ váº¥t váº£ nhá»‰. NhÆ°ng vÃ¬ Ä‘Ã¢y lÃ  má»™t cÃ´ng viá»‡c Ä‘Ã¡ng lÃ m, sao anh khÃ´ng thá»­ cá»‘ gáº¯ng thÃªm má»™t chÃºt ná»¯a?" },
                            { speaker: "Suzuki", jp: "ãã†ã§ã™ã­ã€‚ã“ã®ä¼šç¤¾[ã‹ã„ã—ã‚ƒ]ã¯å®‰å®š[ã‚ã‚“ã¦ã„]ã—ã¦ã„ã‚‹ä¸€æ–¹[ã„ã£ã½ã†]ã§ã€å¤‰åŒ–[ã¸ã‚“ã‹]ãŒå°‘[ã™ã]ãªã„ã§ã™ã€‚å…„[ã‚ã«]ã®ä¼šç¤¾[ã‹ã„ã—ã‚ƒ]ã¯æŒ‘æˆ¦çš„[ã¡ã‚‡ã†ã›ã‚“ã¦ã]ãªã®ã«å¯¾[ãŸã„]ã—ã¦ã€ã†ã¡ã®ä¼šç¤¾[ã‹ã„ã—ã‚ƒ]ã¯ä¿å®ˆçš„[ã»ã—ã‚…ã¦ã]ã§ã™ã€‚", romaji: "Sou desu ne. Kono kaisha wa antei shite iru ippou de, henka ga sukunai desu. Ani no kaisha wa chousenteki na no ni taishite, uchi no kaisha wa hoshuteki desu.", vi: "ÄÃºng váº­y nhá»‰. CÃ´ng ty nÃ y á»•n Ä‘á»‹nh nhÆ°ng Ä‘á»“ng thá»i láº¡i cÃ³ Ã­t sá»± thay Ä‘á»•i. TrÃ¡i ngÆ°á»£c vá»›i cÃ´ng ty cá»§a anh trai tÃ´i ráº¥t cÃ³ tÃ­nh thá»­ thÃ¡ch, cÃ´ng ty cá»§a tÃ´i láº¡i khÃ¡ báº£o thá»§." },
                            { speaker: "Tanaka", jp: "ã‚‚ã—è»¢è·[ã¦ã‚“ã—ã‚‡ã]ã‚’è€ƒ[ã‹ã‚“ãŒ]ãˆã¦ã„ã‚‹ã®ãªã‚‰ã€ä¸€åº¦[ã„ã¡ã©]ç›¸è«‡[ãã†ã ã‚“]ã«ä¹—[ã®]ã‚Šã¾ã™ã‚ˆã€‚", romaji: "Moshi tenshoku o kangaete iru no nara, ichido soudan ni norimasu yo.", vi: "Náº¿u anh Ä‘ang suy nghÄ© vá» viá»‡c chuyá»ƒn viá»‡c thÃ¬ tÃ´i sáº½ cho anh lá»i khuyÃªn." },
                            { speaker: "Suzuki", jp: "ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚å¿ƒå¼·[ã“ã“ã‚ã¥ã‚ˆ]ã„ã§ã™ã€‚", romaji: "Arigatou gozaimasu. Kokorozuyoi desu.", vi: "Cáº£m Æ¡n anh. TÃ´i cáº£m tháº¥y vá»¯ng tÃ¢m hÆ¡n nhiá»u." }
                        ]
                    },
                    casual: {
                        name: "Thá»ƒ thÃ´ng thÆ°á»ng (æ™®é€šå½¢)",
                        dialogue: [
                            { speaker: "Tanaka", jp: "éˆ´æœ¨[ã™ãšã]ãã‚“ã€æœ€è¿‘[ã•ã„ãã‚“]ç–²[ã¤ã‹]ã‚Œã¦ã‚‹ã¿ãŸã„ã ã­ã€‚é¡”è‰²[ã‹ãŠã„ã‚]ã€æ‚ª[ã‚ã‚‹]ã„ã‚ˆã€‚", romaji: "Suzuki-kun, saikin tsukareteru mitai da ne. Kaoiro, warui yo.", vi: "Suzuki, dáº¡o nÃ y trÃ´ng cáº­u má»‡t má»i tháº¿. Sáº¯c máº·t kÃ©m láº¯m." },
                            { speaker: "Suzuki", jp: "ã†ã‚“ã€‚ä»•äº‹[ã—ã”ã¨]ãŒå¿™[ã„ããŒ]ã—ã„åé¢[ã¯ã‚“ã‚ã‚“]ã€çµ¦æ–™[ãã‚…ã†ã‚Šã‚‡ã†]ãŒä¸Š[ã‚]ãŒã‚‰ãªã„ã‹ã‚‰ã€ã¡ã‚‡ã£ã¨ä¸æº€[ãµã¾ã‚“]ãªã‚“ã ã€‚", romaji: "Un. Shigoto ga isogashii hanmen, kyuuryou ga agaranai kara, chotto fuman nanda.", vi: "á»ª. CÃ´ng viá»‡c thÃ¬ báº­n mÃ  lÆ°Æ¡ng cháº³ng tÄƒng, nÃªn tá»› hÆ¡i báº¥t mÃ£n." },
                            { speaker: "Tanaka", jp: "å¤§å¤‰[ãŸã„ã¸ã‚“]ã ã­ã€‚ã§ã‚‚ã€ã‚„ã‚ŠãŒã„ãŒã‚ã‚‹ä»•äº‹[ã—ã”ã¨]ãªã‚“ã ã‹ã‚‰ã€ã‚‚ã†ã¡ã‚‡ã£ã¨é ‘å¼µ[ãŒã‚“ã°]ã£ãŸã‚‰ã©ã†ï¼Ÿ", romaji: "Taihen da ne. Demo, yarigai ga aru shigoto nanda kara, mou chotto ganbattara dou?", vi: "Váº¥t váº£ nhá»‰. NhÆ°ng mÃ  viá»‡c nÃ y cÅ©ng Ä‘Ã¡ng lÃ m mÃ , sao khÃ´ng cá»‘ thÃªm chÃºt ná»¯a?" },
                            { speaker: "Suzuki", jp: "ãã†ã ã­ã€‚ã“ã®ä¼šç¤¾[ã‹ã„ã—ã‚ƒ]ã€å®‰å®š[ã‚ã‚“ã¦ã„]ã—ã¦ã‚‹ä¸€æ–¹[ã„ã£ã½ã†]ã§ã€å¤‰åŒ–[ã¸ã‚“ã‹]ãŒå°‘[ã™ã]ãªã„ã‚“ã ã€‚å…„è²´[ã‚ã«ã]ã®ä¼šç¤¾[ã‹ã„ã—ã‚ƒ]ã¯æŒ‘æˆ¦çš„[ã¡ã‚‡ã†ã›ã‚“ã¦ã]ãªã®ã«å¯¾[ãŸã„]ã—ã¦ã€ã†ã¡ã®ã¯ä¿å®ˆçš„[ã»ã—ã‚…ã¦ã]ã ã‚ˆã€‚", romaji: "Sou da ne. Kono kaisha, antei shiteru ippou de, henka ga sukunain da. Aniki no kaisha wa chousenteki na no ni taishite, uchi no wa hoshuteki da yo.", vi: "CÅ©ng Ä‘Ãºng. CÃ´ng ty nÃ y á»•n Ä‘á»‹nh nhÆ°ng mÃ  Ã­t thay Ä‘á»•i láº¯m. CÃ´ng ty anh trai tá»› thÃ¬ Ä‘áº§y thá»­ thÃ¡ch, trÃ¡i láº¡i cÃ´ng ty mÃ¬nh thÃ¬ báº£o thá»§." },
                            { speaker: "Tanaka", jp: "ã‚‚ã—è»¢è·[ã¦ã‚“ã—ã‚‡ã]è€ƒ[ã‹ã‚“ãŒ]ãˆã¦ã‚‹ãªã‚‰ã€ã„ã¤ã§ã‚‚ç›¸è«‡[ãã†ã ã‚“]ã«ä¹—[ã®]ã‚‹ã‚ˆã€‚", romaji: "Moshi tenshoku kangaeteru nara, itsudemo soudan ni noru yo.", vi: "Náº¿u cáº­u Ä‘ang tÃ­nh chuyá»ƒn viá»‡c thÃ¬ cá»© nÃ³i vá»›i tá»› nhÃ©." },
                            { speaker: "Suzuki", jp: "ã‚ã‚ŠãŒã¨ã†ã€‚å¿ƒå¼·[ã“ã“ã‚ã¥ã‚ˆ]ã„ã‚ˆã€‚", romaji: "Arigatou. Kokorozuyoi yo.", vi: "Cáº£m Æ¡n nhÃ©. Vá»¯ng tÃ¢m hÆ¡n háº³n." }
                        ]
                    }
                }
            },
            reading: {
                id: 'reading',
                title: "ä»Šæ—¥ã®èª­ã¿ç‰© (BÃ i Ä‘á»c ngáº¯n)",
                content: {
                    jp: "éƒ½ä¼š[ã¨ã‹ã„]ã§ã®ç”Ÿæ´»[ã›ã„ã‹ã¤]ã¯ã€ä¾¿åˆ©[ã¹ã‚“ã‚Š]ãªåé¢[ã¯ã‚“ã‚ã‚“]ã€ã‚¹ãƒˆãƒ¬ã‚¹ã‚‚å¤š[ãŠãŠ]ã„ã§ã™ã€‚äºº[ã²ã¨]ã¨ã®ç«¶äº‰[ãã‚‡ã†ãã†]ãŒæ¿€[ã¯ã’]ã—ã„ä¸€æ–¹[ã„ã£ã½ã†]ã§ã€æ–°[ã‚ãŸã‚‰]ã—ã„ãƒãƒ£ãƒ³ã‚¹ã‚‚ãŸãã•ã‚“ã‚ã‚Šã¾ã™ã€‚ç”°èˆ[ã„ãªã‹]ã®é™[ã—ãš]ã‹ãªç”Ÿæ´»[ã›ã„ã‹ã¤]ã«å¯¾[ãŸã„]ã—ã¦ã€éƒ½ä¼š[ã¨ã‹ã„]ã¯ã„ã¤ã‚‚è³‘[ã«ã]ã‚„ã‹ã§ã™ã€‚ã‚‚ã—éƒ½ä¼š[ã¨ã‹ã„]ã§ç–²[ã¤ã‹]ã‚ŒãŸã®ãªã‚‰ã€é€±æœ«[ã—ã‚…ã†ã¾ã¤]ã«ç”°èˆ[ã„ãªã‹]ã¸è¡Œ[ã„]ã£ã¦ã¿ãŸã‚‰ã©ã†ã§ã—ã‚‡ã†ã‹ã€‚è‡ªç„¶[ã—ãœã‚“]ã¯è±Š[ã‚†ãŸ]ã‹ãªã®ã ã‹ã‚‰ã€ãã£ã¨ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã§ãã¾ã™ã‚ˆã€‚",
                    romaji: "Tokai de no seikatsu wa, benri na hanmen, sutoresu mo ooi desu. Hito to no kyousou ga hageshii ippou de, atarashii chansu mo takusan arimasu. Inaka no shizuka na seikatsu ni taishite, tokai wa itsumo nigiyaka desu. Moshi tokai de tsukareta no nara, shuumatsu ni inaka e itte mitara dou deshou ka. Shizen wa yutaka na no dakara, kitto ripuresshu dekimasu yo.",
                    vi: "Cuá»™c sá»‘ng á»Ÿ thÃ nh thá»‹, tiá»‡n lá»£i nhÆ°ng máº·t khÃ¡c cÅ©ng ráº¥t nhiá»u cÄƒng tháº³ng. Má»™t máº·t cáº¡nh tranh vá»›i ngÆ°á»i khÃ¡c ráº¥t gay gáº¯t, máº·t khÃ¡c cÅ©ng cÃ³ ráº¥t nhiá»u cÆ¡ há»™i má»›i. TrÃ¡i ngÆ°á»£c vá»›i cuá»™c sá»‘ng yÃªn tÄ©nh á»Ÿ nÃ´ng thÃ´n, thÃ nh thá»‹ lÃºc nÃ o cÅ©ng nhá»™n nhá»‹p. Náº¿u báº¡n Ä‘Ã£ má»‡t má»i vá»›i thÃ nh thá»‹, sao khÃ´ng thá»­ vá» quÃª vÃ o cuá»‘i tuáº§n xem sao? VÃ¬ thiÃªn nhiÃªn ráº¥t phong phÃº, cháº¯c cháº¯n báº¡n sáº½ cÃ³ thá»ƒ lÃ m má»›i láº¡i báº£n thÃ¢n Ä‘Ã³."
                }
            },
            grammar: {
                id: 'grammar',
                title: "ä»Šæ—¥ã®æ–‡æ³• (Tá»•ng há»£p ngá»¯ phÃ¡p)",
                points: [
                    { rule: "ï½ã®ã ã‹ã‚‰", meaning: "Bá»Ÿi vÃ¬... (lÃ½ do, biá»‡n báº¡ch)", formula: "Thá»ƒ thÃ´ng thÆ°á»ng + ã®ã ã‹ã‚‰", example: "ãã‚“ãªã«é£Ÿ[ãŸ]ã¹ãŸã„ã®ãªã‚‰ã€é£Ÿ[ãŸ]ã¹ãŸã‚‰ã©ã†ã§ã™ã‹ã€‚", example_vi: "Náº¿u mÃ  muá»‘n Äƒn Ä‘áº¿n tháº¿ thÃ¬ sao khÃ´ng Äƒn thá»­ Ä‘i?" },
                    { rule: "ï½ã«å¯¾ã—ã¦", meaning: "Äá»‘i vá»›i / TrÃ¡i ngÆ°á»£c vá»›i", formula: "N / Thá»ƒ thÃ´ng thÆ°á»ng + ã® + ã«å¯¾ã—ã¦", example: "çˆ¶[ã¡ã¡]ãŒèƒŒ[ã›]ãŒé«˜[ãŸã‹]ã„ã®ã«å¯¾[ãŸã„]ã—ã¦ã€æ¯[ã¯ã¯]ã¯èƒŒ[ã›]ãŒä½[ã²ã]ã„ã§ã™ã€‚", example_vi: "TrÃ¡i vá»›i bá»‘ tÃ´i cao, máº¹ tÃ´i láº¡i tháº¥p." },
                    { rule: "ï½åé¢", meaning: "Máº·t khÃ¡c, ngÆ°á»£c láº¡i", formula: "Thá»ƒ thÃ´ng thÆ°á»ng + åé¢", example: "ã“ã®è–¬[ãã™ã‚Š]ã¯ã‚ˆãåŠ¹[ã]ãåé¢[ã¯ã‚“ã‚ã‚“]ã€å‰¯ä½œç”¨[ãµãã•ã‚ˆã†]ãŒã‚ã‚Šã¾ã™ã€‚", example_vi: "Thuá»‘c nÃ y tÃ¡c dá»¥ng tá»‘t nhÆ°ng máº·t khÃ¡c láº¡i cÃ³ tÃ¡c dá»¥ng phá»¥." },
                    { rule: "ï½ä¸€æ–¹ï¼ˆã§ï¼‰", meaning: "Má»™t máº·t thÃ¬..., máº·t khÃ¡c thÃ¬...", formula: "Thá»ƒ thÃ´ng thÆ°á»ng + ä¸€æ–¹ï¼ˆã§ï¼‰", example: "ä¼šè­°[ã‹ã„ã]ã§ã¯è‡ªåˆ†[ã˜ã¶ã‚“]ã®æ„è¦‹[ã„ã‘ã‚“]ã‚’è¨€[ã„]ã†ä¸€æ–¹[ã„ã£ã½ã†]ã§ã€äºº[ã²ã¨]ã®è©±[ã¯ãªã—]ã‚‚ã‚ˆãè[ã]ãã¾ã™ã€‚", example_vi: "Trong cuá»™c há»p, má»™t máº·t tÃ´i nÃ³i Ã½ kiáº¿n cá»§a mÃ¬nh, máº·t khÃ¡c tÃ´i cÅ©ng láº¯ng nghe cÃ¢u chuyá»‡n cá»§a ngÆ°á»i khÃ¡c." },
                    { rule: "ï½ãªã‚‰", meaning: "Náº¿u lÃ ... (Ä‘Æ°a ra lá»i khuyÃªn, Ä‘á» nghá»‹)", formula: "Thá»ƒ thÃ´ng thÆ°á»ng + ãªã‚‰", example: "æ—¥æœ¬[ã«ã»ã‚“]ã¸è¡Œ[ã„]ããªã‚‰ã€äº¬éƒ½[ãã‚‡ã†ã¨]ãŒãŠã™ã™ã‚ã§ã™ã‚ˆã€‚", example_vi: "Náº¿u Ä‘i Nháº­t thÃ¬ tÃ´i gá»£i Ã½ báº¡n nÃªn Ä‘áº¿n Kyoto." },
                    { rule: "ï½ãŸã‚‰ã©ã†ã‹", meaning: "Thá»­... xem sao?", formula: "VãŸã‚‰ + ã©ã†ã‹", example: "ç–²[ã¤ã‹]ã‚Œã¦ã„ã‚‹ãªã‚‰ã€å°‘[ã™ã“]ã—ä¼‘[ã‚„ã™]ã‚“ã ã‚‰ã©ã†ã§ã™ã‹ã€‚", example_vi: "Náº¿u má»‡t thÃ¬ sao khÃ´ng nghá»‰ ngÆ¡i má»™t chÃºt?" }
                ]
            },
            quiz: {
                id: 'quiz',
                title: "ç·´ç¿’ã¨ãƒ†ã‚¹ãƒˆ (Luyá»‡n táº­p & Kiá»ƒm tra)",
                questions: [
                    { type: "mcq", question: "å½¼[ã‹ã‚Œ]ã¯è¦ªåˆ‡[ã—ã‚“ã›ã¤]ãªï¼ˆ___ï¼‰ã€æ™‚ã€…[ã¨ãã©ã]å³[ãã³]ã—ã„ã§ã™ã€‚", options: ["ã®ã ã‹ã‚‰", "ã«å¯¾ã—ã¦", "åé¢"], answer: "åé¢" },
                    { type: "fill", question: "é›¨[ã‚ã‚]ãŒé™[ãµ]ã£ã¦ã„ã‚‹ï¼ˆ___ï¼‰ã€å‚˜[ã‹ã•]ã‚’æŒ[ã‚‚]ã£ã¦è¡Œ[ã„]ããªã•ã„ã€‚", answer: "ã®ã ã‹ã‚‰" },
                    { type: "mcq", question: "æ—¥æœ¬èª[ã«ã»ã‚“ã”]ãŒä¸Šæ‰‹[ã˜ã‚‡ã†ãš]ã«ãªã‚ŠãŸã„ï¼ˆ___ï¼‰ã€æ¯æ—¥[ã¾ã„ã«ã¡]å‹‰å¼·[ã¹ã‚“ãã‚‡ã†]ã—ãŸã‚‰ã©ã†ã§ã™ã‹ã€‚", options: ["ãªã‚‰", "åé¢", "ä¸€æ–¹"], answer: "ãªã‚‰" },
                    { type: "audio", jp: "ã“ã®è–¬ã¯ã‚ˆãåŠ¹ãåé¢ã€å‰¯ä½œç”¨ãŒã‚ã‚‹ã€‚", question: "Nghe vÃ  gÃµ láº¡i cÃ¢u báº¡n vá»«a nghe:" }
                ]
            }
        };

        // --- STATE MANAGEMENT & SETTINGS ---
        let settings = {
            hideFurigana: false,
            showRomaji: false,
            showVietnamese: false
        };

        let progress = {
            conversation: false,
            reading: false,
            grammar: false,
            quiz: false
        };

        function saveSettings() {
            localStorage.setItem('jpAppSettings_day27', JSON.stringify(settings));
        }

        function loadSettings() {
            const saved = localStorage.getItem('jpAppSettings_day27');
            if (saved) {
                settings = JSON.parse(saved);
            }
        }

        function applySettings() {
            // Buttons
            updateToggleButtonUI('toggle-furigana', !settings.hideFurigana, 'áº¨n Furigana', 'Hiá»‡n Furigana');
            updateToggleButtonUI('toggle-romaji', settings.showRomaji, 'áº¨n Romaji', 'Hiá»‡n Romaji');
            updateToggleButtonUI('toggle-vietnamese', settings.showVietnamese, 'áº¨n Tiáº¿ng Viá»‡t', 'Hiá»‡n Tiáº¿ng Viá»‡t');
            
            // Content
            document.getElementById('app').classList.toggle('hide-furigana', settings.hideFurigana);
            document.querySelectorAll('.romaji-text').forEach(el => el.classList.toggle('hidden', !settings.showRomaji));
            document.querySelectorAll('.vi-text').forEach(el => el.classList.toggle('hidden', !settings.showVietnamese));
        }

        function updateToggleButtonUI(buttonId, isActive, activeText, inactiveText) {
            const button = document.getElementById(buttonId);
            button.textContent = isActive ? activeText : inactiveText;
            button.classList.toggle('bg-sky-500', isActive);
            button.classList.toggle('text-white', isActive);
            button.classList.toggle('bg-gray-200', !isActive);
            button.classList.toggle('text-gray-700', !isActive);
        }

        // --- PROGRESS ---
        function updateProgress(sectionId) {
            if (progress.hasOwnProperty(sectionId) && !progress[sectionId]) {
                progress[sectionId] = true;
                updateProgressBar();
            }
        }

        function updateProgressBar() {
            const completed = Object.values(progress).filter(Boolean).length;
            const total = Object.keys(progress).length;
            const percentage = (completed / total) * 100;
            const bar = document.getElementById('lesson-progress-bar');
            bar.style.width = `${percentage}%`;
            bar.textContent = `${Math.round(percentage)}%`;
        }


        // --- UTILITY FUNCTIONS ---
        function parseFurigana(text) {
            return text.replace(/([^\[\]]+)\[(.+?)\]/g, '<ruby>$1<rt>$2</rt></ruby>');
        }

        function speak(text) {
            speechSynthesis.cancel(); // Stop any previous speech
            const cleanText = text.replace(/\[.*?\]/g, '');
            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = 'ja-JP';
            utterance.rate = 0.9;
            speechSynthesis.speak(utterance);
        }

        // --- RENDER FUNCTIONS ---
        function renderConversation() {
            const section = document.getElementById('conversation-section');
            const data = day27Data.conversation;
            section.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h2 class="text-2xl font-bold mb-1 jp-font">${data.title}</h2>
                    <p class="text-gray-500 mb-4">${data.context}</p>
                    <div class="flex items-center justify-center space-x-2 mb-6 p-1 bg-gray-100 rounded-full">
                        <button id="convo-mode-polite" class="convo-mode-btn flex-1 py-2 px-4 rounded-full bg-sky-600 text-white shadow">Thá»ƒ lá»‹ch sá»±</button>
                        <button id="convo-mode-casual" class="convo-mode-btn flex-1 py-2 px-4 rounded-full">Thá»ƒ thÃ´ng thÆ°á»ng</button>
                    </div>
                    <div id="conversation-content" class="space-y-4 content-fade"></div>
                </div>
            `;
            renderDialogue('polite');
            updateProgress(data.id);
        }
        
        function renderDialogue(mode) {
            const container = document.getElementById('conversation-content');
            const dialogue = day27Data.conversation.modes[mode].dialogue;

            container.innerHTML = dialogue.map((line) => `
                <div class="dialogue-line p-4 rounded-lg bg-gray-50 border">
                    <div class="flex items-start space-x-3">
                        <div class="w-10 h-10 rounded-full ${line.speaker === 'Tanaka' ? 'bg-sky-100' : 'bg-emerald-100'} flex items-center justify-center font-bold text-sky-800">${line.speaker.charAt(0)}</div>
                        <div class="flex-1">
                            <p class="font-bold text-gray-800">${line.speaker}</p>
                            <p class="jp-font text-lg mt-1 leading-relaxed">${parseFurigana(line.jp)}</p>
                            <p class="romaji-text text-sm text-gray-500 mt-1">${line.romaji}</p>
                            <p class="vi-text text-sm text-emerald-700 mt-1">${line.vi}</p>
                            <div class="mt-3 flex items-center space-x-3">
                                <button class="speak-btn" data-text="${line.jp}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                                </button>
                                <div class="w-full">
                                    <input type="text" class="typing-input w-full p-2 border rounded-md bg-white text-base" data-correct="${line.jp.replace(/\[.*?\]/g, '')}" placeholder="Luyá»‡n gÃµ á»Ÿ Ä‘Ã¢y...">
                                    <div class="typing-feedback text-xs mt-1 h-4"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            attachEventListenersToRenderedContent(container);
            applySettings();
        }

        function renderReading() {
            const section = document.getElementById('reading-section');
            const data = day27Data.reading;
            section.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h2 class="text-2xl font-bold mb-2 jp-font">${data.title}</h2>
                    <div class="reading-content p-4 rounded-lg bg-gray-50 border">
                        <p class="jp-font text-lg leading-relaxed">${parseFurigana(data.content.jp)}</p>
                        <p class="romaji-text text-sm text-gray-500 mt-2">${data.content.romaji}</p>
                        <p class="vi-text text-sm text-emerald-700 mt-2">${data.content.vi}</p>
                        <div class="mt-4 flex items-center space-x-3">
                             <button class="speak-btn" data-text="${data.content.jp}">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                             </button>
                             <div class="w-full">
                                 <input type="text" class="typing-input w-full p-2 border rounded-md bg-white text-base" data-correct="${data.content.jp.replace(/\[.*?\]/g, '')}" placeholder="Luyá»‡n gÃµ á»Ÿ Ä‘Ã¢y...">
                                 <div class="typing-feedback text-xs mt-1 h-4"></div>
                             </div>
                        </div>
                    </div>
                </div>
            `;
            attachEventListenersToRenderedContent(section);
            updateProgress(data.id);
        }

        function renderGrammar() {
            const section = document.getElementById('grammar-section');
            const data = day27Data.grammar;
            section.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h2 class="text-2xl font-bold mb-4 jp-font">${data.title}</h2>
                    <div class="space-y-3">
                        ${data.points.map((point) => `
                            <div class="grammar-point border border-gray-200 rounded-lg overflow-hidden">
                                <button class="grammar-toggle w-full flex justify-between items-center p-4 bg-gray-50 hover:bg-gray-100">
                                    <span class="font-bold text-sky-800 jp-font text-lg">${point.rule}</span>
                                    <svg class="w-5 h-5 transform transition-transform" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </button>
                                <div class="grammar-details max-h-0 overflow-hidden transition-height">
                                    <div class="p-4 border-t border-gray-200">
                                        <p><strong>Ã nghÄ©a:</strong> ${point.meaning}</p>
                                        <p><strong>CÃ´ng thá»©c:</strong> <code class="bg-gray-200 text-red-600 px-1 rounded">${point.formula}</code></p>
                                        <div class="mt-2 p-3 bg-sky-50 rounded-md">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <p class="jp-font">${parseFurigana(point.example)}</p>
                                                    <p class="vi-text text-sm text-emerald-700 mt-1">${point.example_vi}</p>
                                                </div>
                                                <button class="speak-btn" data-text="${point.example}">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            attachEventListenersToRenderedContent(section);
            updateProgress(data.id);
        }

        function renderQuiz() {
            const section = document.getElementById('quiz-section');
            const data = day27Data.quiz;
            section.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h2 class="text-2xl font-bold mb-4 jp-font">${data.title}</h2>
                    <div id="quiz-content" class="space-y-6">
                        ${data.questions.map((q, index) => {
                            if (q.type === 'mcq') {
                                return `
                                    <div class="quiz-question" data-answer="${q.answer}">
                                        <p class="mb-2 jp-font">${index + 1}. ${parseFurigana(q.question)}</p>
                                        <div class="flex flex-col space-y-2">
                                            ${q.options.map(opt => `<button class="mcq-option text-left p-3 border rounded-lg hover:bg-gray-100">${opt}</button>`).join('')}
                                        </div>
                                        <div class="feedback mt-2 text-sm h-5"></div>
                                    </div>
                                `;
                            }
                            if (q.type === 'fill') {
                                return `
                                    <div class="quiz-question" data-answer="${q.answer}">
                                        <p class="mb-2 jp-font">${index + 1}. ${parseFurigana(q.question)}</p>
                                        <input type="text" class="fill-input w-full p-2 border rounded-md">
                                        <div class="feedback mt-2 text-sm h-5"></div>
                                    </div>
                                `;
                            }
                            if (q.type === 'audio') {
                                return `
                                    <div class="quiz-question" data-answer="${q.jp.replace(/\[.*?\]/g, '')}">
                                        <p class="mb-2 jp-font">${index + 1}. ${q.question}</p>
                                        <button class="speak-btn mb-2 flex items-center" data-text="${q.jp}">
                                           <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-sky-600"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                                           <span class="ml-2">Nghe</span>
                                        </button>
                                        <input type="text" class="fill-input w-full p-2 border rounded-md">
                                        <div class="feedback mt-2 text-sm h-5"></div>
                                    </div>
                                `;
                            }
                        }).join('')}
                    </div>
                    <button id="check-quiz-btn" class="mt-6 w-full bg-emerald-600 text-white font-bold py-3 rounded-lg hover:bg-emerald-700 transition-colors">Kiá»ƒm tra Ä‘Ã¡p Ã¡n</button>
                    <div id="quiz-result" class="mt-4 text-center font-bold"></div>
                </div>
            `;
            attachEventListenersToRenderedContent(section);
        }

        // --- EVENT LISTENERS ---
        function attachEventListenersToRenderedContent(container) {
            container.querySelectorAll('.speak-btn').forEach(btn => {
                btn.onclick = () => speak(btn.dataset.text);
            });

            container.querySelectorAll('.typing-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const correctText = e.target.dataset.correct;
                    const userText = e.target.value;
                    const feedbackContainer = e.target.nextElementSibling;
                    let styledText = '';
                    for (let i = 0; i < userText.length; i++) {
                        styledText += `<span class="${userText[i] === correctText[i] ? 'correct-char' : 'incorrect-char'}">${userText[i]}</span>`;
                    }
                    feedbackContainer.innerHTML = styledText;
                    if (userText === correctText) {
                        feedbackContainer.innerHTML = '<span class="text-green-600 font-bold">ChÃ­nh xÃ¡c! ğŸ‰</span>';
                    }
                });
            });
            
            container.querySelectorAll('.grammar-toggle').forEach(button => {
                button.addEventListener('click', () => {
                    const details = button.nextElementSibling;
                    const icon = button.querySelector('svg');
                    if (details.style.maxHeight && details.style.maxHeight !== '0px') {
                        details.style.maxHeight = '0px';
                        icon.style.transform = 'rotate(0deg)';
                    } else {
                        details.style.maxHeight = details.scrollHeight + 'px';
                        icon.style.transform = 'rotate(180deg)';
                    }
                });
            });
        }

        function setupGlobalEventListeners() {
            document.getElementById('toggle-furigana').addEventListener('click', () => {
                settings.hideFurigana = !settings.hideFurigana;
                saveSettings();
                applySettings();
            });
            document.getElementById('toggle-romaji').addEventListener('click', () => {
                settings.showRomaji = !settings.showRomaji;
                saveSettings();
                applySettings();
            });
            document.getElementById('toggle-vietnamese').addEventListener('click', () => {
                settings.showVietnamese = !settings.showVietnamese;
                saveSettings();
                applySettings();
            });

            document.getElementById('convo-mode-polite').addEventListener('click', (e) => {
                const container = document.getElementById('conversation-content');
                container.classList.add('fading-out');
                setTimeout(() => {
                    renderDialogue('polite');
                    container.classList.remove('fading-out');
                    e.target.classList.add('bg-sky-600', 'text-white', 'shadow');
                    document.getElementById('convo-mode-casual').classList.remove('bg-sky-600', 'text-white', 'shadow');
                }, 300);
            });
            document.getElementById('convo-mode-casual').addEventListener('click', (e) => {
                const container = document.getElementById('conversation-content');
                container.classList.add('fading-out');
                setTimeout(() => {
                    renderDialogue('casual');
                    container.classList.remove('fading-out');
                    e.target.classList.add('bg-sky-600', 'text-white', 'shadow');
                    document.getElementById('convo-mode-polite').classList.remove('bg-sky-600', 'text-white', 'shadow');
                }, 300);
            });
            
            document.getElementById('check-quiz-btn').addEventListener('click', () => {
                const questions = document.querySelectorAll('.quiz-question');
                let score = 0;
                questions.forEach(q => {
                    const answer = q.dataset.answer;
                    const feedback = q.querySelector('.feedback');
                    let isCorrect = false;

                    const selectedOption = q.querySelector('.mcq-option.bg-sky-200');
                    if (selectedOption) {
                        isCorrect = selectedOption.textContent === answer;
                        selectedOption.classList.add(isCorrect ? 'border-green-500' : 'border-red-500');
                    }
                    
                    const input = q.querySelector('.fill-input');
                    if (input) {
                        isCorrect = input.value.trim() === answer;
                        input.classList.add(isCorrect ? 'border-green-500' : 'border-red-500');
                    }

                    if (isCorrect) {
                        score++;
                        feedback.innerHTML = `<span class="feedback-icon feedback-correct">âœ”ï¸</span><span class="text-green-600 font-bold">ÄÃºng!</span>`;
                    } else {
                        feedback.innerHTML = `<span class="feedback-icon feedback-incorrect">âŒ</span><span class="text-red-600 font-bold">Sai! ÄÃ¡p Ã¡n Ä‘Ãºng lÃ : ${answer}</span>`;
                    }
                });
                
                document.getElementById('quiz-result').innerHTML = `Báº¡n Ä‘Ã£ tráº£ lá»i Ä‘Ãºng ${score}/${questions.length} cÃ¢u!`;
                updateProgress(day27Data.quiz.id);
            });
            
            document.querySelectorAll('.mcq-option').forEach(opt => {
                opt.addEventListener('click', () => {
                    opt.parentElement.querySelectorAll('.mcq-option').forEach(sibling => {
                        sibling.classList.remove('bg-sky-200', 'border-sky-500');
                    });
                    opt.classList.add('bg-sky-200', 'border-sky-500');
                });
            });
        }
        
        // --- INITIALIZATION ---
        function init() {
            document.getElementById('main-title').textContent = day27Data.title;
            loadSettings();
            renderConversation();
            renderReading();
            renderGrammar();
            renderQuiz();
            setupGlobalEventListeners();
            applySettings();
            updateProgressBar();
        }

        window.onload = init;
    </script>
</body>
</html><!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Há»c Tiáº¿ng Nháº­t SiÃªu Tá»‘c - NgÃ y 27</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .jp-font {
            font-family: 'Noto Sans JP', sans-serif;
        }
        ruby rt {
            font-size: 0.7em;
            font-weight: 500;
            user-select: none;
        }
        .hide-furigana ruby rt {
            visibility: hidden;
        }
        .transition-height {
            transition: max-height 0.5s ease-in-out;
        }
        .correct-char { color: #16a34a; }
        .incorrect-char { color: #dc2626; text-decoration: underline; }
        
        /* --- NEW STYLES FOR UPGRADES --- */
        /* Progress Bar */
        .progress-bar-container {
            background-color: #e5e7eb; /* gray-200 */
            border-radius: 9999px;
            overflow: hidden;
        }
        .progress-bar {
            background-color: #22c55e; /* green-500 */
            transition: width 0.5s ease-in-out;
        }
        /* Fade transition for conversation */
        .content-fade {
            transition: opacity 0.3s ease-in-out;
        }
        .fading-out {
            opacity: 0;
        }
        /* Quiz feedback icons */
        .feedback-icon {
            display: inline-block;
            margin-right: 0.5rem;
            font-weight: bold;
        }
        .feedback-correct { color: #16a34a; }
        .feedback-incorrect { color: #dc2626; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-sky-700 jp-font" id="main-title"></h1>
            <p class="text-gray-500 mt-2">BÃ i há»c Ã´n táº­p vá» lÃ½ do, tÆ°Æ¡ng pháº£n vÃ  Ä‘á» xuáº¥t.</p>
        </header>

        <!-- Progress Bar Section -->
        <div class="mb-8">
            <h3 class="font-bold text-center mb-2">Tiáº¿n Ä‘á»™ bÃ i há»c</h3>
            <div class="progress-bar-container w-full h-4">
                <div id="lesson-progress-bar" class="progress-bar h-full text-xs text-white text-center" style="width: 0%;"></div>
            </div>
        </div>

        <main class="space-y-8">
            <!-- Settings Panel -->
            <div class="bg-white p-4 rounded-xl shadow-md border border-gray-200">
                <h3 class="font-bold text-lg mb-3 text-gray-700">Báº£ng Ä‘iá»u khiá»ƒn</h3>
                <div class="flex flex-wrap gap-4">
                    <button id="toggle-furigana" class="toggle-btn">Báº­t Furigana</button>
                    <button id="toggle-romaji" class="toggle-btn">Hiá»‡n Romaji</button>
                    <button id="toggle-vietnamese" class="toggle-btn">Hiá»‡n Tiáº¿ng Viá»‡t</button>
                </div>
            </div>

            <!-- Conversation Section -->
            <section id="conversation-section" class="lesson-section"></section>

            <!-- Reading Section -->
            <section id="reading-section" class="lesson-section"></section>

            <!-- Grammar Section -->
            <section id="grammar-section" class="lesson-section"></section>
            
            <!-- Quiz Section -->
            <section id="quiz-section" class="lesson-section"></section>
        </main>

        <footer class="text-center mt-12 text-gray-400 text-sm">
            <p>Copyright by AzaCan, 2025</p>
        </footer>
    </div>

    <script>
        // --- DATA FOR DAY 27 ---
        const day27Data = {
            title: "NgÃ y 27: Ã”n táº­p LÃ½ do vÃ  TÆ°Æ¡ng pháº£n",
            conversation: {
                id: 'conversation',
                title: "ä»Šæ—¥ã®ä¼šè©± (Há»™i thoáº¡i trong ngÃ y)",
                context: "Bá»‘i cáº£nh: Tanaka vÃ  Suzuki nÃ³i vá» cÃ´ng viá»‡c.",
                modes: {
                    polite: {
                        name: "Thá»ƒ lá»‹ch sá»± (ä¸å¯§å½¢)",
                        dialogue: [
                            { speaker: "Tanaka", jp: "éˆ´æœ¨[ã™ãšã]ã•ã‚“ã€æœ€è¿‘[ã•ã„ãã‚“]ãŠç–²[ã¤ã‹]ã‚Œã®ã‚ˆã†ã§ã™ã­ã€‚é¡”è‰²[ã‹ãŠã„ã‚]ãŒæ‚ª[ã‚ã‚‹]ã„ã§ã™ã‚ˆã€‚", romaji: "Suzuki-san, saikin o-tsukare no you desu ne. Kaoiro ga warui desu yo.", vi: "Anh Suzuki, dáº¡o nÃ y cÃ³ váº» anh má»‡t má»i nhá»‰. Sáº¯c máº·t anh khÃ´ng tá»‘t Ä‘Ã¢u." },
                            { speaker: "Suzuki", jp: "ãˆãˆã€‚ä»•äº‹[ã—ã”ã¨]ãŒå¿™[ã„ããŒ]ã—ã„åé¢[ã¯ã‚“ã‚ã‚“]ã€çµ¦æ–™[ãã‚…ã†ã‚Šã‚‡ã†]ãŒä¸Š[ã‚]ãŒã‚‰ãªã„ã®ã§ã€ã¡ã‚‡ã£ã¨ä¸æº€[ãµã¾ã‚“]ãªã‚“ã§ã™ã€‚", romaji: "Ee. Shigoto ga isogashii hanmen, kyuuryou ga agaranai node, chotto fuman nan desu.", vi: "VÃ¢ng. CÃ´ng viá»‡c báº­n rá»™n nhÆ°ng máº·t khÃ¡c lÆ°Æ¡ng láº¡i khÃ´ng tÄƒng nÃªn tÃ´i hÆ¡i báº¥t mÃ£n má»™t chÃºt." },
                            { speaker: "Tanaka", jp: "ãã‚Œã¯å¤§å¤‰[ãŸã„ã¸ã‚“]ã§ã™ã­ã€‚ã§ã‚‚ã€ã‚„ã‚ŠãŒã„ãŒã‚ã‚‹ä»•äº‹[ã—ã”ã¨]ãªã®ã ã‹ã‚‰ã€ã‚‚ã†å°‘ã—é ‘å¼µ[ãŒã‚“ã°]ã£ãŸã‚‰ã©ã†ã§ã™ã‹ã€‚", romaji: "Sore wa taihen desu ne. Demo, yarigai ga aru shigoto na no dakara, mou sukoshi ganbattara dou desu ka.", vi: "Tháº¿ thÃ¬ váº¥t váº£ nhá»‰. NhÆ°ng vÃ¬ Ä‘Ã¢y lÃ  má»™t cÃ´ng viá»‡c Ä‘Ã¡ng lÃ m, sao anh khÃ´ng thá»­ cá»‘ gáº¯ng thÃªm má»™t chÃºt ná»¯a?" },
                            { speaker: "Suzuki", jp: "ãã†ã§ã™ã­ã€‚ã“ã®ä¼šç¤¾[ã‹ã„ã—ã‚ƒ]ã¯å®‰å®š[ã‚ã‚“ã¦ã„]ã—ã¦ã„ã‚‹ä¸€æ–¹[ã„ã£ã½ã†]ã§ã€å¤‰åŒ–[ã¸ã‚“ã‹]ãŒå°‘[ã™ã]ãªã„ã§ã™ã€‚å…„[ã‚ã«]ã®ä¼šç¤¾[ã‹ã„ã—ã‚ƒ]ã¯æŒ‘æˆ¦çš„[ã¡ã‚‡ã†ã›ã‚“ã¦ã]ãªã®ã«å¯¾[ãŸã„]ã—ã¦ã€ã†ã¡ã®ä¼šç¤¾[ã‹ã„ã—ã‚ƒ]ã¯ä¿å®ˆçš„[ã»ã—ã‚…ã¦ã]ã§ã™ã€‚", romaji: "Sou desu ne. Kono kaisha wa antei shite iru ippou de, henka ga sukunai desu. Ani no kaisha wa chousenteki na no ni taishite, uchi no kaisha wa hoshuteki desu.", vi: "ÄÃºng váº­y nhá»‰. CÃ´ng ty nÃ y á»•n Ä‘á»‹nh nhÆ°ng Ä‘á»“ng thá»i láº¡i cÃ³ Ã­t sá»± thay Ä‘á»•i. TrÃ¡i ngÆ°á»£c vá»›i cÃ´ng ty cá»§a anh trai tÃ´i ráº¥t cÃ³ tÃ­nh thá»­ thÃ¡ch, cÃ´ng ty cá»§a tÃ´i láº¡i khÃ¡ báº£o thá»§." },
                            { speaker: "Tanaka", jp: "ã‚‚ã—è»¢è·[ã¦ã‚“ã—ã‚‡ã]ã‚’è€ƒ[ã‹ã‚“ãŒ]ãˆã¦ã„ã‚‹ã®ãªã‚‰ã€ä¸€åº¦[ã„ã¡ã©]ç›¸è«‡[ãã†ã ã‚“]ã«ä¹—[ã®]ã‚Šã¾ã™ã‚ˆã€‚", romaji: "Moshi tenshoku o kangaete iru no nara, ichido soudan ni norimasu yo.", vi: "Náº¿u anh Ä‘ang suy nghÄ© vá» viá»‡c chuyá»ƒn viá»‡c thÃ¬ tÃ´i sáº½ cho anh lá»i khuyÃªn." },
                            { speaker: "Suzuki", jp: "ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚å¿ƒå¼·[ã“ã“ã‚ã¥ã‚ˆ]ã„ã§ã™ã€‚", romaji: "Arigatou gozaimasu. Kokorozuyoi desu.", vi: "Cáº£m Æ¡n anh. TÃ´i cáº£m tháº¥y vá»¯ng tÃ¢m hÆ¡n nhiá»u." }
                        ]
                    },
                    casual: {
                        name: "Thá»ƒ thÃ´ng thÆ°á»ng (æ™®é€šå½¢)",
                        dialogue: [
                            { speaker: "Tanaka", jp: "éˆ´æœ¨[ã™ãšã]ãã‚“ã€æœ€è¿‘[ã•ã„ãã‚“]ç–²[ã¤ã‹]ã‚Œã¦ã‚‹ã¿ãŸã„ã ã­ã€‚é¡”è‰²[ã‹ãŠã„ã‚]ã€æ‚ª[ã‚ã‚‹]ã„ã‚ˆã€‚", romaji: "Suzuki-kun, saikin tsukareteru mitai da ne. Kaoiro, warui yo.", vi: "Suzuki, dáº¡o nÃ y trÃ´ng cáº­u má»‡t má»i tháº¿. Sáº¯c máº·t kÃ©m láº¯m." },
                            { speaker: "Suzuki", jp: "ã†ã‚“ã€‚ä»•äº‹[ã—ã”ã¨]ãŒå¿™[ã„ããŒ]ã—ã„åé¢[ã¯ã‚“ã‚ã‚“]ã€çµ¦æ–™[ãã‚…ã†ã‚Šã‚‡ã†]ãŒä¸Š[ã‚]ãŒã‚‰ãªã„ã‹ã‚‰ã€ã¡ã‚‡ã£ã¨ä¸æº€[ãµã¾ã‚“]ãªã‚“ã ã€‚", romaji: "Un. Shigoto ga isogashii hanmen, kyuuryou ga agaranai kara, chotto fuman nanda.", vi: "á»ª. CÃ´ng viá»‡c thÃ¬ báº­n mÃ  lÆ°Æ¡ng cháº³ng tÄƒng, nÃªn tá»› hÆ¡i báº¥t mÃ£n." },
                            { speaker: "Tanaka", jp: "å¤§å¤‰[ãŸã„ã¸ã‚“]ã ã­ã€‚ã§ã‚‚ã€ã‚„ã‚ŠãŒã„ãŒã‚ã‚‹ä»•äº‹[ã—ã”ã¨]ãªã‚“ã ã‹ã‚‰ã€ã‚‚ã†ã¡ã‚‡ã£ã¨é ‘å¼µ[ãŒã‚“ã°]ã£ãŸã‚‰ã©ã†ï¼Ÿ", romaji: "Taihen da ne. Demo, yarigai ga aru shigoto nanda kara, mou chotto ganbattara dou?", vi: "Váº¥t váº£ nhá»‰. NhÆ°ng mÃ  viá»‡c nÃ y cÅ©ng Ä‘Ã¡ng lÃ m mÃ , sao khÃ´ng cá»‘ thÃªm chÃºt ná»¯a?" },
                            { speaker: "Suzuki", jp: "ãã†ã ã­ã€‚ã“ã®ä¼šç¤¾[ã‹ã„ã—ã‚ƒ]ã€å®‰å®š[ã‚ã‚“ã¦ã„]ã—ã¦ã‚‹ä¸€æ–¹[ã„ã£ã½ã†]ã§ã€å¤‰åŒ–[ã¸ã‚“ã‹]ãŒå°‘[ã™ã]ãªã„ã‚“ã ã€‚å…„è²´[ã‚ã«ã]ã®ä¼šç¤¾[ã‹ã„ã—ã‚ƒ]ã¯æŒ‘æˆ¦çš„[ã¡ã‚‡ã†ã›ã‚“ã¦ã]ãªã®ã«å¯¾[ãŸã„]ã—ã¦ã€ã†ã¡ã®ã¯ä¿å®ˆçš„[ã»ã—ã‚…ã¦ã]ã ã‚ˆã€‚", romaji: "Sou da ne. Kono kaisha, antei shiteru ippou de, henka ga sukunain da. Aniki no kaisha wa chousenteki na no ni taishite, uchi no wa hoshuteki da yo.", vi: "CÅ©ng Ä‘Ãºng. CÃ´ng ty nÃ y á»•n Ä‘á»‹nh nhÆ°ng mÃ  Ã­t thay Ä‘á»•i láº¯m. CÃ´ng ty anh trai tá»› thÃ¬ Ä‘áº§y thá»­ thÃ¡ch, trÃ¡i láº¡i cÃ´ng ty mÃ¬nh thÃ¬ báº£o thá»§." },
                            { speaker: "Tanaka", jp: "ã‚‚ã—è»¢è·[ã¦ã‚“ã—ã‚‡ã]è€ƒ[ã‹ã‚“ãŒ]ãˆã¦ã‚‹ãªã‚‰ã€ã„ã¤ã§ã‚‚ç›¸è«‡[ãã†ã ã‚“]ã«ä¹—[ã®]ã‚‹ã‚ˆã€‚", romaji: "Moshi tenshoku kangaeteru nara, itsudemo soudan ni noru yo.", vi: "Náº¿u cáº­u Ä‘ang tÃ­nh chuyá»ƒn viá»‡c thÃ¬ cá»© nÃ³i vá»›i tá»› nhÃ©." },
                            { speaker: "Suzuki", jp: "ã‚ã‚ŠãŒã¨ã†ã€‚å¿ƒå¼·[ã“ã“ã‚ã¥ã‚ˆ]ã„ã‚ˆã€‚", romaji: "Arigatou. Kokorozuyoi yo.", vi: "Cáº£m Æ¡n nhÃ©. Vá»¯ng tÃ¢m hÆ¡n háº³n." }
                        ]
                    }
                }
            },
            reading: {
                id: 'reading',
                title: "ä»Šæ—¥ã®èª­ã¿ç‰© (BÃ i Ä‘á»c ngáº¯n)",
                content: {
                    jp: "éƒ½ä¼š[ã¨ã‹ã„]ã§ã®ç”Ÿæ´»[ã›ã„ã‹ã¤]ã¯ã€ä¾¿åˆ©[ã¹ã‚“ã‚Š]ãªåé¢[ã¯ã‚“ã‚ã‚“]ã€ã‚¹ãƒˆãƒ¬ã‚¹ã‚‚å¤š[ãŠãŠ]ã„ã§ã™ã€‚äºº[ã²ã¨]ã¨ã®ç«¶äº‰[ãã‚‡ã†ãã†]ãŒæ¿€[ã¯ã’]ã—ã„ä¸€æ–¹[ã„ã£ã½ã†]ã§ã€æ–°[ã‚ãŸã‚‰]ã—ã„ãƒãƒ£ãƒ³ã‚¹ã‚‚ãŸãã•ã‚“ã‚ã‚Šã¾ã™ã€‚ç”°èˆ[ã„ãªã‹]ã®é™[ã—ãš]ã‹ãªç”Ÿæ´»[ã›ã„ã‹ã¤]ã«å¯¾[ãŸã„]ã—ã¦ã€éƒ½ä¼š[ã¨ã‹ã„]ã¯ã„ã¤ã‚‚è³‘[ã«ã]ã‚„ã‹ã§ã™ã€‚ã‚‚ã—éƒ½ä¼š[ã¨ã‹ã„]ã§ç–²[ã¤ã‹]ã‚ŒãŸã®ãªã‚‰ã€é€±æœ«[ã—ã‚…ã†ã¾ã¤]ã«ç”°èˆ[ã„ãªã‹]ã¸è¡Œ[ã„]ã£ã¦ã¿ãŸã‚‰ã©ã†ã§ã—ã‚‡ã†ã‹ã€‚è‡ªç„¶[ã—ãœã‚“]ã¯è±Š[ã‚†ãŸ]ã‹ãªã®ã ã‹ã‚‰ã€ãã£ã¨ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã§ãã¾ã™ã‚ˆã€‚",
                    romaji: "Tokai de no seikatsu wa, benri na hanmen, sutoresu mo ooi desu. Hito to no kyousou ga hageshii ippou de, atarashii chansu mo takusan arimasu. Inaka no shizuka na seikatsu ni taishite, tokai wa itsumo nigiyaka desu. Moshi tokai de tsukareta no nara, shuumatsu ni inaka e itte mitara dou deshou ka. Shizen wa yutaka na no dakara, kitto ripuresshu dekimasu yo.",
                    vi: "Cuá»™c sá»‘ng á»Ÿ thÃ nh thá»‹, tiá»‡n lá»£i nhÆ°ng máº·t khÃ¡c cÅ©ng ráº¥t nhiá»u cÄƒng tháº³ng. Má»™t máº·t cáº¡nh tranh vá»›i ngÆ°á»i khÃ¡c ráº¥t gay gáº¯t, máº·t khÃ¡c cÅ©ng cÃ³ ráº¥t nhiá»u cÆ¡ há»™i má»›i. TrÃ¡i ngÆ°á»£c vá»›i cuá»™c sá»‘ng yÃªn tÄ©nh á»Ÿ nÃ´ng thÃ´n, thÃ nh thá»‹ lÃºc nÃ o cÅ©ng nhá»™n nhá»‹p. Náº¿u báº¡n Ä‘Ã£ má»‡t má»i vá»›i thÃ nh thá»‹, sao khÃ´ng thá»­ vá» quÃª vÃ o cuá»‘i tuáº§n xem sao? VÃ¬ thiÃªn nhiÃªn ráº¥t phong phÃº, cháº¯c cháº¯n báº¡n sáº½ cÃ³ thá»ƒ lÃ m má»›i láº¡i báº£n thÃ¢n Ä‘Ã³."
                }
            },
            grammar: {
                id: 'grammar',
                title: "ä»Šæ—¥ã®æ–‡æ³• (Tá»•ng há»£p ngá»¯ phÃ¡p)",
                points: [
                    { rule: "ï½ã®ã ã‹ã‚‰", meaning: "Bá»Ÿi vÃ¬... (lÃ½ do, biá»‡n báº¡ch)", formula: "Thá»ƒ thÃ´ng thÆ°á»ng + ã®ã ã‹ã‚‰", example: "ãã‚“ãªã«é£Ÿ[ãŸ]ã¹ãŸã„ã®ãªã‚‰ã€é£Ÿ[ãŸ]ã¹ãŸã‚‰ã©ã†ã§ã™ã‹ã€‚", example_vi: "Náº¿u mÃ  muá»‘n Äƒn Ä‘áº¿n tháº¿ thÃ¬ sao khÃ´ng Äƒn thá»­ Ä‘i?" },
                    { rule: "ï½ã«å¯¾ã—ã¦", meaning: "Äá»‘i vá»›i / TrÃ¡i ngÆ°á»£c vá»›i", formula: "N / Thá»ƒ thÃ´ng thÆ°á»ng + ã® + ã«å¯¾ã—ã¦", example: "çˆ¶[ã¡ã¡]ãŒèƒŒ[ã›]ãŒé«˜[ãŸã‹]ã„ã®ã«å¯¾[ãŸã„]ã—ã¦ã€æ¯[ã¯ã¯]ã¯èƒŒ[ã›]ãŒä½[ã²ã]ã„ã§ã™ã€‚", example_vi: "TrÃ¡i vá»›i bá»‘ tÃ´i cao, máº¹ tÃ´i láº¡i tháº¥p." },
                    { rule: "ï½åé¢", meaning: "Máº·t khÃ¡c, ngÆ°á»£c láº¡i", formula: "Thá»ƒ thÃ´ng thÆ°á»ng + åé¢", example: "ã“ã®è–¬[ãã™ã‚Š]ã¯ã‚ˆãåŠ¹[ã]ãåé¢[ã¯ã‚“ã‚ã‚“]ã€å‰¯ä½œç”¨[ãµãã•ã‚ˆã†]ãŒã‚ã‚Šã¾ã™ã€‚", example_vi: "Thuá»‘c nÃ y tÃ¡c dá»¥ng tá»‘t nhÆ°ng máº·t khÃ¡c láº¡i cÃ³ tÃ¡c dá»¥ng phá»¥." },
                    { rule: "ï½ä¸€æ–¹ï¼ˆã§ï¼‰", meaning: "Má»™t máº·t thÃ¬..., máº·t khÃ¡c thÃ¬...", formula: "Thá»ƒ thÃ´ng thÆ°á»ng + ä¸€æ–¹ï¼ˆã§ï¼‰", example: "ä¼šè­°[ã‹ã„ã]ã§ã¯è‡ªåˆ†[ã˜ã¶ã‚“]ã®æ„è¦‹[ã„ã‘ã‚“]ã‚’è¨€[ã„]ã†ä¸€æ–¹[ã„ã£ã½ã†]ã§ã€äºº[ã²ã¨]ã®è©±[ã¯ãªã—]ã‚‚ã‚ˆãè[ã]ãã¾ã™ã€‚", example_vi: "Trong cuá»™c há»p, má»™t máº·t tÃ´i nÃ³i Ã½ kiáº¿n cá»§a mÃ¬nh, máº·t khÃ¡c tÃ´i cÅ©ng láº¯ng nghe cÃ¢u chuyá»‡n cá»§a ngÆ°á»i khÃ¡c." },
                    { rule: "ï½ãªã‚‰", meaning: "Náº¿u lÃ ... (Ä‘Æ°a ra lá»i khuyÃªn, Ä‘á» nghá»‹)", formula: "Thá»ƒ thÃ´ng thÆ°á»ng + ãªã‚‰", example: "æ—¥æœ¬[ã«ã»ã‚“]ã¸è¡Œ[ã„]ããªã‚‰ã€äº¬éƒ½[ãã‚‡ã†ã¨]ãŒãŠã™ã™ã‚ã§ã™ã‚ˆã€‚", example_vi: "Náº¿u Ä‘i Nháº­t thÃ¬ tÃ´i gá»£i Ã½ báº¡n nÃªn Ä‘áº¿n Kyoto." },
                    { rule: "ï½ãŸã‚‰ã©ã†ã‹", meaning: "Thá»­... xem sao?", formula: "VãŸã‚‰ + ã©ã†ã‹", example: "ç–²[ã¤ã‹]ã‚Œã¦ã„ã‚‹ãªã‚‰ã€å°‘[ã™ã“]ã—ä¼‘[ã‚„ã™]ã‚“ã ã‚‰ã©ã†ã§ã™ã‹ã€‚", example_vi: "Náº¿u má»‡t thÃ¬ sao khÃ´ng nghá»‰ ngÆ¡i má»™t chÃºt?" }
                ]
            },
            quiz: {
                id: 'quiz',
                title: "ç·´ç¿’ã¨ãƒ†ã‚¹ãƒˆ (Luyá»‡n táº­p & Kiá»ƒm tra)",
                questions: [
                    { type: "mcq", question: "å½¼[ã‹ã‚Œ]ã¯è¦ªåˆ‡[ã—ã‚“ã›ã¤]ãªï¼ˆ___ï¼‰ã€æ™‚ã€…[ã¨ãã©ã]å³[ãã³]ã—ã„ã§ã™ã€‚", options: ["ã®ã ã‹ã‚‰", "ã«å¯¾ã—ã¦", "åé¢"], answer: "åé¢" },
                    { type: "fill", question: "é›¨[ã‚ã‚]ãŒé™[ãµ]ã£ã¦ã„ã‚‹ï¼ˆ___ï¼‰ã€å‚˜[ã‹ã•]ã‚’æŒ[ã‚‚]ã£ã¦è¡Œ[ã„]ããªã•ã„ã€‚", answer: "ã®ã ã‹ã‚‰" },
                    { type: "mcq", question: "æ—¥æœ¬èª[ã«ã»ã‚“ã”]ãŒä¸Šæ‰‹[ã˜ã‚‡ã†ãš]ã«ãªã‚ŠãŸã„ï¼ˆ___ï¼‰ã€æ¯æ—¥[ã¾ã„ã«ã¡]å‹‰å¼·[ã¹ã‚“ãã‚‡ã†]ã—ãŸã‚‰ã©ã†ã§ã™ã‹ã€‚", options: ["ãªã‚‰", "åé¢", "ä¸€æ–¹"], answer: "ãªã‚‰" },
                    { type: "audio", jp: "ã“ã®è–¬ã¯ã‚ˆãåŠ¹ãåé¢ã€å‰¯ä½œç”¨ãŒã‚ã‚‹ã€‚", question: "Nghe vÃ  gÃµ láº¡i cÃ¢u báº¡n vá»«a nghe:" }
                ]
            }
        };

        // --- STATE MANAGEMENT & SETTINGS ---
        let settings = {
            hideFurigana: false,
            showRomaji: false,
            showVietnamese: false
        };

        let progress = {
            conversation: false,
            reading: false,
            grammar: false,
            quiz: false
        };

        function saveSettings() {
            localStorage.setItem('jpAppSettings_day27', JSON.stringify(settings));
        }

        function loadSettings() {
            const saved = localStorage.getItem('jpAppSettings_day27');
            if (saved) {
                settings = JSON.parse(saved);
            }
        }

        function applySettings() {
            // Buttons
            updateToggleButtonUI('toggle-furigana', !settings.hideFurigana, 'áº¨n Furigana', 'Hiá»‡n Furigana');
            updateToggleButtonUI('toggle-romaji', settings.showRomaji, 'áº¨n Romaji', 'Hiá»‡n Romaji');
            updateToggleButtonUI('toggle-vietnamese', settings.showVietnamese, 'áº¨n Tiáº¿ng Viá»‡t', 'Hiá»‡n Tiáº¿ng Viá»‡t');
            
            // Content
            document.getElementById('app').classList.toggle('hide-furigana', settings.hideFurigana);
            document.querySelectorAll('.romaji-text').forEach(el => el.classList.toggle('hidden', !settings.showRomaji));
            document.querySelectorAll('.vi-text').forEach(el => el.classList.toggle('hidden', !settings.showVietnamese));
        }

        function updateToggleButtonUI(buttonId, isActive, activeText, inactiveText) {
            const button = document.getElementById(buttonId);
            button.textContent = isActive ? activeText : inactiveText;
            button.classList.toggle('bg-sky-500', isActive);
            button.classList.toggle('text-white', isActive);
            button.classList.toggle('bg-gray-200', !isActive);
            button.classList.toggle('text-gray-700', !isActive);
        }

        // --- PROGRESS ---
        function updateProgress(sectionId) {
            if (progress.hasOwnProperty(sectionId) && !progress[sectionId]) {
                progress[sectionId] = true;
                updateProgressBar();
            }
        }

        function updateProgressBar() {
            const completed = Object.values(progress).filter(Boolean).length;
            const total = Object.keys(progress).length;
            const percentage = (completed / total) * 100;
            const bar = document.getElementById('lesson-progress-bar');
            bar.style.width = `${percentage}%`;
            bar.textContent = `${Math.round(percentage)}%`;
        }


        // --- UTILITY FUNCTIONS ---
        function parseFurigana(text) {
            return text.replace(/([^\[\]]+)\[(.+?)\]/g, '<ruby>$1<rt>$2</rt></ruby>');
        }

        function speak(text) {
            speechSynthesis.cancel(); // Stop any previous speech
            const cleanText = text.replace(/\[.*?\]/g, '');
            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = 'ja-JP';
            utterance.rate = 0.9;
            speechSynthesis.speak(utterance);
        }

        // --- RENDER FUNCTIONS ---
        function renderConversation() {
            const section = document.getElementById('conversation-section');
            const data = day27Data.conversation;
            section.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h2 class="text-2xl font-bold mb-1 jp-font">${data.title}</h2>
                    <p class="text-gray-500 mb-4">${data.context}</p>
                    <div class="flex items-center justify-center space-x-2 mb-6 p-1 bg-gray-100 rounded-full">
                        <button id="convo-mode-polite" class="convo-mode-btn flex-1 py-2 px-4 rounded-full bg-sky-600 text-white shadow">Thá»ƒ lá»‹ch sá»±</button>
                        <button id="convo-mode-casual" class="convo-mode-btn flex-1 py-2 px-4 rounded-full">Thá»ƒ thÃ´ng thÆ°á»ng</button>
                    </div>
                    <div id="conversation-content" class="space-y-4 content-fade"></div>
                </div>
            `;
            renderDialogue('polite');
            updateProgress(data.id);
        }
        
        function renderDialogue(mode) {
            const container = document.getElementById('conversation-content');
            const dialogue = day27Data.conversation.modes[mode].dialogue;

            container.innerHTML = dialogue.map((line) => `
                <div class="dialogue-line p-4 rounded-lg bg-gray-50 border">
                    <div class="flex items-start space-x-3">
                        <div class="w-10 h-10 rounded-full ${line.speaker === 'Tanaka' ? 'bg-sky-100' : 'bg-emerald-100'} flex items-center justify-center font-bold text-sky-800">${line.speaker.charAt(0)}</div>
                        <div class="flex-1">
                            <p class="font-bold text-gray-800">${line.speaker}</p>
                            <p class="jp-font text-lg mt-1 leading-relaxed">${parseFurigana(line.jp)}</p>
                            <p class="romaji-text text-sm text-gray-500 mt-1">${line.romaji}</p>
                            <p class="vi-text text-sm text-emerald-700 mt-1">${line.vi}</p>
                            <div class="mt-3 flex items-center space-x-3">
                                <button class="speak-btn" data-text="${line.jp}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                                </button>
                                <div class="w-full">
                                    <input type="text" class="typing-input w-full p-2 border rounded-md bg-white text-base" data-correct="${line.jp.replace(/\[.*?\]/g, '')}" placeholder="Luyá»‡n gÃµ á»Ÿ Ä‘Ã¢y...">
                                    <div class="typing-feedback text-xs mt-1 h-4"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            attachEventListenersToRenderedContent(container);
            applySettings();
        }

        function renderReading() {
            const section = document.getElementById('reading-section');
            const data = day27Data.reading;
            section.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h2 class="text-2xl font-bold mb-2 jp-font">${data.title}</h2>
                    <div class="reading-content p-4 rounded-lg bg-gray-50 border">
                        <p class="jp-font text-lg leading-relaxed">${parseFurigana(data.content.jp)}</p>
                        <p class="romaji-text text-sm text-gray-500 mt-2">${data.content.romaji}</p>
                        <p class="vi-text text-sm text-emerald-700 mt-2">${data.content.vi}</p>
                        <div class="mt-4 flex items-center space-x-3">
                             <button class="speak-btn" data-text="${data.content.jp}">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                             </button>
                             <div class="w-full">
                                 <input type="text" class="typing-input w-full p-2 border rounded-md bg-white text-base" data-correct="${data.content.jp.replace(/\[.*?\]/g, '')}" placeholder="Luyá»‡n gÃµ á»Ÿ Ä‘Ã¢y...">
                                 <div class="typing-feedback text-xs mt-1 h-4"></div>
                             </div>
                        </div>
                    </div>
                </div>
            `;
            attachEventListenersToRenderedContent(section);
            updateProgress(data.id);
        }

        function renderGrammar() {
            const section = document.getElementById('grammar-section');
            const data = day27Data.grammar;
            section.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h2 class="text-2xl font-bold mb-4 jp-font">${data.title}</h2>
                    <div class="space-y-3">
                        ${data.points.map((point) => `
                            <div class="grammar-point border border-gray-200 rounded-lg overflow-hidden">
                                <button class="grammar-toggle w-full flex justify-between items-center p-4 bg-gray-50 hover:bg-gray-100">
                                    <span class="font-bold text-sky-800 jp-font text-lg">${point.rule}</span>
                                    <svg class="w-5 h-5 transform transition-transform" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </button>
                                <div class="grammar-details max-h-0 overflow-hidden transition-height">
                                    <div class="p-4 border-t border-gray-200">
                                        <p><strong>Ã nghÄ©a:</strong> ${point.meaning}</p>
                                        <p><strong>CÃ´ng thá»©c:</strong> <code class="bg-gray-200 text-red-600 px-1 rounded">${point.formula}</code></p>
                                        <div class="mt-2 p-3 bg-sky-50 rounded-md">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <p class="jp-font">${parseFurigana(point.example)}</p>
                                                    <p class="vi-text text-sm text-emerald-700 mt-1">${point.example_vi}</p>
                                                </div>
                                                <button class="speak-btn" data-text="${point.example}">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            attachEventListenersToRenderedContent(section);
            updateProgress(data.id);
        }

        function renderQuiz() {
            const section = document.getElementById('quiz-section');
            const data = day27Data.quiz;
            section.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h2 class="text-2xl font-bold mb-4 jp-font">${data.title}</h2>
                    <div id="quiz-content" class="space-y-6">
                        ${data.questions.map((q, index) => {
                            if (q.type === 'mcq') {
                                return `
                                    <div class="quiz-question" data-answer="${q.answer}">
                                        <p class="mb-2 jp-font">${index + 1}. ${parseFurigana(q.question)}</p>
                                        <div class="flex flex-col space-y-2">
                                            ${q.options.map(opt => `<button class="mcq-option text-left p-3 border rounded-lg hover:bg-gray-100">${opt}</button>`).join('')}
                                        </div>
                                        <div class="feedback mt-2 text-sm h-5"></div>
                                    </div>
                                `;
                            }
                            if (q.type === 'fill') {
                                return `
                                    <div class="quiz-question" data-answer="${q.answer}">
                                        <p class="mb-2 jp-font">${index + 1}. ${parseFurigana(q.question)}</p>
                                        <input type="text" class="fill-input w-full p-2 border rounded-md">
                                        <div class="feedback mt-2 text-sm h-5"></div>
                                    </div>
                                `;
                            }
                            if (q.type === 'audio') {
                                return `
                                    <div class="quiz-question" data-answer="${q.jp.replace(/\[.*?\]/g, '')}">
                                        <p class="mb-2 jp-font">${index + 1}. ${q.question}</p>
                                        <button class="speak-btn mb-2 flex items-center" data-text="${q.jp}">
                                           <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-sky-600"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                                           <span class="ml-2">Nghe</span>
                                        </button>
                                        <input type="text" class="fill-input w-full p-2 border rounded-md">
                                        <div class="feedback mt-2 text-sm h-5"></div>
                                    </div>
                                `;
                            }
                        }).join('')}
                    </div>
                    <button id="check-quiz-btn" class="mt-6 w-full bg-emerald-600 text-white font-bold py-3 rounded-lg hover:bg-emerald-700 transition-colors">Kiá»ƒm tra Ä‘Ã¡p Ã¡n</button>
                    <div id="quiz-result" class="mt-4 text-center font-bold"></div>
                </div>
            `;
            attachEventListenersToRenderedContent(section);
        }

        // --- EVENT LISTENERS ---
        function attachEventListenersToRenderedContent(container) {
            container.querySelectorAll('.speak-btn').forEach(btn => {
                btn.onclick = () => speak(btn.dataset.text);
            });

            container.querySelectorAll('.typing-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const correctText = e.target.dataset.correct;
                    const userText = e.target.value;
                    const feedbackContainer = e.target.nextElementSibling;
                    let styledText = '';
                    for (let i = 0; i < userText.length; i++) {
                        styledText += `<span class="${userText[i] === correctText[i] ? 'correct-char' : 'incorrect-char'}">${userText[i]}</span>`;
                    }
                    feedbackContainer.innerHTML = styledText;
                    if (userText === correctText) {
                        feedbackContainer.innerHTML = '<span class="text-green-600 font-bold">ChÃ­nh xÃ¡c! ğŸ‰</span>';
                    }
                });
            });
            
            container.querySelectorAll('.grammar-toggle').forEach(button => {
                button.addEventListener('click', () => {
                    const details = button.nextElementSibling;
                    const icon = button.querySelector('svg');
                    if (details.style.maxHeight && details.style.maxHeight !== '0px') {
                        details.style.maxHeight = '0px';
                        icon.style.transform = 'rotate(0deg)';
                    } else {
                        details.style.maxHeight = details.scrollHeight + 'px';
                        icon.style.transform = 'rotate(180deg)';
                    }
                });
            });
        }

        function setupGlobalEventListeners() {
            document.getElementById('toggle-furigana').addEventListener('click', () => {
                settings.hideFurigana = !settings.hideFurigana;
                saveSettings();
                applySettings();
            });
            document.getElementById('toggle-romaji').addEventListener('click', () => {
                settings.showRomaji = !settings.showRomaji;
                saveSettings();
                applySettings();
            });
            document.getElementById('toggle-vietnamese').addEventListener('click', () => {
                settings.showVietnamese = !settings.showVietnamese;
                saveSettings();
                applySettings();
            });

            document.getElementById('convo-mode-polite').addEventListener('click', (e) => {
                const container = document.getElementById('conversation-content');
                container.classList.add('fading-out');
                setTimeout(() => {
                    renderDialogue('polite');
                    container.classList.remove('fading-out');
                    e.target.classList.add('bg-sky-600', 'text-white', 'shadow');
                    document.getElementById('convo-mode-casual').classList.remove('bg-sky-600', 'text-white', 'shadow');
                }, 300);
            });
            document.getElementById('convo-mode-casual').addEventListener('click', (e) => {
                const container = document.getElementById('conversation-content');
                container.classList.add('fading-out');
                setTimeout(() => {
                    renderDialogue('casual');
                    container.classList.remove('fading-out');
                    e.target.classList.add('bg-sky-600', 'text-white', 'shadow');
                    document.getElementById('convo-mode-polite').classList.remove('bg-sky-600', 'text-white', 'shadow');
                }, 300);
            });
            
            document.getElementById('check-quiz-btn').addEventListener('click', () => {
                const questions = document.querySelectorAll('.quiz-question');
                let score = 0;
                questions.forEach(q => {
                    const answer = q.dataset.answer;
                    const feedback = q.querySelector('.feedback');
                    let isCorrect = false;

                    const selectedOption = q.querySelector('.mcq-option.bg-sky-200');
                    if (selectedOption) {
                        isCorrect = selectedOption.textContent === answer;
                        selectedOption.classList.add(isCorrect ? 'border-green-500' : 'border-red-500');
                    }
                    
                    const input = q.querySelector('.fill-input');
                    if (input) {
                        isCorrect = input.value.trim() === answer;
                        input.classList.add(isCorrect ? 'border-green-500' : 'border-red-500');
                    }

                    if (isCorrect) {
                        score++;
                        feedback.innerHTML = `<span class="feedback-icon feedback-correct">âœ”ï¸</span><span class="text-green-600 font-bold">ÄÃºng!</span>`;
                    } else {
                        feedback.innerHTML = `<span class="feedback-icon feedback-incorrect">âŒ</span><span class="text-red-600 font-bold">Sai! ÄÃ¡p Ã¡n Ä‘Ãºng lÃ : ${answer}</span>`;
                    }
                });
                
                document.getElementById('quiz-result').innerHTML = `Báº¡n Ä‘Ã£ tráº£ lá»i Ä‘Ãºng ${score}/${questions.length} cÃ¢u!`;
                updateProgress(day27Data.quiz.id);
            });
            
            document.querySelectorAll('.mcq-option').forEach(opt => {
                opt.addEventListener('click', () => {
                    opt.parentElement.querySelectorAll('.mcq-option').forEach(sibling => {
                        sibling.classList.remove('bg-sky-200', 'border-sky-500');
                    });
                    opt.classList.add('bg-sky-200', 'border-sky-500');
                });
            });
        }
        
        // --- INITIALIZATION ---
        function init() {
            document.getElementById('main-title').textContent = day27Data.title;
            loadSettings();
            renderConversation();
            renderReading();
            renderGrammar();
            renderQuiz();
            setupGlobalEventListeners();
            applySettings();
            updateProgressBar();
        }

        window.onload = init;
    </script>
</body>
</html>
