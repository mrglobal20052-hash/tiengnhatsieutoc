<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AzaKanji - Từ Điển Kanji</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #f0f9ff; overflow-x: hidden; }
        .kanji-font { font-family: 'Noto Sans JP', sans-serif; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .kanji-card { 
            background-color: white; 
            border-radius: 12px; 
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease-in-out; 
            display: flex;
            flex-direction: column;
        }
        .kanji-card:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); 
            border-color: #38bdf8;
        }

        .stroke-grid-box { border: 1px solid #e5e7eb; background-color: white; position: relative; }
        .stroke-grid-box::after { content: ''; position: absolute; top: 0; left: 50%; width: 1px; height: 100%; background: repeating-linear-gradient(to bottom, #ddd 0, #ddd 4px, transparent 4px, transparent 8px); z-index: 0; }
        .stroke-grid-box::before { content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 1px; background: repeating-linear-gradient(to right, #ddd 0, #ddd 4px, transparent 4px, transparent 8px); z-index: 0; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Header -->
    <header class="bg-sky-700 text-white shadow-lg sticky top-0 z-40">
        <div class="container mx-auto px-4 py-3">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center space-x-3 cursor-pointer" onclick="window.location.href='kanji.html'">
                    <i class="fas fa-torii-gate text-3xl text-yellow-400"></i>
                    <div>
                        <h1 class="text-xl font-bold uppercase tracking-wider leading-none">AZAKANJI</h1>
                        <p class="text-xs text-sky-200 mt-1">Từ Điển Tra Cứu</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-2 overflow-x-auto max-w-full pb-1 md:pb-0">
                    <a href="kanji.html" class="px-3 py-2 bg-sky-800 hover:bg-sky-600 rounded-md text-sm font-bold transition whitespace-nowrap">
                        <i class="fas fa-th-large mr-2"></i>Lộ Trình Học Kanji
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Search Bar -->
    <div class="bg-white/90 backdrop-blur-md shadow-sm sticky top-[64px] z-30 border-b border-sky-100">
        <div class="container mx-auto px-4 py-4">
            <div class="relative max-w-2xl mx-auto">
                <input type="text" id="local-search" placeholder="Nhập Kanji, Hán Việt, Nghĩa, hoặc Âm đọc để lọc..." class="w-full pl-12 pr-4 py-3 rounded-2xl border-2 border-sky-100 focus:outline-none focus:ring-4 focus:ring-sky-200 focus:border-sky-400 bg-sky-50/30 text-lg transition-all shadow-inner">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-sky-400 text-xl"></i>
                <div id="search-count" class="absolute right-4 top-1/2 -translate-y-1/2 text-xs text-gray-400 font-bold"></div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6 flex-grow" id="app-container">
        <div id="learn-section" class="fade-in">
            <!-- Grid Container -->
            <div id="kanji-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                <!-- Cards will be injected here -->
            </div>
            
            <!-- Empty State -->
            <div id="no-results" class="hidden text-center py-20">
                <i class="fas fa-search-minus text-6xl text-gray-200 mb-4"></i>
                <p class="text-gray-400 text-lg font-bold">Không tìm thấy kết quả phù hợp</p>
            </div>
        </div>
    </main>

    <!-- STROKE ORDER MODAL -->
    <div id="stroke-modal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-sm" onclick="closeStrokeModal()"></div>
            <div class="inline-block align-bottom bg-white rounded-xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl w-full modal-enter relative">
                <div class="bg-sky-600 px-4 py-3 flex justify-between items-center text-white">
                    <h3 class="font-bold text-lg"><i class="fas fa-pen-nib mr-2"></i>Tập Viết: <span id="stroke-modal-char" class="text-2xl ml-2 font-bold"></span></h3>
                    <button onclick="closeStrokeModal()" class="hover:text-gray-200 p-2"><i class="fas fa-times text-xl"></i></button>
                </div>
                <div class="p-4 md:p-6 bg-gray-50 max-h-[80vh] overflow-y-auto">
                    <div class="flex flex-col md:flex-row gap-6 items-center justify-center">
                        <div class="bg-white p-4 rounded-lg shadow border border-gray-200 text-center w-full md:w-auto">
                            <div id="stroke-animation-container" class="w-40 h-40 mx-auto bg-white border border-gray-300 relative stroke-grid-box flex items-center justify-center">
                                <span class="text-gray-400 text-xs">Đang tải...</span>
                            </div>
                            <button onclick="replayStrokeAnimation()" class="mt-3 text-sm bg-sky-100 text-sky-700 px-4 py-2 rounded-full hover:bg-sky-200 transition w-full font-bold flex items-center justify-center"><i class="fas fa-redo mr-2"></i> Viết lại</button>
                        </div>
                        <div class="flex-1 w-full">
                            <p class="text-xs text-gray-500 mb-3 font-bold uppercase text-center md:text-left">Thứ tự nét</p>
                            <div id="stroke-grid-container" class="flex flex-wrap gap-2 justify-center md:justify-start"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DỮ LIỆU TỪ ĐIỂN ---
        // Bạn có thể dán dữ liệu từ bất kỳ file nào (Ngày 1-24, Bộ thủ) vào đây.
        // Hệ thống sẽ tự động nhận diện các trường: h/nghiaHV, v/nghiaTV, examples/viDu...
        const kanjiDictionary = [
            // Sample
            { char: "一", nghiaHV: "NHẤT", nghiaTV: "Một", on: "イチ", kun: "ひと", ti: "Một ngón tay giơ ra.", ta: "**Y chi** (Ichi) chiếc đũa cho **Hí Tô** (Hito).", examples: [{ w: "一月", r: "いちがつ", m: "Tháng 1" }] },
            { char: "二", nghiaHV: "NHỊ", nghiaTV: "Hai", on: "ニ", kun: "ふた", ti: "Hai nét gạch ngang bằng nhau.", ta: "**Ní** (Ni) nuốt **Phù Tá** (Futa) hai lần.", examples: [{ w: "二月", r: "にがつ", m: "Tháng 2" }] },
            { char: "会", h: "HỘI", v: "Gặp gỡ", on: "カイ", kun: "あ.う", ti: "Người gặp nhau dưới mái nhà.", ta: "**Cai** thuốc để gặp.", examples: [{ w: "会話", r: "かいわ", m: "Hội thoại" }] }
            
            // ... Dán thêm dữ liệu vào đây ...
        ];

        // --- CORE FUNCTIONS ---
        let currentStrokeSvg = null;

        function speak(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text.replace(/-/g, ''));
                u.lang = 'ja-JP'; u.rate = 0.9;
                window.speechSynthesis.speak(u);
            }
        }

        function getKanjiHex(kanji) { return kanji.charCodeAt(0).toString(16).padStart(5, '0'); }

        async function fetchKanjiSvg(hex) {
            try {
                const response = await fetch(`https://cdn.jsdelivr.net/gh/KanjiVG/kanjivg/kanji/${hex}.svg`);
                if (!response.ok) throw new Error('Not found');
                return await response.text();
            } catch (e) { return null; }
        }

        // --- RENDER (ĐÃ SỬA LỖI TƯƠNG THÍCH DỮ LIỆU) ---
        function renderDictionary(data) {
            const grid = document.getElementById('kanji-grid');
            const noResults = document.getElementById('no-results');
            const countDisplay = document.getElementById('search-count');

            if (!data || data.length === 0) {
                grid.innerHTML = '';
                noResults.classList.remove('hidden');
                countDisplay.innerText = "0 kết quả";
                return;
            }

            noResults.classList.add('hidden');
            countDisplay.innerText = `${data.length} kết quả`;

            // Giới hạn hiển thị 50 thẻ đầu tiên để tăng tốc độ nếu dữ liệu lớn
            const displayData = data.slice(0, 100); 

            grid.innerHTML = displayData.map((k) => {
                // *** QUAN TRỌNG: Logic tự động nhận diện trường dữ liệu cũ/mới ***
                const hiet = k.nghiaHV || k.h || "N/A";
                const viet = k.nghiaTV || k.v || "N/A";
                
                // Chuẩn hóa ví dụ (hỗ trợ cả examples và viDu)
                let rawEx = k.examples || k.viDu || [];
                const exs = rawEx.map(e => ({
                    w: e.w || e.jp,
                    r: e.r || e.furigana,
                    m: e.m || e.vn
                }));

                // Xử lý hình ảnh và âm thanh (nếu có)
                const hinhAnh = k.ti ? k.ti.replace(/\*\*(.*?)\*\*/g, '<span class="font-bold text-gray-800">$1</span>') : 'Đang cập nhật';
                const amThanh = k.ta ? k.ta.replace(/\*\*(.*?)\*\*/g, '<span class="font-bold text-blue-800">$1</span>') : 'Đang cập nhật';

                return `
                <div class="kanji-card p-4 flex flex-col group h-full">
                    <div class="flex justify-between items-start mb-3 border-b border-gray-100 pb-2">
                        <div class="flex gap-3 items-center">
                            <div class="w-12 h-12 bg-sky-50 rounded-lg flex items-center justify-center border border-sky-200 cursor-pointer hover:bg-sky-100 transition" onclick="showStrokeOrder('${k.char}')">
                                <span class="text-3xl font-bold kanji-font text-sky-700">${k.char}</span>
                            </div>
                            <div>
                                <div class="text-red-600 font-bold text-lg leading-none">${hiet}</div>
                                <div class="text-gray-500 text-xs font-bold uppercase mt-1">${viet}</div>
                            </div>
                        </div>
                        <button onclick="showStrokeOrder('${k.char}')" class="text-gray-300 hover:text-sky-500 transition"><i class="fas fa-pen-nib"></i></button>
                    </div>
                    
                    <div class="flex-grow space-y-2">
                        <div class="grid grid-cols-2 gap-2 text-xs text-center mb-2">
                            <div class="bg-gray-50 rounded p-1.5 border border-gray-100 relative group/btn">
                                <span class="text-[9px] text-gray-400 block uppercase">On</span>
                                <span class="font-bold text-sky-800">${k.on || '-'}</span>
                                <button onclick="speak('${k.on || ''}')" class="absolute inset-0 w-full h-full opacity-0 group-hover/btn:opacity-100 bg-white/80 flex items-center justify-center text-sky-500 transition"><i class="fas fa-volume-up"></i></button>
                            </div>
                            <div class="bg-gray-50 rounded p-1.5 border border-gray-100 relative group/btn">
                                <span class="text-[9px] text-gray-400 block uppercase">Kun</span>
                                <span class="font-bold text-sky-800">${k.kun || '-'}</span>
                                <button onclick="speak('${k.kun || ''}')" class="absolute inset-0 w-full h-full opacity-0 group-hover/btn:opacity-100 bg-white/80 flex items-center justify-center text-sky-500 transition"><i class="fas fa-volume-up"></i></button>
                            </div>
                        </div>
                        
                        <div class="text-xs text-gray-600 bg-orange-50 p-2 rounded border border-orange-100">
                            <span class="font-bold text-orange-600">Hình:</span> ${hinhAnh}
                        </div>
                        <div class="text-xs text-gray-600 bg-blue-50 p-2 rounded border border-blue-100">
                            <span class="font-bold text-blue-600">Âm:</span> ${amThanh}
                        </div>

                        ${exs.length > 0 ? `
                        <div class="pt-2 border-t border-gray-100 mt-2">
                            <div class="text-[10px] text-gray-400 uppercase font-bold mb-1">Ví dụ:</div>
                            ${exs.slice(0, 2).map(ex => `
                                <div class="flex justify-between items-center text-xs text-gray-700 mb-1 cursor-pointer hover:text-sky-600" onclick="speak('${ex.w}')">
                                    <span>${ex.w} <span class="text-gray-400 text-[10px]">(${ex.r})</span></span>
                                    <span class="text-gray-500 text-[10px] truncate max-w-[80px] text-right">${ex.m}</span>
                                </div>
                            `).join('')}
                        </div>` : ''}
                    </div>
                </div>
            `}).join('');
        }

        // --- SEARCH LOGIC ---
        const searchInput = document.getElementById('local-search');
        
        searchInput.addEventListener('input', (e) => {
            const val = e.target.value.trim().toLowerCase();
            if (!val) {
                renderDictionary(kanjiDictionary);
                return;
            }
            
            const filtered = kanjiDictionary.filter(k => {
                // Kiểm tra an toàn để tránh lỗi null/undefined
                const char = k.char || "";
                const hiet = k.nghiaHV || k.h || "";
                const viet = k.nghiaTV || k.v || "";
                const on = k.on || "";
                const kun = k.kun || "";
                
                return char.toLowerCase().includes(val) || 
                       hiet.toLowerCase().includes(val) || 
                       viet.toLowerCase().includes(val) || 
                       on.toLowerCase().includes(val) || 
                       kun.toLowerCase().includes(val);
            });
            renderDictionary(filtered);
        });

        // --- STROKE ORDER ---
        async function showStrokeOrder(kanji) {
            const hex = getKanjiHex(kanji);
            document.getElementById('stroke-modal').classList.remove('hidden');
            document.getElementById('stroke-modal-char').innerText = kanji;
            const animContainer = document.getElementById('stroke-animation-container');
            const gridContainer = document.getElementById('stroke-grid-container');
            animContainer.innerHTML = '<span class="text-xs text-gray-400">Đang tải...</span>';
            
            const svgContent = await fetchKanjiSvg(hex);
            if (!svgContent) { animContainer.innerHTML = "Lỗi tải ảnh"; return; }
            
            animContainer.innerHTML = svgContent;
            const mainSvg = animContainer.querySelector('svg');
            const paths = mainSvg.querySelectorAll('path');
            paths.forEach(p => { 
                const len = p.getTotalLength(); p.style.strokeDasharray = len; p.style.strokeDashoffset = len; 
                p.style.stroke = "#333"; p.style.strokeWidth = "4"; p.style.fill = "none";
            });
            currentStrokeSvg = mainSvg; replayStrokeAnimation();
            
            gridContainer.innerHTML = `<div class="flex flex-wrap gap-2 justify-center"></div>`;
            const wrapper = gridContainer.querySelector('div');
            for(let i=0; i<paths.length; i++) {
                const box = document.createElement('div');
                box.className = "w-10 h-10 bg-white border border-gray-200 relative stroke-grid-box flex items-center justify-center";
                const parser = new DOMParser();
                const svgClone = parser.parseFromString(svgContent, "image/svg+xml").querySelector('svg');
                svgClone.setAttribute('width', '100%'); svgClone.setAttribute('height', '100%');
                svgClone.querySelectorAll('path').forEach((p, idx) => {
                    p.style.fill="none";
                    if(idx < i) { p.style.stroke="#9ca3af"; p.style.strokeWidth="2"; }
                    else if(idx === i) { p.style.stroke="#000"; p.style.strokeWidth="4"; }
                    else p.style.display="none";
                });
                box.appendChild(svgClone); wrapper.appendChild(box);
            }
        }

        function replayStrokeAnimation() {
            if(!currentStrokeSvg) return;
            const paths = currentStrokeSvg.querySelectorAll('path');
            paths.forEach(p => { p.style.transition = 'none'; p.style.strokeDashoffset = p.getTotalLength(); });
            void currentStrokeSvg.offsetWidth;
            let delay = 0;
            paths.forEach(p => { p.style.transition = `stroke-dashoffset 0.6s ease-in-out ${delay}s`; p.style.strokeDashoffset = '0'; delay += 0.6; });
        }
        
        function closeStrokeModal() { document.getElementById('stroke-modal').classList.add('hidden'); }

        // --- INIT ---
        window.onload = () => {
            renderDictionary(kanjiDictionary);
        };
    </script>
</body>
</html>
