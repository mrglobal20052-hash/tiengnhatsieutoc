<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Học Tiếng Nhật Siêu Tốc - Ngày 28</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .jp-font {
            font-family: 'Noto Sans JP', sans-serif;
        }
        ruby rt {
            font-size: 0.7em;
            font-weight: 500;
            user-select: none;
        }
        .hide-furigana ruby rt {
            visibility: hidden;
        }
        .transition-height {
            transition: max-height 0.5s ease-in-out;
        }
        .correct-char { color: #16a34a; }
        .incorrect-char { color: #dc2626; text-decoration: underline; }
        
        /* --- NEW STYLES FOR UPGRADES --- */
        /* Progress Bar */
        .progress-bar-container {
            background-color: #e5e7eb; /* gray-200 */
            border-radius: 9999px;
            overflow: hidden;
        }
        .progress-bar {
            background-color: #22c55e; /* green-500 */
            transition: width 0.5s ease-in-out;
        }
        /* Fade transition for conversation */
        .content-fade {
            transition: opacity 0.3s ease-in-out;
        }
        .fading-out {
            opacity: 0;
        }
        /* Quiz feedback icons */
        .feedback-icon {
            display: inline-block;
            margin-right: 0.5rem;
            font-weight: bold;
        }
        .feedback-correct { color: #16a34a; }
        .feedback-incorrect { color: #dc2626; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-sky-700 jp-font" id="main-title"></h1>
            <p class="text-gray-500 mt-2">Bài học ôn tập về hành động theo mẫu và các cấu trúc so sánh.</p>
        </header>

        <!-- Progress Bar Section -->
        <div class="mb-8">
            <h3 class="font-bold text-center mb-2">Tiến độ bài học</h3>
            <div class="progress-bar-container w-full h-4">
                <div id="lesson-progress-bar" class="progress-bar h-full text-xs text-white text-center" style="width: 0%;"></div>
            </div>
        </div>

        <main class="space-y-8">
            <!-- Settings Panel -->
            <div class="bg-white p-4 rounded-xl shadow-md border border-gray-200">
                <h3 class="font-bold text-lg mb-3 text-gray-700">Bảng điều khiển</h3>
                <div class="flex flex-wrap gap-4">
                    <button id="toggle-furigana" class="toggle-btn">Bật Furigana</button>
                    <button id="toggle-romaji" class="toggle-btn">Hiện Romaji</button>
                    <button id="toggle-vietnamese" class="toggle-btn">Hiện Tiếng Việt</button>
                </div>
            </div>

            <!-- Conversation Section -->
            <section id="conversation-section" class="lesson-section"></section>

            <!-- Reading Section -->
            <section id="reading-section" class="lesson-section"></section>

            <!-- Grammar Section -->
            <section id="grammar-section" class="lesson-section"></section>
            
            <!-- Quiz Section -->
            <section id="quiz-section" class="lesson-section"></section>
        </main>

        <footer class="text-center mt-12 text-gray-400 text-sm">
            <p>Copyright by AzaCan, 2025</p>
        </footer>
    </div>

    <script>
        // --- DATA FOR DAY 28 ---
        const day28Data = {
            title: "Ngày 28: Ôn tập Theo mẫu và Tiện thể",
            conversation: {
                id: 'conversation',
                title: "今日の会話 (Hội thoại trong ngày)",
                context: "Bối cảnh: Tanaka và Suzuki nói về một trận đấu bóng đá.",
                modes: {
                    polite: {
                        name: "Thể lịch sự (丁寧形)",
                        dialogue: [
                            { speaker: "Tanaka", jp: "昨日[きのう]の試合[しあい]、見[み]ましたか。予想[よそう]どおり、Aチームが勝[か]ちましたね。", romaji: "Kinou no shiai, mimashita ka. Yosou doori, A chiimu ga kachimashita ne.", vi: "Anh có xem trận đấu hôm qua không? Đúng như dự đoán, đội A đã thắng nhỉ." },
                            { speaker: "Suzuki", jp: "ええ。応援[おうえん]に行[い]くたびに、彼[かれ]らは勝[か]つんですよ。", romaji: "Ee. Ouen ni iku tabi ni, karera wa katsun desu yo.", vi: "Vâng. Cứ mỗi lần tôi đi cổ vũ là họ lại thắng đó." },
                            { speaker: "Tanaka", jp: "すごいですね。負[ま]けるくらいなら、試合[しあい]に出[で]ないほうがいいとまで言[い]われていますからね。", romaji: "Sugoi desu ne. Makeru kurai nara, shiai ni denai hou ga ii to made iwarete imasu kara ne.", vi: "Tuyệt vời nhỉ. Vì người ta còn nói rằng nếu phải thua thì thà không tham gia trận đấu còn hơn." },
                            { speaker: "Suzuki", jp: "彼[かれ]らのプレーは、上手[じょうず]というより芸術[げいじゅつ]です。コンビニへ行[い]くついでに、来週[らいしゅう]の試合[しあい]のチケットを買[か]ってきます。", romaji: "Karera no puree wa, jouzu to iu yori geijutsu desu. Konbini e iku tsuide ni, raishuu no shiai no chiketto o katte kimasu.", vi: "Lối chơi của họ, nói là giỏi thì đúng hơn là nghệ thuật. Nhân tiện đi cửa hàng tiện lợi, tôi sẽ mua vé cho trận đấu tuần sau rồi về." },
                            { speaker: "Tanaka", jp: "ありがとうございます。彼[かれ]らぐらい強[つよ]いチームはいないでしょう。", romaji: "Arigatou gozaimasu. Karera gurai tsuyoi chiimu wa inai deshou.", vi: "Cảm ơn anh. Chắc không có đội nào mạnh hơn họ đâu nhỉ." }
                        ]
                    },
                    casual: {
                        name: "Thể thông thường (普通形)",
                        dialogue: [
                            { speaker: "Tanaka", jp: "昨日[きのう]の試合[しあい]、見[み]た？予想[よそう]どおり、Aチームが勝[か]ったね。", romaji: "Kinou no shiai, mita? Yosou doori, A chiimu ga katta ne.", vi: "Cậu xem trận hôm qua không? Đúng như dự đoán, đội A thắng rồi." },
                            { speaker: "Suzuki", jp: "うん。応援[おうえん]に行[い]くたびに、彼[かれ]ら勝[か]つんだよ。", romaji: "Un. Ouen ni iku tabi ni, karera katsun da yo.", vi: "Ừ. Cứ lần nào tớ đi cổ vũ là họ lại thắng." },
                            { speaker: "Tanaka", jp: "すごいな。負[ま]けるくらいなら、試合[しあい]に出[で]ないほうがいいって言[い]われてるもんね。", romaji: "Sugoi na. Makeru kurai nara, shiai ni denai hou ga ii tte iwareteru mon ne.", vi: "Ghê thật. Người ta còn bảo nếu mà thua thì thà không đá còn hơn mà." },
                            { speaker: "Suzuki", jp: "彼[かれ]らのプレーは、上手[じょうず]っていうより芸術[げいじゅつ]だよ。コンビニ行[い]くついでに、来週[らいしゅう]のチケット買[か]ってくる。", romaji: "Karera no puree wa, jouzu tte iu yori geijutsu da yo. Konbini iku tsuide ni, raishuu no chiketto katte kuru.", vi: "Lối chơi của họ không chỉ là giỏi mà là nghệ thuật đó. Tiện ra cửa hàng tiện lợi, tớ mua luôn vé trận tuần sau." },
                            { speaker: "Tanaka", jp: "ありがとう。彼[かれ]らぐらい強[つよ]いチームはいないでしょ。", romaji: "Arigatou. Karera gurai tsuyoi chiimu wa inai desho.", vi: "Cảm ơn nhé. Chắc chẳng có đội nào mạnh bằng họ đâu." }
                        ]
                    }
                }
            },
            reading: {
                id: 'reading',
                title: "今日の読み物 (Bài đọc ngắn)",
                content: {
                    jp: "彼[かれ]の料理[りょうり]は、レシピどおりに作[つく]られています。彼[かれ]が料理[りょうり]をするたびに、家族[かぞく]みんなが喜[よろこ]びます。まずいものを食[た]べるくらいなら、自分[じぶん]で作[つく]ったほうがいいと言[い]われています。彼[かれ]の料理[りょうり]は、おいしいというより幸[しあわ]せな気持[きも]ちにさせてくれます。買[か]い物[もの]のついでに、彼[かれ]のために新鮮[しんせん]な材料[ざいりょう]を買[か]って帰[かえ]ります。彼[かれ]ほど料理[りょうり]上手[じょうず]な人[ひと]はいないでしょう。",
                    romaji: "Kare no ryouri wa, reshipi doori ni tsukurarete imasu. Kare ga ryouri o suru tabi ni, kazoku minna ga yorokobimasu. Mazui mono o taberu kurai nara, jibun de tsukutta hou ga ii to iwarete imasu. Kare no ryouri wa, oishii to iu yori shiawase na kimochi ni sasete kuremasu. Kaimono no tsuide ni, kare no tame ni shinsen na zairyou o katte kaerimasu. Kare hodo ryouri jouzu na hito wa inai deshou.",
                    vi: "Món ăn của anh ấy được làm theo đúng công thức. Cứ mỗi lần anh ấy nấu ăn, cả gia đình lại vui mừng. Người ta nói rằng nếu phải ăn đồ dở thì thà tự mình nấu còn hơn. Món ăn của anh ấy, nói là ngon thì đúng hơn là làm cho người ta cảm thấy hạnh phúc. Nhân tiện đi mua sắm, tôi sẽ mua nguyên liệu tươi ngon về cho anh ấy. Chắc không có ai nấu ăn giỏi hơn anh ấy đâu."
                }
            },
            grammar: {
                id: 'grammar',
                title: "今日の文法 (Tổng hợp ngữ pháp)",
                points: [
                    { rule: "～とおりに / ～どおりに", meaning: "Theo đúng như...", formula: "Vる/Vた/Nの + とおりに; N + どおりに", example: "説明書[せつめいしょ]のとおりに、組[く]み立[た]てました。", example_vi: "Tôi đã lắp ráp theo đúng như sách hướng dẫn." },
                    { rule: "～くらいなら", meaning: "Nếu phải... thì thà... còn hơn", formula: "Vる + くらいなら", example: "あんな人[ひと]と友達[ともだち]になるくらいなら、一人[ひとり]のほうがいい。", example_vi: "Nếu phải làm bạn với người như thế thì thà ở một mình còn hơn." },
                    { rule: "～たびに", meaning: "Cứ mỗi lần...", formula: "Vる / Nの + たびに", example: "この写真[しゃしん]を見[み]るたびに、楽[たの]しかったことを思[おも]い出[だ]します。", example_vi: "Cứ mỗi lần nhìn bức ảnh này, tôi lại nhớ về những chuyện vui." },
                    { rule: "～ついでに", meaning: "Nhân tiện, tiện thể", formula: "Vる / Vた / Nの + ついでに", example: "散歩[さんぽ]のついでに、この手紙[てがみ]を出[だ]してきます。", example_vi: "Nhân tiện đi dạo, tôi sẽ đi gửi lá thư này." },
                    { rule: "A というより B", meaning: "Nói là B thì đúng hơn là A", formula: "A (thể thông thường) + というより + B", example: "今日[きょう]は涼[すず]しいというより寒[さむ]いくらいです。", example_vi: "Hôm nay nói là mát mẻ thì đúng hơn là lạnh." },
                    { rule: "～と言われている", meaning: "Người ta nói rằng...", formula: "Thể thông thường + と言われている", example: "この地方[ちほう]は、昔[むかし]から地震[じしん]が多[おお]いと言[い]われています。", example_vi: "Người ta nói rằng vùng này từ xưa đã có nhiều động đất." }
                ]
            },
            quiz: {
                id: 'quiz',
                title: "練習とテスト (Luyện tập & Kiểm tra)",
                questions: [
                    { type: "mcq", question: "先生[せんせい]の言[い]う（___）、勉強[べんきょう]すれば成績[せいせき]は上[あ]がります。", options: ["とおりに", "たびに", "ついでに"], answer: "とおりに" },
                    { type: "fill", question: "彼[かれ]と話[はな]す（___）、いつも喧嘩[けんか]になる。", answer: "たびに" },
                    { type: "mcq", question: "彼[かれ]はかっこいい（___）、かわいいです。", options: ["というより", "くらいなら", "ついでに"], answer: "というより" },
                    { type: "audio", jp: "気が合わない人と一緒に生活するぐらいなら、このまま独身でいたい。", question: "Nghe và gõ lại câu bạn vừa nghe:" }
                ]
            }
        };

        // --- STATE MANAGEMENT & SETTINGS ---
        let settings = {
            hideFurigana: false,
            showRomaji: false,
            showVietnamese: false
        };

        let progress = {
            conversation: false,
            reading: false,
            grammar: false,
            quiz: false
        };

        function saveSettings() {
            localStorage.setItem('jpAppSettings_day28', JSON.stringify(settings));
        }

        function loadSettings() {
            const saved = localStorage.getItem('jpAppSettings_day28');
            if (saved) {
                settings = JSON.parse(saved);
            }
        }

        function applySettings() {
            // Buttons
            updateToggleButtonUI('toggle-furigana', !settings.hideFurigana, 'Ẩn Furigana', 'Hiện Furigana');
            updateToggleButtonUI('toggle-romaji', settings.showRomaji, 'Ẩn Romaji', 'Hiện Romaji');
            updateToggleButtonUI('toggle-vietnamese', settings.showVietnamese, 'Ẩn Tiếng Việt', 'Hiện Tiếng Việt');
            
            // Content
            document.getElementById('app').classList.toggle('hide-furigana', settings.hideFurigana);
            document.querySelectorAll('.romaji-text').forEach(el => el.classList.toggle('hidden', !settings.showRomaji));
            document.querySelectorAll('.vi-text').forEach(el => el.classList.toggle('hidden', !settings.showVietnamese));
        }

        function updateToggleButtonUI(buttonId, isActive, activeText, inactiveText) {
            const button = document.getElementById(buttonId);
            button.textContent = isActive ? activeText : inactiveText;
            button.classList.toggle('bg-sky-500', isActive);
            button.classList.toggle('text-white', isActive);
            button.classList.toggle('bg-gray-200', !isActive);
            button.classList.toggle('text-gray-700', !isActive);
        }

        // --- PROGRESS ---
        function updateProgress(sectionId) {
            if (progress.hasOwnProperty(sectionId) && !progress[sectionId]) {
                progress[sectionId] = true;
                updateProgressBar();
            }
        }

        function updateProgressBar() {
            const completed = Object.values(progress).filter(Boolean).length;
            const total = Object.keys(progress).length;
            const percentage = (completed / total) * 100;
            const bar = document.getElementById('lesson-progress-bar');
            bar.style.width = `${percentage}%`;
            bar.textContent = `${Math.round(percentage)}%`;
        }


        // --- UTILITY FUNCTIONS ---
        function parseFurigana(text) {
            return text.replace(/([^\[\]]+)\[(.+?)\]/g, '<ruby>$1<rt>$2</rt></ruby>');
        }

        function speak(text) {
            speechSynthesis.cancel(); // Stop any previous speech
            const cleanText = text.replace(/\[.*?\]/g, '');
            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = 'ja-JP';
            utterance.rate = 0.9;
            speechSynthesis.speak(utterance);
        }

        // --- RENDER FUNCTIONS ---
        function renderConversation() {
            const section = document.getElementById('conversation-section');
            const data = day28Data.conversation;
            section.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h2 class="text-2xl font-bold mb-1 jp-font">${data.title}</h2>
                    <p class="text-gray-500 mb-4">${data.context}</p>
                    <div class="flex items-center justify-center space-x-2 mb-6 p-1 bg-gray-100 rounded-full">
                        <button id="convo-mode-polite" class="convo-mode-btn flex-1 py-2 px-4 rounded-full bg-sky-600 text-white shadow">Thể lịch sự</button>
                        <button id="convo-mode-casual" class="convo-mode-btn flex-1 py-2 px-4 rounded-full">Thể thông thường</button>
                    </div>
                    <div id="conversation-content" class="space-y-4 content-fade"></div>
                </div>
            `;
            renderDialogue('polite');
            updateProgress(data.id);
        }
        
        function renderDialogue(mode) {
            const container = document.getElementById('conversation-content');
            const dialogue = day28Data.conversation.modes[mode].dialogue;

            container.innerHTML = dialogue.map((line) => `
                <div class="dialogue-line p-4 rounded-lg bg-gray-50 border">
                    <div class="flex items-start space-x-3">
                        <div class="w-10 h-10 rounded-full ${line.speaker === 'Tanaka' ? 'bg-sky-100' : 'bg-emerald-100'} flex items-center justify-center font-bold text-sky-800">${line.speaker.charAt(0)}</div>
                        <div class="flex-1">
                            <p class="font-bold text-gray-800">${line.speaker}</p>
                            <p class="jp-font text-lg mt-1 leading-relaxed">${parseFurigana(line.jp)}</p>
                            <p class="romaji-text text-sm text-gray-500 mt-1">${line.romaji}</p>
                            <p class="vi-text text-sm text-emerald-700 mt-1">${line.vi}</p>
                            <div class="mt-3 flex items-center space-x-3">
                                <button class="speak-btn" data-text="${line.jp}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                                </button>
                                <div class="w-full">
                                    <input type="text" class="typing-input w-full p-2 border rounded-md bg-white text-base" data-correct="${line.jp.replace(/\[.*?\]/g, '')}" placeholder="Luyện gõ ở đây...">
                                    <div class="typing-feedback text-xs mt-1 h-4"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            attachEventListenersToRenderedContent(container);
            applySettings();
        }

        function renderReading() {
            const section = document.getElementById('reading-section');
            const data = day28Data.reading;
            section.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h2 class="text-2xl font-bold mb-2 jp-font">${data.title}</h2>
                    <div class="reading-content p-4 rounded-lg bg-gray-50 border">
                        <p class="jp-font text-lg leading-relaxed">${parseFurigana(data.content.jp)}</p>
                        <p class="romaji-text text-sm text-gray-500 mt-2">${data.content.romaji}</p>
                        <p class="vi-text text-sm text-emerald-700 mt-2">${data.content.vi}</p>
                        <div class="mt-4 flex items-center space-x-3">
                             <button class="speak-btn" data-text="${data.content.jp}">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                             </button>
                             <div class="w-full">
                                 <input type="text" class="typing-input w-full p-2 border rounded-md bg-white text-base" data-correct="${data.content.jp.replace(/\[.*?\]/g, '')}" placeholder="Luyện gõ ở đây...">
                                 <div class="typing-feedback text-xs mt-1 h-4"></div>
                             </div>
                        </div>
                    </div>
                </div>
            `;
            attachEventListenersToRenderedContent(section);
            updateProgress(data.id);
        }

        function renderGrammar() {
            const section = document.getElementById('grammar-section');
            const data = day28Data.grammar;
            section.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h2 class="text-2xl font-bold mb-4 jp-font">${data.title}</h2>
                    <div class="space-y-3">
                        ${data.points.map((point) => `
                            <div class="grammar-point border border-gray-200 rounded-lg overflow-hidden">
                                <button class="grammar-toggle w-full flex justify-between items-center p-4 bg-gray-50 hover:bg-gray-100">
                                    <span class="font-bold text-sky-800 jp-font text-lg">${point.rule}</span>
                                    <svg class="w-5 h-5 transform transition-transform" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </button>
                                <div class="grammar-details max-h-0 overflow-hidden transition-height">
                                    <div class="p-4 border-t border-gray-200">
                                        <p><strong>Ý nghĩa:</strong> ${point.meaning}</p>
                                        <p><strong>Công thức:</strong> <code class="bg-gray-200 text-red-600 px-1 rounded">${point.formula}</code></p>
                                        <div class="mt-2 p-3 bg-sky-50 rounded-md">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <p class="jp-font">${parseFurigana(point.example)}</p>
                                                    <p class="vi-text text-sm text-emerald-700 mt-1">${point.example_vi}</p>
                                                </div>
                                                <button class="speak-btn" data-text="${point.example}">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            attachEventListenersToRenderedContent(section);
            updateProgress(data.id);
        }

        function renderQuiz() {
            const section = document.getElementById('quiz-section');
            const data = day28Data.quiz;
            section.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h2 class="text-2xl font-bold mb-4 jp-font">${data.title}</h2>
                    <div id="quiz-content" class="space-y-6">
                        ${data.questions.map((q, index) => {
                            if (q.type === 'mcq') {
                                return `
                                    <div class="quiz-question" data-answer="${q.answer}">
                                        <p class="mb-2 jp-font">${index + 1}. ${parseFurigana(q.question)}</p>
                                        <div class="flex flex-col space-y-2">
                                            ${q.options.map(opt => `<button class="mcq-option text-left p-3 border rounded-lg hover:bg-gray-100">${opt}</button>`).join('')}
                                        </div>
                                        <div class="feedback mt-2 text-sm h-5"></div>
                                    </div>
                                `;
                            }
                            if (q.type === 'fill') {
                                return `
                                    <div class="quiz-question" data-answer="${q.answer}">
                                        <p class="mb-2 jp-font">${index + 1}. ${parseFurigana(q.question)}</p>
                                        <input type="text" class="fill-input w-full p-2 border rounded-md">
                                        <div class="feedback mt-2 text-sm h-5"></div>
                                    </div>
                                `;
                            }
                            if (q.type === 'audio') {
                                return `
                                    <div class="quiz-question" data-answer="${q.jp.replace(/\[.*?\]/g, '')}">
                                        <p class="mb-2 jp-font">${index + 1}. ${q.question}</p>
                                        <button class="speak-btn mb-2 flex items-center" data-text="${q.jp}">
                                           <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-sky-600"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                                           <span class="ml-2">Nghe</span>
                                        </button>
                                        <input type="text" class="fill-input w-full p-2 border rounded-md">
                                        <div class="feedback mt-2 text-sm h-5"></div>
                                    </div>
                                `;
                            }
                        }).join('')}
                    </div>
                    <button id="check-quiz-btn" class="mt-6 w-full bg-emerald-600 text-white font-bold py-3 rounded-lg hover:bg-emerald-700 transition-colors">Kiểm tra đáp án</button>
                    <div id="quiz-result" class="mt-4 text-center font-bold"></div>
                </div>
            `;
            attachEventListenersToRenderedContent(section);
        }

        // --- EVENT LISTENERS ---
        function attachEventListenersToRenderedContent(container) {
            container.querySelectorAll('.speak-btn').forEach(btn => {
                btn.onclick = () => speak(btn.dataset.text);
            });

            container.querySelectorAll('.typing-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const correctText = e.target.dataset.correct;
                    const userText = e.target.value;
                    const feedbackContainer = e.target.nextElementSibling;
                    let styledText = '';
                    for (let i = 0; i < userText.length; i++) {
                        styledText += `<span class="${userText[i] === correctText[i] ? 'correct-char' : 'incorrect-char'}">${userText[i]}</span>`;
                    }
                    feedbackContainer.innerHTML = styledText;
                    if (userText === correctText) {
                        feedbackContainer.innerHTML = '<span class="text-green-600 font-bold">Chính xác! 🎉</span>';
                    }
                });
            });
            
            container.querySelectorAll('.grammar-toggle').forEach(button => {
                button.addEventListener('click', () => {
                    const details = button.nextElementSibling;
                    const icon = button.querySelector('svg');
                    if (details.style.maxHeight && details.style.maxHeight !== '0px') {
                        details.style.maxHeight = '0px';
                        icon.style.transform = 'rotate(0deg)';
                    } else {
                        details.style.maxHeight = details.scrollHeight + 'px';
                        icon.style.transform = 'rotate(180deg)';
                    }
                });
            });
        }

        function setupGlobalEventListeners() {
            document.getElementById('toggle-furigana').addEventListener('click', () => {
                settings.hideFurigana = !settings.hideFurigana;
                saveSettings();
                applySettings();
            });
            document.getElementById('toggle-romaji').addEventListener('click', () => {
                settings.showRomaji = !settings.showRomaji;
                saveSettings();
                applySettings();
            });
            document.getElementById('toggle-vietnamese').addEventListener('click', () => {
                settings.showVietnamese = !settings.showVietnamese;
                saveSettings();
                applySettings();
            });

            document.getElementById('convo-mode-polite').addEventListener('click', (e) => {
                const container = document.getElementById('conversation-content');
                container.classList.add('fading-out');
                setTimeout(() => {
                    renderDialogue('polite');
                    container.classList.remove('fading-out');
                    e.target.classList.add('bg-sky-600', 'text-white', 'shadow');
                    document.getElementById('convo-mode-casual').classList.remove('bg-sky-600', 'text-white', 'shadow');
                }, 300);
            });
            document.getElementById('convo-mode-casual').addEventListener('click', (e) => {
                const container = document.getElementById('conversation-content');
                container.classList.add('fading-out');
                setTimeout(() => {
                    renderDialogue('casual');
                    container.classList.remove('fading-out');
                    e.target.classList.add('bg-sky-600', 'text-white', 'shadow');
                    document.getElementById('convo-mode-polite').classList.remove('bg-sky-600', 'text-white', 'shadow');
                }, 300);
            });
            
            document.getElementById('check-quiz-btn').addEventListener('click', () => {
                const questions = document.querySelectorAll('.quiz-question');
                let score = 0;
                questions.forEach(q => {
                    const answer = q.dataset.answer;
                    const feedback = q.querySelector('.feedback');
                    let isCorrect = false;

                    const selectedOption = q.querySelector('.mcq-option.bg-sky-200');
                    if (selectedOption) {
                        isCorrect = selectedOption.textContent === answer;
                        selectedOption.classList.add(isCorrect ? 'border-green-500' : 'border-red-500');
                    }
                    
                    const input = q.querySelector('.fill-input');
                    if (input) {
                        isCorrect = input.value.trim() === answer;
                        input.classList.add(isCorrect ? 'border-green-500' : 'border-red-500');
                    }

                    if (isCorrect) {
                        score++;
                        feedback.innerHTML = `<span class="feedback-icon feedback-correct">✔️</span><span class="text-green-600 font-bold">Đúng!</span>`;
                    } else {
                        feedback.innerHTML = `<span class="feedback-icon feedback-incorrect">❌</span><span class="text-red-600 font-bold">Sai! Đáp án đúng là: ${answer}</span>`;
                    }
                });
                
                document.getElementById('quiz-result').innerHTML = `Bạn đã trả lời đúng ${score}/${questions.length} câu!`;
                updateProgress(day28Data.quiz.id);
            });
            
            document.querySelectorAll('.mcq-option').forEach(opt => {
                opt.addEventListener('click', () => {
                    opt.parentElement.querySelectorAll('.mcq-option').forEach(sibling => {
                        sibling.classList.remove('bg-sky-200', 'border-sky-500');
                    });
                    opt.classList.add('bg-sky-200', 'border-sky-500');
                });
            });
        }
        
        // --- INITIALIZATION ---
        function init() {
            document.getElementById('main-title').textContent = day28Data.title;
            loadSettings();
            renderConversation();
            renderReading();
            renderGrammar();
            renderQuiz();
            setupGlobalEventListeners();
            applySettings();
            updateProgressBar();
        }

        window.onload = init;
    </script>
</body>
</html>
