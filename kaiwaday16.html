<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AzaKanji - Hội Thoại & Ngữ Pháp (Day 16)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #f3f4f6; }
        .kanji-font { font-family: 'Noto Sans JP', sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Ruby Text Styling */
        ruby rt { font-size: 0.6em; color: #64748b; user-select: none; }
        .hide-furigana ruby rt { visibility: hidden; }

        /* Animations */
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .card-transition { transition: all 0.3s ease-in-out; }
        
        /* Highlight classes for Typing */
        .correct-char { color: #16a34a; font-weight: bold; }
        .incorrect-char { color: #dc2626; text-decoration: underline; font-weight: bold; }
        .correct-input { border-color: #22c55e !important; background-color: #f0fdf4 !important; }
        .wrong-input { border-color: #ef4444 !important; background-color: #fef2f2 !important; }
        
        /* Microphone Animation */
        .mic-listening { animation: pulse-red 1.5s infinite; color: #dc2626 !important; border-color: #dc2626 !important; }
        @keyframes pulse-red { 
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); } 
            70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); } 
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } 
        }

        /* Tab Transitions */
        .tab-btn { transition: all 0.3s ease; }
        .tab-active { background-color: #0284c7; color: white; shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .tab-inactive { background-color: #f3f4f6; color: #4b5563; }
        .tab-inactive:hover { background-color: #e5e7eb; }

        /* Progress Bar */
        .progress-container { background-color: #e5e7eb; border-radius: 999px; height: 8px; width: 100%; overflow: hidden; margin-top: 10px; }
        .progress-fill { background-color: #10b981; height: 100%; width: 0%; transition: width 0.5s ease-in-out; }

        /* Active playing line */
        .playing-line { border-left: 4px solid #0ea5e9; background-color: #f0f9ff !important; }

        /* STROKE ORDER STYLES */
        .stroke-path {
            fill: none;
            stroke: #333;
            stroke-width: 3;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .stroke-grid-box {
            border: 1px solid #e5e7eb;
            background-color: white;
            position: relative;
        }
        /* Dotted lines for kanji grid */
        .stroke-grid-box::after {
            content: ''; position: absolute; top: 0; left: 50%; width: 1px; height: 100%;
            background: repeating-linear-gradient(to bottom, #ddd 0, #ddd 4px, transparent 4px, transparent 8px); z-index: 0;
        }
        .stroke-grid-box::before {
            content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 1px;
            background: repeating-linear-gradient(to right, #ddd 0, #ddd 4px, transparent 4px, transparent 8px); z-index: 0;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Header -->
    <header class="bg-sky-700 text-white shadow-lg sticky top-0 z-40">
        <div class="container mx-auto px-4 py-3">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center space-x-3 cursor-pointer" onclick="location.reload()">
                    <i class="fas fa-torii-gate text-3xl text-yellow-300"></i>
                    <div>
                        <h1 class="text-xl font-bold uppercase tracking-wider">AzaKanji Kaiwa</h1>
                        <p class="text-xs text-sky-200">Học Hội Thoại & Ngữ Pháp (Day 16)</p>
                    </div>
                </div>
                
                <!-- Controls -->
                <div class="flex items-center gap-2 overflow-x-auto pb-1 md:pb-0">
                    <div class="flex bg-sky-800 rounded-lg p-1 text-sm">
                        <button id="btn-toggle-furigana" class="px-3 py-1.5 rounded transition hover:bg-sky-600 text-white flex items-center whitespace-nowrap" title="Bật/Tắt cách đọc Kanji">
                            <i class="fas fa-eye mr-2"></i> Furi
                        </button>
                        <button id="btn-toggle-romaji" class="px-3 py-1.5 rounded transition hover:bg-sky-600 text-white flex items-center ml-1 whitespace-nowrap" title="Bật/Tắt phiên âm Romaji">
                            <i class="fas fa-font mr-2"></i> Romaji
                        </button>
                        <button id="btn-toggle-vi" class="px-3 py-1.5 rounded transition bg-white text-sky-800 font-bold ml-1 flex items-center whitespace-nowrap" title="Bật/Tắt dịch tiếng Việt">
                            <i class="fas fa-language mr-2"></i> Việt
                        </button>
                    </div>
                    
                    <!-- Audio Speed Control -->
                    <div class="flex bg-sky-800 rounded-lg p-1 text-sm items-center px-2 text-white">
                        <i class="fas fa-tachometer-alt mr-2 text-sky-300"></i>
                        <select id="audio-speed" class="bg-transparent border-none focus:ring-0 text-white font-bold cursor-pointer text-xs">
                            <option value="0.75" class="text-gray-800">0.75x</option>
                            <option value="1.0" class="text-gray-800" selected>1.0x</option>
                            <option value="1.25" class="text-gray-800">1.25x</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8 flex-grow space-y-8" id="app">
        
        <!-- Progress Section -->
        <div class="w-full max-w-4xl mx-auto mb-4 bg-white p-3 rounded-lg shadow-sm border border-gray-100">
            <div class="flex justify-between text-xs text-gray-500 mb-1 font-bold">
                <span>Tiến độ học tập</span>
                <span id="progress-text">0%</span>
            </div>
            <div class="progress-container">
                <div id="progress-bar" class="progress-fill"></div>
            </div>
        </div>

        <!-- 1. Conversation Section -->
        <section class="bg-white rounded-2xl shadow-md overflow-hidden fade-in border border-gray-100">
            <div class="bg-sky-50 px-6 py-4 border-b border-sky-100">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <h2 class="text-xl font-bold text-sky-800 flex items-center">
                        <i class="fas fa-comments mr-2"></i>Hội Thoại: Cuộc Sống & Sự Cố
                        <button onclick="playAllConversation()" class="ml-3 text-sm bg-sky-100 text-sky-700 hover:bg-sky-200 px-3 py-1 rounded-full transition flex items-center">
                            <i class="fas fa-play mr-1"></i> Nghe tất cả
                        </button>
                    </h2>
                    
                    <!-- Mode Tabs -->
                    <div class="flex bg-white rounded-lg p-1 shadow-sm border border-gray-200">
                        <button onclick="switchMode('polite')" id="tab-polite" class="tab-btn tab-active px-4 py-1.5 rounded-md text-sm font-bold">Lịch sự</button>
                        <button onclick="switchMode('casual')" id="tab-casual" class="tab-btn tab-inactive px-4 py-1.5 rounded-md text-sm font-bold ml-1">Thông thường</button>
                    </div>
                </div>
            </div>
            
            <div class="p-6 space-y-6" id="conversation-container">
                <!-- Dialogue injected by JS -->
            </div>
        </section>

        <!-- 2. Reading Section -->
        <section class="bg-white rounded-2xl shadow-md overflow-hidden fade-in border border-gray-100">
            <div class="bg-orange-50 px-6 py-4 border-b border-orange-100">
                <h2 class="text-xl font-bold text-orange-800"><i class="fas fa-book-open mr-2"></i>Bài Đọc: Kiến Trúc & Công Dụng</h2>
            </div>
            <div class="p-6">
                <div class="bg-orange-50/30 p-5 rounded-xl border border-orange-100 leading-loose text-lg kanji-font mb-2" id="reading-text"></div>
                <div class="text-gray-500 text-sm mb-4 italic hidden romaji-text" id="reading-romaji"></div>
                <div class="text-gray-700 text-sm mb-4 hidden vi-trans border-t border-orange-100 pt-2" id="reading-vi"></div>
                
                <!-- Reading Practice Area -->
                <div class="mt-6 pt-4 border-t border-gray-100">
                    <h4 class="text-sm font-bold text-gray-500 mb-2 uppercase"><i class="fas fa-keyboard mr-1"></i> Luyện gõ lại bài đọc:</h4>
                    <textarea id="reading-input" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-200 bg-gray-50 text-base kanji-font h-32" placeholder="Gõ lại nội dung bài đọc bằng tiếng Nhật vào đây..."></textarea>
                    <div id="reading-feedback" class="text-sm mt-2 min-h-[1.5rem]"></div>
                </div>
            </div>
        </section>

        <!-- 3. Grammar Section -->
        <section class="bg-white rounded-2xl shadow-md overflow-hidden fade-in border border-gray-100">
            <div class="bg-purple-50 px-6 py-4 border-b border-purple-100">
                <h2 class="text-xl font-bold text-purple-800"><i class="fas fa-star mr-2"></i>Điểm Ngữ Pháp Quan Trọng</h2>
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-4" id="grammar-container"></div>
        </section>

        <!-- 4. Vocabulary Flashcards -->
        <section class="fade-in">
            <div class="flex items-center justify-between mb-4 px-2">
                <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-tags mr-2 text-sky-600"></i>Thẻ Kanji</h2>
                <div class="flex items-center gap-2">
                    <button onclick="shuffleVocab()" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1 rounded-full font-bold transition flex items-center">
                        <i class="fas fa-random mr-1"></i> Shuffle
                    </button>
                    <span class="text-sm text-gray-500 bg-white px-3 py-1 rounded-full shadow-sm" id="vocab-counter">1 / 20</span>
                </div>
            </div>
            
            <div class="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden relative min-h-[500px]" id="vocab-card-container">
                <button onclick="prevVocab()" class="absolute left-0 top-0 bottom-0 px-4 text-gray-400 hover:text-sky-600 hover:bg-sky-50 transition z-10 focus:outline-none"><i class="fas fa-chevron-left text-3xl"></i></button>
                <button onclick="nextVocab()" class="absolute right-0 top-0 bottom-0 px-4 text-gray-400 hover:text-sky-600 hover:bg-sky-50 transition z-10 focus:outline-none"><i class="fas fa-chevron-right text-3xl"></i></button>
                <div id="vocab-content" class="p-8 md:p-12 text-center card-transition"></div>
            </div>
        </section>

        <!-- 5. Quiz Section -->
        <section class="bg-white rounded-2xl shadow-md overflow-hidden fade-in border border-gray-100 mb-12">
            <div class="bg-emerald-50 px-6 py-4 border-b border-emerald-100 flex justify-between items-center">
                <h2 class="text-xl font-bold text-emerald-800"><i class="fas fa-question-circle mr-2"></i>Bài Tập Thực Hành</h2>
                <span class="text-sm bg-emerald-200 text-emerald-800 px-3 py-1 rounded-full font-bold" id="quiz-score">0/10</span>
            </div>
            <div class="p-6 space-y-6" id="quiz-container"></div>
            <div class="px-6 py-4 bg-gray-50 border-t border-gray-100 text-center">
                <button onclick="checkQuiz()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-8 rounded-full shadow-lg transform transition active:scale-95">Nộp Bài</button>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-gray-400 py-8 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p>&copy; 2025 AzaKanji Kaiwa.</p>
        </div>
    </footer>

    <!-- STROKE ORDER MODAL -->
    <div id="stroke-modal" class="fixed inset-0 z-50 hidden overflow-y-auto" role="dialog" aria-modal="true">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity backdrop-blur-sm" onclick="closeStrokeModal()"></div>
            <div class="inline-block align-bottom bg-white rounded-xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full modal-enter relative">
                <div class="bg-sky-600 px-4 py-3 flex justify-between items-center text-white">
                    <h3 class="font-bold text-lg"><i class="fas fa-pen-nib mr-2"></i>Tập Viết Kanji: <span id="stroke-modal-char" class="text-2xl ml-2"></span></h3>
                    <button onclick="closeStrokeModal()" class="hover:text-gray-200"><i class="fas fa-times text-xl"></i></button>
                </div>
                <div class="p-6 bg-gray-50 max-h-[80vh] overflow-y-auto">
                    <div class="flex flex-col md:flex-row gap-8 items-start justify-center">
                        <div class="bg-white p-4 rounded-lg shadow border border-gray-200 text-center">
                            <p class="text-sm text-gray-500 mb-2 font-bold uppercase">Mô phỏng</p>
                            <div id="stroke-animation-container" class="w-40 h-40 mx-auto bg-white border border-gray-300 relative stroke-grid-box flex items-center justify-center">
                                <span class="text-gray-400 text-xs">Đang tải...</span>
                            </div>
                            <button onclick="replayStrokeAnimation()" class="mt-3 text-sm bg-sky-100 text-sky-700 px-3 py-1 rounded hover:bg-sky-200 transition"><i class="fas fa-redo mr-1"></i> Viết lại</button>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm text-gray-500 mb-3 font-bold uppercase">Thứ tự nét</p>
                            <div id="stroke-grid-container" class="flex flex-wrap gap-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA DAY 16 ---
        const lessonData = {
            conversation: {
                polite: [
                    { role: "Tanaka", jp: "鈴木[すずき]さん、毎日[まいにち]何時[なんじ]に起[お]きていますか。", romaji: "Suzuki-san, mainichi nanji ni okite imasu ka.", vi: "Anh Suzuki, hàng ngày anh thường thức dậy lúc mấy giờ?" },
                    { role: "Suzuki", jp: "毎朝[まいあさ]、6時[ろくじ]に起[お]きています。会社[かいしゃ]まで2時間[にじかん]もかかりますから。", romaji: "Maiasa, rokuji ni okite imasu. Kaisha made nijikan mo kakarimasu kara.", vi: "Mỗi sáng tôi thường dậy lúc 6 giờ. Vì đi đến công ty mất những 2 tiếng đồng hồ." },
                    { role: "Tanaka", jp: "大変[たいへん]ですね。お金[かね]を貯[た]めるために、頑張[がんば]っていますね。", romaji: "Taihen desu ne. Okane o tameru tame ni, ganbatte imasu ne.", vi: "Vất vả quá nhỉ. Anh đang cố gắng để dành dụm tiền nhỉ." },
                    { role: "Suzuki", jp: "はい。この間[あいだ]、どろぼうに財布[さいふ]を盗[ぬす]まれましたから、もっとお金[かね]が必要[ひつよう]なんです。", romaji: "Hai. Kono aida, dorobou ni saifu o nusumaremashita kara, motto okane ga hitsuyou nan desu.", vi: "Vâng. Vì dạo trước tôi bị trộm lấy mất ví nên giờ cần nhiều tiền hơn." },
                    { role: "Tanaka", jp: "それは大変[たいへん]でしたね。この本[ほん]は夏目漱石[なつめそうせき]によって書[か]かれました。読[よ]んでみませんか。", romaji: "Sore wa taihen deshita ne. Kono hon wa Natsume Souseki ni yotte kakaremashita. Yonde mimasen ka.", vi: "Thế thì gay go quá nhỉ. Cuốn sách này được viết bởi Natsume Souseki. Anh đọc thử không?" },
                    { role: "Suzuki", jp: "ありがとうございます。家[いえ]に帰[かえ]る途中[とちゅう]で、読[よ]んでみます。", romaji: "Arigatou gozaimasu. Ie ni kaeru tochuu de, yonde mimasu.", vi: "Cảm ơn anh. Trên đường về nhà tôi sẽ đọc thử." }
                ],
                casual: [
                    { role: "Tanaka", jp: "鈴木[すずき]くん、毎日[まいにち]何時[なんじ]に起[お]きてるの？", romaji: "Suzuki-kun, mainichi nanji ni okiteru no?", vi: "Suzuki, mỗi ngày cậu dậy lúc mấy giờ thế?" },
                    { role: "Suzuki", jp: "毎朝[まいあさ]6時[ろくじ]だよ。会社[かいしゃ]まで2時間[にじかん]もかかるからさ。", romaji: "Maiasa rokuji da yo. Kaisha made nijikan mo kakaru kara sa.", vi: "6 giờ mỗi sáng đó. Vì đến công ty mất tận 2 tiếng lận." },
                    { role: "Tanaka", jp: "大変[たいへん]だね。お金[かね]を貯[た]めるために、頑張[がんば]ってるんだね。", romaji: "Taihen da ne. Okane o tameru tame ni, ganbatterun da ne.", vi: "Vất vả ghê. Cậu đang cố gắng để tiết kiệm tiền nhỉ." },
                    { role: "Suzuki", jp: "うん。この間[あいだ]、どろぼうに財布[さいふ]盗[ぬす]まれたから、もっとお金[かね]が必要[ひつよう]なんだ。", romaji: "Un. Kono aida, dorobou ni saifu nusumareta kara, motto okane ga hitsuyou nanda.", vi: "Ừ. Dạo trước tớ bị trộm lấy mất ví, nên giờ cần nhiều tiền hơn." },
                    { role: "Tanaka", jp: "それは大変[たいへん]だったね。この本[ほん]、夏目漱石[なつめそうせき]によって書[か]かれたんだ。読[よ]んでみない？", romaji: "Sore wa taihen datta ne. Kono hon, Natsume Souseki ni yotte kakaretan da. Yonde minai?", vi: "Gay go nhỉ. Sách này được viết bởi Natsume Souseki đó. Đọc thử không?" },
                    { role: "Suzuki", jp: "ありがとう。家[いえ]に帰[かえ]る途中[とちゅう]で、読[よ]んでみるよ。", romaji: "Arigatou. Ie ni kaeru tochuu de, yonde miru yo.", vi: "Cảm ơn. Tớ sẽ đọc thử trên đường về nhà." }
                ]
            },
            reading: {
                jp: "この建物[たてもの]は有名[ゆうめい]な建築家[けんちくか]によって設計[せっけい]されました。中[なか]はとても広[ひろ]くて、たくさんの絵[え]が飾[かざ]られています。このはさみは紙[かみ]を切[き]るのに使[つか]います。毎日[まいにち]たくさんの人[ひと]に利用[りよう]されています。しかし、建物[たてもの]へ行[い]く途中[とちゅう]で、雨[あめ]に降[ふ]られました。傘[かさ]を持[も]っていなかったので、服[ふく]が濡[ぬ]れてしまいました。",
                romaji: "Kono tatemono wa yuumei na kenchikuka ni yotte sekkei saremashita. Naka wa totemo hirokute, takusan no e ga kazararete imasu. Kono hasami wa kami o kiru no ni tsukaimasu. Mainichi takusan no hito ni riyou sarete imasu. Shikashi, tatemono e iku tochuu de, ame ni furaremashita. Kasa o motte inakatta node, fuku ga nurete shimaimashita.",
                vi: "Tòa nhà này được thiết kế bởi một kiến trúc sư nổi tiếng. Bên trong rất rộng và được trang trí rất nhiều tranh. Cái kéo này được dùng để cắt giấy. Hàng ngày nó được rất nhiều người sử dụng. Tuy nhiên, trên đường đến tòa nhà, tôi đã bị mưa. Vì không mang ô nên quần áo đã bị ướt hết."
            },
            grammar: [
                { rule: "Vています (Thói quen)", formula: "Vて + います", mean: "Diễn tả một hành động lặp đi lặp lại như một thói quen.", ex: "毎朝[まいあさ]、ジョギングをしています。", vi: "Tôi chạy bộ mỗi sáng." },
                { rule: "～ために (Mục đích)", formula: "Vる / Nの + ために", mean: "Để làm gì đó, vì cái gì đó (Mục đích rõ ràng).", ex: "健康[けんこう]のために、野菜[やさい]を食[た]べます。", vi: "Vì sức khỏe, tôi ăn rau." },
                { rule: "～のに (Công dụng)", formula: "Vる / N + のに", mean: "Dùng để... (chỉ mục đích sử dụng của đồ vật).", ex: "このはさみは花[はな]を切[き]るのに使[つか]います。", vi: "Cái kéo này dùng để cắt hoa." },
                { rule: "Thể bị động (受身形)", formula: "N1は N2に (Nを) V(bị động)", mean: "Bị ai đó làm gì, hoặc được ai đó làm gì.", ex: "私[わたし]は先生[せんせい]に褒[ほ]められました。", vi: "Tôi đã được giáo viên khen." },
                { rule: "～によって (Bởi...)", formula: "N + によって + V(bị động)", mean: "Được làm bởi ai (chỉ tác giả, người phát minh).", ex: "電話[でんわ]はベルによって発明[はつめい]されました。", vi: "Điện thoại được phát minh bởi Bell." },
                { rule: "～途中で (Giữa chừng)", formula: "Vる / Nの + 途中で", mean: "Đang trên đường làm gì thì...", ex: "学校[がっこう]へ来[く]る途中[とちゅう]で、事故[じこ]を見[み]ました。", vi: "Trên đường đến trường, tôi đã thấy một vụ tai nạn." }
            ],
            vocab: [
                { 
                    k: "毎", h: "まい", on: "マイ", kun: "ごと", m: "Mỗi", hv: "MỖI", 
                    ti: "Người (**人**) Mẹ (**母**) Mỗi ngày đều chăm sóc con.", 
                    ta: "**Mai** (Mai) này **mỗi** ngày tôi đều sẽ nhớ bạn.", 
                    compounds: [{w: "毎日", r: "まいにち", m: "Mỗi ngày"}] 
                },
                { 
                    k: "起", h: "お", on: "キ", kun: "お.きる", m: "Dậy", hv: "KHỞI", 
                    ti: "Tẩu (**走**) thoát và Tự (**己**) mình đứng dậy Khởi nghĩa.", 
                    ta: "**Ô kìa** (Oki-ru), sao giờ này mới ngủ **Dậy**? **Kì** (Ki) lạ thật.", 
                    compounds: [{w: "起きる", r: "おきる", m: "Thức dậy"}] 
                },
                { 
                    k: "貯", h: "た", on: "チョ", kun: "た.める", m: "Trữ", hv: "TRỮ", 
                    ti: "Bối (**貝**) để trong Mái nhà (**宀**) và Đinh (**丁**) đóng chặt để tích trữ.", 
                    ta: "**Chờ** (Cho) mãi mới **tích trữ** (Ta-meru) đủ tiền.", 
                    compounds: [{w: "貯める", r: "ためる", m: "Để dành/Tích trữ"}] 
                },
                { 
                    k: "盗", h: "ぬす", on: "トウ", kun: "ぬす.む", m: "Trộm", hv: "ĐẠO", 
                    ti: "Tiếp cận (次) cái đĩa (皿) để ăn trộm.", 
                    ta: "Kẻ trộm **Nẫng** (Nusu-mu) tay trên đồ của **Tớ** (Tou).", 
                    compounds: [{w: "盗む", r: "ぬすむ", m: "Ăn trộm"}] 
                },
                { 
                    k: "財", h: "ざい", on: "ザイ", kun: "-", m: "Tiền tài", hv: "TÀI", 
                    ti: "Bảo bối (**貝**) và Tài năng (**才**) tạo ra Tiền tài.", 
                    ta: "Có **Dài** (Zai) dằng dặc của cải là người có **Tài**.", 
                    compounds: [{w: "財布", r: "さいふ", m: "Cái ví"}] 
                },
                { 
                    k: "必", h: "ひつ", on: "ヒツ", kun: "かなら.ず", m: "Tất", hv: "TẤT", 
                    ti: "Tâm (**心**) bị chia cắt bằng một nhát kiếm.", 
                    ta: "**Hít** (Hitsu) thở là điều **tất** yếu.", 
                    compounds: [{w: "必要", r: "ひつよう", m: "Cần thiết"}] 
                },
                { 
                    k: "要", h: "よう", on: "ヨウ", kun: "い.る", m: "Cần", hv: "YẾU", 
                    ti: "Người phụ nữ (**女**) phương Tây (**西**) rất quan trọng.", 
                    ta: "**Yêu** (You) cầu những thứ cần thiết.", 
                    compounds: [{w: "必要", r: "ひつよう", m: "Cần thiết"}] 
                },
                { 
                    k: "途", h: "と", on: "ト", kun: "みち", m: "Đường", hv: "ĐỒ", 
                    ti: "Đi (**辶**) trên con đường dư (**余**) thừa thời gian.", 
                    ta: "Cái **tô** (To) này mua ở **giữa đường** (Tochuu).", 
                    compounds: [{w: "途中", r: "とちゅう", m: "Giữa đường"}] 
                },
                { 
                    k: "建", h: "たて", on: "ケン", kun: "た.てる", m: "Xây dựng", hv: "KIẾN", 
                    ti: "Cầm bút (**聿**) đi trên đường (**廴**) để Kiến thiết đất nước.", 
                    ta: "**Ta tệ** (Tate-ru) thật, mãi không xây được cái nhà **Kiên** (Ken) cố.", 
                    compounds: [{w: "建物", r: "たてもの", m: "Tòa nhà"}] 
                },
                { 
                    k: "築", h: "ちく", on: "チク", kun: "きず.く", m: "Kiến trúc", hv: "TRÚC", 
                    ti: "Dùng Tre (**竹**) và Gỗ (**木**) làm việc (**工**) xây Kiến trúc tầm thường (**凡**).", 
                    ta: "**Chi cứ** (Chiku) đòi xây kiến **Trúc** bằng tre mãi.", 
                    compounds: [{w: "建築家", r: "けんちくか", m: "Kiến trúc sư"}] 
                },
                { 
                    k: "設", h: "せつ", on: "セツ", kun: "もう.ける", m: "Thiết lập", hv: "THIẾT", 
                    ti: "Nói (**言**) và dùng Binh khí (**殳**) để Thiết lập trật tự.", 
                    ta: "Hãy **Xếp** (Setsu) đặt và **Thiết** lập lại hệ thống.", 
                    compounds: [{w: "設計", r: "せっけい", m: "Thiết kế"}] 
                },
                { 
                    k: "計", h: "けい", on: "ケイ", kun: "はか.る", m: "Kế", hv: "KẾ", 
                    ti: "Nói (**言**) mười (**十**) điều để lên kế hoạch.", 
                    ta: "Lên **kế** hoạch **kê** (Kei) khai tài sản.", 
                    compounds: [{w: "設計", r: "せっけい", m: "Thiết kế"}] 
                },
                { 
                    k: "飾", h: "かざ", on: "ショク", kun: "かざ.る", m: "Trang trí", hv: "SỨC", 
                    ti: "Ăn (**飠**) xong dùng khăn (**巾**) lau người (**人**) cho đẹp.", 
                    ta: "**Ca ra** (Kaza-ru) oke cần **trang trí** đẹp.", 
                    compounds: [{w: "飾る", r: "かざる", m: "Trang trí"}] 
                },
                { 
                    k: "利", h: "り", on: "リ", kun: "き.く", m: "Lợi", hv: "LỢI", 
                    ti: "Cây lúa (**禾**) dùng dao (**刂**) gặt thì có Lợi.", 
                    ta: "Dùng **Lí** (Ri) trí để kiếm **lợi**.", 
                    compounds: [{w: "利用", r: "りよう", m: "Sử dụng"}] 
                },
                { 
                    k: "用", h: "よう", on: "ヨウ", kun: "もち.いる", m: "Dụng", hv: "DỤNG", 
                    ti: "Hình cái hàng rào bao quanh công dụng.", 
                    ta: "**Yo** (You)! Cái này có **dụng** ý gì?", 
                    compounds: [{w: "利用", r: "りよう", m: "Sử dụng"}] 
                },
                { 
                    k: "降", h: "ふ", on: "コウ", kun: "ふ.る", m: "Rơi/Xuống", hv: "GIÁNG", 
                    ti: "Ở Phụ (**阝**) cận, Bò (**夂**) và tay cầm gậy (**㐄**) đi xuống.", 
                    ta: "**Phù** (Fu-ru) thủy làm mưa rơi xuống **Cô** (Kou) nương.", 
                    compounds: [{w: "雨が降る", r: "あめがふる", m: "Mưa rơi"}] 
                },
                { 
                    k: "傘", h: "かさ", on: "サン", kun: "かさ", m: "Cái ô", hv: "TẢN", 
                    ti: "Nhiều người (**人**) đứng dưới một cái mái lớn.", 
                    ta: "Cầm **Ca sa** (Kasa) đi che ô thì thật là **Sân** (San) si.", 
                    compounds: [{w: "傘", r: "かさ", m: "Cái ô"}] 
                },
                { 
                    k: "濡", h: "ぬ", on: "ジュ", kun: "ぬ.れる", m: "Ướt", hv: "NHU", 
                    ti: "Nước (**氵**) mưa (**雨**) làm ướt mà (**而**).", 
                    ta: "**Nu** (Nu-reru) na nu nống bị **ướt** sũng.", 
                    compounds: [{w: "濡れる", r: "ぬれる", m: "Bị ướt"}] 
                },
                { 
                    k: "切", h: "き", on: "セツ", kun: "き.る", m: "Cắt", hv: "THIẾT", 
                    ti: "Bảy (**七**) con dao (**刀**) dùng để Cắt.", 
                    ta: "**Ki** (Ki-ru) ki là tiếng **cắt** giấy.", 
                    compounds: [{w: "切る", r: "きる", m: "Cắt"}] 
                },
                { 
                    k: "使", h: "つか", on: "シ", kun: "つか.う", m: "Sử dụng", hv: "SỬ", 
                    ti: "Người (**亻**) lại (**吏**) làm quan Sử dụng quyền lực.", 
                    ta: "**Sứ** (Shi) giả **sử dụng** (Tsuka-u) ngựa.", 
                    compounds: [{w: "使う", r: "つかう", m: "Sử dụng"}] 
                }
            ],
            quiz: [
                { type: 'mcq', question: "この本[ほん]は夏目漱石[なつめそうせき]（___）書[か]かれました。", options: ["が", "を", "によって"], correct: 2, explain: "Cấu trúc bị động chỉ tác giả/người phát minh: N + によって." },
                { type: 'fill', question: "健康[けんこう]の（___）、毎日[まいにち]運動[うんどう]しています。", answer: "ために", explain: "Nの + ために: Để (chỉ mục đích)." },
                { type: 'mcq', question: "私[わたし]は犬[いぬ]に手[て]を（___）。", options: ["噛[か]みました", "噛[か]まれました", "噛[か]んでいます"], correct: 1, explain: "Bị động gián tiếp (Bị chó cắn vào tay): Kamaremashita." },
                { type: 'audio', question: "Nghe và gõ lại câu bạn vừa nghe:", jp: "学校へ来る途中で、事故を見ました。", explain: "Gakkou e kuru tochuu de, jiko o mimashita (Trên đường đến trường tôi thấy tai nạn)." },
                { type: 'mcq', question: "このペンは字[じ]を書[か]く（___）使[つか]います。", options: ["ために", "のに", "ように"], correct: 1, explain: "Cấu trúc 'Dùng để...': Vる + のに + 使います." },
                { type: 'mcq', question: "設計 (Thiết kế) đọc là gì?", options: ["せっけい", "けんちく", "せつび"], correct: 0, explain: "設計 đọc là Sekkei." },
                { type: 'fill', question: "先生（___）褒[ほ]められました。", answer: "に", explain: "Trong câu bị động, người thực hiện hành động đi với trợ từ に." },
                { type: 'mcq', question: "飾る[かざる] có nghĩa là gì?", options: ["Xây dựng", "Trang trí", "Thiết kế"], correct: 1, explain: "飾る (Kazaru) nghĩa là Trang trí." },
                { type: 'mcq', question: "Chọn động từ đúng: 毎朝6時に（___）。", options: ["起きます", "起きています", "起きました"], correct: 1, explain: "V-te imasu diễn tả thói quen lặp lại hàng ngày." },
                { type: 'audio', question: "Nghe và điền từ còn thiếu:", jp: "この建物は有名な建築家によって設計されました。", explain: "Kono tatemono wa yuumei na kenchikuka ni yotte sekkei saremashita." }
            ]
        };

        // --- STATE ---
        let currentMode = 'polite';
        let showFurigana = true;
        let showRomaji = false;
        let showVi = true;
        let currentVocabIndex = 0; 
        let vocabSeen = new Set();
        let quizScoreCurrent = 0;
        let currentSpeed = 1.0;
        let currentStrokeSvg = null;
        let recognition = null; // Speech Recognition
        let isRecognizing = false; // Add this state variable

        // --- UTILS ---
        const parseFurigana = (text) => text ? text.replace(/([^\[\]]+)\[(.+?)\]/g, '<ruby>$1<rt>$2</rt></ruby>') : '';
        const cleanText = (text) => text ? text.replace(/\[.*?\]/g, '') : '';

        // Audio with Voice Selection
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            if (type === 'correct') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(500, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1); gain.gain.setValueAtTime(0.2, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3); osc.start(); osc.stop(audioCtx.currentTime + 0.3);
            } else {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(200, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.2); gain.gain.setValueAtTime(0.2, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2); osc.start(); osc.stop(audioCtx.currentTime + 0.2);
            }
        }

        let jpVoice = null;
        function loadVoices() {
            const voices = window.speechSynthesis.getVoices();
            // Prioritize Google Japanese, then any Japanese, then default
            jpVoice = voices.find(v => v.name === 'Google 日本語') || voices.find(v => v.lang === 'ja-JP') || null;
        }
        window.speechSynthesis.onvoiceschanged = loadVoices;

        function speak(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(cleanText(text));
                u.lang = 'ja-JP'; u.rate = currentSpeed;
                if(jpVoice) u.voice = jpVoice;
                window.speechSynthesis.speak(u);
            }
        }

        // --- SPEECH RECOGNITION (New Feature) ---
        function initSpeech() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.lang = 'ja-JP';
                recognition.continuous = false;
                recognition.interimResults = false;
            } else {
                console.warn("Speech Recognition not supported in this browser.");
            }
        }

        function startListening(targetInputId) {
            if (!recognition) {
                alert("Trình duyệt của bạn không hỗ trợ nhận diện giọng nói. Hãy dùng Chrome hoặc Edge.");
                return;
            }
            
            // If already active, stop it (toggle behavior)
            if (isRecognizing) {
                recognition.stop();
                return;
            }
            
            const btn = document.getElementById(`mic-btn-${targetInputId}`);
            const input = document.getElementById(targetInputId);
            
            // Clear any stray loading states
            document.querySelectorAll('.mic-listening').forEach(el => el.classList.remove('mic-listening'));
            
            // Define handlers
            recognition.onstart = () => {
                isRecognizing = true;
                btn.classList.add('mic-listening');
            };

            recognition.onend = () => {
                isRecognizing = false;
                btn.classList.remove('mic-listening');
            };

            recognition.onresult = (event) => {
                const text = event.results[0][0].transcript;
                input.value = text;
                input.dispatchEvent(new Event('input'));
            };

            recognition.onerror = (event) => {
                console.error("Speech error", event.error);
                // onend will be called automatically
            };

            try {
                recognition.start();
            } catch (e) {
                console.error("Speech start failed", e);
                isRecognizing = false;
            }
        }

        // --- STROKE ORDER LOGIC ---
        function getKanjiHex(kanji) {
            return kanji.charCodeAt(0).toString(16).padStart(5, '0');
        }

        async function fetchKanjiSvg(hex) {
            const url = `https://cdn.jsdelivr.net/gh/KanjiVG/kanjivg/kanji/${hex}.svg`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Not found');
                return await response.text();
            } catch (e) {
                console.error("Error fetching SVG:", e);
                return null;
            }
        }

        async function showStrokeOrder(kanji) {
            const hex = getKanjiHex(kanji);
            document.getElementById('stroke-modal').classList.remove('hidden');
            document.getElementById('stroke-modal-char').innerText = kanji;
            
            const animContainer = document.getElementById('stroke-animation-container');
            const gridContainer = document.getElementById('stroke-grid-container');
            animContainer.innerHTML = '<span class="text-gray-400 text-xs">Đang tải...</span>';
            
            const svgContent = await fetchKanjiSvg(hex);
            
            if (!svgContent) {
                animContainer.innerHTML = "<p class='p-4 text-red-500 text-xs'>Lỗi tải dữ liệu.</p>";
                gridContainer.innerHTML = "";
                return;
            }

            // 1. Setup Animation
            animContainer.innerHTML = svgContent;
            const mainSvg = animContainer.querySelector('svg');
            mainSvg.setAttribute('width', '100%');
            mainSvg.setAttribute('height', '100%');
            
            const paths = mainSvg.querySelectorAll('path');
            paths.forEach((path) => {
                const length = path.getTotalLength();
                path.style.strokeDasharray = length;
                path.style.strokeDashoffset = length;
                path.style.stroke = "#333";
                path.style.strokeWidth = "4";
                path.style.fill = "none";
                path.style.strokeLinecap = "round";
                path.style.strokeLinejoin = "round";
            });
            
            currentStrokeSvg = mainSvg;
            replayStrokeAnimation();

            // 2. Setup Static Grid
            gridContainer.innerHTML = '';
            const numStrokes = paths.length;
            
            for (let i = 0; i < numStrokes; i++) {
                const stepBox = document.createElement('div');
                stepBox.className = "w-20 h-20 bg-white border border-gray-200 relative stroke-grid-box flex items-center justify-center";
                
                const parser = new DOMParser();
                const doc = parser.parseFromString(svgContent, "image/svg+xml");
                const svgClone = doc.querySelector('svg');
                svgClone.setAttribute('width', '100%');
                svgClone.setAttribute('height', '100%');
                
                const clonePaths = svgClone.querySelectorAll('path');
                clonePaths.forEach((p, pIdx) => {
                    p.style.fill = "none";
                    p.style.strokeLinecap = "round";
                    p.style.strokeLinejoin = "round";
                    if (pIdx < i) { p.style.stroke = "#9ca3af"; p.style.strokeWidth = "3"; }
                    else if (pIdx === i) { p.style.stroke = "#000"; p.style.strokeWidth = "4"; }
                    else { p.style.display = "none"; }
                });
                
                stepBox.appendChild(svgClone);
                gridContainer.appendChild(stepBox);
            }
        }

        function replayStrokeAnimation() {
            if(!currentStrokeSvg) return;
            const paths = currentStrokeSvg.querySelectorAll('path');
            paths.forEach(p => { p.style.transition = 'none'; p.style.strokeDashoffset = p.getTotalLength(); });
            void currentStrokeSvg.offsetWidth;
            let delay = 0; const duration = 0.6;
            paths.forEach((p) => {
                p.style.transition = `stroke-dashoffset ${duration}s ease-in-out ${delay}s`;
                p.style.strokeDashoffset = '0';
                delay += duration;
            });
        }

        function closeStrokeModal() { document.getElementById('stroke-modal').classList.add('hidden'); }

        // --- STORAGE & SETTINGS ---
        function saveSettings() {
            const settings = { showFurigana, showRomaji, showVi, currentSpeed };
            localStorage.setItem('azaSettings', JSON.stringify(settings));
        }

        function loadSettings() {
            const saved = localStorage.getItem('azaSettings');
            if (saved) {
                const s = JSON.parse(saved);
                showFurigana = s.showFurigana; showRomaji = s.showRomaji; showVi = s.showVi; currentSpeed = s.currentSpeed || 1.0;
            }
        }

        // --- PROGRESS ---
        function updateProgress() {
            const totalPoints = 40 + 10 + 20 + 30;
            let currentPoints = 0;
            const convoInputs = document.querySelectorAll('#conversation-container .correct-input');
            const totalConvoLines = lessonData.conversation.polite.length;
            if (totalConvoLines > 0) currentPoints += (convoInputs.length / totalConvoLines) * 40;
            const readingInput = document.getElementById('reading-input');
            if(readingInput && readingInput.value.length > lessonData.reading.jp.length * 0.3) currentPoints += 10;
            if (lessonData.vocab.length > 0) currentPoints += (vocabSeen.size / lessonData.vocab.length) * 20;
            if (lessonData.quiz.length > 0) currentPoints += (quizScoreCurrent / lessonData.quiz.length) * 30;
            const percent = Math.min(100, Math.round(currentPoints));
            document.getElementById('progress-bar').style.width = `${percent}%`;
            document.getElementById('progress-text').innerText = `${percent}%`;
        }

        function checkTyping(input, correctText, feedbackDiv) {
            const userText = input.value;
            const targetText = cleanText(correctText);
            
            // Normalize for loose checking (optional: ignore spaces or punctuation)
            // For now, keep strict but visual feedback helps
            
            let html = '';
            for (let i = 0; i < userText.length; i++) {
                if (i >= targetText.length) { html += `<span class="incorrect-char">${userText[i]}</span>`; }
                else if (userText[i] === targetText[i]) { html += `<span class="correct-char">${userText[i]}</span>`; }
                else { html += `<span class="incorrect-char">${userText[i]}</span>`; }
            }
            feedbackDiv.innerHTML = html;
            
            if (userText === targetText) {
                input.classList.add('correct-input'); input.classList.remove('wrong-input');
                feedbackDiv.innerHTML += ' <span class="text-green-600 ml-2 font-bold text-xs"><i class="fas fa-check-circle"></i> Chính xác!</span>';
                playSound('correct'); updateProgress();
            } else if (userText.length > 0) {
                input.classList.add('wrong-input'); input.classList.remove('correct-input');
            } else {
                input.classList.remove('correct-input', 'wrong-input');
            }
        }

        function playAllConversation() {
            const lines = lessonData.conversation[currentMode];
            let i = 0;
            function playNext() {
                if (i >= lines.length) return;
                const allLines = document.querySelectorAll('#conversation-container > div');
                allLines.forEach(el => el.classList.remove('playing-line'));
                if (allLines[i]) {
                    allLines[i].classList.add('playing-line');
                    allLines[i].scrollIntoView({behavior: "smooth", block: "center"});
                }
                speak(lines[i].jp);
                // Approx duration calculation or use onend (more reliable)
                // Using global speech function doesn't expose onend easily without refactoring, 
                // so we use a direct utterance here for the chain.
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(cleanText(lines[i].jp));
                u.lang = 'ja-JP'; u.rate = currentSpeed;
                if(jpVoice) u.voice = jpVoice;
                u.onend = () => { i++; setTimeout(playNext, 500); };
                window.speechSynthesis.speak(u);
            }
            window.speechSynthesis.cancel();
            playNext();
        }

        // --- RENDER ---
        function renderConversation() {
            const container = document.getElementById('conversation-container');
            const lines = lessonData.conversation[currentMode];
            container.innerHTML = lines.map((line, idx) => `
                <div class="flex gap-4 fade-in ${line.role === 'Tanaka' ? '' : 'flex-row-reverse'} p-2 rounded-lg transition-colors duration-300">
                    <div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center font-bold text-white shadow-md ${line.role === 'Tanaka' ? 'bg-blue-500' : 'bg-green-500'}">
                        ${line.role[0]}
                    </div>
                    <div class="flex-1 max-w-[90%]">
                        <div class="text-xs text-gray-500 mb-1 ${line.role === 'Tanaka' ? 'text-left' : 'text-right'}">${line.role}</div>
                        <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-200 relative group transition hover:shadow-md ${line.role === 'Tanaka' ? 'rounded-tl-none' : 'rounded-tr-none bg-green-50'}">
                            <p class="text-lg text-gray-800 kanji-font leading-relaxed mb-1">${parseFurigana(line.jp)}</p>
                            <p class="text-sm text-gray-500 romaji-text hidden italic mb-1">${line.romaji}</p>
                            <p class="text-sm text-gray-500 vi-trans border-t border-gray-100 pt-2 mt-2">${line.vi}</p>
                            <button onclick="speak('${line.jp}')" class="absolute top-2 right-2 text-gray-300 hover:text-sky-600 transition"><i class="fas fa-volume-up"></i></button>
                            
                            <div class="mt-3 pt-2 border-t border-gray-100">
                                <div class="flex gap-2">
                                    <input type="text" id="convo-input-${idx}" class="flex-1 text-sm p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-200 transition bg-gray-50 placeholder-gray-300" placeholder="Nghe và gõ lại..." oninput="checkTyping(this, '${line.jp}', this.parentElement.nextElementSibling)">
                                    <button id="mic-btn-convo-input-${idx}" onclick="startListening('convo-input-${idx}')" class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 rounded-lg transition" title="Nói để nhập (Chrome/Edge)"><i class="fas fa-microphone"></i></button>
                                </div>
                                <div class="h-5 mt-1 text-sm pl-1 kanji-font"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            updateUI();
        }

        function switchMode(mode) {
            currentMode = mode;
            document.getElementById('tab-polite').className = mode === 'polite' ? "tab-btn tab-active px-4 py-1.5 rounded-md text-sm font-bold" : "tab-btn tab-inactive px-4 py-1.5 rounded-md text-sm font-bold ml-1";
            document.getElementById('tab-casual').className = mode === 'casual' ? "tab-btn tab-active px-4 py-1.5 rounded-md text-sm font-bold ml-1" : "tab-btn tab-inactive px-4 py-1.5 rounded-md text-sm font-bold ml-1";
            renderConversation();
        }

        function renderReading() {
            document.getElementById('reading-text').innerHTML = parseFurigana(lessonData.reading.jp);
            document.getElementById('reading-romaji').innerText = lessonData.reading.romaji;
            document.getElementById('reading-vi').innerText = lessonData.reading.vi;
            const input = document.getElementById('reading-input');
            const feedback = document.getElementById('reading-feedback');
            input.oninput = () => {
                if(input.value.length > 50) updateProgress();
                checkTyping(input, lessonData.reading.jp, feedback); 
            };
            if(!document.getElementById('reading-play-btn')) {
                const btn = document.createElement('button');
                btn.id = 'reading-play-btn';
                btn.className = "mt-4 text-orange-500 hover:text-orange-700 font-bold flex items-center text-sm transition";
                btn.innerHTML = '<i class="fas fa-volume-up mr-2"></i> Nghe bài đọc';
                btn.onclick = () => speak(lessonData.reading.jp);
                document.getElementById('reading-text').parentNode.insertBefore(btn, document.getElementById('reading-text').nextSibling);
            }
        }

        function renderGrammar() {
            const container = document.getElementById('grammar-container');
            container.innerHTML = lessonData.grammar.map(g => `
                <div class="bg-white p-5 rounded-xl border border-purple-100 shadow-sm hover:border-purple-300 transition group">
                    <h3 class="font-bold text-purple-700 mb-1 text-lg flex items-center"><span class="w-2 h-2 bg-purple-500 rounded-full mr-2"></span>${g.rule}</h3>
                    <div class="mb-2 pl-4"><span class="bg-red-100 text-red-600 text-xs px-2 py-1 rounded font-bold">Công thức:</span> <span class="text-gray-700 text-sm kanji-font">${g.formula}</span></div>
                    <p class="text-gray-600 text-sm mb-3 pl-4">${g.mean}</p>
                    <div class="bg-purple-50 p-3 rounded-lg text-sm text-gray-700 kanji-font relative pl-4">
                        <i class="fas fa-quote-left text-purple-200 absolute top-1 left-1 text-xs"></i>${parseFurigana(g.ex)}
                        <p class="text-xs text-purple-600 mt-1 italic">${g.vi}</p>
                        <button onclick="speak('${g.ex}')" class="absolute top-2 right-2 text-purple-300 hover:text-purple-600 transition opacity-0 group-hover:opacity-100"><i class="fas fa-volume-up"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function shuffleVocab() {
            for (let i = lessonData.vocab.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [lessonData.vocab[i], lessonData.vocab[j]] = [lessonData.vocab[j], lessonData.vocab[i]];
            }
            currentVocabIndex = 0;
            renderVocab();
        }

        function renderVocab() {
            vocabSeen.add(currentVocabIndex);
            updateProgress();
            const container = document.getElementById('vocab-content');
            const v = lessonData.vocab[currentVocabIndex];
            const compoundsHtml = v.compounds ? v.compounds.map(c => 
                `<div class="flex justify-between items-center bg-gray-50 px-3 py-2 rounded mb-1 cursor-pointer hover:bg-gray-100" onclick="speak('${c.r}')">
                    <span class="text-gray-800 font-bold">${c.w}</span>
                    <span class="text-gray-500 text-xs">${c.r}</span>
                    <span class="text-sky-600 text-xs">${c.m}</span>
                    <i class="fas fa-volume-up text-xs text-gray-300 ml-2"></i>
                </div>`
            ).join('') : '';

            container.innerHTML = `
                <div class="animate-fade-in relative">
                    <div class="text-6xl font-bold text-gray-800 kanji-font mb-2 cursor-pointer hover:text-sky-600 transition" onclick="showStrokeOrder('${v.k}')" title="Bấm để xem cách viết">${v.k}</div>
                    <button onclick="showStrokeOrder('${v.k}')" class="text-xs bg-sky-100 text-sky-700 px-3 py-1 rounded-full mb-2 hover:bg-sky-200 transition"><i class="fas fa-pen-nib mr-1"></i> Tập viết</button>
                    
                    <div class="grid grid-cols-2 gap-4 text-center mb-4 text-sm bg-gray-50 p-2 rounded-lg">
                        <div class="flex flex-col items-center">
                            <span class="text-xs text-gray-400 block uppercase font-bold mb-1">On'yomi</span>
                            <div class="flex items-center gap-2">
                                <span class="text-gray-800 font-bold">${v.on}</span>
                                <button onclick="speak('${v.on}')" class="w-6 h-6 rounded-full bg-white shadow-sm flex items-center justify-center text-sky-500 hover:bg-sky-50 hover:text-sky-700 transition" title="Nghe âm On">
                                    <i class="fas fa-volume-up text-xs"></i>
                                </button>
                            </div>
                        </div>
                        <div class="flex flex-col items-center">
                            <span class="text-xs text-gray-400 block uppercase font-bold mb-1">Kun'yomi</span>
                            <div class="flex items-center gap-2">
                                <span class="text-gray-800 font-bold">${v.kun}</span>
                                <button onclick="speak('${v.kun.replace(/\./g, '')}')" class="w-6 h-6 rounded-full bg-white shadow-sm flex items-center justify-center text-sky-500 hover:bg-sky-50 hover:text-sky-700 transition" title="Nghe âm Kun">
                                    <i class="fas fa-volume-up text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="inline-block text-xs font-bold text-white bg-gray-400 px-3 py-1 rounded-full mb-4 tracking-wide">${v.hv}</div>
                    <div class="text-sky-700 font-bold text-2xl mb-6 border-b border-gray-100 pb-4">${v.m}</div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-left max-w-2xl mx-auto">
                        <div class="bg-orange-50 p-4 rounded-xl border border-orange-100">
                            <div class="font-bold text-orange-600 mb-2 flex items-center"><i class="fas fa-image mr-2"></i> Mẹo Hình Ảnh</div>
                            <div class="text-gray-700 text-sm leading-relaxed">${v.ti.replace(/\*\*(.*?)\*\*/g, '<span class="text-red-600 font-bold">$1</span>')}</div>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                            <div class="font-bold text-blue-600 mb-2 flex items-center"><i class="fas fa-volume-up mr-2"></i> Mẹo Âm Thanh</div>
                            <div class="text-gray-700 text-sm leading-relaxed">${v.ta.replace(/\*\*(.*?)\*\*/g, '<span class="text-indigo-600 font-bold">$1</span>')}</div>
                        </div>
                    </div>

                    ${compoundsHtml ? `<div class="mt-8 pt-6 border-t border-gray-100"><div class="text-sm text-gray-400 mb-2 font-bold uppercase tracking-wide text-center">Từ ghép (Bấm để nghe)</div><div class="kanji-font text-gray-600 max-w-sm mx-auto text-left">${compoundsHtml}</div></div>` : ''}
                </div>
            `;
            document.getElementById('vocab-counter').innerText = `${currentVocabIndex + 1} / ${lessonData.vocab.length}`;
        }
        function prevVocab() { if (currentVocabIndex > 0) { currentVocabIndex--; renderVocab(); } }
        function nextVocab() { if (currentVocabIndex < lessonData.vocab.length - 1) { currentVocabIndex++; renderVocab(); } }
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') prevVocab();
            if (e.key === 'ArrowRight') nextVocab();
        });

        // --- QUIZ ---
        function renderQuiz() {
            const container = document.getElementById('quiz-container');
            container.innerHTML = lessonData.quiz.map((q, idx) => `
                <div class="quiz-item border-b border-gray-100 pb-4 last:border-0">
                    <p class="font-bold text-gray-800 mb-3"><span class="text-emerald-600 mr-2">Câu ${idx + 1}:</span> ${q.type === 'audio' ? q.question : parseFurigana(q.question)}</p>
                    <div class="space-y-2">
                        ${q.type === 'audio' ? `<button class="speak-btn mb-2 flex items-center text-sky-600 font-bold" onclick="speak('${q.jp}')"><i class="fas fa-volume-up mr-2"></i> Nghe câu hỏi</button><input type="text" class="w-full p-2 border rounded" placeholder="Nhập câu bạn nghe được..." data-idx="${idx}">` 
                        : q.type === 'fill' ? `<input type="text" class="w-full p-2 border rounded fill-input" placeholder="Điền từ còn thiếu..." data-idx="${idx}">` 
                        : q.options.map((opt, optIdx) => `<label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition quiz-option" data-q="${idx}" data-opt="${optIdx}"><input type="radio" name="q${idx}" value="${optIdx}" class="mr-3 text-emerald-600 focus:ring-emerald-500"><span class="kanji-font">${parseFurigana(opt)}</span></label>`).join('')}
                    </div>
                    <div class="quiz-feedback hidden mt-3 p-3 rounded-lg text-sm" id="feedback-${idx}"></div>
                </div>
            `).join('');
            document.getElementById('quiz-score').innerText = `0/${lessonData.quiz.length}`;
        }

        function checkQuiz() {
            let score = 0;
            lessonData.quiz.forEach((q, idx) => {
                const feedbackEl = document.getElementById(`feedback-${idx}`);
                feedbackEl.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
                let isCorrect = false;
                if (q.type === 'audio') {
                    const input = document.querySelector(`input[data-idx="${idx}"]`);
                    isCorrect = input.value.trim() === cleanText(q.jp);
                } else if (q.type === 'fill') {
                    const input = document.querySelector(`input[data-idx="${idx}"]`);
                    isCorrect = input.value.trim() === q.answer;
                } else {
                    const selected = document.querySelector(`input[name="q${idx}"]:checked`);
                    if (selected && parseInt(selected.value) === q.correct) isCorrect = true;
                }
                
                if (isCorrect) {
                    score++;
                    feedbackEl.innerHTML = `<i class="fas fa-check-circle mr-2"></i> Chính xác! <br><span class="text-xs mt-1 block opacity-80">${q.explain || ''}</span>`;
                    feedbackEl.classList.add('bg-green-100', 'text-green-800');
                } else {
                    const ans = q.type === 'mcq' ? q.options[q.correct] : (q.type === 'audio' ? q.jp : q.answer);
                    feedbackEl.innerHTML = `<i class="fas fa-times-circle mr-2"></i> Sai rồi. Đáp án: <strong>${ans}</strong><br><span class="text-xs mt-1 block opacity-80">${q.explain || ''}</span>`;
                    feedbackEl.classList.add('bg-red-100', 'text-red-800');
                }
            });
            if(score === lessonData.quiz.length) playSound('correct');
            else playSound('wrong');
            quizScoreCurrent = score;
            document.getElementById('quiz-score').innerText = `${score}/${lessonData.quiz.length}`;
            updateProgress();
        }

        function updateUI() {
            document.querySelectorAll('rt').forEach(rt => rt.style.visibility = showFurigana ? 'visible' : 'hidden');
            document.getElementById('btn-toggle-furigana').className = showFurigana ? "px-3 py-1.5 rounded transition bg-sky-600 text-white flex items-center shadow" : "px-3 py-1.5 rounded transition bg-gray-200 text-gray-600 flex items-center";
            document.querySelectorAll('.romaji-text').forEach(el => el.classList.toggle('hidden', !showRomaji));
            document.getElementById('btn-toggle-romaji').className = showRomaji ? "px-3 py-1.5 rounded transition bg-sky-600 text-white flex items-center shadow ml-1" : "px-3 py-1.5 rounded transition bg-gray-200 text-gray-600 flex items-center ml-1";
            document.querySelectorAll('.vi-trans').forEach(p => p.style.display = showVi ? 'block' : 'none');
            document.getElementById('btn-toggle-vi').className = showVi ? "px-3 py-1.5 rounded transition bg-white text-sky-800 font-bold ml-1 flex items-center border border-sky-200 shadow-sm" : "px-3 py-1.5 rounded transition bg-gray-200 text-gray-500 font-bold ml-1 flex items-center";
            const speedSelect = document.getElementById('audio-speed');
            speedSelect.value = currentSpeed;
            speedSelect.onchange = (e) => { currentSpeed = parseFloat(e.target.value); };
        }

        document.getElementById('btn-toggle-furigana').onclick = () => { showFurigana = !showFurigana; updateUI(); saveSettings(); };
        document.getElementById('btn-toggle-romaji').onclick = () => { showRomaji = !showRomaji; updateUI(); saveSettings(); };
        document.getElementById('btn-toggle-vi').onclick = () => { showVi = !showVi; updateUI(); saveSettings(); };

        document.addEventListener('DOMContentLoaded', () => {
            initSpeech(); // Init Microphone
            loadSettings();
            renderConversation();
            renderReading();
            renderGrammar();
            renderVocab();
            renderQuiz();
            updateUI();
            updateProgress();
            setTimeout(loadVoices, 100); // Load voices explicitly
        });
    </script>
</body>
</html>
