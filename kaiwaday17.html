<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AzaKanji - Hội Thoại & Ngữ Pháp (Day 17 - Mobile Fix)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #f3f4f6; overflow-x: hidden; }
        .kanji-font { font-family: 'Noto Sans JP', sans-serif; }
        
        /* Mobile-friendly scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }

        ruby rt { font-size: 0.6em; color: #64748b; user-select: none; }
        .hide-furigana ruby rt { visibility: hidden; }

        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Typing Feedback */
        .correct-char { color: #16a34a; font-weight: bold; }
        .incorrect-char { color: #dc2626; text-decoration: underline; font-weight: bold; }
        .correct-input { border-color: #22c55e !important; background-color: #f0fdf4 !important; }
        .wrong-input { border-color: #ef4444 !important; background-color: #fef2f2 !important; }
        
        /* Microphone Pulse */
        .mic-listening { animation: pulse-red 1.5s infinite; color: #dc2626 !important; border-color: #dc2626 !important; background-color: #fef2f2; }
        @keyframes pulse-red { 
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); } 
            70% { box-shadow: 0 0 0 6px rgba(220, 38, 38, 0); } 
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } 
        }

        /* SVG Animation */
        .stroke-path { fill: none; stroke: #333; stroke-width: 3; stroke-linecap: round; stroke-linejoin: round; }
        .stroke-grid-box { border: 1px solid #e5e7eb; background-color: white; position: relative; }
        .stroke-grid-box::after { content: ''; position: absolute; top: 0; left: 50%; width: 1px; height: 100%; background: repeating-linear-gradient(to bottom, #ddd 0, #ddd 4px, transparent 4px, transparent 8px); z-index: 0; }
        .stroke-grid-box::before { content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 1px; background: repeating-linear-gradient(to right, #ddd 0, #ddd 4px, transparent 4px, transparent 8px); z-index: 0; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Header -->
    <header class="bg-sky-700 text-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-3 py-2">
            <div class="flex flex-col gap-2">
                <!-- Top Row: Logo & Title -->
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2 cursor-pointer" onclick="location.reload()">
                        <i class="fas fa-torii-gate text-2xl text-yellow-300"></i>
                        <div>
                            <h1 class="text-lg font-bold uppercase tracking-wide leading-tight">AzaKanji</h1>
                            <p class="text-[10px] text-sky-200 leading-tight">Day 17: Cảm Giác & Phỏng Đoán</p>
                        </div>
                    </div>
                    <!-- Audio Speed (Compact) -->
                    <div class="flex bg-sky-800 rounded px-2 py-1 items-center">
                        <i class="fas fa-tachometer-alt text-xs text-sky-300 mr-1"></i>
                        <select id="audio-speed" class="bg-transparent border-none text-white text-xs font-bold focus:ring-0 p-0 cursor-pointer">
                            <option value="0.75" class="text-gray-800">0.75x</option>
                            <option value="1.0" class="text-gray-800" selected>1.0x</option>
                            <option value="1.25" class="text-gray-800">1.25x</option>
                        </select>
                    </div>
                </div>
                
                <!-- Bottom Row: Controls (Scrollable) -->
                <div class="flex gap-2 overflow-x-auto pb-1 no-scrollbar">
                    <button id="btn-toggle-furigana" class="px-3 py-1 rounded text-xs font-bold whitespace-nowrap transition bg-sky-600 text-white border border-sky-500">
                        <i class="fas fa-eye mr-1"></i>Furi
                    </button>
                    <button id="btn-toggle-romaji" class="px-3 py-1 rounded text-xs font-bold whitespace-nowrap transition bg-sky-800 text-gray-300 border border-sky-800">
                        <i class="fas fa-font mr-1"></i>Romaji
                    </button>
                    <button id="btn-toggle-vi" class="px-3 py-1 rounded text-xs font-bold whitespace-nowrap transition bg-white text-sky-800">
                        <i class="fas fa-language mr-1"></i>Việt
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-2 py-4 flex-grow space-y-6 w-full max-w-full overflow-hidden" id="app">
        
        <!-- Progress Section -->
        <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-100">
            <div class="flex justify-between text-xs text-gray-500 mb-1 font-bold">
                <span>Tiến độ</span>
                <span id="progress-text">0%</span>
            </div>
            <div class="progress-container h-2 bg-gray-100 rounded-full overflow-hidden">
                <div id="progress-bar" class="progress-fill h-full bg-green-500 w-0 transition-all duration-500"></div>
            </div>
        </div>

        <!-- 1. Conversation Section -->
        <section class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100">
            <div class="bg-sky-50 px-4 py-3 border-b border-sky-100 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
                <h2 class="text-lg font-bold text-sky-800"><i class="fas fa-comments mr-2"></i>Hội Thoại</h2>
                <div class="flex bg-white rounded-lg p-0.5 border border-sky-200 shadow-sm self-end sm:self-auto">
                    <button onclick="switchMode('polite')" id="tab-polite" class="tab-btn tab-active px-3 py-1 rounded text-xs font-bold">Lịch sự</button>
                    <button onclick="switchMode('casual')" id="tab-casual" class="tab-btn tab-inactive px-3 py-1 rounded text-xs font-bold ml-1">Bạn bè</button>
                </div>
            </div>
            
            <div class="p-3 sm:p-5 space-y-4 bg-slate-50" id="conversation-container">
                <!-- Dialogue injected here -->
            </div>
            
            <div class="px-4 py-3 bg-white border-t border-gray-100 text-center">
                <button onclick="playAllConversation()" class="text-sm text-sky-600 font-bold hover:text-sky-800 transition">
                    <i class="fas fa-play-circle mr-1 text-lg align-middle"></i> Nghe toàn bộ hội thoại
                </button>
            </div>
        </section>

        <!-- 2. Reading Section -->
        <section class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100">
            <div class="bg-orange-50 px-4 py-3 border-b border-orange-100">
                <h2 class="text-lg font-bold text-orange-800"><i class="fas fa-book-open mr-2"></i>Bài Đọc</h2>
            </div>
            <div class="p-3 sm:p-5">
                <div class="bg-orange-50/50 p-4 rounded-lg border border-orange-100 leading-8 text-base kanji-font text-gray-800 mb-2 text-justify" id="reading-text"></div>
                <div class="text-gray-500 text-xs mb-3 italic hidden romaji-text bg-gray-50 p-2 rounded" id="reading-romaji"></div>
                <div class="text-gray-700 text-sm mb-4 hidden vi-trans border-t border-orange-100 pt-2" id="reading-vi"></div>
                
                <div class="mt-4 pt-3 border-t border-gray-100">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-xs font-bold text-gray-500 uppercase"><i class="fas fa-keyboard mr-1"></i> Luyện gõ:</h4>
                        <button onclick="speak(lessonData.reading.jp)" class="text-orange-500 hover:text-orange-700 text-xs font-bold"><i class="fas fa-volume-up mr-1"></i> Nghe bài</button>
                    </div>
                    <textarea id="reading-input" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-200 bg-gray-50 text-sm kanji-font h-28 resize-none" placeholder="Gõ lại bài đọc vào đây..."></textarea>
                    <div id="reading-feedback" class="text-xs mt-1 min-h-[1.2rem]"></div>
                </div>
            </div>
        </section>

        <!-- 3. Grammar Section -->
        <section class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100">
            <div class="bg-purple-50 px-4 py-3 border-b border-purple-100">
                <h2 class="text-lg font-bold text-purple-800"><i class="fas fa-star mr-2"></i>Ngữ Pháp</h2>
            </div>
            <div class="p-3 sm:p-5 grid grid-cols-1 md:grid-cols-2 gap-3" id="grammar-container"></div>
        </section>

        <!-- 4. Vocabulary Flashcards -->
        <section class="fade-in">
            <div class="flex items-center justify-between mb-3 px-1">
                <h2 class="text-lg font-bold text-gray-800"><i class="fas fa-tags mr-2 text-sky-600"></i>Từ Vựng</h2>
                <span class="text-xs text-gray-500 bg-white px-2 py-1 rounded shadow-sm border border-gray-100 font-mono" id="vocab-counter">1 / 20</span>
            </div>
            
            <div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden relative min-h-[400px]" id="vocab-card-container">
                <!-- Nav Buttons -->
                <button onclick="prevVocab()" class="absolute left-0 top-0 bottom-0 px-2 sm:px-4 text-gray-300 hover:text-sky-600 hover:bg-gray-50 transition z-10 focus:outline-none active:text-sky-500"><i class="fas fa-chevron-left text-2xl"></i></button>
                <button onclick="nextVocab()" class="absolute right-0 top-0 bottom-0 px-2 sm:px-4 text-gray-300 hover:text-sky-600 hover:bg-gray-50 transition z-10 focus:outline-none active:text-sky-500"><i class="fas fa-chevron-right text-2xl"></i></button>
                
                <!-- Content -->
                <div id="vocab-content" class="p-6 sm:p-10 text-center card-transition"></div>
            </div>
        </section>

        <!-- 5. Quiz Section -->
        <section class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100 mb-8">
            <div class="bg-emerald-50 px-4 py-3 border-b border-emerald-100 flex justify-between items-center">
                <h2 class="text-lg font-bold text-emerald-800"><i class="fas fa-question-circle mr-2"></i>Bài Tập</h2>
                <span class="text-xs bg-emerald-100 text-emerald-700 px-2 py-1 rounded font-bold" id="quiz-score">0/10</span>
            </div>
            <div class="p-4 space-y-6" id="quiz-container"></div>
            <div class="px-4 py-3 bg-gray-50 border-t border-gray-100 text-center">
                <button onclick="checkQuiz()" class="w-full sm:w-auto bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-8 rounded-lg shadow-md transform transition active:scale-95">
                    Nộp Bài
                </button>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-gray-400 py-6 mb-0">
        <div class="container mx-auto px-4 text-center text-sm">
            <p>&copy; 2025 AzaKanji Kaiwa.</p>
        </div>
    </footer>

    <!-- STROKE ORDER MODAL -->
    <div id="stroke-modal" class="fixed inset-0 z-[60] hidden" role="dialog" aria-modal="true">
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-black/80 backdrop-blur-sm transition-opacity" onclick="closeStrokeModal()"></div>
        
        <!-- Modal Content Center -->
        <div class="flex items-center justify-center min-h-screen px-4 py-4 pointer-events-none">
            <div class="bg-white rounded-xl w-full max-w-lg shadow-2xl overflow-hidden pointer-events-auto transform transition-all relative flex flex-col max-h-[90vh]">
                
                <!-- Header -->
                <div class="bg-sky-600 px-4 py-3 flex justify-between items-center text-white shrink-0">
                    <h3 class="font-bold text-lg flex items-center"><i class="fas fa-pen-nib mr-2"></i><span id="stroke-modal-char" class="text-2xl font-serif ml-1"></span></h3>
                    <button onclick="closeStrokeModal()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/20 transition"><i class="fas fa-times"></i></button>
                </div>
                
                <!-- Scrollable Content -->
                <div class="p-4 overflow-y-auto bg-gray-50">
                    <div class="flex flex-col items-center gap-6">
                        <!-- Animation Box -->
                        <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-200 text-center w-full sm:w-auto">
                            <p class="text-[10px] text-gray-400 mb-2 font-bold uppercase tracking-wider">Mô phỏng</p>
                            <div id="stroke-animation-container" class="w-40 h-40 mx-auto bg-white border border-gray-300 relative stroke-grid-box flex items-center justify-center">
                                <span class="text-xs text-gray-400"><i class="fas fa-spinner fa-spin mr-1"></i>Loading</span>
                            </div>
                            <button onclick="replayStrokeAnimation()" class="mt-3 w-full bg-sky-50 text-sky-700 px-3 py-2 rounded text-sm font-bold hover:bg-sky-100 transition flex items-center justify-center">
                                <i class="fas fa-redo-alt mr-2"></i> Viết lại
                            </button>
                        </div>
                        
                        <!-- Grid Steps -->
                        <div class="w-full">
                            <p class="text-[10px] text-gray-400 mb-2 font-bold uppercase tracking-wider text-center sm:text-left">Thứ tự nét</p>
                            <div id="stroke-grid-container" class="flex flex-wrap gap-2 justify-center sm:justify-start"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /* --- MOBILE FIX: Ensure viewport height is correct on mobile browsers --- */
        let vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
        window.addEventListener('resize', () => {
            let vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        });

        // --- DATA DAY 17 ---
        const lessonData = {
            conversation: {
                polite: [
                    { role: "Tanaka", jp: "鈴木[すずき]さん、駅前[えきまえ]に新[あたら]しいレストランができたので、一緒[いっしょ]に行[い]きませんか。", romaji: "Suzuki-san, ekimae ni atarashii resutoran ga dekita node, issho ni ikimasen ka.", vi: "Anh Suzuki, vì có một nhà hàng mới mở ở trước ga nên chúng ta đi cùng nhau không?" },
                    { role: "Suzuki", jp: "いいですね。どんな料理[りょうり]ですか。おいしそうですか。", romaji: "Ii desu ne. Donna ryouri desu ka. Oishisou desu ka.", vi: "Hay đấy. Món ăn như thế nào vậy? Trông có vẻ ngon không?" },
                    { role: "Tanaka", jp: "イタリア料理[りょうり]です。とても人気[にんき]があるので、おいしいでしょう。でも、ちょっと高[たか]そうです。", romaji: "Itaria ryouri desu. Totemo ninki ga aru node, oishii deshou. Demo, chotto takasou desu.", vi: "Là món Ý ạ. Vì rất được yêu thích nên chắc là ngon. Nhưng trông có vẻ hơi đắt." },
                    { role: "Suzuki", jp: "そうですか。昨日[きのう]お酒[さけ]を飲[の]みすぎたので、今日[きょう]はあまり食[た]べられません。", romaji: "Sou desu ka. Kinou osake o nomisugita node, kyou wa amari taberaremasen.", vi: "Vậy à. Vì hôm qua tôi uống quá nhiều rượu nên hôm nay không ăn được nhiều đâu." },
                    { role: "Tanaka", jp: "大丈夫[だいじょうぶ]ですよ。食[た]べるのは楽[たの]しいことですから、行[い]きましょう。", romaji: "Daijoubu desu yo. Taberu no wa tanoshii koto desu kara, ikimashou.", vi: "Không sao đâu. Vì việc ăn uống là một điều vui vẻ mà, chúng ta đi thôi." },
                    { role: "Suzuki", jp: "はい。この交差点[こうさてん]は事故[じこ]が起[お]きやすいので、気[き]をつけましょう。", romaji: "Hai. Kono kousaten wa jiko ga okiyasui node, ki o tsukemashou.", vi: "Vâng. Vì ngã tư này dễ xảy ra tai nạn nên chúng ta hãy cẩn thận nhé." }
                ],
                casual: [
                    { role: "Tanaka", jp: "鈴木[すずき]くん、駅前[えきまえ]に新[あたら]しいレストランができたから、一緒[いっしょ]に行[い]かない？", romaji: "Suzuki-kun, ekimae ni atarashii resutoran ga dekita kara, issho ni ikanai?", vi: "Suzuki, có nhà hàng mới mở trước ga, đi cùng không?" },
                    { role: "Suzuki", jp: "いいね。どんな料理[りょうり]？おいしそう？", romaji: "Ii ne. Donna ryouri? Oishisou?", vi: "Hay đó. Món gì thế? Trông ngon không?" },
                    { role: "Tanaka", jp: "イタリア料理[りょうり]だよ。すごく人気[にんき]があるから、おいしいだろうね。でも、ちょっと高[たか]そうだけど。", romaji: "Itaria ryouri da yo. Sugoku ninki ga aru kara, oishii darou ne. Demo, chotto takasou dakedo.", vi: "Món Ý đó. Vì nổi tiếng lắm nên chắc là ngon. Nhưng có vẻ hơi đắt." },
                    { role: "Suzuki", jp: "そっか。昨日[きのう]飲[の]みすぎたから、今日[きょう]はあまり食[た]べられないな。", romaji: "Sokka. Kinou nomisugita kara, kyou wa amari taberarenai na.", vi: "Vậy à. Hôm qua tớ uống quá chén nên nay không ăn được nhiều đâu." },
                    { role: "Tanaka", jp: "大丈夫[だいじょうぶ]だって。食[た]べるのは楽[たの]しいことだから、行[い]こうよ。", romaji: "Daijoubu datte. Taberu no wa tanoshii koto dakara, ikou yo.", vi: "Không sao đâu mà. Ăn uống là chuyện vui, đi thôi." },
                    { role: "Suzuki", jp: "うん。この交差点[こうさてん]、事故[じこ]が起[お]きやすいから、気[き]をつけよう。", romaji: "Un. Kono kousaten, jiko ga okiyasui kara, ki o tsukeyou.", vi: "Ừ. Ngã tư này dễ xảy ra tai nạn lắm, cẩn thận nhé." }
                ]
            },
            reading: {
                jp: "私[わたし]は昨日[きのう]、友達[ともだち]とレストランへ行[い]きました。そこは新[あたら]しくて、とてもきれいでした。料理[りょうり]はちょっと辛[から]そうでしたが、食[た]べてみると、とてもおいしかったです。しかし、食[た]べすぎたので、お腹[なか]が痛[いた]くなりました。薬[くすり]を飲[の]んで、すぐによくなりました。友達[ともだち]と話[はな]すのは楽[たの]しいです。このペンは書[か]きやすいので、いつも使[つか]っています。",
                romaji: "Watashi wa kinou, tomodachi to resutoran e ikimashita. Soko wa atarashikute, totemo kirei deshita. Ryouri wa chotto karasou deshita ga, tabete miru to, totemo oishikatta desu. Shikashi, tabesugita node, onaka ga itaku narimashita. Kusuri o nonde, sugu ni yoku narimashita. Tomodachi to hanasu no wa tanoshii desu. Kono pen wa kakiyasui node, itsumo tsukatte imasu.",
                vi: "Hôm qua tôi đã đi đến nhà hàng cùng với bạn. Nơi đó mới và rất sạch đẹp. Món ăn trông có vẻ hơi cay nhưng khi ăn thử thì rất ngon. Tuy nhiên, vì đã ăn quá nhiều nên tôi đã bị đau bụng. Tôi uống thuốc và đã khỏe lại ngay. Việc nói chuyện với bạn bè rất vui. Vì cái bút này dễ viết nên tôi luôn sử dụng nó."
            },
            grammar: [
                { rule: "～がします", meaning: "Có (mùi, vị, âm thanh...)", formula: "N + がします", mean: "Cảm nhận giác quan.", ex: "変[へん]なにおいがします。", vi: "Có mùi lạ." },
                { rule: "～すぎます", meaning: "Quá...", formula: "V/A + すぎます", mean: "Vượt quá giới hạn.", ex: "この服[ふく]は大[おお]きすぎます。", vi: "Áo này quá rộng." },
                { rule: "～ので", meaning: "Bởi vì...", formula: "Thể thường + ので", mean: "Nguyên nhân (lịch sự).", ex: "事故[じこ]があったので遅[おく]れました。", vi: "Vì tai nạn nên tôi trễ." },
                { rule: "～のは～です", meaning: "Việc...", formula: "Vる + のは", mean: "Danh từ hóa.", ex: "絵[え]をかくのは楽[たの]しいです。", vi: "Vẽ tranh rất vui." },
                { rule: "～そうです", meaning: "Trông có vẻ", formula: "V/A + そうです", mean: "Phỏng đoán thị giác.", ex: "おいしそうです。", vi: "Trông ngon quá." },
                { rule: "～やすい", meaning: "Dễ làm", formula: "V(masu) + やすい", mean: "Dễ thực hiện.", ex: "このペンは書[か]きやすい。", vi: "Bút này dễ viết." }
            ],
            vocab: [
                { k: "駅", h: "えき", on: "エキ", kun: "-", m: "Nhà ga", hv: "DỊCH", ti: "Ngựa (**馬**) đứng đợi ở Dịch (**尺**) trạm.", ta: "Đi bộ mỏi **Ê** (**Eki**) mông.", compounds: [{w: "駅前", r: "えきまえ", m: "Trước ga"}] },
                { k: "新", h: "あたら", on: "シン", kun: "あたら.しい", m: "Mới", hv: "TÂN", ti: "Đứng (**立**) trên cây (**木**) đẽo rìu (**斤**).", ta: "**A ta ra** (**Atara**) cái ghế mới **Xinh** (**Shin**).", compounds: [{w: "新しい", r: "あたらしい", m: "Mới"}] },
                { k: "理", h: "り", on: "リ", kun: "ことわり", m: "Lý", hv: "LÝ", ti: "Vua (**王**) trong làng (**里**) giảng đạo lý.", ta: "**Li** (**Ri**) biệt là vô **Lý**.", compounds: [{w: "料理", r: "りょうり", m: "Món ăn"}] },
                { k: "最", h: "もっと", on: "サイ", kun: "もっと.も", m: "Nhất", hv: "TỐI", ti: "Mặt trời (**日**) lắng nghe (**取**).", ta: "**Mốt tồ** (**Motto**) là **Sai** (**Sai**) nhất.", compounds: [{w: "最近", r: "さいきん", m: "Gần đây"}] },
                { k: "昨", h: "さく", on: "サク", kun: "-", m: "Hôm qua", hv: "TẠC", ti: "Mặt trời (**日**) đã lặn (**乍**).", ta: "**Sa cư** (**Saku**) ra nở hôm qua.", compounds: [{w: "昨日", r: "きのう", m: "Hôm qua"}] },
                { k: "痛", h: "いた", on: "ツウ", kun: "いた.い", m: "Đau", hv: "THỐNG", ti: "Bệnh (**疒**) dùng Dụng (**甬**) cụ chữa.", ta: "**Y tá** (**Ita**) tiêm **Đau**.", compounds: [{w: "痛い", r: "いたい", m: "Đau"}] },
                { k: "薬", h: "くすり", on: "ヤク", kun: "くすり", m: "Thuốc", hv: "DƯỢC", ti: "Cỏ (**艹**) phơi vui (**楽**) làm thuốc.", ta: "**Cư sử** (**Kusu**) thi uống thuốc.", compounds: [{w: "薬", r: "くすり", m: "Thuốc"}] },
                { k: "交", h: "こう", on: "コウ", kun: "まじ.わる", m: "Giao", hv: "GIAO", ti: "Cha (**父**) đội nón đi Giao lưu.", ta: "**Cô** (**Kou**) giáo đi **Giao** lưu.", compounds: [{w: "交差点", r: "こうさてん", m: "Ngã tư"}] },
                { k: "差", h: "さ", on: "サ", kun: "さ.す", m: "Sai/Khác", hv: "SAI", ti: "Dê (**羊**) làm công (**工**) việc Sai.", ta: "**Xa** (**Sa**) nhau dễ hiểu **Sai**.", compounds: [{w: "交差点", r: "こうさてん", m: "Ngã tư"}] },
                { k: "点", h: "てん", on: "テン", kun: "-", m: "Điểm", hv: "ĐIỂM", ti: "Chiếm (**占**) bốn đốm lửa (**灬**).", ta: "10 điểm lên **Thiên** (**Ten**) đàng.", compounds: [{w: "交差点", r: "こうさてん", m: "Ngã tư"}] },
                { k: "気", h: "き", on: "キ", kun: "-", m: "Khí", hv: "KHÍ", ti: "Hơi (**气**) bốc từ Gạo (**米**).", ta: "**Kì** (**Ki**) lạ thật.", compounds: [{w: "気をつける", r: "きをつける", m: "Cẩn thận"}] },
                { k: "料", h: "りょう", on: "リョウ", kun: "-", m: "Liệu", hv: "LIỆU", ti: "Gạo (**米**) đong bằng Đấu (**斗**).", ta: "**Rượu** (**Ryou**) là nguyên **Liệu**.", compounds: [{w: "料理", r: "りょうり", m: "Món ăn"}] },
                { k: "辛", h: "から", on: "シン", kun: "から.い", m: "Cay", hv: "TÂN", ti: "Đứng (**立**) mười (**十**) lần chịu cay.", ta: "Ăn **Cà ra** (**Kara**) bị **Cay**.", compounds: [{w: "辛い", r: "からい", m: "Cay"}] },
                { k: "飲", h: "の", on: "イン", kun: "の.む", m: "Uống", hv: "ẨM", ti: "Ăn (**飠**) thiếu (**欠**) nước thì Uống.", ta: "**No** (**No**) vẫn **Uống** nước **In** (**In**) hình.", compounds: [{w: "飲む", r: "のむ", m: "Uống"}] },
                { k: "楽", h: "たの", on: "ラク", kun: "たの.しい", m: "Vui", hv: "LẠC", ti: "Cây (**木**) sồi trắng (**白**) trên băng (**冫**).", ta: "**Ta nổ** (**Tano**) pháo tay **Vui**.", compounds: [{w: "楽しい", r: "たのしい", m: "Vui vẻ"}] },
                { k: "事", h: "こと", on: "ジ", kun: "こと", m: "Việc", hv: "SỰ", ti: "Miệng (**口**) nói, tay (**彐**) viết.", ta: "**Cô tô** (**Koto**) có **Sự** việc **Gì** (**Ji**).", compounds: [{w: "事故", r: "じこ", m: "Tai nạn"}] },
                { k: "故", h: "こ", on: "コ", kun: "ゆえ", m: "Cố", hv: "CỐ", ti: "Người xưa (**古**) đánh (**攵**) nhau.", ta: "**Cô** (**Ko**) ấy gặp sự **Cố**.", compounds: [{w: "事故", r: "じこ", m: "Tai nạn"}] },
                { k: "腹", h: "はら", on: "フク", kun: "はら", m: "Bụng", hv: "PHÚC", ti: "Thịt (**月**) quay lại (**復**) bụng.", ta: "**Ha ra** (**Hara**) cái **Bụng** **Phúc** (**Fuku**) hậu.", compounds: [{w: "お腹", r: "おなか", m: "Bụng"}] },
                { k: "書", h: "か", on: "ショ", kun: "か.く", m: "Viết", hv: "THƯ", ti: "Cầm bút (**聿**) Viết lên mặt trời (**日**).", ta: "**Ca** (**Ka**) sĩ **Viết** thư **Sơ** (**Sho**) sài.", compounds: [{w: "書く", r: "かく", m: "Viết"}] },
                { k: "良", h: "よ", on: "リョウ", kun: "よ.い", m: "Tốt", hv: "LƯƠNG", ti: "Chấm trên Cấn (**艮**).", ta: "**Yo** (**Yo**)! **Tốt** đẹp **Liệu** (**Ryou**) có tin?", compounds: [{w: "良い", r: "よい", m: "Tốt"}] }
            ],
            quiz: [
                { type: 'mcq', question: "この靴[くつ]は歩[ある]き（___）。", options: ["そうです", "やすいです", "すぎます"], correct: 1, explain: "V(bỏ mas) + やすい: Dễ làm gì đó. Aruk-iyasui: Dễ đi bộ." },
                { type: 'fill', question: "昨日[きのう]テレビを見（___）ので、今日[きょう]は眠[ねむ]いです。", answer: "すぎた", explain: "V(bỏ mas) + すぎた: Làm gì quá mức." },
                { type: 'mcq', question: "このカレーは（___）そうです。", options: ["辛[から]", "辛[からい]", "辛[からく]"], correct: 0, explain: "A(bỏ i) + そうです: Trông có vẻ (Karasou - Trông cay)." },
                { type: 'audio', question: "Nghe và gõ lại câu bạn vừa nghe:", jp: "事故があったので、電車が遅れました。", explain: "Vì có tai nạn nên tàu đến muộn." },
                { type: 'mcq', question: "Chữ 料理 đọc là gì?", options: ["りゅうり", "りょうり", "りょり"], correct: 1, explain: "料理 (Ryouri) - Món ăn." },
                { type: 'fill', question: "絵[え]をかく（___）は楽[たの]しいです。", answer: "の", explain: "V-ru + のは: Danh từ hóa động từ." },
                { type: 'mcq', question: "Chữ Hán nào có nghĩa là 'Tân' (Mới)?", options: ["親", "新", "辛"], correct: 1, explain: "新 (Atarashii - Mới)." },
                { type: 'mcq', question: "このペンは（___）やすいです。", options: ["書[か]く", "書[か]き", "書[か]いた"], correct: 1, explain: "V(bỏ mas) + やすい: Kakimasu -> Kaki-yasui." },
                { type: 'audio', question: "Nghe và điền từ còn thiếu:", jp: "イタリア料理です。とても人気があります。", explain: "Itaria ryouri desu. Totemo ninki ga arimasu." },
                { type: 'mcq', question: "Chữ 交差点 có nghĩa là gì?", options: ["Ngã tư", "Đèn đỏ", "Cảnh sát"], correct: 0, explain: "Kousaten - Ngã tư." }
            ]
        };

        // --- CORE LOGIC ---
        let currentMode = 'polite';
        let showFurigana = true, showRomaji = false, showVi = true;
        let currentVocabIndex = 0; 
        let currentSpeed = 1.0;
        let recognition = null, isRecognizing = false;

        const parseFurigana = (text) => text ? text.replace(/([^\[\]]+)\[(.+?)\]/g, '<ruby>$1<rt>$2</rt></ruby>') : '';
        const cleanText = (text) => text ? text.replace(/\[.*?\]/g, '') : '';

        // Audio
        function speak(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(cleanText(text));
                u.lang = 'ja-JP'; u.rate = currentSpeed;
                // Try to use Google Japanese if available for better quality
                const voices = window.speechSynthesis.getVoices();
                const jpVoice = voices.find(v => v.name.includes('Google') && v.lang === 'ja-JP') || voices.find(v => v.lang === 'ja-JP');
                if(jpVoice) u.voice = jpVoice;
                window.speechSynthesis.speak(u);
            }
        }

        // --- RENDER CONVERSATION (Mobile Optimized) ---
        function renderConversation() {
            const container = document.getElementById('conversation-container');
            const lines = lessonData.conversation[currentMode];
            container.innerHTML = lines.map((line, idx) => `
                <div class="flex gap-2 fade-in ${line.role === 'Tanaka' ? '' : 'flex-row-reverse'} items-end">
                    <div class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 rounded-full flex items-center justify-center font-bold text-white shadow-sm text-xs sm:text-sm ${line.role === 'Tanaka' ? 'bg-sky-500' : 'bg-green-500'}">
                        ${line.role[0]}
                    </div>
                    <div class="flex-1 min-w-0 max-w-[85%]">
                        <div class="bg-white p-2 sm:p-3 rounded-2xl shadow-sm border border-gray-200 relative group ${line.role === 'Tanaka' ? 'rounded-bl-none' : 'rounded-br-none bg-green-50/50'}">
                            <p class="text-base sm:text-lg text-gray-800 kanji-font leading-normal">${parseFurigana(line.jp)}</p>
                            <p class="text-xs text-gray-500 romaji-text hidden italic mt-1 leading-tight">${line.romaji}</p>
                            <p class="text-xs sm:text-sm text-gray-600 vi-trans border-t border-gray-100 pt-1 mt-1 leading-tight">${line.vi}</p>
                            
                            <div class="mt-2 pt-2 border-t border-gray-100 flex gap-2 items-center">
                                <button onclick="speak('${line.jp}')" class="text-gray-400 hover:text-sky-600 p-1"><i class="fas fa-volume-up"></i></button>
                                <div class="flex-1 relative">
                                    <input type="text" id="convo-input-${idx}" class="w-full text-xs sm:text-sm p-1.5 border rounded focus:outline-none focus:border-sky-400 bg-gray-50 min-w-0" placeholder="Gõ lại..." oninput="checkTyping(this, '${line.jp}', this.nextElementSibling)">
                                    <div class="h-1 bg-gray-200 rounded-full mt-1 w-0 transition-all duration-300"></div>
                                </div>
                                <button id="mic-btn-convo-input-${idx}" onclick="startListening('convo-input-${idx}')" class="text-gray-400 hover:text-red-500 p-1"><i class="fas fa-microphone"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            updateUI();
        }

        function checkTyping(input, correctText, progressBar) {
            const userText = input.value;
            const target = cleanText(correctText);
            if (userText === target) {
                input.classList.add('correct-input');
                input.classList.remove('wrong-input');
                progressBar.style.width = '100%';
                progressBar.classList.add('bg-green-500');
            } else if (target.startsWith(userText) && userText.length > 0) {
                input.classList.remove('wrong-input');
                input.classList.remove('correct-input');
                const pct = (userText.length / target.length) * 100;
                progressBar.style.width = `${pct}%`;
                progressBar.classList.remove('bg-green-500');
            } else if (userText.length > 0) {
                input.classList.add('wrong-input');
            }
        }

        // --- OTHER RENDER FUNCTIONS (Grammar, Vocab, Quiz) - Simplified for brevity ---
        // (Similar logic to previous versions but with mobile classes)
        function renderGrammar() {
            const container = document.getElementById('grammar-container');
            container.innerHTML = lessonData.grammar.map(g => `
                <div class="bg-white p-3 rounded-lg border border-purple-100 shadow-sm hover:shadow-md transition">
                    <h3 class="font-bold text-purple-700 text-base mb-1 flex items-center"><span class="w-1.5 h-1.5 bg-purple-500 rounded-full mr-2"></span>${g.rule}</h3>
                    <div class="text-xs text-gray-500 mb-1 font-mono bg-gray-50 inline-block px-1 rounded">${g.formula}</div>
                    <p class="text-sm text-gray-700 mb-2">${g.mean}</p>
                    <div class="text-sm text-gray-600 bg-purple-50 p-2 rounded relative">
                        ${parseFurigana(g.ex)}
                        <p class="text-xs text-gray-500 italic mt-0.5">${g.vi}</p>
                        <button onclick="speak('${g.ex}')" class="absolute top-1 right-1 text-purple-300 hover:text-purple-600"><i class="fas fa-volume-up"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function renderVocab() {
            const container = document.getElementById('vocab-content');
            const v = lessonData.vocab[currentVocabIndex];
            
            // Mobile optimized Vocab Card
            container.innerHTML = `
                <div class="flex flex-col items-center animate-fade-in relative">
                    <!-- Main Kanji -->
                    <div class="text-5xl sm:text-7xl font-bold text-gray-800 kanji-font mb-2 cursor-pointer hover:text-sky-600 transition" onclick="showStrokeOrder('${v.k}')">${v.k}</div>
                    
                    <button onclick="showStrokeOrder('${v.k}')" class="text-xs bg-sky-50 text-sky-600 px-3 py-1 rounded-full mb-4 border border-sky-100"><i class="fas fa-pen-nib mr-1"></i>Tập viết</button>
                    
                    <!-- Readings Grid -->
                    <div class="grid grid-cols-2 gap-3 w-full max-w-sm mb-4">
                        <div class="bg-gray-50 p-2 rounded text-center border border-gray-100">
                            <span class="text-[10px] text-gray-400 uppercase font-bold block mb-1">On'yomi</span>
                            <div class="flex items-center justify-center gap-1">
                                <span class="font-bold text-sm sm:text-base">${v.on}</span>
                                <button onclick="speak('${v.on}')" class="text-sky-400 hover:text-sky-600"><i class="fas fa-volume-up text-xs"></i></button>
                            </div>
                        </div>
                        <div class="bg-gray-50 p-2 rounded text-center border border-gray-100">
                            <span class="text-[10px] text-gray-400 uppercase font-bold block mb-1">Kun'yomi</span>
                            <div class="flex items-center justify-center gap-1">
                                <span class="font-bold text-sm sm:text-base">${v.kun}</span>
                                <button onclick="speak('${v.kun.replace(/\./g,'')}')" class="text-sky-400 hover:text-sky-600"><i class="fas fa-volume-up text-xs"></i></button>
                            </div>
                        </div>
                    </div>

                    <!-- Meaning -->
                    <div class="mb-4 text-center">
                        <span class="inline-block text-[10px] font-bold text-white bg-gray-400 px-2 py-0.5 rounded mb-1">${v.hv}</span>
                        <div class="text-xl sm:text-2xl font-bold text-sky-700 border-b-2 border-sky-50 pb-2 px-4">${v.m}</div>
                    </div>

                    <!-- Mnemonics (Stack on mobile) -->
                    <div class="w-full text-left space-y-2 text-sm bg-gray-50 p-3 rounded-lg border border-gray-100">
                        <div class="flex gap-2">
                            <span class="text-orange-500 font-bold shrink-0"><i class="fas fa-image"></i></span>
                            <span class="text-gray-700">${v.ti.replace(/\*\*(.*?)\*\*/g, '<b class="text-gray-900">$1</b>')}</span>
                        </div>
                        <div class="border-t border-gray-200 my-1"></div>
                        <div class="flex gap-2">
                            <span class="text-blue-500 font-bold shrink-0"><i class="fas fa-music"></i></span>
                            <span class="text-gray-700">${v.ta.replace(/\*\*(.*?)\*\*/g, '<b class="text-sky-700">$1</b>')}</span>
                        </div>
                    </div>
                    
                    <!-- Compounds -->
                    <div class="mt-3 w-full flex flex-wrap gap-2 justify-center">
                        ${v.compounds.map(c => `<span class="text-xs bg-white border border-gray-200 px-2 py-1 rounded cursor-pointer hover:bg-gray-50" onclick="speak('${c.r}')">${c.w}</span>`).join('')}
                    </div>
                </div>
            `;
            document.getElementById('vocab-counter').innerText = `${currentVocabIndex + 1} / ${lessonData.vocab.length}`;
        }

        // --- INIT & UTILS ---
        function switchMode(mode) {
            currentMode = mode;
            document.getElementById('tab-polite').className = mode === 'polite' ? "tab-btn bg-sky-600 text-white px-3 py-1 rounded text-xs font-bold shadow-sm" : "tab-btn text-gray-500 hover:bg-gray-100 px-3 py-1 rounded text-xs font-bold ml-1";
            document.getElementById('tab-casual').className = mode === 'casual' ? "tab-btn bg-sky-600 text-white px-3 py-1 rounded text-xs font-bold shadow-sm ml-1" : "tab-btn text-gray-500 hover:bg-gray-100 px-3 py-1 rounded text-xs font-bold ml-1";
            renderConversation();
        }

        function updateUI() {
            document.querySelectorAll('rt').forEach(rt => rt.style.visibility = showFurigana ? 'visible' : 'hidden');
            document.getElementById('btn-toggle-furigana').className = showFurigana ? "px-3 py-1 rounded text-xs font-bold bg-sky-600 text-white border border-sky-500" : "px-3 py-1 rounded text-xs font-bold bg-white text-sky-700 border border-sky-200";
            document.querySelectorAll('.romaji-text').forEach(el => el.classList.toggle('hidden', !showRomaji));
            document.getElementById('btn-toggle-romaji').className = showRomaji ? "px-3 py-1 rounded text-xs font-bold bg-sky-800 text-white border border-sky-800" : "px-3 py-1 rounded text-xs font-bold bg-white text-sky-900 border border-sky-200";
            document.querySelectorAll('.vi-trans').forEach(p => p.style.display = showVi ? 'block' : 'none');
            document.getElementById('btn-toggle-vi').className = showVi ? "px-3 py-1 rounded text-xs font-bold bg-orange-500 text-white border border-orange-500" : "px-3 py-1 rounded text-xs font-bold bg-white text-orange-600 border border-orange-200";
        }

        document.getElementById('btn-toggle-furigana').onclick = () => { showFurigana = !showFurigana; updateUI(); };
        document.getElementById('btn-toggle-romaji').onclick = () => { showRomaji = !showRomaji; updateUI(); };
        document.getElementById('btn-toggle-vi').onclick = () => { showVi = !showVi; updateUI(); };

        // Stroke Order Logic (Simplified for brevity - keep your existing implementation)
        function getKanjiHex(kanji) { return kanji.charCodeAt(0).toString(16).padStart(5, '0'); }
        async function showStrokeOrder(kanji) {
            document.getElementById('stroke-modal').classList.remove('hidden');
            document.getElementById('stroke-modal-char').innerText = kanji;
            const anim = document.getElementById('stroke-animation-container');
            const grid = document.getElementById('stroke-grid-container');
            anim.innerHTML = '<span class="text-xs text-gray-400">Loading...</span>'; grid.innerHTML = '';
            
            try {
                const res = await fetch(`https://cdn.jsdelivr.net/gh/KanjiVG/kanjivg/kanji/${getKanjiHex(kanji)}.svg`);
                if(!res.ok) throw new Error();
                const svg = await res.text();
                anim.innerHTML = svg;
                const mainSvg = anim.querySelector('svg');
                mainSvg.setAttribute('width', '100%'); mainSvg.setAttribute('height', '100%');
                const paths = mainSvg.querySelectorAll('path');
                
                // Grid generation
                paths.forEach((p, i) => {
                    // Animation setup
                    const len = p.getTotalLength();
                    p.style.strokeDasharray = len; p.style.strokeDashoffset = len;
                    
                    // Grid item
                    const box = document.createElement('div');
                    box.className = "w-12 h-12 bg-white border border-gray-200 relative stroke-grid-box flex items-center justify-center";
                    const clone = mainSvg.cloneNode(true);
                    clone.querySelectorAll('path').forEach((cp, ci) => {
                        cp.style.stroke = ci === i ? '#000' : (ci < i ? '#ccc' : 'none');
                        cp.style.strokeDasharray = ''; cp.style.strokeDashoffset = '';
                    });
                    box.appendChild(clone);
                    grid.appendChild(box);
                });
                replayStrokeAnimation();
            } catch(e) { anim.innerHTML = 'Error'; }
        }
        function replayStrokeAnimation() {
            const paths = document.querySelectorAll('#stroke-animation-container path');
            paths.forEach(p => { p.style.transition = 'none'; p.style.strokeDashoffset = p.getTotalLength(); });
            setTimeout(() => {
                let delay = 0;
                paths.forEach(p => {
                    p.style.transition = `stroke-dashoffset 0.6s ease-in-out ${delay}s`;
                    p.style.strokeDashoffset = '0';
                    delay += 0.6;
                });
            }, 50);
        }
        function closeStrokeModal() { document.getElementById('stroke-modal').classList.add('hidden'); }

        // Speech & Mic (Keep your existing implementation)
        function startListening(id) {
            if (!('webkitSpeechRecognition' in window)) { alert("Trình duyệt không hỗ trợ"); return; }
            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'ja-JP';
            const btn = document.getElementById(`mic-btn-${id}`);
            btn.classList.add('mic-listening');
            recognition.onresult = (e) => {
                document.getElementById(id).value = e.results[0][0].transcript;
                document.getElementById(id).dispatchEvent(new Event('input'));
                btn.classList.remove('mic-listening');
            };
            recognition.onend = () => btn.classList.remove('mic-listening');
            recognition.start();
        }
        
        function playAllConversation() {
            const lines = lessonData.conversation[currentMode];
            let i = 0;
            function playNext() {
                if (i >= lines.length) return;
                speak(lines[i].jp);
                // Simple timeout simulation for demo. In real app, use onend event of utterance.
                setTimeout(() => { i++; playNext(); }, 3000); 
            }
            playNext();
        }

        // Quiz Logic & Nav (Vocab)
        function prevVocab() { if(currentVocabIndex > 0) { currentVocabIndex--; renderVocab(); } }
        function nextVocab() { if(currentVocabIndex < lessonData.vocab.length - 1) { currentVocabIndex++; renderVocab(); } }
        
        function renderQuiz() {
            const c = document.getElementById('quiz-container');
            c.innerHTML = lessonData.quiz.map((q, i) => `
                <div class="border-b border-gray-100 pb-4 last:border-0" id="q-${i}">
                    <p class="font-bold text-gray-800 mb-2 text-sm"><span class="text-emerald-600 mr-1">Q${i+1}:</span> ${q.type==='audio'?'(Nghe)':parseFurigana(q.question)}</p>
                    ${q.type === 'audio' ? `<button onclick="speak('${q.jp}')" class="mb-2 text-sky-500 text-sm font-bold"><i class="fas fa-volume-up"></i> Nghe</button>` : ''}
                    <div class="space-y-2">
                        ${q.type === 'mcq' ? q.options.map(o => `<label class="flex items-center p-2 border rounded hover:bg-gray-50 cursor-pointer text-sm"><input type="radio" name="q${i}" value="${o}" class="mr-2 text-emerald-500 focus:ring-emerald-500"><span class="kanji-font">${parseFurigana(o)}</span></label>`).join('') : `<input type="text" class="w-full p-2 border rounded text-sm bg-gray-50" placeholder="Nhập câu trả lời..." id="input-q${i}">`}
                    </div>
                    <div class="mt-2 text-xs hidden feedback bg-gray-50 p-2 rounded"></div>
                </div>
            `).join('');
        }
        
        function checkQuiz() {
            let score = 0;
            lessonData.quiz.forEach((q, i) => {
                const el = document.getElementById(`q-${i}`);
                const fb = el.querySelector('.feedback');
                fb.classList.remove('hidden');
                let correct = false;
                if(q.type === 'mcq') {
                    const sel = el.querySelector(`input:checked`);
                    if(sel && (q.options.indexOf(sel.value) === q.correct || sel.value === q.options[q.correct])) correct = true;
                } else {
                    const val = document.getElementById(`input-q${i}`).value.trim();
                    if(q.type === 'audio' ? val === cleanText(q.jp) : val === q.answer) correct = true;
                }
                
                if(correct) {
                    score++;
                    fb.innerHTML = `<span class="text-green-600 font-bold"><i class="fas fa-check"></i> Đúng!</span> ${q.explain}`;
                } else {
                    fb.innerHTML = `<span class="text-red-600 font-bold"><i class="fas fa-times"></i> Sai.</span> Đáp án: ${q.type==='mcq'?q.options[q.correct]:(q.answer||q.jp)}<br><span class="text-gray-500">${q.explain}</span>`;
                }
            });
            document.getElementById('quiz-score').innerText = `${score}/10`;
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            renderConversation();
            document.getElementById('reading-text').innerHTML = parseFurigana(lessonData.reading.jp);
            renderGrammar();
            renderVocab();
            renderQuiz();
            updateUI();
        });
    </script>
</body>
</html>
