<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AzaKanji - Hội Thoại & Ngữ Pháp (Day 17)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #f3f4f6; overflow-x: hidden; }
        .kanji-font { font-family: 'Noto Sans JP', sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Ruby Text Styling */
        ruby rt { font-size: 0.6em; color: #64748b; user-select: none; }
        .hide-furigana ruby rt { visibility: hidden; }

        /* Animations */
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .card-transition { transition: all 0.3s ease-in-out; }
        
        /* Highlight classes for Typing */
        .correct-char { color: #16a34a; font-weight: bold; }
        .incorrect-char { color: #dc2626; text-decoration: underline; font-weight: bold; }
        .correct-input { border-color: #22c55e !important; background-color: #f0fdf4 !important; }
        .wrong-input { border-color: #ef4444 !important; background-color: #fef2f2 !important; }
        
        /* Microphone Animation */
        .mic-listening { animation: pulse-red 1.5s infinite; color: #dc2626 !important; border-color: #dc2626 !important; }
        @keyframes pulse-red { 
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); } 
            70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); } 
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } 
        }

        /* Tab Transitions */
        .tab-btn { transition: all 0.3s ease; }
        .tab-active { background-color: #0284c7; color: white; shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .tab-inactive { background-color: #f3f4f6; color: #4b5563; }
        .tab-inactive:hover { background-color: #e5e7eb; }

        /* Progress Bar */
        .progress-container { background-color: #e5e7eb; border-radius: 999px; height: 8px; width: 100%; overflow: hidden; margin-top: 10px; }
        .progress-fill { background-color: #10b981; height: 100%; width: 0%; transition: width 0.5s ease-in-out; }

        /* Active playing line */
        .playing-line { border-left: 4px solid #0ea5e9; background-color: #f0f9ff !important; }

        /* STROKE ORDER STYLES */
        .stroke-path {
            fill: none;
            stroke: #333;
            stroke-width: 3;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .stroke-grid-box {
            border: 1px solid #e5e7eb;
            background-color: white;
            position: relative;
        }
        /* Dotted lines for kanji grid */
        .stroke-grid-box::after {
            content: ''; position: absolute; top: 0; left: 50%; width: 1px; height: 100%;
            background: repeating-linear-gradient(to bottom, #ddd 0, #ddd 4px, transparent 4px, transparent 8px); z-index: 0;
        }
        .stroke-grid-box::before {
            content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 1px;
            background: repeating-linear-gradient(to right, #ddd 0, #ddd 4px, transparent 4px, transparent 8px); z-index: 0;
        }

        /* Mobile Optimization for Quiz Options */
        .quiz-option {
            touch-action: manipulation; /* Improves touch response */
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Header -->
    <header class="bg-sky-700 text-white shadow-lg sticky top-0 z-40">
        <div class="container mx-auto px-4 py-3">
            <div class="flex flex-col md:flex-row justify-between items-center gap-3">
                <!-- Logo Area -->
                <div class="flex items-center space-x-3 cursor-pointer self-start md:self-auto" onclick="location.reload()">
                    <i class="fas fa-torii-gate text-2xl md:text-3xl text-yellow-300"></i>
                    <div>
                        <h1 class="text-lg md:text-xl font-bold uppercase tracking-wider leading-tight">AzaKanji Kaiwa</h1>
                        <p class="text-[10px] md:text-xs text-sky-200">Học Hội Thoại & Ngữ Pháp (Day 17)</p>
                    </div>
                </div>
                
                <!-- Controls (Scrollable on mobile) -->
                <div class="w-full md:w-auto flex items-center overflow-x-auto pb-1 md:pb-0 no-scrollbar">
                    <div class="flex bg-sky-800 rounded-lg p-1 text-sm whitespace-nowrap mx-auto md:mx-0">
                        <button id="btn-toggle-furigana" class="px-2 md:px-3 py-1.5 rounded transition hover:bg-sky-600 text-white flex items-center" title="Bật/Tắt cách đọc Kanji">
                            <i class="fas fa-eye mr-1 md:mr-2"></i> Furi
                        </button>
                        <button id="btn-toggle-romaji" class="px-2 md:px-3 py-1.5 rounded transition hover:bg-sky-600 text-white flex items-center ml-1" title="Bật/Tắt phiên âm Romaji">
                            <i class="fas fa-font mr-1 md:mr-2"></i> Romaji
                        </button>
                        <button id="btn-toggle-vi" class="px-2 md:px-3 py-1.5 rounded transition bg-white text-sky-800 font-bold ml-1 flex items-center" title="Bật/Tắt dịch tiếng Việt">
                            <i class="fas fa-language mr-1 md:mr-2"></i> Việt
                        </button>
                        
                        <!-- Audio Speed Control -->
                        <div class="flex items-center px-2 ml-1 border-l border-sky-600 text-white">
                            <i class="fas fa-tachometer-alt mr-1 text-sky-300 text-xs"></i>
                            <select id="audio-speed" class="bg-transparent border-none focus:ring-0 text-white font-bold cursor-pointer text-xs p-0">
                                <option value="0.75" class="text-gray-800">0.75x</option>
                                <option value="1.0" class="text-gray-800" selected>1.0x</option>
                                <option value="1.25" class="text-gray-800">1.25x</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-3 md:px-4 py-4 md:py-8 flex-grow space-y-6 md:space-y-8" id="app">
        
        <!-- Progress Section -->
        <div class="w-full max-w-4xl mx-auto mb-2 bg-white p-3 rounded-lg shadow-sm border border-gray-100">
            <div class="flex justify-between text-xs text-gray-500 mb-1 font-bold">
                <span>Tiến độ học tập</span>
                <span id="progress-text">0%</span>
            </div>
            <div class="progress-container">
                <div id="progress-bar" class="progress-fill"></div>
            </div>
        </div>

        <!-- 1. Conversation Section -->
        <section class="bg-white rounded-xl md:rounded-2xl shadow-md overflow-hidden fade-in border border-gray-100">
            <div class="bg-sky-50 px-4 md:px-6 py-3 md:py-4 border-b border-sky-100">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-3">
                    <h2 class="text-lg md:text-xl font-bold text-sky-800 flex items-center flex-wrap">
                        <span class="flex items-center"><i class="fas fa-comments mr-2"></i>Hội Thoại: Nhà Hàng Mới</span>
                        <button onclick="playAllConversation()" class="ml-auto md:ml-3 text-xs md:text-sm bg-sky-100 text-sky-700 hover:bg-sky-200 px-3 py-1 rounded-full transition flex items-center whitespace-nowrap">
                            <i class="fas fa-play mr-1"></i> Nghe hết
                        </button>
                    </h2>
                    
                    <!-- Mode Tabs -->
                    <div class="flex bg-white rounded-lg p-1 shadow-sm border border-gray-200 w-full md:w-auto">
                        <button onclick="switchMode('polite')" id="tab-polite" class="tab-btn tab-active flex-1 md:flex-none px-2 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-bold text-center">Lịch sự</button>
                        <button onclick="switchMode('casual')" id="tab-casual" class="tab-btn tab-inactive flex-1 md:flex-none px-2 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-bold ml-1 text-center">Thông thường</button>
                    </div>
                </div>
            </div>
            
            <div class="p-3 md:p-6 space-y-4 md:space-y-6" id="conversation-container">
                <!-- Dialogue injected by JS -->
            </div>
        </section>

        <!-- 2. Reading Section -->
        <section class="bg-white rounded-xl md:rounded-2xl shadow-md overflow-hidden fade-in border border-gray-100">
            <div class="bg-orange-50 px-4 md:px-6 py-3 md:py-4 border-b border-orange-100">
                <h2 class="text-lg md:text-xl font-bold text-orange-800"><i class="fas fa-book-open mr-2"></i>Bài Đọc: Cảm Giác & Phán Đoán</h2>
            </div>
            <div class="p-4 md:p-6">
                <div class="bg-orange-50/30 p-3 md:p-5 rounded-xl border border-orange-100 leading-loose text-base md:text-lg kanji-font mb-2 text-justify" id="reading-text"></div>
                <div class="text-gray-500 text-sm mb-4 italic hidden romaji-text" id="reading-romaji"></div>
                <div class="text-gray-700 text-sm mb-4 hidden vi-trans border-t border-orange-100 pt-2" id="reading-vi"></div>
                
                <!-- Reading Practice Area -->
                <div class="mt-6 pt-4 border-t border-gray-100">
                    <h4 class="text-sm font-bold text-gray-500 mb-2 uppercase flex items-center"><i class="fas fa-keyboard mr-2"></i> Luyện gõ lại bài đọc:</h4>
                    <textarea id="reading-input" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-200 bg-gray-50 text-base kanji-font h-32" placeholder="Gõ lại nội dung bài đọc bằng tiếng Nhật vào đây..."></textarea>
                    <div id="reading-feedback" class="text-sm mt-2 min-h-[1.5rem]"></div>
                </div>
            </div>
        </section>

        <!-- 3. Grammar Section -->
        <section class="bg-white rounded-xl md:rounded-2xl shadow-md overflow-hidden fade-in border border-gray-100">
            <div class="bg-purple-50 px-4 md:px-6 py-3 md:py-4 border-b border-purple-100">
                <h2 class="text-lg md:text-xl font-bold text-purple-800"><i class="fas fa-star mr-2"></i>Ngữ Pháp Quan Trọng</h2>
            </div>
            <div class="p-4 md:p-6 grid grid-cols-1 md:grid-cols-2 gap-4" id="grammar-container"></div>
        </section>

        <!-- 4. Vocabulary Flashcards -->
        <section class="fade-in">
            <div class="flex items-center justify-between mb-4 px-2">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800"><i class="fas fa-tags mr-2 text-sky-600"></i>Thẻ Kanji</h2>
                <div class="flex items-center gap-2">
                    <button onclick="shuffleVocab()" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1 rounded-full font-bold transition flex items-center">
                        <i class="fas fa-random mr-1"></i> Shuffle
                    </button>
                    <span class="text-xs md:text-sm text-gray-500 bg-white px-3 py-1 rounded-full shadow-sm" id="vocab-counter">1 / 20</span>
                </div>
            </div>
            
            <div class="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden relative min-h-[450px] md:min-h-[500px]" id="vocab-card-container">
                <!-- Navigation buttons customized for mobile to not cover content -->
                <button onclick="prevVocab()" class="absolute left-0 top-0 bottom-0 px-2 md:px-4 text-gray-400 hover:text-sky-600 hover:bg-sky-50 transition z-10 focus:outline-none bg-white/50 md:bg-transparent"><i class="fas fa-chevron-left text-2xl md:text-3xl"></i></button>
                <button onclick="nextVocab()" class="absolute right-0 top-0 bottom-0 px-2 md:px-4 text-gray-400 hover:text-sky-600 hover:bg-sky-50 transition z-10 focus:outline-none bg-white/50 md:bg-transparent"><i class="fas fa-chevron-right text-2xl md:text-3xl"></i></button>
                
                <div id="vocab-content" class="p-6 md:p-12 text-center card-transition h-full flex flex-col justify-center"></div>
            </div>
        </section>

        <!-- 5. Quiz Section -->
        <section class="bg-white rounded-xl md:rounded-2xl shadow-md overflow-hidden fade-in border border-gray-100 mb-8 md:mb-12">
            <div class="bg-emerald-50 px-4 md:px-6 py-3 md:py-4 border-b border-emerald-100 flex justify-between items-center">
                <h2 class="text-lg md:text-xl font-bold text-emerald-800"><i class="fas fa-question-circle mr-2"></i>Thực Hành</h2>
                <span class="text-xs md:text-sm bg-emerald-200 text-emerald-800 px-3 py-1 rounded-full font-bold" id="quiz-score">0/10</span>
            </div>
            <div class="p-4 md:p-6 space-y-6" id="quiz-container"></div>
            <div class="px-6 py-4 bg-gray-50 border-t border-gray-100 text-center">
                <button onclick="checkQuiz()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-10 rounded-full shadow-lg transform transition active:scale-95 text-sm md:text-base w-full md:w-auto">Nộp Bài</button>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-gray-400 py-6 md:py-8 mt-6">
        <div class="container mx-auto px-4 text-center text-sm">
            <p>&copy; 2025 AzaKanji Kaiwa.</p>
        </div>
    </footer>

    <!-- STROKE ORDER MODAL -->
    <div id="stroke-modal" class="fixed inset-0 z-50 hidden overflow-y-auto" role="dialog" aria-modal="true">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity backdrop-blur-sm" onclick="closeStrokeModal()"></div>
            <div class="inline-block align-bottom bg-white rounded-xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl w-full modal-enter relative">
                <div class="bg-sky-600 px-4 py-3 flex justify-between items-center text-white">
                    <h3 class="font-bold text-lg"><i class="fas fa-pen-nib mr-2"></i>Tập Viết Kanji: <span id="stroke-modal-char" class="text-2xl ml-2"></span></h3>
                    <button onclick="closeStrokeModal()" class="hover:text-gray-200 p-2"><i class="fas fa-times text-xl"></i></button>
                </div>
                <div class="p-4 md:p-6 bg-gray-50 max-h-[80vh] overflow-y-auto">
                    <div class="flex flex-col md:flex-row gap-6 md:gap-8 items-center md:items-start justify-center">
                        <div class="bg-white p-4 rounded-lg shadow border border-gray-200 text-center w-full md:w-auto">
                            <p class="text-sm text-gray-500 mb-2 font-bold uppercase">Mô phỏng</p>
                            <div id="stroke-animation-container" class="w-40 h-40 mx-auto bg-white border border-gray-300 relative stroke-grid-box flex items-center justify-center">
                                <span class="text-gray-400 text-xs">Đang tải...</span>
                            </div>
                            <button onclick="replayStrokeAnimation()" class="mt-3 text-sm bg-sky-100 text-sky-700 px-4 py-2 rounded hover:bg-sky-200 transition w-full"><i class="fas fa-redo mr-1"></i> Viết lại</button>
                        </div>
                        <div class="flex-1 w-full">
                            <p class="text-sm text-gray-500 mb-3 font-bold uppercase text-center md:text-left">Thứ tự nét</p>
                            <div id="stroke-grid-container" class="flex flex-wrap gap-2 justify-center md:justify-start"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA DAY 17 ---
        const lessonData = {
            conversation: {
                polite: [
                    { role: "Tanaka", jp: "鈴木[すずき]さん、駅前[えきまえ]に新[あたら]しいレストランができたので、一緒[いっしょ]に行[い]きませんか。", romaji: "Suzuki-san, ekimae ni atarashii resutoran ga dekita node, issho ni ikimasen ka.", vi: "Anh Suzuki, vì có một nhà hàng mới mở ở trước ga nên chúng ta đi cùng nhau không?" },
                    { role: "Suzuki", jp: "いいですね。どんな料理[りょうり]ですか。おいしそうですか。", romaji: "Ii desu ne. Donna ryouri desu ka. Oishisou desu ka.", vi: "Hay đấy. Món ăn như thế nào vậy? Trông có vẻ ngon không?" },
                    { role: "Tanaka", jp: "イタリア料理[りょうり]です。とても人気[にんき]があるので、おいしいでしょう。でも、ちょっと高[たか]そうです。", romaji: "Itaria ryouri desu. Totemo ninki ga aru node, oishii deshou. Demo, chotto takasou desu.", vi: "Là món Ý ạ. Vì rất được yêu thích nên chắc là ngon. Nhưng trông có vẻ hơi đắt." },
                    { role: "Suzuki", jp: "そうですか。昨日[きのう]お酒[さけ]を飲[の]みすぎたので、今日[きょう]はあまり食[た]べられません。", romaji: "Sou desu ka. Kinou osake o nomisugita node, kyou wa amari taberaremasen.", vi: "Vậy à. Vì hôm qua tôi uống quá nhiều rượu nên hôm nay không ăn được nhiều đâu." },
                    { role: "Tanaka", jp: "大丈夫[だいじょうぶ]ですよ。食[た]べるのは楽[たの]しいことですから、行[い]きましょう。", romaji: "Daijoubu desu yo. Taberu no wa tanoshii koto desu kara, ikimashou.", vi: "Không sao đâu. Vì việc ăn uống là một điều vui vẻ mà, chúng ta đi thôi." },
                    { role: "Suzuki", jp: "はい。この交差点[こうさてん]は事故[じこ]が起[お]きやすいので、気[き]をつけましょう。", romaji: "Hai. Kono kousaten wa jiko ga okiyasui node, ki o tsukemashou.", vi: "Vâng. Vì ngã tư này dễ xảy ra tai nạn nên chúng ta hãy cẩn thận nhé." }
                ],
                casual: [
                    { role: "Tanaka", jp: "鈴木[すずき]くん、駅前[えきまえ]に新[あたら]しいレストランができたから、一緒[いっしょ]に行[い]かない？", romaji: "Suzuki-kun, ekimae ni atarashii resutoran ga dekita kara, issho ni ikanai?", vi: "Suzuki, có nhà hàng mới mở trước ga, đi cùng không?" },
                    { role: "Suzuki", jp: "いいね。どんな料理[りょうり]？おいしそう？", romaji: "Ii ne. Donna ryouri? Oishisou?", vi: "Hay đó. Món gì thế? Trông ngon không?" },
                    { role: "Tanaka", jp: "イタリア料理[りょうり]だよ。すごく人気[にんき]があるから、おいしいだろうね。でも、ちょっと高[たか]そうだけど。", romaji: "Itaria ryouri da yo. Sugoku ninki ga aru kara, oishii darou ne. Demo, chotto takasou dakedo.", vi: "Món Ý đó. Vì nổi tiếng lắm nên chắc là ngon. Nhưng có vẻ hơi đắt." },
                    { role: "Suzuki", jp: "そっか。昨日[きのう]飲[の]みすぎたから、今日[きょう]はあまり食[た]べられないな。", romaji: "Sokka. Kinou nomisugita kara, kyou wa amari taberarenai na.", vi: "Vậy à. Hôm qua tớ uống quá chén nên nay không ăn được nhiều đâu." },
                    { role: "Tanaka", jp: "大丈夫[だいじょうぶ]だって。食[た]べるのは楽[たの]しいことだから、行[い]こうよ。", romaji: "Daijoubu datte. Taberu no wa tanoshii koto dakara, ikou yo.", vi: "Không sao đâu mà. Ăn uống là chuyện vui, đi thôi." },
                    { role: "Suzuki", jp: "うん。この交差点[こうさてん]、事故[じこ]が起[お]きやすいから、気[き]をつけよう。", romaji: "Un. Kono kousaten, jiko ga okiyasui kara, ki o tsukeyou.", vi: "Ừ. Ngã tư này dễ xảy ra tai nạn lắm, cẩn thận nhé." }
                ]
            },
            reading: {
                jp: "私[わたし]は昨日[きのう]、友達[ともだち]とレストランへ行[い]きました。そこは新[あたら]しくて、とてもきれいでした。料理[りょうり]はちょっと辛[から]そうでしたが、食[た]べてみると、とてもおいしかったです。しかし、食[た]べすぎたので、お腹[なか]が痛[いた]くなりました。薬[くすり]を飲[の]んで、すぐによくなりました。友達[ともだち]と話[はな]すのは楽[たの]しいです。このペンは書[か]きやすいので、いつも使[つか]っています。",
                romaji: "Watashi wa kinou, tomodachi to resutoran e ikimashita. Soko wa atarashikute, totemo kirei deshita. Ryouri wa chotto karasou deshita ga, tabete miru to, totemo oishikatta desu. Shikashi, tabesugita node, onaka ga itaku narimashita. Kusuri o nonde, sugu ni yoku narimashita. Tomodachi to hanasu no wa tanoshii desu. Kono pen wa kakiyasui node, itsumo tsukatte imasu.",
                vi: "Hôm qua tôi đã đi đến nhà hàng cùng với bạn. Nơi đó mới và rất sạch đẹp. Món ăn trông có vẻ hơi cay nhưng khi ăn thử thì rất ngon. Tuy nhiên, vì đã ăn quá nhiều nên tôi đã bị đau bụng. Tôi uống thuốc và đã khỏe lại ngay. Việc nói chuyện với bạn bè rất vui. Vì cái bút này dễ viết nên tôi luôn sử dụng nó."
            },
            grammar: [
                { rule: "～がします (Có cảm giác/mùi/vị)", formula: "N (âm thanh/mùi/vị) + がします", mean: "Cảm nhận được tín hiệu từ giác quan.", ex: "変[へん]なにおいがしますね。", vi: "Có mùi gì lạ quá nhỉ." },
                { rule: "～すぎます (Quá...)", formula: "V(bỏ ます) / A(bỏ い/な) + すぎます", mean: "Mức độ vượt quá giới hạn bình thường.", ex: "このセーターは大[おお]きすぎます。", vi: "Cái áo len này lớn quá." },
                { rule: "～ので (Bởi vì...)", formula: "Thể thông thường + ので", mean: "Nguyên nhân khách quan, lịch sự hơn Kara.", ex: "事故[じこ]があったので、電車[でんしゃ]が遅[おく]れました。", vi: "Vì có tai nạn nên tàu điện đã đến muộn." },
                { rule: "～のは～です (Việc... thì...)", formula: "Vる + のは + A/Câu です", mean: "Danh từ hóa động từ làm chủ ngữ.", ex: "絵[え]をかくのは楽[たの]しいです。", vi: "Việc vẽ tranh rất vui." },
                { rule: "～そうです (Trông có vẻ...)", formula: "V(bỏ ます) / A(bỏ い/な) + そうです", mean: "Phỏng đoán dựa trên thị giác (nhìn thấy).", ex: "このケーキはおいしそうです。", vi: "Cái bánh này trông có vẻ ngon." },
                { rule: "～やすい / ～にくい (Dễ/Khó)", formula: "V(bỏ ます) + やすい / にくい", mean: "Dễ hoặc khó thực hiện hành động nào đó.", ex: "この薬[くすり]は飲[の]みやすいです。", vi: "Thuốc này rất dễ uống." }
            ],
            vocab: [
                { 
                    k: "駅", h: "えき", on: "エキ", kun: "-", m: "Nhà ga", hv: "DỊCH", 
                    ti: "Con ngựa (**馬**) đứng đợi ở Dịch (**尺**) trạm.", 
                    ta: "Nhà ga này to quá, đi bộ mỏi cả **Ê** (**Eki**) mông.", 
                    compounds: [{w: "駅前", r: "えきまえ", m: "Trước ga"}] 
                },
                { 
                    k: "新", h: "あたら", on: "シン", kun: "あたら.しい", m: "Mới", hv: "TÂN", 
                    ti: "Đứng (**立**) trên cây (**木**) dùng rìu (**斤**) đẽo cái mới.", 
                    ta: "**A ta ra** (**Atara**) cái ghế mới **Xinh** (**Shin**) quá.", 
                    compounds: [{w: "新しい", r: "あたらしい", m: "Mới"}, {w: "新聞", r: "しんぶん", m: "Báo"}] 
                },
                { 
                    k: "理", h: "り", on: "リ", kun: "ことわり", m: "Lý", hv: "LÝ", 
                    ti: "Vua (**王**) ở trong làng (**里**) giảng giải đạo Lý.", 
                    ta: "**Li** (**Ri**) biệt là điều vô **Lý**.", 
                    compounds: [{w: "料理", r: "りょうり", m: "Món ăn"}] 
                },
                { 
                    k: "最", h: "もっと", on: "サイ", kun: "もっと.も", m: "Nhất", hv: "TỐI", 
                    ti: "Mặt trời (**日**) lắng nghe (**取**) điều Tối cao nhất.", 
                    ta: "**Mốt tồ** (**Motto**) là người **Sai** (**Sai**) lầm nhất.", 
                    compounds: [{w: "最近", r: "さいきん", m: "Gần đây"}] 
                },
                { 
                    k: "昨", h: "さく", on: "サク", kun: "-", m: "Hôm qua", hv: "TẠC", 
                    ti: "Mặt trời (**日**) lặn rồi (**乍**), là chuyện hôm qua.", 
                    ta: "**Sa cư** (**Saku**) ra đã nở từ hôm qua.", 
                    compounds: [{w: "昨日", r: "きのう", m: "Hôm qua"}] 
                },
                { 
                    k: "痛", h: "いた", on: "ツウ", kun: "いた.い", m: "Đau", hv: "THỐNG", 
                    ti: "Bị bệnh (**疒**) phải dùng Dụng (**甬**) cụ chữa rất Đau.", 
                    ta: "**Y tá** (**Ita**) tiêm **Đau** đến mức thông **Suốt** (**Tsuu**) cả người.", 
                    compounds: [{w: "痛い", r: "いたい", m: "Đau"}] 
                },
                { 
                    k: "薬", h: "くすり", on: "ヤク", kun: "くすり", m: "Thuốc", hv: "DƯỢC", 
                    ti: "Cỏ (**艹**) đem về phơi vui vẻ (**楽**) làm Thuốc.", 
                    ta: "Uống thuốc đắng như **Cư sử** (**Kusu**) thi thì thật là **Giặc** (**Yaku**).", 
                    compounds: [{w: "薬", r: "くすり", m: "Thuốc"}] 
                },
                { 
                    k: "交", h: "こう", on: "コウ", kun: "まじ.わる", m: "Giao", hv: "GIAO", 
                    ti: "Cha (**父**) đội nón đi Giao lưu.", 
                    ta: "**Cô** (**Kou**) giáo đi **Giao** lưu văn hóa.", 
                    compounds: [{w: "交差点", r: "こうさてん", m: "Ngã tư"}] 
                },
                { 
                    k: "差", h: "さ", on: "サ", kun: "さ.す", m: "Sai/Khác", hv: "SAI", 
                    ti: "Con dê (**羊**) làm công (**工**) việc Sai trái.", 
                    ta: "**Xa** (**Sa**) nhau quá nên dễ hiểu **Sai**.", 
                    compounds: [{w: "交差点", r: "こうさてん", m: "Ngã tư"}] 
                },
                { 
                    k: "点", h: "てん", on: "テン", kun: "-", m: "Điểm", hv: "ĐIỂM", 
                    ti: "Chiếm (**占**) được bốn đốm lửa (**灬**) là ghi Điểm.", 
                    ta: "Được 10 điểm thì lên **Thiên** (**Ten**) đàng.", 
                    compounds: [{w: "交差点", r: "こうさてん", m: "Ngã tư"}] 
                },
                { 
                    k: "気", h: "き", on: "キ", kun: "-", m: "Khí", hv: "KHÍ", 
                    ti: "Hơi nước (**气**) bốc lên từ Gạo (**米**) là tinh Khí.", 
                    ta: "**Kì** (**Ki**) lạ, không khí ở đây thật trong lành.", 
                    compounds: [{w: "気をつける", r: "きをつける", m: "Cẩn thận"}, {w: "人気", r: "にんき", m: "Được yêu thích"}] 
                },
                { 
                    k: "料", h: "りょう", on: "リョウ", kun: "-", m: "Liệu", hv: "LIỆU", 
                    ti: "Gạo (**米**) đong bằng Đấu (**斗**) là nguyên Liệu.", 
                    ta: "**Rượu** (**Ryou**) là nguyên **Liệu** nấu ăn.", 
                    compounds: [{w: "料理", r: "りょうり", m: "Món ăn/Nấu ăn"}] 
                },
                { 
                    k: "辛", h: "から", on: "シン", kun: "から.い", m: "Cay", hv: "TÂN", 
                    ti: "Đứng (**立**) mười (**十**) lần chịu cay đắng.", 
                    ta: "Ăn **Cà ra** (**Kara**) bị **Cay** quá, thật là **Xin** (**Shin**) lỗi.", 
                    compounds: [{w: "辛い", r: "からい", m: "Cay"}] 
                },
                { 
                    k: "飲", h: "の", on: "イン", kun: "の.む", m: "Uống", hv: "ẨM", 
                    ti: "Ăn (**飠**) xong mà thiếu (**欠**) nước thì phải Uống.", 
                    ta: "**No** (**No**) rồi nhưng vẫn muốn **Uống** nước **In** (**In**) hình con mèo.", 
                    compounds: [{w: "飲む", r: "のむ", m: "Uống"}] 
                },
                { 
                    k: "楽", h: "たの", on: "ラク", kun: "たの.しい", m: "Vui/Nhạc", hv: "LẠC", 
                    ti: "Cây (**木**) sồi trắng (**白**) mọc trên băng (**冫**) nhìn rất Vui.", 
                    ta: "**Ta nổ** (**Tano**) pháo tay **Vui** vẻ, **Lạc** (**Raku**) quan.", 
                    compounds: [{w: "楽しい", r: "たのしい", m: "Vui vẻ"}] 
                },
                { 
                    k: "事", h: "こと", on: "ジ", kun: "こと", m: "Việc", hv: "SỰ", 
                    ti: "Miệng (**口**) nói, tay (**彐**) viết sử sách (**亅**) là Sự việc quan trọng.", 
                    ta: "**Cô tô** (**Koto**) là hòn đảo có nhiều **Sự** việc kì lạ **Gì** (**Ji**) đó.", 
                    compounds: [{w: "事故", r: "じこ", m: "Tai nạn"}] 
                },
                { 
                    k: "故", h: "こ", on: "コ", kun: "ゆえ", m: "Cố", hv: "CỐ", 
                    ti: "Người xưa (**古**) đánh (**攵**) nhau là Sự cố.", 
                    ta: "**Cô** (**Ko**) ấy gặp sự **Cố**.", 
                    compounds: [{w: "事故", r: "じこ", m: "Tai nạn"}] 
                },
                { 
                    k: "腹", h: "はら", on: "フク", kun: "はら", m: "Bụng", hv: "PHÚC", 
                    ti: "Thịt (**月**) quay trở lại (**復**) vào Bụng.", 
                    ta: "**Ha ra** (**Hara**) kìa, cái **Bụng** **Phúc** (**Fuku**) hậu quá.", 
                    compounds: [{w: "お腹", r: "おなか", m: "Bụng"}] 
                },
                { 
                    k: "書", h: "か", on: "ショ", kun: "か.く", m: "Viết", hv: "THƯ", 
                    ti: "Tay cầm bút (**聿**) Viết lên mặt trời (**日**).", 
                    ta: "**Ca** (**Ka**) sĩ **Viết** thư cho **Sơ** (**Sho**) sơ vài dòng.", 
                    compounds: [{w: "書く", r: "かく", m: "Viết"}] 
                },
                { 
                    k: "良", h: "よ", on: "リョウ", kun: "よ.い", m: "Tốt", hv: "LƯƠNG", 
                    ti: "Một dấu chấm trên Cấn (**艮**) là Lương thiện.", 
                    ta: "**Yo** (**Yo**) man! Mọi thứ đều **Tốt** đẹp **Liệu** (**Ryou**) có tin được không?", 
                    compounds: [{w: "良い", r: "よい", m: "Tốt"}] 
                }
            ],
            quiz: [
                { type: 'mcq', question: "この靴[くつ]は歩[ある]き（___）。", options: ["そうです", "やすいです", "すぎます"], correct: 1, explain: "V(bỏ mas) + やすい: Dễ làm gì đó. Aruk-iyasui: Dễ đi bộ." },
                { type: 'fill', question: "昨日[きのう]テレビを見（___）ので、今日[きょう]は眠[ねむ]いです。", answer: "すぎた", explain: "V(bỏ mas) + すぎた (Quá khứ của Sugimasu): Đã làm gì đó quá mức." },
                { type: 'mcq', question: "このカレーは（___）そうです。", options: ["辛[から]", "辛[からい]", "辛[からく]"], correct: 0, explain: "Tính từ đuôi I bỏ 'i' + そうです: Trông có vẻ (Karasou - Trông có vẻ cay)." },
                { type: 'audio', question: "Nghe và gõ lại câu bạn vừa nghe:", jp: "事故があったので、電車が遅れました。", explain: "Jiko ga atta node, densha ga okuremashita (Vì có tai nạn nên tàu đến muộn)." },
                { type: 'mcq', question: "Chữ 料理 đọc là gì?", options: ["りゅうり", "りょうり", "りょり"], correct: 1, explain: "料理 (Ryouri) - Món ăn." },
                { type: 'fill', question: "絵[え]をかく（___）は楽[たの]しいです。", answer: "の", explain: "V-ru + のは: Danh từ hóa động từ làm chủ ngữ." },
                { type: 'mcq', question: "Chữ Hán nào có nghĩa là 'Tân' (Mới)?", options: ["親", "新", "辛"], correct: 1, explain: "新 (Atarashii - Mới)." },
                { type: 'mcq', question: "このペンは（___）やすいです。", options: ["書[か]く", "書[か]き", "書[か]いた"], correct: 1, explain: "V(bỏ mas) + やすい: Kakimasu -> Kaki-yasui (Dễ viết)." },
                { type: 'audio', question: "Nghe và điền từ còn thiếu:", jp: "イタリア料理です。とても人気があります。", explain: "Itaria ryouri desu. Totemo ninki ga arimasu." },
                { type: 'mcq', question: "Chữ 交差点 có nghĩa là gì?", options: ["Ngã tư", "Đèn đỏ", "Cảnh sát"], correct: 0, explain: "Kousaten - Ngã tư (Giao sai điểm)." }
            ]
        };

        // --- STATE ---
        let currentMode = 'polite';
        let showFurigana = true;
        let showRomaji = false;
        let showVi = true;
        let currentVocabIndex = 0; 
        let vocabSeen = new Set();
        let quizScoreCurrent = 0;
        let currentSpeed = 1.0;
        let currentStrokeSvg = null;
        let recognition = null; // Speech Recognition
        let isRecognizing = false; // Add this state variable

        // --- UTILS ---
        const parseFurigana = (text) => text ? text.replace(/([^\[\]]+)\[(.+?)\]/g, '<ruby>$1<rt>$2</rt></ruby>') : '';
        const cleanText = (text) => text ? text.replace(/\[.*?\]/g, '') : '';

        // Audio with Voice Selection
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            if (type === 'correct') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(500, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1); gain.gain.setValueAtTime(0.2, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3); osc.start(); osc.stop(audioCtx.currentTime + 0.3);
            } else {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(200, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.2); gain.gain.setValueAtTime(0.2, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2); osc.start(); osc.stop(audioCtx.currentTime + 0.2);
            }
        }

        let jpVoice = null;
        function loadVoices() {
            const voices = window.speechSynthesis.getVoices();
            // Prioritize Google Japanese, then any Japanese, then default
            jpVoice = voices.find(v => v.name === 'Google 日本語') || voices.find(v => v.lang === 'ja-JP') || null;
        }
        window.speechSynthesis.onvoiceschanged = loadVoices;

        function speak(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(cleanText(text));
                u.lang = 'ja-JP'; u.rate = currentSpeed;
                if(jpVoice) u.voice = jpVoice;
                window.speechSynthesis.speak(u);
            }
        }

        // --- SPEECH RECOGNITION (New Feature) ---
        function initSpeech() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.lang = 'ja-JP';
                recognition.continuous = false;
                recognition.interimResults = false;
            } else {
                console.warn("Speech Recognition not supported in this browser.");
            }
        }

        function startListening(targetInputId) {
            if (!recognition) {
                alert("Trình duyệt của bạn không hỗ trợ nhận diện giọng nói. Hãy dùng Chrome hoặc Edge.");
                return;
            }
            
            // If already active, stop it (toggle behavior)
            if (isRecognizing) {
                recognition.stop();
                return;
            }
            
            const btn = document.getElementById(`mic-btn-${targetInputId}`);
            const input = document.getElementById(targetInputId);
            
            // Clear any stray loading states
            document.querySelectorAll('.mic-listening').forEach(el => el.classList.remove('mic-listening'));
            
            // Define handlers
            recognition.onstart = () => {
                isRecognizing = true;
                btn.classList.add('mic-listening');
            };

            recognition.onend = () => {
                isRecognizing = false;
                btn.classList.remove('mic-listening');
            };

            recognition.onresult = (event) => {
                const text = event.results[0][0].transcript;
                input.value = text;
                input.dispatchEvent(new Event('input'));
            };

            recognition.onerror = (event) => {
                console.error("Speech error", event.error);
                // onend will be called automatically
            };

            try {
                recognition.start();
            } catch (e) {
                console.error("Speech start failed", e);
                isRecognizing = false;
            }
        }

        // --- STROKE ORDER LOGIC ---
        function getKanjiHex(kanji) {
            return kanji.charCodeAt(0).toString(16).padStart(5, '0');
        }

        async function fetchKanjiSvg(hex) {
            const url = `https://cdn.jsdelivr.net/gh/KanjiVG/kanjivg/kanji/${hex}.svg`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Not found');
                return await response.text();
            } catch (e) {
                console.error("Error fetching SVG:", e);
                return null;
            }
        }

        async function showStrokeOrder(kanji) {
            const hex = getKanjiHex(kanji);
            document.getElementById('stroke-modal').classList.remove('hidden');
            document.getElementById('stroke-modal-char').innerText = kanji;
            
            const animContainer = document.getElementById('stroke-animation-container');
            const gridContainer = document.getElementById('stroke-grid-container');
            animContainer.innerHTML = '<span class="text-gray-400 text-xs">Đang tải...</span>';
            
            const svgContent = await fetchKanjiSvg(hex);
            
            if (!svgContent) {
                animContainer.innerHTML = "<p class='p-4 text-red-500 text-xs'>Lỗi tải dữ liệu.</p>";
                gridContainer.innerHTML = "";
                return;
            }

            // 1. Setup Animation
            animContainer.innerHTML = svgContent;
            const mainSvg = animContainer.querySelector('svg');
            mainSvg.setAttribute('width', '100%');
            mainSvg.setAttribute('height', '100%');
            
            const paths = mainSvg.querySelectorAll('path');
            paths.forEach((path) => {
                const length = path.getTotalLength();
                path.style.strokeDasharray = length;
                path.style.strokeDashoffset = length;
                path.style.stroke = "#333";
                path.style.strokeWidth = "4";
                path.style.fill = "none";
                path.style.strokeLinecap = "round";
                path.style.strokeLinejoin = "round";
            });
            
            currentStrokeSvg = mainSvg;
            replayStrokeAnimation();

            // 2. Setup Static Grid
            gridContainer.innerHTML = '';
            const numStrokes = paths.length;
            
            for (let i = 0; i < numStrokes; i++) {
                const stepBox = document.createElement('div');
                stepBox.className = "w-12 h-12 md:w-20 md:h-20 bg-white border border-gray-200 relative stroke-grid-box flex items-center justify-center";
                
                const parser = new DOMParser();
                const doc = parser.parseFromString(svgContent, "image/svg+xml");
                const svgClone = doc.querySelector('svg');
                svgClone.setAttribute('width', '100%');
                svgClone.setAttribute('height', '100%');
                
                const clonePaths = svgClone.querySelectorAll('path');
                clonePaths.forEach((p, pIdx) => {
                    p.style.fill = "none";
                    p.style.strokeLinecap = "round";
                    p.style.strokeLinejoin = "round";
                    if (pIdx < i) { p.style.stroke = "#9ca3af"; p.style.strokeWidth = "3"; }
                    else if (pIdx === i) { p.style.stroke = "#000"; p.style.strokeWidth = "4"; }
                    else { p.style.display = "none"; }
                });
                
                stepBox.appendChild(svgClone);
                gridContainer.appendChild(stepBox);
            }
        }

        function replayStrokeAnimation() {
            if(!currentStrokeSvg) return;
            const paths = currentStrokeSvg.querySelectorAll('path');
            paths.forEach(p => { p.style.transition = 'none'; p.style.strokeDashoffset = p.getTotalLength(); });
            void currentStrokeSvg.offsetWidth;
            let delay = 0; const duration = 0.6;
            paths.forEach((p) => {
                p.style.transition = `stroke-dashoffset ${duration}s ease-in-out ${delay}s`;
                p.style.strokeDashoffset = '0';
                delay += duration;
            });
        }

        function closeStrokeModal() { document.getElementById('stroke-modal').classList.add('hidden'); }

        // --- STORAGE & SETTINGS ---
        function saveSettings() {
            const settings = { showFurigana, showRomaji, showVi, currentSpeed };
            localStorage.setItem('azaSettings', JSON.stringify(settings));
        }

        function loadSettings() {
            const saved = localStorage.getItem('azaSettings');
            if (saved) {
                const s = JSON.parse(saved);
                showFurigana = s.showFurigana; showRomaji = s.showRomaji; showVi = s.showVi; currentSpeed = s.currentSpeed || 1.0;
            }
        }

        // --- PROGRESS ---
        function updateProgress() {
            const totalPoints = 40 + 10 + 20 + 30;
            let currentPoints = 0;
            const convoInputs = document.querySelectorAll('#conversation-container .correct-input');
            const totalConvoLines = lessonData.conversation.polite.length;
            if (totalConvoLines > 0) currentPoints += (convoInputs.length / totalConvoLines) * 40;
            const readingInput = document.getElementById('reading-input');
            if(readingInput && readingInput.value.length > lessonData.reading.jp.length * 0.3) currentPoints += 10;
            if (lessonData.vocab.length > 0) currentPoints += (vocabSeen.size / lessonData.vocab.length) * 20;
            if (lessonData.quiz.length > 0) currentPoints += (quizScoreCurrent / lessonData.quiz.length) * 30;
            const percent = Math.min(100, Math.round(currentPoints));
            document.getElementById('progress-bar').style.width = `${percent}%`;
            document.getElementById('progress-text').innerText = `${percent}%`;
        }

        function checkTyping(input, correctText, feedbackDiv) {
            const userText = input.value;
            const targetText = cleanText(correctText);
            
            // Normalize for loose checking (optional: ignore spaces or punctuation)
            // For now, keep strict but visual feedback helps
            
            let html = '';
            for (let i = 0; i < userText.length; i++) {
                if (i >= targetText.length) { html += `<span class="incorrect-char">${userText[i]}</span>`; }
                else if (userText[i] === targetText[i]) { html += `<span class="correct-char">${userText[i]}</span>`; }
                else { html += `<span class="incorrect-char">${userText[i]}</span>`; }
            }
            feedbackDiv.innerHTML = html;
            
            if (userText === targetText) {
                input.classList.add('correct-input'); input.classList.remove('wrong-input');
                feedbackDiv.innerHTML += ' <span class="text-green-600 ml-2 font-bold text-xs"><i class="fas fa-check-circle"></i> Chính xác!</span>';
                playSound('correct'); updateProgress();
            } else if (userText.length > 0) {
                input.classList.add('wrong-input'); input.classList.remove('correct-input');
            } else {
                input.classList.remove('correct-input', 'wrong-input');
            }
        }

        function playAllConversation() {
            const lines = lessonData.conversation[currentMode];
            let i = 0;
            function playNext() {
                if (i >= lines.length) return;
                const allLines = document.querySelectorAll('#conversation-container > div');
                allLines.forEach(el => el.classList.remove('playing-line'));
                if (allLines[i]) {
                    allLines[i].classList.add('playing-line');
                    allLines[i].scrollIntoView({behavior: "smooth", block: "center"});
                }
                speak(lines[i].jp);
                // Approx duration calculation or use onend (more reliable)
                // Using global speech function doesn't expose onend easily without refactoring, 
                // so we use a direct utterance here for the chain.
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(cleanText(lines[i].jp));
                u.lang = 'ja-JP'; u.rate = currentSpeed;
                if(jpVoice) u.voice = jpVoice;
                u.onend = () => { i++; setTimeout(playNext, 500); };
                window.speechSynthesis.speak(u);
            }
            window.speechSynthesis.cancel();
            playNext();
        }

        // --- RENDER ---
        function renderConversation() {
            const container = document.getElementById('conversation-container');
            const lines = lessonData.conversation[currentMode];
            container.innerHTML = lines.map((line, idx) => `
                <div class="flex gap-2 md:gap-4 fade-in ${line.role === 'Tanaka' ? '' : 'flex-row-reverse'} p-1 md:p-2 rounded-lg transition-colors duration-300">
                    <div class="flex-shrink-0 w-8 h-8 md:w-12 md:h-12 rounded-full flex items-center justify-center font-bold text-white shadow-md text-sm md:text-base ${line.role === 'Tanaka' ? 'bg-blue-500' : 'bg-green-500'}">
                        ${line.role[0]}
                    </div>
                    <div class="flex-1 max-w-[95%] md:max-w-[90%]">
                        <div class="text-[10px] md:text-xs text-gray-500 mb-1 ${line.role === 'Tanaka' ? 'text-left' : 'text-right'}">${line.role}</div>
                        <div class="bg-white p-3 md:p-4 rounded-xl md:rounded-2xl shadow-sm border border-gray-200 relative group transition hover:shadow-md ${line.role === 'Tanaka' ? 'rounded-tl-none' : 'rounded-tr-none bg-green-50'}">
                            <p class="text-base md:text-lg text-gray-800 kanji-font leading-relaxed mb-1 pr-6 md:pr-0">${parseFurigana(line.jp)}</p>
                            <p class="text-sm text-gray-500 romaji-text hidden italic mb-1">${line.romaji}</p>
                            <p class="text-xs md:text-sm text-gray-500 vi-trans border-t border-gray-100 pt-2 mt-2">${line.vi}</p>
                            <button onclick="speak('${line.jp}')" class="absolute top-2 right-2 text-gray-300 hover:text-sky-600 transition"><i class="fas fa-volume-up"></i></button>
                            
                            <div class="mt-3 pt-2 border-t border-gray-100">
                                <div class="flex gap-2">
                                    <input type="text" id="convo-input-${idx}" class="flex-1 text-sm md:text-base p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-200 transition bg-gray-50 placeholder-gray-300 min-w-0" placeholder="Nghe và gõ lại..." oninput="checkTyping(this, '${line.jp}', this.parentElement.nextElementSibling)">
                                    <button id="mic-btn-convo-input-${idx}" onclick="startListening('convo-input-${idx}')" class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-2 md:px-3 rounded-lg transition flex-shrink-0" title="Nói để nhập (Chrome/Edge)"><i class="fas fa-microphone"></i></button>
                                </div>
                                <div class="h-auto md:h-5 mt-1 text-xs md:text-sm pl-1 kanji-font break-all"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            updateUI();
        }

        function switchMode(mode) {
            currentMode = mode;
            document.getElementById('tab-polite').className = mode === 'polite' ? "tab-btn tab-active flex-1 md:flex-none px-2 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-bold text-center" : "tab-btn tab-inactive flex-1 md:flex-none px-2 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-bold ml-1 text-center";
            document.getElementById('tab-casual').className = mode === 'casual' ? "tab-btn tab-active flex-1 md:flex-none px-2 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-bold ml-1 text-center" : "tab-btn tab-inactive flex-1 md:flex-none px-2 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-bold ml-1 text-center";
            renderConversation();
        }

        function renderReading() {
            document.getElementById('reading-text').innerHTML = parseFurigana(lessonData.reading.jp);
            document.getElementById('reading-romaji').innerText = lessonData.reading.romaji;
            document.getElementById('reading-vi').innerText = lessonData.reading.vi;
            const input = document.getElementById('reading-input');
            const feedback = document.getElementById('reading-feedback');
            input.oninput = () => {
                if(input.value.length > 50) updateProgress();
                checkTyping(input, lessonData.reading.jp, feedback); 
            };
            if(!document.getElementById('reading-play-btn')) {
                const btn = document.createElement('button');
                btn.id = 'reading-play-btn';
                btn.className = "mt-4 text-orange-500 hover:text-orange-700 font-bold flex items-center text-sm transition";
                btn.innerHTML = '<i class="fas fa-volume-up mr-2"></i> Nghe bài đọc';
                btn.onclick = () => speak(lessonData.reading.jp);
                document.getElementById('reading-text').parentNode.insertBefore(btn, document.getElementById('reading-text').nextSibling);
            }
        }

        function renderGrammar() {
            const container = document.getElementById('grammar-container');
            container.innerHTML = lessonData.grammar.map(g => `
                <div class="bg-white p-4 md:p-5 rounded-xl border border-purple-100 shadow-sm hover:border-purple-300 transition group">
                    <h3 class="font-bold text-purple-700 mb-1 text-base md:text-lg flex items-center"><span class="w-2 h-2 bg-purple-500 rounded-full mr-2 flex-shrink-0"></span>${g.rule}</h3>
                    <div class="mb-2 pl-4"><span class="bg-red-100 text-red-600 text-[10px] md:text-xs px-2 py-1 rounded font-bold">Công thức:</span> <span class="text-gray-700 text-xs md:text-sm kanji-font break-all">${g.formula}</span></div>
                    <p class="text-gray-600 text-xs md:text-sm mb-3 pl-4">${g.mean}</p>
                    <div class="bg-purple-50 p-3 rounded-lg text-xs md:text-sm text-gray-700 kanji-font relative pl-4">
                        <i class="fas fa-quote-left text-purple-200 absolute top-1 left-1 text-xs"></i>${parseFurigana(g.ex)}
                        <p class="text-[10px] md:text-xs text-purple-600 mt-1 italic">${g.vi}</p>
                        <button onclick="speak('${g.ex}')" class="absolute top-2 right-2 text-purple-300 hover:text-purple-600 transition md:opacity-0 md:group-hover:opacity-100"><i class="fas fa-volume-up"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function shuffleVocab() {
            for (let i = lessonData.vocab.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [lessonData.vocab[i], lessonData.vocab[j]] = [lessonData.vocab[j], lessonData.vocab[i]];
            }
            currentVocabIndex = 0;
            renderVocab();
        }

        function renderVocab() {
            vocabSeen.add(currentVocabIndex);
            updateProgress();
            const container = document.getElementById('vocab-content');
            const v = lessonData.vocab[currentVocabIndex];
            const compoundsHtml = v.compounds ? v.compounds.map(c => 
                `<div class="flex justify-between items-center bg-gray-50 px-3 py-2 rounded mb-1 cursor-pointer hover:bg-gray-100" onclick="speak('${c.r}')">
                    <span class="text-gray-800 font-bold">${c.w}</span>
                    <span class="text-gray-500 text-xs">${c.r}</span>
                    <span class="text-sky-600 text-xs text-right">${c.m}</span>
                    <i class="fas fa-volume-up text-xs text-gray-300 ml-2"></i>
                </div>`
            ).join('') : '';

            container.innerHTML = `
                <div class="animate-fade-in relative">
                    <div class="text-5xl md:text-6xl font-bold text-gray-800 kanji-font mb-2 cursor-pointer hover:text-sky-600 transition" onclick="showStrokeOrder('${v.k}')" title="Bấm để xem cách viết">${v.k}</div>
                    <button onclick="showStrokeOrder('${v.k}')" class="text-xs bg-sky-100 text-sky-700 px-3 py-1 rounded-full mb-2 hover:bg-sky-200 transition"><i class="fas fa-pen-nib mr-1"></i> Tập viết</button>
                    
                    <div class="grid grid-cols-2 gap-2 md:gap-4 text-center mb-4 text-sm bg-gray-50 p-2 rounded-lg">
                        <div class="flex flex-col items-center">
                            <span class="text-[10px] md:text-xs text-gray-400 block uppercase font-bold mb-1">On'yomi</span>
                            <div class="flex items-center gap-1 md:gap-2 flex-wrap justify-center">
                                <span class="text-gray-800 font-bold text-xs md:text-sm">${v.on}</span>
                                <button onclick="speak('${v.on}')" class="w-5 h-5 md:w-6 md:h-6 rounded-full bg-white shadow-sm flex items-center justify-center text-sky-500 hover:bg-sky-50 hover:text-sky-700 transition" title="Nghe âm On">
                                    <i class="fas fa-volume-up text-[10px] md:text-xs"></i>
                                </button>
                            </div>
                        </div>
                        <div class="flex flex-col items-center">
                            <span class="text-[10px] md:text-xs text-gray-400 block uppercase font-bold mb-1">Kun'yomi</span>
                            <div class="flex items-center gap-1 md:gap-2 flex-wrap justify-center">
                                <span class="text-gray-800 font-bold text-xs md:text-sm">${v.kun}</span>
                                <button onclick="speak('${v.kun.replace(/\./g, '')}')" class="w-5 h-5 md:w-6 md:h-6 rounded-full bg-white shadow-sm flex items-center justify-center text-sky-500 hover:bg-sky-50 hover:text-sky-700 transition" title="Nghe âm Kun">
                                    <i class="fas fa-volume-up text-[10px] md:text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="inline-block text-[10px] md:text-xs font-bold text-white bg-gray-400 px-3 py-1 rounded-full mb-3 md:mb-4 tracking-wide">${v.hv}</div>
                    <div class="text-sky-700 font-bold text-xl md:text-2xl mb-4 md:mb-6 border-b border-gray-100 pb-2 md:pb-4">${v.m}</div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 text-left max-w-2xl mx-auto">
                        <div class="bg-orange-50 p-3 md:p-4 rounded-xl border border-orange-100">
                            <div class="font-bold text-orange-600 mb-2 flex items-center text-sm"><i class="fas fa-image mr-2"></i> Mẹo Hình Ảnh</div>
                            <div class="text-gray-700 text-xs md:text-sm leading-relaxed">${v.ti.replace(/\*\*(.*?)\*\*/g, '<span class="text-red-600 font-bold">$1</span>')}</div>
                        </div>
                        <div class="bg-blue-50 p-3 md:p-4 rounded-xl border border-blue-100">
                            <div class="font-bold text-blue-600 mb-2 flex items-center text-sm"><i class="fas fa-volume-up mr-2"></i> Mẹo Âm Thanh</div>
                            <div class="text-gray-700 text-xs md:text-sm leading-relaxed">${v.ta.replace(/\*\*(.*?)\*\*/g, '<span class="text-indigo-600 font-bold">$1</span>')}</div>
                        </div>
                    </div>

                    ${compoundsHtml ? `<div class="mt-6 md:mt-8 pt-4 md:pt-6 border-t border-gray-100"><div class="text-xs md:text-sm text-gray-400 mb-2 font-bold uppercase tracking-wide text-center">Từ ghép</div><div class="kanji-font text-gray-600 max-w-sm mx-auto text-left">${compoundsHtml}</div></div>` : ''}
                </div>
            `;
            document.getElementById('vocab-counter').innerText = `${currentVocabIndex + 1} / ${lessonData.vocab.length}`;
        }
        function prevVocab() { if (currentVocabIndex > 0) { currentVocabIndex--; renderVocab(); } }
        function nextVocab() { if (currentVocabIndex < lessonData.vocab.length - 1) { currentVocabIndex++; renderVocab(); } }
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') prevVocab();
            if (e.key === 'ArrowRight') nextVocab();
        });

        // --- QUIZ ---
        function renderQuiz() {
            const container = document.getElementById('quiz-container');
            container.innerHTML = lessonData.quiz.map((q, idx) => `
                <div class="quiz-item border-b border-gray-100 pb-4 last:border-0">
                    <p class="font-bold text-gray-800 mb-2 md:mb-3 text-sm md:text-base"><span class="text-emerald-600 mr-2">Câu ${idx + 1}:</span> ${q.type === 'audio' ? q.question : parseFurigana(q.question)}</p>
                    <div class="space-y-2">
                        ${q.type === 'audio' ? `<button class="speak-btn mb-2 flex items-center text-sky-600 font-bold text-sm" onclick="speak('${q.jp}')"><i class="fas fa-volume-up mr-2"></i> Nghe câu hỏi</button><input type="text" class="w-full p-2 border rounded text-base" placeholder="Nhập câu bạn nghe được..." data-idx="${idx}">` 
                        : q.type === 'fill' ? `<input type="text" class="w-full p-2 border rounded fill-input text-base" placeholder="Điền từ còn thiếu..." data-idx="${idx}">` 
                        : q.options.map((opt, optIdx) => `<label class="flex items-center p-2 md:p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition quiz-option text-sm md:text-base" data-q="${idx}" data-opt="${optIdx}"><input type="radio" name="q${idx}" value="${optIdx}" class="mr-3 text-emerald-600 focus:ring-emerald-500"><span class="kanji-font">${parseFurigana(opt)}</span></label>`).join('')}
                    </div>
                    <div class="quiz-feedback hidden mt-3 p-3 rounded-lg text-sm" id="feedback-${idx}"></div>
                </div>
            `).join('');
            document.getElementById('quiz-score').innerText = `0/${lessonData.quiz.length}`;
        }

        function checkQuiz() {
            let score = 0;
            lessonData.quiz.forEach((q, idx) => {
                const feedbackEl = document.getElementById(`feedback-${idx}`);
                feedbackEl.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
                let isCorrect = false;
                if (q.type === 'audio') {
                    const input = document.querySelector(`input[data-idx="${idx}"]`);
                    isCorrect = input.value.trim() === cleanText(q.jp);
                } else if (q.type === 'fill') {
                    const input = document.querySelector(`input[data-idx="${idx}"]`);
                    isCorrect = input.value.trim() === q.answer;
                } else {
                    const selected = document.querySelector(`input[name="q${idx}"]:checked`);
                    if (selected && parseInt(selected.value) === q.correct) isCorrect = true;
                }
                
                if (isCorrect) {
                    score++;
                    feedbackEl.innerHTML = `<i class="fas fa-check-circle mr-2"></i> Chính xác! <br><span class="text-xs mt-1 block opacity-80">${q.explain || ''}</span>`;
                    feedbackEl.classList.add('bg-green-100', 'text-green-800');
                } else {
                    const ans = q.type === 'mcq' ? q.options[q.correct] : (q.type === 'audio' ? q.jp : q.answer);
                    feedbackEl.innerHTML = `<i class="fas fa-times-circle mr-2"></i> Sai rồi. Đáp án: <strong>${ans}</strong><br><span class="text-xs mt-1 block opacity-80">${q.explain || ''}</span>`;
                    feedbackEl.classList.add('bg-red-100', 'text-red-800');
                }
            });
            if(score === lessonData.quiz.length) playSound('correct');
            else playSound('wrong');
            quizScoreCurrent = score;
            document.getElementById('quiz-score').innerText = `${score}/${lessonData.quiz.length}`;
            updateProgress();
        }

        function updateUI() {
            document.querySelectorAll('rt').forEach(rt => rt.style.visibility = showFurigana ? 'visible' : 'hidden');
            document.getElementById('btn-toggle-furigana').className = showFurigana ? "px-2 md:px-3 py-1.5 rounded transition bg-sky-600 text-white flex items-center shadow" : "px-2 md:px-3 py-1.5 rounded transition bg-gray-200 text-gray-600 flex items-center";
            document.querySelectorAll('.romaji-text').forEach(el => el.classList.toggle('hidden', !showRomaji));
            document.getElementById('btn-toggle-romaji').className = showRomaji ? "px-2 md:px-3 py-1.5 rounded transition bg-sky-600 text-white flex items-center shadow ml-1" : "px-2 md:px-3 py-1.5 rounded transition bg-gray-200 text-gray-600 flex items-center ml-1";
            document.querySelectorAll('.vi-trans').forEach(p => p.style.display = showVi ? 'block' : 'none');
            document.getElementById('btn-toggle-vi').className = showVi ? "px-2 md:px-3 py-1.5 rounded transition bg-white text-sky-800 font-bold ml-1 flex items-center border border-sky-200 shadow-sm" : "px-2 md:px-3 py-1.5 rounded transition bg-gray-200 text-gray-500 font-bold ml-1 flex items-center";
            const speedSelect = document.getElementById('audio-speed');
            speedSelect.value = currentSpeed;
            speedSelect.onchange = (e) => { currentSpeed = parseFloat(e.target.value); };
        }

        document.getElementById('btn-toggle-furigana').onclick = () => { showFurigana = !showFurigana; updateUI(); saveSettings(); };
        document.getElementById('btn-toggle-romaji').onclick = () => { showRomaji = !showRomaji; updateUI(); saveSettings(); };
        document.getElementById('btn-toggle-vi').onclick = () => { showVi = !showVi; updateUI(); saveSettings(); };

        document.addEventListener('DOMContentLoaded', () => {
            initSpeech(); // Init Microphone
            loadSettings();
            renderConversation();
            renderReading();
            renderGrammar();
            renderVocab();
            renderQuiz();
            updateUI();
            updateProgress();
            setTimeout(loadVoices, 100); // Load voices explicitly
        });
    </script>
</body>
</html>
