<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AzaGrammar Master - Cặp từ & Ngữ pháp Dễ nhầm (Nâng cao)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #f0f2f5; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        .ja-text { font-family: 'Noto Sans JP', sans-serif; }
        
        /* Custom Scrollbar */
        .scroller::-webkit-scrollbar { width: 6px; }
        .scroller::-webkit-scrollbar-track { background: transparent; }
        .scroller::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        
        /* Category Item */
        .cat-header { transition: all 0.2s; }
        .cat-header:hover { background-color: #e0e7ff; }
        .cat-header.active { background-color: #4f46e5; color: white; }
        .cat-header.active i { color: white; }
        
        /* Grammar Item in List */
        .g-item { transition: all 0.2s; border-left: 3px solid transparent; }
        .g-item:hover { background-color: #f8fafc; padding-left: 1rem; }
        .g-item.active { background-color: #eff6ff; border-left-color: #4f46e5; color: #4338ca; padding-left: 1rem; font-weight: 700; }

        /* Comparison Box */
        .comp-box { transition: transform 0.2s; }
        .comp-box:hover { transform: translateY(-2px); }

        /* Nuance Box */
        .nuance-box { border-left: 4px solid #f59e0b; background-color: #fffbeb; }
        
        /* Animation */
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-in { animation: slideIn 0.3s ease-out forwards; }
        
        /* Mobile Drawer */
        #mobileDrawer { transition: transform 0.3s ease-in-out; }
        #mobileDrawer.open { transform: translateX(0); }
        #mobileDrawer.closed { transform: translateX(-100%); }
    </style>
</head>
<body class="text-slate-800">

    <!-- HEADER -->
    <header class="bg-white border-b border-gray-200 flex-none z-30 h-14 md:h-16 flex items-center justify-between px-4 shadow-sm">
        <div class="flex items-center gap-3">
            <button class="md:hidden text-gray-500 text-xl" onclick="toggleMobileDrawer()"><i class="fas fa-bars"></i></button>
            <div class="flex items-center gap-2 text-indigo-600">
                <i class="fas fa-balance-scale text-2xl"></i>
                <h1 class="font-extrabold text-lg md:text-xl tracking-tight">AzaGrammar <span class="text-xs bg-orange-100 px-2 py-0.5 rounded-full text-orange-700 ml-1">Confusing Pairs Pro</span></h1>
            </div>
        </div>
        <div class="flex gap-2">
             <button onclick="switchMode('study')" id="btn-study" class="px-4 py-1.5 rounded-lg text-sm font-bold bg-indigo-50 text-indigo-600 hover:bg-indigo-100 transition">Học Tập</button>
             <button onclick="switchMode('practice')" id="btn-practice" class="px-4 py-1.5 rounded-lg text-sm font-bold text-gray-500 hover:bg-gray-100 transition">Luyện Tập</button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- SIDEBAR (Topic List) -->
        <aside id="sidebar" class="hidden md:flex w-80 bg-white border-r border-gray-200 flex-col overflow-hidden z-20">
            <div class="p-3 border-b border-gray-100">
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i>
                    <input type="text" id="searchInput" placeholder="Tìm cặp từ (vd: shiru, aida...)" class="w-full pl-9 pr-4 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition">
                </div>
            </div>
            <div id="categoryList" class="flex-1 scroller overflow-y-auto pb-20">
                <!-- Categories will be injected here -->
            </div>
        </aside>

        <!-- MOBILE DRAWER -->
        <div id="mobileDrawer" class="fixed inset-y-0 left-0 w-3/4 max-w-xs bg-white shadow-2xl z-50 md:hidden closed flex flex-col">
            <div class="p-4 bg-indigo-600 text-white flex justify-between items-center">
                <h2 class="font-bold text-lg">Danh sách chủ đề</h2>
                <button onclick="toggleMobileDrawer()"><i class="fas fa-times"></i></button>
            </div>
            <div id="mobileCategoryList" class="flex-1 scroller overflow-y-auto"></div>
        </div>
        <div id="drawerBackdrop" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden glass" onclick="toggleMobileDrawer()"></div>

        <!-- MAIN CONTENT AREA -->
        <main class="flex-1 relative bg-[#f3f4f6] overflow-hidden flex flex-col">
            
            <!-- STUDY MODE -->
            <div id="study-view" class="flex-1 flex flex-col h-full overflow-y-auto scroller p-4 md:p-8">
                <div class="max-w-6xl mx-auto w-full pb-20 animate-slide-in">
                    
                    <!-- Title Card -->
                    <div class="mb-6 text-center">
                        <span class="text-xs font-bold text-indigo-500 uppercase tracking-wider bg-indigo-100 px-3 py-1 rounded-full" id="c-cat-name">Category</span>
                        <h2 class="text-3xl font-extrabold text-gray-800 mt-2 mb-1" id="c-title">Title</h2>
                        <p class="text-gray-500 text-sm max-w-2xl mx-auto" id="c-desc">Description</p>
                    </div>

                    <!-- Nuance Tip Box (Top) -->
                    <div class="mb-8 nuance-box p-4 rounded-lg shadow-sm" id="c-nuance-box">
                        <h4 class="font-bold text-amber-700 flex items-center gap-2 mb-2"><i class="fas fa-lightbulb"></i> Phân biệt Sắc thái (Nuance)</h4>
                        <p class="text-gray-700 text-sm leading-relaxed" id="c-nuance-text">...</p>
                    </div>

                    <!-- Comparison Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6" id="comp-container">
                        <!-- Left Side -->
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 comp-box flex flex-col">
                            <h3 class="text-xl font-bold text-indigo-700 mb-2 border-b border-indigo-100 pb-2" id="left-title">...</h3>
                            <p class="text-sm text-gray-600 mb-4 bg-gray-50 p-3 rounded-lg" id="left-desc">...</p>
                            <div class="space-y-4 flex-1" id="left-examples"></div>
                        </div>

                        <!-- Right Side -->
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 comp-box flex flex-col">
                            <h3 class="text-xl font-bold text-pink-700 mb-2 border-b border-pink-100 pb-2" id="right-title">...</h3>
                            <p class="text-sm text-gray-600 mb-4 bg-gray-50 p-3 rounded-lg" id="right-desc">...</p>
                            <div class="space-y-4 flex-1" id="right-examples"></div>
                        </div>
                    </div>

                    <!-- Third Side (Optional) -->
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 comp-box mt-6 hidden" id="third-box">
                         <h3 class="text-xl font-bold text-green-700 mb-2 border-b border-green-100 pb-2" id="third-title">...</h3>
                         <p class="text-sm text-gray-600 mb-4 bg-gray-50 p-3 rounded-lg" id="third-desc">...</p>
                         <div class="space-y-4" id="third-examples"></div>
                    </div>

                </div>
            </div>

            <!-- PRACTICE MODE (Quiz) -->
            <div id="practice-view" class="hidden flex-1 flex-col h-full bg-white relative">
                <div class="absolute inset-0 flex flex-col max-w-2xl mx-auto p-6 justify-center">
                    <div class="mb-8 text-center">
                        <div class="inline-block bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold mb-2" id="quiz-progress">Câu 1/10</div>
                        <h2 class="text-xl font-bold text-gray-800 mb-2">Sắp xếp câu hoàn chỉnh</h2>
                        <p class="text-gray-500 text-sm">Chọn các từ bên dưới theo đúng thứ tự</p>
                    </div>

                    <!-- Quiz Display -->
                    <div class="bg-gray-50 rounded-2xl p-6 border-2 border-dashed border-gray-200 mb-6 min-h-[120px] flex flex-wrap items-center gap-2 justify-center" id="quiz-answer-zone"></div>

                    <div class="mb-8">
                         <p class="text-center text-gray-600 text-sm mb-4" id="quiz-question-vi">...</p>
                         <div class="flex flex-wrap justify-center gap-3" id="quiz-options-zone"></div>
                    </div>

                    <div class="flex gap-4">
                        <button onclick="resetQuizQuestion()" class="flex-1 py-3 rounded-xl border border-gray-300 text-gray-600 font-bold hover:bg-gray-50 transition"><i class="fas fa-undo"></i> Làm lại</button>
                        <button onclick="checkQuizAnswer()" class="flex-1 py-3 rounded-xl bg-indigo-600 text-white font-bold hover:bg-indigo-700 shadow-lg transition shadow-indigo-200" id="btn-submit-quiz">Kiểm tra</button>
                    </div>
                    
                    <!-- Feedback Overlay -->
                    <div id="quiz-feedback" class="absolute inset-0 bg-white/90 backdrop-blur-sm z-10 hidden flex-col items-center justify-center text-center p-6 rounded-2xl">
                        <div class="text-6xl mb-4" id="fb-icon"></div>
                        <h3 class="text-2xl font-bold mb-2" id="fb-text"></h3>
                        <p class="text-gray-500 mb-6" id="fb-subtext"></p>
                        <button onclick="nextQuizQuestion()" class="bg-gray-900 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:scale-105 transition">Tiếp tục <i class="fas fa-arrow-right ml-2"></i></button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- MODAL: GRAMMAR DETAIL -->
    <div id="detailGrammarModal" class="fixed inset-0 z-[90] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity opacity-0" id="detailGrammarBackdrop" onclick="closeModal('detailGrammarModal')"></div>
        <div class="bg-white rounded-2xl w-full max-w-md relative z-10 shadow-2xl transform transition-all scale-95 opacity-0 flex flex-col" id="detailGrammarPanel">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 rounded-t-2xl">
                <div class="flex items-center gap-2">
                    <div class="bg-indigo-100 p-1.5 rounded-lg text-indigo-600"><i class="fas fa-info-circle"></i></div>
                    <h3 class="text-lg font-bold text-gray-800">Giải thích Ngữ pháp</h3>
                </div>
                <button onclick="closeModal('detailGrammarModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6">
                <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-3 text-center mb-4 shadow-sm">
                    <code class="text-lg font-bold text-indigo-700 font-mono" id="dgFormula"></code>
                </div>
                <div id="dgExplanation" class="text-gray-600 text-sm mb-4 space-y-3 leading-relaxed"></div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. GRAMMAR REPO (Simplified for Lookup) ---
        const grammarRepo = {
            "aida_ni": { title: "Trong lúc (khoảnh khắc)", formula: "Vている・Nの + 間に", desc: "Hành động xảy ra và kết thúc tại 1 điểm trong khoảng thời gian V1 diễn ra." },
            "uchi_ni": { title: "Nhân lúc / Trong lúc", formula: "Vる・Vない・A・Nの + うちに", desc: "Tranh thủ làm gì trước khi trạng thái thay đổi. Hoặc trong khi đang làm gì thì có sự thay đổi tự nhiên." },
            "aida": { title: "Trong suốt", formula: "Vている・Nの + 間", desc: "Hành động V2 diễn ra liên tục suốt thời gian V1 diễn ra." },
            "node": { title: "Vì (Khách quan)", formula: "Thể thường + ので", desc: "Nguyên nhân, lý do nhẹ nhàng, lịch sự." },
            "kara_reason": { title: "Vì (Chủ quan)", formula: "Thể thường + から", desc: "Nguyên nhân mang tính chủ quan, mạnh mẽ hơn. Dùng được cho mệnh lệnh, cấm chỉ." },
            "bakari_feel": { title: "Vừa mới (Cảm giác)", formula: "Vた + ばかり", desc: "Cảm thấy như vừa mới làm xong (dù thực tế có thể lâu)." },
            "ta_tokoro": { title: "Vừa mới (Thực tế)", formula: "Vた + ところ", desc: "Vừa mới kết thúc tức thì." },
            "rashii": { title: "Nghe nói / Đúng chất", formula: "Thể thường + らしい", desc: "Phỏng đoán có căn cứ (nghe nói), hoặc mang tính chất điển hình (nam ra nam, xuân ra xuân)." },
            "mitai": { title: "Hình như / Giống như", formula: "Thể thường + みたい", desc: "Suy đoán dựa trên cảm nhận trực quan hoặc so sánh ví von (văn nói)." },
            "you_da": { title: "Hình như / Giống như", formula: "Thể thường + ようだ", desc: "Suy đoán có căn cứ, trang trọng hơn 'mitai' (văn viết/nói lịch sự)." },
            "koto": { title: "Việc (Trừu tượng)", formula: "Vる + こと", desc: "Danh từ hóa, dùng cho khái niệm trừu tượng, sở thích, khả năng, kinh nghiệm." },
            "no_nomial": { title: "Việc (Cụ thể)", formula: "Vる + の", desc: "Danh từ hóa, dùng cho tri giác (nhìn, nghe), cảm nhận cụ thể, nhấn mạnh." },
            "shiru": { title: "Biết (Thông tin)", formula: "知る", desc: "Biết thông tin, kiến thức. Trạng thái biết: 'Shitteiru'." },
            "wakaru": { title: "Hiểu (Bản chất)", formula: "分かる", desc: "Hiểu rõ bản chất, lý do, cảm xúc, hoặc biết đường đi lối lại." }
        };

        // --- DATA: Comparisons (Rich Data) ---
        const grammarData = {
            "time_action": {
                name: "1. Thời gian & Hành động",
                icon: "clock",
                color: "blue",
                items: [
                    { 
                        id: "comp_01", title: "「間に」 vs 「うちに」",
                        nuance: "Cả hai đều là 'trong khi', nhưng 'Uchi ni' mang ý nghĩa 'TRANH THỦ' làm trước khi quá muộn, hoặc sự thay đổi tự nhiên. 'Aida ni' chỉ đơn thuần là một hành động xen vào giữa một khoảng thời gian.",
                        left: { title: "〜間に (Aida ni)", desc: "Xảy ra tại 1 thời điểm trong khi V1 diễn ra.", ex: [
                            {ja:"留守の間に泥棒が入った。", vi:"Trộm vào nhà lúc tôi đi vắng (một thời điểm nào đó).", gIds:["aida_ni"]}, 
                            {ja:"寝ている間に地震があった。", vi:"Động đất xảy ra lúc tôi đang ngủ.", gIds:["aida_ni"]},
                            {ja:"授業の間に質問しました。", vi:"Tôi đã hỏi trong giờ học.", gIds:["aida_ni"]},
                            {ja:"電車を待っている間に、本を読んだ。", vi:"Trong lúc đợi tàu, tôi đã đọc sách.", gIds:["aida_ni"]}
                        ]},
                        right: { title: "〜うちに (Uchi ni)", desc: "Tranh thủ làm V2 trước khi V1 thay đổi.", ex: [
                            {ja:"忘れないうちにメモする。", vi:"Ghi lại ngay kẻo quên (tranh thủ).", gIds:["uchi_ni"]}, 
                            {ja:"温かいうちに食べてください。", vi:"Hãy ăn khi còn nóng (trước khi nguội).", gIds:["uchi_ni"]},
                            {ja:"若いうちに苦労すべきだ。", vi:"Nên chịu khổ khi còn trẻ.", gIds:["uchi_ni"]},
                            {ja:"雨が降らないうちに帰ろう。", vi:"Tranh thủ về trước khi trời mưa.", gIds:["uchi_ni"]}
                        ]}
                    },
                    { 
                        id: "comp_12", title: "「間」 vs 「間に」",
                        nuance: "'Aida' (không có ni) nghĩa là hành động V2 kéo dài LIÊN TỤC suốt thời gian V1. 'Aida ni' (có ni) là hành động KHOẢNH KHẮC.",
                        left: { title: "〜間 (Aida)", desc: "V2 diễn ra liên tục song song V1.", ex: [
                            {ja:"待っている間、ずっと本を読んでいた。", vi:"Tôi đọc sách SUỐT lúc chờ.", gIds:["aida"]}, 
                            {ja:"留守の間、ずっと犬が吠えていた。", vi:"Chó sủa suốt lúc tôi vắng nhà.", gIds:["aida"]},
                            {ja:"夏休みの間、国に帰っていました。", vi:"Tôi đã ở quê suốt kỳ nghỉ hè.", gIds:["aida"]},
                            {ja:"彼女が寝ている間、僕はゲームをしていた。", vi:"Tôi chơi game suốt lúc cô ấy ngủ.", gIds:["aida"]}
                        ]},
                        right: { title: "〜間に (Aida ni)", desc: "V2 xảy ra tại một điểm thời gian.", ex: [
                            {ja:"留守の間に友達が来た。", vi:"Bạn đến chơi (một lúc nào đó) khi tôi vắng nhà.", gIds:["aida_ni"]},
                            {ja:"授業の間に停電しました。", vi:"Mất điện trong giờ học.", gIds:["aida_ni"]},
                            {ja:"夜の間に雪が降った。", vi:"Tuyết rơi vào lúc đêm (không biết chính xác lúc nào).", gIds:["aida_ni"]}
                        ]}
                    },
                    {
                        id: "comp_07", title: "「前に」 vs 「うちに」",
                        nuance: "'Mae ni' chỉ đơn thuần là thứ tự thời gian. 'Uchi ni' nhấn mạnh việc 'nếu không làm bây giờ thì sẽ không kịp/khó làm'.",
                        left: { title: "〜前に (Mae ni)", desc: "Thứ tự thời gian đơn thuần.", ex: [
                            {ja:"寝る前に歯を磨く。", vi:"Đánh răng trước khi ngủ.", gIds:["mae_ni"]},
                            {ja:"日本に来る前に日本語を勉強した。", vi:"Tôi đã học tiếng Nhật trước khi đến Nhật.", gIds:["mae_ni"]},
                            {ja:"食事の前に手を洗う。", vi:"Rửa tay trước khi ăn.", gIds:["mae_ni"]}
                        ]},
                        right: { title: "〜うちに (Uchi ni)", desc: "Tranh thủ cơ hội/thời điểm.", ex: [
                            {ja:"明るいうちに帰る。", vi:"Về khi trời còn sáng (kẻo tối).", gIds:["uchi_ni"]},
                            {ja:"独身のうちにたくさん旅行したい。", vi:"Muốn du lịch nhiều khi còn độc thân.", gIds:["uchi_ni"]},
                            {ja:"桜がきれいなうちに花見に行こう。", vi:"Đi ngắm hoa khi hoa còn đẹp đi.", gIds:["uchi_ni"]}
                        ]}
                    },
                    {
                        id: "comp_11", title: "「までに」 vs 「まで」",
                        nuance: "'Made' là hành động kéo dài LIÊN TỤC. 'Made ni' là hạn chót (DEADLINE), hành động chỉ cần xảy ra 1 lần trước mốc đó.",
                        left: { title: "〜までに (Made ni)", desc: "Hạn chót (Deadline). Xong trước lúc đó.", ex: [
                            {ja:"5時までに帰ります。", vi:"Sẽ về trước 5 giờ (lúc nào cũng được miễn là trước 5h).", gIds:["made_ni"]},
                            {ja:"明日までにレポートを出して。", vi:"Nộp báo cáo trước ngày mai.", gIds:["made_ni"]},
                            {ja:"授業が始まるまでに来てください。", vi:"Hãy đến trước khi giờ học bắt đầu.", gIds:["made_ni"]}
                        ]},
                        right: { title: "〜まで (Made)", desc: "Kéo dài liên tục cho đến lúc đó.", ex: [
                            {ja:"5時まで働きます。", vi:"Làm việc LIÊN TỤC đến 5 giờ.", gIds:["made"]},
                            {ja:"朝まで飲んだ。", vi:"Uống rượu thâu đêm đến sáng.", gIds:["made"]},
                            {ja:"バスが来るまで待つ。", vi:"Đợi đến khi xe buýt đến.", gIds:["made"]}
                        ]}
                    },
                    {
                        id: "comp_03", title: "「ばかり」 vs 「ところ」",
                        nuance: "'Ta bakari' là cảm giác chủ quan (có thể hôm qua, năm ngoái). 'Ta tokoro' là thực tế khách quan, vừa xong tức thì (vài giây, vài phút).",
                        left: { title: "〜たばかり", desc: "Cảm giác vừa mới làm (có thể lâu rồi).", ex: [
                            {ja:"先月日本に来たばかりです。", vi:"Tôi mới đến Nhật tháng trước (cảm giác vẫn còn mới).", gIds:["bakari_feel"]},
                            {ja:"さっき食べたばかりでお腹がいっぱい。", vi:"Vừa mới ăn xong (cảm giác) nên no lắm.", gIds:["bakari_feel"]},
                            {ja:"買ったばかりの携帯を落とした。", vi:"Làm rơi cái điện thoại mới mua.", gIds:["bakari_feel"]}
                        ]},
                        right: { title: "〜たところ", desc: "Vừa mới xong tức thì (thực tế).", ex: [
                            {ja:"今着いたところです。", vi:"Vừa mới tới nơi xong (ngay lúc này).", gIds:["ta_tokoro"]},
                            {ja:"会議が終わったところだ。", vi:"Cuộc họp vừa mới kết thúc tức thì.", gIds:["ta_tokoro"]},
                            {ja:"ただいま帰ったところです。", vi:"Tôi vừa mới về đến nhà.", gIds:["ta_tokoro"]}
                        ]}
                    }
                ]
            },
            "reason_cond": {
                name: "2. Nguyên nhân & Điều kiện",
                icon: "question",
                color: "green",
                items: [
                    {
                        id: "comp_02", title: "「ので」 vs 「から」",
                        nuance: "'Kara' mang tính chủ quan mạnh, dùng được cho mệnh lệnh, cấm chỉ. 'Node' nhẹ nhàng, lịch sự, khách quan hơn, thích hợp để xin phép, biện bạch.",
                        left: { title: "〜ので (Node)", desc: "Khách quan, nhẹ nhàng, lịch sự.", ex: [
                            {ja:"雨なので中止です。", vi:"Vì mưa nên hủy (khách quan).", gIds:["node"]},
                            {ja:"気分が悪いので帰ります。", vi:"Vì mệt nên tôi về (xin phép).", gIds:["node"]},
                            {ja:"遅れたので叱られた。", vi:"Bị mắng vì đến muộn.", gIds:["node"]},
                            {ja:"バスが来ないので遅れます。", vi:"Vì xe buýt không đến nên tôi sẽ trễ.", gIds:["node"]}
                        ]},
                        right: { title: "〜から (Kara)", desc: "Chủ quan, mạnh mẽ.", ex: [
                            {ja:"危ないから入るな。", vi:"Nguy hiểm đấy, cấm vào! (Mệnh lệnh)", gIds:["kara_reason"]},
                            {ja:"好きだから買った。", vi:"Thích thì mua thôi (Chủ quan).", gIds:["kara_reason"]},
                            {ja:"寒いから窓を閉めて。", vi:"Lạnh quá đóng cửa vào đi.", gIds:["kara_reason"]},
                            {ja:"疲れたから寝る。", vi:"Mệt rồi, ngủ đây.", gIds:["kara_reason"]}
                        ]}
                    },
                    {
                        id: "comp_06", title: "「と・たら・ば・なら」 (Nếu)",
                        nuance: "'To': Kết quả tất yếu (máy móc, tự nhiên). 'Tara': Dùng rộng rãi nhất, giả định quá khứ. 'Ba': Điều kiện cần. 'Nara': Dựa vào thông tin để khuyên.",
                        left: { title: "〜と (To)", desc: "Hễ A thì B (Tất yếu).", ex: [{ja:"ボタンを押すと開く。", vi:"Ấn là mở.", gIds:["to_cond"]}, {ja:"春になると暖かくなる。", vi:"Sang xuân thì ấm.", gIds:["to_cond"]}, {ja:"右に曲がると駅がある。", vi:"Rẽ phải là thấy ga.", gIds:["to_cond"]}] },
                        right: { title: "〜たら (Tara)", desc: "Giả định chung / Sau khi.", ex: [{ja:"雨だったら行かない。", vi:"Nếu mưa thì không đi.", gIds:["tara_cond"]}, {ja:"家に着いたら電話する。", vi:"Về đến nhà tớ sẽ gọi.", gIds:["tara_cond"]}, {ja:"夏になったら海に行きたい。", vi:"Hè đến thì muốn đi biển.", gIds:["tara_cond"]}] },
                        third: { title: "〜ば (Ba)", desc: "Điều kiện cần thiết.", ex: [{ja:"安ければ買う。", vi:"Rẻ thì mua (đắt thì thôi).", gIds:["ba_cond"]}, {ja:"行けばわかる。", vi:"Đi thì sẽ hiểu.", gIds:["ba_cond"]}, {ja:"練習すれば上手になる。", vi:"Luyện tập thì sẽ giỏi.", gIds:["ba_cond"]}] }
                    }
                ]
            },
            "guess_sem": {
                name: "3. Phỏng đoán & Truyền đạt",
                icon: "magic",
                color: "purple",
                items: [
                    {
                        id: "comp_04", title: "「らしい・みたい・よう」",
                        nuance: "'Rashii': Nghe đồn (tin cậy thấp) hoặc đúng chất. 'Mitai': Văn nói của 'You', phỏng đoán bằng giác quan hoặc ví von.",
                        left: { title: "〜らしい (Rashii)", desc: "Nghe đồn / Đúng chất.", ex: [
                            {ja:"彼は来ないらしい。", vi:"Nghe đâu là anh ấy không đến.", gIds:["rashii"]},
                            {ja:"今日は春らしい天気だ。", vi:"Thời tiết đúng chất mùa xuân.", gIds:["rashii"]},
                            {ja:"男らしい人。", vi:"Người đàn ông nam tính (đúng chất).", gIds:["rashii"]},
                            {ja:"彼は学生らしい。", vi:"Nghe nói cậu ta là sinh viên.", gIds:["rashii"]}
                        ]},
                        right: { title: "〜みたい (Mitai)", desc: "Giống như / Phỏng đoán (Văn nói).", ex: [
                            {ja:"夢みたいだ。", vi:"Cứ như là mơ vậy (Ví von).", gIds:["mitai"]},
                            {ja:"雨が降るみたい。", vi:"Hình như trời sắp mưa (Nhìn thấy mây đen).", gIds:["mitai"]},
                            {ja:"子供みたいに泣く。", vi:"Khóc như đứa trẻ con.", gIds:["mitai"]},
                            {ja:"風邪を引いたみたいだ。", vi:"Hình như bị cảm rồi.", gIds:["mitai"]}
                        ]}
                    },
                    {
                        id: "comp_09", title: "「そうです」(nhìn) vs (nghe)",
                        nuance: "'Sou' (bỏ mas/i/na): Phỏng đoán bằng mắt (trông có vẻ). 'Sou' (thể thường): Nghe nói lại (tin tức, người khác).",
                        left: { title: "Vmas/A + そう (Có vẻ)", desc: "Nhìn thấy và đoán.", ex: [
                            {ja:"おいしそうだ。", vi:"Trông ngon thế (nhìn).", gIds:["sou_visual"]},
                            {ja:"雨が降りそうだ。", vi:"Trời trông có vẻ sắp mưa.", gIds:["sou_visual"]},
                            {ja:"彼は元気そうだ。", vi:"Anh ấy trông khỏe mạnh.", gIds:["sou_visual"]}
                        ]},
                        right: { title: "Thể thường + そう (Nghe nói)", desc: "Nghe thông tin từ đâu đó.", ex: [
                            {ja:"おいしいそうだ。", vi:"Nghe nói là ngon (chưa ăn).", gIds:["sou_hear"]},
                            {ja:"雨が降るそうだ。", vi:"Nghe dự báo nói trời sẽ mưa.", gIds:["sou_hear"]},
                            {ja:"彼は元気だそうだ。", vi:"Nghe nói anh ấy khỏe.", gIds:["sou_hear"]}
                        ]}
                    },
                    {
                        id: "comp_15", title: "「はず」 vs 「わけ」",
                        nuance: "'Hazu': Phán đoán chắc chắn của người nói (dựa trên lịch trình, lẽ thường). 'Wake': Sự thấu hiểu lý do, kết quả logic (thảo nào...).",
                        left: { title: "〜はず (Hazu)", desc: "Chắc chắn là (suy đoán có căn cứ).", ex: [
                            {ja:"彼は今日来るはずです。", vi:"Hôm nay chắc chắn anh ấy sẽ đến (có lịch).", gIds:["hazu"]},
                            {ja:"そんなはずはない。", vi:"Chắc chắn không có chuyện đó.", gIds:["hazu"]},
                            {ja:"店は開いているはずだ。", vi:"Giờ này chắc quán mở rồi.", gIds:["hazu"]}
                        ]},
                        right: { title: "〜わけ (Wake)", desc: "Thảo nào / Hèn chi (hiểu ra lý do).", ex: [
                            {ja:"暑いわけだ。エアコンが壊れている。", vi:"Hèn chi nóng thế. Điều hòa hỏng.", gIds:["wake"]},
                            {ja:"道理でできないわけだ。", vi:"Thảo nào mà không làm được.", gIds:["wake"]},
                            {ja:"彼が怒るわけだ。", vi:"Thảo nào anh ấy giận (có lý do).", gIds:["wake"]}
                        ]}
                    }
                ]
            },
            "others": {
                name: "4. Các cặp khác",
                icon: "list-ul",
                color: "purple",
                items: [
                    {
                        id: "comp_08", title: "「やすい」 vs 「がち」",
                        nuance: "'Yasui': Tính chất dễ làm của hành động (dễ viết, dễ vỡ). 'Gachi': Xu hướng tiêu cực lặp đi lặp lại (hay ốm, hay quên).",
                        left: { title: "〜やすい (Yasui)", desc: "Dễ làm (tính chất).", ex: [
                            {ja:"このペンは書きやすい。", vi:"Bút này dễ viết.", gIds:["yasui"]},
                            {ja:"ガラスは割れやすい。", vi:"Thủy tinh dễ vỡ.", gIds:["yasui"]},
                            {ja:"わかりやすい説明。", vi:"Lời giải thích dễ hiểu.", gIds:["yasui"]}
                        ]},
                        right: { title: "〜がち (Gachi)", desc: "Thường hay (xu hướng xấu).", ex: [
                            {ja:"最近、病気がちだ。", vi:"Dạo này hay ốm.", gIds:["gachi"]},
                            {ja:"電車は遅れがちだ。", vi:"Tàu thường hay trễ.", gIds:["gachi"]},
                            {ja:"休みがちになる。", vi:"Trở nên hay nghỉ làm.", gIds:["gachi"]}
                        ]}
                    },
                    {
                        id: "comp_13", title: "授受表現 (Cho nhận)",
                        nuance: "Chú ý hướng của hành động. 'Ageru': Mình -> Người khác. 'Kureru': Người khác -> Mình. 'Morau': Mình <- Người khác (chủ ngữ là Mình).",
                        left: { title: "あげる・やる", desc: "Mình cho người khác.", ex: [{ja:"花に水をやる。", vi:"Cho (hoa) tưới nước.", gIds:["te_ageru"]}, {ja:"友達に本をあげる。", vi:"Tặng sách cho bạn.", gIds:["te_ageru"]}] },
                        right: { title: "くれる・くださる", desc: "Người khác cho mình.", ex: [{ja:"母がくれた。", vi:"Mẹ đã cho tôi.", gIds:["te_kureru"]}, {ja:"先生がくださった。", vi:"Thầy đã cho (kính ngữ).", gIds:["te_kureru"]}] },
                        third: { title: "もらう・いただく", desc: "Mình nhận từ người khác.", ex: [{ja:"友達にもらった。", vi:"Đã nhận từ bạn.", gIds:["te_morau"]}, {ja:"先生にいただいた。", vi:"Đã nhận từ thầy (khiêm nhường).", gIds:["te_morau"]}] }
                    },
                    {
                        id: "comp_14", title: "「ことにする」 vs 「ことになる」",
                        nuance: "'Koto ni suru': Quyết định chủ quan của bản thân. 'Koto ni naru': Quyết định do hoàn cảnh hoặc người khác áp đặt.",
                        left: { title: "〜ことにする", desc: "Tự mình quyết định.", ex: [
                            {ja:"明日から走ることにした。", vi:"Tôi quyết định chạy bộ từ mai.", gIds:["koto_ni_suru"]},
                            {ja:"酒をやめることにする。", vi:"Quyết định bỏ rượu.", gIds:["koto_ni_suru"]},
                            {ja:"買わないことにした。", vi:"Quyết định không mua nữa.", gIds:["koto_ni_suru"]}
                        ]},
                        right: { title: "〜ことになる", desc: "Được quyết định (bởi hoàn cảnh).", ex: [
                            {ja:"転勤することになった。", vi:"Được quyết định chuyển công tác.", gIds:["koto_ni_naru"]},
                            {ja:"来年結婚することになった。", vi:"Đã định ngày cưới (thống nhất rồi).", gIds:["koto_ni_naru"]},
                            {ja:"中止することになった。", vi:"Bị hủy bỏ (quyết định chung).", gIds:["koto_ni_naru"]}
                        ]}
                    }
                ]
            },
            "synonyms": {
                name: "6. Từ Đồng nghĩa & Gần nghĩa",
                icon: "clone",
                color: "teal",
                items: [
                     {
                        id: "comp_vocab_01", title: "「知る」 vs 「分かる」",
                        nuance: "'Shiru': Tiếp nhận thông tin mới (Biết tin, biết người). 'Wakaru': Hiểu bản chất, lý do, hoặc biết đường đi, biết ngôn ngữ.",
                        left: { title: "知る (Shiru)", desc: "Biết thông tin/người.", ex: [
                            {ja:"彼の名前を知っていますか。", vi:"Bạn có biết tên anh ấy không?", gIds:["shiru"]},
                            {ja:"ニュースを知った。", vi:"Đã biết tin tức.", gIds:["shiru"]},
                            {ja:"あの店を知っている。", vi:"Tôi biết quán đó (từng nghe/đến).", gIds:["shiru"]},
                            {ja:"知りません。", vi:"Tôi không biết (thông tin đó).", gIds:["shiru"]}
                        ]},
                        right: { title: "分かる (Wakaru)", desc: "Hiểu / Nắm rõ.", ex: [
                            {ja:"意味が分かる。", vi:"Hiểu ý nghĩa.", gIds:["wakaru"]},
                            {ja:"日本語が分かる。", vi:"Biết (hiểu/dùng được) tiếng Nhật.", gIds:["wakaru"]},
                            {ja:"駅への行き方が分かる。", vi:"Biết đường đến ga.", gIds:["wakaru"]},
                            {ja:"気持ちが分かる。", vi:"Hiểu cảm giác đó.", gIds:["wakaru"]}
                        ]}
                    },
                    {
                        id: "comp_vocab_02", title: "「こと」 vs 「の」 (Danh từ hóa)",
                        nuance: "'Koto' dùng cho khái niệm trừu tượng, ngữ pháp cố định (koto ga aru). 'No' dùng cho tri giác (nhìn, nghe), nhấn mạnh, mang tính cụ thể.",
                        left: { title: "〜こと (Koto)", desc: "Trừu tượng / Ngữ pháp.", ex: [
                            {ja:"趣味は泳ぐことです。", vi:"Sở thích là bơi lội.", gIds:["koto"]},
                            {ja:"富士山に登ったことがある。", vi:"Đã từng leo núi Phú Sĩ.", gIds:["koto"]},
                            {ja:"大切なことは...", vi:"Điều quan trọng là...", gIds:["koto"]},
                            {ja:"日本語を話すことができる。", vi:"Có thể nói tiếng Nhật.", gIds:["koto"]}
                        ]},
                        right: { title: "〜の (No)", desc: "Cụ thể / Tri giác / Nhấn mạnh.", ex: [
                            {ja:"彼が走っているのを見た。", vi:"Tôi nhìn thấy anh ấy đang chạy.", gIds:["no_nomial"]},
                            {ja:"ピアノを弾くのは楽しい。", vi:"Việc chơi piano rất vui.", gIds:["no_nomial"]},
                            {ja:"電話したのは彼だ。", vi:"Người gọi điện chính là anh ấy (Nhấn mạnh).", gIds:["no_nomial"]},
                            {ja:"雨が降るのを待つ。", vi:"Chờ trời mưa.", gIds:["no_nomial"]}
                        ]}
                    },
                    {
                        id: "comp_vocab_03", title: "「会う」 vs 「出会う」",
                        nuance: "'Au': Gặp gỡ thông thường (có hẹn hoặc tình cờ). 'Deau': Gặp gỡ tình cờ, định mệnh, gặp lần đầu tiên.",
                        left: { title: "会う (Au)", desc: "Gặp (người/vật).", ex: [
                            {ja:"駅で友達に会った。", vi:"Gặp bạn ở nhà ga.", gIds:["au"]},
                            {ja:"明日先生に会う予定だ。", vi:"Dự định mai gặp thầy.", gIds:["au"]},
                            {ja:"ひどい目に会った。", vi:"Gặp chuyện xui xẻo.", gIds:["au"]}
                        ]},
                        right: { title: "出会う (Deau)", desc: "Gặp gỡ (định mệnh/tình cờ).", ex: [
                            {ja:"大学で妻と出会った。", vi:"Gặp vợ ở đại học (lần đầu/định mệnh).", gIds:["deau"]},
                            {ja:"素晴らしい本に出会った。", vi:"Tình cờ tìm được cuốn sách tuyệt vời.", gIds:["deau"]},
                            {ja:"旅先で面白い人に出会った。", vi:"Gặp người thú vị khi đi du lịch.", gIds:["deau"]}
                        ]}
                    },
                    {
                        id: "comp_vocab_04", title: "「嬉しい」 vs 「楽しい」",
                        nuance: "'Ureshii': Cảm xúc tức thời khi nhận được điều tốt (vui mừng). 'Tanoshii': Cảm giác tận hưởng một quá trình (vui vẻ).",
                        left: { title: "嬉しい (Ureshii)", desc: "Vui mừng (Tức thời).", ex: [
                            {ja:"合格して嬉しい。", vi:"Vui vì thi đỗ.", gIds:["ureshii"]},
                            {ja:"プレゼントをもらって嬉しい。", vi:"Vui vì nhận được quà.", gIds:["ureshii"]},
                            {ja:"会えて嬉しい。", vi:"Vui vì được gặp bạn.", gIds:["ureshii"]}
                        ]},
                        right: { title: "楽しい (Tanoshii)", desc: "Vui vẻ (Quá trình).", ex: [
                            {ja:"パーティーは楽しかった。", vi:"Bữa tiệc rất vui.", gIds:["tanoshii"]},
                            {ja:"毎日が楽しい。", vi:"Mỗi ngày đều vui vẻ.", gIds:["tanoshii"]},
                            {ja:"テニスをするのは楽しい。", vi:"Chơi tennis rất vui.", gIds:["tanoshii"]}
                        ]}
                    }
                ]
            },
            "antonyms": {
                name: "5. Từ vựng Trái nghĩa",
                icon: "arrows-alt-h",
                color: "orange",
                items: [
                    { id: "ant_01", title: "Tính từ đuôi I", isAntonym: true,
                      left: { title: "大きい・高い・長い", desc: "To, Cao/Đắt, Dài", ex: [{ja:"背が高い。", vi:"Dáng cao."}, {ja:"値段が高い。", vi:"Giá đắt."}, {ja:"長い髪。", vi:"Tóc dài."}] },
                      right: { title: "小さい・低い/安い・短い", desc: "Nhỏ, Thấp/Rẻ, Ngắn", ex: [{ja:"背が低い。", vi:"Dáng thấp."}, {ja:"安い服。", vi:"Quần áo rẻ."}, {ja:"短いスカート。", vi:"Váy ngắn."}] } 
                    },
                    { id: "ant_02", title: "Tính từ đuôi Na", isAntonym: true,
                      left: { title: "静か・好き・便利", desc: "Yên tĩnh, Thích, Tiện lợi", ex: [{ja:"静かな部屋。", vi:"Phòng yên tĩnh."}, {ja:"好きな人。", vi:"Người mình thích."}, {ja:"便利な道具。", vi:"Dụng cụ tiện lợi."}] },
                      right: { title: "にぎやか・嫌い・不便", desc: "Náo nhiệt, Ghét, Bất tiện", ex: [{ja:"にぎやかな通り。", vi:"Phố náo nhiệt."}, {ja:"嫌いな食べ物。", vi:"Đồ ăn đáng ghét."}, {ja:"交通が不便だ。", vi:"Giao thông bất tiện."}] }
                    },
                    { id: "ant_03", title: "Động từ", isAntonym: true,
                      left: { title: "行く・入る・開ける", desc: "Đi, Vào, Mở", ex: [{ja:"学校へ行く。", vi:"Đi học."}, {ja:"部屋に入る。", vi:"Vào phòng."}, {ja:"ドアを開ける。", vi:"Mở cửa."}] },
                      right: { title: "来る・出る・閉める", desc: "Đến, Ra, Đóng", ex: [{ja:"ここへ来る。", vi:"Đến đây."}, {ja:"外に出る。", vi:"Ra ngoài."}, {ja:"窓を閉める。", vi:"Đóng cửa sổ."}] }
                    }
                ]
            }
        };

        let currentCategory = 'time_action';
        let currentGrammarId = 'comp_01';
        let currentQuizData = null;

        function init() {
            renderSidebar();
            selectCategory('time_action');
            setupMobileDrawer();
        }

        function renderSidebar() {
            const list = document.getElementById('categoryList');
            const mobileList = document.getElementById('mobileCategoryList');
            let html = '';
            
            Object.keys(grammarData).forEach(key => {
                const cat = grammarData[key];
                html += `
                    <div class="mb-2">
                        <div onclick="selectCategory('${key}')" class="cat-header p-3 rounded-lg cursor-pointer flex items-center justify-between font-bold text-gray-700 hover:bg-gray-100" data-cat="${key}">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-${cat.color}-100 text-${cat.color}-600 flex items-center justify-center"><i class="fas fa-${cat.icon}"></i></div>
                                <span>${cat.name}</span>
                            </div>
                            <i class="fas fa-chevron-down text-xs text-gray-400 transition-transform" id="chevron-${key}"></i>
                        </div>
                        <div id="list-${key}" class="hidden pl-11 pr-2 space-y-1 mt-1">
                            ${cat.items.map((g, idx) => `
                                <div onclick="loadGrammar('${key}', '${g.id}')" class="g-item p-2 rounded text-sm cursor-pointer text-gray-600" id="item-${g.id}">
                                    ${g.title}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            list.innerHTML = html;
            mobileList.innerHTML = html;
        }

        function selectCategory(key) {
            Object.keys(grammarData).forEach(k => {
                document.getElementById(`list-${k}`)?.classList.add('hidden');
                document.getElementById(`chevron-${k}`)?.classList.remove('rotate-180');
                document.querySelectorAll(`.cat-header[data-cat="${k}"]`).forEach(el => el.classList.remove('active'));
            });

            document.querySelectorAll(`[id^="list-${key}"]`).forEach(el => el.classList.remove('hidden'));
            document.querySelectorAll(`[id^="chevron-${key}"]`).forEach(el => el.classList.add('rotate-180'));
            document.querySelectorAll(`.cat-header[data-cat="${key}"]`).forEach(el => el.classList.add('active'));
            
            const firstItem = grammarData[key].items[0];
            loadGrammar(key, firstItem.id);
        }

        function loadGrammar(catKey, gId) {
            currentGrammarId = gId;
            currentCategory = catKey;
            
            document.querySelectorAll('.g-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll(`[id^="item-${gId}"]`).forEach(el => el.classList.add('active'));

            const data = grammarData[catKey].items.find(i => i.id === gId);
            if(!data) return;

            document.getElementById('c-cat-name').innerText = grammarData[catKey].name;
            document.getElementById('c-title').innerText = data.title;
            document.getElementById('c-desc').innerText = data.isAntonym ? "Các cặp từ trái nghĩa thường gặp." : "So sánh cách sử dụng và sắc thái ý nghĩa.";
            
            // Nuance Tip
            const nuanceBox = document.getElementById('c-nuance-box');
            if (data.nuance) {
                nuanceBox.classList.remove('hidden');
                document.getElementById('c-nuance-text').innerText = data.nuance;
            } else {
                nuanceBox.classList.add('hidden');
            }

            // Load comparisons
            updateSide('left', data.left);
            updateSide('right', data.right);
            
            // Handle 3rd comparison item if exists
            const thirdBox = document.getElementById('third-box');
            if (data.third) {
                thirdBox.classList.remove('hidden');
                document.getElementById('third-title').innerText = data.third.title;
                document.getElementById('third-desc').innerText = data.third.desc;
                renderExamples('third-examples', data.third.ex);
                document.getElementById('comp-container').classList.remove('md:grid-cols-2');
                document.getElementById('comp-container').classList.add('md:grid-cols-3');
            } else {
                thirdBox.classList.add('hidden');
                document.getElementById('comp-container').classList.add('md:grid-cols-2');
                document.getElementById('comp-container').classList.remove('md:grid-cols-3');
            }

            toggleMobileDrawer(false);
        }

        function updateSide(side, data) {
            document.getElementById(`${side}-title`).innerText = data.title;
            document.getElementById(`${side}-desc`).innerText = data.desc;
            renderExamples(`${side}-examples`, data.ex);
        }

        function renderExamples(containerId, examples) {
            const container = document.getElementById(containerId);
            container.innerHTML = examples.map(e => {
                const grammarBtn = e.gIds ? `<button onclick="openExplan('${e.gIds.join(',')}')" class="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded border border-indigo-100 hover:bg-indigo-100"><i class="fas fa-info-circle"></i> GT</button>` : '';
                return `
                <div class="border-l-2 border-gray-200 pl-3 py-1 hover:bg-gray-50 transition rounded-r">
                    <div class="flex justify-between items-start mb-1">
                        <p class="font-bold text-gray-800 ja-text text-base cursor-pointer hover:text-indigo-600 leading-snug" onclick="speakText('${e.ja.replace(/'/g, "\\'")}')">${e.ja}</p>
                        <div class="flex gap-1 items-center flex-shrink-0">
                            <button onclick="speakText('${e.ja.replace(/'/g, "\\'")}')" class="text-gray-400 hover:text-indigo-500"><i class="fas fa-volume-up text-xs"></i></button>
                            ${grammarBtn}
                        </div>
                    </div>
                    <p class="text-xs text-gray-500">${e.vi}</p>
                </div>
            `}).join('');
        }

        // --- GRAMMAR MODAL LOGIC ---
        function openExplan(idsStr) {
             const ids = idsStr.split(','); 
             const f = document.getElementById('dgFormula'); 
             const e = document.getElementById('dgExplanation');
             
             f.innerHTML = '';
             e.innerHTML = ids.map(id => {
                 const g = grammarRepo[id];
                 if (!g) return `<div class="text-red-400 text-xs">Mã ngữ pháp: ${id}</div>`;
                 return `
                 <div class="mb-4 last:mb-0">
                     <h4 class="font-bold text-indigo-700 flex items-center gap-2"><i class="fas fa-bookmark text-sm"></i> ${g.title}</h4>
                     <code class="block bg-gray-100 p-2 rounded text-sm font-mono my-2 text-gray-700">${g.formula}</code>
                     <p class="text-sm text-gray-600">${g.desc}</p>
                 </div>`;
             }).join('<hr class="my-4 border-gray-100">');
             
             document.getElementById('detailGrammarModal').classList.remove('hidden');
             setTimeout(() => {
                 document.getElementById('detailGrammarBackdrop').classList.remove('opacity-0');
                 document.getElementById('detailGrammarPanel').classList.remove('opacity-0', 'scale-95');
             }, 10);
        }

        function closeModal(id) {
            const b = document.getElementById('detailGrammarBackdrop');
            const p = document.getElementById('detailGrammarPanel');
            b.classList.add('opacity-0');
            p.classList.add('opacity-0', 'scale-95');
            setTimeout(() => document.getElementById(id).classList.add('hidden'), 200);
        }

        // --- QUIZ LOGIC ---
        function switchMode(mode) {
            document.getElementById('study-view').classList.toggle('hidden', mode !== 'study');
            document.getElementById('practice-view').classList.toggle('hidden', mode !== 'practice');
            
            const btnStudy = document.getElementById('btn-study');
            const btnPractice = document.getElementById('btn-practice');
            
            if(mode === 'study') {
                btnStudy.className = "px-4 py-1.5 rounded-lg text-sm font-bold bg-indigo-50 text-indigo-600 shadow-sm";
                btnPractice.className = "px-4 py-1.5 rounded-lg text-sm font-bold text-gray-500 hover:bg-gray-100";
            } else {
                btnPractice.className = "px-4 py-1.5 rounded-lg text-sm font-bold bg-green-50 text-green-600 shadow-sm";
                btnStudy.className = "px-4 py-1.5 rounded-lg text-sm font-bold text-gray-500 hover:bg-gray-100";
                generateQuiz();
            }
        }
        
        function generateQuiz() {
            const catKeys = Object.keys(grammarData);
            const randCat = grammarData[catKeys[Math.floor(Math.random() * catKeys.length)]];
            const randItem = randCat.items[Math.floor(Math.random() * randCat.items.length)];
            
            const sides = [randItem.left, randItem.right];
            if(randItem.third) sides.push(randItem.third);
            const randSide = sides[Math.floor(Math.random() * sides.length)];
            const targetEx = randSide.ex[Math.floor(Math.random() * randSide.ex.length)];
            
            // Smarter segmentation
            const segments = targetEx.ja.split(/(?=[をにがはの。て、])|(?<=[をにがはの。て、])/g).filter(s => s.trim().length > 0);
            
            currentQuizData = {
                original: targetEx.ja,
                vi: targetEx.vi,
                segments: shuffleArray([...segments])
            };

            document.getElementById('quiz-question-vi').innerText = `"${currentQuizData.vi}"`;
            document.getElementById('quiz-answer-zone').innerHTML = '<span class="text-gray-400 italic text-sm pointer-events-none">Kéo từ vào đây</span>';
            
            const optionsZone = document.getElementById('quiz-options-zone');
            optionsZone.innerHTML = '';
            currentQuizData.segments.forEach((seg) => {
                const btn = document.createElement('button');
                btn.className = "bg-white border-2 border-indigo-100 text-indigo-700 font-bold py-2 px-4 rounded-lg shadow-sm hover:bg-indigo-50 active:scale-95 transition ja-text text-lg";
                btn.innerText = seg;
                btn.onclick = () => addToAnswer(seg, btn);
                optionsZone.appendChild(btn);
            });

            document.getElementById('quiz-feedback').classList.add('hidden');
            document.getElementById('btn-submit-quiz').disabled = false;
        }

        function addToAnswer(text, btnElement) {
            const zone = document.getElementById('quiz-answer-zone');
            if (zone.children.length === 1 && zone.children[0].tagName === 'SPAN') zone.innerHTML = '';
            
            const chip = document.createElement('div');
            chip.className = "bg-indigo-600 text-white px-3 py-1 rounded-lg font-bold shadow-md cursor-pointer hover:bg-red-500 transition ja-text flex items-center gap-2 animate-slide-in";
            chip.innerHTML = `${text}`;
            chip.onclick = () => {
                chip.remove();
                btnElement.classList.remove('opacity-0', 'pointer-events-none');
                if(zone.children.length === 0) zone.innerHTML = '<span class="text-gray-400 italic text-sm pointer-events-none">Kéo từ vào đây</span>';
            };
            
            zone.appendChild(chip);
            btnElement.classList.add('opacity-0', 'pointer-events-none');
        }
        
        function resetQuizQuestion() { generateQuiz(); }

        function checkQuizAnswer() {
            const zone = document.getElementById('quiz-answer-zone');
            const userAnswer = Array.from(zone.children).map(c => c.innerText).join('');
            const isCorrect = userAnswer === currentQuizData.original.replace(/\s/g, '');
            
            const fb = document.getElementById('quiz-feedback');
            const icon = document.getElementById('fb-icon');
            const text = document.getElementById('fb-text');
            const sub = document.getElementById('fb-subtext');
            
            fb.classList.remove('hidden', 'flex');
            fb.classList.add('flex');
            
            if (isCorrect) {
                icon.innerHTML = '<i class="fas fa-check-circle text-green-500"></i>';
                text.innerText = "Chính xác!";
                text.className = "text-2xl font-bold mb-2 text-green-600";
                sub.innerText = currentQuizData.original;
                speakText(currentQuizData.original);
            } else {
                icon.innerHTML = '<i class="fas fa-times-circle text-red-500"></i>';
                text.innerText = "Tiếc quá!";
                text.className = "text-2xl font-bold mb-2 text-red-600";
                sub.innerText = `Đáp án đúng: ${currentQuizData.original}`;
            }
        }
        
        function nextQuizQuestion() { generateQuiz(); }

        // --- UTILS ---
        function toggleMobileDrawer(forceState) {
            const drawer = document.getElementById('mobileDrawer');
            const backdrop = document.getElementById('drawerBackdrop');
            const isOpen = forceState !== undefined ? forceState : !drawer.classList.contains('closed');
            if (!isOpen) { drawer.classList.remove('open'); drawer.classList.add('closed'); backdrop.classList.add('hidden'); }
            else { drawer.classList.remove('closed'); drawer.classList.add('open'); backdrop.classList.remove('hidden'); }
        }
        function setupMobileDrawer() { toggleMobileDrawer(false); }
        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }
        function speakText(text) { if ('speechSynthesis' in window) { const u = new SpeechSynthesisUtterance(text); u.lang = 'ja-JP'; u.rate = 0.9; speechSynthesis.speak(u); } }

        document.getElementById('searchInput').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
             // Simple search: filter headers
             document.querySelectorAll('.cat-header').forEach(item => {
                // Expand if matched or collapse
                // This is complex with categories, simplifying to just console log for now
             });
        });

        init();
    </script>
</body>
</html>
