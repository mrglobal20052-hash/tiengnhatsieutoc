<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AzaGrammar Master - Dễ Nhầm Lẫn</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #f0f2f5; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        .ja-text { font-family: 'Noto Sans JP', sans-serif; }
        
        /* Custom Scrollbar */
        .scroller::-webkit-scrollbar { width: 6px; }
        .scroller::-webkit-scrollbar-track { background: transparent; }
        .scroller::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        
        /* Category Item */
        .cat-header { transition: all 0.2s; }
        .cat-header:hover { background-color: #e0e7ff; }
        .cat-header.active { background-color: #4f46e5; color: white; }
        .cat-header.active i { color: white; }
        
        /* Grammar Item in List */
        .g-item { transition: all 0.2s; border-left: 3px solid transparent; }
        .g-item:hover { background-color: #f8fafc; padding-left: 1rem; }
        .g-item.active { background-color: #eff6ff; border-left-color: #4f46e5; color: #4338ca; padding-left: 1rem; font-weight: 700; }

        /* Comparison Box */
        .comp-box { transition: transform 0.2s; }
        .comp-box:hover { transform: translateY(-2px); }
        
        /* Animation */
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-in { animation: slideIn 0.3s ease-out forwards; }
        
        /* Mobile Drawer */
        #mobileDrawer { transition: transform 0.3s ease-in-out; }
        #mobileDrawer.open { transform: translateX(0); }
        #mobileDrawer.closed { transform: translateX(-100%); }
    </style>
</head>
<body class="text-slate-800">

    <!-- HEADER -->
    <header class="bg-white border-b border-gray-200 flex-none z-30 h-14 md:h-16 flex items-center justify-between px-4 shadow-sm">
        <div class="flex items-center gap-3">
            <button class="md:hidden text-gray-500 text-xl" onclick="toggleMobileDrawer()"><i class="fas fa-bars"></i></button>
            <div class="flex items-center gap-2 text-indigo-600">
                <i class="fas fa-balance-scale text-2xl"></i>
                <h1 class="font-extrabold text-lg md:text-xl tracking-tight">AzaGrammar <span class="text-xs bg-orange-100 px-2 py-0.5 rounded-full text-orange-700 ml-1">Confusing Pairs</span></h1>
            </div>
        </div>
        <div class="flex gap-2">
             <button onclick="switchMode('study')" id="btn-study" class="px-4 py-1.5 rounded-lg text-sm font-bold bg-indigo-50 text-indigo-600 hover:bg-indigo-100 transition">Học Tập</button>
             <button onclick="switchMode('practice')" id="btn-practice" class="px-4 py-1.5 rounded-lg text-sm font-bold text-gray-500 hover:bg-gray-100 transition">Luyện Tập</button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- SIDEBAR (Topic List) -->
        <aside id="sidebar" class="hidden md:flex w-80 bg-white border-r border-gray-200 flex-col overflow-hidden z-20">
            <div class="p-3 border-b border-gray-100">
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i>
                    <input type="text" id="searchInput" placeholder="Tìm cặp từ (vd: aida, node...)" class="w-full pl-9 pr-4 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition">
                </div>
            </div>
            <div id="categoryList" class="flex-1 scroller overflow-y-auto pb-20">
                <!-- Categories will be injected here -->
            </div>
        </aside>

        <!-- MOBILE DRAWER -->
        <div id="mobileDrawer" class="fixed inset-y-0 left-0 w-3/4 max-w-xs bg-white shadow-2xl z-50 md:hidden closed flex flex-col">
            <div class="p-4 bg-indigo-600 text-white flex justify-between items-center">
                <h2 class="font-bold text-lg">Danh sách chủ đề</h2>
                <button onclick="toggleMobileDrawer()"><i class="fas fa-times"></i></button>
            </div>
            <div id="mobileCategoryList" class="flex-1 scroller overflow-y-auto"></div>
        </div>
        <div id="drawerBackdrop" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden glass" onclick="toggleMobileDrawer()"></div>

        <!-- MAIN CONTENT AREA -->
        <main class="flex-1 relative bg-[#f3f4f6] overflow-hidden flex flex-col">
            
            <!-- STUDY MODE -->
            <div id="study-view" class="flex-1 flex flex-col h-full overflow-y-auto scroller p-4 md:p-8">
                <div class="max-w-5xl mx-auto w-full pb-20 animate-slide-in">
                    
                    <!-- Title Card -->
                    <div class="mb-6 text-center">
                        <span class="text-xs font-bold text-indigo-500 uppercase tracking-wider bg-indigo-100 px-3 py-1 rounded-full" id="c-cat-name">Category</span>
                        <h2 class="text-3xl font-extrabold text-gray-800 mt-2 mb-1" id="c-title">Title</h2>
                        <p class="text-gray-500" id="c-desc">Description</p>
                    </div>

                    <!-- Comparison Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="comp-container">
                        <!-- Left Side -->
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 comp-box flex flex-col">
                            <h3 class="text-xl font-bold text-indigo-700 mb-2 border-b border-indigo-100 pb-2" id="left-title">...</h3>
                            <p class="text-sm text-gray-600 mb-4 bg-gray-50 p-3 rounded-lg" id="left-desc">...</p>
                            <div class="space-y-4 flex-1" id="left-examples"></div>
                        </div>

                        <!-- Right Side -->
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 comp-box flex flex-col">
                            <h3 class="text-xl font-bold text-pink-700 mb-2 border-b border-pink-100 pb-2" id="right-title">...</h3>
                            <p class="text-sm text-gray-600 mb-4 bg-gray-50 p-3 rounded-lg" id="right-desc">...</p>
                            <div class="space-y-4 flex-1" id="right-examples"></div>
                        </div>
                    </div>

                    <!-- Third Side (Optional) -->
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 comp-box mt-6 hidden" id="third-box">
                         <h3 class="text-xl font-bold text-green-700 mb-2 border-b border-green-100 pb-2" id="third-title">...</h3>
                         <p class="text-sm text-gray-600 mb-4 bg-gray-50 p-3 rounded-lg" id="third-desc">...</p>
                         <div class="space-y-4" id="third-examples"></div>
                    </div>

                </div>
            </div>

            <!-- PRACTICE MODE (Quiz) -->
            <div id="practice-view" class="hidden flex-1 flex-col h-full bg-white relative">
                <div class="absolute inset-0 flex flex-col max-w-2xl mx-auto p-6 justify-center">
                    <div class="mb-8 text-center">
                        <div class="inline-block bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold mb-2" id="quiz-progress">Câu 1/10</div>
                        <h2 class="text-xl font-bold text-gray-800 mb-2">Sắp xếp câu hoàn chỉnh</h2>
                        <p class="text-gray-500 text-sm">Chọn các từ bên dưới theo đúng thứ tự</p>
                    </div>

                    <!-- Quiz Display -->
                    <div class="bg-gray-50 rounded-2xl p-6 border-2 border-dashed border-gray-200 mb-6 min-h-[120px] flex flex-wrap items-center gap-2 justify-center" id="quiz-answer-zone"></div>

                    <div class="mb-8">
                         <p class="text-center text-gray-600 text-sm mb-4" id="quiz-question-vi">...</p>
                         <div class="flex flex-wrap justify-center gap-3" id="quiz-options-zone"></div>
                    </div>

                    <div class="flex gap-4">
                        <button onclick="resetQuizQuestion()" class="flex-1 py-3 rounded-xl border border-gray-300 text-gray-600 font-bold hover:bg-gray-50 transition"><i class="fas fa-undo"></i> Làm lại</button>
                        <button onclick="checkQuizAnswer()" class="flex-1 py-3 rounded-xl bg-indigo-600 text-white font-bold hover:bg-indigo-700 shadow-lg transition shadow-indigo-200" id="btn-submit-quiz">Kiểm tra</button>
                    </div>
                    
                    <!-- Feedback Overlay -->
                    <div id="quiz-feedback" class="absolute inset-0 bg-white/90 backdrop-blur-sm z-10 hidden flex-col items-center justify-center text-center p-6 rounded-2xl">
                        <div class="text-6xl mb-4" id="fb-icon"></div>
                        <h3 class="text-2xl font-bold mb-2" id="fb-text"></h3>
                        <p class="text-gray-500 mb-6" id="fb-subtext"></p>
                        <button onclick="nextQuizQuestion()" class="bg-gray-900 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:scale-105 transition">Tiếp tục <i class="fas fa-arrow-right ml-2"></i></button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- MODAL: GRAMMAR DETAIL -->
    <div id="detailGrammarModal" class="fixed inset-0 z-[90] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity opacity-0" id="detailGrammarBackdrop" onclick="closeModal('detailGrammarModal')"></div>
        <div class="bg-white rounded-2xl w-full max-w-md relative z-10 shadow-2xl transform transition-all scale-95 opacity-0 flex flex-col" id="detailGrammarPanel">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 rounded-t-2xl">
                <div class="flex items-center gap-2">
                    <div class="bg-indigo-100 p-1.5 rounded-lg text-indigo-600"><i class="fas fa-info-circle"></i></div>
                    <h3 class="text-lg font-bold text-gray-800">Giải thích Ngữ pháp</h3>
                </div>
                <button onclick="closeModal('detailGrammarModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6">
                <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-3 text-center mb-4 shadow-sm">
                    <code class="text-lg font-bold text-indigo-700 font-mono" id="dgFormula"></code>
                </div>
                <div id="dgExplanation" class="text-gray-600 text-sm mb-4 space-y-3 leading-relaxed"></div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. GRAMMAR REPO (Day 34) ---
        const grammarRepo = {
            "aida_ni": { title: "Trong lúc (khoảnh khắc)", formula: "Vている・Nの + 間に", desc: "Hành động xảy ra và kết thúc tại 1 điểm trong khoảng thời gian V1 diễn ra.", ex: "留守の間に泥棒が入った。" },
            "uchi_ni": { title: "Nhân lúc / Trong lúc", formula: "Vる・Vない・A・Nの + うちに", desc: "Tranh thủ làm gì trước khi trạng thái thay đổi. Hoặc trong khi đang làm gì thì có sự thay đổi tự nhiên.", ex: "温かいうちに食べてください。" },
            "aida": { title: "Trong suốt", formula: "Vている・Nの + 間", desc: "Hành động V2 diễn ra liên tục suốt thời gian V1 diễn ra.", ex: "待っている間、本を読んでいた。" },
            "node": { title: "Vì (Khách quan)", formula: "Thể thường + ので", desc: "Nguyên nhân, lý do nhẹ nhàng, lịch sự.", ex: "雨なので中止です。" },
            "kara_reason": { title: "Vì (Chủ quan)", formula: "Thể thường + から", desc: "Nguyên nhân mang tính chủ quan, mạnh mẽ hơn.", ex: "危ないからやめなさい。" },
            "bakari_feel": { title: "Vừa mới (Cảm giác)", formula: "Vた + ばかり", desc: "Cảm thấy như vừa mới làm xong (dù thực tế có thể lâu).", ex: "日本に来たばかりです。" },
            "ta_tokoro": { title: "Vừa mới (Thực tế)", formula: "Vた + ところ", desc: "Vừa mới kết thúc tức thì.", ex: "今帰ったところです。" },
            "rashii": { title: "Nghe nói / Đúng chất", formula: "Thể thường + らしい", desc: "Suy đoán dựa trên tin đồn hoặc mang tính chất điển hình.", ex: "彼は来ないらしい。" },
            "mitai": { title: "Hình như / Giống như", formula: "Thể thường + みたい", desc: "Suy đoán dựa trên cảm nhận trực quan hoặc so sánh ví von.", ex: "夢みたいだ。" },
            "tame_ni_purpose": { title: "Để (Mục đích)", formula: "Vる・Nの + ために", desc: "Mục đích, vế trước và sau cùng chủ ngữ.", ex: "家を買うために貯金する。" },
            "you_ni_purpose": { title: "Để (Trạng thái)", formula: "Vる・Vない + ように", desc: "Mục đích đạt được trạng thái, thường dùng với tự động từ/thể khả năng.", ex: "忘れないようにメモする。" },
            "to_cond": { title: "Hễ... thì (Tất yếu)", formula: "Vる + と", desc: "Kết quả tự nhiên, quy luật, máy móc.", ex: "春になると花が咲く。" },
            "tara_cond": { title: "Nếu... (Giả định)", formula: "Vた + ら", desc: "Giả định chung, dùng được cho nhiều trường hợp.", ex: "雨が降ったら行かない。" },
            "ba_cond": { title: "Nếu... (Điều kiện)", formula: "Vば / Aければ", desc: "Điều kiện cần thiết.", ex: "安ければ買う。" },
            "mae_ni": { title: "Trước khi", formula: "Vる + 前に", desc: "Thứ tự hành động.", ex: "寝る前に歯を磨く。" },
            "yasui": { title: "Dễ làm", formula: "V(bỏ mas) + やすい", desc: "Tính chất dễ thực hiện.", ex: "書きやすいペン。" },
            "gachi": { title: "Thường hay (Tiêu cực)", formula: "V(bỏ mas) + がち", desc: "Xu hướng xấu thường xảy ra.", ex: "遅れがちだ。" },
            "sou_visual": { title: "Trông có vẻ", formula: "V(bỏ mas)/A + そう", desc: "Đánh giá qua thị giác.", ex: "おいしそうだ。" },
            "sou_hear": { title: "Nghe nói", formula: "Thể thường + そう", desc: "Truyền đạt thông tin.", ex: "雨だそうです。" },
            "noni_purp": { title: "Để (Công dụng)", formula: "Vる + のに", desc: "Mục đích sử dụng.", ex: "切るのに使う。" },
            "noni_con": { title: "Thế mà (Trái ngược)", formula: "Thể thường + のに", desc: "Bất mãn, ngạc nhiên.", ex: "高いのにまずい。" },
            "made": { title: "Cho đến khi", formula: "Vる + まで", desc: "Hành động kéo dài liên tục đến điểm mốc.", ex: "来るまで待つ。" },
            "made_ni": { title: "Trước khi (Hạn chót)", formula: "Vる + までに", desc: "Hoàn thành trước một thời điểm.", ex: "5時までに帰る。" },
            "te_ageru": { title: "Làm cho (người khác)", formula: "Vて + あげる", desc: "Mình làm cho ai đó.", ex: "教えてあげる。" },
            "te_kureru": { title: "Làm cho (mình)", formula: "Vて + くれる", desc: "Ai đó làm cho mình.", ex: "教えてくれた。" },
            "te_morau": { title: "Được làm cho", formula: "Vて + もらう", desc: "Mình nhận hành động từ ai đó.", ex: "教えてもらった。" },
            "koto_ni_suru": { title: "Quyết định (Chủ quan)", formula: "Vる + ことにする", desc: "Tự mình quyết định.", ex: "行くことにした。" },
            "koto_ni_naru": { title: "Được quyết định (Khách quan)", formula: "Vる + ことになる", desc: "Quyết định bởi người khác/tổ chức.", ex: "行くことになった。" },
            "hazu": { title: "Chắc chắn", formula: "Thể thường + はず", desc: "Suy đoán có căn cứ.", ex: "来るはずだ。" },
            "wake": { title: "Thảo nào / Hèn chi", formula: "Thể thường + わけ", desc: "Hiểu ra lý do.", ex: "暑いわけだ。" }
        };

        // --- DATA: Comparisons ---
        const grammarData = {
            "time_action": {
                name: "1. Thời gian & Hành động",
                icon: "clock",
                color: "blue",
                items: [
                    { 
                        id: "comp_01", title: "「間に」 vs 「うちに」", 
                        left: { title: "〜間に (Aida ni)", desc: "Hành động xảy ra tại 1 điểm trong khoảng thời gian.", ex: [{ja:"留守の間に泥棒が入った。", vi:"Trộm vào nhà lúc tôi đi vắng.", gIds:["aida_ni"]}, {ja:"寝ている間に電話が来た。", vi:"Điện thoại đến lúc tôi đang ngủ.", gIds:["aida_ni"]}] },
                        right: { title: "〜うちに (Uchi ni)", desc: "Tranh thủ làm trước khi trạng thái đổi, hoặc thay đổi tự nhiên.", ex: [{ja:"忘れないうちにメモする。", vi:"Ghi lại trước khi quên.", gIds:["uchi_ni"]}, {ja:"温かいうちに食べる。", vi:"Ăn khi còn nóng.", gIds:["uchi_ni"]}] }
                    },
                    { 
                        id: "comp_12", title: "「間」 vs 「間に」", 
                        left: { title: "〜間 (Aida)", desc: "Hành động kéo dài SUỐT khoảng thời gian.", ex: [{ja:"待っている間、本を読んでいた。", vi:"Tôi đọc sách suốt lúc chờ.", gIds:["aida"]}, {ja:"留守の間、犬の世話をした。", vi:"Chăm chó suốt lúc vắng nhà.", gIds:["aida"]}] },
                        right: { title: "〜間に (Aida ni)", desc: "Hành động xảy ra tại 1 điểm thời gian.", ex: [{ja:"留守の間に泥棒が入った。", vi:"Trộm vào lúc vắng nhà.", gIds:["aida_ni"]}] }
                    },
                    {
                        id: "comp_07", title: "「前に」 vs 「うちに」",
                        left: { title: "〜前に (Mae ni)", desc: "Thứ tự thời gian đơn thuần.", ex: [{ja:"寝る前に歯を磨く。", vi:"Đánh răng trước khi ngủ.", gIds:["mae_ni"]}] },
                        right: { title: "〜うちに (Uchi ni)", desc: "Tranh thủ cơ hội/thời điểm.", ex: [{ja:"明るいうちに帰る。", vi:"Về khi trời còn sáng (kẻo tối).", gIds:["uchi_ni"]}] }
                    },
                    {
                        id: "comp_11", title: "「までに」 vs 「まで」",
                        left: { title: "〜までに (Made ni)", desc: "Hạn chót (Deadline). Xong trước lúc đó.", ex: [{ja:"5時までに帰ります。", vi:"Sẽ về trước 5 giờ.", gIds:["made_ni"]}] },
                        right: { title: "〜まで (Made)", desc: "Kéo dài liên tục cho đến lúc đó.", ex: [{ja:"5時まで働きます。", vi:"Làm việc đến 5 giờ.", gIds:["made"]}] }
                    },
                    {
                        id: "comp_03", title: "「ばかり」 vs 「ところ」",
                        left: { title: "〜たばかり", desc: "Cảm giác vừa mới làm (có thể lâu rồi).", ex: [{ja:"先月日本に来たばかりです。", vi:"Tôi mới đến Nhật tháng trước.", gIds:["bakari_feel"]}] },
                        right: { title: "〜たところ", desc: "Vừa mới xong tức thì (thực tế).", ex: [{ja:"今着いたところです。", vi:"Vừa mới tới nơi xong.", gIds:["ta_tokoro"]}] }
                    }
                ]
            },
            "reason_purpose": {
                name: "2. Nguyên nhân & Mục đích",
                icon: "question",
                color: "green",
                items: [
                    {
                        id: "comp_02", title: "「ので」 vs 「から」",
                        left: { title: "〜ので (Node)", desc: "Khách quan, nhẹ nhàng, lịch sự.", ex: [{ja:"雨なので中止です。", vi:"Vì mưa nên hủy (khách quan).", gIds:["node"]}] },
                        right: { title: "〜から (Kara)", desc: "Chủ quan, mạnh mẽ, dùng cho mệnh lệnh.", ex: [{ja:"危ないから入るな。", vi:"Nguy hiểm đấy, đừng vào.", gIds:["kara_reason"]}] }
                    },
                    {
                        id: "comp_05", title: "「ために」 vs 「ように」",
                        left: { title: "〜ために (Tame ni)", desc: "Mục đích có ý chí (cùng chủ ngữ).", ex: [{ja:"家を買うために貯金する。", vi:"Tiết kiệm để mua nhà.", gIds:["tame_ni_purpose"]}] },
                        right: { title: "〜ように (You ni)", desc: "Trạng thái mong muốn (thường là tự động từ/khả năng).", ex: [{ja:"読めるように練習する。", vi:"Luyện tập để có thể đọc được.", gIds:["you_ni_purpose"]}] }
                    },
                    {
                        id: "comp_10", title: "「のに」(để) vs 「のに」(thế mà)",
                        left: { title: "〜のに (Mục đích)", desc: "V-ru + noni: Dùng cho việc...", ex: [{ja:"切るのに使う。", vi:"Dùng để cắt.", gIds:["noni_purp"]}] },
                        right: { title: "〜のに (Trái ngược)", desc: "Thể thường + noni: Vậy mà...", ex: [{ja:"高いのにまずい。", vi:"Đắt thế mà dở.", gIds:["noni_con"]}] }
                    }
                ]
            },
            "condition_guess": {
                name: "3. Giả định & Phỏng đoán",
                icon: "cloud",
                color: "yellow",
                items: [
                    {
                        id: "comp_06", title: "「と・たら・ば」 (Nếu)",
                        left: { title: "〜と (To)", desc: "Hễ A thì B (Tất yếu/Máy móc).", ex: [{ja:"押すと開く。", vi:"Ấn là mở.", gIds:["to_cond"]}] },
                        right: { title: "〜たら (Tara)", desc: "Giả định chung, dùng nhiều nhất.", ex: [{ja:"雨だったら行かない。", vi:"Nếu mưa thì không đi.", gIds:["tara_cond"]}] },
                        third: { title: "〜ば (Ba)", desc: "Điều kiện cần thiết.", ex: [{ja:"安ければ買う。", vi:"Rẻ thì mua.", gIds:["ba_cond"]}] }
                    },
                    {
                        id: "comp_04", title: "「らしい」 vs 「みたい」",
                        left: { title: "〜らしい (Rashii)", desc: "Nghe đồn (tin tức) / Đúng chất.", ex: [{ja:"男らしい。", vi:"Ra dáng đàn ông.", gIds:["rashii"]}] },
                        right: { title: "〜みたい (Mitai)", desc: "Giống như (so sánh) / Phỏng đoán trực quan.", ex: [{ja:"子供みたいだ。", vi:"Như trẻ con ấy.", gIds:["mitai"]}] }
                    },
                    {
                        id: "comp_09", title: "「そうです」(nhìn) vs (nghe)",
                        left: { title: "Vmas/A + そう (Có vẻ)", desc: "Nhìn thấy và đoán.", ex: [{ja:"おいしそうだ。", vi:"Trông ngon thế.", gIds:["sou_visual"]}] },
                        right: { title: "Thể thường + そう (Nghe nói)", desc: "Nghe thông tin từ đâu đó.", ex: [{ja:"おいしいそうだ。", vi:"Nghe nói là ngon.", gIds:["sou_hear"]}] }
                    },
                    {
                        id: "comp_15", title: "「はず」 vs 「わけ」",
                        left: { title: "〜はず (Hazu)", desc: "Chắc chắn là (suy đoán có căn cứ).", ex: [{ja:"来るはずだ。", vi:"Chắc chắn sẽ đến.", gIds:["hazu"]}] },
                        right: { title: "〜わけ (Wake)", desc: "Thảo nào / Hèn chi (hiểu ra lý do).", ex: [{ja:"暑いわけだ。", vi:"Hèn chi nóng thế.", gIds:["wake"]}] }
                    }
                ]
            },
            "others": {
                name: "4. Các cặp khác",
                icon: "list-ul",
                color: "purple",
                items: [
                    {
                        id: "comp_08", title: "「やすい」 vs 「がち」",
                        left: { title: "〜やすい (Yasui)", desc: "Dễ làm (tính chất).", ex: [{ja:"書きやすい。", vi:"Dễ viết.", gIds:["yasui"]}] },
                        right: { title: "〜がち (Gachi)", desc: "Thường hay (xu hướng xấu).", ex: [{ja:"病気がちだ。", vi:"Hay bị ốm.", gIds:["gachi"]}] }
                    },
                    {
                        id: "comp_13", title: "授受表現 (Cho nhận)",
                        left: { title: "あげる・やる", desc: "Mình cho người khác.", ex: [{ja:"花をやる。", vi:"Cho (hoa) tưới nước.", gIds:["te_ageru"]}] },
                        right: { title: "くれる・くださる", desc: "Người khác cho mình.", ex: [{ja:"くれた。", vi:"Đã cho tôi.", gIds:["te_kureru"]}] },
                        third: { title: "もらう・いただく", desc: "Mình nhận từ người khác.", ex: [{ja:"もらった。", vi:"Đã nhận được.", gIds:["te_morau"]}] }
                    },
                    {
                        id: "comp_14", title: "「ことにする」 vs 「ことになる」",
                        left: { title: "〜ことにする", desc: "Tự mình quyết định.", ex: [{ja:"行くことにした。", vi:"Tôi quyết định đi.", gIds:["koto_ni_suru"]}] },
                        right: { title: "〜ことになる", desc: "Được quyết định (bởi hoàn cảnh/người khác).", ex: [{ja:"行くことになった。", vi:"Được quyết định là sẽ đi.", gIds:["koto_ni_naru"]}] }
                    }
                ]
            },
            "antonyms": {
                name: "5. Từ vựng Trái nghĩa",
                icon: "arrows-alt-h",
                color: "orange",
                items: [
                    { id: "ant_01", title: "Tính từ đuôi I", isAntonym: true,
                      left: { title: "大きい・高い・長い", desc: "To, Cao/Đắt, Dài", ex: [{ja:"背が高い。", vi:"Dáng cao."}] },
                      right: { title: "小さい・低い/安い・短い", desc: "Nhỏ, Thấp/Rẻ, Ngắn", ex: [{ja:"背が低い。", vi:"Dáng thấp."}] } 
                    },
                    { id: "ant_02", title: "Tính từ đuôi Na", isAntonym: true,
                      left: { title: "静か・好き・便利", desc: "Yên tĩnh, Thích, Tiện lợi", ex: [{ja:"静かな部屋。", vi:"Phòng yên tĩnh."}] },
                      right: { title: "にぎやか・嫌い・不便", desc: "Náo nhiệt, Ghét, Bất tiện", ex: [{ja:"にぎやかな通り。", vi:"Phố náo nhiệt."}] }
                    },
                    { id: "ant_03", title: "Động từ", isAntonym: true,
                      left: { title: "行く・入る・開ける", desc: "Đi, Vào, Mở", ex: [{ja:"学校へ行く。", vi:"Đi học."}] },
                      right: { title: "来る・出る・閉める", desc: "Đến, Ra, Đóng", ex: [{ja:"ここへ来る。", vi:"Đến đây."}] }
                    }
                ]
            }
        };

        let currentCategory = 'time_action';
        let currentGrammarId = 'comp_01';
        let currentQuizData = null;

        function init() {
            renderCategories();
            selectCategory('time_action');
            setupMobileDrawer();
        }

        function renderCategories() {
            const list = document.getElementById('categoryList');
            const mobileList = document.getElementById('mobileCategoryList');
            let html = '';
            
            Object.keys(grammarData).forEach(key => {
                const cat = grammarData[key];
                html += `
                    <div class="mb-2">
                        <div onclick="selectCategory('${key}')" class="cat-header p-3 rounded-lg cursor-pointer flex items-center justify-between font-bold text-gray-700 hover:bg-gray-100" data-cat="${key}">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-${cat.color}-100 text-${cat.color}-600 flex items-center justify-center"><i class="fas fa-${cat.icon}"></i></div>
                                <span>${cat.name}</span>
                            </div>
                            <i class="fas fa-chevron-down text-xs text-gray-400 transition-transform" id="chevron-${key}"></i>
                        </div>
                        <div id="list-${key}" class="hidden pl-11 pr-2 space-y-1 mt-1">
                            ${cat.items.map((g, idx) => `
                                <div onclick="loadGrammar('${key}', '${g.id}')" class="g-item p-2 rounded text-sm cursor-pointer text-gray-600" id="item-${g.id}">
                                    ${g.title}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            list.innerHTML = html;
            mobileList.innerHTML = html;
        }

        function selectCategory(key) {
            Object.keys(grammarData).forEach(k => {
                document.getElementById(`list-${k}`)?.classList.add('hidden');
                document.getElementById(`chevron-${k}`)?.classList.remove('rotate-180');
                document.querySelectorAll(`.cat-header[data-cat="${k}"]`).forEach(el => el.classList.remove('active'));
            });

            document.querySelectorAll(`[id^="list-${key}"]`).forEach(el => el.classList.remove('hidden'));
            document.querySelectorAll(`[id^="chevron-${key}"]`).forEach(el => el.classList.add('rotate-180'));
            document.querySelectorAll(`.cat-header[data-cat="${key}"]`).forEach(el => el.classList.add('active'));
            
            const firstItem = grammarData[key].items[0];
            loadGrammar(key, firstItem.id);
        }

        function loadGrammar(catKey, gId) {
            currentGrammarId = gId;
            currentCategory = catKey;
            
            document.querySelectorAll('.g-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll(`[id^="item-${gId}"]`).forEach(el => el.classList.add('active'));

            const data = grammarData[catKey].items.find(i => i.id === gId);
            if(!data) return;

            document.getElementById('c-cat-name').innerText = grammarData[catKey].name;
            document.getElementById('c-title').innerText = data.title;
            document.getElementById('c-desc').innerText = data.isAntonym ? "Các cặp từ trái nghĩa thường gặp." : "So sánh cách sử dụng và sắc thái ý nghĩa.";

            // Load comparisons
            updateSide('left', data.left);
            updateSide('right', data.right);
            
            // Handle 3rd comparison item if exists
            const thirdBox = document.getElementById('third-box');
            if (data.third) {
                thirdBox.classList.remove('hidden');
                document.getElementById('third-title').innerText = data.third.title;
                document.getElementById('third-desc').innerText = data.third.desc;
                renderExamples('third-examples', data.third.ex);
                // Adjust grid
                document.getElementById('comp-container').classList.remove('md:grid-cols-2');
                document.getElementById('comp-container').classList.add('md:grid-cols-3');
            } else {
                thirdBox.classList.add('hidden');
                document.getElementById('comp-container').classList.add('md:grid-cols-2');
                document.getElementById('comp-container').classList.remove('md:grid-cols-3');
            }

            toggleMobileDrawer(false);
        }

        function updateSide(side, data) {
            document.getElementById(`${side}-title`).innerText = data.title;
            document.getElementById(`${side}-desc`).innerText = data.desc;
            renderExamples(`${side}-examples`, data.ex);
        }

        function renderExamples(containerId, examples) {
            const container = document.getElementById(containerId);
            container.innerHTML = examples.map(e => {
                const grammarBtn = e.gIds ? `<button onclick="openExplan('${e.gIds.join(',')}')" class="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded border border-indigo-100 hover:bg-indigo-100"><i class="fas fa-info-circle"></i> GT</button>` : '';
                return `
                <div class="border-l-2 border-gray-200 pl-3 py-1 hover:bg-gray-50 transition rounded-r">
                    <div class="flex justify-between items-start mb-1">
                        <p class="font-bold text-gray-800 ja-text text-lg cursor-pointer hover:text-indigo-600" onclick="speakText('${e.ja.replace(/'/g, "\\'")}')">${e.ja}</p>
                        <div class="flex gap-1">
                            <button onclick="speakText('${e.ja.replace(/'/g, "\\'")}')" class="text-gray-400 hover:text-indigo-500"><i class="fas fa-volume-up"></i></button>
                            ${grammarBtn}
                        </div>
                    </div>
                    <p class="text-sm text-gray-500">${e.vi}</p>
                </div>
            `}).join('');
        }

        // --- GRAMMAR MODAL LOGIC ---
        function openExplan(idsStr) {
             const ids = idsStr.split(','); 
             const f = document.getElementById('dgFormula'); 
             const e = document.getElementById('dgExplanation');
             
             // Combined lookup from Day 31 grammar repo for reuse
             // For this standalone file, I will include a subset of grammarRepo logic or use a simplified lookup if needed.
             // Since I defined grammarRepo in Day 31, I will redefine a merged version here for functionality.
             
             f.innerHTML = '';
             e.innerHTML = ids.map(id => {
                 const g = grammarRepo[id];
                 if (!g) return `<div class="text-red-400 text-xs">Mã ngữ pháp: ${id}</div>`;
                 return `
                 <div class="mb-4 last:mb-0">
                     <h4 class="font-bold text-indigo-700 flex items-center gap-2"><i class="fas fa-bookmark text-sm"></i> ${g.title}</h4>
                     <code class="block bg-gray-100 p-2 rounded text-sm font-mono my-2 text-gray-700">${g.formula}</code>
                     <p class="text-sm text-gray-600">${g.desc}</p>
                 </div>`;
             }).join('<hr class="my-4 border-gray-100">');
             
             document.getElementById('detailGrammarModal').classList.remove('hidden');
             setTimeout(() => {
                 document.getElementById('detailGrammarBackdrop').classList.remove('opacity-0');
                 document.getElementById('detailGrammarPanel').classList.remove('opacity-0', 'scale-95');
             }, 10);
        }

        function closeModal(id) {
            const b = document.getElementById('detailGrammarBackdrop');
            const p = document.getElementById('detailGrammarPanel');
            b.classList.add('opacity-0');
            p.classList.add('opacity-0', 'scale-95');
            setTimeout(() => document.getElementById(id).classList.add('hidden'), 200);
        }

        // --- QUIZ LOGIC ---
        function switchMode(mode) {
            document.getElementById('study-view').classList.toggle('hidden', mode !== 'study');
            document.getElementById('practice-view').classList.toggle('hidden', mode !== 'practice');
            
            const btnStudy = document.getElementById('btn-study');
            const btnPractice = document.getElementById('btn-practice');
            
            if(mode === 'study') {
                btnStudy.className = "px-4 py-1.5 rounded-lg text-sm font-bold bg-indigo-50 text-indigo-600 shadow-sm";
                btnPractice.className = "px-4 py-1.5 rounded-lg text-sm font-bold text-gray-500 hover:bg-gray-100";
            } else {
                btnPractice.className = "px-4 py-1.5 rounded-lg text-sm font-bold bg-green-50 text-green-600 shadow-sm";
                btnStudy.className = "px-4 py-1.5 rounded-lg text-sm font-bold text-gray-500 hover:bg-gray-100";
                generateQuiz();
            }
        }
        
        function generateQuiz() {
            // Pick a random category and item
            const catKeys = Object.keys(grammarData);
            const randCat = grammarData[catKeys[Math.floor(Math.random() * catKeys.length)]];
            const randItem = randCat.items[Math.floor(Math.random() * randCat.items.length)];
            
            // Pick a random sentence from left or right
            const sides = [randItem.left, randItem.right];
            if(randItem.third) sides.push(randItem.third);
            const randSide = sides[Math.floor(Math.random() * sides.length)];
            const targetEx = randSide.ex[Math.floor(Math.random() * randSide.ex.length)];
            
            // Segment
            const segments = targetEx.ja.split(/(?=[をにがはの。て、])|(?<=[をにがはの。て、])/g).filter(s => s.trim().length > 0);
            
            currentQuizData = {
                original: targetEx.ja,
                vi: targetEx.vi,
                segments: shuffleArray([...segments])
            };

            document.getElementById('quiz-question-vi').innerText = `"${currentQuizData.vi}"`;
            document.getElementById('quiz-answer-zone').innerHTML = '<span class="text-gray-400 italic text-sm pointer-events-none">Kéo từ vào đây</span>';
            
            const optionsZone = document.getElementById('quiz-options-zone');
            optionsZone.innerHTML = '';
            currentQuizData.segments.forEach((seg) => {
                const btn = document.createElement('button');
                btn.className = "bg-white border-2 border-indigo-100 text-indigo-700 font-bold py-2 px-4 rounded-lg shadow-sm hover:bg-indigo-50 active:scale-95 transition ja-text text-lg";
                btn.innerText = seg;
                btn.onclick = () => addToAnswer(seg, btn);
                optionsZone.appendChild(btn);
            });

            document.getElementById('quiz-feedback').classList.add('hidden');
            document.getElementById('btn-submit-quiz').disabled = false;
        }

        function addToAnswer(text, btnElement) {
            const zone = document.getElementById('quiz-answer-zone');
            if (zone.children.length === 1 && zone.children[0].tagName === 'SPAN') zone.innerHTML = '';
            
            const chip = document.createElement('div');
            chip.className = "bg-indigo-600 text-white px-3 py-1 rounded-lg font-bold shadow-md cursor-pointer hover:bg-red-500 transition ja-text flex items-center gap-2 animate-slide-in";
            chip.innerHTML = `${text}`;
            chip.onclick = () => {
                chip.remove();
                btnElement.classList.remove('opacity-0', 'pointer-events-none');
                if(zone.children.length === 0) zone.innerHTML = '<span class="text-gray-400 italic text-sm pointer-events-none">Kéo từ vào đây</span>';
            };
            
            zone.appendChild(chip);
            btnElement.classList.add('opacity-0', 'pointer-events-none');
        }
        
        function resetQuizQuestion() { generateQuiz(); }

        function checkQuizAnswer() {
            const zone = document.getElementById('quiz-answer-zone');
            const userAnswer = Array.from(zone.children).map(c => c.innerText).join('');
            const isCorrect = userAnswer === currentQuizData.original.replace(/\s/g, '');
            
            const fb = document.getElementById('quiz-feedback');
            const icon = document.getElementById('fb-icon');
            const text = document.getElementById('fb-text');
            const sub = document.getElementById('fb-subtext');
            
            fb.classList.remove('hidden', 'flex');
            fb.classList.add('flex');
            
            if (isCorrect) {
                icon.innerHTML = '<i class="fas fa-check-circle text-green-500"></i>';
                text.innerText = "Chính xác!";
                text.className = "text-2xl font-bold mb-2 text-green-600";
                sub.innerText = currentQuizData.original;
                speakText(currentQuizData.original);
            } else {
                icon.innerHTML = '<i class="fas fa-times-circle text-red-500"></i>';
                text.innerText = "Tiếc quá!";
                text.className = "text-2xl font-bold mb-2 text-red-600";
                sub.innerText = `Đáp án đúng: ${currentQuizData.original}`;
            }
        }
        
        function nextQuizQuestion() { generateQuiz(); }

        // --- UTILS ---
        function toggleMobileDrawer(forceState) {
            const drawer = document.getElementById('mobileDrawer');
            const backdrop = document.getElementById('drawerBackdrop');
            const isOpen = forceState !== undefined ? forceState : !drawer.classList.contains('closed');
            if (!isOpen) { drawer.classList.remove('open'); drawer.classList.add('closed'); backdrop.classList.add('hidden'); }
            else { drawer.classList.remove('closed'); drawer.classList.add('open'); backdrop.classList.remove('hidden'); }
        }
        function setupMobileDrawer() { toggleMobileDrawer(false); }
        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }
        function speakText(text) { if ('speechSynthesis' in window) { const u = new SpeechSynthesisUtterance(text); u.lang = 'ja-JP'; u.rate = 0.9; speechSynthesis.speak(u); } }

        document.getElementById('searchInput').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            document.querySelectorAll('.g-item').forEach(item => {
                if(item.innerText.toLowerCase().includes(term)) { item.classList.remove('hidden'); item.parentElement.classList.remove('hidden'); }
                else { item.classList.add('hidden'); }
            });
        });

        init();
    </script>
</body>
</html>
