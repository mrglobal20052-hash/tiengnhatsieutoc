<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Học Tiếng Nhật Siêu Tốc - Ngày 13</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .jp-font {
            font-family: 'Noto Sans JP', sans-serif;
        }
        ruby rt {
            font-size: 0.7em;
            font-weight: 500;
            user-select: none;
        }
        .hide-furigana ruby rt {
            visibility: hidden;
        }
        .transition-height {
            transition: max-height 0.5s ease-in-out;
        }
        .correct-char { color: #16a34a; }
        .incorrect-char { color: #dc2626; text-decoration: underline; }
        
        /* --- NEW STYLES FOR UPGRADES --- */
        /* Progress Bar */
        .progress-bar-container {
            background-color: #e5e7eb; /* gray-200 */
            border-radius: 9999px;
            overflow: hidden;
        }
        .progress-bar {
            background-color: #22c55e; /* green-500 */
            transition: width 0.5s ease-in-out;
        }
        /* Fade transition for conversation */
        .content-fade {
            transition: opacity 0.3s ease-in-out;
        }
        .fading-out {
            opacity: 0;
        }
        /* Quiz feedback icons */
        .feedback-icon {
            display: inline-block;
            margin-right: 0.5rem;
            font-weight: bold;
        }
        .feedback-correct { color: #16a34a; }
        .feedback-incorrect { color: #dc2626; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-sky-700 jp-font" id="main-title"></h1>
            <p class="text-gray-500 mt-2">Bài học về cách diễn đạt dự định, lời khuyên và phỏng đoán.</p>
        </header>

        <!-- Progress Bar Section -->
        <div class="mb-8">
            <h3 class="font-bold text-center mb-2">Tiến độ bài học</h3>
            <div class="progress-bar-container w-full h-4">
                <div id="lesson-progress-bar" class="progress-bar h-full text-xs text-white text-center" style="width: 0%;"></div>
            </div>
        </div>

        <main class="space-y-8">
            <!-- Settings Panel -->
            <div class="bg-white p-4 rounded-xl shadow-md border border-gray-200">
                <h3 class="font-bold text-lg mb-3 text-gray-700">Bảng điều khiển</h3>
                <div class="flex flex-wrap gap-4">
                    <button id="toggle-furigana" class="toggle-btn">Bật Furigana</button>
                    <button id="toggle-romaji" class="toggle-btn">Hiện Romaji</button>
                    <button id="toggle-vietnamese" class="toggle-btn">Hiện Tiếng Việt</button>
                </div>
            </div>

            <!-- Conversation Section -->
            <section id="conversation-section" class="lesson-section"></section>

            <!-- Reading Section -->
            <section id="reading-section" class="lesson-section"></section>

            <!-- Grammar Section -->
            <section id="grammar-section" class="lesson-section"></section>
            
            <!-- Quiz Section -->
            <section id="quiz-section" class="lesson-section"></section>
        </main>

        <footer class="text-center mt-12 text-gray-400 text-sm">
            <p>Copyright by AzaCan, 2025</p>
        </footer>
    </div>

    <script>
        // --- DATA FOR DAY 13 ---
        const day13Data = {
            title: "Ngày 13: Dự định và Lời khuyên",
            conversation: {
                id: 'conversation',
                title: "今日の会話 (Hội thoại trong ngày)",
                context: "Bối cảnh: Tanaka và Suzuki nói về kế hoạch cuối tuần.",
                modes: {
                    polite: {
                        name: "Thể lịch sự (丁寧形)",
                        dialogue: [
                            { speaker: "Tanaka", jp: "鈴木[すずき]さん、今週末[こんしゅうまつ]は何[なに]か予定[よてい]がありますか。", romaji: "Suzuki-san, konshuumatsu wa nani ka yotei ga arimasu ka.", vi: "Anh Suzuki, cuối tuần này anh có dự định gì không?" },
                            { speaker: "Suzuki", jp: "仲間[なかま]と旅行[りょこう]に行[い]く予定[よてい]です。でも、天気[てんき]が悪[わる]いかもしれません。", romaji: "Nakama to ryokou ni iku yotei desu. Demo, tenki ga warui kamoshiremasen.", vi: "Tôi có kế hoạch đi du lịch với bạn bè. Nhưng, có lẽ thời tiết sẽ xấu." },
                            { speaker: "Tanaka", jp: "そうですか。それなら、傘[かさ]を持[も]っていったほうがいいですよ。田中[たなか]さんは明日[あした]休[やす]むと言[い]っていましたよ。", romaji: "Sou desu ka. Sorenara, kasa o motte itta hou ga ii desu yo. Tanaka-san wa ashita yasumu to itte imashita yo.", vi: "Vậy à. Nếu vậy thì anh nên mang theo ô đấy. Chị Tanaka nhắn là ngày mai chị ấy nghỉ đó." },
                            { speaker: "Suzuki", jp: "本当[ほんとう]ですか。じゃ、旅行[りょこう]の計画[けいかく]を変[か]えるかもしれません。先生[せんせい]が言[い]った通[とお]りに、よく考[かんが]えたほうがいいですね。", romaji: "Hontou desu ka. Ja, ryokou no keikaku o kaeru kamoshiremasen. Sensei ga itta toori ni, yoku kangaeta hou ga ii desu ne.", vi: "Thật vậy sao? Vậy thì, có lẽ tôi sẽ thay đổi kế hoạch du lịch. Đúng như lời giáo viên đã nói, nên suy nghĩ kỹ thì hơn nhỉ." },
                            { speaker: "Tanaka", jp: "ええ。この仕事[しごと]は30分[さんじゅっぷん]で終[お]わるでしょうから、その後[あと]で話[はな]しましょうか。", romaji: "Ee. Kono shigoto wa sanjuppun de owaru deshou kara, sono ato de hanashimashou ka.", vi: "Vâng. Công việc này chắc sẽ xong trong 30 phút, nên chúng ta nói chuyện sau đó nhé?" },
                            { speaker: "Suzuki", jp: "はい、そうしましょう。", romaji: "Hai, sou shimashou.", vi: "Vâng, cứ làm vậy đi." }
                        ]
                    },
                    casual: {
                        name: "Thể thông thường (普通形)",
                        dialogue: [
                            { speaker: "Tanaka", jp: "鈴木[すずき]くん、今週末[こんしゅうまつ]、何か予定[よてい]ある？", romaji: "Suzuki-kun, konshuumatsu, nani ka yotei aru?", vi: "Suzuki, cuối tuần này có dự định gì không?" },
                            { speaker: "Suzuki", jp: "仲間[なかま]と旅行[りょこう]に行[い]く予定[よてい]なんだ。でも、天気[てんき]、悪[わる]いかもしれないね。", romaji: "Nakama to ryokou ni iku yotei nanda. Demo, tenki, warui kamoshirenai ne.", vi: "Tớ định đi du lịch với bạn bè. Nhưng mà, thời tiết có thể sẽ xấu." },
                            { speaker: "Tanaka", jp: "そっか。じゃ、傘[かさ]持[も]ってったほうがいいよ。田中[たなか]さん、明日[あした]休[やす]むって言[い]ってたよ。", romaji: "Sokka. Ja, kasa mottetta hou ga ii yo. Tanaka-san, ashita yasumu tte itteta yo.", vi: "Vậy à. Thế thì nên mang ô đi đấy. Chị Tanaka bảo là mai chị ấy nghỉ đó." },
                            { speaker: "Suzuki", jp: "マジで？じゃ、旅行[りょこう]の計画[けいかく]、変[か]えるかも。先生[せんせい]が言[い]った通[とお]り、よく考[かんが]えたほうがいいね。", romaji: "Maji de? Ja, ryokou no keikaku, kaeru kamo. Sensei ga itta toori, yoku kangaeta hou ga ii ne.", vi: "Thật á? Vậy, kế hoạch du lịch chắc phải thay đổi quá. Đúng như lời thầy nói, nên nghĩ kỹ thì hơn." },
                            { speaker: "Tanaka", jp: "うん。この仕事[しごと]、30分[さんじゅっぷん]で終[お]わるだろうから、そのあと話[はな]そうか。", romaji: "Un. Kono shigoto, sanjuppun de owaru darou kara, sono ato hanasou ka.", vi: "Ừ. Việc này chắc 30 phút là xong thôi, nói chuyện sau đó nhé." },
                            { speaker: "Suzuki", jp: "オッケー。", romaji: "Okkee.", vi: "OK." }
                        ]
                    }
                }
            },
            reading: {
                id: 'reading',
                title: "今日の読み物 (Bài đọc ngắn)",
                content: {
                    jp: "来月[らいげつ]、私[わたし]は新[あたら]しい会社[かいしゃ]で働[はたら]く予定[よてい]です。そこは国際的[こくさいてき]な企業[きぎょう]で、技術[ぎじゅつ]が進[すす]んでいるでしょう。でも、仕事[しごと]は大変[たいへん]かもしれません。だから、毎日[まいにち]一生懸命[いっしょうけんめい]勉強[べんきょう]したほうがいいと思[おも]います。部長[ぶちょう]は「君[きみ]ならできる」と言[い]っていました。その言葉[ことば]の通[とお]りに、頑張[がんば]りたいです。この仕事[しごと]は半年[はんとし]で慣[な]れるでしょう。",
                    romaji: "Raigetsu, watashi wa atarashii kaisha de hataraku yotei desu. Soko wa kokusaiteki na kigyou de, gijutsu ga susunde iru deshou. Demo, shigoto wa taihen kamoshiremasen. Dakara, mainichi isshoukenmei benkyou shita hou ga ii to omoimasu. Buchou wa 'kimi nara dekiru' to itte imashita. Sono kotoba no toori ni, ganbaritai desu. Kono shigoto wa hantoshi de nareru deshou.",
                    vi: "Tháng tới, tôi dự định sẽ làm việc ở một công ty mới. Đó có lẽ là một công ty quốc tế với kỹ thuật tiên tiến. Nhưng, công việc có thể sẽ rất vất vả. Vì vậy, tôi nghĩ rằng nên chăm chỉ học tập mỗi ngày. Trưởng phòng đã nói rằng 'Nếu là cậu thì có thể làm được'. Tôi muốn cố gắng đúng như lời nói đó. Chắc là tôi sẽ quen với công việc này trong vòng nửa năm."
                }
            },
            grammar: {
                id: 'grammar',
                title: "今日の文法 (Tổng hợp ngữ pháp)",
                points: [
                    { rule: "～予定です", meaning: "Dự định, kế hoạch", formula: "Vる / Nの + 予定です", example: "来週[らいしゅう]、京都[きょうと]へ行[い]く予定[よてい]です。", example_vi: "Tôi dự định đi Kyoto vào tuần sau." },
                    { rule: "～ほうがいいです", meaning: "Nên làm / không nên làm...", formula: "Vた / Vない + ほうがいいです", example: "もっと野菜[やさい]を食[た]べたほうがいいですよ。", example_vi: "Bạn nên ăn nhiều rau hơn đấy." },
                    { rule: "～でしょう", meaning: "Có lẽ, chắc là... (khả năng cao)", formula: "Thể thông thường + でしょう", example: "明日[あした]は雨[あめ]が降[ふ]るでしょう。", example_vi: "Chắc là ngày mai trời sẽ mưa." },
                    { rule: "～かもしれません", meaning: "Có lẽ, có thể... (khả năng thấp hơn)", formula: "Thể thông thường + かもしれません", example: "約束[やくそく]の時間[じかん]に間[ま]に合[あ]わないかもしれません。", example_vi: "Có lẽ tôi sẽ không kịp giờ hẹn." },
                    { rule: "Lượng từ + で", meaning: "Trong vòng (thời gian)", formula: "Lượng từ (thời gian) + で", example: "この宿題[しゅくだい]は１時間[いちじかん]で終[お]わります。", example_vi: "Bài tập này sẽ xong trong vòng 1 tiếng." },
                    { rule: "～と言っていました", meaning: " (Ai đó) đã nhắn là...", formula: "Câu (thể thông thường) + と言っていました", example: "田中[たなか]さんはパーティーに来[こ]ないと言[い]っていました。", example_vi: "Anh Tanaka đã nhắn là anh ấy không đến bữa tiệc." },
                    { rule: "～通りに", meaning: "Theo đúng như...", formula: "Vる/Vた/Nの + 通りに", example: "私[わたし]が言[い]った通[とお]りにしてください。", example_vi: "Hãy làm theo đúng như những gì tôi đã nói." }
                ]
            },
            quiz: {
                id: 'quiz',
                title: "練習とテスト (Luyện tập & Kiểm tra)",
                questions: [
                    { type: "mcq", question: "来月[らいげつ]、旅行[りょこう]に行[い]く（___）です。", options: ["でしょう", "予定", "かもしれません"], answer: "予定" },
                    { type: "fill", question: "疲[つか]れているなら、早[はや]く寝[ね]た（___）いいですよ。", answer: "ほうが" },
                    { type: "mcq", question: "彼[かれ]は来[こ]ない（___）。", options: ["でしょう", "ほうがいい", "かもしれません"], answer: "かもしれません" },
                    { type: "audio", jp: "先生が言った通りにしてください。", question: "Nghe và gõ lại câu bạn vừa nghe:" }
                ]
            }
        };

        // --- STATE MANAGEMENT & SETTINGS ---
        let settings = {
            hideFurigana: false,
            showRomaji: false,
            showVietnamese: false
        };

        let progress = {
            conversation: false,
            reading: false,
            grammar: false,
            quiz: false
        };

        function saveSettings() {
            localStorage.setItem('jpAppSettings_day13', JSON.stringify(settings));
        }

        function loadSettings() {
            const saved = localStorage.getItem('jpAppSettings_day13');
            if (saved) {
                settings = JSON.parse(saved);
            }
        }

        function applySettings() {
            // Buttons
            updateToggleButtonUI('toggle-furigana', !settings.hideFurigana, 'Ẩn Furigana', 'Hiện Furigana');
            updateToggleButtonUI('toggle-romaji', settings.showRomaji, 'Ẩn Romaji', 'Hiện Romaji');
            updateToggleButtonUI('toggle-vietnamese', settings.showVietnamese, 'Ẩn Tiếng Việt', 'Hiện Tiếng Việt');
            
            // Content
            document.getElementById('app').classList.toggle('hide-furigana', settings.hideFurigana);
            document.querySelectorAll('.romaji-text').forEach(el => el.classList.toggle('hidden', !settings.showRomaji));
            document.querySelectorAll('.vi-text').forEach(el => el.classList.toggle('hidden', !settings.showVietnamese));
        }

        function updateToggleButtonUI(buttonId, isActive, activeText, inactiveText) {
            const button = document.getElementById(buttonId);
            button.textContent = isActive ? activeText : inactiveText;
            button.classList.toggle('bg-sky-500', isActive);
            button.classList.toggle('text-white', isActive);
            button.classList.toggle('bg-gray-200', !isActive);
            button.classList.toggle('text-gray-700', !isActive);
        }

        // --- PROGRESS ---
        function updateProgress(sectionId) {
            if (progress.hasOwnProperty(sectionId) && !progress[sectionId]) {
                progress[sectionId] = true;
                updateProgressBar();
            }
        }

        function updateProgressBar() {
            const completed = Object.values(progress).filter(Boolean).length;
            const total = Object.keys(progress).length;
            const percentage = (completed / total) * 100;
            const bar = document.getElementById('lesson-progress-bar');
            bar.style.width = `${percentage}%`;
            bar.textContent = `${Math.round(percentage)}%`;
        }


        // --- UTILITY FUNCTIONS ---
        function parseFurigana(text) {
            return text.replace(/([^\[\]]+)\[(.+?)\]/g, '<ruby>$1<rt>$2</rt></ruby>');
        }

        function speak(text) {
            speechSynthesis.cancel(); // Stop any previous speech
            const cleanText = text.replace(/\[.*?\]/g, '');
            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = 'ja-JP';
            utterance.rate = 0.9;
            speechSynthesis.speak(utterance);
        }

        // --- RENDER FUNCTIONS ---
        function renderConversation() {
            const section = document.getElementById('conversation-section');
            const data = day13Data.conversation;
            section.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h2 class="text-2xl font-bold mb-1 jp-font">${data.title}</h2>
                    <p class="text-gray-500 mb-4">${data.context}</p>
                    <div class="flex items-center justify-center space-x-2 mb-6 p-1 bg-gray-100 rounded-full">
                        <button id="convo-mode-polite" class="convo-mode-btn flex-1 py-2 px-4 rounded-full bg-sky-600 text-white shadow">Thể lịch sự</button>
                        <button id="convo-mode-casual" class="convo-mode-btn flex-1 py-2 px-4 rounded-full">Thể thông thường</button>
                    </div>
                    <div id="conversation-content" class="space-y-4 content-fade"></div>
                </div>
            `;
            renderDialogue('polite');
            updateProgress(data.id);
        }
        
        function renderDialogue(mode) {
            const container = document.getElementById('conversation-content');
            const dialogue = day13Data.conversation.modes[mode].dialogue;

            container.innerHTML = dialogue.map((line) => `
                <div class="dialogue-line p-4 rounded-lg bg-gray-50 border">
                    <div class="flex items-start space-x-3">
                        <div class="w-10 h-10 rounded-full ${line.speaker === 'Tanaka' ? 'bg-sky-100' : 'bg-emerald-100'} flex items-center justify-center font-bold text-sky-800">${line.speaker.charAt(0)}</div>
                        <div class="flex-1">
                            <p class="font-bold text-gray-800">${line.speaker}</p>
                            <p class="jp-font text-lg mt-1 leading-relaxed">${parseFurigana(line.jp)}</p>
                            <p class="romaji-text text-sm text-gray-500 mt-1">${line.romaji}</p>
                            <p class="vi-text text-sm text-emerald-700 mt-1">${line.vi}</p>
                            <div class="mt-3 flex items-center space-x-3">
                                <button class="speak-btn" data-text="${line.jp}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                                </button>
                                <div class="w-full">
                                    <input type="text" class="typing-input w-full p-2 border rounded-md bg-white text-base" data-correct="${line.jp.replace(/\[.*?\]/g, '')}" placeholder="Luyện gõ ở đây...">
                                    <div class="typing-feedback text-xs mt-1 h-4"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            attachEventListenersToRenderedContent(container);
            applySettings();
        }

        function renderReading() {
            const section = document.getElementById('reading-section');
            const data = day13Data.reading;
            section.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h2 class="text-2xl font-bold mb-2 jp-font">${data.title}</h2>
                    <div class="reading-content p-4 rounded-lg bg-gray-50 border">
                        <p class="jp-font text-lg leading-relaxed">${parseFurigana(data.content.jp)}</p>
                        <p class="romaji-text text-sm text-gray-500 mt-2">${data.content.romaji}</p>
                        <p class="vi-text text-sm text-emerald-700 mt-2">${data.content.vi}</p>
                        <div class="mt-4 flex items-center space-x-3">
                             <button class="speak-btn" data-text="${data.content.jp}">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                             </button>
                             <div class="w-full">
                                 <input type="text" class="typing-input w-full p-2 border rounded-md bg-white text-base" data-correct="${data.content.jp.replace(/\[.*?\]/g, '')}" placeholder="Luyện gõ ở đây...">
                                 <div class="typing-feedback text-xs mt-1 h-4"></div>
                             </div>
                        </div>
                    </div>
                </div>
            `;
            attachEventListenersToRenderedContent(section);
            updateProgress(data.id);
        }

        function renderGrammar() {
            const section = document.getElementById('grammar-section');
            const data = day13Data.grammar;
            section.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h2 class="text-2xl font-bold mb-4 jp-font">${data.title}</h2>
                    <div class="space-y-3">
                        ${data.points.map((point) => `
                            <div class="grammar-point border border-gray-200 rounded-lg overflow-hidden">
                                <button class="grammar-toggle w-full flex justify-between items-center p-4 bg-gray-50 hover:bg-gray-100">
                                    <span class="font-bold text-sky-800 jp-font text-lg">${point.rule}</span>
                                    <svg class="w-5 h-5 transform transition-transform" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </button>
                                <div class="grammar-details max-h-0 overflow-hidden transition-height">
                                    <div class="p-4 border-t border-gray-200">
                                        <p><strong>Ý nghĩa:</strong> ${point.meaning}</p>
                                        <p><strong>Công thức:</strong> <code class="bg-gray-200 text-red-600 px-1 rounded">${point.formula}</code></p>
                                        <div class="mt-2 p-3 bg-sky-50 rounded-md">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <p class="jp-font">${parseFurigana(point.example)}</p>
                                                    <p class="vi-text text-sm text-emerald-700 mt-1">${point.example_vi}</p>
                                                </div>
                                                <button class="speak-btn" data-text="${point.example}">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            attachEventListenersToRenderedContent(section);
            updateProgress(data.id);
        }

        function renderQuiz() {
            const section = document.getElementById('quiz-section');
            const data = day13Data.quiz;
            section.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h2 class="text-2xl font-bold mb-4 jp-font">${data.title}</h2>
                    <div id="quiz-content" class="space-y-6">
                        ${data.questions.map((q, index) => {
                            if (q.type === 'mcq') {
                                return `
                                    <div class="quiz-question" data-answer="${q.answer}">
                                        <p class="mb-2 jp-font">${index + 1}. ${parseFurigana(q.question)}</p>
                                        <div class="flex flex-col space-y-2">
                                            ${q.options.map(opt => `<button class="mcq-option text-left p-3 border rounded-lg hover:bg-gray-100">${opt}</button>`).join('')}
                                        </div>
                                        <div class="feedback mt-2 text-sm h-5"></div>
                                    </div>
                                `;
                            }
                            if (q.type === 'fill') {
                                return `
                                    <div class="quiz-question" data-answer="${q.answer}">
                                        <p class="mb-2 jp-font">${index + 1}. ${parseFurigana(q.question)}</p>
                                        <input type="text" class="fill-input w-full p-2 border rounded-md">
                                        <div class="feedback mt-2 text-sm h-5"></div>
                                    </div>
                                `;
                            }
                            if (q.type === 'audio') {
                                return `
                                    <div class="quiz-question" data-answer="${q.jp.replace(/\[.*?\]/g, '')}">
                                        <p class="mb-2 jp-font">${index + 1}. ${q.question}</p>
                                        <button class="speak-btn mb-2 flex items-center" data-text="${q.jp}">
                                           <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-sky-600"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                                           <span class="ml-2">Nghe</span>
                                        </button>
                                        <input type="text" class="fill-input w-full p-2 border rounded-md">
                                        <div class="feedback mt-2 text-sm h-5"></div>
                                    </div>
                                `;
                            }
                        }).join('')}
                    </div>
                    <button id="check-quiz-btn" class="mt-6 w-full bg-emerald-600 text-white font-bold py-3 rounded-lg hover:bg-emerald-700 transition-colors">Kiểm tra đáp án</button>
                    <div id="quiz-result" class="mt-4 text-center font-bold"></div>
                </div>
            `;
            attachEventListenersToRenderedContent(section);
        }

        // --- EVENT LISTENERS ---
        function attachEventListenersToRenderedContent(container) {
            container.querySelectorAll('.speak-btn').forEach(btn => {
                btn.onclick = () => speak(btn.dataset.text);
            });

            container.querySelectorAll('.typing-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const correctText = e.target.dataset.correct;
                    const userText = e.target.value;
                    const feedbackContainer = e.target.nextElementSibling;
                    let styledText = '';
                    for (let i = 0; i < userText.length; i++) {
                        styledText += `<span class="${userText[i] === correctText[i] ? 'correct-char' : 'incorrect-char'}">${userText[i]}</span>`;
                    }
                    feedbackContainer.innerHTML = styledText;
                    if (userText === correctText) {
                        feedbackContainer.innerHTML = '<span class="text-green-600 font-bold">Chính xác! 🎉</span>';
                    }
                });
            });
            
            container.querySelectorAll('.grammar-toggle').forEach(button => {
                button.addEventListener('click', () => {
                    const details = button.nextElementSibling;
                    const icon = button.querySelector('svg');
                    if (details.style.maxHeight && details.style.maxHeight !== '0px') {
                        details.style.maxHeight = '0px';
                        icon.style.transform = 'rotate(0deg)';
                    } else {
                        details.style.maxHeight = details.scrollHeight + 'px';
                        icon.style.transform = 'rotate(180deg)';
                    }
                });
            });
        }

        function setupGlobalEventListeners() {
            document.getElementById('toggle-furigana').addEventListener('click', () => {
                settings.hideFurigana = !settings.hideFurigana;
                saveSettings();
                applySettings();
            });
            document.getElementById('toggle-romaji').addEventListener('click', () => {
                settings.showRomaji = !settings.showRomaji;
                saveSettings();
                applySettings();
            });
            document.getElementById('toggle-vietnamese').addEventListener('click', () => {
                settings.showVietnamese = !settings.showVietnamese;
                saveSettings();
                applySettings();
            });

            document.getElementById('convo-mode-polite').addEventListener('click', (e) => {
                const container = document.getElementById('conversation-content');
                container.classList.add('fading-out');
                setTimeout(() => {
                    renderDialogue('polite');
                    container.classList.remove('fading-out');
                    e.target.classList.add('bg-sky-600', 'text-white', 'shadow');
                    document.getElementById('convo-mode-casual').classList.remove('bg-sky-600', 'text-white', 'shadow');
                }, 300);
            });
            document.getElementById('convo-mode-casual').addEventListener('click', (e) => {
                const container = document.getElementById('conversation-content');
                container.classList.add('fading-out');
                setTimeout(() => {
                    renderDialogue('casual');
                    container.classList.remove('fading-out');
                    e.target.classList.add('bg-sky-600', 'text-white', 'shadow');
                    document.getElementById('convo-mode-polite').classList.remove('bg-sky-600', 'text-white', 'shadow');
                }, 300);
            });
            
            document.getElementById('check-quiz-btn').addEventListener('click', () => {
                const questions = document.querySelectorAll('.quiz-question');
                let score = 0;
                questions.forEach(q => {
                    const answer = q.dataset.answer;
                    const feedback = q.querySelector('.feedback');
                    let isCorrect = false;

                    const selectedOption = q.querySelector('.mcq-option.bg-sky-200');
                    if (selectedOption) {
                        isCorrect = selectedOption.textContent === answer;
                        selectedOption.classList.add(isCorrect ? 'border-green-500' : 'border-red-500');
                    }
                    
                    const input = q.querySelector('.fill-input');
                    if (input) {
                        isCorrect = input.value.trim() === answer;
                        input.classList.add(isCorrect ? 'border-green-500' : 'border-red-500');
                    }

                    if (isCorrect) {
                        score++;
                        feedback.innerHTML = `<span class="feedback-icon feedback-correct">✔️</span><span class="text-green-600 font-bold">Đúng!</span>`;
                    } else {
                        feedback.innerHTML = `<span class="feedback-icon feedback-incorrect">❌</span><span class="text-red-600 font-bold">Sai! Đáp án đúng là: ${answer}</span>`;
                    }
                });
                
                document.getElementById('quiz-result').innerHTML = `Bạn đã trả lời đúng ${score}/${questions.length} câu!`;
                updateProgress(day13Data.quiz.id);
            });
            
            document.querySelectorAll('.mcq-option').forEach(opt => {
                opt.addEventListener('click', () => {
                    opt.parentElement.querySelectorAll('.mcq-option').forEach(sibling => {
                        sibling.classList.remove('bg-sky-200', 'border-sky-500');
                    });
                    opt.classList.add('bg-sky-200', 'border-sky-500');
                });
            });
        }
        
        // --- INITIALIZATION ---
        function init() {
            document.getElementById('main-title').textContent = day13Data.title;
            loadSettings();
            renderConversation();
            renderReading();
            renderGrammar();
            renderQuiz();
            setupGlobalEventListeners();
            applySettings();
            updateProgressBar();
        }

        window.onload = init;
    </script>
</body>
</html>
