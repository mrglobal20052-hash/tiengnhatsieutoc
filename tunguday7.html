<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AzaKanji Tango - Ngày 7: Cho phép & Điều kiện</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    
    <style>
        /* Base Configuration */
        :root {
            --primary: #4f46e5;
            --secondary: #db2777;
        }

        body { 
            font-family: 'Nunito', 'Inter', sans-serif; 
            background-color: #f3f4f6; 
            height: 100vh; height: 100dvh; 
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .ja-text, .kanji-font { font-family: 'Noto Sans JP', sans-serif; }
        
        /* Custom Scrollbar */
        .scroller { -webkit-overflow-scrolling: touch; }
        .scroller::-webkit-scrollbar { width: 6px; }
        .scroller::-webkit-scrollbar-track { background: transparent; }
        .scroller::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .scroller::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }

        /* Animations */
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .correct-anim { animation: bounce 0.5s; }
        @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        
        .wrong-anim { animation: shake 0.5s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* UI Components */
        .vocab-item { transition: all 0.2s ease; }
        .vocab-item.active { 
            background-color: #eef2ff; 
            border-left: 4px solid var(--primary);
            color: #4338ca;
            padding-left: 12px;
        }
        
        .shadow-card {
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.2s;
        }
        .shadow-card:active { transform: scale(0.98); }

        .glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid rgba(255, 255, 255, 0.5);
        }

        /* Tabs */
        .tab-btn { color: #a5b4fc; }
        .tab-btn.active {
            background-color: white;
            color: #312e81;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .tab-btn:hover:not(.active) { color: white; background-color: rgba(255,255,255,0.1); }

        /* Kanji Drawing Grid */
        .stroke-grid-box {
            border: 1px solid #e5e7eb;
            background-color: white;
            position: relative;
        }
        .stroke-grid-box::after {
            content: ''; position: absolute; top: 0; left: 50%; width: 1px; height: 100%;
            background: repeating-linear-gradient(to bottom, #ddd 0, #ddd 4px, transparent 4px, transparent 8px); z-index: 0;
        }
        .stroke-grid-box::before {
            content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 1px;
            background: repeating-linear-gradient(to right, #ddd 0, #ddd 4px, transparent 4px, transparent 8px); z-index: 0;
        }
    </style>
</head>
<body class="flex flex-col text-slate-800">

    <!-- HEADER -->
    <header class="bg-indigo-700 text-white shadow-lg flex-none z-40 relative">
        <div class="container mx-auto px-4 py-2 md:py-3">
            <div class="flex flex-col md:flex-row justify-between items-center gap-3">
                <div class="flex items-center space-x-3 cursor-pointer select-none w-full md:w-auto justify-between md:justify-start">
                    <div class="flex items-center gap-3" onclick="location.reload()">
                        <div class="bg-white/10 p-2 rounded-lg">
                            <i class="fas fa-torii-gate text-2xl text-white"></i>
                        </div>
                        <div>
                            <h1 class="text-lg md:text-xl font-bold uppercase tracking-wider leading-none">AzaKanji Tango</h1>
                            <p class="text-[10px] md:text-xs text-indigo-200 mt-0.5">Ngày 7: Cho phép & Điều kiện</p>
                        </div>
                    </div>
                    <div class="md:hidden text-xs font-semibold bg-indigo-800/80 px-3 py-1 rounded-full border border-indigo-500/50 backdrop-blur-sm">
                        <span id="headerProgress">1/89</span>
                    </div>
                </div>

                <div class="flex items-center gap-3 w-full md:w-auto">
                    <div class="flex bg-indigo-900/50 rounded-lg p-1 w-full md:w-auto overflow-x-auto no-scrollbar gap-1">
                        <button onclick="switchTab('learn')" id="tab-learn" class="tab-btn active flex-1 md:flex-none px-4 py-1.5 rounded-md text-sm font-bold transition whitespace-nowrap flex items-center justify-center gap-2">
                            <i class="fas fa-book-open"></i> Học Từ
                        </button>
                        <button onclick="switchTab('quiz')" id="tab-quiz" class="tab-btn flex-1 md:flex-none px-4 py-1.5 rounded-md text-sm font-bold transition whitespace-nowrap flex items-center justify-center gap-2">
                            <i class="fas fa-keyboard"></i> Kiểm Tra
                        </button>
                        <div class="w-px bg-indigo-600/50 mx-1"></div>
                        <button onclick="openGrammarList()" class="tab-btn flex-1 md:flex-none px-4 py-1.5 rounded-md text-sm font-bold transition whitespace-nowrap flex items-center justify-center gap-2">
                            <i class="fas fa-scroll"></i> Ngữ Pháp
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- MAIN CONTAINER -->
    <div class="flex flex-1 overflow-hidden relative w-full">
        
        <!-- SECTION 1: LEARN (SHADOWING UI) -->
        <div id="learn-section" class="flex flex-1 w-full overflow-hidden absolute inset-0 fade-in">
            <!-- Sidebar (Desktop) -->
            <aside class="hidden md:flex w-72 bg-white border-r border-gray-200 flex-col z-10">
                <div class="p-4 border-b border-gray-100 bg-gray-50">
                    <div class="relative group">
                        <span class="material-symbols-rounded absolute left-3 top-2.5 text-gray-400 text-xl">search</span>
                        <input type="text" id="searchInput" placeholder="Tìm kiếm từ..." class="w-full pl-10 pr-4 py-2 bg-white border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all shadow-sm">
                    </div>
                </div>
                <div id="vocabList" class="flex-1 overflow-y-auto scroller p-2 space-y-1"></div>
            </aside>

            <!-- Main Content -->
            <main id="mainContent" class="flex-1 overflow-y-auto scroller bg-slate-50 p-4 pb-28 md:pb-8 w-full scroll-smooth">
                <div class="max-w-3xl mx-auto flex flex-col items-center">
                    
                    <!-- Flashcard -->
                    <div class="w-full bg-white rounded-2xl p-6 shadow-sm border border-gray-200 mb-6 relative overflow-hidden group hover:shadow-md transition-shadow">
                        <!-- Decorative BG -->
                        <div class="absolute top-0 right-0 w-40 h-40 bg-gradient-to-br from-indigo-50 to-pink-50 rounded-bl-full -mr-10 -mt-10 z-0 opacity-70"></div>
                        
                        <div class="relative z-10 text-center">
                            <div class="inline-flex items-center gap-2 bg-gray-50 px-3 py-1 rounded-full mb-6 border border-gray-100 shadow-sm">
                                <span id="wordType" class="text-[10px] font-bold uppercase tracking-wider text-indigo-500">WORD</span>
                                <div class="w-px h-3 bg-gray-300"></div>
                                <span class="text-[10px] text-gray-400 font-mono" id="wordIndex">#1</span>
                            </div>
                            
                            <div class="relative inline-block group mb-2">
                                <h2 id="cardKanji" class="text-5xl md:text-7xl font-bold text-gray-800 ja-text tracking-tight cursor-pointer hover:text-indigo-700 transition-colors select-none" onclick="speakCurrent()">見せます</h2>
                                <button id="strokeBtn" onclick="openStrokeModal()" class="absolute -right-12 top-0 w-9 h-9 bg-pink-50 text-pink-600 rounded-full flex items-center justify-center shadow-sm hover:bg-pink-100 hover:scale-110 transition-all hidden" title="Tập viết Kanji">
                                    <i class="fas fa-pen-nib text-sm"></i>
                                </button>
                            </div>

                            <div class="flex flex-col items-center gap-1 cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition-colors" onclick="speakCurrent()">
                                <span id="cardFurigana" class="text-xl text-indigo-600 font-medium ja-text">みせます</span>
                                <span id="cardMeaning" class="text-lg text-gray-500 font-medium">Cho xem</span>
                            </div>
                        </div>
                    </div>

                    <!-- Context Examples -->
                    <div class="w-full">
                        <div class="flex items-center gap-2 mb-4 px-1">
                            <div class="bg-gradient-to-br from-pink-100 to-red-50 text-pink-600 p-1.5 rounded-lg shadow-sm">
                                <i class="fas fa-comments"></i>
                            </div>
                            <h3 class="font-bold text-gray-700 text-lg">Mẫu Câu Ứng Dụng</h3>
                        </div>
                        <div id="sentenceList" class="space-y-4"></div>
                        
                        <!-- Empty State -->
                        <div id="emptyState" class="hidden flex-col items-center justify-center p-12 text-center bg-white rounded-2xl border border-dashed border-gray-300">
                            <div class="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mb-3 text-gray-300">
                                <i class="fas fa-comment-slash text-2xl"></i>
                            </div>
                            <p class="text-sm text-gray-500 font-medium">Từ này đặc biệt, chưa có mẫu câu tự động.</p>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Mobile Navigation Bar -->
            <div class="fixed bottom-0 left-0 right-0 glass px-4 py-3 pb-6 md:pb-4 z-30 flex items-center justify-between gap-4 md:hidden shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                <button onclick="prevWord()" class="w-12 h-12 rounded-xl bg-white border border-gray-200 text-gray-600 flex items-center justify-center shadow-sm active:bg-gray-50 active:scale-95 transition-all"><i class="fas fa-chevron-left"></i></button>
                <button onclick="toggleDrawer()" class="flex-1 h-12 rounded-xl bg-indigo-600 text-white font-bold flex items-center justify-center shadow-lg shadow-indigo-200 active:bg-indigo-700 active:scale-95 transition-all gap-2"><i class="fas fa-list-ul"></i> Danh Sách</button>
                <button onclick="nextWord()" class="w-12 h-12 rounded-xl bg-white border border-gray-200 text-gray-600 flex items-center justify-center shadow-sm active:bg-gray-50 active:scale-95 transition-all"><i class="fas fa-chevron-right"></i></button>
            </div>

            <!-- Desktop Floating Nav -->
            <div class="hidden md:flex fixed bottom-8 right-8 gap-3 z-30">
                 <button onclick="prevWord()" class="w-14 h-14 rounded-full bg-white border border-gray-200 text-gray-600 flex items-center justify-center shadow-lg hover:bg-gray-50 transition-transform hover:-translate-y-1"><i class="fas fa-chevron-left text-lg"></i></button>
                 <button onclick="nextWord()" class="w-14 h-14 rounded-full bg-indigo-600 text-white flex items-center justify-center shadow-xl shadow-indigo-200 hover:bg-indigo-700 transition-transform hover:-translate-y-1"><i class="fas fa-chevron-right text-lg"></i></button>
            </div>
        </div>

        <!-- SECTION 2: QUIZ UI -->
        <div id="quiz-section" class="hidden flex-1 w-full overflow-y-auto scroller bg-slate-100 p-4 absolute inset-0 fade-in z-20">
            <div class="max-w-xl mx-auto mt-4 md:mt-12">
                <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-200 relative">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-6 text-white flex justify-between items-center relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-40 h-40 bg-white opacity-10 rounded-full -mr-12 -mt-12 pointer-events-none"></div>
                        <div class="relative z-10">
                            <h2 class="text-2xl font-bold flex items-center gap-2"><i class="fas fa-graduation-cap"></i> Thử Thách</h2>
                            <p class="text-indigo-100 text-sm mt-1">Nhìn Kanji - Đoán Hiragana</p>
                        </div>
                        <div class="text-right relative z-10">
                            <div class="text-[10px] text-indigo-200 uppercase font-bold tracking-widest">ĐIỂM SỐ</div>
                            <div class="text-4xl font-bold font-mono leading-none" id="score-display">0</div>
                        </div>
                    </div>
                    
                    <!-- Content -->
                    <div class="p-6 md:p-10 text-center">
                        <div class="mb-8">
                            <div class="text-xs text-gray-400 mb-2 uppercase tracking-wide font-bold">Từ này đọc là gì?</div>
                            <div id="quiz-kanji" class="text-6xl md:text-7xl kanji-font font-bold text-gray-800 mb-4 transition-all py-4"></div>
                            <div id="quiz-meaning" class="text-lg text-indigo-600 font-bold mb-2"></div>
                        </div>

                        <div class="relative max-w-sm mx-auto mb-8">
                            <input type="text" id="quiz-input" class="w-full text-center text-2xl p-4 border-2 border-gray-300 rounded-xl focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 focus:outline-none transition-all kanji-font placeholder-gray-300" placeholder="nhập hiragana..." autocomplete="off">
                        </div>

                        <div id="feedback-area" class="hidden rounded-xl p-5 bg-gray-50 border border-gray-200 text-left mb-6 fade-in">
                            <div id="feedback-title" class="font-bold text-lg mb-2 flex items-center"></div>
                            <div class="text-gray-700 mb-3 flex items-center flex-wrap gap-2">
                                Đáp án đúng: <span id="correct-answer" class="font-bold text-xl text-indigo-600 px-3 py-1 bg-white rounded border border-indigo-100 ja-text shadow-sm"></span>
                                <button onclick="playQuizAudio()" class="w-8 h-8 rounded-full flex items-center justify-center hover:bg-gray-200 text-gray-500 transition-colors"><i class="fas fa-volume-up"></i></button>
                            </div>
                        </div>

                        <div>
                            <button id="btn-check" onclick="checkAnswer()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-indigo-200 transform transition active:scale-95 text-lg flex items-center justify-center gap-2"><i class="fas fa-check"></i> Kiểm Tra</button>
                            <button id="btn-next" onclick="nextQuestion()" class="hidden w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-4 rounded-xl shadow-lg transform transition active:scale-95 text-lg flex items-center justify-center gap-2">Câu Tiếp Theo <i class="fas fa-arrow-right"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- GRAMMAR LIST MODAL -->
    <div id="grammarListModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity opacity-0" id="grammarListBackdrop" onclick="closeModal('grammarListModal')"></div>
        <div class="bg-white rounded-2xl w-full max-w-4xl relative z-10 shadow-2xl transform transition-all scale-95 opacity-0 flex flex-col max-h-[85vh]" id="grammarListPanel">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-indigo-50 rounded-t-2xl">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-600 text-white p-2 rounded-lg shadow-md shadow-indigo-200"><i class="fas fa-book"></i></div>
                    <div><h3 class="text-xl font-bold text-gray-800">Cẩm Nang Ngữ Pháp</h3><p class="text-xs text-gray-500">Các mẫu câu trọng điểm (Bài 7)</p></div>
                </div>
                <button onclick="closeModal('grammarListModal')" class="w-8 h-8 rounded-full hover:bg-white flex items-center justify-center text-gray-500 transition-colors"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto scroller bg-slate-50">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="grammarGrid"></div>
            </div>
            <div class="p-4 border-t border-gray-100 bg-white rounded-b-2xl flex justify-end">
                <button onclick="closeModal('grammarListModal')" class="px-6 py-2 bg-gray-800 hover:bg-gray-900 text-white font-bold rounded-full text-sm transition-transform active:scale-95 shadow-lg">Đóng</button>
            </div>
        </div>
    </div>

    <!-- GRAMMAR DETAIL MODAL -->
    <div id="detailModal" class="fixed inset-0 z-[70] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity opacity-0" id="detailBackdrop" onclick="closeModal('detailModal')"></div>
        <div class="bg-white rounded-2xl w-full max-w-md relative z-10 shadow-2xl transform transition-all scale-95 opacity-0 flex flex-col" id="detailPanel">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 rounded-t-2xl">
                <div class="flex items-center gap-2">
                    <div class="bg-indigo-100 p-1.5 rounded-lg text-indigo-600"><i id="modalIcon" class="fas fa-info-circle"></i></div>
                    <h3 class="text-lg font-bold text-gray-800" id="modalTitle">Chi tiết</h3>
                </div>
                <button onclick="closeModal('detailModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6">
                <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-4 text-center mb-5">
                    <code class="text-lg font-bold text-indigo-700 font-mono" id="modalFormula"></code>
                </div>
                <p class="text-gray-600 text-sm mb-5 leading-relaxed" id="modalExplanation"></p>
                <div class="bg-white rounded-xl p-4 border border-gray-200 shadow-sm">
                    <div class="text-[10px] font-bold text-gray-400 uppercase mb-3 tracking-wider">Ví dụ minh họa</div>
                    <div class="flex justify-between items-start gap-3">
                        <div>
                            <p class="ja-text font-medium text-gray-800 mb-1 text-lg" id="modalExampleJa"></p>
                            <p class="text-xs text-gray-500 italic" id="modalExampleVi"></p>
                        </div>
                        <button id="modalPlayBtn" class="text-indigo-500 hover:text-indigo-700 bg-indigo-50 w-8 h-8 rounded-full flex items-center justify-center"><i class="fas fa-volume-up"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- STROKE ORDER MODAL -->
    <div id="strokeModal" class="fixed inset-0 z-[80] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-gray-900/80 backdrop-blur-sm transition-opacity opacity-0" id="strokeBackdrop" onclick="closeModal('strokeModal')"></div>
        <div class="bg-white rounded-2xl w-full max-w-5xl relative z-10 shadow-2xl transform transition-all scale-95 opacity-0 flex flex-col max-h-[90vh]" id="strokePanel">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-pink-50 rounded-t-2xl">
                <h3 class="text-lg font-bold text-pink-700 flex items-center gap-2">
                    <i class="fas fa-pen-nib"></i> Tập Viết & Chi Tiết Kanji
                </h3>
                <button onclick="closeModal('strokeModal')" class="w-8 h-8 rounded-full hover:bg-white flex items-center justify-center text-gray-500 transition-colors"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto scroller bg-slate-50 flex-1">
                <div id="strokeTabs" class="flex justify-center gap-2 mb-6 flex-wrap"></div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Left: Writing -->
                    <div class="flex flex-col gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 text-center relative">
                            <p class="text-xs text-gray-400 mb-4 font-bold uppercase tracking-wider">Mô phỏng nét viết</p>
                            <div id="strokeAnimContainer" class="w-48 h-48 mx-auto bg-white border border-gray-300 relative stroke-grid-box flex items-center justify-center rounded-lg shadow-inner">
                                <span class="text-xs text-gray-400 animate-pulse">Đang tải dữ liệu...</span>
                            </div>
                            <button onclick="replayStrokeAnimation()" class="absolute top-4 right-4 bg-pink-50 text-pink-600 w-10 h-10 rounded-full flex items-center justify-center hover:bg-pink-100 transition shadow-sm hover:rotate-180 duration-500" title="Viết lại"><i class="fas fa-redo text-sm"></i></button>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <p class="text-xs text-gray-400 mb-4 font-bold uppercase tracking-wider">Thứ tự từng nét</p>
                            <div id="strokeGridContainer" class="flex flex-wrap gap-2 justify-center lg:justify-start"></div>
                        </div>
                    </div>
                    <!-- Right: Info -->
                    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200 flex flex-col h-full">
                        <div id="kanjiDetailContent">
                            <div class="flex items-center justify-between mb-6 border-b border-gray-100 pb-4">
                                <div>
                                    <h2 id="detailKanji" class="text-6xl font-bold text-gray-800 ja-text mb-2"></h2>
                                    <div class="text-xs font-bold bg-indigo-100 text-indigo-700 px-2 py-1 rounded inline-block tracking-wider" id="detailHanViet"></div>
                                </div>
                                <div class="text-right"><div class="text-2xl font-bold text-gray-600 capitalize" id="detailMeaning"></div></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <div class="bg-slate-50 p-3 rounded-lg border border-slate-100"><span class="text-[10px] font-bold text-gray-400 uppercase block mb-1">On (Âm Nhật)</span><span class="text-lg font-bold text-indigo-600 ja-text" id="detailOn"></span></div>
                                <div class="bg-slate-50 p-3 rounded-lg border border-slate-100"><span class="text-[10px] font-bold text-gray-400 uppercase block mb-1">Kun (Âm Hán)</span><span class="text-lg font-bold text-pink-600 ja-text" id="detailKun"></span></div>
                            </div>
                            <div class="space-y-4 mb-6">
                                <div class="bg-green-50 p-4 rounded-lg border border-green-100 relative overflow-hidden">
                                    <div class="absolute right-0 top-0 opacity-10 text-green-600 text-4xl p-2"><i class="fas fa-image"></i></div>
                                    <h4 class="text-xs font-bold text-green-800 mb-1 uppercase">Mẹo nhớ hình ảnh</h4>
                                    <p class="text-sm text-green-900 leading-relaxed font-medium" id="detailTipImg"></p>
                                </div>
                                <div class="bg-orange-50 p-4 rounded-lg border border-orange-100 relative overflow-hidden">
                                    <div class="absolute right-0 top-0 opacity-10 text-orange-600 text-4xl p-2"><i class="fas fa-music"></i></div>
                                    <h4 class="text-xs font-bold text-orange-800 mb-1 uppercase">Mẹo nhớ âm thanh</h4>
                                    <p class="text-sm text-orange-900 leading-relaxed font-medium" id="detailTipSound"></p>
                                </div>
                            </div>
                            <div>
                                <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Từ vựng liên quan</h4>
                                <div class="space-y-2 max-h-40 overflow-y-auto scroller pr-1" id="detailWords"></div>
                            </div>
                        </div>
                        <div id="kanjiDetailEmpty" class="hidden h-full flex flex-col items-center justify-center text-center p-4">
                            <i class="fas fa-book-open text-gray-200 text-6xl mb-4"></i>
                            <p class="text-gray-400 font-medium">Đang cập nhật thông tin chi tiết.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. DATA: KANJI & VOCAB & GRAMMAR ---
        
        // KANJI DATABASE (Specific for Day 7)
        const kanjiDetails = {
            "準": { hanviet: "CHUẨN", mean: "Chuẩn bị", on: "ジュン", kun: "", tipImg: "Nước (**氵**) chim (**隹**) mười (**十**) lần là chuẩn.", tipSound: "**Jun**bi chuẩn bị.", words: [{w:"準備 (じゅんび)", m:"Chuẩn bị"}, {w:"水準 (すいじゅん)", m:"Tiêu chuẩn"}] },
            "備": { hanviet: "BỊ", mean: "Trang bị", on: "ビ", kun: "そな.える", tipImg: "Người (**亻**) dùng cỏ (**艹**) trên sườn núi (**厂**) để trang bị.", tipSound: "Jun**bi** trang bị.", words: [{w:"準備 (じゅんび)", m:"Chuẩn bị"}, {w:"設備 (せつび)", m:"Thiết bị"}] },
            "決": { hanviet: "QUYẾT", mean: "Quyết định", on: "ケツ", kun: "き.める", tipImg: "Nước (**氵**) chảy xiết quyết định (**夬**).", tipSound: "**Ki**meru quyết định.", words: [{w:"決めます (きめます)", m:"Quyết định"}, {w:"解決 (かいけつ)", m:"Giải quyết"}] },
            "納": { hanviet: "NẠP", mean: "Thu nạp", on: "ノウ", kun: "おさ.める", tipImg: "Sợi chỉ (**糸**) trong nhà (**内**) được thu nạp.", tipSound: "**Nat**tou đậu nạp.", words: [{w:"納豆 (なっとう)", m:"Đậu nạp"}, {w:"納税 (のうぜい)", m:"Nộp thuế"}] },
            "豆": { hanviet: "ĐẬU", mean: "Hạt đậu", on: "トウ", kun: "まめ", tipImg: "Hạt đậu trong bát.", tipSound: "Nat**tou** đậu.", words: [{w:"納豆 (なっとう)", m:"Đậu nạp"}, {w:"豆 (まめ)", m:"Đậu"}] },
            "着": { hanviet: "TRƯỚC", mean: "Mặc/Đến", on: "チャク", kun: "き.る", tipImg: "Con dê (**⺶**) nhìn (**目**) đích đến.", tipSound: "**Ki**mono áo.", words: [{w:"着物 (きもの)", m:"Kimono"}, {w:"着ます (きます)", m:"Mặc"}] },
            "物": { hanviet: "VẬT", mean: "Đồ vật", on: "ブツ", kun: "もの", tipImg: "Con bò (**牛**) chê không (**勿**) phải vật.", tipSound: "Ki**mono** đồ.", words: [{w:"着物 (きもの)", m:"Kimono"}, {w:"食べ物 (たべもの)", m:"Đồ ăn"}] },
            "浴": { hanviet: "DỤC", mean: "Tắm", on: "ヨク", kun: "あ.びる", tipImg: "Nước (**氵**) chảy trong thung lũng (**谷**) để tắm.", tipSound: "**Yu**kata áo tắm.", words: [{w:"浴衣 (ゆかた)", m:"Yukata"}, {w:"浴びます (あびます)", m:"Tắm"}] },
            "衣": { hanviet: "Y", mean: "Y phục", on: "イ", kun: "ころも", tipImg: "Cổ áo và vạt áo.", tipSound: "Yu**kata** y phục.", words: [{w:"浴衣 (ゆかた)", m:"Yukata"}, {w:"衣類 (いるい)", m:"Y phục"}] },
            "化": { hanviet: "HÓA", mean: "Biến hóa", on: "カ", kun: "ば.ける", tipImg: "Người (**亻**) biến thành cái thìa (**匕**).", tipSound: "O**ba**ke ma.", words: [{w:"お化け (おばけ)", m:"Ma quỷ"}, {w:"文化 (ぶんか)", m:"Văn hóa"}] },
            "旅": { hanviet: "LỮ", mean: "Lữ hành", on: "リョ", kun: "たび", tipImg: "Phương (**方**) xa có người nằm (**亻**) dưới áo (**衣**) lữ hành.", tipSound: "**Ryo**kan lữ quán.", words: [{w:"旅館 (りょかん)", m:"Lữ quán"}, {w:"旅行 (りょこう)", m:"Du lịch"}] },
            "館": { hanviet: "QUÁN", mean: "Tòa nhà", on: "カン", kun: "やかた", tipImg: "Nơi ăn (**食**) của quan (**官**) lại.", tipSound: "Ryo**kan** quán.", words: [{w:"旅館 (りょかん)", m:"Lữ quán"}, {w:"図書館 (としょかん)", m:"Thư viện"}] },
            "相": { hanviet: "TƯƠNG", mean: "Tương hỗ", on: "ソウ", kun: "あい", tipImg: "Cây (**木**) che mắt (**目**) tương trợ.", tipSound: "**Su**mou tương phác.", words: [{w:"相撲 (すもう)", m:"Sumo"}, {w:"首相 (しゅしょう)", m:"Thủ tướng"}] },
            "撲": { hanviet: "PHÁC", mean: "Đánh", on: "ボク", kun: "", tipImg: "Tay (**扌**) đánh người nghiệp (**業**) chướng.", tipSound: "Su**mou** đấu vật.", words: [{w:"相撲 (すもう)", m:"Sumo"}] },
            "歌": { hanviet: "CA", mean: "Hát", on: "カ", kun: "うた", tipImg: "Hai người ca (**哥**) hát thiếu (**欠**) hơi.", tipSound: "**Ka**buki ca vũ.", words: [{w:"歌舞伎 (かぶき)", m:"Kịch Kabuki"}, {w:"歌手 (かしゅ)", m:"Ca sĩ"}] },
            "舞": { hanviet: "VŨ", mean: "Múa", on: "ブ", kun: "ま.う", tipImg: "Người múa chiều (**夕**) trên thuyền (**舛**).", tipSound: "Ka**bu**ki vũ.", words: [{w:"歌舞伎 (かぶき)", m:"Kịch Kabuki"}, {w:"お見舞い (おみまい)", m:"Thăm bệnh"}] },
            "伎": { hanviet: "KỸ", mean: "Kỹ nghệ", on: "キ", kun: "", tipImg: "Người (**亻**) có chi (**支**)êu thức kỹ nghệ.", tipSound: "Kabu**ki** kỹ.", words: [{w:"歌舞伎 (かぶき)", m:"Kịch Kabuki"}] },
            "泊": { hanviet: "BẠC", mean: "Trọ lại", on: "ハク", kun: "と.まる", tipImg: "Nước (**氵**) trắng (**白**) ở bến bạc.", tipSound: "**To**maru trọ.", words: [{w:"泊まります (とまります)", m:"Trọ lại"}, {w:"宿泊 (しゅくはく)", m:"Trọ"}] },
            "乗": { hanviet: "THỪA", mean: "Lên xe", on: "ジョウ", kun: "の.る", tipImg: "Cây lúa (**禾**) trên xe.", tipSound: "**No**ru lên.", words: [{w:"乗ります (のります)", m:"Lên xe"}, {w:"乗車 (じょうしゃ)", m:"Lên tàu"}] },
            "登": { hanviet: "ĐĂNG", mean: "Leo", on: "トウ", kun: "のぼ.る", tipImg: "Hai chân đạp lên hạt đậu (**豆**) leo lên.", tipSound: "**No**boru leo.", words: [{w:"登ります (のぼります)", m:"Leo núi"}, {w:"登山 (とざん)", m:"Leo núi"}] },
            "釣": { hanviet: "ĐIẾU", mean: "Câu cá", on: "チョウ", kun: "つ.る", tipImg: "Kim loại (**金**) làm cái muôi (**勺**) câu cá.", tipSound: "**Tsu**ru câu.", words: [{w:"釣ります (つります)", m:"Câu cá"}] },
            "会": { hanviet: "HỘI", mean: "Gặp", on: "カイ", kun: "あ.う", tipImg: "Hai người gặp nhau dưới mái nhà.", tipSound: "**A**u gặp.", words: [{w:"会ります (あいます)", m:"Gặp"}, {w:"会話 (かいわ)", m:"Hội thoại"}] },
            "度": { hanviet: "ĐỘ", mean: "Lần/Độ", on: "ド", kun: "たび", tipImg: "Trong nhà (**广**) hai mươi (**廿**) tay (**又**) đo độ.", tipSound: "**Do** độ.", words: [{w:"一度 (いちど)", m:"Một lần"}, {w:"温度 (おんど)", m:"Nhiệt độ"}] },
            "赤": { hanviet: "XÍCH", mean: "Đỏ", on: "セキ", kun: "あか", tipImg: "Đất (**土**) lửa (**火**) màu đỏ.", tipSound: "**Aka**chan em bé.", words: [{w:"赤ちゃん (あかちゃん)", m:"Em bé"}, {w:"赤い (あかい)", m:"Đỏ"}] },
            "服": { hanviet: "PHỤC", mean: "Quần áo", on: "フク", kun: "", tipImg: "Trăng (**月**) phục (**𠬝**) vụ quần áo.", tipSound: "**Fuku** phục.", words: [{w:"服 (ふく)", m:"Quần áo"}, {w:"洋服 (ようふく)", m:"Âu phục"}] },
            "瓶": { hanviet: "BÌNH", mean: "Bình/Lọ", on: "ビン", kun: "かめ", tipImg: "Ngói (**瓦**) ghép lại (**并**) thành bình.", tipSound: "Ka**bin** bình hoa.", words: [{w:"花瓶 (かびん)", m:"Bình hoa"}, {w:"瓶 (びん)", m:"Chai/Lọ"}] },
            "拭": { hanviet: "THỨC", mean: "Lau", on: "ショク", kun: "ふ.く", tipImg: "Tay (**扌**) thức (**式**) tỉnh để lau.", tipSound: "**Fu**ku lau.", words: [{w:"拭きます (ふきます)", m:"Lau"}, {w:"払拭 (ふっしょく)", m:"Lau sạch/Gạt bỏ"}] },
            "干": { hanviet: "CAN", mean: "Phơi/Khô", on: "カン", kun: "ほ.す", tipImg: "Hình cái giá phơi.", tipSound: "**Ho**su phơi.", words: [{w:"干します (ほします)", m:"Phơi"}, {w:"干物 (ひもの)", m:"Đồ khô"}] },
            "泳": { hanviet: "VỊNH", mean: "Bơi", on: "エイ", kun: "およ.ぐ", tipImg: "Nước (**氵**) chảy vĩnh (**永**) cửu.", tipSound: "**Oyo**gu bơi.", words: [{w:"泳ぎます (およぎます)", m:"Bơi"}, {w:"水泳 (すいえい)", m:"Bơi lội"}] },
            "洗": { hanviet: "TẨY", mean: "Rửa", on: "セン", kun: "あら.う", tipImg: "Nước (**氵**) tẩy sạch trước (**先**).", tipSound: "**Sen**taku giặt.", words: [{w:"洗濯 (せんたく)", m:"Giặt giũ"}, {w:"洗います (あらいます)", m:"Rửa"}] },
            "濯": { hanviet: "TRẠC", mean: "Giặt", on: "タク", kun: "", tipImg: "Nước (**氵**) giặt lông chim (**翟**).", tipSound: "Sen**taku** giặt.", words: [{w:"洗濯 (せんたく)", m:"Giặt giũ"}] },
            "連": { hanviet: "LIÊN", mean: "Liên tục/Dẫn", on: "レン", kun: "つ.れる", tipImg: "Xe (**車**) đi (**⻌**) liên tục.", tipSound: "**Ren**kyuu liên hưu.", words: [{w:"連休 (れんきゅう)", m:"Kỳ nghỉ dài"}, {w:"連れていきます (つれていきます)", m:"Dẫn đi"}] },
            "休": { hanviet: "HƯU", mean: "Nghỉ", on: "キュウ", kun: "やす.む", tipImg: "Người (**亻**) dựa cây (**木**) nghỉ.", tipSound: "Ren**kyuu** nghỉ.", words: [{w:"連休 (れんきゅう)", m:"Kỳ nghỉ dài"}, {w:"休みます (やすみます)", m:"Nghỉ"}] },
            "音": { hanviet: "ÂM", mean: "Âm thanh", on: "オン", kun: "おと", tipImg: "Đứng (**立**) nói ngày (**日**) tạo âm thanh.", tipSound: "**On**gaku âm nhạc.", words: [{w:"音楽 (おんがく)", m:"Âm nhạc"}, {w:"音 (おと)", m:"Âm thanh"}] },
            "楽": { hanviet: "LẠC/NHẠC", mean: "Vui/Nhạc", on: "ガク, ラク", kun: "たの.しい", tipImg: "Trắng (**白**) gỗ (**木**) vui vẻ.", tipSound: "On**gaku** nhạc.", words: [{w:"音楽 (おんがく)", m:"Âm nhạc"}, {w:"楽しい (たのしい)", m:"Vui vẻ"}] },
            "外": { hanviet: "NGOẠI", mean: "Ngoài", on: "ガイ", kun: "そと", tipImg: "Tối (**夕**) bói (**卜**) ngoài đường.", tipSound: "**Gai**kokugo ngoại ngữ.", words: [{w:"外国語 (がいこくご)", m:"Ngoại ngữ"}, {w:"外 (そと)", m:"Bên ngoài"}] },
            "国": { hanviet: "QUỐC", mean: "Nước", on: "コク", kun: "くに", tipImg: "Vùng đất (**口**) có vua (**玉**).", tipSound: "Gai**koku**go nước.", words: [{w:"外国語 (がいこくご)", m:"Ngoại ngữ"}, {w:"国 (くに)", m:"Đất nước"}] },
            "語": { hanviet: "NGỮ", mean: "Ngôn ngữ", on: "ゴ", kun: "かた.る", tipImg: "Lời nói (**言**) của tôi (**吾**).", tipSound: "Gaikoku**go** ngữ.", words: [{w:"外国語 (がいこくご)", m:"Ngoại ngữ"}, {w:"日本語 (にほんご)", m:"Tiếng Nhật"}] },
            "答": { hanviet: "ĐÁP", mean: "Trả lời", on: "トウ", kun: "こた.え", tipImg: "Trúc (**竹**) hợp (**合**) lại trả lời.", tipSound: "**Kota**e câu trả lời.", words: [{w:"答え (こたえ)", m:"Câu trả lời"}, {w:"答えます (こたえます)", m:"Trả lời"}] },
            "財": { hanviet: "TÀI", mean: "Tiền tài", on: "ザイ", kun: "", tipImg: "Tiền (**貝**) là tài (**才**) sản.", tipSound: "**Sai**fu ví.", words: [{w:"財布 (さいふ)", m:"Ví"}] },
            "布": { hanviet: "BỐ", mean: "Vải", on: "フ", kun: "ぬの", tipImg: "Tay (**ナ**) cầm khăn (**巾**) vải.", tipSound: "Sai**fu** ví.", words: [{w:"財布 (さいふ)", m:"Ví"}, {w:"布 (ぬの)", m:"Vải"}] },
            "壁": { hanviet: "BÍCH", mean: "Tường", on: "ヘキ", kun: "かべ", tipImg: "Tích (**辟**) đất (**土**) làm tường.", tipSound: "**Kabe** tường.", words: [{w:"壁 (かべ)", m:"Tường"}] },
            "遠": { hanviet: "VIỄN", mean: "Xa", on: "エン", kun: "とお.い", tipImg: "Đi (**⻌**) bộ mặc áo dài (**袁**) đi xa.", tipSound: "**En**ryo ngại.", words: [{w:"遠慮 (えんりょ)", m:"Ngại ngần"}, {w:"遠い (とおい)", m:"Xa"}] },
            "慮": { hanviet: "LỰ", mean: "Lưỡng lự", on: "リョ", kun: "", tipImg: "Hổ (**虍**) nghĩ (**思**) lưỡng lự.", tipSound: "En**ryo** ngại.", words: [{w:"遠慮 (えんりょ)", m:"Ngại ngần"}, {w:"考慮 (こうりょ)", m:"Cân nhắc"}] },
            "無": { hanviet: "VÔ", mean: "Không", on: "ム", kun: "な.い", tipImg: "Không có lửa (**灬**).", tipSound: "**Na**kushimasu mất.", words: [{w:"無くします (なくします)", m:"Làm mất"}, {w:"無理 (むり)", m:"Vô lý/Quá sức"}] },
            "心": { hanviet: "TÂM", mean: "Tim", on: "シン", kun: "こころ", tipImg: "Hình trái tim.", tipSound: "**Shin**pai lo lắng.", words: [{w:"心配 (しんぱい)", m:"Lo lắng"}, {w:"心 (こころ)", m:"Trái tim"}] },
            "配": { hanviet: "PHỐI", mean: "Phân phối", on: "ハイ", kun: "くば.る", tipImg: "Rượu (**酉**) của bản thân (**己**) đem phân phối.", tipSound: "Shin**pai** lo.", words: [{w:"心配 (しんぱい)", m:"Lo lắng"}, {w:"配達 (はいたつ)", m:"Chuyển phát"}] },
            "触": { hanviet: "XÚC", mean: "Chạm", on: "ショク", kun: "さわ.る", tipImg: "Góc (**角**) sâu (**虫**) chạm vào.", tipSound: "**Sawa**ru chạm.", words: [{w:"触ります (さわります)", m:"Chạm/Sờ"}, {w:"感触 (かんしょく)", m:"Cảm giác"}] },
            "動": { hanviet: "ĐỘNG", mean: "Chuyển động", on: "ドウ", kun: "うご.く", tipImg: "Dùng sức (**力**) chuyển trọng (**重**) lượng.", tipSound: "**Ugo**ku động.", words: [{w:"動きます (うごきます)", m:"Cử động"}, {w:"運動 (うんどう)", m:"Vận động"}] },
            "夜": { hanviet: "DẠ", mean: "Đêm", on: "ヤ", kun: "よる", tipImg: "Người đứng dưới mái nhà buổi đêm.", tipSound: "**Yoru** đêm.", words: [{w:"夜 (よる)", m:"Buổi tối"}, {w:"夜中 (よなか)", m:"Nửa đêm"}] },
            "遅": { hanviet: "TRÌ", mean: "Muộn", on: "チ", kun: "おそ.い", tipImg: "Con cừu (**羊**) đi (**⻌**) muộn.", tipSound: "**Oso**ku muộn.", words: [{w:"遅く (おそく)", m:"Muộn"}, {w:"遅い (おそい)", m:"Chậm/Trễ"}] },
            "理": { hanviet: "LÝ", mean: "Lý do", on: "リ", kun: "", tipImg: "Vua (**王**) ở làng (**里**) có lý.", tipSound: "Mu**ri** vô lý.", words: [{w:"無理 (むり)", m:"Quá sức"}, {w:"理由 (りゆう)", m:"Lý do"}] },
            "規": { hanviet: "QUY", mean: "Quy tắc", on: "キ", kun: "", tipImg: "Chồng (**夫**) nhìn (**見**) quy tắc.", tipSound: "**Ki**soku quy tắc.", words: [{w:"規則 (きそく)", m:"Quy tắc"}, {w:"定規 (じょうぎ)", m:"Thước kẻ"}] },
            "則": { hanviet: "TẮC", mean: "Quy tắc", on: "ソク", kun: "", tipImg: "Tiền (**貝**) và dao (**刂**) là quy tắc.", tipSound: "Ki**soku** tắc.", words: [{w:"規則 (きそく)", m:"Quy tắc"}, {w:"法則 (ほうそく)", m:"Định luật"}] },
            "意": { hanviet: "Ý", mean: "Ý nghĩa", on: "イ", kun: "", tipImg: "Tiếng (**音**) lòng (**心**) là ý.", tipSound: "**I**mi ý nghĩa.", words: [{w:"意味 (いみ)", m:"Ý nghĩa"}, {w:"意見 (いけん)", m:"Ý kiến"}] },
            "味": { hanviet: "VỊ", mean: "Vị", on: "ミ", kun: "あじ", tipImg: "Miệng (**口**) nếm cây chưa chín (**未**).", tipSound: "I**mi** vị.", words: [{w:"意味 (いみ)", m:"Ý nghĩa"}, {w:"味 (あじ)", m:"Hương vị"}] },
            "受": { hanviet: "THỤ", mean: "Nhận/Dự thi", on: "ジュ", kun: "う.ける", tipImg: "Móng vuốt (**爫**) nhận (**又**) lấy.", tipSound: "**U**keru nhận.", words: [{w:"受けます (うけます)", m:"Dự thi"}, {w:"受付 (うけつけ)", m:"Lễ tân"}] },
            "水": { hanviet: "THỦY", mean: "Nước", on: "スイ", kun: "みず", tipImg: "Dòng nước chảy.", tipSound: "**Mizu** nước.", words: [{w:"水 (みず)", m:"Nước"}, {w:"水道 (すいどう)", m:"Nước máy"}] },
            "制": { hanviet: "CHẾ", mean: "Chế độ", on: "セイ", kun: "", tipImg: "Con bò (**牛**) bị dao (**刂**) khống chế.", tipSound: "**Sei**fuku đồng phục.", words: [{w:"制服 (せいふく)", m:"Đồng phục"}, {w:"制度 (せいど)", m:"Chế độ"}] },
            "授": { hanviet: "THỤ", mean: "Trao/Dạy", on: "ジュ", kun: "", tipImg: "Tay (**扌**) nhận (**受**) sự truyền thụ.", tipSound: "**Ju**gyou giờ học.", words: [{w:"授業 (じゅぎょう)", m:"Giờ học"}, {w:"教授 (きょうじゅ)", m:"Giáo sư"}] },
            "業": { hanviet: "NGHIỆP", mean: "Nghề nghiệp", on: "ギョウ", kun: "", tipImg: "Cây cỏ mọc trên cừu.", tipSound: "Ju**gyou** nghiệp.", words: [{w:"授業 (じゅぎょう)", m:"Giờ học"}, {w:"残業 (ざんぎょう)", m:"Tăng ca"}] },
            "大": { hanviet: "ĐẠI", mean: "Lớn", on: "ダイ", kun: "おお.きい", tipImg: "Người dang tay chân.", tipSound: "**Dai**gaku đại học.", words: [{w:"大学 (だいがく)", m:"Đại học"}, {w:"大きい (おおきい)", m:"To lớn"}] },
            "学": { hanviet: "HỌC", mean: "Học", on: "ガク", kun: "まな.ぶ", tipImg: "Đứa trẻ đội mũ đi học.", tipSound: "Dai**gaku** học.", words: [{w:"大学 (だいがく)", m:"Đại học"}, {w:"学生 (がくせい)", m:"Học sinh"}] },
            "目": { hanviet: "MỤC", mean: "Mắt", on: "モク", kun: "め", tipImg: "Hình con mắt.", tipSound: "**Moku**teki mục đích.", words: [{w:"目的地 (もくてきち)", m:"Điểm đến"}, {w:"目 (め)", m:"Mắt"}] },
            "的": { hanviet: "ĐÍCH", mean: "Đích", on: "テキ", kun: "まと", tipImg: "Màu trắng (**白**) cái bao (**勹**) chấm nhỏ (**丶**).", tipSound: "Moku**teki** đích.", words: [{w:"目的地 (もくてきち)", m:"Điểm đến"}, {w:"目的 (もくてき)", m:"Mục đích"}] },
            "地": { hanviet: "ĐỊA", mean: "Đất", on: "チ", kun: "", tipImg: "Đất (**土**) có bọ cạp (**也**).", tipSound: "Mokuteki**chi** địa.", words: [{w:"目的地 (もくてきち)", m:"Điểm đến"}, {w:"地下鉄 (ちかてつ)", m:"Tàu điện ngầm"}] },
            "喫": { hanviet: "KHIẾT", mean: "Uống/Ăn", on: "キツ", kun: "", tipImg: "Miệng (**口**) ký kết (**契**).", tipSound: "**Kis**saten quán nước.", words: [{w:"喫茶店 (きっさてん)", m:"Quán giải khát"}, {w:"喫煙 (きつえん)", m:"Hút thuốc"}] },
            "茶": { hanviet: "TRÀ", mean: "Trà", on: "チャ", kun: "", tipImg: "Cỏ (**艹**) người (**人**) cây (**木**) là trà.", tipSound: "Kis**sa**ten trà.", words: [{w:"喫茶店 (きっさてん)", m:"Quán giải khát"}, {w:"お茶 (おちゃ)", m:"Trà"}] },
            "店": { hanviet: "ĐIẾM", mean: "Cửa hàng", on: "テン", kun: "みせ", tipImg: "Trong nhà (**广**) xem bói (**占**).", tipSound: "Kissa**ten** tiệm.", words: [{w:"喫茶店 (きっさてん)", m:"Quán giải khát"}, {w:"店 (みせ)", m:"Cửa hàng"}] },
            "問": { hanviet: "VẤN", mean: "Hỏi", on: "モン", kun: "と.い", tipImg: "Miệng (**口**) ở cổng (**門**) hỏi.", tipSound: "Shitsu**mon** câu hỏi.", words: [{w:"質問 (しつもん)", m:"Câu hỏi"}, {w:"問題 (もんだい)", m:"Vấn đề"}] },
            "題": { hanviet: "ĐỀ", mean: "Vấn đề", on: "ダイ", kun: "", tipImg: "Đúng (**是**) là cái đầu (**頁**) có vấn đề.", tipSound: "Mon**dai** đề.", words: [{w:"問題 (もんだい)", m:"Vấn đề"}, {w:"宿題 (しゅくだい)", m:"Bài tập"}] },
            "咳": { hanviet: "KHÁI", mean: "Ho", on: "ガイ", kun: "せき", tipImg: "Miệng (**口**) hợi (**亥**) ho.", tipSound: "**Seki** ho.", words: [{w:"咳 (せき)", m:"Ho"}] },
            "傷": { hanviet: "THƯƠNG", mean: "Vết thương", on: "ショウ", kun: "きず", tipImg: "Người (**亻**) dương (**昜**) bị thương.", tipSound: "**Kizu** thương.", words: [{w:"傷 (きず)", m:"Vết thương"}, {w:"負傷 (ふしょう)", m:"Bị thương"}] },
            "熱": { hanviet: "NHIỆT", mean: "Nóng/Sốt", on: "ネツ", kun: "あつ.い", tipImg: "Thế lực (**丸**) đốt lửa (**灬**) nóng.", tipSound: "**Netsu** sốt.", words: [{w:"熱 (ねつ)", m:"Sốt"}, {w:"熱い (あつい)", m:"Nóng"}] },
            "薬": { hanviet: "DƯỢC", mean: "Thuốc", on: "ヤク", kun: "くすり", tipImg: "Cỏ (**艹**) vui (**楽**) là thuốc.", tipSound: "**Kusuri** thuốc.", words: [{w:"薬 (くすり)", m:"Thuốc"}, {w:"薬局 (やっきょく)", m:"Hiệu thuốc"}] },
            "食": { hanviet: "THỰC", mean: "Ăn", on: "ショク", kun: "た.べる", tipImg: "Người tốt (**良**) có lương thực.", tipSound: "Gai**shoku** thực.", words: [{w:"外食 (がいしょく)", m:"Ăn ngoài"}, {w:"食べる (たべる)", m:"Ăn"}] },
            "治": { hanviet: "TRỊ", mean: "Chữa trị", on: "ジ", kun: "なお.る", tipImg: "Nước (**氵**) cái đài (**台**) chữa trị.", tipSound: "**Nao**ru trị.", words: [{w:"治ります (なきます)", m:"Khỏi bệnh"}, {w:"治療 (ちりょう)", m:"Điều trị"}] },
            "太": { hanviet: "THÁI", mean: "Béo", on: "タイ", kun: "ふと.る", tipImg: "Người to lớn (**大**) có điểm (**丶**).", tipSound: "**Futo**ru béo.", words: [{w:"太ります (ふとります)", m:"Béo lên"}, {w:"太い (ふとい)", m:"Béo/Dày"}] },
            "着": { hanviet: "TRƯỚC", mean: "Đến", on: "チャク", kun: "つ.く", tipImg: "Dê (**⺶**) nhìn (**目**) đích đến.", tipSound: "**Tsu**ku đến.", words: [{w:"着きます (つきます)", m:"Đến nơi"}, {w:"到着 (とうちゃく)", m:"Đến"}] },
            "釣": { hanviet: "ĐIẾU", mean: "Câu cá", on: "チョウ", kun: "つ.る", tipImg: "Kim loại (**金**) cái muôi (**勺**) câu cá.", tipSound: "O**tsu**ri tiền thừa (nghĩa khác).", words: [{w:"お釣り (おつり)", m:"Tiền thừa"}, {w:"釣ります (つります)", m:"Câu cá"}] },
            "質": { hanviet: "CHẤT", mean: "Chất lượng/Hỏi", on: "シツ", kun: "", tipImg: "Hai cái rìu (**斤**) trên tiền (**貝**).", tipSound: "**Shitsu**mon chất vấn.", words: [{w:"質問 (しつもん)", m:"Câu hỏi"}, {w:"品質 (ひんしつ)", m:"Chất lượng"}] },
            "集": { hanviet: "TẬP", mean: "Tập hợp", on: "シュウ", kun: "あつ.める", tipImg: "Chim (**隹**) trên cây (**木**) tập hợp.", tipSound: "**Atsu**meru tập.", words: [{w:"集めます (あつめます)", m:"Tập hợp/Sưu tầm"}, {w:"集中 (しゅうちゅう)", m:"Tập trung"}] },
            "困": { hanviet: "KHỐN", mean: "Khó khăn", on: "コン", kun: "こま.る", tipImg: "Cây (**木**) trong khung (**囗**) khốn khổ.", tipSound: "**Koma**ru khốn.", words: [{w:"困ります (こまります)", m:"Gặp khó khăn"}, {w:"困難 (こんなん)", m:"Khó khăn"}] },
            "渡": { hanviet: "ĐỘ", mean: "Trao/Qua", on: "ト", kun: "わた.す", tipImg: "Nước (**氵**) độ (**度**) qua sông.", tipSound: "**Wata**su độ.", words: [{w:"渡します (わたします)", m:"Trao/Đưa"}, {w:"渡ります (わたります)", m:"Băng qua"}] },
            "貼": { hanviet: "THIẾP", mean: "Dán", on: "テン", kun: "は.る", tipImg: "Tiền (**貝**) chiếm (**占**) chỗ dán.", tipSound: "**Ha**ru dán.", words: [{w:"貼ります (はります)", m:"Dán"}] },
            "疲": { hanviet: "BÌ", mean: "Mệt", on: "ヒ", kun: "つか.れる", tipImg: "Bệnh (**疒**) da (**皮**) mệt mỏi.", tipSound: "**Tsuka**reru mệt.", words: [{w:"疲れます (つかれます)", m:"Mệt mỏi"}] },
            "並": { hanviet: "TỊNH", mean: "Xếp hàng", on: "ヘイ", kun: "なら.べる", tipImg: "Hai người đứng (**立**) ngang nhau.", tipSound: "**Nara**beru tịnh.", words: [{w:"並べます (ならべます)", m:"Sắp xếp"}, {w:"並びます (ならびます)", m:"Xếp hàng"}] },
            "生": { hanviet: "SINH", mean: "Sinh ra", on: "セイ", kun: "う.まれる", tipImg: "Cây cỏ mọc trên đất.", tipSound: "**U**mareru sinh.", words: [{w:"生まれます (うまれます)", m:"Sinh ra"}, {w:"誕生日 (たんじょうび)", m:"Sinh nhật"}] },
            "差": { hanviet: "SAI", mean: "Giương/Sai khác", on: "サ", kun: "さ.す", tipImg: "Dê (**⺶**) làm công (**工**) bị sai.", tipSound: "**Sa**su giương.", words: [{w:"差します (さします)", m:"Giương (ô)"}, {w:"交差点 (こうさてん)", m:"Ngã tư"}] },
            "頼": { hanviet: "LẠI", mean: "Nhờ cậy", on: "ライ", kun: "たの.む", tipImg: "Cố gắng (**束**) kiếm tiền (**頁**) để nhờ cậy.", tipSound: "**Tano**mu lại.", words: [{w:"頼みます (たのみます)", m:"Nhờ cậy"}, {w:"信頼 (しんらい)", m:"Tin cậy"}] },
            "守": { hanviet: "THỦ", mean: "Bảo vệ/Tuân thủ", on: "シュ", kun: "まも.る", tipImg: "Trong nhà (**宀**) có tấc (**寸**) lòng thủ giữ.", tipSound: "**Mamo**ru thủ.", words: [{w:"守ります (まもります)", m:"Tuân thủ/Bảo vệ"}, {w:"留守 (るす)", m:"Vắng nhà"}] },
            "現": { hanviet: "HIỆN", mean: "Hiện tại", on: "ゲン", kun: "", tipImg: "Vua (**王**) nhìn (**見**) hiện tại.", tipSound: "**Gen**kin hiện kim.", words: [{w:"現金 (げんきん)", m:"Tiền mặt"}, {w:"現在 (げんざい)", m:"Hiện tại"}] },
            "金": { hanviet: "KIM", mean: "Tiền/Vàng", on: "キン", kun: "かね", tipImg: "Vàng chôn dưới đất.", tipSound: "Gen**kin** kim.", words: [{w:"現金 (げんきん)", m:"Tiền mặt"}, {w:"お金 (おかね)", m:"Tiền"}] },
            "趣": { hanviet: "THÚ", mean: "Hứng thú", on: "シュ", kun: "", tipImg: "Chạy (**走**) đi lấy (**取**) hứng thú.", tipSound: "**Shu**mi thú.", words: [{w:"趣味 (しゅみ)", m:"Sở thích/Gu"}] },
            "読": { hanviet: "ĐỘC", mean: "Đọc", on: "ドク", kun: "よ.む", tipImg: "Nói (**言**) bán (**売**) sách cho độc giả.", tipSound: "**Doku**sho độc thư.", words: [{w:"読書 (どくしょ)", m:"Đọc sách"}, {w:"読みます (よみます)", m:"Đọc"}] },
            "書": { hanviet: "THƯ", mean: "Viết", on: "ショ", kun: "か.く", tipImg: "Tay cầm bút viết.", tipSound: "Doku**sho** thư.", words: [{w:"読書 (どくしょ)", m:"Đọc sách"}, {w:"辞書 (じしょ)", m:"Từ điển"}] }
        };

        // --- GRAMMAR CONFIGURATION ---
        const grammarDefs = {
            te_kara: {
                id: 'te_kara', label: 'Sau khi (Te kara)', icon: 'schedule', type: 'verb',
                color: 'text-indigo-600', bg: 'bg-indigo-100',
                validFor: ['verb'],
                formula: 'Vて + から、V2',
                meaning: 'Hành động 2 xảy ra sau khi hành động 1 kết thúc.',
                example: { ja: '手を洗ってから、食べます。', vi: 'Sau khi rửa tay, tôi sẽ ăn.' },
                gen: (w, f) => ({
                    polite: `${f.te}から、寝ます。`,
                    politeVi: `Sau khi ${w['Nghĩa tiếng Việt'].toLowerCase()}, tôi sẽ ngủ.`,
                    casual: `${f.te}から、寝る。`,
                    casualVi: `Sau khi ${w['Nghĩa tiếng Việt'].toLowerCase()}, tôi ngủ.`
                })
            },
            temo_ii: {
                id: 'temo_ii', label: 'Làm... được (Temo ii)', icon: 'check_circle', type: 'verb',
                color: 'text-green-600', bg: 'bg-green-100',
                validFor: ['verb'],
                formula: 'Vて + も いいです',
                meaning: 'Xin phép hoặc cho phép làm gì đó.',
                example: { ja: '写真を撮ってもいいですか。', vi: 'Tôi chụp ảnh được không?' },
                gen: (w, f) => ({
                    polite: `${f.te}もいいですか。`,
                    politeVi: `Tôi ${w['Nghĩa tiếng Việt'].toLowerCase()} cũng được không?`,
                    casual: `${f.te}もいい？`,
                    casualVi: `${w['Nghĩa tiếng Việt'].toLowerCase()} được không?`
                })
            },
            mashou_ka: {
                id: 'mashou_ka', label: 'Làm giúp nhé (Mashouka)', icon: 'volunteer_activism', type: 'verb',
                color: 'text-pink-600', bg: 'bg-pink-100',
                validFor: ['verb'],
                formula: 'Vます + ましょうか',
                meaning: 'Đề nghị làm giúp ai đó.',
                example: { ja: '荷物を持ちましょうか。', vi: 'Tôi cầm hành lý giúp bạn nhé?' },
                gen: (w, f) => ({
                    polite: `${f.stem}ましょうか。`,
                    politeVi: `Để tôi ${w['Nghĩa tiếng Việt'].toLowerCase()} giúp nhé?`,
                    casual: `${f.stem}ようか。`,
                    casualVi: `Để tôi ${w['Nghĩa tiếng Việt'].toLowerCase()} cho.`
                })
            },
            mashou: {
                id: 'mashou', label: 'Cùng làm (Mashou)', icon: 'group_add', type: 'verb',
                color: 'text-blue-600', bg: 'bg-blue-100',
                validFor: ['verb'],
                formula: 'Vます + ましょう',
                meaning: 'Rủ rê, đề nghị cùng làm.',
                example: { ja: '一緒に帰りましょう。', vi: 'Cùng về nhé.' },
                gen: (w, f) => ({
                    polite: `一緒に${f.stem}ましょう。`,
                    politeVi: `Cùng ${w['Nghĩa tiếng Việt'].toLowerCase()} nhé.`,
                    casual: `一緒に${f.stem}よう。`,
                    casualVi: `Cùng ${w['Nghĩa tiếng Việt'].toLowerCase()} nào.`
                })
            },
            temo: {
                id: 'temo', label: 'Dù... (Temo/Demo)', icon: 'contrast', type: 'verb',
                color: 'text-orange-600', bg: 'bg-orange-100',
                validFor: ['verb', 'adj_i', 'adj_na', 'noun', 'food', 'place', 'person'],
                formula: 'Vて + も',
                meaning: 'Dù... nhưng vẫn...',
                example: { ja: '雨が降っても、行きます。', vi: 'Dù trời mưa tôi vẫn đi.' },
                gen: (w, f) => {
                    if(w.type === 'verb') {
                        return {
                            polite: `${f.te}も、大丈夫です。`,
                            politeVi: `Dù ${w['Nghĩa tiếng Việt'].toLowerCase()} cũng không sao.`,
                            casual: `${f.te}も、平気。`,
                            casualVi: `Dù ${w['Nghĩa tiếng Việt'].toLowerCase()} cũng bình thường.`
                        };
                    } else if (w.type === 'adj_i') {
                        return {
                            polite: `${f.te}も、好きです。`,
                            politeVi: `Dù ${w['Nghĩa tiếng Việt'].toLowerCase()} tôi vẫn thích.`,
                            casual: `${f.te}も、好き。`,
                            casualVi: `Dù ${w['Nghĩa tiếng Việt'].toLowerCase()} vẫn thích.`
                        };
                    } else { // noun, adj_na
                        return {
                            polite: `${w.Furigana}でも、いいです。`,
                            politeVi: `Dù là ${w['Nghĩa tiếng Việt'].toLowerCase()} cũng được.`,
                            casual: `${w.Furigana}でも、いいよ。`,
                            casualVi: `Dù là ${w['Nghĩa tiếng Việt'].toLowerCase()} cũng được đấy.`
                        };
                    }
                }
            },
            prohibition: {
                id: 'prohibition', label: 'Cấm (Te wa ikemasen)', icon: 'block', type: 'verb',
                color: 'text-red-600', bg: 'bg-red-100',
                validFor: ['verb'],
                formula: 'Vて + は いけません',
                meaning: 'Cấm đoán, không được phép làm.',
                example: { ja: 'ここで吸ってはいけません。', vi: 'Không được hút thuốc ở đây.' },
                gen: (w, f) => ({
                    polite: `ここで${f.te}はいけません。`,
                    politeVi: `Không được ${w['Nghĩa tiếng Việt'].toLowerCase()} ở đây.`,
                    casual: `ここ、${f.te}はだめ。`,
                    casualVi: `Ở đây cấm ${w['Nghĩa tiếng Việt'].toLowerCase()}.`
                })
            },
            ga_arimasu: {
                id: 'ga_arimasu', label: 'Có (Ga Arimasu)', icon: 'inventory_2', type: 'noun',
                color: 'text-teal-600', bg: 'bg-teal-100',
                validFor: ['noun', 'food'],
                formula: 'N + が あります',
                meaning: 'Biểu thị sự sở hữu hoặc tồn tại.',
                example: { ja: 'お金があります。', vi: 'Tôi có tiền.' },
                gen: (w, f) => ({
                    polite: `${w.Furigana}があります。`,
                    politeVi: `Có ${w['Nghĩa tiếng Việt'].toLowerCase()}.`,
                    casual: `${w.Furigana}がある。`,
                    casualVi: `Có ${w['Nghĩa tiếng Việt'].toLowerCase()}.`
                })
            },
            ni_ikitai: {
                id: 'ni_ikitai', label: 'Muốn đi (Ni Ikitai)', icon: 'flight_takeoff', type: 'place',
                color: 'text-cyan-600', bg: 'bg-cyan-100',
                validFor: ['place'],
                formula: 'N + に 行きたい',
                meaning: 'Muốn đi đến địa điểm nào đó.',
                example: { ja: '日本に行きたいです。', vi: 'Tôi muốn đi Nhật.' },
                gen: (w, f) => ({
                    polite: `${w.Furigana}に行きたいです。`,
                    politeVi: `Tôi muốn đi đến ${w['Nghĩa tiếng Việt'].toLowerCase()}.`,
                    casual: `${w.Furigana}に行きたい。`,
                    casualVi: `Muốn đi ${w['Nghĩa tiếng Việt'].toLowerCase()}.`
                })
            },
            suki: {
                id: 'suki', label: 'Thích (Suki)', icon: 'favorite', type: 'noun',
                color: 'text-pink-500', bg: 'bg-pink-100',
                validFor: ['noun', 'food', 'person'],
                formula: 'N + が 好きです',
                meaning: 'Biểu thị sự yêu thích.',
                example: { ja: '猫が好きです。', vi: 'Tôi thích mèo.' },
                gen: (w, f) => ({
                    polite: `${w.Furigana}が好きです。`,
                    politeVi: `Tôi thích ${w['Nghĩa tiếng Việt'].toLowerCase()}.`,
                    casual: `${w.Furigana}が好き。`,
                    casualVi: `Thích ${w['Nghĩa tiếng Việt'].toLowerCase()}.`
                })
            }
        };

        // Helper to conjugate verbs & adjs
        const teFormMap = {
            'じゅんびします':'じゅんびして', 'きめます':'きめて', 'きます':'きて', 'とまります':'とまって', 'キャンプします':'キャンプして', 
            'のります':'のって', 'のぼります':'のぼって', 'つります':'つって', 'あいます':'あって', 'します':'して', 'かいます':'かって', 
            'かざります':'かざって', 'ふきます':'ふいて', 'ほします':'ほして', 'およぎます':'およいで', 'せんたくします':'せんたくして', 
            'ききます':'きいて', 'おしえます':'おしえて', 'なくします':'なくして', 'しんぱいします':'しんぱいして', 'さわります':'さわって', 
            'うごきます':'うごいて', 'コピーします':'コピーして', 'べんきょうします':'べんきょうして', 'むりします':'むりして', 
            'うけます':'うけて', 'やります':'やって', 'おわります':'おわって', 'はいります':'はいって', 'つきます':'ついて', 
            'あつめます':'あつめて', 'こまります':'こまって', 'わたします':'わたして', 'はります':'はって', 'こたえます':'こたえて', 
            'つかれます':'つかれて', 'ならべます':'ならべて', 'うまれます':'うまれて', 'しつもんします':'しつもんして', 
            'さします':'さして', 'たのみます':'たのんで', 'まもります':'まもって', 'うたいます':'うたって', 'ひきます':'ひいて'
        };
        
        const adjTeFormMap = {
            'かわいい': 'かわいくて', 'きたない': 'きたなくて', 'くさい': 'くさくて', 'いたい': 'いたくて'
        }

        function getForms(furigana) {
            let stem = furigana;
            let te = furigana;

            if (furigana.endsWith('します')) {
                 stem = furigana.replace('します', 'し');
                 te = teFormMap[furigana] || stem + 'て';
            } else if (furigana.endsWith('ます')) {
                stem = furigana.replace('ます', '');
                te = teFormMap[furigana] || stem + 'て'; 
            } else if (furigana.endsWith('い')) { // i-adj
                te = adjTeFormMap[furigana] || furigana.slice(0, -1) + 'くて';
            }
            
            return { stem, te };
        }

        // --- VOCABULARY DATA (Day 7 - 89 Words) ---
        const vocabData = [
            // Verbs
            { "STT": 1, "Kanji": "準備", "Nghĩa tiếng Việt": "Chuẩn bị", "Furigana": "じゅんびします", "type": "verb" },
            { "STT": 2, "Kanji": "決めます", "Nghĩa tiếng Việt": "Quyết định", "Furigana": "きめます", "type": "verb" },
            { "STT": 3, "Kanji": "泊まります", "Nghĩa tiếng Việt": "Trọ lại", "Furigana": "とまります", "type": "verb" },
            { "STT": 4, "Kanji": "", "Nghĩa tiếng Việt": "Cắm trại", "Furigana": "キャンプします", "type": "verb" },
            { "STT": 5, "Kanji": "乗ります", "Nghĩa tiếng Việt": "Cưỡi (ngựa)", "Furigana": "のります", "type": "verb" },
            { "STT": 6, "Kanji": "登ります", "Nghĩa tiếng Việt": "Leo (núi)", "Furigana": "のぼります", "type": "verb" },
            { "STT": 7, "Kanji": "釣ります", "Nghĩa tiếng Việt": "Câu cá", "Furigana": "つります", "type": "verb" },
            { "STT": 8, "Kanji": "会います", "Nghĩa tiếng Việt": "Gặp", "Furigana": "あいます", "type": "verb" },
            { "STT": 9, "Kanji": "着ます", "Nghĩa tiếng Việt": "Mặc", "Furigana": "きます", "type": "verb" },
            { "STT": 10, "Kanji": "", "Nghĩa tiếng Việt": "Làm (chơi)", "Furigana": "します", "type": "verb" },
            { "STT": 11, "Kanji": "買います", "Nghĩa tiếng Việt": "Mua", "Furigana": "かいます", "type": "verb" },
            { "STT": 12, "Kanji": "飾ります", "Nghĩa tiếng Việt": "Trang trí", "Furigana": "かざります", "type": "verb" }, // New for context
            { "STT": 13, "Kanji": "拭きます", "Nghĩa tiếng Việt": "Lau", "Furigana": "ふきます", "type": "verb" },
            { "STT": 14, "Kanji": "干します", "Nghĩa tiếng Việt": "Phơi", "Furigana": "ほします", "type": "verb" },
            { "STT": 15, "Kanji": "泳ぎます", "Nghĩa tiếng Việt": "Bơi", "Furigana": "およぎます", "type": "verb" },
            { "STT": 16, "Kanji": "洗濯します", "Nghĩa tiếng Việt": "Giặt", "Furigana": "せんたくします", "type": "verb" },
            { "STT": 17, "Kanji": "聞きます", "Nghĩa tiếng Việt": "Nghe", "Furigana": "ききます", "type": "verb" },
            { "STT": 18, "Kanji": "教えます", "Nghĩa tiếng Việt": "Dạy/Chỉ", "Furigana": "おしえます", "type": "verb" },
            { "STT": 19, "Kanji": "無くします", "Nghĩa tiếng Việt": "Làm mất", "Furigana": "なくします", "type": "verb" },
            { "STT": 20, "Kanji": "心配します", "Nghĩa tiếng Việt": "Lo lắng", "Furigana": "しんぱいします", "type": "verb" },
            { "STT": 21, "Kanji": "触ります", "Nghĩa tiếng Việt": "Chạm", "Furigana": "さわります", "type": "verb" },
            { "STT": 22, "Kanji": "動きます", "Nghĩa tiếng Việt": "Cử động", "Furigana": "うごきます", "type": "verb" },
            { "STT": 23, "Kanji": "", "Nghĩa tiếng Việt": "Sao chép", "Furigana": "コピーします", "type": "verb" },
            { "STT": 24, "Kanji": "勉強します", "Nghĩa tiếng Việt": "Học", "Furigana": "べんきょうします", "type": "verb" },
            { "STT": 25, "Kanji": "無理します", "Nghĩa tiếng Việt": "Làm quá sức", "Furigana": "むりします", "type": "verb" },
            { "STT": 26, "Kanji": "受けます", "Nghĩa tiếng Việt": "Dự thi", "Furigana": "うけます", "type": "verb" },
            { "STT": 27, "Kanji": "やります", "Nghĩa tiếng Việt": "Tưới (nước)", "Furigana": "やります", "type": "verb" },
            { "STT": 28, "Kanji": "終わります", "Nghĩa tiếng Việt": "Kết thúc", "Furigana": "おわります", "type": "verb" },
            { "STT": 29, "Kanji": "入ります", "Nghĩa tiếng Việt": "Vào", "Furigana": "はいります", "type": "verb" },
            { "STT": 30, "Kanji": "着きます", "Nghĩa tiếng Việt": "Đến nơi", "Furigana": "つきます", "type": "verb" },
            { "STT": 31, "Kanji": "集めます", "Nghĩa tiếng Việt": "Tập hợp", "Furigana": "あつめます", "type": "verb" },
            { "STT": 32, "Kanji": "困ります", "Nghĩa tiếng Việt": "Gặp khó khăn", "Furigana": "こまります", "type": "verb" },
            { "STT": 33, "Kanji": "渡します", "Nghĩa tiếng Việt": "Trao/Đưa", "Furigana": "わたします", "type": "verb" },
            { "STT": 34, "Kanji": "貼ります", "Nghĩa tiếng Việt": "Dán", "Furigana": "はります", "type": "verb" },
            { "STT": 35, "Kanji": "答えます", "Nghĩa tiếng Việt": "Trả lời", "Furigana": "こたえます", "type": "verb" },
            { "STT": 36, "Kanji": "疲れます", "Nghĩa tiếng Việt": "Mệt", "Furigana": "つかれます", "type": "verb" },
            { "STT": 37, "Kanji": "並べます", "Nghĩa tiếng Việt": "Sắp xếp", "Furigana": "ならべます", "type": "verb" },
            { "STT": 38, "Kanji": "生まれます", "Nghĩa tiếng Việt": "Sinh ra", "Furigana": "うまれます", "type": "verb" },
            { "STT": 39, "Kanji": "質問します", "Nghĩa tiếng Việt": "Hỏi", "Furigana": "しつもんします", "type": "verb" },
            { "STT": 40, "Kanji": "差します", "Nghĩa tiếng Việt": "Giương (ô)", "Furigana": "さします", "type": "verb" },
            { "STT": 41, "Kanji": "頼みます", "Nghĩa tiếng Việt": "Nhờ cậy", "Furigana": "たのみます", "type": "verb" },
            { "STT": 42, "Kanji": "守ります", "Nghĩa tiếng Việt": "Tuân thủ", "Furigana": "まもります", "type": "verb" },
            { "STT": 43, "Kanji": "歌います", "Nghĩa tiếng Việt": "Hát", "Furigana": "うたいます", "type": "verb" },
            { "STT": 44, "Kanji": "弾きます", "Nghĩa tiếng Việt": "Chơi (nhạc cụ)", "Furigana": "ひきます", "type": "verb" },
            
            // Nouns & Food
            { "STT": 45, "Kanji": "納豆", "Nghĩa tiếng Việt": "Natto", "Furigana": "なっとう", "type": "food" },
            { "STT": 46, "Kanji": "", "Nghĩa tiếng Việt": "Sầu riêng", "Furigana": "ドリアン", "type": "food" },
            { "STT": 47, "Kanji": "", "Nghĩa tiếng Việt": "Idol", "Furigana": "アイドル", "type": "noun" },
            { "STT": 48, "Kanji": "着物", "Nghĩa tiếng Việt": "Kimono", "Furigana": "きもの", "type": "noun" },
            { "STT": 49, "Kanji": "浴衣", "Nghĩa tiếng Việt": "Yukata", "Furigana": "ゆかた", "type": "noun" },
            { "STT": 50, "Kanji": "お化け", "Nghĩa tiếng Việt": "Ma quỷ", "Furigana": "おばけ", "type": "noun" },
            { "STT": 51, "Kanji": "旅館", "Nghĩa tiếng Việt": "Lữ quán", "Furigana": "りょかん", "type": "place" },
            { "STT": 52, "Kanji": "", "Nghĩa tiếng Việt": "Khách sạn", "Furigana": "ホテル", "type": "place" },
            { "STT": 53, "Kanji": "相撲", "Nghĩa tiếng Việt": "Sumo", "Furigana": "すもう", "type": "noun" },
            { "STT": 54, "Kanji": "歌舞伎", "Nghĩa tiếng Việt": "Kabuki", "Furigana": "かぶき", "type": "noun" },
            { "STT": 55, "Kanji": "一度", "Nghĩa tiếng Việt": "Một lần", "Furigana": "いちど", "type": "noun" },
            { "STT": 56, "Kanji": "一度も", "Nghĩa tiếng Việt": "Chưa lần nào", "Furigana": "いちども", "type": "noun" },
            { "STT": 57, "Kanji": "", "Nghĩa tiếng Việt": "Tennis", "Furigana": "テニス", "type": "noun" },
            { "STT": 58, "Kanji": "", "Nghĩa tiếng Việt": "Bể bơi", "Furigana": "プール", "type": "place" },
            { "STT": 59, "Kanji": "赤ちゃん", "Nghĩa tiếng Việt": "Em bé", "Furigana": "あかちゃん", "type": "person" },
            { "STT": 60, "Kanji": "服", "Nghĩa tiếng Việt": "Quần áo", "Furigana": "ふく", "type": "noun" },
            { "STT": 61, "Kanji": "花瓶", "Nghĩa tiếng Việt": "Bình hoa", "Furigana": "かびん", "type": "noun" },
            { "STT": 62, "Kanji": "連休", "Nghĩa tiếng Việt": "Kỳ nghỉ dài", "Furigana": "れんきゅう", "type": "noun" },
            { "STT": 63, "Kanji": "", "Nghĩa tiếng Việt": "Phim Drama", "Furigana": "ドラマ", "type": "noun" },
            { "STT": 64, "Kanji": "音楽", "Nghĩa tiếng Việt": "Âm nhạc", "Furigana": "おんがく", "type": "noun" },
            { "STT": 65, "Kanji": "外国語", "Nghĩa tiếng Việt": "Ngoại ngữ", "Furigana": "がいこくご", "type": "noun" },
            { "STT": 66, "Kanji": "答え", "Nghĩa tiếng Việt": "Câu trả lời", "Furigana": "こたえ", "type": "noun" },
            { "STT": 67, "Kanji": "財布", "Nghĩa tiếng Việt": "Ví", "Furigana": "さいふ", "type": "noun" },
            { "STT": 68, "Kanji": "", "Nghĩa tiếng Việt": "Hộ chiếu", "Furigana": "パスポート", "type": "noun" },
            { "STT": 69, "Kanji": "壁", "Nghĩa tiếng Việt": "Tường", "Furigana": "かべ", "type": "noun" },
            { "STT": 70, "Kanji": "遠慮", "Nghĩa tiếng Việt": "Ngại ngần", "Furigana": "えんりょ", "type": "noun" }, // Used as suru verb usually
            { "STT": 71, "Kanji": "夜遅く", "Nghĩa tiếng Việt": "Đêm khuya", "Furigana": "よるおそく", "type": "noun" },
            { "STT": 72, "Kanji": "規則", "Nghĩa tiếng Việt": "Quy tắc", "Furigana": "きそく", "type": "noun" },
            { "STT": 73, "Kanji": "", "Nghĩa tiếng Việt": "Bài thi", "Furigana": "テスト", "type": "noun" },
            { "STT": 74, "Kanji": "意味", "Nghĩa tiếng Việt": "Ý nghĩa", "Furigana": "いみ", "type": "noun" },
            { "STT": 75, "Kanji": "制服", "Nghĩa tiếng Việt": "Đồng phục", "Furigana": "せいふく", "type": "noun" },
            { "STT": 76, "Kanji": "授業", "Nghĩa tiếng Việt": "Giờ học", "Furigana": "じゅぎょう", "type": "noun" },
            { "STT": 77, "Kanji": "大学", "Nghĩa tiếng Việt": "Đại học", "Furigana": "だいがく", "type": "place" },
            { "STT": 78, "Kanji": "目的地", "Nghĩa tiếng Việt": "Đích đến", "Furigana": "もくてきち", "type": "place" },
            { "STT": 79, "Kanji": "喫茶店", "Nghĩa tiếng Việt": "Quán nước", "Furigana": "きっさてん", "type": "place" },
            { "STT": 80, "Kanji": "問題", "Nghĩa tiếng Việt": "Vấn đề", "Furigana": "もんだい", "type": "noun" },
            { "STT": 81, "Kanji": "傷", "Nghĩa tiếng Việt": "Vết thương", "Furigana": "きず", "type": "noun" },
            { "STT": 82, "Kanji": "熱", "Nghĩa tiếng Việt": "Sốt", "Furigana": "ねつ", "type": "noun" },
            { "STT": 83, "Kanji": "", "Nghĩa tiếng Việt": "Cúm", "Furigana": "インフルエンザ", "type": "noun" },
            { "STT": 84, "Kanji": "薬", "Nghĩa tiếng Việt": "Thuốc", "Furigana": "くすり", "type": "noun" },
            { "STT": 85, "Kanji": "外食", "Nghĩa tiếng Việt": "Ăn ngoài", "Furigana": "がいしょく", "type": "noun" }, // Suru verb
            { "STT": 86, "Kanji": "お釣り", "Nghĩa tiếng Việt": "Tiền thừa", "Furigana": "おつり", "type": "noun" },
            { "STT": 87, "Kanji": "現金", "Nghĩa tiếng Việt": "Tiền mặt", "Furigana": "げんきん", "type": "noun" },
            { "STT": 88, "Kanji": "趣味", "Nghĩa tiếng Việt": "Sở thích", "Furigana": "しゅみ", "type": "noun" },
            { "STT": 89, "Kanji": "読書", "Nghĩa tiếng Việt": "Đọc sách", "Furigana": "どくしょ", "type": "noun" }
        ].filter(i => i.Furigana);

        let currentIndex = 0; let currentQuiz = null; let score = 0; let currentStrokeSvg = null;

        // --- CORE FUNCTIONS ---
        function init() { 
            // Safe initialization
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', startApp);
            } else {
                startApp();
            }
        }

        function startApp() {
            renderList();
            renderGrammarList();
            loadWord(0);
            
            // Add listeners safely
            const searchInput = document.getElementById('searchInput');
            if(searchInput) {
                searchInput.addEventListener('input', e => { 
                    const t = e.target.value.toLowerCase(); 
                    document.querySelectorAll('.vocab-item').forEach(el => el.style.display = el.innerText.toLowerCase().includes(t) ? 'block' : 'none'); 
                });
            }

            const mobileSearchInput = document.getElementById('mobileSearchInput');
            if(mobileSearchInput) {
                mobileSearchInput.addEventListener('input', e => { 
                    const t = e.target.value.toLowerCase(); 
                    document.querySelectorAll('.vocab-item').forEach(el => el.style.display = el.innerText.toLowerCase().includes(t) ? 'block' : 'none'); 
                });
            }

            const quizInput = document.getElementById('quiz-input');
            if(quizInput) {
                quizInput.addEventListener('keypress', e => { 
                    if(e.key==='Enter') checkAnswer(); 
                });
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            const tabBtn = document.getElementById(`tab-${tab}`);
            if(tabBtn) tabBtn.classList.add('active');
            
            const learnSec = document.getElementById('learn-section');
            const quizSec = document.getElementById('quiz-section');
            
            if(learnSec) learnSec.classList.toggle('hidden', tab!=='learn');
            if(quizSec) quizSec.classList.toggle('hidden', tab!=='quiz');
            
            if(tab === 'quiz') nextQuestion();
        }

        function renderList() {
            const listD = document.getElementById('vocabList'); const listM = document.getElementById('mobileVocabList');
            const html = vocabData.map((item, i) => `
                <div class="vocab-item p-3 mb-1 rounded-xl cursor-pointer hover:bg-indigo-50 transition-colors border-l-4 border-transparent ${i===0?'active':''}" 
                     data-index="${i}" onclick="loadWord(${i}); if(window.innerWidth<768) toggleDrawer();">
                    <div class="flex justify-between items-center"><span class="font-bold text-gray-800 ja-text">${item.Kanji||item.Furigana}</span><span class="text-[10px] font-bold text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded">#${item.STT}</span></div>
                    <div class="text-xs text-gray-500 truncate mt-0.5">${item['Nghĩa tiếng Việt']}</div>
                </div>`).join('');
            if(listD) listD.innerHTML = html; if(listM) listM.innerHTML = html;
        }

        function loadWord(idx) {
            currentIndex = idx; const word = vocabData[idx];
            document.querySelectorAll('.vocab-item').forEach(el => { el.classList.remove('active'); el.classList.add('border-transparent'); });
            document.querySelectorAll(`.vocab-item[data-index="${idx}"]`).forEach(el => { el.classList.add('active'); el.classList.remove('border-transparent'); });
            
            const hp = document.getElementById('headerProgress');
            if(hp) hp.innerText = `${idx+1}/${vocabData.length}`;
            
            const wi = document.getElementById('wordIndex'); if(wi) wi.innerText = `#${word.STT}`;
            
            const ck = document.getElementById('cardKanji'); if(ck) ck.innerText = word.Kanji || word.Furigana;
            const cf = document.getElementById('cardFurigana'); if(cf) cf.innerText = word.Furigana;
            const cm = document.getElementById('cardMeaning'); if(cm) cm.innerText = word['Nghĩa tiếng Việt'];
            const wt = document.getElementById('wordType'); if(wt) wt.innerText = word.type.toUpperCase();
            
            const hasK = word.Kanji && word.Kanji !== word.Furigana;
            const sb = document.getElementById('strokeBtn'); if(sb) sb.classList.toggle('hidden', !hasK);
            renderContexts(word);
        }

        function renderContexts(word) {
            const cont = document.getElementById('sentenceList'); const empty = document.getElementById('emptyState');
            if(!cont) return;
            
            cont.innerHTML = ''; let hasContext = false;
            Object.values(grammarDefs).forEach(rule => {
                const subType = word.subType || 'general';
                if (!rule.validFor.includes(word.type) && !rule.validFor.includes(subType)) return;
                
                let forms = {};
                if(word.type==='verb') forms = getForms(word.Furigana);
                
                const data = rule.gen(word, forms);
                if(!data) return;
                hasContext = true;
                
                const card = document.createElement('div');
                card.className = "shadow-card bg-white rounded-2xl p-4 border border-gray-100";
                card.innerHTML = `
                    <div class="flex items-center justify-between mb-3 border-b border-gray-50 pb-2">
                        <div class="flex items-center gap-2"><div class="${rule.bg} p-1.5 rounded-lg ${rule.color}"><i class="fas fa-${rule.icon}"></i></div><span class="text-xs font-bold text-gray-500 uppercase tracking-wide">${rule.label}</span></div>
                        <button onclick="openGrammarDetail('${rule.id}')" class="text-xs text-indigo-500 bg-indigo-50 hover:bg-indigo-100 px-3 py-1 rounded-full transition flex items-center gap-1"><i class="fas fa-book-open"></i> Ngữ pháp</button>
                    </div>
                    <div class="mb-3 pl-3 border-l-2 border-indigo-200">
                        <div class="flex justify-between items-start"><div><div class="text-base font-medium text-gray-800 ja-text leading-relaxed">${data.polite}</div><div class="text-xs text-gray-500 italic mt-0.5">${data.politeVi}</div></div><button onclick="speakText('${data.polite}')" class="audio-btn text-indigo-400 hover:text-indigo-600 p-1"><i class="fas fa-volume-up"></i></button></div>
                    </div>
                    <div class="pl-3 border-l-2 border-pink-200">
                        <div class="flex justify-between items-start"><div><div class="flex items-center gap-2"><div class="text-base font-medium text-gray-800 ja-text leading-relaxed">${data.casual}</div><span class="text-[10px] bg-pink-50 text-pink-600 px-1.5 rounded font-bold">Thân mật</span></div><div class="text-xs text-gray-500 italic mt-0.5">${data.casualVi}</div></div><button onclick="speakText('${data.casual}')" class="audio-btn text-pink-400 hover:text-pink-600 p-1"><i class="fas fa-volume-up"></i></button></div>
                    </div>`;
                cont.appendChild(card);
            });
            if(empty) {
                empty.classList.toggle('hidden', hasContext); 
                empty.classList.toggle('flex', !hasContext);
            }
        }
        
        // --- MODAL LOGIC ---
        function renderGrammarList() {
            const grid = document.getElementById('grammarGrid'); 
            if(!grid) return;
            grid.innerHTML = '';
            Object.values(grammarDefs).forEach(r => {
                grid.innerHTML += `<div class="bg-white rounded-xl border border-gray-100 p-4 shadow-sm hover:shadow-md transition cursor-pointer" onclick="closeModal('grammarListModal'); openGrammarDetail('${r.id}')"><div class="flex items-center gap-3 mb-3"><div class="w-10 h-10 rounded-full ${r.bg} ${r.color} flex items-center justify-center shadow-sm"><i class="fas fa-${r.icon} text-sm"></i></div><h4 class="font-bold text-gray-800 text-sm">${r.label}</h4></div><div class="bg-slate-50 rounded px-2 py-1 text-xs font-mono text-slate-600 mb-2 inline-block border border-slate-100">${r.formula}</div><p class="text-xs text-gray-500 line-clamp-2 leading-relaxed">${r.meaning}</p></div>`;
            });
        }
        function openGrammarList() { showModal('grammarListModal'); }
        function openGrammarDetail(id) {
            const r = grammarDefs[id]; if(!r) return;
            const title = document.getElementById('modalTitle'); if(title) title.innerText = r.label;
            const icon = document.getElementById('modalIcon'); if(icon) icon.className = `fas fa-${r.icon}`;
            const formula = document.getElementById('modalFormula'); if(formula) formula.innerText = r.formula;
            const explanation = document.getElementById('modalExplanation'); if(explanation) explanation.innerText = r.meaning;
            const exJa = document.getElementById('modalExampleJa'); if(exJa) exJa.innerText = r.example.ja;
            const exVi = document.getElementById('modalExampleVi'); if(exVi) exVi.innerText = r.example.vi;
            const playBtn = document.getElementById('modalPlayBtn'); if(playBtn) playBtn.onclick = () => speakText(r.example.ja);
            showModal('detailModal');
        }
        function showModal(id) {
            const el = document.getElementById(id);
            if(!el) return;
            el.classList.remove('hidden');
            requestAnimationFrame(() => {
                const backdrop = document.getElementById(id.replace('Modal','Backdrop'));
                const panel = document.getElementById(id.replace('Modal','Panel'));
                if(backdrop) backdrop.classList.remove('opacity-0'); 
                if(panel) panel.classList.remove('opacity-0', 'scale-95');
            });
        }
        function closeModal(id) {
            const backdrop = document.getElementById(id.replace('Modal','Backdrop'));
            const panel = document.getElementById(id.replace('Modal','Panel'));
            if(backdrop) backdrop.classList.add('opacity-0');
            if(panel) panel.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                const el = document.getElementById(id);
                if(el) el.classList.add('hidden');
            }, 200);
        }
        
        async function openStrokeModal(char) {
            const word = vocabData[currentIndex]; const kanjis = word.Kanji.match(/[\u4e00-\u9faf]/g)||[];
            if(kanjis.length===0) return;
            const target = char || kanjis[0];
            const tabs = document.getElementById('strokeTabs'); 
            if(tabs) {
                tabs.innerHTML = '';
                if(kanjis.length>1) kanjis.forEach(k => {
                    const b = document.createElement('button'); b.innerText = k;
                    b.className = `w-12 h-12 rounded-xl font-bold border-2 transition text-lg ${k===target?'bg-pink-600 border-pink-600 text-white shadow-lg':'bg-white border-gray-100 text-gray-400 hover:border-pink-200'}`;
                    b.onclick = () => showKanjiStroke(k); tabs.appendChild(b);
                });
            }
            showModal('strokeModal'); await showKanjiStroke(target);
        }
        function getKanjiHex(k) { return k.charCodeAt(0).toString(16).padStart(5, '0'); }
        async function showKanjiStroke(k) {
            const d = kanjiDetails[k]; const content = document.getElementById('kanjiDetailContent'); const empty = document.getElementById('kanjiDetailEmpty');
            
            if(content && empty) {
                if(d) {
                    content.classList.remove('hidden'); empty.classList.add('hidden');
                    const dk = document.getElementById('detailKanji'); if(dk) dk.innerText=k;
                    const dh = document.getElementById('detailHanViet'); if(dh) dh.innerText=d.hanviet;
                    const dm = document.getElementById('detailMeaning'); if(dm) dm.innerText=d.mean;
                    const doo = document.getElementById('detailOn'); if(doo) doo.innerText=d.on;
                    const dku = document.getElementById('detailKun'); if(dku) dku.innerText=d.kun;
                    
                    const fmt = s => s.replace(/\*\*(.*?)\*\*/g, '<span class="font-bold text-gray-900">$1</span>');
                    const dti = document.getElementById('detailTipImg'); if(dti) dti.innerHTML=fmt(d.tipImg);
                    const dts = document.getElementById('detailTipSound'); if(dts) dts.innerHTML=fmt(d.tipSound);
                    
                    const wc = document.getElementById('detailWords'); 
                    if(wc) {
                        wc.innerHTML='';
                        d.words.forEach(w => wc.innerHTML+=`<div class="flex justify-between items-center bg-gray-50 p-2 rounded hover:bg-gray-100 cursor-pointer border border-transparent hover:border-indigo-100 transition-colors" onclick="speakText('${w.w.split(' ')[0]}')"><span class="text-sm font-bold text-indigo-700 ja-text">${w.w}</span><span class="text-xs text-gray-500">${w.m}</span></div>`);
                    }
                } else { content.classList.add('hidden'); empty.classList.remove('hidden'); }
            }
            
            const anim = document.getElementById('strokeAnimContainer'); const grid = document.getElementById('strokeGridContainer');
            if(anim) anim.innerHTML = '<span class="text-xs text-gray-400 animate-pulse">Đang tải...</span>'; 
            if(grid) grid.innerHTML='';
            try {
                // Using jsDelivr for better CDN reliability
                const r = await fetch(`https://cdn.jsdelivr.net/gh/KanjiVG/kanjivg/kanji/${getKanjiHex(k)}.svg`);
                if(!r.ok) throw new Error();
                const svg = await r.text();
                if(anim) {
                    anim.innerHTML = svg;
                    const mainSvg = anim.querySelector('svg'); 
                    if(mainSvg) {
                        mainSvg.setAttribute('width','100%'); mainSvg.setAttribute('height','100%');
                        currentStrokeSvg = mainSvg;
                        const paths = mainSvg.querySelectorAll('path');
                        paths.forEach(p => { p.style.stroke="#333"; p.style.strokeWidth="4"; p.style.fill="none"; p.style.strokeLinecap="round"; p.style.strokeLinejoin="round"; });
                        replayStrokeAnimation();
                        
                        const parser = new DOMParser();
                        if(grid) {
                            paths.forEach((_, i) => {
                                const box = document.createElement('div'); box.className="w-16 h-16 bg-white border border-gray-200 relative stroke-grid-box flex items-center justify-center rounded";
                                const cloneDoc = parser.parseFromString(svg, "image/svg+xml"); const clone = cloneDoc.querySelector('svg');
                                clone.setAttribute('width','100%'); clone.setAttribute('height','100%');
                                clone.querySelectorAll('path').forEach((p, idx) => {
                                    p.style.fill="none"; p.style.strokeLinecap="round"; p.style.strokeLinejoin="round";
                                    if(idx<i) { p.style.stroke="#d1d5db"; p.style.strokeWidth="3"; }
                                    else if(idx===i) { p.style.stroke="#db2777"; p.style.strokeWidth="4"; }
                                    else p.style.display="none";
                                });
                                box.appendChild(clone); grid.appendChild(box);
                            });
                        }
                    }
                }
            } catch(e) { if(anim) anim.innerHTML="<p class='text-xs text-red-500'>Lỗi tải</p>"; }
        }
        function replayStrokeAnimation() {
            if(!currentStrokeSvg) return;
            const paths = currentStrokeSvg.querySelectorAll('path');
            paths.forEach(p => { p.style.transition='none'; p.style.strokeDasharray=p.getTotalLength(); p.style.strokeDashoffset=p.getTotalLength(); });
            void currentStrokeSvg.offsetWidth;
            let d = 0;
            paths.forEach(p => { p.style.transition=`stroke-dashoffset 0.8s ease-in-out ${d}s`; p.style.strokeDashoffset='0'; d+=0.8; });
        }

        // --- UTILS ---
        function speakText(t) { 
            const u = new SpeechSynthesisUtterance(t); 
            u.lang='ja-JP'; 
            u.rate = 0.9; // Slightly slower for learning
            speechSynthesis.speak(u); 
        }
        function speakCurrent() { speakText(vocabData[currentIndex].Furigana); }
        function playQuizAudio() { if(currentQuiz) speakText(currentQuiz.Furigana); }
        function toggleDrawer() {
            const d = document.getElementById('mobileDrawer'); const c = document.getElementById('drawerContent'); const b = document.getElementById('drawerBackdrop');
            if(!d || !c || !b) return;
            
            if(d.classList.contains('pointer-events-none')) { d.classList.remove('pointer-events-none'); requestAnimationFrame(() => { c.classList.remove('-translate-x-full'); b.classList.remove('opacity-0'); }); }
            else { c.classList.add('-translate-x-full'); b.classList.add('opacity-0'); setTimeout(() => d.classList.add('pointer-events-none'), 300); }
        }
        
        // --- QUIZ ---
        function nextQuestion() {
            const fb = document.getElementById('feedback-area'); if(fb) fb.classList.add('hidden');
            const btnCheck = document.getElementById('btn-check'); if(btnCheck) btnCheck.classList.remove('hidden');
            const btnNext = document.getElementById('btn-next'); if(btnNext) btnNext.classList.add('hidden');
            
            const inp = document.getElementById('quiz-input'); 
            if(inp) { inp.value=''; inp.disabled=false; inp.focus(); }
            
            currentQuiz = vocabData[Math.floor(Math.random()*vocabData.length)];
            const qk = document.getElementById('quiz-kanji'); if(qk) { qk.innerText = currentQuiz.Kanji || currentQuiz.Furigana; qk.className = "text-6xl md:text-7xl kanji-font font-bold text-gray-800 mb-4 transition-all py-4"; }
            const qm = document.getElementById('quiz-meaning'); if(qm) qm.innerText = currentQuiz['Nghĩa tiếng Việt'];
        }
        
        function checkAnswer() {
            const inp = document.getElementById('quiz-input'); if(!inp || !inp.value.trim()) return;
            inp.disabled=true; const correct = inp.value.trim()===currentQuiz.Furigana;
            
            const k = document.getElementById('quiz-kanji'); 
            const fbTitle = document.getElementById('feedback-title');
            
            if(correct) { 
                score+=10; 
                if(k) k.className+=" text-green-600 correct-anim"; 
                if(fbTitle) fbTitle.innerHTML='<i class="fas fa-check-circle text-green-600 mr-2"></i> Chính xác!'; 
                speakText(currentQuiz.Furigana); 
            } else { 
                score=Math.max(0,score-5); 
                if(k) k.className+=" text-red-600 wrong-anim"; 
                if(fbTitle) fbTitle.innerHTML='<i class="fas fa-times-circle text-red-600 mr-2"></i> Sai rồi!'; 
            }
            
            const sd = document.getElementById('score-display'); if(sd) sd.innerText=score;
            const ca = document.getElementById('correct-answer'); if(ca) ca.innerText=currentQuiz.Furigana;
            
            const fbArea = document.getElementById('feedback-area'); if(fbArea) fbArea.classList.remove('hidden');
            const btnCheck = document.getElementById('btn-check'); if(btnCheck) btnCheck.classList.add('hidden');
            const btnNext = document.getElementById('btn-next'); if(btnNext) { btnNext.classList.remove('hidden'); btnNext.focus(); }
        }

        // Listeners
        function nextWord() { if(currentIndex<vocabData.length-1) loadWord(currentIndex+1); }
        function prevWord() { if(currentIndex>0) loadWord(currentIndex-1); }
        
        init();
    </script>
</body>
</html>
